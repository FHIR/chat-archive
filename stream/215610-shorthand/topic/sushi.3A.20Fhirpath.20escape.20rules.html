---
layout: page
title: "FHIR Chat  · sushi: Fhirpath escape rules · shorthand"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/index.html">shorthand</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/sushi.3A.20Fhirpath.20escape.20rules.html">sushi: Fhirpath escape rules</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="258562781"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/sushi%3A%20Fhirpath%20escape%20rules/near/258562781" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/sushi.3A.20Fhirpath.20escape.20rules.html#258562781">(Oct 21 2021 at 15:07)</a>:</h4>
<p>We are using sushi extensively to create testscript resources containing a lot of FHIRpath Expressions.<br>
Writing fhirpath in FSH is quite cumbersome as you have to pay attention to the escaping rules of FSH.</p>



<a name="258563345"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/sushi%3A%20Fhirpath%20escape%20rules/near/258563345" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/sushi.3A.20Fhirpath.20escape.20rules.html#258563345">(Oct 21 2021 at 15:10)</a>:</h4>
<p>It would be nice to have a way to just copy in the fhirpath expressions and use them without escaping.</p>



<a name="258563874"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/sushi%3A%20Fhirpath%20escape%20rules/near/258563874" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/sushi.3A.20Fhirpath.20escape.20rules.html#258563874">(Oct 21 2021 at 15:13)</a>:</h4>
<p>Is there an escaping/un-escaping tool FHIRpath &lt;-&gt; FSH ?</p>



<a name="258569687"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/sushi%3A%20Fhirpath%20escape%20rules/near/258569687" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/sushi.3A.20Fhirpath.20escape.20rules.html#258569687">(Oct 21 2021 at 15:47)</a>:</h4>
<p>Can you provide some examples of the types of things you're commonly needing to escape?</p>



<a name="258571385"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/sushi%3A%20Fhirpath%20escape%20rules/near/258571385" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yannick Börner <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/sushi.3A.20Fhirpath.20escape.20rules.html#258571385">(Oct 21 2021 at 15:58)</a>:</h4>
<p>It is mostly generic FHIRPath expressions that look like this: </p>
<div class="codehilite"><pre><span></span><code>component.where(code.coding.system = &#39;http://loinc.org&#39; and code.coding.code = &#39;8462-4&#39;\).exists(\)
component.select(valueQuantity.code = &#39;mm[Hg]&#39;\).allTrue(\)
component.all(valueSampledData.exists(\)\)\)
component.all(valueSampledData.origin.exists(\)\)\)
entry.resource.all((code.coding.where(code = &#39;8462-4&#39; and system = &#39;http://loinc.org&#39;\).exists(\) or component.where(code.coding.where(code = &#39;8462-4&#39; and system = &#39;http://loinc.org&#39;\)\).exists(\)\) and (valueQuantity.where($this.value = 107\).exists(\) or component.valueQuantity.where($this.value = 107\).exists(\)\)\)
</code></pre></div>
<p>Notice how the escaping gets a bit crazy at times and impacts readability. We also have some cases in which we provide descriptions that contain i.e. a comma which needs to be escaped.</p>



<a name="258585105"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/sushi%3A%20Fhirpath%20escape%20rules/near/258585105" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/sushi.3A.20Fhirpath.20escape.20rules.html#258585105">(Oct 21 2021 at 17:24)</a>:</h4>
<p>Oh, I see.  It looks like you are passing FHIRPath as an argument to parameterized RuleSets?  Is that right?  Because I don't think you'd need to escape <code>)</code> and <code>,</code> otherwise.</p>



<a name="258674009"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/sushi%3A%20Fhirpath%20escape%20rules/near/258674009" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/sushi.3A.20Fhirpath.20escape.20rules.html#258674009">(Oct 22 2021 at 07:29)</a>:</h4>
<p>yes you are right <span class="user-mention" data-user-id="191469">@Chris Moesel</span></p>



<a name="262703333"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/sushi%3A%20Fhirpath%20escape%20rules/near/262703333" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/sushi.3A.20Fhirpath.20escape.20rules.html#262703333">(Nov 25 2021 at 13:07)</a>:</h4>
<p>I want to come back to this issue, i ran into this issue again when nesting RuleSets in Rulesets:</p>
<div class="codehilite"><pre><span></span><code>RuleSet: inner (linkId)
* item[+].linkId = {linkId}
  * item[+].linkId = {linkId}_question

RuleSet: outer (linkId)
* insert inner ({linkId})

Instance: Test
InstanceOf: Questionnaire
* insert outer (&quot;test\, test1&quot;)
</code></pre></div>



<a name="262703334"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/sushi%3A%20Fhirpath%20escape%20rules/near/262703334" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/sushi.3A.20Fhirpath.20escape.20rules.html#262703334">(Nov 25 2021 at 13:07)</a>:</h4>
<p>The escaping is lost after the first RuleSet -&gt; leading to an error.<br>
Would it be possible for the FSH Syntax/SUSHI to just accept Strings as they are?  ( ignore <code>,</code>and <code>)</code>if they are inside of a <code>"..."</code>block?)</p>



<a name="262704358"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/sushi%3A%20Fhirpath%20escape%20rules/near/262704358" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/sushi.3A.20Fhirpath.20escape.20rules.html#262704358">(Nov 25 2021 at 13:18)</a>:</h4>
<p><a href="https://fshschool.org/FSHOnline/#/share/3HV93fK">https://fshschool.org/FSHOnline/#/share/3HV93fK</a></p>



<a name="263304008"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/sushi%3A%20Fhirpath%20escape%20rules/near/263304008" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/sushi.3A.20Fhirpath.20escape.20rules.html#263304008">(Dec 01 2021 at 15:06)</a>:</h4>
<p><span class="user-mention" data-user-id="191469">@Chris Moesel</span>  can i make this a feature request issue? Or is something from the FSH grammar blocking this idea?</p>



<a name="263336596"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/sushi%3A%20Fhirpath%20escape%20rules/near/263336596" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/sushi.3A.20Fhirpath.20escape.20rules.html#263336596">(Dec 01 2021 at 18:38)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="191451">@Patrick Werner</span> -- parameterized rule sets are Trial-Use in FSH, so we do have the liberty to make changes like this.  Feel free to propose a change on the FHIR issue tracker (as I think that's where spec feature requests are supposed to go).  Make sure you indicate it is for the FHIR Shorthand spec.  As for whether or not we do it, I think we'll have to look at the implications and see if it adds new complications somewhere else.  I like the idea in principal, but we'll have to see if there are other consequences of making a change like this.</p>



<a name="263584110"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/sushi%3A%20Fhirpath%20escape%20rules/near/263584110" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bas van den Heuvel <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/sushi.3A.20Fhirpath.20escape.20rules.html#263584110">(Dec 03 2021 at 14:05)</a>:</h4>
<p>So far as I see, there is nothing in the shorthand specification where it requires parsing of the strings in a general context. <br>
This might just be an implementation feature, which I agree, is very annoying. </p>
<p>Related question: what does this mean for aliases? Will they also be replaced if the alias is in a text string?</p>



<a name="263588320"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/sushi%3A%20Fhirpath%20escape%20rules/near/263588320" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/sushi.3A.20Fhirpath.20escape.20rules.html#263588320">(Dec 03 2021 at 14:38)</a>:</h4>
<blockquote>
<p>So far as I see, there is nothing in the shorthand specification where it requires parsing of the strings in a general context.</p>
</blockquote>
<p>I'm not sure exactly what you mean, but in the context of using parameterized RuleSets, the spec only calls out that (a) parameters are wrapped in <code>(</code> <code>)</code>, (b) each parameter is separated by <code>,</code>, (c) literal <code>,</code> and <code>)</code> must be escaped inside a parameter, and (d) whitespace between parameters is removed (<a href="http://build.fhir.org/ig/HL7/fhir-shorthand/reference.html#inserting-parameterized-rule-sets">doc</a>).  The idea was to try to simplify the rules such that it really works like raw find/replace would.  Once we get into anything much more sophisticated, we need to treat parameters more like tokens, which complicates matters in some ways and also may restrict where placeholders can be in the RuleSet.</p>
<p>For example, imagine a RuleSet that contains a string like this: <code>"This is a profile for {Description}"</code>.  As it is defined today, you would just pass in <code>a patient</code> -- which would get substituted via simple find/replace.  But if we support special tokenization of the parameters (to support things like allowing strings with unescaped <code>,</code> in them), then you'd pass in <code>"a patient"</code> -- but it's no longer find/replace because we now need to be smart enough to know if we <em>keep</em> the wrapping <code>"</code> (when it represents a <em>whole string</em> in the RuleSet) or we discard the wrapping <code>"</code> (when it is <em>inside a string</em> in the RuleSet). This requires a more complicated parsing of the RuleSet before substitution.  That is, unless we also make a new rule that <code>"</code> is <em>always</em> stripped before substitution -- but that can also be confusing to users.  So... it's not as clear as it might seem.</p>
<blockquote>
<p>what does this mean for aliases? Will they also be replaced if the alias is in a text string?</p>
</blockquote>
<p>Aliases are only allowed where a URL token would be expected in the grammar, so an alias reference inside a string would not be replaced (e.g. <code>"The URI for LOINC is $LOINC."</code> would not replace the <code>$LOINC</code> alias with the LOINC URI).</p>



<a name="263593755"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/sushi%3A%20Fhirpath%20escape%20rules/near/263593755" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bas van den Heuvel <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/sushi.3A.20Fhirpath.20escape.20rules.html#263593755">(Dec 03 2021 at 15:16)</a>:</h4>
<p>Chris, <br>
Thanks for the response. If I understand your correctly, a rule such as stated below should just work.</p>
<blockquote>
<ul>
<li>insert fhirPathVariable( "score", "%resource.repeat(item).where(linkId = 'score').answer.value")</li>
</ul>
</blockquote>
<p>Yet, when I run this through   sushi I get the following errors:<br>
Importing FSH text...</p>
<blockquote>
<p>error extraneous input '.where(linkId' expecting {&lt;EOF&gt;, KW_ALIAS, KW_PROFILE, KW_EXTENSION, KW_INSTANCE, KW_INVARIANT, KW_VALUESET, KW_CODESYSTEM, KW_RULESET, KW_MAPPING, KW_LOGICAL, KW_RESOURCE}</p>
</blockquote>
<blockquote>
<p>error Cannot find definition for Instance: "%resource.repeat(item. Skipping rule.</p>
</blockquote>



<a name="263600551"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/sushi%3A%20Fhirpath%20escape%20rules/near/263600551" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/sushi.3A.20Fhirpath.20escape.20rules.html#263600551">(Dec 03 2021 at 16:06)</a>:</h4>
<p>No... I think that is what was being proposed as something to consider.  As it is today, however, you need to escape all <code>)</code> except the last one so they don't get interpreted as the end of the argument list.   So you need something more like: <code>insert fhirPathVariable( "score", "%resource.repeat(item\).where(linkId = 'score'\).answer.value")</code> (assuming the wrapping <code>"</code> are also intended to be literally inserted into the RuleSet).</p>



<a name="263819514"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/sushi%3A%20Fhirpath%20escape%20rules/near/263819514" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bas van den Heuvel <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/sushi.3A.20Fhirpath.20escape.20rules.html#263819514">(Dec 06 2021 at 08:23)</a>:</h4>
<p>No... I think that is what was being proposed as something to consider. As it is today, however, you need to escape all ) except the last one so they don't get interpreted as the end of the argument list. So you need something more like: insert fhirPathVariable( "score", "%resource.repeat(item\).where(linkId = 'score'\).answer.value") (assuming the wrapping " are also intended to be literally inserted into the RuleSet)</p>
<p>Chris, I think I understand the issue (and got mine to work). Thanks.<br>
As you indicated above the escapes are needed in order for the parser to identify the different input parameters. Too bad this causes a somewhat strangly formatted input format. The root cause behind this that for parameterised Rule inserts we seem to make a format shift. From the shorthand - one parameter on a line starting with an '*' to a more java/C-style format (I know that it is present in Reference(xx) like format but these are behind an '=').<br>
This shift is responsible that input intended for the 'shorthand' domain is to interpreted in the 'java-like' domain. The escapes are needed to resolve this. </p>
<p>This make me wonder what the more shorthand way of addressing this would be.<br>
A ruleset specified as</p>
<blockquote>
<p>RuleSet: variable( name, language, expression )
* extension[+]<br>
  * url = "<a href="http://hl7.org/fhir/StructureDefinition/variable">http://hl7.org/fhir/StructureDefinition/variable</a>"<br>
  * valueExpression<br>
    * name = {name}<br>
    * language = {language}<br>
    * expression = {expression}</p>
</blockquote>
<p>is now inserted as:</p>
<blockquote>
<ul>
<li>insert variable( "varNam", #text/fhirpath, "%resource.repeat(item\).answer.value.extension.value.aggregate($this+$total\,0\)" )</li>
</ul>
</blockquote>
<p>Note the escaped characters. As these are removed when the rule is nested, this makes nesting of such expressions difficult.<br>
From a shorthand perspective, the trailing ')' has no direct meaning as the end of the statement is determined by the next line starting with an '*'. </p>
<p>A more shorthand approach could be:</p>
<blockquote>
<ul>
<li>insert variable<ul>
<li>name = "varNam"</li>
<li>language = #text/fhirpath</li>
<li>expression = "%resource.repeat(item).answer.value.extension.value.aggregate($this+$total,0)"</li>
</ul>
</li>
</ul>
</blockquote>
<p>This would be more verbose but would retain the shorthand way of providing data. It would also allow nesting of rules as the beginning and end of each parameter is obvious. Wouldn't this be a better way to provide the parameters? Or an alternative if the bracketted approach does not work?</p>



<a name="263856993"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/sushi%3A%20Fhirpath%20escape%20rules/near/263856993" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/sushi.3A.20Fhirpath.20escape.20rules.html#263856993">(Dec 06 2021 at 14:27)</a>:</h4>
<p>Thanks for the suggestion, <span class="user-mention" data-user-id="194452">@Bas van den Heuvel</span>.  That is an interesting approach -- and one that we had not yet considered.  There are a few implications to consider:</p>
<ul>
<li><code>*</code> would need to be escaped in parameter values (unless we restricted the values to only allow valid tokens like a string, number, code, etc.)</li>
<li>It requires indenting -- which so far we've kept as a purely optional feature since some people really don't like it.  (E.g., in other cases, there is always a way to do something <em>without</em> indenting, but in this case, you <em>must</em> use indenting).</li>
</ul>
<p>I'm making a note to revisit parameterized RuleSets -- at which point we'll look at your suggestion, as well as Patrick's and anyone else who has ideas on how to improve this!</p>



<a name="263877703"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/sushi%3A%20Fhirpath%20escape%20rules/near/263877703" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elliot Silver <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/sushi.3A.20Fhirpath.20escape.20rules.html#263877703">(Dec 06 2021 at 16:39)</a>:</h4>
<p>Reading this thread, I wonder if two notations are needed? One would substitute the parameter as is; the other strips off a level of quoting and escaping. (Alternatively, one notation substitutes the parameter as is; the other adds quotes and escapes.) Something along the lines the following, using ! to indicate the new behaviour:</p>
<blockquote>
<p>RuleSet: variable( name, language, expression )  </p>
<ul>
<li>extension[+]<ul>
<li>...</li>
<li>name = {name}</li>
<li>language = {language}</li>
<li>expression = {!expression}</li>
</ul>
</li>
</ul>
</blockquote>
<p>or</p>
<blockquote>
<p>insert variable( "varNam", #text/fhirpath, !"%resource.repeat(item).answer.value.extension.value.aggregate($this+$total,0)" )</p>
</blockquote>
<p>The second version might actually be generally useful to outside of this context--take a string and escape it properly. I haven't had my coffee yet, or thought it through fully, but is there some value here?</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
