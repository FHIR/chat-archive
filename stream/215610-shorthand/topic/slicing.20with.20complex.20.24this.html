---
layout: page
title: "FHIR Chat  · slicing with complex $this · shorthand"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/index.html">shorthand</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html">slicing with complex $this</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="264169904"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/slicing%20with%20complex%20%24this/near/264169904" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html#264169904">(Dec 08 2021 at 15:20)</a>:</h4>
<p>I am struggling with more complex slicing beyond simple type. I have a need to slice on a extension which is a Reference, and need to slice on the Reference.Identifier.type element. I have a minimal FSH implementation guide that shows what I am trying to do. Would be glad to offer the working solution that we eventually come to as sample for others.</p>



<a name="264170243"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/slicing%20with%20complex%20%24this/near/264170243" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html#264170243">(Dec 08 2021 at 15:22)</a>:</h4>
<p>I have <code>^slicing.discriminator.path = "(value as Reference).identifier.type"</code> today, and Grahame says it needs to be <code>$this.value.ofType(Reference).identifier.type</code>, but that fails to build.</p>



<a name="264170315"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/slicing%20with%20complex%20%24this/near/264170315" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html#264170315">(Dec 08 2021 at 15:23)</a>:</h4>
<p>so I presume there is some translation of what Grahame is saying into sushi that I need</p>



<a name="264170369"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/slicing%20with%20complex%20%24this/near/264170369" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html#264170369">(Dec 08 2021 at 15:23)</a>:</h4>
<p><a href="https://github.com/JohnMoehrke/SlicingSlicedExtension">https://github.com/JohnMoehrke/SlicingSlicedExtension</a></p>



<a name="264174413"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/slicing%20with%20complex%20%24this/near/264174413" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html#264174413">(Dec 08 2021 at 15:47)</a>:</h4>
<p>Hmmm... I didn't think that the <code>$this.</code> prefix would be necessary since the context is assumed to be this (e.g., I thought that <code>value</code> would implicitly be <code>$this.value</code>).  Either way, <code>$this.value</code> certainly is not wrong.  I also think that the cast is valid, but agree that <code>ofType</code> is better (I actually forgot about the <code>ofType</code> function). So... the discriminator that Grahame suggested looks ok to me.  I'll have to look into this further when I have a chance later.</p>



<a name="264183115"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/slicing%20with%20complex%20%24this/near/264183115" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html#264183115">(Dec 08 2021 at 16:44)</a>:</h4>
<p>I feel stuck between a rock (IG builder) and a hard place (sushi). I only want to do the right thing, but can't figure out what the right thing is.</p>



<a name="264183310"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/slicing%20with%20complex%20%24this/near/264183310" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html#264183310">(Dec 08 2021 at 16:46)</a>:</h4>
<p>putting Grahame's recommendation into my FSH gives me a different error in the IG builder</p>
<div class="codehilite"><pre><span></span><code>Slicing cannot be evaluated: illegal use of ofType() in discriminator - Multiple possible types on Extension.value[x] (@char 1)
</code></pre></div>



<a name="264183451"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/slicing%20with%20complex%20%24this/near/264183451" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html#264183451">(Dec 08 2021 at 16:47)</a>:</h4>
<p>sushi does seem to create the right thing...</p>
<div class="codehilite"><pre><span></span><code>        &quot;slicing&quot;: {
          &quot;discriminator&quot;: [
            {
              &quot;type&quot;: &quot;pattern&quot;,
              &quot;path&quot;: &quot;$this.value.ofType(Reference).identifier.type&quot;
            }
          ],
          &quot;rules&quot;: &quot;open&quot;
        }
</code></pre></div>



<a name="264186109"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/slicing%20with%20complex%20%24this/near/264186109" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html#264186109">(Dec 08 2021 at 17:03)</a>:</h4>
<p>I added my small IG added to IG build<br>
<a href="http://build.fhir.org/ig/JohnMoehrke/SlicingSlicedExtension/branches/main/index.html">http://build.fhir.org/ig/JohnMoehrke/SlicingSlicedExtension/branches/main/index.html</a></p>



<a name="264189528"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/slicing%20with%20complex%20%24this/near/264189528" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html#264189528">(Dec 08 2021 at 17:27)</a>:</h4>
<p>It seems like <code>ofType</code> should be allowed there (based on the spec).  I'm not sure why it is not.  That said, maybe you can get by without it?  Have you tried: <code>$this.value.identifier.type</code>?</p>



<a name="264198182"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/slicing%20with%20complex%20%24this/near/264198182" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html#264198182">(Dec 08 2021 at 18:23)</a>:</h4>
<p>I get this error with that</p>
<div class="codehilite"><pre><span></span><code>Slicing cannot be evaluated: Error in discriminator at Extension.value[x]: no children, multiple types (@char 1)
</code></pre></div>



<a name="264201544"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/slicing%20with%20complex%20%24this/near/264201544" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html#264201544">(Dec 08 2021 at 18:47)</a>:</h4>
<p>Ha.  OK.  The way to fix that would be <code>ofType(Reference)</code>, but you know how that goes!</p>



<a name="264202363"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/slicing%20with%20complex%20%24this/near/264202363" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html#264202363">(Dec 08 2021 at 18:53)</a>:</h4>
<p>yup, back to that rock and hard-place</p>



<a name="265810001"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/slicing%20with%20complex%20%24this/near/265810001" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html#265810001">(Dec 22 2021 at 14:21)</a>:</h4>
<p>so, Grahame has provided examples in his validation github that he indicates work. The only difference I see in the json is that the id for the slice in his does not use the '/' character. And that character seems to be illegal in an id. Sushi is creating these id values... so, can this pattern be cleaned? (Note, I am very willing to be the failure, just not noticing any other difference between Grahames validation examples and what sushi creates from my sample IG.</p>
<p>- His - <a href="https://github.com/FHIR/fhir-test-cases/blob/0b6699c0a54c445722194773fbac7cd8b7ef8784/validator/structureDefinition-SecondSliceProfile.json">https://github.com/FHIR/fhir-test-cases/blob/0b6699c0a54c445722194773fbac7cd8b7ef8784/validator/structureDefinition-SecondSliceProfile.json</a></p>



<a name="265810472"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/slicing%20with%20complex%20%24this/near/265810472" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html#265810472">(Dec 22 2021 at 14:25)</a>:</h4>
<div class="codehilite"><pre><span></span><code>      {
        &quot;id&quot;: &quot;AuditEvent.agent:user.extension:otherIdnpi&quot;,
        &quot;path&quot;: &quot;AuditEvent.agent.extension&quot;,
        &quot;sliceName&quot;: &quot;otherId-npi&quot;,
        &quot;min&quot;: 0,
        &quot;max&quot;: &quot;1&quot;
      },
</code></pre></div>



<a name="265810597"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/slicing%20with%20complex%20%24this/near/265810597" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html#265810597">(Dec 22 2021 at 14:26)</a>:</h4>
<p>vs what I get out of sushi</p>
<div class="codehilite"><pre><span></span><code>      {
        &quot;id&quot;: &quot;AuditEvent.agent:user.extension:otherId/npi&quot;,
        &quot;path&quot;: &quot;AuditEvent.agent.extension&quot;,
        &quot;sliceName&quot;: &quot;otherId/npi&quot;,
        &quot;min&quot;: 0,
        &quot;max&quot;: &quot;1&quot;
      },
</code></pre></div>



<a name="265810819"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/slicing%20with%20complex%20%24this/near/265810819" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html#265810819">(Dec 22 2021 at 14:29)</a>:</h4>
<p>reminder that my github for my test IG for this use-case is <a href="https://github.com/JohnMoehrke/SlicingSlicedExtension">https://github.com/JohnMoehrke/SlicingSlicedExtension</a></p>



<a name="265812707"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/slicing%20with%20complex%20%24this/near/265812707" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html#265812707">(Dec 22 2021 at 14:47)</a>:</h4>
<p>I replied over in <a class="stream" data-stream-id="179252" href="/#narrow/stream/179252-IG-creation">#IG creation</a> too, but here is what I said there:</p>
<blockquote>
<p>I have not had the time to look at Grahame's example, but the <code>/</code> character is used when you are re-slicing.  In other words, if there is an existing slice defined and you need to create sub-slices within that slice, this is called re-slicing.  And in re-slicing, the sliceName is <code>${parentSliceName}/{subSliceName}</code>.  See <a href="http://hl7.org/fhir/R4/profiling.html#reslicinghttp://hl7.org/fhir/R4/profiling.html#reslicing">Re-profiling and Re-slicing</a> (particularly the last paragraph).</p>
</blockquote>
<p>While it is true that the <code>id</code> datatype does not allow <code>/</code>, that does not apply here because <code>ElementDefinition.id</code> is a <code>string</code>, not an <code>id</code> (despite its name).  This is why element IDs are also allowed to use <code>:</code> (which happens quite a lot).</p>
<p>I'll have to look at Grahame's example further to see how he is slicing it (without re-slicing), but AFAIK, re-slicing should work too.</p>



<a name="265812825"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/slicing%20with%20complex%20%24this/near/265812825" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html#265812825">(Dec 22 2021 at 14:48)</a>:</h4>
<p>turns out it is not that</p>



<a name="265813133"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/slicing%20with%20complex%20%24this/near/265813133" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html#265813133">(Dec 22 2021 at 14:51)</a>:</h4>
<p>the second profile has <code>sliceName:otherId</code> that Grahame does not have. Removing that clears the error</p>
<div class="codehilite"><pre><span></span><code>     {
        &quot;id&quot;: &quot;AuditEvent.agent:user.extension:otherId&quot;,
        &quot;path&quot;: &quot;AuditEvent.agent.extension&quot;,
       ~~ &quot;sliceName&quot;: &quot;otherId&quot;,~~
        &quot;slicing&quot;: {
          &quot;discriminator&quot;: [
            {
              &quot;type&quot;: &quot;pattern&quot;,
              &quot;path&quot;: &quot;$this.value.ofType(Reference).identifier.type&quot;
            }
          ],
          &quot;rules&quot;: &quot;open&quot;
        }
      },
</code></pre></div>



<a name="265814125"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/slicing%20with%20complex%20%24this/near/265814125" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html#265814125">(Dec 22 2021 at 15:00)</a>:</h4>
<p>so <code>otherId</code> is an extension defined in the first profile. Is sushi thinking that the <code>.extension[otherId]</code> is a slice and not an index?</p>



<a name="265817517"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/slicing%20with%20complex%20%24this/near/265817517" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html#265817517">(Dec 22 2021 at 15:33)</a>:</h4>
<p>I'm not sure I follow.  <code>.extension[otherId]</code> <em>is</em> a slice (not an index).  Extensions are, in reality, just slices of <code>extension</code> with <code>url</code> as the <code>discriminator.path</code>.  SUSHI includes the <code>sliceName</code> because we've been told in the past (and it might be documented somewhere, but I'd need to check) that you must <em>always</em> include the <code>sliceName</code> in the differential -- even if it is not <em>different</em> (i.e., it's inherited).  Isn't that the case, <span class="user-mention" data-user-id="191316">@Grahame Grieve</span>?  Or has that changed?</p>



<a name="265818041"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/slicing%20with%20complex%20%24this/near/265818041" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html#265818041">(Dec 22 2021 at 15:38)</a>:</h4>
<p>thanks for continuing to work on this. the extension is defined in the first slice, as is the <code>user</code> slice is not replicated in the second one, just the extension slice</p>



<a name="265819221"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/slicing%20with%20complex%20%24this/near/265819221" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html#265819221">(Dec 22 2021 at 15:48)</a>:</h4>
<p>I'm looking at Grahame's test case now.  <span class="user-mention" data-user-id="191316">@Grahame Grieve</span> -- I'm a little confused by this.  Here are some things I'm seeing that I am not sure of:</p>
<ol>
<li>
<p>The element with id <code>AuditEvent.agent:user.extension:otherId</code> does not redeclare the <code>sliceName</code> (<code>otherId</code>), but I think it is supposed to.</p>
</li>
<li>
<p>The element with id <code>AuditEvent.agent:user.extension:otherIdnpi</code> is supposed to be a re-slice of <code>otherId</code>, so shouldn't the last part of the element id be <code>otherId/npi</code>?</p>
</li>
<li>
<p>The children of the <code>AuditEvent.agent:user.extension:otherIdnpi</code> element have ids like <code>AuditEvent.agent:user.extension:otherId/npi.valueReference</code> (note they <em>do</em> have the <code>/</code>) -- which further seems to indicate that the first id is wrong.</p>
</li>
<li>
<p>Most of the <code>sliceName</code> values do <em>not</em> match the slice name in the id.  For example, the element with id <code>AuditEvent.agent:user.extension:otherId/provider-id</code> has sliceName <code>otherId-provider-id</code>.  Shouldn't those match?</p>
</li>
</ol>



<a name="265915446"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/slicing%20with%20complex%20%24this/near/265915446" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this.html#265915446">(Dec 23 2021 at 13:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="191404">John Moehrke</span> <a href="#narrow/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this/near/265813133">said</a>:</p>
<blockquote>
<p>the second profile has <code>sliceName:otherId</code> that Grahame does not have. Removing that clears the error</p>
<p><div class="codehilite"><pre><span></span><code>     {
        &quot;id&quot;: &quot;AuditEvent.agent:user.extension:otherId&quot;,
        &quot;path&quot;: &quot;AuditEvent.agent.extension&quot;,
       ~~ &quot;sliceName&quot;: &quot;otherId&quot;,~~
        &quot;slicing&quot;: {
          &quot;discriminator&quot;: [
            {
              &quot;type&quot;: &quot;pattern&quot;,
              &quot;path&quot;: &quot;$this.value.ofType(Reference).identifier.type&quot;
            }
          ],
          &quot;rules&quot;: &quot;open&quot;
        }
      },
</code></pre></div><br>
</p>
</blockquote>
<p>so, removing this one line produces good output. So either Sushi should not put it in, or validator should not complain that it is there.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
