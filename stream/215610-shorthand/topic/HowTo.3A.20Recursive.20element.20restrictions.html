---
layout: page
title: "FHIR Chat  · HowTo: Recursive element restrictions · shorthand"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/index.html">shorthand</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/HowTo.3A.20Recursive.20element.20restrictions.html">HowTo: Recursive element restrictions</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="277918670"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/HowTo%3A%20Recursive%20element%20restrictions/near/277918670" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jean Duteau <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/HowTo.3A.20Recursive.20element.20restrictions.html#277918670">(Apr 05 2022 at 17:55)</a>:</h4>
<p>I'm profiling Composition.section and it contains itself in the resource.  I'm trying to figure out how to apply my profile restrictions to the recursive elements without restating them.  Since I will essentially support unlimited recursion like the resource itself, I can't just restate them.  I can't see in the FSH specification how to support this.</p>



<a name="277919868"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/HowTo%3A%20Recursive%20element%20restrictions/near/277919868" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Pyke <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/HowTo.3A.20Recursive.20element.20restrictions.html#277919868">(Apr 05 2022 at 18:03)</a>:</h4>
<p>When I gofsh'd a resource that had a recursive (Consent), it gave me:</p>
<div class="codehilite"><pre><span></span><code>* provision.provision ^contentReference = &quot;#Consent.provision&quot;
</code></pre></div>



<a name="277922554"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/HowTo%3A%20Recursive%20element%20restrictions/near/277922554" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Al Pivonka <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/HowTo.3A.20Recursive.20element.20restrictions.html#277922554">(Apr 05 2022 at 18:23)</a>:</h4>
<p>moving to logical model mapping</p>



<a name="277923618"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/HowTo%3A%20Recursive%20element%20restrictions/near/277923618" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/HowTo.3A.20Recursive.20element.20restrictions.html#277923618">(Apr 05 2022 at 18:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="193364">Al Pivonka</span> has marked this topic as resolved.</p>



<a name="277923679"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/HowTo%3A%20Recursive%20element%20restrictions/near/277923679" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/HowTo.3A.20Recursive.20element.20restrictions.html#277923679">(Apr 05 2022 at 18:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="192166">Jean Duteau</span> has marked this topic as unresolved.</p>



<a name="277926484"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/HowTo%3A%20Recursive%20element%20restrictions/near/277926484" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jean Duteau <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/HowTo.3A.20Recursive.20element.20restrictions.html#277926484">(Apr 05 2022 at 18:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="192587">David Pyke</span> <a href="#narrow/stream/215610-shorthand/topic/HowTo.3A.20Recursive.20element.20restrictions/near/277919868">said</a>:</p>
<blockquote>
<p>When I gofsh'd a resource that had a recursive (Consent), it gave me:</p>
<p><div class="codehilite"><pre><span></span><code>* provision.provision ^contentReference = &quot;#Consent.provision&quot;
</code></pre></div><br>
</p>
</blockquote>
<p>I've done that for logical models, but I'm not sure how to do that for profiles.</p>
<p>I did  <code>* section ^contentReference = "#Composition.section.section"</code> and that "works" in that it does do the reference.  But it's not a reference to my constraints.  I then tried     <code>* section ^contentReference = "#ProductSubmissionDocument.section.section"</code> and that doesn't work.</p>



<a name="278019194"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/HowTo%3A%20Recursive%20element%20restrictions/near/278019194" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/HowTo.3A.20Recursive.20element.20restrictions.html#278019194">(Apr 06 2022 at 12:58)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="192166">@Jean Duteau</span>.  Getting constraints to apply recursively w/ contentRefs is a little tricky - and not very intuitive.  There is a <a href="#narrow/stream/179252-IG-creation/topic/Clarification.20on.20contentReference/near/187852423">previous zulip conversation</a> where Grahame suggests that the <a href="http://hl7.org/fhir/R4/extension-elementdefinition-profile-element.html">elementdefinition-profile-element extension</a> should be used for this.  Based on that conversation, we built in support to ensure that SUSHI handles this correctly.  It's described in the <a href="https://github.com/FHIR/sushi/releases/tag/v2.0.0">SUSHI 2.0.0 Release Notes</a>:</p>
<blockquote>
<p><strong>Extension for Profiling BackboneElements</strong></p>
<p>The <code>profile-element</code> extension can be used to profile a BackboneElement by pointing at another BackboneElement defined elsewhere. This is typically used to indicate that constraints on the target of a contentReference should be applied to all the references as well. For example, the following snippet indicates the all recursive references to <code>Questionnaire.item</code> (e.g., <code>Questionnaire.item.item</code>) should conform to the same constraints as the original <code>Questionnaire.item</code> in this profile:</p>
<p><code>Profile: MyQuestionnaire</code><br>
<code>Parent: Questionnaire</code><br>
<code>* Questionnaire.item ^type.profile = http://example.org/StructureDefinition/MyQuestionnaire</code><br>
<code>* Questionnaire.item ^type.profile.extension.url = http://hl7.org/fhir/StructureDefinition/elementdefinition-profile-element</code><br>
<code>* Questionnaire.item ^type.profile.extension.valueString = "Questionnaire.item"</code><br>
<code>// ...</code></p>
</blockquote>



<a name="278038632"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/HowTo%3A%20Recursive%20element%20restrictions/near/278038632" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jean Duteau <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/HowTo.3A.20Recursive.20element.20restrictions.html#278038632">(Apr 06 2022 at 15:12)</a>:</h4>
<p>I tried this yesterday because a little bird whispered in my ear about this, but I wasn't sure how to generalize what was in the Release Notes to what I wanted to do...</p>
<div class="codehilite"><pre><span></span><code>Profile: ProductSubmissionDocument
Parent: Composition
Description: &quot;A profile that represents a document that is required for Product Submission to the FDA.&quot;

* extension contains VersionNumber named versionNumber 1..1 MS
* type MS
* type from SPLDocumentCodes (required)
* title MS
* identifier 1..1 MS
* author 1..1 MS
* author only Reference(IdentifiedLabeler)
* section 1..* MS
  * extension contains SectionIdentifier named sectionID 0..1 MS and SectionEffectiveTime named sectionTime 0..1 MS
  * code 1..1 MS
  * code from SPLSectionCodes (required)
  * title MS
  * text MS
  * entry MS
  * section MS
* Composition.section ^type.profile = http://hl7.org/fhir/us/spl/StructureDefinition/ProductSubmissionDocument
* Composition.section ^type.profile.extension.url = http://hl7.org/fhir/StructureDefinition/elementdefinition-profile-element
* Composition.section ^type.profile.extension.valueString = &quot;Composition.section&quot;
</code></pre></div>
<div class="codehilite"><pre><span></span><code>error No element found at path Composition.section for CaretValueRule in ProductSubmissionDocument, skipping rule
  File: /Users/jeanduteau/Documents/DDIWork/Samvit/SPL/fhir-spl/input/fsh/ProductSubmission.fsh
  Line: 38
error No element found at path Composition.section for CaretValueRule in ProductSubmissionDocument, skipping rule
  File: /Users/jeanduteau/Documents/DDIWork/Samvit/SPL/fhir-spl/input/fsh/ProductSubmission.fsh
  Line: 39
error No element found at path Composition.section for CaretValueRule in ProductSubmissionDocument, skipping rule
  File: /Users/jeanduteau/Documents/DDIWork/Samvit/SPL/fhir-spl/input/fsh/ProductSubmission.fsh
  Line: 40
</code></pre></div>



<a name="278038800"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/HowTo%3A%20Recursive%20element%20restrictions/near/278038800" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jean Duteau <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/HowTo.3A.20Recursive.20element.20restrictions.html#278038800">(Apr 06 2022 at 15:13)</a>:</h4>
<p>And my next question is whether I can make a different set of constraints on Composition.section.section and have those constraints apply recursively.</p>



<a name="278042103"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/HowTo%3A%20Recursive%20element%20restrictions/near/278042103" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/HowTo.3A.20Recursive.20element.20restrictions.html#278042103">(Apr 06 2022 at 15:34)</a>:</h4>
<p>Well, that's embarrassing.  The release notes had invalid paths.  This is FSH, so you <em>don't</em> prefix the resource name to the path.  So for those last three rules, it should be <code>* section ...</code> not <code>* Composition.section ...</code>.  I've updated the release notes and the comment above so no one else trips up on this.</p>



<a name="278042505"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/HowTo%3A%20Recursive%20element%20restrictions/near/278042505" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/HowTo.3A.20Recursive.20element.20restrictions.html#278042505">(Apr 06 2022 at 15:36)</a>:</h4>
<p>As for your next question, I'm not 100% sure, but <em>maybe</em> this?</p>
<div class="codehilite"><pre><span></span><code>* section.section ^type.profile = http://hl7.org/fhir/us/spl/StructureDefinition/ProductSubmissionDocument
* section.section ^type.profile.extension.url = http://hl7.org/fhir/StructureDefinition/elementdefinition-profile-element
* section.section ^type.profile.extension.valueString = &quot;Composition.section.section&quot;
</code></pre></div>
<p>TBH, this was always a little bit of black magic to me, so I can't guarantee that this would work (for recursing constraints in section.section).</p>



<a name="278042952"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/HowTo%3A%20Recursive%20element%20restrictions/near/278042952" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jean Duteau <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/HowTo.3A.20Recursive.20element.20restrictions.html#278042952">(Apr 06 2022 at 15:39)</a>:</h4>
<p>When I do that (which I did try yesterday), I get IGPublisher errors:</p>
<div class="codehilite"><pre><span></span><code>* section 0..* MS
  * extension contains SectionIdentifier named sectionID 0..1 MS and SectionEffectiveTime named sectionTime 0..1 MS
  * code 1..1 MS
  * code from SPLSectionCodes (required)
  * title MS
  * text MS
  * entry MS
* section ^type.profile = http://hl7.org/fhir/us/spl/StructureDefinition/ProductSubmissionDocument
* section ^type.profile.extension.url = http://hl7.org/fhir/StructureDefinition/elementdefinition-profile-element
* section ^type.profile.extension.valueString = &quot;Composition.section&quot;
</code></pre></div>
<div class="codehilite"><pre><span></span><code>java.lang.Exception: Error generating snapshot for ProductSubmissionBundle(ProductSubmissionBundle): Unable to generate snapshot for http://hl7.org/fhir/us/spl/StructureDefinition/ProductSubmissionBundle in /Users/jeanduteau/Documents/DDIWork/Samvit/SPL/fhir-spl/fsh-generated/resources/structuredefinition-ProductSubmissionBundle
    at org.hl7.fhir.igtools.publisher.Publisher.generateSnapshots(Publisher.java:5411)
    at org.hl7.fhir.igtools.publisher.Publisher.loadConformance(Publisher.java:4668)
    at org.hl7.fhir.igtools.publisher.Publisher.createIg(Publisher.java:1006)
    at org.hl7.fhir.igtools.publisher.Publisher.execute(Publisher.java:857)
    at org.hl7.fhir.igtools.publisher.Publisher.main(Publisher.java:10033)
Caused by: org.hl7.fhir.exceptions.FHIRException: Unable to generate snapshot for http://hl7.org/fhir/us/spl/StructureDefinition/ProductSubmissionBundle in /Users/jeanduteau/Documents/DDIWork/Samvit/SPL/fhir-spl/fsh-generated/resources/structuredefinition-ProductSubmissionBundle
    at org.hl7.fhir.igtools.publisher.Publisher.generateSnapshot(Publisher.java:5464)
    at org.hl7.fhir.igtools.publisher.Publisher.generateSnapshots(Publisher.java:5409)
    ... 4 more
Caused by: org.hl7.fhir.exceptions.DefinitionException: Unable to find element Composition.section in http://hl7.org/fhir/us/spl/StructureDefinition/ProductSubmissionDocument
    at org.hl7.fhir.r5.conformance.ProfileUtilities.processPaths(ProfileUtilities.java:1214)
    at org.hl7.fhir.r5.conformance.ProfileUtilities.processPaths(ProfileUtilities.java:1485)
    at org.hl7.fhir.r5.conformance.ProfileUtilities.processPaths(ProfileUtilities.java:1109)
    at org.hl7.fhir.r5.conformance.ProfileUtilities.generateSnapshot(ProfileUtilities.java:669)
    at org.hl7.fhir.r5.conformance.ProfileUtilities.processPaths(ProfileUtilities.java:1203)
    at org.hl7.fhir.r5.conformance.ProfileUtilities.processPaths(ProfileUtilities.java:1548)
</code></pre></div>



<a name="278057525"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/HowTo%3A%20Recursive%20element%20restrictions/near/278057525" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/HowTo.3A.20Recursive.20element.20restrictions.html#278057525">(Apr 06 2022 at 17:23)</a>:</h4>
<p>I see <code>ProductSubmissionBundle</code> and <code>ProductSubmissionDocument</code> in that stack trace.  I assume that <code>ProductSubmissionBundle</code> is profiled to have an entry slice with a resource conforming to <code>ProductSubmissionDocument</code>?  If you comment out that slice, does the IG Publisher choke on <code>ProductSubmissionDocument</code> when it processes it standalone?  Or only in the context of <code>ProductSubmissionBundle</code>?</p>
<p>I actually have no idea what's going on here, but sometimes narrowing it down helps.  For example, if we know the IGP generates the <code>ProductSubmissionDocument</code> snapshot fine (which is the profile w/ the recursive magic in it), then it would appear the issue is related to <em>using</em> it in another context.  Either way, I think you've likely crossed the line into <a class="stream" data-stream-id="179252" href="/#narrow/stream/179252-IG-creation">#IG creation</a> or <a class="stream" data-stream-id="179177" href="/#narrow/stream/179177-conformance">#conformance</a> at that point, as I think you're doing things as Grahame specified in that original thread.</p>



<a name="278057838"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/HowTo%3A%20Recursive%20element%20restrictions/near/278057838" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jean Duteau <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/HowTo.3A.20Recursive.20element.20restrictions.html#278057838">(Apr 06 2022 at 17:26)</a>:</h4>
<p>ah, I hadn't noticed the two profiles.  let me go try that...</p>



<a name="278058146"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/HowTo%3A%20Recursive%20element%20restrictions/near/278058146" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jean Duteau <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/HowTo.3A.20Recursive.20element.20restrictions.html#278058146">(Apr 06 2022 at 17:28)</a>:</h4>
<p>no beans.  when I comment out the slice in the bundle, the error just shifts to the document:</p>
<div class="codehilite"><pre><span></span><code>java.lang.Exception: Error generating snapshot for ProductSubmissionDocument(ProductSubmissionDocument): Unable to generate snapshot for http://hl7.org/fhir/us/spl/StructureDefinition/ProductSubmissionDocument in /Users/jeanduteau/Documents/DDIWork/Samvit/SPL/fhir-spl/fsh-generated/resources/structuredefinition-ProductSubmissionDocument
    at org.hl7.fhir.igtools.publisher.Publisher.generateSnapshots(Publisher.java:5411)
    at org.hl7.fhir.igtools.publisher.Publisher.loadConformance(Publisher.java:4668)
    at org.hl7.fhir.igtools.publisher.Publisher.createIg(Publisher.java:1006)
    at org.hl7.fhir.igtools.publisher.Publisher.execute(Publisher.java:857)
    at org.hl7.fhir.igtools.publisher.Publisher.main(Publisher.java:10033)
Caused by: org.hl7.fhir.exceptions.FHIRException: Unable to generate snapshot for http://hl7.org/fhir/us/spl/StructureDefinition/ProductSubmissionDocument in /Users/jeanduteau/Documents/DDIWork/Samvit/SPL/fhir-spl/fsh-generated/resources/structuredefinition-ProductSubmissionDocument
    at org.hl7.fhir.igtools.publisher.Publisher.generateSnapshot(Publisher.java:5464)
    at org.hl7.fhir.igtools.publisher.Publisher.generateSnapshots(Publisher.java:5409)
    ... 4 more
Caused by: org.hl7.fhir.exceptions.DefinitionException: Unable to find element Composition.section in http://hl7.org/fhir/us/spl/StructureDefinition/ProductSubmissionDocument
    at org.hl7.fhir.r5.conformance.ProfileUtilities.processPaths(ProfileUtilities.java:1214)
    at org.hl7.fhir.r5.conformance.ProfileUtilities.processPaths(ProfileUtilities.java:1485)
    at org.hl7.fhir.r5.conformance.ProfileUtilities.generateSnapshot(ProfileUtilities.java:669)
    at org.hl7.fhir.igtools.publisher.Publisher.generateSnapshot(Publisher.java:5459)
    ... 5 more
</code></pre></div>



<a name="278058211"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/215610-shorthand/topic/HowTo%3A%20Recursive%20element%20restrictions/near/278058211" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jean Duteau <a href="https://fhir.github.io/chat-archive/stream/215610-shorthand/topic/HowTo.3A.20Recursive.20element.20restrictions.html#278058211">(Apr 06 2022 at 17:28)</a>:</h4>
<p>I'll raise this on <a class="stream" data-stream-id="179252" href="/#narrow/stream/179252-IG-creation">#IG creation</a></p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
