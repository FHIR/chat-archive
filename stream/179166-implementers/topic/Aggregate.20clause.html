---
layout: page
title: "FHIR Chat  · Aggregate clause · implementers"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/index.html">implementers</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Aggregate.20clause.html">Aggregate clause</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="256086710"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Aggregate%20clause/near/256086710" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Montavon <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Aggregate.20clause.html#256086710">(Oct 04 2021 at 16:21)</a>:</h4>
<p>I am trying to test the aggregate clause in the Atom extension. I'm using the following code from the developer's guide:</p>
<p>define "FactorialOfFive":<br>
  ({ 1, 2, 3, 4, 5 }) Num<br>
    aggregate Result starting 1: Result * Num </p>
<p>This returns the original list ({ 1, 2, 3, 4, 5 }) instead of 120. </p>
<p>It looks like the aggregate clause is a new feature of CQL 1.5. And, the atom extension lists CQL 1.5 in its dependencies. How do I know if this is a bug or hasn't truly been implemented yet?</p>
<p>Thanks in advance.</p>



<a name="256088871"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Aggregate%20clause/near/256088871" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Aggregate.20clause.html#256088871">(Oct 04 2021 at 16:32)</a>:</h4>
<p><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span></p>



<a name="256167255"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Aggregate%20clause/near/256167255" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Aggregate.20clause.html#256167255">(Oct 05 2021 at 02:39)</a>:</h4>
<p>Hi Joel!</p>
<p>The cql-engine used by Atom doesn’t (yet) implement all of the 1.5 features. Aggregate is a missing one. There’s an issue tracking that here:</p>
<p><a href="https://github.com/DBCG/cql_engine/issues/373">https://github.com/DBCG/cql_engine/issues/373</a></p>



<a name="259544537"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Aggregate%20clause/near/259544537" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rebecca Green <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Aggregate.20clause.html#259544537">(Oct 29 2021 at 15:55)</a>:</h4>
<p>Asked this in a different channel but feel like it might be appropriate to ask on this thread. I'm trying to write a function similar to this:</p>
<div class="codehilite"><pre><span></span><code>define function AggregateFunction():
  (expand Interval[1, 4]) C
  aggregate S starting ({
    A: null,
    B: null,
    C: null,
    D: null
  } as Tuple {
    A Boolean,
    B Boolean,
    C Boolean,
    D Boolean
  }):
  case
    when C &gt; 1 then S.A is true
    when C = 1 then S.B is true
    when C &lt; 1 then S.C is true
    when C = 0 then S.D is true
    else S
  end
</code></pre></div>
<p>But I'm getting this syntax error: <code>Expected an expression of type 'System.Boolean', but found an expression of type 'tuple of A: System.Boolean, B: System.Boolean, C: System.Boolean, D: System.Boolean'.</code> </p>
<p>I thought that by specifying the starting value as the tuple the cql would expect the tuple as a response. Any help? Thoughts on what I'm getting wrong here?</p>



<a name="259559012"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Aggregate%20clause/near/259559012" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Aggregate.20clause.html#259559012">(Oct 29 2021 at 17:41)</a>:</h4>
<p><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span></p>



<a name="259566217"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Aggregate%20clause/near/259566217" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rebecca Green <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Aggregate.20clause.html#259566217">(Oct 29 2021 at 18:36)</a>:</h4>
<p>I think i understand the error. because I am returning a boolean and when with <code>S.A is true</code>. It seems that cql doesn't allow you do multiple thing after <code>then</code> ideally i would write <code>assign S.A to true then return S</code> but not sure that's possible.</p>



<a name="259572273"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Aggregate%20clause/near/259572273" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Aggregate.20clause.html#259572273">(Oct 29 2021 at 19:28)</a>:</h4>
<p>Yes, the aggregate clause is letting you specify the accumulating expression, and optionally the starting expression. In this case you've specified the starting expression as a tuple { A: Any, B: Any, C: Any, D: Any }, so that determines the shape of the accumulator, and it's expecting the accumulating expression to return that same shape.</p>



<a name="259572518"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Aggregate%20clause/near/259572518" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Aggregate.20clause.html#259572518">(Oct 29 2021 at 19:30)</a>:</h4>
<p>In theory, a case expression could return a choice of all the types of all the <code>then</code> expressions and the <code>else</code> expression, but the translator takes the more conservative approach of using the type of the first case to determine the expression, and then seeing if there are implicit conversions to/from the type of all the conditions. So the case expression will do some promotion, but not a completely general choice like that, and it falls back to a type error on the else condition.</p>



<a name="259572544"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Aggregate%20clause/near/259572544" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Aggregate.20clause.html#259572544">(Oct 29 2021 at 19:30)</a>:</h4>
<p><span class="user-mention" data-user-id="427685">@Rebecca Green</span></p>



<a name="259573528"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Aggregate%20clause/near/259573528" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rebecca Green <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Aggregate.20clause.html#259573528">(Oct 29 2021 at 19:39)</a>:</h4>
<p>Thanks! That makes sense. Do you know if there's a way to update the value in the Tuple and return the Tuple itself  in one line? So for example that same code would look something like this: </p>
<div class="codehilite"><pre><span></span><code>define function AggregateFunction():
  (expand Interval[1, 4]) C
  aggregate S starting ({
    A: null,
    B: null,
    C: null,
    D: null
  } as Tuple {
    A Boolean,
    B Boolean,
    C Boolean,
    D Boolean
  }):
  case
    when C &gt; 1 then S.A is true return S
    when C = 1 then S.B is true return S
    when C &lt; 1 then S.C is true return S
    when C = 0 then S.D is true return S
    else S
  end
</code></pre></div>
<p>That way I wouldn't get a Type error and could keep track of what conditions of have been updated.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
