---
layout: page
title: "FHIR Chat  · FHIR Mapping Language Question · implementers"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/index.html">implementers</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/FHIR.20Mapping.20Language.20Question.html">FHIR Mapping Language Question</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="273717117"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/FHIR%20Mapping%20Language%20Question/near/273717117" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/FHIR.20Mapping.20Language.20Question.html#273717117">(Mar 01 2022 at 21:58)</a>:</h4>
<p>Hi all, I received a question on FHIR Mapping Language + Validation and was hoping for confirmation.  Starting from the (unfortunately named =) <a href="https://hl7.org/fhir/r3maps.html">Transforms between DSTU 3 and STU 4</a>, I am looking at (for example) <a href="https://hl7.org/fhir/observation-version-maps.html">Observation</a>.</p>
<p>When mapping into extensions (e.g., <code>v3.related where type=interfered-by</code>), the extension extension URL is: <code>http://hl7.org/fhir/3.0/StructureDefinition/Observation.interferedBy</code>, which is different from the cross-version extension URL: <code>http://hl7.org/fhir/3.0/StructureDefinition/extension-Observation.related</code>.</p>
<p>The extensions used in the mapping language are not actually defined, which unfortunately means they fail validation.  Is the intention just that they are used in the context of transformations and should ignore the validation warnings, or are the mapping files out of date and the 'correct' way is to use the cross-version extensions?  Thanks!</p>



<a name="273725573"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/FHIR%20Mapping%20Language%20Question/near/273725573" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/FHIR.20Mapping.20Language.20Question.html#273725573">(Mar 01 2022 at 23:06)</a>:</h4>
<p>I think the mappings are out of date.</p>



<a name="273729891"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/FHIR%20Mapping%20Language%20Question/near/273729891" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Silva <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/FHIR.20Mapping.20Language.20Question.html#273729891">(Mar 01 2022 at 23:47)</a>:</h4>
<p>I've found another example of where the DSTU2 to STU3 FHIR mappings are out of sync with 'reality'; I forget the specific example but when I posted about it I was told that it's not likely that the mapping would be updated.</p>



<a name="273752497"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/FHIR%20Mapping%20Language%20Question/near/273752497" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/FHIR.20Mapping.20Language.20Question.html#273752497">(Mar 02 2022 at 04:09)</a>:</h4>
<p>In principle, they could be fixed in R4B, but we'd need a FHIR mapping language volunteer to do it  who isn't Grahame - and we'd need the work done in the next week or so.</p>



<a name="273753236"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/FHIR%20Mapping%20Language%20Question/near/273753236" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/FHIR.20Mapping.20Language.20Question.html#273753236">(Mar 02 2022 at 04:20)</a>:</h4>
<p>Thanks for the info!  I doubt that timeframe is realistic to spin up on the work that needs to be done though.  I will check to see if anything can be done post-R4B release though.</p>



<a name="273765777"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/FHIR%20Mapping%20Language%20Question/near/273765777" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> René Spronk <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/FHIR.20Mapping.20Language.20Question.html#273765777">(Mar 02 2022 at 07:26)</a>:</h4>
<p>AFAIK the only mappings that are well maintained are the ones for the conformance resources. For any other resource types there's no guarantee that they exist, nor that they're up to date. Obviously it would be nice if they were to exist, but then we'd need a (new) volunteer to maintain them.</p>



<a name="273821202"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/FHIR%20Mapping%20Language%20Question/near/273821202" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/FHIR.20Mapping.20Language.20Question.html#273821202">(Mar 02 2022 at 15:13)</a>:</h4>
<p>Mappings also exist in 2 repos:</p>
<ul>
<li><a href="https://github.com/HL7/fhir/blob/master/implementations/r3maps/R3toR4/">https://github.com/HL7/fhir/blob/master/implementations/r3maps/R3toR4/</a></li>
<li><a href="https://github.com/FHIR/interversion/tree/master/r4/R3toR4">https://github.com/FHIR/interversion/tree/master/r4/R3toR4</a></li>
</ul>
<p>Is one of these "official," and how do we intend to keep these in sync?</p>



<a name="273826485"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/FHIR%20Mapping%20Language%20Question/near/273826485" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/FHIR.20Mapping.20Language.20Question.html#273826485">(Mar 02 2022 at 15:45)</a>:</h4>
<p>Hmm.. I wonder if this is something that could be moved into core editing somehow.  E.g., if you modify a resource, you also modify some map information to keep it up to date.  Probably not worth cycles thinking about right now though.</p>



<a name="273864018"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/FHIR%20Mapping%20Language%20Question/near/273864018" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Silva <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/FHIR.20Mapping.20Language.20Question.html#273864018">(Mar 02 2022 at 19:32)</a>:</h4>
<p>I found one of the tickets, <a href="https://jira.hl7.org/browse/FHIR-35797">FHIR-35797</a>, I submitted for ClinicalImpression.finding.cause mapping is missing in DSTU2 to STU3 version map.  The fix, assuming it's one line of missing FML, should be easy.</p>
<p>I think this line is just a typo:<br>
<code>  "ClinicalImpression.finding-reason" : for src.reason make tgt.basis</code><br>
should be:<br>
<code>  "ClinicalImpression.finding-cause" : for src.reason make tgt.basis</code></p>
<p>There is no ClinicalImpression.finding[].reason property in STU3.</p>



<a name="273917071"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/FHIR%20Mapping%20Language%20Question/near/273917071" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/FHIR.20Mapping.20Language.20Question.html#273917071">(Mar 03 2022 at 03:30)</a>:</h4>
<p><span class="user-mention" data-user-id="222054">@Gino Canessa</span> the set of people who know how to use the mapping language is significantly smaller than the set of people who know how to maintain resources.  (And that set isn't huge.)</p>



<a name="273921730"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/FHIR%20Mapping%20Language%20Question/near/273921730" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/FHIR.20Mapping.20Language.20Question.html#273921730">(Mar 03 2022 at 04:39)</a>:</h4>
<p>Yep, idle theorizing.  Mostly pinning in the back of my head to think about.</p>



<a name="273951033"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/FHIR%20Mapping%20Language%20Question/near/273951033" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Declan Kieran <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/FHIR.20Mapping.20Language.20Question.html#273951033">(Mar 03 2022 at 10:15)</a>:</h4>
<p><span class="user-mention" data-user-id="222054">@Gino Canessa</span> <span class="user-mention" data-user-id="191320">@Lloyd McKenzie</span> </p>
<p>In testing 3to4 transforms using the validator_cli, I wrote a script to do a level of validation on the transforms.  What it does is described here</p>
<p><a href="https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/tree/main/scripts">https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/tree/main/scripts</a></p>
<p>The script is</p>
<p><a href="https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/blob/main/scripts/generate_comparison.py">https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/blob/main/scripts/generate_comparison.py</a></p>
<p>basically, it uses the source and target StructureDefinitions to work out if the transform is correct based on what is contained in the input and what ends up in the transform.  I had in the back of my head when I was writing it, the notion that it might a good test harness for updating the maps.  They're actually quite complete from what it 's show so far though.</p>
<p>It will identify</p>
<ul>
<li>Definitely lost data</li>
<li>Data that is invalid (i.e. shouldn't be in the input)</li>
<li>Data that might be lost or renamed either in the source or target (because a mapping isn't referenced).</li>
</ul>
<p>in a generated report</p>
<p><a href="https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/tree/main/examples">https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/tree/main/examples</a></p>
<p>It currently has the limitation of not looking at data, it just looks at the keys and only so far as is defined in the StructureDefinition snapshot elements, and its only for STU3 to R4.  More details on limitations here</p>
<p><a href="https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/tree/main/scripts#limitations--scope-for-extension">https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/tree/main/scripts#limitations--scope-for-extension</a></p>
<p>It might be useful for what you're talking about as it should indicate potential issues with transforms assuming you have a good set of input data to test.  I still need to write some unit tests for code, but I'm pretty sure where a transform has no issues, then it can be considered correct (well in terms of keys, to the level as defined...).  I think it should be straightforward as well to extend it to look at the data, and even reference maps, but I haven't got round to that yet...</p>
<p>One other thing, is I needed to make a modification to the xver package as there is an issue with the code finding the STU3 definitions if the target is not a versioned URL in the StructureMaps.</p>
<p>There is a github pipeline that shows how it is ran on a linux machine</p>
<p><a href="https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/blob/main/.github/workflows/validate-transforms.yml">https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/blob/main/.github/workflows/validate-transforms.yml</a></p>
<p>As for using this to get all maps fully correct by next week, even just for 3 to 4, I think that might be ambitious!</p>



<a name="274104803"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/FHIR%20Mapping%20Language%20Question/near/274104803" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Peretokin <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/FHIR.20Mapping.20Language.20Question.html#274104803">(Mar 04 2022 at 09:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="222054">Gino Canessa</span> <a href="#narrow/stream/179166-implementers/topic/FHIR.20Mapping.20Language.20Question/near/273717117">said</a>:</p>
<blockquote>
<p>Hi all, I received a question on FHIR Mapping Language + Validation and was hoping for confirmation.  Starting from the (unfortunately named =) <a href="https://hl7.org/fhir/r3maps.html">Transforms between DSTU 3 and STU 4</a>, I am looking at (for example) <a href="https://hl7.org/fhir/observation-version-maps.html">Observation</a>.</p>
<p>When mapping into extensions (e.g., <code>v3.related where type=interfered-by</code>), the extension extension URL is: <code>http://hl7.org/fhir/3.0/StructureDefinition/Observation.interferedBy</code>, which is different from the cross-version extension URL: <code>http://hl7.org/fhir/3.0/StructureDefinition/extension-Observation.related</code>.</p>
<p>The extensions used in the mapping language are not actually defined, which unfortunately means they fail validation.  Is the intention just that they are used in the context of transformations and should ignore the validation warnings, or are the mapping files out of date and the 'correct' way is to use the cross-version extensions?  Thanks!</p>
</blockquote>
<p>I think it was just a mistake that they're not aligned. The <a href="https://github.com/HL7/fhir/commit/641002468f296d9085044e7704733e224a609f82">format</a> for the extensions and the <a href="https://github.com/HL7/fhir/commit/70321f285d08c25eccaca8468bcbf19a5f6a6a16">first use</a> of extensions was both in 2018 a few months apart.</p>
<p>It looks like a relatively simple change - if that's all there is to it, does not seem like a problem to fix. I'll look into it this weekend. No promises it'll fix all your validation issues, I haven't looked at the mappings in a while so we might discover other gremlins.</p>
<p>Which branch is tracking the R4B release on github? Is it <code>master</code>?</p>



<a name="274138884"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/FHIR%20Mapping%20Language%20Question/near/274138884" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/FHIR.20Mapping.20Language.20Question.html#274138884">(Mar 04 2022 at 14:49)</a>:</h4>
<p>R4B</p>



<a name="274146693"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/FHIR%20Mapping%20Language%20Question/near/274146693" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/FHIR.20Mapping.20Language.20Question.html#274146693">(Mar 04 2022 at 15:40)</a>:</h4>
<p>Thanks Vadim!</p>



<a name="274503277"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/FHIR%20Mapping%20Language%20Question/near/274503277" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Peretokin <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/FHIR.20Mapping.20Language.20Question.html#274503277">(Mar 08 2022 at 06:55)</a>:</h4>
<p><a href="https://github.com/HL7/fhir/pull/1758">https://github.com/HL7/fhir/pull/1758</a>, have a look to see if that solves the problem!</p>



<a name="274589759"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/FHIR%20Mapping%20Language%20Question/near/274589759" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/FHIR.20Mapping.20Language.20Question.html#274589759">(Mar 08 2022 at 19:05)</a>:</h4>
<p>Awesome! I added a quick correction <a href="https://github.com/HL7/fhir/pull/1758/files#r821982009">here</a>. Once merged is there a process for propagating these changes to keep these two in sync:</p>
<ul>
<li><a href="https://github.com/HL7/fhir/blob/master/implementations/r3maps/R3toR4/">https://github.com/HL7/fhir/blob/master/implementations/r3maps/R3toR4/</a></li>
<li><a href="https://github.com/FHIR/interversion/tree/master/r4/R3toR4">https://github.com/FHIR/interversion/tree/master/r4/R3toR4</a></li>
</ul>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
