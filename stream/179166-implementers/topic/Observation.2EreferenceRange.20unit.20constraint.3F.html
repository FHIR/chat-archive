---
layout: page
title: "FHIR Chat  · Observation.referenceRange unit constraint? · implementers"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/index.html">implementers</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Observation.2EreferenceRange.20unit.20constraint.3F.html">Observation.referenceRange unit constraint?</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="257678018"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Observation.referenceRange%20unit%20constraint%3F/near/257678018" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Simons <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Observation.2EreferenceRange.20unit.20constraint.3F.html#257678018">(Oct 15 2021 at 10:45)</a>:</h4>
<p>Any best practices on ensuring that the units of referenceRange high/low match those of the valueQuantity, on Observation?</p>
<p>To my surprise the base spec nor for example the vitalSigns profiles constrain anything on this...<br>
One approach is to constrain the referenceRange to only hold a value, without an explicit unit. (UnitlessQuantity).</p>
<p><a href="https://www.hl7.org/fhir/observation-definitions.html#Observation.referenceRange.low">https://www.hl7.org/fhir/observation-definitions.html#Observation.referenceRange.low</a><br>
<a href="https://www.hl7.org/fhir/observation-definitions.html#Observation.referenceRange.high">https://www.hl7.org/fhir/observation-definitions.html#Observation.referenceRange.high</a></p>
<p>Example that should get flagged because of the <code>kg</code> vs <code>nmol/L</code> units</p>
<div class="codehilite"><pre><span></span><code>{
  &quot;resourceType&quot;: &quot;Observation&quot;,
  &quot;code&quot;: {
    &quot;coding&quot;: [
      {
        &quot;system&quot;: &quot;http://loinc.org&quot;,
        &quot;code&quot;: &quot;76485-2&quot;,
      }
    ]
  },
  &quot;valueQuantity&quot;: {
    &quot;value&quot;: 45,
    &quot;system&quot;: &quot;http://unitsofmeasure.org&quot;,
    &quot;code&quot;: &quot;nnmol/L&quot;
  },
  &quot;referenceRange&quot;: [
    {
      &quot;low&quot;: {
        &quot;value&quot;: 40,
        &quot;system&quot;: &quot;http://unitsofmeasure.org&quot;,
        &quot;code&quot;: &quot;kg&quot;
      },
      &quot;high&quot;: {
        &quot;value&quot;: 140,
        &quot;system&quot;: &quot;http://unitsofmeasure.org&quot;,
        &quot;code&quot;: &quot;kg&quot;
      },
      &quot;text&quot;: &quot;40-140&quot;
    }
  ]
  ...
}
</code></pre></div>



<a name="257696465"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Observation.referenceRange%20unit%20constraint%3F/near/257696465" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Observation.2EreferenceRange.20unit.20constraint.3F.html#257696465">(Oct 15 2021 at 13:22)</a>:</h4>
<p>No expectation they'll match.  The reference ranges are just that - ranges assigned by the equipment manufacturer, lab procedures manual or something else.  If the reference range for body weight for a given age and gender is 5-7kg, that doesn't mean a clinician can't capture the weight in pounds or ounces.  Some organizations might have best practices that require this - or at least require a translation to the reference range units, but it's not something we can enforce across all types of measurements across all countries.</p>



<a name="257707998"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Observation.referenceRange%20unit%20constraint%3F/near/257707998" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Simons <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Observation.2EreferenceRange.20unit.20constraint.3F.html#257707998">(Oct 15 2021 at 14:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="191320">Lloyd McKenzie</span> <a href="#narrow/stream/179166-implementers/topic/Observation.2EreferenceRange.20unit.20constraint.3F/near/257696465">said</a>:</p>
<blockquote>
<p>No expectation they'll match.  The reference ranges are just that - ranges assigned by the equipment manufacturer, lab procedures manual or something else.  If the reference range for body weight for a given age and gender is 5-7kg, that doesn't mean a clinician can't capture the weight in pounds or ounces.  Some organizations might have best practices that require this - or at least require a translation to the reference range units, but it's not something we can enforce across all types of measurements across all countries.</p>
</blockquote>
<p>Thanks, your example of an alternate unit that _is_ clinically relevant (lbs vs kg) indeed helps to understand that such constraints would be very context specific. Hence, we'll have to create solution-specific profiles with corresponding valueset bindings on the units for example, in the context of use.</p>



<a name="259248596"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Observation.referenceRange%20unit%20constraint%3F/near/259248596" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Simons <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Observation.2EreferenceRange.20unit.20constraint.3F.html#259248596">(Oct 27 2021 at 14:35)</a>:</h4>
<p>Trying to add a warning using FHIRPath expressions - crazy how tricky it is to debug/tweak these expressions to give the correct outcome:</p>
<div class="codehilite"><pre><span></span><code>&lt;element id=&quot;Observation.referenceRange&quot;&gt;
      &lt;path value=&quot;Observation.referenceRange&quot; /&gt;
      &lt;constraint&gt;
        &lt;key value=&quot;Observation.referenceRange.low.code&quot; /&gt;
        &lt;severity value=&quot;warning&quot; /&gt;
        &lt;human value=&quot;SHOULD have a match in unit code between valueQuantity and referenceRange.low&quot; /&gt;
        &lt;expression value=&quot;Observation.referenceRange.where( low.code.toString() != Observation.value.ofType(Quantity).code.toString() ).empty()&quot; /&gt;
      &lt;/constraint&gt;
      &lt;constraint&gt;
        &lt;key value=&quot;Observation.referenceRange.high.code&quot; /&gt;
        &lt;severity value=&quot;warning&quot; /&gt;
        &lt;human value=&quot;SHOULD have a match in unit code between valueQuantity and referenceRange.high&quot; /&gt;
        &lt;expression value=&quot;Observation.referenceRange.where( high.code.toString() != Observation.value.ofType(Quantity).code.toString() ).empty()&quot; /&gt;
      &lt;/constraint&gt;
      &lt;mustSupport value=&quot;true&quot; /&gt;
      &lt;isModifier value=&quot;false&quot; /&gt;
    &lt;/element&gt;
</code></pre></div>
<p>Unfortunately the where - to handle the <strong>multiple</strong> referenceRanges on the Observation - does not work as expected... Any tips?</p>



<a name="259250340"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Observation.referenceRange%20unit%20constraint%3F/near/259250340" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Simons <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Observation.2EreferenceRange.20unit.20constraint.3F.html#259250340">(Oct 27 2021 at 14:45)</a>:</h4>
<p>This works <code>$this.referenceRange.where(low.code.toString() != 'Cel').empty()</code>with hardcoded String,<br>
 , but I want to use the actual Observation.valueQuantity.code from the same Resource being validated.</p>



<a name="259250837"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Observation.referenceRange%20unit%20constraint%3F/near/259250837" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Observation.2EreferenceRange.20unit.20constraint.3F.html#259250837">(Oct 27 2021 at 14:48)</a>:</h4>
<p>If your context is Observation.referenceRange, you can't refer to Observation.value unless you use %resource.  (It's not in scope.)</p>



<a name="259250958"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Observation.referenceRange%20unit%20constraint%3F/near/259250958" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Observation.2EreferenceRange.20unit.20constraint.3F.html#259250958">(Oct 27 2021 at 14:49)</a>:</h4>
<p>Also, you want to check for a match, not a non- match.  (The expression asserts what is desired to be true)</p>



<a name="259251041"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Observation.referenceRange%20unit%20constraint%3F/near/259251041" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Observation.2EreferenceRange.20unit.20constraint.3F.html#259251041">(Oct 27 2021 at 14:49)</a>:</h4>
<p>Finally, if you're already in Observation.referenceRange, you shouldn't be prefixing with Observation.referenceRange.</p>



<a name="259252541"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Observation.referenceRange%20unit%20constraint%3F/near/259252541" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Observation.2EreferenceRange.20unit.20constraint.3F.html#259252541">(Oct 27 2021 at 14:59)</a>:</h4>
<p>I think what you want is:<br>
<code>high.code.empty() or %resource.value.empty or (high.code=%resource.value.ofType(Quantity).code and high.system=%resource.value.ofType(Quantity).system)</code></p>



<a name="259253804"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Observation.referenceRange%20unit%20constraint%3F/near/259253804" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Simons <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Observation.2EreferenceRange.20unit.20constraint.3F.html#259253804">(Oct 27 2021 at 15:06)</a>:</h4>
<p>Thanks!</p>
<p>The challenge is the multiplicity of referenceRange... or does the PATH iterate over all of those?</p>
<p>So yeah, I had tried the root Observation context also, to have the valueQuantity in scope - good to know about <code>%resource</code>!</p>
<div class="codehilite"><pre><span></span><code>   &lt;element id=&quot;Observation&quot;&gt;
      &lt;path value=&quot;Observation&quot; /&gt;
      &lt;constraint&gt;
        &lt;key value=&quot;Observation.referenceRange.low.code&quot; /&gt;
        &lt;severity value=&quot;warning&quot; /&gt;
        &lt;human value=&quot;SHOULD have a match in unit code between valueQuantity and referenceRange.low&quot; /&gt;
        &lt;expression value=&quot;referenceRange.where( low.code.toString() != %resource.value.ofType(Quantity).code.toString() ).empty()&quot; /&gt;
      &lt;/constraint&gt;
      &lt;mustSupport value=&quot;true&quot; /&gt;
      &lt;isModifier value=&quot;false&quot; /&gt;
    &lt;/element&gt;
</code></pre></div>
<p>Note that I am searching for mismatches: the <code>!=</code> is used to ensure there are no (<code>empty()</code>) mismatches, across the multiple referenceRange.low attributes (via the <code>where</code>). </p>
<p>Lastly, I used the toString(), to compare codes, I sensed that comparing codes directly did not work?</p>
<p>Will try your suggestions</p>



<a name="259257564"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Observation.referenceRange%20unit%20constraint%3F/near/259257564" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Observation.2EreferenceRange.20unit.20constraint.3F.html#259257564">(Oct 27 2021 at 15:29)</a>:</h4>
<p>Comparing codes directly should be fine.  The invariant will trigger on each element repetition at the element path the invariant is declared on.  You don't want to search for mismatches, you want to assert that all should be matches.  The warning will trigger if the specified expression evaluates to 'false'.</p>



<a name="259261436"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Observation.referenceRange%20unit%20constraint%3F/near/259261436" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Simons <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Observation.2EreferenceRange.20unit.20constraint.3F.html#259261436">(Oct 27 2021 at 15:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="191320">Lloyd McKenzie</span> <a href="#narrow/stream/179166-implementers/topic/Observation.2EreferenceRange.20unit.20constraint.3F/near/259257564">said</a>:</p>
<blockquote>
<p>The invariant will trigger on each element repetition at the element path the invariant is declared on. </p>
</blockquote>
<p>Clear - thank you - if indeed the constraint is evaluated separately for each instance of the path, then I don't need the where and the negation approach, as you say, and can keep it a simple comparison.</p>
<p>Really appreciate the help - this kind of detail is hard to find in the docs.</p>



<a name="259267762"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Observation.referenceRange%20unit%20constraint%3F/near/259267762" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Observation.2EreferenceRange.20unit.20constraint.3F.html#259267762">(Oct 27 2021 at 16:37)</a>:</h4>
<p>If you want to propose enhanced wording in the spec, change requests are always welcome :)</p>



<a name="259275724"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Observation.referenceRange%20unit%20constraint%3F/near/259275724" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Simons <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Observation.2EreferenceRange.20unit.20constraint.3F.html#259275724">(Oct 27 2021 at 17:29)</a>:</h4>
<p>Yes, will try to . Helping to build a knowledge base here on Zulip also should help others.</p>
<p>Particularly the following I could not find on &lt;<a href="https://hl7.org/fhirpath/">https://hl7.org/fhirpath/</a>&gt;</p>
<ul>
<li>%resource</li>
<li>the element repetition handling of constraint under a given  element path</li>
</ul>
<p>As an update, the following seems to work - but will also try to further simplify tomorrow.</p>
<p>The <code>%resources</code> and the precondition of the code.exists() seemed to have helped me.</p>
<div class="codehilite"><pre><span></span><code>&lt;element id=&quot;Observation&quot;&gt;
      &lt;path value=&quot;Observation&quot; /&gt;
      &lt;constraint&gt;
        &lt;key value=&quot;Observation.referenceRange.low.code&quot; /&gt;
        &lt;severity value=&quot;warning&quot; /&gt;
        &lt;human value=&quot;SHOULD have a match in unit code between valueQuantity and referenceRange.low&quot; /&gt;
        &lt;expression value=&quot;referenceRange.where( low.code.exists() and (low.code != %resource.value.ofType(Quantity).code) ).empty()&quot; /&gt;
      &lt;/constraint&gt;
      &lt;constraint&gt;
        &lt;key value=&quot;Observation.referenceRange.high.code&quot; /&gt;
        &lt;severity value=&quot;warning&quot; /&gt;
        &lt;human value=&quot;SHOULD have a match in unit code between valueQuantity and referenceRange.high&quot; /&gt;
        &lt;expression value=&quot;referenceRange.where( high.code.exists() and (high.code != %resource.value.ofType(Quantity).code) ).empty()&quot; /&gt;
      &lt;/constraint&gt;
      &lt;mustSupport value=&quot;true&quot; /&gt;
      &lt;isModifier value=&quot;false&quot; /&gt;
    &lt;/element&gt;
</code></pre></div>



<a name="259279660"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Observation.referenceRange%20unit%20constraint%3F/near/259279660" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Observation.2EreferenceRange.20unit.20constraint.3F.html#259279660">(Oct 27 2021 at 17:56)</a>:</h4>
<p>You won't find anything about %resource in the base fhirpath spec because that's a FHIR-specific extension.  (It wouldn't make any sense for FHIRPath exercised against v2, for example.</p>



<a name="259311657"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Observation.referenceRange%20unit%20constraint%3F/near/259311657" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Observation.2EreferenceRange.20unit.20constraint.3F.html#259311657">(Oct 27 2021 at 21:50)</a>:</h4>
<p><a href="http://hl7.org/fhir/fhirpath.html">http://hl7.org/fhir/fhirpath.html</a></p>



<a name="259402627"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Observation.referenceRange%20unit%20constraint%3F/near/259402627" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Simons <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Observation.2EreferenceRange.20unit.20constraint.3F.html#259402627">(Oct 28 2021 at 15:05)</a>:</h4>
<p>Thank you both</p>
<p>An for completeness, the following is more elegant indeed, also works, and gives the warnings more precisely on the line items of the referenceRange:</p>
<div class="codehilite"><pre><span></span><code>  &lt;element id=&quot;Observation.referenceRange&quot;&gt;
      &lt;path value=&quot;Observation.referenceRange&quot; /&gt;
      &lt;constraint&gt;
        &lt;key value=&quot;Observation.referenceRange.low.code&quot; /&gt;
        &lt;severity value=&quot;warning&quot; /&gt;
        &lt;human value=&quot;SHOULD have a match in unit code between valueQuantity and all referenceRange.low&quot; /&gt;
        &lt;expression value=&quot;(%resource.value.ofType(Quantity).code.exists() and low.code.exists()) implies (%resource.value.ofType(Quantity).code = low.code)&quot; /&gt;
      &lt;/constraint&gt;
      &lt;constraint&gt;
        &lt;key value=&quot;Observation.referenceRange.high.code&quot; /&gt;
        &lt;severity value=&quot;warning&quot; /&gt;
        &lt;human value=&quot;SHOULD have a match in unit code between valueQuantity and all referenceRange.high&quot; /&gt;
        &lt;expression value=&quot;(%resource.value.ofType(Quantity).code.exists() and high.code.exists()) implies (%resource.value.ofType(Quantity).code = high.code)&quot; /&gt;
      &lt;/constraint&gt;
      &lt;mustSupport value=&quot;true&quot; /&gt;
      &lt;isModifier value=&quot;false&quot; /&gt;
    &lt;/element&gt;
</code></pre></div>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
