---
layout: page
title: "FHIR Chat  · Container reference violates `ref-1`? · implementers"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/index.html">implementers</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Container.20reference.20violates.20.60ref-1.60.3F.html">Container reference violates `ref-1`?</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="176037868"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Container%20reference%20violates%20%60ref-1%60%3F/near/176037868" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Preston TW <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Container.20reference.20violates.20.60ref-1.60.3F.html#176037868">(Sep 18 2019 at 19:34)</a>:</h4>
<p>Hello!</p>
<p>I'm reading over the specification for <code>Reference</code> (<a href="https://www.hl7.org/fhir/references.html" target="_blank" title="https://www.hl7.org/fhir/references.html">https://www.hl7.org/fhir/references.html</a>). Its <code>ref-1</code> constraint expression is:</p>
<div class="codehilite"><pre><span></span>reference.startsWith(&#39;#&#39;).not() or (reference.substring(1).trace(&#39;url&#39;) in %resource.contained.id.trace(&#39;ids&#39;))
</pre></div>


<p>However, later in this page, it describes contained resources (<a href="https://www.hl7.org/fhir/references.html#contained" target="_blank" title="https://www.hl7.org/fhir/references.html#contained">https://www.hl7.org/fhir/references.html#contained</a>). Quoting from that section:</p>
<blockquote>
<p>For a resource that references the container, the reference is "#"</p>
</blockquote>
<p>Thus it seems like the above expression is missing a case. Am I reading this correctly?</p>
<p>Thank you,<br>
Preston</p>



<a name="176038175"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Container%20reference%20violates%20%60ref-1%60%3F/near/176038175" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Container.20reference.20violates.20.60ref-1.60.3F.html#176038175">(Sep 18 2019 at 19:37)</a>:</h4>
<p>The above expression says that a reference either:</p>
<ul>
<li>does NOT start with <code>#</code></li>
<li>OR the part after the <code>#</code> must match one of the contained resource IDs</li>
</ul>
<p>So that seems right to me, unless I'm misunderstanding your question.</p>



<a name="176038367"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Container%20reference%20violates%20%60ref-1%60%3F/near/176038367" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Preston TW <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Container.20reference.20violates.20.60ref-1.60.3F.html#176038367">(Sep 18 2019 at 19:39)</a>:</h4>
<p>Thank you, <span class="user-mention" data-user-id="191469">@Chris Moesel</span>, I misread how constraint expressions work. I thought the expression must be <code>true</code> to <em>satisfy</em> the constraint, rather than evaluating to <code>true</code> means the constraint is violated. Is the latter interpretation correct?</p>



<a name="176038620"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Container%20reference%20violates%20%60ref-1%60%3F/near/176038620" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Container.20reference.20violates.20.60ref-1.60.3F.html#176038620">(Sep 18 2019 at 19:42)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="240854">@Preston TW</span> -- no, you had it right the first time.  If the constraint evaluates to <code>true</code> then the data is <em>good</em>.  If it evaluates to false, then the data is <em>bad</em> (constraint violated).</p>



<a name="176038683"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Container%20reference%20violates%20%60ref-1%60%3F/near/176038683" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Container.20reference.20violates.20.60ref-1.60.3F.html#176038683">(Sep 18 2019 at 19:43)</a>:</h4>
<p>I have to step out a quick minute, but glad to walk through it.  Just a minute...</p>



<a name="176039362"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Container%20reference%20violates%20%60ref-1%60%3F/near/176039362" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Preston TW <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Container.20reference.20violates.20.60ref-1.60.3F.html#176039362">(Sep 18 2019 at 19:50)</a>:</h4>
<p>As a concrete example, the docs give this resource:</p>
<div class="codehilite"><pre><span></span>&lt;Patient xmlns=&quot;http://hl7.org/fhir&quot;&gt;
  &lt;id value=&quot;something&quot;/&gt;
  &lt;contained&gt;
    &lt;Provenance&gt;
      &lt;!-- no id necessary (though still allowed) --&gt;
      &lt;target&gt;
        &lt;reference value=&quot;#&quot;/&gt;
      &lt;/target&gt;
    &lt;/Provenance&gt;
  &lt;/contained&gt;
  &lt;!-- other attributes --&gt;
&lt;/Patient&gt;
</pre></div>


<p>How is this reference valid wrt <code>ref-1</code>?</p>



<a name="176039702"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Container%20reference%20violates%20%60ref-1%60%3F/near/176039702" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Container.20reference.20violates.20.60ref-1.60.3F.html#176039702">(Sep 18 2019 at 19:54)</a>:</h4>
<p><span class="user-mention" data-user-id="240854">@Preston TW</span> -- you are 100% correct.  I'm sorry, I misread your original message.  I agree -- if just <code>"#"</code> is intended to be used to reference the "container" (e.g., the resource that has the contained resources), then there <em>does</em> seem to be a missing phrase in the constraint.  I'm sorry for the confusion!</p>



<a name="176040030"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Container%20reference%20violates%20%60ref-1%60%3F/near/176040030" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Preston TW <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Container.20reference.20violates.20.60ref-1.60.3F.html#176040030">(Sep 18 2019 at 19:57)</a>:</h4>
<p>Thank you, <span class="user-mention" data-user-id="191469">@Chris Moesel</span>, for clearing that up!</p>



<a name="176041459"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Container%20reference%20violates%20%60ref-1%60%3F/near/176041459" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Preston TW <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Container.20reference.20violates.20.60ref-1.60.3F.html#176041459">(Sep 18 2019 at 20:10)</a>:</h4>
<p>Is there a process for opening a ticket?</p>



<a name="176041702"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Container%20reference%20violates%20%60ref-1%60%3F/near/176041702" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Container.20reference.20violates.20.60ref-1.60.3F.html#176041702">(Sep 18 2019 at 20:13)</a>:</h4>
<p><code>#</code> is not a valid reference. I have no idea what's up with that example above.</p>



<a name="176041718"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Container%20reference%20violates%20%60ref-1%60%3F/near/176041718" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Container.20reference.20violates.20.60ref-1.60.3F.html#176041718">(Sep 18 2019 at 20:13)</a>:</h4>
<p>to create a ticket, there's a link at the bottom of every page - "propose a change"</p>



<a name="176042376"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Container%20reference%20violates%20%60ref-1%60%3F/near/176042376" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Container.20reference.20violates.20.60ref-1.60.3F.html#176042376">(Sep 18 2019 at 20:20)</a>:</h4>
<p>I initially didn't expect it either, <span class="user-mention" data-user-id="191316">@Grahame Grieve</span>  , but it's not just the example that uses <code>#</code> as a reference.  The text itself <em>says</em> to use just <code>#</code> to reference the container from a contained resource.</p>
<p>And this approach is further supported by DOM-3 in DomainResource, which contains the following clause: <code>descendants().where(reference = '#').exists()</code>.</p>



<a name="176042407"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Container%20reference%20violates%20%60ref-1%60%3F/near/176042407" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Container.20reference.20violates.20.60ref-1.60.3F.html#176042407">(Sep 18 2019 at 20:20)</a>:</h4>
<p>oh</p>



<a name="176042427"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Container%20reference%20violates%20%60ref-1%60%3F/near/176042427" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Container.20reference.20violates.20.60ref-1.60.3F.html#176042427">(Sep 18 2019 at 20:21)</a>:</h4>
<p>yes now I'm waking up. this is to reference the container</p>



<a name="176044495"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Container%20reference%20violates%20%60ref-1%60%3F/near/176044495" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Container.20reference.20violates.20.60ref-1.60.3F.html#176044495">(Sep 18 2019 at 20:42)</a>:</h4>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span> and it looks like the original poster is correct that the FHIRPath is insufficient - it doesn't allow for a bare "#" as the reference when the reference appears in a contained resource - and it needs to.</p>



<a name="176044644"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Container%20reference%20violates%20%60ref-1%60%3F/near/176044644" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Container.20reference.20violates.20.60ref-1.60.3F.html#176044644">(Sep 18 2019 at 20:44)</a>:</h4>
<p>looks like another technical correction</p>



<a name="176044714"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Container%20reference%20violates%20%60ref-1%60%3F/near/176044714" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Container.20reference.20violates.20.60ref-1.60.3F.html#176044714">(Sep 18 2019 at 20:45)</a>:</h4>
<p>Yep.  So the constraint needs to check for references that are <code>#</code> and are in the <code>contained</code> resources. <br>
 Maybe something more like this?</p>
<div class="codehilite"><pre><span></span>reference.startsWith(&#39;#&#39;).not()
  or (reference.substring(1).trace(&#39;url&#39;) in %resource.contained.id.trace(&#39;ids&#39;))
  or (reference = &#39;#&#39; and $this in %resource.contained.descendants())
</pre></div>


<p>I'm not sure if that's the right / best way to check if the reference is in the contained resources of the container.  Another possible approach might be checking the <code>path</code> of <code>reference.elementDefinition()</code>.  I don't have a FHIRPath parser on hand that knows how to do <code>%resource</code> or <code>elementDefintion()</code>, so I can't test this constraint.</p>



<a name="176044755"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Container%20reference%20violates%20%60ref-1%60%3F/near/176044755" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Container.20reference.20violates.20.60ref-1.60.3F.html#176044755">(Sep 18 2019 at 20:45)</a>:</h4>
<p>something like that, yes. I'd also have to test</p>



<a name="176964844"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Container%20reference%20violates%20%60ref-1%60%3F/near/176964844" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Preston TW <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Container.20reference.20violates.20.60ref-1.60.3F.html#176964844">(Sep 30 2019 at 19:24)</a>:</h4>
<p><span class="user-mention" data-user-id="191469">@Chris Moesel</span> <span class="user-mention" data-user-id="191316">@Grahame Grieve</span>  quick followup,  why do you need the <code>descendants()</code>? Can you just have <code>... or (reference = '#' and $this in %resource.contained)</code>? From <a href="https://www.hl7.org/fhir/references.html#contained" target="_blank" title="https://www.hl7.org/fhir/references.html#contained">https://www.hl7.org/fhir/references.html#contained</a>: "Contained resources SHALL NOT contain additional contained resources."</p>



<a name="176968414"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Container%20reference%20violates%20%60ref-1%60%3F/near/176968414" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Container.20reference.20violates.20.60ref-1.60.3F.html#176968414">(Sep 30 2019 at 20:02)</a>:</h4>
<p><span class="user-mention" data-user-id="240854">@Preston TW</span> -- IIRC, this is a constraint on the <code>Reference</code> data type, so <code>$this</code> refers to an instance of a <code>Reference</code>. In your concrete example further up the thread, Reference's <code>$this</code> would refer to the part inside the <code>&lt;target&gt;</code> tags.  That being the case, the Reference instance is not an item directly in <code>contained</code> -- it's nested within the contained object.  That's why I used <code>descendants()</code> -- because we don't know exactly where it should be in a contained resource (depends on the resource) -- but we know it should be a descendant node of one of the contained resources.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
