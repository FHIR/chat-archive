---
layout: page
title: "FHIR Chat  · X-Consent header · implementers"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/index.html">implementers</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html">X-Consent header</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="155292755"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/155292755" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Donnelly <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#155292755">(Jan 16 2019 at 22:09)</a>:</h4>
<p>Tuesday Q3, Security and CBCP approved adding an <a href="https://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=19312&amp;start=0" target="_blank" title="https://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=19312&amp;start=0">X-Consent header</a>. A number of people have had questions about it, so this is an attempt to clarify the purpose and mechanism of this optional header.</p>
<p><strong>USE CASE</strong></p>
<p>A patient, Mary Smith, is in the Emergency Department at San Antonio General.  SAG would like to get Mary's data from her primary care provider at Austin Health Alliance.  The X-Consent header is useful when a number of things are true:</p>
<ul>
<li>SAG and AHA have an existing business agreement</li>
<li>AHA doesn't have any documentation in their system explicitly prohibiting them from sharing Mary's data with SAG</li>
<li>AHA also doesn't have documentation explicitly authorizing them to share Mary's data with SAG</li>
</ul>
<p>When SAG requests Mary's data from AHA, AHA checks for all of this:</p>
<div class="message_inline_image"><a href="https://i.imgur.com/zFXfH3D.png" target="_blank" title="https://i.imgur.com/zFXfH3D.png"><img src="https://i.imgur.com/zFXfH3D.png"></a></div><p>The case X-Consent seeks to address is the one where AHA has nothing on file.</p>



<a name="155292771"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/155292771" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Donnelly <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#155292771">(Jan 16 2019 at 22:09)</a>:</h4>
<p><strong>WHAT HAPPENS NEXT?</strong></p>
<p>SAG collects consent, on behalf of AHA, for AHA to share her data with SAG.  SAG then repeats its previous request, including an X-Consent header to<br>
1. let AHA know that it <strong>has</strong> Mary's consent and <br>
2. provide <strong>documentation</strong> of that consent to AHA.</p>
<div class="message_inline_image"><a href="https://i.imgur.com/QtLbL9V.png" target="_blank" title="https://i.imgur.com/QtLbL9V.png"><img src="https://i.imgur.com/QtLbL9V.png"></a></div><p><strong>IS THERE ANOTHER WAY TO DO THIS?</strong></p>
<p>There are some suggestions that have come up more than once. </p>
<p><em>Can we use OAuth2?</em></p>
<p>Yes, just not for the consent part</p>
<ul>
<li>When an OAuth2 token is issued for a <strong>patient</strong>, that token can be used to get that patient's data (or maybe other patients for which that patient has proxy access, like his or her children).</li>
<li>When an OAuth2 token is issued for a clinical end <strong>user</strong>, that token can be used to get data that user would be able to see in the EHR.</li>
<li>When an OAuth2 token is issued for <strong>back-end services</strong>, it's less straightforward than the cases above.  </li>
</ul>
<p>Since a user at SAG doesn't have an account at AHA, this is a case <strong>for back-end services</strong>.  The token SAG gets represents SAG as an organization not a specific person there and isn't able to address this use case. </p>
<p><em>Can SAG POST a Consent resource to AHA?</em></p>
<p>The <em>consent document</em> might not be a <em>Consent resource</em>. It could be a scan of a physical form Mary signed. As such, there wouldn't be anything for AHA to inspect and change their business rules.</p>



<a name="155292824"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/155292824" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Donnelly <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#155292824">(Jan 16 2019 at 22:10)</a>:</h4>
<p><strong>TECHNICAL DETAILS</strong></p>
<p>I kept the flow above high level to avoid getting bogged down in details.  At a more technical level:</p>
<div class="message_inline_image"><a href="https://i.imgur.com/MY2PNF9.png" target="_blank" title="https://i.imgur.com/MY2PNF9.png"><img src="https://i.imgur.com/MY2PNF9.png"></a></div><p>Note that this doesn't explicitly include a step where AHA retrieves the consent document from SAG. Optionally, AHA <strong>could</strong> get the consent before responding to SAG's query (and if it's a Consent resource, it could inspect it). Realistically, given that they already have a business agreement, AHA doesn't want to delay the response with another round trip to call a web service.</p>



<a name="155292830"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/155292830" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Donnelly <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#155292830">(Jan 16 2019 at 22:10)</a>:</h4>
<p><strong>FAQ</strong></p>
<p><em>If the consent is a scan, how can the custodian of the data inspect it?</em> </p>
<p>It can't.  This model is dependent on a business agreement between the systems.  </p>
<p><em>If the consent is a scan, does it have to be scanned right away?</em></p>
<p>Nope.  In the X-Consent header, SAG could provide the URL where it plans to publish the consent document.  If AHA queried that URL before the document had been scanned, SAG's response would include a <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.37" target="_blank" title="https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.37">Retry-After</a> header, and AHA would retry then.  </p>
<p><em>Can't SAG cheat (claim to have consent it doesn't)?</em></p>
<p>In theory, sure.  </p>
<p>X-Consent <em>isn't</em> about security, it's about consent.  A given of this model is that SAG and AHA have an existing business agreement.  A violation of this agreement is likely to result in one or more of: termination of someone's employment, charges being pressed, and/or litigation.</p>
<p><em>Does AHA have to retrieve the consent document every time?</em></p>
<p>With the right business agreement with the right technical support, we should be able to minimize unnecessary network traffic. </p>
<p>I believe the safest way to handle this is for SAG to include an ETag along with the URI in X-Consent.  There's a <a href="#narrow/stream/179166-implementers/topic/Caching.20of.20Consent.20linked.20in.20X-Consent.20header" title="#narrow/stream/179166-implementers/topic/Caching.20of.20Consent.20linked.20in.20X-Consent.20header">Zulip discussion about caching this consent</a>.</p>



<a name="155292881"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/155292881" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Donnelly <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#155292881">(Jan 16 2019 at 22:11)</a>:</h4>
<p><span class="user-mention" data-user-id="191404">@John Moehrke</span> <span class="user-mention" data-user-id="192587">@David Pyke</span></p>



<a name="155362071"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/155362071" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#155362071">(Jan 17 2019 at 19:30)</a>:</h4>
<p>I like that clarification. The X-Consent header is there to use. The server can impose any policy it needs to. The existance of the X-Consent header is not a mandate. Thus policy and business relationships will still be most important.</p>



<a name="156899169"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/156899169" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mohammad Jafari <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#156899169">(Jan 26 2019 at 00:45)</a>:</h4>
<p>Being a bit late to this thread, I wanted to express some concerns/questions about this approach. <br>
Generally, evaluating patient's consent is part of the authorization logic. First, a broader authorization policy needs to be checked to determine whether patient's consent is needed to begin with; then, the patient's consent(s) need(s) to be evaluated (by a module we called "Consent Decision Point" in our previous demos which is part of the broader policy decision point) and the result of that evaluation is passed as an input into the broader authorization service which will ultimately determine what will be released and to what extent (e.g. some resources from a bundle might be redacted).<br>
In this context, I think the proper way for a client to inform the server of an existing consent on file if to present the link to the consent as a claim/attribute in its initial request to the authorization server to obtain an OAuth token. The client provides a set of claims/attributes which essentially says: "I am X, I want a token to be able to access patient Y's resources (optionally also narrow down the requested resource types, date range, or confidentiality level, etc.) and also here is the link to this patient's consent I have on file."<br>
This will provide an opportunity to consider all the provided claims/attributes, and eventually decide whether or not to issue a token (potentially granting more limited set of scopes compared to what the client asked for). In this approach _all_ of the authorization logic, including evaluating the consent directive happens in one place. <br>
Note that there may be a lot of intertwined policy decisions in this process and consent evaluation can hardly be separated from the rest of the authorization logic; for example, the authorization server may be configured based on policy to trust Client A's claim that they are in possession of a consent without evaluating it while Client B must actually make the consent available to be processed.<br>
I think my concerns are:<br>
 a) What is the problem that x-consent header trying to solve which cannot be covered by the above standard flow? <br>
b) How and where the authorization logic is going to be handled? By bringing in the consent link into the FHIR request, it seems like part of the authorization logic (i.e. evaluating consent) will fall on the FHIR server. I think the tendency to isolate authorization logic (of which consent evaluation is a part) from the FHIR server is a more appropriate approach. Having all or part of the authorization processing take place inside the FHIR server, and after an authorization server has issued a token does not seem to be a good design decision.<br>
If I am missing something about the context of the use-case here, I will be grateful if someone can provide more information .</p>



<a name="156940549"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/156940549" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#156940549">(Jan 26 2019 at 20:41)</a>:</h4>
<p>a) not all FHIR access is through a user mediated OAuth process<br>
b) the FHIR server cannot do nothing about authorization. Each request has to be checked in detail against the authorizations and consents, irrespective of the checking done when the session was established. We've said nothing about how the RS and AS act in concert in this degree, but clearly they need to. Adding the X-Consent header doesn't make any difference in this regard</p>



<a name="156947675"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/156947675" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mohammad Jafari <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#156947675">(Jan 27 2019 at 00:16)</a>:</h4>
<p>I agree that "the FHIR server cannot do nothing about authorization" and that's precisely why I think this is not a good idea because it sends to the FHIR server some authorization information and  breaks the separation of Authorization and FHIR server by bringing an authorization claim/assertion into the FHIR API. <br>
A reference to a consent resource or even a simple claim that a party has a patient consent on file are indeed authorization assertion/claims which can only be consumed in a meaningful and consequential way by an Authorization Server which is ultimately the only place which knows what to do with that information.<br>
I think consent assertions should not be conveyed using HTTP headers for the same reason that we don't use HTTP headers for other authorization claims/assertions like client ID, client's organization ID, purpose of use, or the client's confidentiality/sensitivity clearance. <br>
There are well-defined and standard ways for conveying such assertions to an authorization server (where they actually can be meaningfully consumed) and there are well-defined and standard ways to convey the authorization decision to an API server in the form of an authorization token. If a FHIR server needs authorization, those standard methods should be used. If authorization is not a concern, then what would it need the consent reference for? <br>
My contention is that sending some authorization information directly to the FHIR server as part of the FHIR API breaks the separation between the Authorization and FHIR API and potentially creates confusion by misleading implementers to implement some piecemeal authorization logic inside the FHIR server by enforcing the consent decisions isolated or in parallel to the rest of authorization policies. <br>
I'd still like to hear how this header is supposed to be consumed by a FHIR server in a use-case and what the FHIR server is supposed to do with it.</p>



<a name="156961445"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/156961445" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#156961445">(Jan 27 2019 at 07:26)</a>:</h4>
<p>you're still assuming that there is an authorization server. In lots of cases, there is not.</p>



<a name="156977817"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/156977817" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#156977817">(Jan 27 2019 at 16:27)</a>:</h4>
<p>The X-Consent header is being defined as a method, not a mandate. The server is fully free to ignore it, or to reject any requests that contain the header. <br>
It is not right to say we don't do this for other security mechanisms, as the auth header is an http header, etc... AND within the FHIR specification there is discussion of a break-glass mechanism that leverage a proposed IETF specification for Category <a href="http://build.fhir.org/security-labels.html#break-the-glass" target="_blank" title="http://build.fhir.org/security-labels.html#break-the-glass">http://build.fhir.org/security-labels.html#break-the-glass</a><br>
NONE of these are required, they can all be forbidden... the point of having them specified is to enable re-use when someone finds them useful and acceptable risk.</p>



<a name="157000964"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157000964" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> k connor <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157000964">(Jan 28 2019 at 03:52)</a>:</h4>
<p>RE Graham: " you're still assuming that there is an authorization server. In lots of cases, there is not."  I'm not sure what the use cases are for not having an authorization server in healthcare systems except maybe within an enterprise.  It would be helpful to have a few mainstream examples where that's permissible within known privacy policy domains.  Also, I think we need to articulate the use cases for when x-consent header makes sense.  I've been thinking it makes sense where a Server is pushing patient records, so no claims involved from the Client side, as a way to convey the governing consent or any governing privacy policy for that matter.  That seems different from the use case being discussed, where it might make sense to have the OAuth claims of the requester indicating that they have a "consent on file." That would help implementers determine whether they;ve got any business impetus for supporting x-consent header.</p>



<a name="157014025"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157014025" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157014025">(Jan 28 2019 at 09:51)</a>:</h4>
<p>depends whether you mean, by authorization server, an OAuth Authorization server, or just generally, an point of decision making. Of course you'll have an decision making point. But most interfaces in healthcare a system:system trust based, and the user assertions are part of the request, not part of a special session established with user involvement</p>



<a name="157024059"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157024059" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157024059">(Jan 28 2019 at 13:17)</a>:</h4>
<p>I am happy to get clarity on some of the best use-cases, but want to keep us short of trying to go exhaustive in the use-cases (an infinite well of possibilities). The most visible use-case to me is the same one that drives the similar function in the eHealth Exchange, which is the one Michael was outlining. It is not the only use-case, it might not be the best, but it is the one that is used today. That use-case does start with a high degree of trust between the client and server.  They have strong reason to trust each other, no need to elaborate on why or how. The communication of the x header is by the business layer, not the security layer. So having it in the http header, and not in the OAuth. The server verification of the x header claim can be light or very heavy, again we don't need to elaborate. All we are trying to do is "standardize" a method of communicating this fact, not how the fact was obtained or how it is used.  Yes the use-case we elaborate will speak to how it is obtained and ow it is used in that context. But that specific use-case is not a mandate, it is an illustration of one way to use this method.</p>



<a name="157129307"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157129307" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mohammad Jafari <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157129307">(Jan 29 2019 at 19:10)</a>:</h4>
<p>The use-case <span class="user-mention" data-user-id="199026">@k connor</span> is referring to is entirely different from the use-case outlined earlier in this thread. In this case, this header is used by the _FHIR server_ in its response to the client, to specify what patient consent was used to authorize access. This can be useful if the FHIR Server wants to specify (for purposes such as accounting of disclosure) the reasoning behind its decision to release the FHIR resources in its response. It may also help the client  compare this consent with its own record and get an opportunity to update the record in case the it has a more recent consent from the patient.</p>
<p>I think even in this use-case it makes more sense to include such information in the the authorization server response (because that's where the decision is made and the AS is the party that knows best what consent/policies were used to make the decision to allow/deny issuing a token) but I don't have the concerns I expressed earlier (about encouraging piecemeal authorization logic inside the FHIR server) about using the x-consent header in this case.</p>



<a name="157129727"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157129727" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mohammad Jafari <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157129727">(Jan 29 2019 at 19:16)</a>:</h4>
<p>I think ultimately what can help this discussion is to a) identify the use-case in which the client uses this header, and b) explain what sequence of actions the FHIR server is expected to take in order to consume this header in that use-case. <br>
My understanding is that the logic for processing such a header is authorization logic in nature and is inherently intertwined with the logic for processing other applicable authorization policies (as I argued earlier in this thread) which does not belong in the FHIR server.</p>



<a name="157136359"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157136359" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157136359">(Jan 29 2019 at 20:44)</a>:</h4>
<p>that's where you're wrong: the logic absoutely does belong in the FHIR server, since it's the one that actually has to apply the rules</p>



<a name="157136673"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157136673" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mohammad Jafari <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157136673">(Jan 29 2019 at 20:48)</a>:</h4>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span> "the FHIR server cannot do nothing about authorization" is what you said above. I'm reiterating that by saying the authorization logic does not belong in the FHIR server.</p>



<a name="157136725"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157136725" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157136725">(Jan 29 2019 at 20:49)</a>:</h4>
<p>right. the FHIR Server must be deeply involved in authorization. The authorization server is only a bystander</p>



<a name="157136945"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157136945" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mohammad Jafari <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157136945">(Jan 29 2019 at 20:52)</a>:</h4>
<p>I see, so you actually meant that double negative as a positive <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span><br>
My understanding is that the FHIR specs has purposefully stayed away from defining authorization flow/logic and has left it to existing authorization technologies and I think that's the right decision.</p>



<a name="157137440"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157137440" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157137440">(Jan 29 2019 at 20:59)</a>:</h4>
<p>The FHIR specification is defining interoperability mechanisms, not decision or enforcement.... This is true of x-consent like any other mechanism defined in the FHIR specificaiton. Said another way the sole purpose of defining the x-consent header is to enable "a" method of communicating a consent that the requester has that it thinks is applicable to the server. That is all. There is no expectation beyond that. Yes there are some behaviours that this clearly enables, but those behavours would technology and policy specific.</p>



<a name="157138213"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157138213" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157138213">(Jan 29 2019 at 21:08)</a>:</h4>
<p>right. we have not defined how it should be done. but it has to be done.</p>



<a name="157146503"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157146503" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> k connor <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157146503">(Jan 29 2019 at 23:00)</a>:</h4>
<p>RE John: "the sole purpose of defining the x-consent header is to enable "a" method of communicating a consent that the requester has that it thinks is applicable to the server". Mohammad and I are proposing an additional use case - where the x-consent header is used by the _FHIR server_ in its response to the client, to specify what patient consent was used to authorize access. See his comment 1/29 above.</p>



<a name="157150336"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157150336" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157150336">(Jan 30 2019 at 00:06)</a>:</h4>
<blockquote>
<p>RE John: "the sole purpose of defining the x-consent header is to enable "a" method of communicating a consent that the requester has that it thinks is applicable to the server". Mohammad and I are proposing an additional use case - where the x-consent header is used by the _FHIR server_ in its response to the client, to specify what patient consent was used to authorize access. See his comment 1/29 above.</p>
</blockquote>
<p>That already exists -- see the extension on OperationOutcome -- <a href="http://build.fhir.org/extension-operationoutcome-authority.html" target="_blank" title="http://build.fhir.org/extension-operationoutcome-authority.html">http://build.fhir.org/extension-operationoutcome-authority.html</a></p>



<a name="157210921"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157210921" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mohammad Jafari <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157210921">(Jan 30 2019 at 18:50)</a>:</h4>
<p><span class="user-mention" data-user-id="191404">@John Moehrke</span>  I can stand corrected but my understanding is that <code>OperationOutcome</code> is not intended to be returned with a successful response, so, it doesn't really address the use-case <span class="user-mention" data-user-id="199026">@k connor</span> and I mentioned above.<br>
  a)  If  the FHIR server wants to notify the client about the reasoning behind its decision to release some information for accounting/traceability purposes, or <br>
  b)  When a client who has received a successful response needs to check whether the response is based on an up-to-date consent, for example, since it may suspect that part of the response may have been redacted based on an older consent.<br>
In these cases the FHIR server returns a successful response but it may still want to communicate the consent based on which access was granted.</p>



<a name="157220017"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157220017" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157220017">(Jan 30 2019 at 20:41)</a>:</h4>
<p>That use-case is not the one being addressed by X-Consent header. If you have a solution, you can submit a change request for consideration.</p>



<a name="157363928"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157363928" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mohammad Jafari <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157363928">(Feb 01 2019 at 16:13)</a>:</h4>
<p>FTR, Kathleen and I summarized our thoughts on these use-cases here:<br>
<a href="https://medium.com/@jafarim/when-the-client-has-the-patients-consent-37650e8a6c1c" target="_blank" title="https://medium.com/@jafarim/when-the-client-has-the-patients-consent-37650e8a6c1c">https://medium.com/@jafarim/when-the-client-has-the-patients-consent-37650e8a6c1c</a><br>
I hope this can be helpful in clarifying them. <br>
In summary, I think using <code>X-Consent</code> header is justified in the case where there is no mechanism for the client to communicate dynamic per-transaction attribute assertions/claims with the authorization service, but when it is possible for the client to communicate per-transaction attribute assertions, consent on file should be communicated using an assertion/claim.</p>



<a name="157381489"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157381489" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157381489">(Feb 01 2019 at 20:05)</a>:</h4>
<p>I think your diagrams would be clearer if you included the consent decision point explciitly. And also if you were clear that the execution of the the authorization decisions are on the FHIR server, not the authorization server</p>



<a name="157381507"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157381507" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157381507">(Feb 01 2019 at 20:05)</a>:</h4>
<p>note that we are working on a common API for the consent decision point for the FHIR servers</p>



<a name="157390692"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157390692" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mohammad Jafari <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157390692">(Feb 01 2019 at 22:15)</a>:</h4>
<p>I am not sure I agree with on that <span class="user-mention" data-user-id="191316">@Grahame Grieve</span>. I have argued at length both earlier in this thread and in the writeup that processing the consent should take place at the authorization service where there is context for other rival and overarching policies and a meaningful decision can be made by considering all applicable policies in different forms and formats (FHIR consent, legacy consent standards, XACML, ODRL,...) and resolving potential conflicts. <br>
The interface for processing consents is very similar to the interface for an authorization service: <br>
1) request comes in as a set of assertions, <br>
2) consult a policy information point to add additional assertions to the request if necessary, <br>
3) find applicable policies,  <br>
4) evaluate the request against each applicable policy and record the results (authorization decisions and obligations)<br>
5) Combine all the partial decisions into a final decisions (one authorization decision and a set of obligations) based on overarching conflict resolution policies. <br>
The FHIR Server would simply serve the FHIR consent to the authorization service so that it can be processed alongside all other applicable policies. We have demoed this architecture a few times in previous connectathons.</p>
<p>But I think this is out of the scope of the current thread. If there's already a thread on consent decision point, I'm happy to continue there.</p>



<a name="157398089"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157398089" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157398089">(Feb 02 2019 at 00:33)</a>:</h4>
<p>you are wrong to treat the request as an atomic unit. The authorization server cannot approve the request or not as a single unit. The engine that constructs the response must be aware of the fine grained rules so it knows how to build the response</p>



<a name="157398934"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157398934" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mohammad Jafari <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157398934">(Feb 02 2019 at 00:49)</a>:</h4>
<p>The fine-grained rules to construct the response come from the obligations resulting from different policies including the patient consent, as I discussed above and as we have demonstrated in fhir connectathons as far back as 2015 with different variations of the authorization service, security labeling service, and privacy preserving services. Our team has a deep understanding and a lot of experience with authorization and labeling. If you think this is all wrong you certainly need to elaborate.</p>



<a name="157406914"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157406914" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157406914">(Feb 02 2019 at 04:31)</a>:</h4>
<p>ok. this request: </p>
<p><code>GET [base]/Observation?subject=Patient/[id]&amp;_lastUpdated=ge:2018-01-01</code></p>



<a name="157406923"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157406923" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157406923">(Feb 02 2019 at 04:31)</a>:</h4>
<p>patient has consented to share observations except those pertaining to STD and Mental health</p>



<a name="157434826"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157434826" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mohammad Jafari <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157434826">(Feb 02 2019 at 19:15)</a>:</h4>
<p>We have demoed this a few times in the connectathons with a) enterprise authorization service (e.g. XACML), b) with UMA, and with c) plain OAuth. The reports were published to the Security WG. For example, the summary of the approach with basic authorization is as the following:<br>
- After the response to the query is determined by the FHIR server, the <em>policy enforcement point</em> (PEP) in the FHIR server captures and creates a request and sends it to the authorization service; the request includes the response contents and attribute assertions.<br>
- The authorization service evaluates the response content, and the attribute assertions against applicable consents (there's a <em>consent discovery</em> component which determined which patients' information are in the response based on the bundle contents and retrieves the applicable consents from those patients which may or may not be stored in the same FHIR server).<br>
- The result of this evaluation is an array of decisions; one decision from each applicable consent. Each decision includes an authorization decision (<code>permit</code>, <code>deny</code>, <code>not_applicable</code>) and a set of obligations e.g. <code>redact resources labeled with STD and mental health</code>.<br>
- A <em>decision combiner</em> component turns the array of decisions into one final decision (i.e. one authorization decision and one final set of obligations). This conflict resolution can be highly configurable (policy-based) or as simple as <em>most recent consent overrides</em>. This final decision is sent back to the FHIR PEP.<br>
- The PEP invokes the labeling and privacy preserving service (SLS/PPS), passing the response bundle alongside the final decision from the authorization server which includes labeling and redaction obligations. The SLS/PPS returns a modified response by applying the obligations.<br>
- The FHIR server sends back the response as packaged by the SLS/PPS back to the client.<br>
There is some nuanced glue logic here, e.g. if the request is for a single resource and not a bundle, if the decision requires that resource to be redacted, the FHIR server should send a 404, whereas if the response is a bundle, it can simply remove that one resource from the outgoing bundle.</p>
<p>With UMA and OAuth the flow is a bit different but is based on similar steps.</p>
<p>When we demoed this in 2016, I used the hooks inside the HAPI server (servlet interceptors) to have the FHIR server make the appropriate calls to the authorization service and  SLS/PPS before sending out the response. Since then I have re-implemented this in the form of a reverse proxy which can sit in front of any FHIR server and enforce the authorization flow. <br>
We have the documents from the earlier work (the code was not open-sourced) but the reverse proxy is a project I have worked on outside of contracts in my own time and is open-source. Will be happy to share the docs, present a demo or the code, or chat further if you <span class="user-mention" data-user-id="191316">@Grahame Grieve</span>  or others are interested.  Where is the <em>consent decision point</em> conversation taking place?</p>



<a name="157438711"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157438711" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157438711">(Feb 02 2019 at 21:12)</a>:</h4>
<p>interesting. I would not like to second guess the cascade of decisions the FHIR server makes. For that reason, we are working up an in-server API that is common across servers, and that the server consults as it makes it's decisions. See <a href="#narrow/stream/179247-Security-and.20Privacy/topic/FHIR-Security.20and.20Privacy.20Overview.20Mon.20Q3" title="#narrow/stream/179247-Security-and.20Privacy/topic/FHIR-Security.20and.20Privacy.20Overview.20Mon.20Q3">https://chat.fhir.org/#narrow/stream/179247-Security-and.20Privacy/topic/FHIR-Security.20and.20Privacy.20Overview.20Mon.20Q3</a></p>



<a name="157438722"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157438722" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157438722">(Feb 02 2019 at 21:13)</a>:</h4>
<p>I'm going to propose some changes to the interface after what you wrote</p>



<a name="157440730"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157440730" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mohammad Jafari <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157440730">(Feb 02 2019 at 22:12)</a>:</h4>
<p>I see. </p>
<p>To add to the above, the reason I moved towards implementing an HTTP reverse proxy was to avoid having to tweak the FHIR server (even as much as putting in the hooks and configs for the AS or OAuth). At the connectathon I noticed that our flow could only work with our own HAPI server which we had modified to add the AS and SLS/PPS calls, and we were not able to use our auth layer on someone else's FHIR server unless we were given access to change their server source/configs which can be an administrative nightmare ("we need write access to your code repo and code pipeline and deploy access to your server environment <span aria-label="smirk" class="emoji emoji-1f60f" role="img" title="smirk">:smirk:</span> ") as well as technical challenge ("oh we need to add a few calls to the server side but I see your FHIR server is written in COBOL <span aria-label="astonished" class="emoji emoji-1f632" role="img" title="astonished">:astonished:</span> "). <br>
So, I wanted a solution that can be orthogonal to  the backend and can work with any FHIR server without the need to do anything inside the FHIR box. This approach also helps with the separation of concern (in a microservice sense) so there is less coupling between the FHIR server and the authorization proxy and the development/management of these servers can be done by separate groups. </p>
<p>I see that in contrast, the alternative is to make this part of the FHIR standard so that every FHIR server is guaranteed to have it implemented in the same way. This works too, but with the caveat that a) it will make the specs bulkier, and b) there is a risk of defining the specs in a way that only works well with <em>some</em> authorization technologies (e.g. as I mentioned above the flows for plain OAuth2 vs. UMA profile vs. classic enterprise auth service are a bit different and call for different interfaces).  </p>
<p>I will monitor that thread and maybe write more about the details as the conversation moves forward. Maybe I will also introduce and discuss the fhir reverse proxy in a separate thread.</p>



<a name="157462326"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157462326" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157462326">(Feb 03 2019 at 10:10)</a>:</h4>
<p>so we won't be adding that API to the spec, I think. Maybe we'll document it somewhere to encourage people to adopt it, but that won't make your wrapping approach useless- they'll just be solving different deployment architecture</p>



<a name="157481279"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157481279" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157481279">(Feb 03 2019 at 19:52)</a>:</h4>
<p>cascading OAuth (UMA or simple OAuth) has been recommended in the specification for a long time. So the model you are promoting is already promoted.. Today we have specific pointer at a healthcare specific version, such as HEART. More general architecture examples could be added simply by recommending the wording in a Change Request.</p>



<a name="157488556"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157488556" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157488556">(Feb 03 2019 at 23:33)</a>:</h4>
<p>Just removing the resour e from a bundle isn't enough, you would also need to consider the total count and paging too.<br>
If the paging through observations went through a set of mental health related ones chances of receiving an empty page would be high, which isn't particularly useful to a client.<br>
This needs to be a step back into the paging logic. So it's not as simple as has been described.</p>



<a name="157494450"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157494450" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mohammad Jafari <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157494450">(Feb 04 2019 at 02:20)</a>:</h4>
<p><span class="user-mention" data-user-id="191367">@Brian Postlethwaite</span>  yes. There is a lot of little nuances like this as I mentioned earlier.  Another example I encountered was redacting embedded resources and handling references to redacted resources in un-redacted resources.<br>
I think  it will be worth to document a list of these implementation details for the community at some point.</p>



<a name="157494820"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157494820" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mohammad Jafari <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157494820">(Feb 04 2019 at 02:33)</a>:</h4>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span> ok. I'll be happy to help with/contribute to that document.</p>



<a name="157521835"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/X-Consent%20header/near/157521835" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/X-Consent.20header.html#157521835">(Feb 04 2019 at 13:17)</a>:</h4>
<p>The discussion of methods of redaction is independent of the X-Consent header topic... I would agree that having a section on the security pages that outlines these various "Considerations" would be good.  We have some of this mentioned <a href="http://build.fhir.org/secpriv-module.html#query-parameters" target="_blank" title="http://build.fhir.org/secpriv-module.html#query-parameters">http://build.fhir.org/secpriv-module.html#query-parameters</a></p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
