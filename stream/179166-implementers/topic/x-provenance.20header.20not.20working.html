---
layout: page
title: "FHIR Chat  · x-provenance header not working · implementers"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/index.html">implementers</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/x-provenance.20header.20not.20working.html">x-provenance header not working</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="186577368"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/x-provenance%20header%20not%20working/near/186577368" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nath <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/x-provenance.20header.20not.20working.html#186577368">(Jan 25 2020 at 15:30)</a>:</h4>
<p>Hello Friends, I have been reading docs and desperately looking for an example how this X-Provenance works?. Here is what I tried:<br>
I use the JPA Version R4.0.0. Upgraded to 4.0.1 also still not working. </p>
<div class="codehilite"><pre><span></span>   @Autowired
   private  IGenericClient fhirClient;
    Patient patient = new Patient();
    patient.addIdentifier().setUse(Identifier.IdentifierUse.OFFICIAL).setSystem(&quot;urn:example&quot;)
        .setValue(&quot;101&quot;);
   - - - - more fields to patient object

    Bundle bundle = new Bundle();
    bundle.setType(Bundle.BundleType.TRANSACTION);
    bundle.addEntry()
        .setFullUrl(patient.getIdElement().getValue())
        .setResource(patient)
        .getRequest()
        .setUrl(&quot;Patient&quot;)
        .setIfNoneExist(&quot;identifier=http://xyz.org/mrns|12345&quot;)
        .setMethod(Bundle.HTTPVerb.POST);


  AdditionalRequestHeadersInterceptor additionalRequestHeadersInterceptor = new AdditionalRequestHeadersInterceptor();
    JSONObject jsonObject = new JSONObject();
    try {
        jsonObject.put(&quot;resourceType&quot;, &quot;Provenance&quot;);
        jsonObject.put(&quot;recorded&quot;, new Date());
        JSONObject j = new JSONObject();
        j.put(&quot;who&quot;, &quot;Patient/1&quot;);  // existing patient in my system 
        jsonObject.put(&quot;agent&quot;, j);
    }
    catch (Exception e) {}

    additionalRequestHeadersInterceptor.addHeaderValue(&quot;X-Provenance&quot;, jsonObject.toString());
    additionalRequestHeadersInterceptor.addHeaderValue(&quot;content-type&quot;, &quot;application/fhir+json&quot;);
    fhirClient.registerInterceptor(additionalRequestHeadersInterceptor);

    Bundle resp = fhirClient
        .transaction()
        .withBundle(bundle)
        .execute();
</pre></div>


<hr>
<p>I checked the database, I see the patient is created but no provenance resource. Can someone help me what I am doing wrong ?. <br>
Since there is no proper example describing this X-Provenance, its hard. I searched the code also but not able to find where X-Provenance is used as well. I will debug it further if someone points me to the source code. </p>
<p>thanks for your help<br>
Nath</p>



<a name="186577428"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/x-provenance%20header%20not%20working/near/186577428" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Pyke <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/x-provenance.20header.20not.20working.html#186577428">(Jan 25 2020 at 15:32)</a>:</h4>
<p><span class="user-mention" data-user-id="191404">@John Moehrke</span></p>



<a name="186581920"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/x-provenance%20header%20not%20working/near/186581920" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Fradkin <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/x-provenance.20header.20not.20working.html#186581920">(Jan 25 2020 at 17:44)</a>:</h4>
<p>If you're using HAPI-FHIR, it doesn't appear to support the X-Provenance header yet.  We had to implement our own support for the header in order for it to work.  Are there any servers that support it out of the box at this point in time?</p>



<a name="186589535"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/x-provenance%20header%20not%20working/near/186589535" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nath <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/x-provenance.20header.20not.20working.html#186589535">(Jan 25 2020 at 21:33)</a>:</h4>
<p>thanks <span class="user-mention" data-user-id="238352">@Scott Fradkin</span> Yes I am using Hapi fhir. Is there a link or document where I can see what's supported or not. Sorry I am new to this. <br>
Sorry for this basic question,  so where is this functionality currently implemented then ?</p>
<p>Also, "we had to implement our own support for the header ..", you mean if the header contains  X-Provenance then do this functionality of creating the provenance resource youself in hapi fhir ?. Is that what you mean ?.  basically, duplicate the functionality from the place where its currently implemented to hapi fhir ?</p>
<p>thanks</p>



<a name="186592870"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/x-provenance%20header%20not%20working/near/186592870" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/x-provenance.20header.20not.20working.html#186592870">(Jan 25 2020 at 23:19)</a>:</h4>
<p>You would probably want to implement this as a Server Interceptor (see <a href="https://hapifhir.io/hapi-fhir/docs/interceptors/" target="_blank" title="https://hapifhir.io/hapi-fhir/docs/interceptors/">https://hapifhir.io/hapi-fhir/docs/interceptors/</a> ). We'd gladly welcome any contributions of such an interceptor if someone wanted to try building it and sharing their work.</p>



<a name="186600493"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/x-provenance%20header%20not%20working/near/186600493" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nath <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/x-provenance.20header.20not.20working.html#186600493">(Jan 26 2020 at 03:23)</a>:</h4>
<p><span class="user-mention" data-user-id="191319">@James Agnew</span> thanks. sure, let me understand interceptor and provider. <br>
High level this is what I am thinking:<br>
In the bundle provider method, </p>
<p>JpaSystemProviderR4.java</p>
<p>@Transaction<br>
    public Bundle transaction(RequestDetails theRequestDetails, @TransactionParam Bundle theResources) {<br>
        startRequest(((ServletRequestDetails) theRequestDetails).getServletRequest());<br>
        try {<br>
            return getDao().transaction(theRequestDetails, theResources);<br>
        } finally {<br>
            endRequest(((ServletRequestDetails) theRequestDetails).getServletRequest());<br>
        }<br>
    }</p>
<p>I looked at all server interceptor and I see there is none currently for bundle pre-commit resources. I see only STORAGE_PRESTORAGE_RESOURCE_CREATED. </p>
<p>So, in the above method transaction(..) after getDao().transaction(theRequestDetails, theResources) is called, invoke the new interceptor say STORAGE_PRECOMMIT_RESOURCES.</p>
<p>JpaInterceptorBroadcaster.doCallHooks(myInterceptorBroadcaster, theRequest, Pointcut.STORAGE_PRECOMMIT_RESOURCES, theResources); </p>
<p>inside the interceptor, it should walk thru the theResources, get the id and version, create the provenance resource, call getDao().transaction(newRequest, provenanceResource)</p>
<p>This is for JPA but not sure what needs to be done for Restful server(non-jpa). <br>
Please kindly guide me,</p>



<a name="186623274"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/x-provenance%20header%20not%20working/near/186623274" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/x-provenance.20header.20not.20working.html#186623274">(Jan 26 2020 at 14:06)</a>:</h4>
<p>I think you should be fine to just hook into <code>STORAGE_PRESTORAGE_RESOURCE_CREATED</code> and also <code>STORAGE_PRESTORAGE_RESOURCE_UPDATED</code> if you want. Those will get called both for normal CRUD and for transaction operations.</p>



<a name="186630882"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/x-provenance%20header%20not%20working/near/186630882" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nath <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/x-provenance.20header.20not.20working.html#186630882">(Jan 26 2020 at 17:50)</a>:</h4>
<p>thanks <span class="user-mention" data-user-id="191319">@James Agnew</span> . Sorry, I am bit confused now. The STORAGE_PRESTORAGE_RESOURCE_CREATED is fired for each resource. So, if my txn bundle contains 3 resources I will get 3 times this interceptor be called and that's not what we want here.RIght?</p>
<p>In this case once all my 3 resources are created I want my interceptor be called and it will create provenance resource with version id's. So, I am thinking we need a new interceptor that should be invoked once all the resources in the bundle are processed.</p>
<p>thanks</p>



<a name="186645411"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/x-provenance%20header%20not%20working/near/186645411" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/x-provenance.20header.20not.20working.html#186645411">(Jan 27 2020 at 00:47)</a>:</h4>
<p>ah, if the logic you're after is for a single call to happen after the whole bundle is done, you probably want to hook into SERVER_PROCESSING_COMPLETED_NORMALLY</p>



<a name="186652671"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/x-provenance%20header%20not%20working/near/186652671" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Fradkin <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/x-provenance.20header.20not.20working.html#186652671">(Jan 27 2020 at 04:36)</a>:</h4>
<p>Our implementation was for prototype functionality for a single operation, so we didn't implement anything generic enough like a server interceptor, but basically, yes we created a new Provenance resource out of the header and added the resource identifiers inserted from the bundle as the target to the Provenance resource.  So the Provenance resource was created and inserted after the bundle transaction was completed.</p>



<a name="186654354"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/x-provenance%20header%20not%20working/near/186654354" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nath <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/x-provenance.20header.20not.20working.html#186654354">(Jan 27 2020 at 05:27)</a>:</h4>
<p>thanks <span class="user-mention" data-user-id="191319">@James Agnew</span>. I looked at the server interceptor diagram <a href="https://hapifhir.io/hapi-fhir/docs/interceptors/server_pointcuts.html" target="_blank" title="https://hapifhir.io/hapi-fhir/docs/interceptors/server_pointcuts.html">https://hapifhir.io/hapi-fhir/docs/interceptors/server_pointcuts.html</a>. The event SERVER_PROCESSING_COMPLETED_NORMALLY is raised after the transaction is completed but I want to add provenance resource within the same txn. So, I need something after all resources in the bundle are processed, id, version is generated, then I use those versions, id and create provenance resource in the same txn. <br>
This will work for JPA.</p>
<p>Also, 2nd question is about Plain server, do I need to do anything since storage is done externally. </p>
<p><span class="user-mention" data-user-id="238352">@Scott Fradkin</span> thanks for the information. <br>
thanks a lot.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
