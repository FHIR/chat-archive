---
layout: page
title: "FHIR Chat  · GCP: Managing Resource Contention with FHIR Bundle · implementers"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/index.html">implementers</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/GCP.3A.20Managing.20Resource.20Contention.20with.20FHIR.20Bundle.html">GCP: Managing Resource Contention with FHIR Bundle</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="206117386"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/GCP%3A%20Managing%20Resource%20Contention%20with%20FHIR%20Bundle/near/206117386" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nguyen Quang Huy <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/GCP.3A.20Managing.20Resource.20Contention.20with.20FHIR.20Bundle.html#206117386">(Aug 06 2020 at 08:52)</a>:</h4>
<p>Hi, so currently I am trying to update multiple FHIR resources via executeBundle[1] and "Managing Resource Contention"[2] by using Etag with If-Match header. But GCP returning "412 Precondition Failed" with <code>"diagnostics": "the version id doesn't match current value"</code>.<br>
But it return "200 OK" when I try to update a single FHIR resource separately via executeBundle.<br>
The different here are:</p>
<ul>
<li>Case 1: request bundle have 2 or more entries, each entry is a different resource of the same type with different versionId.</li>
<li>Case 2: request bundle have only 1 entry.</li>
</ul>
<p>[1] <a href="https://cloud.google.com/healthcare/docs/reference/rest/v1/projects.locations.datasets.fhirStores.fhir/executeBundle">https://cloud.google.com/healthcare/docs/reference/rest/v1/projects.locations.datasets.fhirStores.fhir/executeBundle</a><br>
[2] <a href="http://hl7.org/fhir/http.html#concurrency">http://hl7.org/fhir/http.html#concurrency</a></p>
<p>So my request body for executeBundle look like this:<br>
POST <a href="https://healthcare.googleapis.com/v1/projects/*/locations/*/datasets/*/fhirStores/*/fhir">https://healthcare.googleapis.com/v1/projects/*/locations/*/datasets/*/fhirStores/*/fhir</a></p>
<ul>
<li>Case 1:</li>
</ul>
<div class="codehilite"><pre><span></span><code>{
  &quot;entry&quot;: [
    {
      &quot;resource&quot;: {
        &quot;active&quot;: false,
        &quot;gender&quot;: &quot;female&quot;,
        &quot;id&quot;: &quot;example1&quot;,
        &quot;meta&quot;: {
          &quot;lastUpdated&quot;: &quot;2020-08-06T08:19:13.138829+00:00&quot;,
          &quot;versionId&quot;: &quot;validVersionIdExample1&quot;
        },
        &quot;resourceType&quot;: &quot;Patient&quot;
      },
      &quot;request&quot;: {
        &quot;method&quot;: &quot;PUT&quot;,
        &quot;url&quot;: &quot;Patient/example1&quot;,
        &quot;ifMatch&quot;: &quot;W/\&quot;validVersionIdExample1\&quot;&quot;
      }
    },
    {
      &quot;resource&quot;: {
        &quot;active&quot;: false,
        &quot;gender&quot;: &quot;male&quot;,
        &quot;id&quot;: &quot;example2&quot;,
        &quot;meta&quot;: {
          &quot;lastUpdated&quot;: &quot;2020-08-06T08:19:30.331322+00:00&quot;,
          &quot;versionId&quot;: &quot;validVersionIdExample2&quot;
        },
        &quot;resourceType&quot;: &quot;Patient&quot;
      },
      &quot;request&quot;: {
        &quot;method&quot;: &quot;PUT&quot;,
        &quot;url&quot;: &quot;Patient/example2&quot;,
        &quot;ifMatch&quot;: &quot;W/\&quot;validVersionIdExample2\&quot;&quot;
      }
    }
  ],
  &quot;type&quot;: &quot;transaction&quot;,
  &quot;resourceType&quot;: &quot;Bundle&quot;
}
</code></pre></div>


<p>GCP will return: "Status: 412 Precondition Failed"</p>
<div class="codehilite"><pre><span></span><code>{
  &quot;issue&quot;: [
    {
      &quot;code&quot;: &quot;structure&quot;,
      &quot;details&quot;: {
        &quot;text&quot;: &quot;invalid_headers&quot;
      },
      &quot;diagnostics&quot;: &quot;the version id doesn&#39;t match current value&quot;,
      &quot;severity&quot;: &quot;error&quot;
    }
  ],
  &quot;resourceType&quot;: &quot;OperationOutcome&quot;
}
</code></pre></div>


<ul>
<li>Case 2:</li>
</ul>
<div class="codehilite"><pre><span></span><code>{
  &quot;entry&quot;: [
    {
      &quot;resource&quot;: {
        &quot;active&quot;: false,
        &quot;gender&quot;: &quot;female&quot;,
        &quot;id&quot;: &quot;example1&quot;,
        &quot;meta&quot;: {
          &quot;lastUpdated&quot;: &quot;2020-08-06T08:19:13.138829+00:00&quot;,
          &quot;versionId&quot;: &quot;validVersionIdExample1&quot;
        },
        &quot;resourceType&quot;: &quot;Patient&quot;
      },
      &quot;request&quot;: {
        &quot;method&quot;: &quot;PUT&quot;,
        &quot;url&quot;: &quot;Patient/example1&quot;,
        &quot;ifMatch&quot;: &quot;W/\&quot;validVersionIdExample1\&quot;&quot;
      }
    }
  ],
  &quot;type&quot;: &quot;transaction&quot;,
  &quot;resourceType&quot;: &quot;Bundle&quot;
}
</code></pre></div>


<p>GCP will return: "Status: 200 OK"</p>
<div class="codehilite"><pre><span></span><code>{
  &quot;entry&quot;: [
    {
      &quot;response&quot;: {
        &quot;etag&quot;: &quot;W/\&quot;newVersionId\&quot;&quot;,
        &quot;lastModified&quot;: &quot;2020-08-06T08:41:01.385494+00:00&quot;,
        &quot;location&quot;: &quot;https://healthcare.googleapis.com/v1/projects/*/locations/*/datasets/*/fhirStores/*/fhir/Patient/example1/_history/newVersionId&quot;,
        &quot;status&quot;: &quot;200 OK&quot;
      }
    }
  ],
  &quot;resourceType&quot;: &quot;Bundle&quot;,
  &quot;type&quot;: &quot;transaction-response&quot;
}
</code></pre></div>



<a name="206149972"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/GCP%3A%20Managing%20Resource%20Contention%20with%20FHIR%20Bundle/near/206149972" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/GCP.3A.20Managing.20Resource.20Contention.20with.20FHIR.20Bundle.html#206149972">(Aug 06 2020 at 14:40)</a>:</h4>
<p><span class="user-mention" data-user-id="197072">@Paul Church</span></p>



<a name="206169996"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/GCP%3A%20Managing%20Resource%20Contention%20with%20FHIR%20Bundle/near/206169996" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Church <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/GCP.3A.20Managing.20Resource.20Contention.20with.20FHIR.20Bundle.html#206169996">(Aug 06 2020 at 17:14)</a>:</h4>
<p>What are your expectations in each of these cases? It depends on the current state of the resources compared to the version IDs specified in If-Match.</p>



<a name="206227051"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/GCP%3A%20Managing%20Resource%20Contention%20with%20FHIR%20Bundle/near/206227051" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nguyen Quang Huy <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/GCP.3A.20Managing.20Resource.20Contention.20with.20FHIR.20Bundle.html#206227051">(Aug 07 2020 at 06:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="197072">Paul Church</span> <a href="#narrow/stream/179166-implementers/topic/GCP.3A.20Managing.20Resource.20Contention.20with.20FHIR.20Bundle/near/206169996">said</a>:</p>
<blockquote>
<p>What are your expectations in each of these cases? It depends on the current state of the resources compared to the version IDs specified in If-Match.</p>
</blockquote>
<p>For case 1: I expect GCP to return <code>Status: 200 OK</code> response bundle with 2 entries which is updated resources from request. And of course those 2 resources should be updated.<br>
For case 2: It is already return what I expect it to be returned.</p>



<a name="206515714"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/GCP%3A%20Managing%20Resource%20Contention%20with%20FHIR%20Bundle/near/206515714" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Church <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/GCP.3A.20Managing.20Resource.20Contention.20with.20FHIR.20Bundle.html#206515714">(Aug 10 2020 at 21:27)</a>:</h4>
<p>I believe the confusion here is that the meta.lastUpdated and meta.versionId in the resources in the bundle have no effect. These fields are assigned by the server. The ifMatch header compares against the version ID of the resource currently in the store.</p>
<p>Also, our implementation does not check IfMatch when doing a PUT to a resource that does not exist - perhaps it is a matter of interpretation whether this should be rejected.</p>
<p>Your examples are succeeding or failing depending on the state of the store.</p>



<a name="206551293"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/GCP%3A%20Managing%20Resource%20Contention%20with%20FHIR%20Bundle/near/206551293" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nguyen Quang Huy <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/GCP.3A.20Managing.20Resource.20Contention.20with.20FHIR.20Bundle.html#206551293">(Aug 11 2020 at 08:29)</a>:</h4>
<p>I think you miss understanding of my example. Let's me make it more clear:</p>
<ul>
<li>I have 2 Patient resources which already exist in FHIR store for example are <code>Patient/example1</code> &amp; <code>Patient/example2</code>.</li>
<li>I send to GCP an<code> executeBundle</code> to PUT those 2 already exist Patients, the <code>transaction bundle</code> in request body will have 2 entries which is corresponding to <code>Patient/example1</code> &amp; <code>Patient/example2</code>.</li>
<li>The <code>ifMatch</code> will point to current version ID  of <code>Patient/example1</code> &amp; <code>Patient/example2</code> corresponding are <code>currentVersionOfPatientExample1</code> &amp; <code>currentVersionOfPatientExample2</code>. So it will look like this:</li>
</ul>
<div class="codehilite"><pre><span></span><code>  &quot;entry&quot;: [
    {
      &quot;resource&quot;: {
        &quot;id&quot;: &quot;example1&quot;,
        &quot;resourceType&quot;: &quot;Patient&quot;
      },
      &quot;request&quot;: {
        &quot;method&quot;: &quot;PUT&quot;,
        &quot;url&quot;: &quot;Patient/example1&quot;,
        &quot;ifMatch&quot;: &quot;W/\&quot;currentVersionOfPatientExample1\&quot;&quot;
      }
    },
    {
      &quot;resource&quot;: {
        &quot;id&quot;: &quot;example2&quot;,
        &quot;resourceType&quot;: &quot;Patient&quot;
      },
      &quot;request&quot;: {
        &quot;method&quot;: &quot;PUT&quot;,
        &quot;url&quot;: &quot;Patient/example2&quot;,
        &quot;ifMatch&quot;: &quot;W/\&quot;currentVersionOfPatientExample2\&quot;&quot;
      }
    }
  ],
  &quot;type&quot;: &quot;transaction&quot;,
  &quot;resourceType&quot;: &quot;Bundle&quot;
}
</code></pre></div>


<p>This will sometimes succeed and sometimes fail. So I don't know what is happening here as why sometimes it succeed and sometimes it fail.</p>



<a name="207300099"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/GCP%3A%20Managing%20Resource%20Contention%20with%20FHIR%20Bundle/near/207300099" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Church <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/GCP.3A.20Managing.20Resource.20Contention.20with.20FHIR.20Bundle.html#207300099">(Aug 18 2020 at 18:56)</a>:</h4>
<p><span class="user-mention" data-user-id="320901">@Nguyen Quang Huy</span> I haven't reproduced this so far but we're still investigating. There are no existing known issues with IfMatch that would explain it.</p>



<a name="207537277"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/GCP%3A%20Managing%20Resource%20Contention%20with%20FHIR%20Bundle/near/207537277" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Church <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/GCP.3A.20Managing.20Resource.20Contention.20with.20FHIR.20Bundle.html#207537277">(Aug 20 2020 at 15:40)</a>:</h4>
<p><span class="user-mention" data-user-id="320901">@Nguyen Quang Huy</span> We have identified the cause of this issue and a fix is in progress. The issue is specific to transaction bundles containing more than one entry with an IfMatch condition. I don't have any workarounds to suggest but we are confident that the fix will address the issue once rolled out to production.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
