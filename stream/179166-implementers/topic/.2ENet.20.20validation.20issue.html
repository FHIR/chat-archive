---
layout: page
title: "FHIR Chat  · .Net  validation issue · implementers"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/index.html">implementers</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.2ENet.20.20validation.20issue.html">.Net  validation issue</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="176011908"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/.Net%20%20validation%20issue/near/176011908" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.2ENet.20.20validation.20issue.html#176011908">(Sep 18 2019 at 14:45)</a>:</h4>
<p>Hi !</p>
<p>I'm currently using FirelyTeam library (<a href="https://github.com/FirelyTeam/fhir-net-api/tree/master-r4/src/Hl7.Fhir.Specification" target="_blank" title="https://github.com/FirelyTeam/fhir-net-api/tree/master-r4/src/Hl7.Fhir.Specification">https://github.com/FirelyTeam/fhir-net-api/tree/master-r4/src/Hl7.Fhir.Specification</a>) for validation but I'm facing an issue with a simple validation.</p>
<p>I have created : <br>
- A custom profile for patient<br>
- A custom complex extension (Added to patient profile) with 3 fields (Nationality, DocumentType, DocumentNumber)</p>
<p>During validation, I've got theses errors from the library : <br>
[ERROR] Instance count for 'Extension.extension:nationality' is 3, which is not within the specified cardinality of 0..1 (at Patient.extension[0])    <br>
[ERROR] Instance count for 'Extension.extension:documentType' is 3, which is not within the specified cardinality of 0..1 (at Patient.extension[0])    <br>
[ERROR] Instance count for 'Extension.extension:documentNumber' is 3, which is not within the specified cardinality of 0..1 (at Patient.extension[0])</p>
<p>if I use HAPI validation, it gives multiples issues  :<br>
{<br>
      "severity": "error",<br>
      "code": "processing",<br>
      "diagnostics": "Could not match discriminator (url) for slice Patient.extension:citizenship in profile <a href="http://pms-fhir.org/fhir/StructureDefinition/PmsPatient" target="_blank" title="http://pms-fhir.org/fhir/StructureDefinition/PmsPatient">http://pms-fhir.org/fhir/StructureDefinition/PmsPatient</a> - does not have fixed value, binding or existence assertions",<br>
      "location": [<br>
        "Patient.extension"<br>
      ]<br>
    },<br>
    {<br>
      "severity": "error",<br>
      "code": "processing",<br>
      "diagnostics": "Could not match discriminator (url) for slice Extension.extension:nationality in profile <a href="http://pms-fhir.org/fhir/StructureDefinition/PmsCitizenship" target="_blank" title="http://pms-fhir.org/fhir/StructureDefinition/PmsCitizenship">http://pms-fhir.org/fhir/StructureDefinition/PmsCitizenship</a> - does not have fixed value, binding or existence assertions",<br>
      "location": [<br>
        "Patient.extension.extension[1]"<br>
      ]<br>
    }</p>
<p>Moreover, I see that multiple github issues related to this problem without any fixes : <br>
<a href="https://github.com/FirelyTeam/fhir-net-api/issues/885" target="_blank" title="https://github.com/FirelyTeam/fhir-net-api/issues/885">https://github.com/FirelyTeam/fhir-net-api/issues/885</a></p>
<p>It seems that the resolver can't correctly map my ressource.. Any ideas ?</p>



<a name="176012733"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/.Net%20%20validation%20issue/near/176012733" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michel Rutten <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.2ENet.20.20validation.20issue.html#176012733">(Sep 18 2019 at 14:54)</a>:</h4>
<p><span class="user-mention" data-user-id="191328">@Ewout Kramer</span> ?</p>



<a name="176015324"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/.Net%20%20validation%20issue/near/176015324" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.2ENet.20.20validation.20issue.html#176015324">(Sep 18 2019 at 15:22)</a>:</h4>
<p>Perfect timing!  We're working on those issues currently, and the fix is available in this branch (<a href="https://github.com/FirelyTeam/fhir-net-api/tree/develop-1.x/r4" target="_blank" title="https://github.com/FirelyTeam/fhir-net-api/tree/develop-1.x/r4">https://github.com/FirelyTeam/fhir-net-api/tree/develop-1.x/r4</a>).</p>
<p><span class="user-mention" data-user-id="238039">@Thomas</span> are you using your own build of the API?  In that case it would be lovely if you could grab that branch and test whether I have actually fixed your problem.</p>
<p>Otherwise, I think we have our CI build alphas of all these branches, and there should be a way to get to it and test it out.  <span class="user-mention" data-user-id="193551">@Marco Visser</span> do you know exactly?</p>



<a name="176075561"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/.Net%20%20validation%20issue/near/176075561" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.2ENet.20.20validation.20issue.html#176075561">(Sep 19 2019 at 07:30)</a>:</h4>
<blockquote>
<p>Perfect timing!  We're working on those issues currently, and the fix is available in this branch (<a href="https://github.com/FirelyTeam/fhir-net-api/tree/develop-1.x/r4" target="_blank" title="https://github.com/FirelyTeam/fhir-net-api/tree/develop-1.x/r4">https://github.com/FirelyTeam/fhir-net-api/tree/develop-1.x/r4</a>).</p>
<p><span class="user-mention silent" data-user-id="238039">Thomas</span> are you using your own build of the API?  In that case it would be lovely if you could grab that branch and test whether I have actually fixed your problem.</p>
<p>Otherwise, I think we have our CI build alphas of all these branches, and there should be a way to get to it and test it out.  <span class="user-mention silent" data-user-id="193551">Marco Visser</span> do you know exactly?</p>
</blockquote>
<p><span class="user-mention" data-user-id="191328">@Ewout Kramer</span>  Thanks for your answer. I'm currently using the build provided by the nuget package (<a href="https://www.nuget.org/packages/Hl7.Fhir.Specification.R4/" target="_blank" title="https://www.nuget.org/packages/Hl7.Fhir.Specification.R4/">https://www.nuget.org/packages/Hl7.Fhir.Specification.R4/</a>).</p>
<p>Now, I'm going to try artifacts located here : <a href="https://dev.azure.com/firely/fhir-net-api/_build/results?buildId=4744" target="_blank" title="https://dev.azure.com/firely/fhir-net-api/_build/results?buildId=4744">https://dev.azure.com/firely/fhir-net-api/_build/results?buildId=4744</a></p>



<a name="176076736"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/.Net%20%20validation%20issue/near/176076736" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.2ENet.20.20validation.20issue.html#176076736">(Sep 19 2019 at 07:54)</a>:</h4>
<p><span class="user-mention" data-user-id="191328">@Ewout Kramer</span> <br>
I've updated all packages to 1.4.0-alpha-20190912-1 and now I have a different issue during validation : </p>
<p>Overall result: FAILURE<br>
[FATAL] Internal logic failure: The value discriminator should have either a 'fixed[x]' or 'binding' element set on 'Extension.url'. (at Patient)</p>
<p>I've attached my DefinitionStructures of patient + Extension with an example.<br>
Extension definition : <a href="/user_uploads/10155/DJA_uvP5uiWydPwi6HACwOHQ/pmsCitizenship.StructureDefinition.xml" target="_blank" title="pmsCitizenship.StructureDefinition.xml">pmsCitizenship.StructureDefinition.xml</a> <br>
Patient definition : <a href="/user_uploads/10155/KZSbgqIAhCyPtWhHi-H7Dv0E/PmsPatient.StructureDefinition.xml" target="_blank" title="PmsPatient.StructureDefinition.xml">PmsPatient.StructureDefinition.xml</a><br>
Patient example : <a href="/user_uploads/10155/2chtYKpMa8sQplOJeddsFk_H/ExamplePatient" target="_blank" title="ExamplePatient">ExamplePatient</a> </p>
<p>Could you please, have a look ?</p>



<a name="176079553"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/.Net%20%20validation%20issue/near/176079553" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Marco Visser <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.2ENet.20.20validation.20issue.html#176079553">(Sep 19 2019 at 08:45)</a>:</h4>
<p>In the meantime I created the packages for 1.x/r4 on MyGet (<a href="https://www.myget.org/feed/fhir-net-api/package/nuget/Hl7.Fhir.R4/1.4.0-alpha-20190912-1" target="_blank" title="https://www.myget.org/feed/fhir-net-api/package/nuget/Hl7.Fhir.R4/1.4.0-alpha-20190912-1">https://www.myget.org/feed/fhir-net-api/package/nuget/Hl7.Fhir.R4/1.4.0-alpha-20190912-1</a>). So you could use that one, but it will be probably the same like you created yourself. Btw, this is not an official release, but an alpha release. Official releases can be found on NuGet.</p>
<p>I will try to test your use case now. I will  report the results later.</p>



<a name="176081487"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/.Net%20%20validation%20issue/near/176081487" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michel Rutten <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.2ENet.20.20validation.20issue.html#176081487">(Sep 19 2019 at 09:16)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="238039">@Thomas</span>, your extension definition has a couple of errors. All three<code>valueString</code> slices are repeated and the "[...].extension.url" elements don't specify a <code>fixedString</code> value (in the snapshot). This probably explains why the validator complains about the extension slice. Here are updated versions with snapshots generated by Forge R4 22.1:<br>
<a href="/user_uploads/10155/f1hoxx4dE3nQ3gIDZVY8Lwy5/pmsCitizenship.StructureDefinition.xml" target="_blank" title="pmsCitizenship.StructureDefinition.xml">pmsCitizenship.StructureDefinition.xml</a> <a href="/user_uploads/10155/bv5-1X18SXOKKyCIM_fpoRIT/PmsPatient.StructureDefinition.xml" target="_blank" title="PmsPatient.StructureDefinition.xml">PmsPatient.StructureDefinition.xml</a></p>



<a name="176082341"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/.Net%20%20validation%20issue/near/176082341" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Marco Visser <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.2ENet.20.20validation.20issue.html#176082341">(Sep 19 2019 at 09:30)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="238039">@Thomas</span>  , I can confirm  the comment of my colleague <span class="user-mention" data-user-id="191336">@Michel Rutten</span>: the structuredefinitions were not correct. I have created an unittest to prove that. <a href="/user_uploads/10155/XLU8CWoLzWv0qucnJuW3qC_H/Program.cs" target="_blank" title="Program.cs">Program.cs</a></p>



<a name="176101281"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/.Net%20%20validation%20issue/near/176101281" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.2ENet.20.20validation.20issue.html#176101281">(Sep 19 2019 at 13:53)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="191336">@Michel Rutten</span> and <span class="user-mention" data-user-id="193551">@Marco Visser</span>  for your revisions.</p>
<p>I've created these files with a previous version of forge and with this 22.1, it seems better.</p>
<p>Snapshot shoud always been included into structureDefinitions ?</p>
<p>Thanks again</p>



<a name="176101952"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/.Net%20%20validation%20issue/near/176101952" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michel Rutten <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.2ENet.20.20validation.20issue.html#176101952">(Sep 19 2019 at 13:59)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="238039">@Thomas</span>, <a href="http://hl7.org/fhir/structuredefinition-definitions.html#StructureDefinition.snapshot" target="_blank" title="http://hl7.org/fhir/structuredefinition-definitions.html#StructureDefinition.snapshot"><code>StructureDefinition.snapshot</code></a> is an optional component (not required). Systems can re-generate the snapshot from the differential component (depending on capabilities).<br>
Note that Forge ignores any existing snapshot and always re-generates a new snapshot based on the specified differential. Except when an existing profile only contains a snapshot and no differential.</p>



<a name="176129344"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/.Net%20%20validation%20issue/near/176129344" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.2ENet.20.20validation.20issue.html#176129344">(Sep 19 2019 at 18:44)</a>:</h4>
<p>I am happy my new code now turned this into a clear error message - this is probably also why the original &lt;1.4 version behaved incorrectly!   I'll  have to chase why the error includes the bit about "internal error", but those small things are to be expected in an alpha ;-)</p>



<a name="176137166"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/.Net%20%20validation%20issue/near/176137166" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.2ENet.20.20validation.20issue.html#176137166">(Sep 19 2019 at 20:11)</a>:</h4>
<p>Can we make it tollerant of the fixedUrl or fixedString in there, and report a warning/info message that the SD is incorrect, rather than the instance of the resource?</p>



<a name="176170131"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/.Net%20%20validation%20issue/near/176170131" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.2ENet.20.20validation.20issue.html#176170131">(Sep 20 2019 at 07:10)</a>:</h4>
<p><span class="user-mention" data-user-id="191336">@Michel Rutten</span>  Good to know, it seems that some servers implementation of FHIR need to have the full snapshot to have a correct validation of ressources..</p>
<p><span class="user-mention" data-user-id="191328">@Ewout Kramer</span>  Do you know when we could expect this bugfix included in the next release ?</p>



<a name="176176874"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/.Net%20%20validation%20issue/near/176176874" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michel Rutten <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.2ENet.20.20validation.20issue.html#176176874">(Sep 20 2019 at 09:13)</a>:</h4>
<p>FYI after discussion with Grahame &amp; Lloyd, I learned that <code>Extension.url</code> actually requires a <code>fixedUri</code> value, not a <code>fixedString</code> as I mistakenly had assumed. Coincidentally, this small discrepancy does not seem to cause validation errors, since the validator is perfectly capable of discriminating slices on fixedString values.<br>
I have already created a bugfix for the .NET API SnapshotGenerator and am planning to publish a Forge hotfix soon that includes a fix for this issue.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
