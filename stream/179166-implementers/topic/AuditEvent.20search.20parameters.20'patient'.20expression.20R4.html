---
layout: page
title: "FHIR Chat  · AuditEvent search parameters &#x27;patient&#x27; expression R4 · implementers"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/index.html">implementers</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/AuditEvent.20search.20parameters.20&#x27;patient&#x27;.20expression.20R4.html">AuditEvent search parameters &#x27;patient&#x27; expression R4</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="153997306"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/AuditEvent%20search%20parameters%20%27patient%27%20expression%20R4/near/153997306" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Angus Millar <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/AuditEvent.20search.20parameters.20&#x27;patient&#x27;.20expression.20R4.html#153997306">(Sep 17 2018 at 09:22)</a>:</h4>
<p>I was digging into why a Patient compartment search was not working for AuditEvent search, on a server implementation, this search:<br>
<code>[base]/Patient/FCC-PAT-00001/AuditEvent</code> where I knew I had an AuditEvent for this patient 'FCC-PAT-00001'<br>
It turned out that the 'patient' search parameter was never being indexed based on the FHIR path expression for the search parameter. That Search parameter being  'patient' on the AuditEvent resource. The expression in the FHIR R4 spec definitions.xml file  SearchParameters  resource for this parameter was this:<br>
Expression = <code>AuditEvent.agent.who.where(resolve() is Patient) | AuditEvent.entity.what.where(resolve() is Patient)</code><br>
In the FHIR .NET API that expression fails on 'resolve()'. I'm no FHIR path expert but I think 'resolve()' means got get the resource the ResourceReference points to. That's never going to happen in this context, well not for me.  I feel that the expression should be this, which then works for me .<br>
Expression = <code>AuditEvent.entity.what.where(reference.startsWith('Patient')) | AuditEvent.agent.who.where(reference.startsWith('Patient'))</code><br>
Does anyone else agree with me that the currect expression in the R4 Spec is wrong? It can be found here: <a href="http://hl7.org/fhir/2018Sep/auditevent.html#search" target="_blank" title="http://hl7.org/fhir/2018Sep/auditevent.html#search">http://hl7.org/fhir/2018Sep/auditevent.html#search</a></p>



<a name="153997312"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/AuditEvent%20search%20parameters%20%27patient%27%20expression%20R4/near/153997312" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/AuditEvent.20search.20parameters.20&#x27;patient&#x27;.20expression.20R4.html#153997312">(Sep 17 2018 at 09:25)</a>:</h4>
<p>not it's not wrong. I understand why you don't like it, but the change you propose would only be right if only local references are allowed</p>



<a name="153997313"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/AuditEvent%20search%20parameters%20%27patient%27%20expression%20R4/near/153997313" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/AuditEvent.20search.20parameters.20&#x27;patient&#x27;.20expression.20R4.html#153997313">(Sep 17 2018 at 09:25)</a>:</h4>
<p>we've actually removed this in R4</p>



<a name="153997322"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/AuditEvent%20search%20parameters%20%27patient%27%20expression%20R4/near/153997322" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Angus Millar <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/AuditEvent.20search.20parameters.20&#x27;patient&#x27;.20expression.20R4.html#153997322">(Sep 17 2018 at 09:30)</a>:</h4>
<blockquote>
<p>not it's not wrong. I understand why you don't like it, but the change you propose would only be right if only local references are allowed</p>
</blockquote>
<p>Humm, good point did not think of that. Still, don't understand how it works as it is though.</p>
<p>Actualy I now feel the issue lies with the .NET R4 FHIR Path expression implementation. The FHIR Path spec says this for resolve():<br>
"The items in the collection may also represent a Reference, in which case the Reference.reference is resolved."<br>
That appears to not happen.</p>



<a name="153997341"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/AuditEvent%20search%20parameters%20%27patient%27%20expression%20R4/near/153997341" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/AuditEvent.20search.20parameters.20&#x27;patient&#x27;.20expression.20R4.html#153997341">(Sep 17 2018 at 12:26)</a>:</h4>
<p>then you can make a task but I think actually it is implemented but you need to implement some kind of service (<span class="user-mention" data-user-id="191367">@Brian Postlethwaite</span> )</p>



<a name="153997342"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/AuditEvent%20search%20parameters%20%27patient%27%20expression%20R4/near/153997342" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/AuditEvent.20search.20parameters.20&#x27;patient&#x27;.20expression.20R4.html#153997342">(Sep 17 2018 at 12:30)</a>:</h4>
<p>I'm not sure on that one.</p>



<a name="153997344"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/AuditEvent%20search%20parameters%20%27patient%27%20expression%20R4/near/153997344" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/AuditEvent.20search.20parameters.20&#x27;patient&#x27;.20expression.20R4.html#153997344">(Sep 17 2018 at 12:31)</a>:</h4>
<p>In my server I'm going to be reprocessing those specific fhirpath queries with specific code so that it dowant actually resolve, but checks that it is a patient reference.</p>



<a name="153997345"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/AuditEvent%20search%20parameters%20%27patient%27%20expression%20R4/near/153997345" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/AuditEvent.20search.20parameters.20&#x27;patient&#x27;.20expression.20R4.html#153997345">(Sep 17 2018 at 12:32)</a>:</h4>
<p>Haven't done it yet though</p>



<a name="153997350"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/AuditEvent%20search%20parameters%20%27patient%27%20expression%20R4/near/153997350" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Angus Millar <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/AuditEvent.20search.20parameters.20&#x27;patient&#x27;.20expression.20R4.html#153997350">(Sep 17 2018 at 13:05)</a>:</h4>
<p>Well it is a little ugly but I can't see how it will fail unless someone creates a server base with '/Patient/' within. So I chnanged the expression to this:<br>
Expression = $"AuditEvent.entity.what.where(reference.startsWith('Patient/') or reference.contains('/Patient/')) | AuditEvent.agent.who.where(reference.startsWith('Patient/') or reference.contains('/Patient/'))";</p>



<a name="153997351"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/AuditEvent%20search%20parameters%20%27patient%27%20expression%20R4/near/153997351" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/AuditEvent.20search.20parameters.20&#x27;patient&#x27;.20expression.20R4.html#153997351">(Sep 17 2018 at 13:11)</a>:</h4>
<p>And don't need to hit the DB either,  and read the whole resource just to find out if it is a patient.</p>



<a name="153997354"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/AuditEvent%20search%20parameters%20%27patient%27%20expression%20R4/near/153997354" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Angus Millar <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/AuditEvent.20search.20parameters.20&#x27;patient&#x27;.20expression.20R4.html#153997354">(Sep 17 2018 at 14:02)</a>:</h4>
<p>Yeah exsactly ,that was what I never wanted to do and yet that older expression was implying that is what was to happen.</p>



<a name="153997355"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/AuditEvent%20search%20parameters%20%27patient%27%20expression%20R4/near/153997355" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/AuditEvent.20search.20parameters.20&#x27;patient&#x27;.20expression.20R4.html#153997355">(Sep 17 2018 at 14:05)</a>:</h4>
<p>are the patterns intended to be literal? Or instructional? I expected a system could optimize the query parameters in many ways based on their technology.</p>



<a name="153997356"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/AuditEvent%20search%20parameters%20%27patient%27%20expression%20R4/near/153997356" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/AuditEvent.20search.20parameters.20&#x27;patient&#x27;.20expression.20R4.html#153997356">(Sep 17 2018 at 14:08)</a>:</h4>
<p>where is it that you see the specific language you have shown? In the AuditEvent there is only <code>  AuditEvent.agent.who.where(resolve() is Patient) | AuditEvent.entity.what.where(resolve() is Patient)</code></p>



<a name="153997360"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/AuditEvent%20search%20parameters%20%27patient%27%20expression%20R4/near/153997360" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Angus Millar <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/AuditEvent.20search.20parameters.20&#x27;patient&#x27;.20expression.20R4.html#153997360">(Sep 17 2018 at 14:30)</a>:</h4>
<p>I changed the FHIR Path in the specification, as you have posted, to a different FHIR Path expression for my use case as I posted.  The issue I have with the one in the spec is that it tries to resolve to a Patient resource instance rather than a ResourceReferance to a Patient resource. Given the expression is in  a SearchParameterDefinition Resource and that  search paramter is defined as a search type 'reference' I would personaly expect the FHIR Path expression to resolve to a ResourceReferance and not a Resource instance.</p>



<a name="153997361"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/AuditEvent%20search%20parameters%20%27patient%27%20expression%20R4/near/153997361" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Angus Millar <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/AuditEvent.20search.20parameters.20&#x27;patient&#x27;.20expression.20R4.html#153997361">(Sep 17 2018 at 14:32)</a>:</h4>
<p>As a server implementation I expected the SearchParameterDefinition expressions to be literal as I process them programaticaly to create search indexes. Personaly I though that was the intent.</p>



<a name="153997389"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/AuditEvent%20search%20parameters%20%27patient%27%20expression%20R4/near/153997389" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/AuditEvent.20search.20parameters.20&#x27;patient&#x27;.20expression.20R4.html#153997389">(Sep 17 2018 at 15:04)</a>:</h4>
<p>I am happy to entertain an improvement submitted as a change request. You are likely correct in that this expression was written before Reference changed to include identifier... so I am not sure what would be a proper expression today. Happy to see recommendations.</p>



<a name="153997877"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/AuditEvent%20search%20parameters%20%27patient%27%20expression%20R4/near/153997877" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/AuditEvent.20search.20parameters.20&#x27;patient&#x27;.20expression.20R4.html#153997877">(Sep 19 2018 at 00:59)</a>:</h4>
<p><span class="user-mention" data-user-id="191391">@Angus Millar</span> I'm confused by this:</p>



<a name="153997878"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/AuditEvent%20search%20parameters%20%27patient%27%20expression%20R4/near/153997878" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/AuditEvent.20search.20parameters.20&#x27;patient&#x27;.20expression.20R4.html#153997878">(Sep 19 2018 at 00:59)</a>:</h4>
<blockquote>
<p>The issue I have with the one in the spec is that it tries to resolve to a Patient resource instance rather than a ResourceReferance to a Patient resource. Given the expression is in a SearchParameterDefinition Resource and that search paramter is defined as a search type 'reference' I would personaly expect the FHIR Path expression to resolve to a ResourceReferance and not a Resource instance</p>
</blockquote>



<a name="153997879"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/AuditEvent%20search%20parameters%20%27patient%27%20expression%20R4/near/153997879" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/AuditEvent.20search.20parameters.20&#x27;patient&#x27;.20expression.20R4.html#153997879">(Sep 19 2018 at 00:59)</a>:</h4>
<p>it does</p>



<a name="153997880"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/AuditEvent%20search%20parameters%20%27patient%27%20expression%20R4/near/153997880" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/AuditEvent.20search.20parameters.20&#x27;patient&#x27;.20expression.20R4.html#153997880">(Sep 19 2018 at 01:00)</a>:</h4>
<p>resolve to a reference, that is. Unless you mean something different by "ResourceReference"</p>



<a name="153997891"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/AuditEvent%20search%20parameters%20%27patient%27%20expression%20R4/near/153997891" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Angus Millar <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/AuditEvent.20search.20parameters.20&#x27;patient&#x27;.20expression.20R4.html#153997891">(Sep 19 2018 at 01:24)</a>:</h4>
<p>Lookig again Graham you are correct, the <code>.where(resolve() is Patient)</code> portion should retun a Reference.reference as is stated by the FHIR Path specification for resolve() as below. So my root problem is that the .NET FHIR API FHIR Path is not handleing resolve for me as documented. I will try address that in the dotnet stream. </p>
<div class="codehilite"><pre><span></span>B.3.3. resolve() : collection
For each item in the collection, if it is a string, locate the target of the reference, and add it to the resulting collection. If the item is not a string, the item is ignored and nothing is added to the output collection.

The items in the collection may also represent a Reference, in which case the Reference.reference is resolved.

If fetching the resource fails, the failure message is added to the output collection.
</pre></div>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
