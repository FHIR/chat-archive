---
layout: page
title: "FHIR Chat  · Querying with :excludes vs :not ? · implementers"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/index.html">implementers</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Querying.20with.20.3Aexcludes.20vs.20.3Anot.20.3F.html">Querying with :excludes vs :not ?</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="203735692"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Querying%20with%20%3Aexcludes%20vs%20%3Anot%20%3F/near/203735692" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Querying.20with.20.3Aexcludes.20vs.20.3Anot.20.3F.html#203735692">(Jul 13 2020 at 16:16)</a>:</h4>
<p>Today in FHIR it's hard to query for data that <em>doesn't</em> match a specific value. For example, say you want to query for data that *aren't marked with a "restricted" or "very restricted" security label. You might try:</p>
<div class="codehilite"><pre><span></span><code>GET Observation?_security:not=R,VR
</code></pre></div>


<p>... but this query is subtly broken (and <span class="user-mention" data-user-id="191387">@Keith Boone</span> explains many of the reasons in <a href="http://motorcycleguy.blogspot.com/2019/06/set-theory-much-yeah-me-too.html">his "Set theory much" blog post</a>). Briefly, this query will match a resource that has a <code>VR</code> security label if the resource <em>also</em> has some some other label like a "sensitivity category" code of <code>http://terminology.hl7.org/CodeSystem/v3-ActCode|HIV</code> indicating that it's very restricted data <em>about HIV</em>. The <code>HIV</code> code means there's a security label present that <em>isn't</em> <code>R</code> or <code>VR</code>, so this Observation gets included in the response to the <code>:not</code> search, even though we didn't want it to.</p>



<a name="203735762"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Querying%20with%20%3Aexcludes%20vs%20%3Anot%20%3F/near/203735762" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Querying.20with.20.3Aexcludes.20vs.20.3Anot.20.3F.html#203735762">(Jul 13 2020 at 16:17)</a>:</h4>
<hr>
<p>Have we thought about defining a different modifier to convey this intent -- something like <code>:exclude</code> instead of <code>:not</code>, that would allow queries like:</p>
<div class="codehilite"><pre><span></span><code>GET Observation?_security:exclude=R,VR
</code></pre></div>



<a name="203750488"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Querying%20with%20%3Aexcludes%20vs%20%3Anot%20%3F/near/203750488" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Querying.20with.20.3Aexcludes.20vs.20.3Anot.20.3F.html#203750488">(Jul 13 2020 at 18:17)</a>:</h4>
<p>to be clear this is not a problem specific to _security..... and actually ConfidentialityCode vocabulary is a bad example as it is a non-overlapping set of 6 codes, so to say 'not this' can also be said as 'only that'. This vocabulary is unusual in that it is explicitly designed as a non-overlapping set of 6 codes. (Note part of this design was also assuming all data had to have a confidentiityCode value (1..1), we did not put that requirement into FHIR core to avoid massive duplication of 99.99% of all resources being forced to have the code Normal. Had we required (1..1) then 'only that' would have been equivalent to 'not this'.  Sadly current core requirements on .meta.security do lead to situations you are pointing out.</p>



<a name="203755982"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Querying%20with%20%3Aexcludes%20vs%20%3Anot%20%3F/near/203755982" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Querying.20with.20.3Aexcludes.20vs.20.3Anot.20.3F.html#203755982">(Jul 13 2020 at 18:59)</a>:</h4>
<p>Good point. I've updated the topic to make this clear.</p>



<a name="203757898"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Querying%20with%20%3Aexcludes%20vs%20%3Anot%20%3F/near/203757898" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Querying.20with.20.3Aexcludes.20vs.20.3Anot.20.3F.html#203757898">(Jul 13 2020 at 19:14)</a>:</h4>
<p>you could do this with a value set query, I believe</p>



<a name="203769711"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Querying%20with%20%3Aexcludes%20vs%20%3Anot%20%3F/near/203769711" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Querying.20with.20.3Aexcludes.20vs.20.3Anot.20.3F.html#203769711">(Jul 13 2020 at 20:52)</a>:</h4>
<p>Can you show me what that would look like <span class="user-mention" data-user-id="191316">@Grahame Grieve</span> ? How do I define a valueset so that <code>Observation?_security:in=https://my-value-set</code> returns only observations that <em>lack</em> a <code>R</code> or <code>VR</code> label? The ValueSet query will only find observations that <em>match</em> something, right?</p>



<a name="203775666"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Querying%20with%20%3Aexcludes%20vs%20%3Anot%20%3F/near/203775666" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Querying.20with.20.3Aexcludes.20vs.20.3Anot.20.3F.html#203775666">(Jul 13 2020 at 21:45)</a>:</h4>
<p>yes like that, but using :not-in instead of :in</p>



<a name="203776921"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Querying%20with%20%3Aexcludes%20vs%20%3Anot%20%3F/near/203776921" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Querying.20with.20.3Aexcludes.20vs.20.3Anot.20.3F.html#203776921">(Jul 13 2020 at 21:59)</a>:</h4>
<p>So if <code>https://my-value-set</code> has 3 codes (<code>A</code>, <code>B</code>, <code>C</code>), then <code>?_security:not-in=https://my-value-set</code> acts differently from <code>?_security:not=A,B,C</code>?</p>



<a name="204125219"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Querying%20with%20%3Aexcludes%20vs%20%3Anot%20%3F/near/204125219" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Querying.20with.20.3Aexcludes.20vs.20.3Anot.20.3F.html#204125219">(Jul 16 2020 at 18:43)</a>:</h4>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span> can you weigh in on this?</p>



<a name="204157590"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Querying%20with%20%3Aexcludes%20vs%20%3Anot%20%3F/near/204157590" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Querying.20with.20.3Aexcludes.20vs.20.3Anot.20.3F.html#204157590">(Jul 16 2020 at 23:55)</a>:</h4>
<p>no I think you're right - it will return any resources that have at least security tag that it not in the value set</p>



<a name="204236758"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Querying%20with%20%3Aexcludes%20vs%20%3Anot%20%3F/near/204236758" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Querying.20with.20.3Aexcludes.20vs.20.3Anot.20.3F.html#204236758">(Jul 17 2020 at 17:48)</a>:</h4>
<p>So is it worth proposing a new <code>:excludes</code> modifier for these kinds of cases? Or better to just leave this as a known challenge? I could see it either way...</p>



<a name="204265572"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Querying%20with%20%3Aexcludes%20vs%20%3Anot%20%3F/near/204265572" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Querying.20with.20.3Aexcludes.20vs.20.3Anot.20.3F.html#204265572">(Jul 17 2020 at 22:11)</a>:</h4>
<p>not sure. we could. Let's see - can we do it with _filter? </p>
<p><code>Observation?_filter=not (security in https://my-value-set)</code></p>
<p>I think that's what you want  - because with richer syntax, you can control the handling of the not</p>



<a name="204281257"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Querying%20with%20%3Aexcludes%20vs%20%3Anot%20%3F/near/204281257" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Querying.20with.20.3Aexcludes.20vs.20.3Anot.20.3F.html#204281257">(Jul 18 2020 at 03:24)</a>:</h4>
<p>That's true; is that an argument against proposing a modifier? Many of our most recent improvements to search are things that _filter "already covers"</p>



<a name="204281736"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Querying%20with%20%3Aexcludes%20vs%20%3Anot%20%3F/near/204281736" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Querying.20with.20.3Aexcludes.20vs.20.3Anot.20.3F.html#204281736">(Jul 18 2020 at 03:38)</a>:</h4>
<p>it is an argument, yes. I'm not sure how strong it is, as you say</p>



<a name="244473210"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Querying%20with%20%3Aexcludes%20vs%20%3Anot%20%3F/near/244473210" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Querying.20with.20.3Aexcludes.20vs.20.3Anot.20.3F.html#244473210">(Jun 30 2021 at 19:09)</a>:</h4>
<p>I'm revisiting this with a new use case of excluding data; from search results we're looking at examples in the Argo Write project where patient-supplied data may have a specific tag; it's important to have some way to include or exclude such data from a search -- and today, there's no way to ask for data <em>without</em> a certain tag.</p>
<div class="codehilite"><pre><span></span><code>GET Observation?_tag:excludes=http://terminology.hl7.org/CodeSystem/common-tags|unreconciled
</code></pre></div>

<p>would be a fairly natural thing to do. I'll submit a Jira issue.</p>



<a name="244474805"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Querying%20with%20%3Aexcludes%20vs%20%3Anot%20%3F/near/244474805" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Querying.20with.20.3Aexcludes.20vs.20.3Anot.20.3F.html#244474805">(Jun 30 2021 at 19:23)</a>:</h4>
<p>Wait, reading now I see the following note tucked away in an example at <a href="http://hl7.org/fhir/search.html#token">http://hl7.org/fhir/search.html#token</a>:</p>
<blockquote>
<p>Note that this search does not return "any document that has a section that is not an Allergies and adverse reaction section" (e.g. in the presence of multiple possible matches, the negation applies to the set, not each individual entry)</p>
</blockquote>
<p>... this seems to imply that <code>:not</code> <em>already</em> behaves like the <code>:excludes</code> I'm asking for -- but nobody point this out, and <span class="user-mention" data-user-id="191316">@Grahame Grieve</span>  you even said the opposite:</p>
<blockquote>
<p>it will return any resources that have at least security tag that it not in the value set</p>
</blockquote>



<a name="244476196"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Querying%20with%20%3Aexcludes%20vs%20%3Anot%20%3F/near/244476196" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Querying.20with.20.3Aexcludes.20vs.20.3Anot.20.3F.html#244476196">(Jun 30 2021 at 19:35)</a>:</h4>
<p>yes i was wrong, sorry</p>



<a name="244478180"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/Querying%20with%20%3Aexcludes%20vs%20%3Anot%20%3F/near/244478180" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/Querying.20with.20.3Aexcludes.20vs.20.3Anot.20.3F.html#244478180">(Jun 30 2021 at 19:50)</a>:</h4>
<p>No, that's a great outcome. My use case is already supported. I'll give this a shot against some reference servers.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
