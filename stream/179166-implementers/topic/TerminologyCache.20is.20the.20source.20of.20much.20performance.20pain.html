---
layout: page
title: "FHIR Chat  · TerminologyCache is the source of much performance pain · implementers"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/index.html">implementers</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/TerminologyCache.20is.20the.20source.20of.20much.20performance.20pain.html">TerminologyCache is the source of much performance pain</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="268723308"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/TerminologyCache%20is%20the%20source%20of%20much%20performance%20pain/near/268723308" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonathan Meijer <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/TerminologyCache.20is.20the.20source.20of.20much.20performance.20pain.html#268723308">(Jan 20 2022 at 16:59)</a>:</h4>
<p>When validating messages, the validateCode(ValidationOptions options, CodeableConcept code, ValueSet vs) method in org.hl7.fhir.r5.BaseWorkerContext (called by checkCodeOnServer in org.hl7.fhir.validation.instance.InstanceValidator) creates a token to find a cached validation result.<br>
While the purpose of a cache is usually to improve performance, this heavy lookup takes 15-20% of the average validation entire time.  This is because TerminologyCache.extracted(...) converts the entire ValueSet into JSON, and the UTF8 conversion takes most of the time.<br>
The issue appears to be in TerminologyCache.extracted(...).  Seems that in order to build the cache token, it'd be simply a lot more efficient to use the ValueSet.url instead of using the whole ValueSet?!?</p>
<p>Any comments on the matter?</p>



<a name="268758621"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/TerminologyCache%20is%20the%20source%20of%20much%20performance%20pain/near/268758621" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonathan Meijer <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/TerminologyCache.20is.20the.20source.20of.20much.20performance.20pain.html#268758621">(Jan 20 2022 at 21:13)</a>:</h4>
<p>Noticed CacheToken.request is never used except to generate CacheToken.key.</p>



<a name="268789283"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/TerminologyCache%20is%20the%20source%20of%20much%20performance%20pain/near/268789283" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vassil Peytchev <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/TerminologyCache.20is.20the.20source.20of.20much.20performance.20pain.html#268789283">(Jan 21 2022 at 02:47)</a>:</h4>
<p>Is that regarding the validator code, or IG publisher?</p>



<a name="268795005"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/TerminologyCache%20is%20the%20source%20of%20much%20performance%20pain/near/268795005" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/TerminologyCache.20is.20the.20source.20of.20much.20performance.20pain.html#268795005">(Jan 21 2022 at 04:35)</a>:</h4>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span> to consider when you're back</p>



<a name="268841039"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/TerminologyCache%20is%20the%20source%20of%20much%20performance%20pain/near/268841039" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonathan Meijer <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/TerminologyCache.20is.20the.20source.20of.20much.20performance.20pain.html#268841039">(Jan 21 2022 at 13:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="192685">Vassil Peytchev</span> <a href="#narrow/stream/179166-implementers/topic/TerminologyCache.20is.20the.20source.20of.20much.20performance.20pain/near/268789283">said</a>:</p>
<blockquote>
<p>Is that regarding the validator code, or IG publisher?</p>
</blockquote>
<p>Inside the Validator code.</p>



<a name="269526776"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/TerminologyCache%20is%20the%20source%20of%20much%20performance%20pain/near/269526776" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/TerminologyCache.20is.20the.20source.20of.20much.20performance.20pain.html#269526776">(Jan 27 2022 at 05:11)</a>:</h4>
<p>hmm. I thought I had refactored that code.</p>



<a name="269526856"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/TerminologyCache%20is%20the%20source%20of%20much%20performance%20pain/near/269526856" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/TerminologyCache.20is.20the.20source.20of.20much.20performance.20pain.html#269526856">(Jan 27 2022 at 05:12)</a>:</h4>
<p>I'll look at it again</p>



<a name="269687186"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/TerminologyCache%20is%20the%20source%20of%20much%20performance%20pain/near/269687186" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/TerminologyCache.20is.20the.20source.20of.20much.20performance.20pain.html#269687186">(Jan 28 2022 at 05:04)</a>:</h4>
<p>will be improved next release</p>



<a name="269687196"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/TerminologyCache%20is%20the%20source%20of%20much%20performance%20pain/near/269687196" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/TerminologyCache.20is.20the.20source.20of.20much.20performance.20pain.html#269687196">(Jan 28 2022 at 05:04)</a>:</h4>
<p>though it does change the behavior of the validator somewhat...</p>



<a name="269687250"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/TerminologyCache%20is%20the%20source%20of%20much%20performance%20pain/near/269687250" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/TerminologyCache.20is.20the.20source.20of.20much.20performance.20pain.html#269687250">(Jan 28 2022 at 05:05)</a>:</h4>
<p>the validator has been robust about breaking the versioning rules - offering up the same value set by url + version that contains different content. From now on, that won't work the same. That was something <span class="user-mention" data-user-id="191319">@James Agnew</span> and I already decided on</p>



<a name="269687260"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/TerminologyCache%20is%20the%20source%20of%20much%20performance%20pain/near/269687260" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/TerminologyCache.20is.20the.20source.20of.20much.20performance.20pain.html#269687260">(Jan 28 2022 at 05:05)</a>:</h4>
<p>I just didn't finish the change off</p>



<a name="275014313"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/TerminologyCache%20is%20the%20source%20of%20much%20performance%20pain/near/275014313" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonathan Meijer <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/TerminologyCache.20is.20the.20source.20of.20much.20performance.20pain.html#275014313">(Mar 11 2022 at 18:31)</a>:</h4>
<p>FYI, average time required to validate doubled from 5.4.11 to 5.6.36.  Though there are many cases of Spring.replace which take up a lot of time in processing (through Pattern match), replacing those occurrences with StringUtils.replace/remove do not appear to improve performance much.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
