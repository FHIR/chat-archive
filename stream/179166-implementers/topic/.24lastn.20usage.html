---
layout: page
title: "FHIR Chat  · $lastn usage · implementers"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/index.html">implementers</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.24lastn.20usage.html">$lastn usage</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="185711073"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/%24lastn%20usage/near/185711073" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> André Luiz <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.24lastn.20usage.html#185711073">(Jan 15 2020 at 15:56)</a>:</h4>
<p>Hey everyone!<br>
I would like to ask if someone already used the $lastn Operation.<br>
I created this operation but doesn't seem to work properly. Everytime I use this parameter, it gets ignored.</p>
<p>I'm trying to use it as a GROUP BY of codes.</p>



<a name="185715366"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/%24lastn%20usage/near/185715366" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michele Mottini <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.24lastn.20usage.html#185715366">(Jan 15 2020 at 16:33)</a>:</h4>
<p>No sure what you mean with 'I created this operation' ? Do you have your own server? Or are you trying to use the operation on an existing server? And if so - which one?</p>



<a name="185715741"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/%24lastn%20usage/near/185715741" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> André Luiz <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.24lastn.20usage.html#185715741">(Jan 15 2020 at 16:37)</a>:</h4>
<p>I'm using the HAPI-FHIR implementation and i created the OperationDefinition like below:</p>
<div class="codehilite"><pre><span></span>    {
      &quot;fullUrl&quot;: &quot;http://localhost:8080/baseDstu3/OperationDefinition/46545&quot;,
      &quot;resource&quot;: {
        &quot;resourceType&quot;: &quot;OperationDefinition&quot;,
        &quot;id&quot;: &quot;46545&quot;,
        &quot;meta&quot;: {
          &quot;versionId&quot;: &quot;1&quot;,
          &quot;lastUpdated&quot;: &quot;2020-01-15T15:34:02.221+00:00&quot;
        },
        &quot;text&quot;: {
          &quot;status&quot;: &quot;generated&quot;,
          &quot;div&quot;: &quot;&lt;div xmlns=\&quot;http://www.w3.org/1999/xhtml\&quot;&gt;!-- Snipped for Brevity --&amp;gt;&lt;/div&gt;&quot;
        },
        &quot;extension&quot;: [
          {
            &quot;url&quot;: &quot;http://hl7.org/fhir/StructureDefinition/structuredefinition-fmm&quot;,
            &quot;valueInteger&quot;: 3
          },
          {
            &quot;url&quot;: &quot;http://hl7.org/fhir/StructureDefinition/structuredefinition-standards-status&quot;,
            &quot;valueCode&quot;: &quot;trial-use&quot;
          }
        ],
        &quot;url&quot;: &quot;http://hl7.org/fhir/OperationDefinition/Observation-lastn&quot;,
        &quot;version&quot;: &quot;4.0.1&quot;,
        &quot;name&quot;: &quot;Last N Observations Query&quot;,
        &quot;status&quot;: &quot;draft&quot;,
        &quot;kind&quot;: &quot;operation&quot;,
        &quot;date&quot;: &quot;2019-11-01T09:29:23+11:00&quot;,
        &quot;publisher&quot;: &quot;HL7 (FHIR Project)&quot;,
        &quot;contact&quot;: [
          {
            &quot;telecom&quot;: [
              {
                &quot;system&quot;: &quot;url&quot;,
                &quot;value&quot;: &quot;http://hl7.org/fhir&quot;
              },
              {
                &quot;system&quot;: &quot;email&quot;,
                &quot;value&quot;: &quot;fhir@lists.hl7.org&quot;
              }
            ]
          }
        ],
        &quot;description&quot;: &quot;The *lastn query* meets the common need for searching for the most recent or last n=number of observations for a subject. For example, retrieving the last 5 temperatures for a patient to view trends or fetching the most recent laboratory results or vitals signs. To ask a server to return the last n=number of observations, the *lastn* query uses the [normal search parameters](observation.html#search) defined for the Observation resource.  However, rather than their normal use, they are interpreted as inputs - i.e.. instead of requiring that the resources literally contain the search parameters, they are passed to a server algorithm of some kind that uses them to determine the most appropriate matches.\n\nThe request for a lastn query SHALL include:\n\n* A `$lastn` operation parameter\n*  A subject using either the `patient` or `subject`  search parameter\n*  A `category` parameter and/or a search parameter that contains a code element in its FHIRpath expression.  ( e.g., `code` or `code-value-concept`)\n\nThe request for a lastn query MAY include:\n\n* Other Observation search parameters and modifiers\n\nThe response from a lastn query is a set of observations:\n\n*  Filtered by additional parameters\n   * If not explicitly filtered by status then will include statuses of &#39;entered-in-error&#39;\n* &#39;GROUP BY&#39; `Observation.code`\n   * Codes SHALL be considered equivalent if the `coding.value` *and* `coding.system` are the same.\n   * Text only codes SHALL be treated and grouped based on the text.\n   * For codes with translations (multiple codings), the code translations are assumed to be equal and the grouping by code SHALL follow the transitive property of equality.\n\nfor example:\n\n|Observation.code for observation a|Observation.code for observation b|Observation.code for observation c|number of groups [codes/text in each group]|    \n|---|---|---|---|     \n|a|b|c | 3 [a],[b],[c]|    \n|a|b|a,c | 2 [a.c],[b]|     \n|a|b|a,b | 1 [a,b]|    \n|&#39;textM&#39;|&#39;Text&#39;|&#39;t e x t&#39;|3 [&#39;text&#39;],[&#39;Text&#39;],[&#39;t e x t&#39;]|\n\n* Sorted from most recent to the oldest\n* Limited to the number of requested responses per group specified by the optional *max* query parameter\n  * In case of a tie - when the effective times for &gt;1 Observations are equal - both will be returned.  Therefore, more Observations may be returned than is specified in *max*.  For example, 4 Observations instead of 3 if the 3rd and 4th most recent observation had the same effective time.\n* If no maximum number is given then only the most recent Observation in each group is returned.\n\nThe set of returned observations should represent distinct real world observations and not the same observation with changes in status or versions. If there are no matches, the *lastn* query SHALL return an empty search set with no error, but may include an operation outcome with further advice.&quot;,
        &quot;code&quot;: &quot;lastn&quot;,
        &quot;comment&quot;: &quot;The key differences between this query operation and simply searching Observation using the combination of `_count` and `_sort` parameters are:\r\r* The *lastn* query returns **only** the last N resource grouped by code.  Using the _count query method doesn&#39;t restrict the total matches so you may need to page through several \&quot;A\&quot; Observations  before getting to Observation \&quot;B\&quot;.\r* The server is responsible for grouping the observations by codes.  This frees the client from needing to determine which codes she should ask for.\r\rThis operation cannot be performed on observations that the user is not authorized to see.  It is assumed that the server has identified and secured the context appropriately, and can either associate the authorization context with a single patient, or determine whether the context has the rights to the nominated patient, if there is one. If there is no nominated patient (e.g. the operation is invoked at the system level) and the context is not associated with a single patient record, then the server should return an error. Specifying the relationship between the context, a user and patient records is outside the scope of this specification.&quot;,
        &quot;resource&quot;: [
          &quot;Observation&quot;
        ],
        &quot;system&quot;: false,
        &quot;type&quot;: true,
        &quot;instance&quot;: false,
        &quot;parameter&quot;: [
          {
            &quot;name&quot;: &quot;max&quot;,
            &quot;use&quot;: &quot;in&quot;,
            &quot;min&quot;: 0,
            &quot;max&quot;: &quot;1&quot;,
            &quot;documentation&quot;: &quot;`max` is  an optional input parameter to the *lastn* query operation.  It is used to specify the maximum number of Observations to return from each group. For example for the query \&quot;Fetch the last 3 results for all vitals for a patient\&quot; `max` = 3.&quot;,
            &quot;type&quot;: &quot;positiveInt&quot;
          },
          {
            &quot;name&quot;: &quot;return&quot;,
            &quot;use&quot;: &quot;out&quot;,
            &quot;min&quot;: 1,
            &quot;max&quot;: &quot;1&quot;,
            &quot;documentation&quot;: &quot;The set of most recent N Observations that match the *lastn* query search criteria.&quot;,
            &quot;type&quot;: &quot;Bundle&quot;
          }
        ]
      },
      &quot;search&quot;: {
        &quot;mode&quot;: &quot;match&quot;
      }
    }
</pre></div>


<p>But whenever i try to use like:<br>
baseUrl/Observation?code=777-3,718-7/$lastn<br>
The observation doesn't get filtered.</p>



<a name="185716751"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/%24lastn%20usage/near/185716751" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenico Corapi <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.24lastn.20usage.html#185716751">(Jan 15 2020 at 16:47)</a>:</h4>
<p>I don't think HAPI supports $lastn (although I know they are working on it). Creating the operation definition won't make it work</p>



<a name="185717363"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/%24lastn%20usage/near/185717363" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> André Luiz <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.24lastn.20usage.html#185717363">(Jan 15 2020 at 16:52)</a>:</h4>
<p>Oh, that's true.<br>
I see that now.<br>
I've been searching their repos to find something related.</p>



<a name="185717734"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/%24lastn%20usage/near/185717734" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenico Corapi <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.24lastn.20usage.html#185717734">(Jan 15 2020 at 16:55)</a>:</h4>
<p>You can obtain a similar result by sending a Bundle with a search sorted by date for each code, although it's a bit inconvenient and may not scale well</p>



<a name="185789181"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/%24lastn%20usage/near/185789181" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.24lastn.20usage.html#185789181">(Jan 16 2020 at 06:22)</a>:</h4>
<p><span class="user-mention" data-user-id="244659">@André Luiz</span>  We will be starting a project to implement $lastn for HAPI FHIR servers in the next week or so, oddly enough.  I expect it will be ready for public testing at some point in March.</p>



<a name="230671103"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/%24lastn%20usage/near/230671103" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vivek TK <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.24lastn.20usage.html#230671103">(Mar 17 2021 at 10:56)</a>:</h4>
<p>I was reading through the $lastn operation specifics on the FHIR page:<br>
<a href="http://hl7.org/fhir/STU3/operation-observation-lastn.html">http://hl7.org/fhir/STU3/operation-observation-lastn.html</a>. There it mentions "The lastn query meets the common need for searching for the most recent or last n=number of observations for a subject". Hence can we assume that always the Observation.subject query parameter will be used along with the $lastn operation? I dont see that mentioned specifically anywhere.  Can $lastn be invoked without a patient context?</p>



<a name="230699405"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/%24lastn%20usage/near/230699405" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.24lastn.20usage.html#230699405">(Mar 17 2021 at 14:30)</a>:</h4>
<p>There's no requirement to filter by subject - though some servers might impose that as a requirement</p>



<a name="230829996"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/%24lastn%20usage/near/230829996" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vivek TK <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.24lastn.20usage.html#230829996">(Mar 18 2021 at 08:50)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="191320">@Lloyd McKenzie</span> . If filter by subject is not always mandatory, the $lastn should consider all the Observations across multiple patients and the "group by code" operation may group the observations from multiple patients for an observation.code. I wasn't sure if that is the real intention of this operation.</p>



<a name="230862314"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/%24lastn%20usage/near/230862314" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.24lastn.20usage.html#230862314">(Mar 18 2021 at 13:27)</a>:</h4>
<p>$lastN is a 'query'.  That means it can be used alongside any of the other search parameters a part of a search.  Essentially you determine the search results based on all of the other search parameters and then you filter to ensure that you only expose the most recent 'n' of each Observation.code.  It's not quite the same as 'group by' because there's no ordering of the returned results implied (though some servers might provide some).</p>



<a name="230875277"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/%24lastn%20usage/near/230875277" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Haas <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.24lastn.20usage.html#230875277">(Mar 18 2021 at 14:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="191320">Lloyd McKenzie</span> <a href="#narrow/stream/179166-implementers/topic/.24lastn.20usage/near/230699405">said</a>:</p>
<blockquote>
<p>There's no requirement to filter by subject - though some servers might impose that as a requirement</p>
</blockquote>
<div class="codehilite"><pre><span></span><code>The request for a lastn query SHALL include:

A $lastn operation parameter
A subject using either the patient or subject search parameter
...
</code></pre></div>



<a name="230875591"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/%24lastn%20usage/near/230875591" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Haas <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.24lastn.20usage.html#230875591">(Mar 18 2021 at 14:47)</a>:</h4>
<p>and the results are ordered temporaly most recent is first</p>



<a name="230911481"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/%24lastn%20usage/near/230911481" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vivek TK <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.24lastn.20usage.html#230911481">(Mar 18 2021 at 18:02)</a>:</h4>
<p>That's interesting <span class="user-mention" data-user-id="191401">@Eric Haas</span> . I think your quote is from R4 documentation where it clearly mentions about the subject search parameter. However the same for STU3 doesn't mention that in such a detailed way.  I assume that could be a documentation gap.</p>



<a name="230911661"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/%24lastn%20usage/near/230911661" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Haas <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.24lastn.20usage.html#230911661">(Mar 18 2021 at 18:03)</a>:</h4>
<p>yes was updated in R4 did not realize you were in STU3</p>



<a name="230911841"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/%24lastn%20usage/near/230911841" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vivek TK <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.24lastn.20usage.html#230911841">(Mar 18 2021 at 18:04)</a>:</h4>
<p>Right, but ideally the behaviour and query constraints should be consistent across FHIR versions. Right?</p>



<a name="230914621"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/%24lastn%20usage/near/230914621" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Haas <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.24lastn.20usage.html#230914621">(Mar 18 2021 at 18:21)</a>:</h4>
<p>only when there a labeled as Normative.  $lastn has an <a href="http://hl7.org/fhir/R4/versions.html#maturity">FMM</a> of 3</p>



<a name="230916276"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/%24lastn%20usage/near/230916276" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vivek TK <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.24lastn.20usage.html#230916276">(Mar 18 2021 at 18:32)</a>:</h4>
<p>Got it.But is it wrong if we enforce the subject query parameter in the implementation while using STU3?I feel that it makes more sense when queried using a patient context rather than being open.</p>



<a name="231307559"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/%24lastn%20usage/near/231307559" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/.24lastn.20usage.html#231307559">(Mar 22 2021 at 13:16)</a>:</h4>
<p>HAPI FHIR has relaxed the R4 definition to allow leaving out the subject parameter, or the code/category parameter.  Leaving both of those out and specifying max=1 and and code:text allows you to find what codes are actually in the FHIR database that match an input string.  The "group by code" feature so far only supports single-coded Observations, though.  (Example:  <a href="https://lforms-fhir.nlm.nih.gov/baseR4/Observation/$lastn?max=1&amp;_elements=code,value,component&amp;code:text=height&amp;_count=500">https://lforms-fhir.nlm.nih.gov/baseR4/Observation/$lastn?max=1&amp;_elements=code,value,component&amp;code:text=height&amp;_count=500</a>)</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
