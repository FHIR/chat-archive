---
layout: page
title: "FHIR Chat  · potentially bad invariant in RatioRange · implementers"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/index.html">implementers</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/potentially.20bad.20invariant.20in.20RatioRange.html">potentially bad invariant in RatioRange</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="264156552"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/potentially%20bad%20invariant%20in%20RatioRange/near/264156552" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/potentially.20bad.20invariant.20in.20RatioRange.html#264156552">(Dec 08 2021 at 13:45)</a>:</h4>
<p>R4B introduces datatype RatioRange with the following invariant:</p>
<div class="codehilite"><pre><span></span><code>One of lowNumerator or highNumerator and denominator SHALL be present, or all are absent. If all are absent, there SHALL be some extension present
</code></pre></div>
<p>Expression:</p>
<div class="codehilite"><pre><span></span><code>((lowNumerator.empty() and highNumerator.empty()) xor denominator.exists()) and (lowNumerator.exists() or extension.exists())
</code></pre></div>
<p>I find both the description and the fhirpath a bit dense, but at the outer layer of the expression its an and with <code>(lowNumerator.exists() or extension.exists())</code></p>
<p>Should the following RatioRange be valid (e.g. in concentration[x] in Ingredient)?</p>
<div class="codehilite"><pre><span></span><code>      &lt;concentrationRatioRange&gt;
        &lt;highNumerator&gt;
          &lt;value value=&quot;1&quot;/&gt;
          &lt;unit value=&quot;L&quot;/&gt;
        &lt;/highNumerator&gt;
        &lt;denominator&gt;
          &lt;value value=&quot;2&quot;/&gt;
          &lt;unit value=&quot;L&quot;/&gt;
        &lt;/denominator&gt;
      &lt;/concentrationRatioRange&gt;
</code></pre></div>
<p>If so, I think the expression is in error.</p>



<a name="264160165"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/potentially%20bad%20invariant%20in%20RatioRange/near/264160165" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/potentially.20bad.20invariant.20in.20RatioRange.html#264160165">(Dec 08 2021 at 14:12)</a>:</h4>
<p>Reading the English and making a guess about where the parentheses belong, I think your example is valid.</p>
<p>I can't read that FHIRpath expression before coffee ;-)</p>



<a name="264160359"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/potentially%20bad%20invariant%20in%20RatioRange/near/264160359" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/potentially.20bad.20invariant.20in.20RatioRange.html#264160359">(Dec 08 2021 at 14:13)</a>:</h4>
<p>I had to make a truth table to convince myself the xor part was right (but i think it is)<br>
<a href="/user_uploads/10155/ys1bO5w8lyLLlGUF7-_7utkJ/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/10155/ys1bO5w8lyLLlGUF7-_7utkJ/image.png" title="image.png"><img src="/user_uploads/10155/ys1bO5w8lyLLlGUF7-_7utkJ/image.png"></a></div>



<a name="264160457"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/potentially%20bad%20invariant%20in%20RatioRange/near/264160457" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/potentially.20bad.20invariant.20in.20RatioRange.html#264160457">(Dec 08 2021 at 14:14)</a>:</h4>
<p>but maybe we should strive for more readable expressions...</p>



<a name="264160654"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/potentially%20bad%20invariant%20in%20RatioRange/near/264160654" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/potentially.20bad.20invariant.20in.20RatioRange.html#264160654">(Dec 08 2021 at 14:16)</a>:</h4>
<p>I think its the mix of <code>.empty()</code> and <code>.exists()</code> with various boolean operations in the same expression that made it hard for my feable mind</p>



<a name="264202659"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/potentially%20bad%20invariant%20in%20RatioRange/near/264202659" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/potentially.20bad.20invariant.20in.20RatioRange.html#264202659">(Dec 08 2021 at 18:55)</a>:</h4>
<p>totally agree about that. <span class="user-mention" data-user-id="191651">@Rik Smithies</span> can we write a more natural expression that doesn't use xor? (looks like it was translated from xpath to me)</p>



<a name="264215016"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/potentially%20bad%20invariant%20in%20RatioRange/near/264215016" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rik Smithies <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/potentially.20bad.20invariant.20in.20RatioRange.html#264215016">(Dec 08 2021 at 20:24)</a>:</h4>
<p>It wasn't me that created that, I just copied the whole datatype into R4B from the main build. Possibly <span class="user-mention" data-user-id="192166">@Jean Duteau</span> ?</p>



<a name="264215280"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/potentially%20bad%20invariant%20in%20RatioRange/near/264215280" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/potentially.20bad.20invariant.20in.20RatioRange.html#264215280">(Dec 08 2021 at 20:27)</a>:</h4>
<p>yes it was <span class="user-mention" data-user-id="192166">@Jean Duteau</span></p>



<a name="264225431"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/potentially%20bad%20invariant%20in%20RatioRange/near/264225431" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jean Duteau <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/potentially.20bad.20invariant.20in.20RatioRange.html#264225431">(Dec 08 2021 at 21:47)</a>:</h4>
<p>when this was applied, the invariant was taken from Ratio:<br>
rat-1: (numerator.empty() xor denominator.exists()) and (numerator.exists() or extension.exists())<br>
this became for RatioRange:<br>
inv-1: ((lowNumerator.empty() and highNumerator.empty()) xor denominator.exists()) and (lowNumerator.exists() or extension.exists())</p>



<a name="264227201"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/potentially%20bad%20invariant%20in%20RatioRange/near/264227201" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jean Duteau <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/potentially.20bad.20invariant.20in.20RatioRange.html#264227201">(Dec 08 2021 at 22:01)</a>:</h4>
<p>this does miss the case where high and denominator are present, so the invariant isn't quite right.</p>



<a name="264228429"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/potentially%20bad%20invariant%20in%20RatioRange/near/264228429" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jean Duteau <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/potentially.20bad.20invariant.20in.20RatioRange.html#264228429">(Dec 08 2021 at 22:12)</a>:</h4>
<p>here is the easier invariant:<br>
((low.exists or high.exists) and denom.exists) or (low.empty and high.empty and denom.empty and extension.exists)</p>



<a name="264228750"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/potentially%20bad%20invariant%20in%20RatioRange/near/264228750" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jean Duteau <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/potentially.20bad.20invariant.20in.20RatioRange.html#264228750">(Dec 08 2021 at 22:14)</a>:</h4>
<p>if we want to rewrite the Ratio invariant to not use xor:<br>
(numerator.exists and denominator.exists) or (numerator.empty and denominator.empty and extension.exists)</p>



<a name="264229879"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/potentially%20bad%20invariant%20in%20RatioRange/near/264229879" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/potentially.20bad.20invariant.20in.20RatioRange.html#264229879">(Dec 08 2021 at 22:24)</a>:</h4>
<p>I, for one, find those much more readable</p>



<a name="264518295"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/potentially%20bad%20invariant%20in%20RatioRange/near/264518295" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/potentially.20bad.20invariant.20in.20RatioRange.html#264518295">(Dec 10 2021 at 22:34)</a>:</h4>
<p>Would it be helpful for me to open a JIRA tracker for this one, or is already being worked?</p>



<a name="264540641"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/potentially%20bad%20invariant%20in%20RatioRange/near/264540641" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jean Duteau <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/potentially.20bad.20invariant.20in.20RatioRange.html#264540641">(Dec 11 2021 at 04:29)</a>:</h4>
<p>Open a Jira issue</p>



<a name="264567708"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/potentially%20bad%20invariant%20in%20RatioRange/near/264567708" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/potentially.20bad.20invariant.20in.20RatioRange.html#264567708">(Dec 11 2021 at 15:19)</a>:</h4>
<p><a href="http://jira.hl7.org/browse/FHIR-34454">FHIR#34454</a></p>



<a name="264812317"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179166-implementers/topic/potentially%20bad%20invariant%20in%20RatioRange/near/264812317" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179166-implementers/topic/potentially.20bad.20invariant.20in.20RatioRange.html#264812317">(Dec 14 2021 at 05:02)</a>:</h4>
<p>I pre-applied these in R4B</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
