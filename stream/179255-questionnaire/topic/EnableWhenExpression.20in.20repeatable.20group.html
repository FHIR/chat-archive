---
layout: page
title: "FHIR Chat  · EnableWhenExpression in repeatable group · questionnaire"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179255-questionnaire/index.html">questionnaire</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179255-questionnaire/topic/EnableWhenExpression.20in.20repeatable.20group.html">EnableWhenExpression in repeatable group</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="247447621"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179255-questionnaire/topic/EnableWhenExpression%20in%20repeatable%20group/near/247447621" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ilya Beda <a href="https://fhir.github.io/chat-archive/stream/179255-questionnaire/topic/EnableWhenExpression.20in.20repeatable.20group.html#247447621">(Jul 28 2021 at 11:36)</a>:</h4>
<p>Hello!<br>
I hope you are doing well. I faced some issues when I try to define some conditional logic on repeatable group children.</p>
<p>I want to define some conditional expressions for an element of a repeatable group.<br>
If there is an answer for the first, I would like to show the second question</p>
<p>I am using YAML and first-class extension notation to make the Questionnaire resource more readable.</p>
<div class="codehilite" data-code-language="YAML"><pre><span></span><code><span class="nt">resourceType</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Questionnaire</span>
<span class="nt">item</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">group</span>
  <span class="nt">linkId</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-group</span>
  <span class="nt">repeats</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">item</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">text</span>
    <span class="nt">linkId</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">first</span>
  <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">text</span>
    <span class="nt">linkId</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">second</span>
    <span class="nt">enableWhenExpression</span><span class="p">:</span> <span class="s">'%parent.item.where(linkId='</span><span class="l l-Scalar l-Scalar-Plain">first').count()&gt;0'</span>
</code></pre></div>
<p>I am confused about how can I define parent in this case.</p>
<p>The best I did is</p>
<div class="codehilite" data-code-language="YAML"><pre><span></span><code><span class="nt">resourceType</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Questionnaire</span>
<span class="nt">item</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">group</span>
  <span class="nt">linkId</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-group</span>
  <span class="nt">repeats</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">variable</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">parent</span>
    <span class="nt">expression</span><span class="p">:</span> <span class="s">'%context'</span>
  <span class="nt">item</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">text</span>
    <span class="nt">linkId</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">first</span>
  <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">text</span>
    <span class="nt">linkId</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">second</span>
    <span class="nt">enableWhenExpression</span><span class="p">:</span> <span class="s">'%parent.answer.item.where(linkId='</span><span class="l l-Scalar l-Scalar-Plain">first').count()&gt;0'</span>
</code></pre></div>
<p>Unfortunately, this doesn't work obviously. I got all answers to <code>my-group</code>, but I need only a current one.</p>
<p>How can I define <code>%parent</code> to achieve desired behavior?</p>



<a name="247459866"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179255-questionnaire/topic/EnableWhenExpression%20in%20repeatable%20group/near/247459866" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179255-questionnaire/topic/EnableWhenExpression.20in.20repeatable.20group.html#247459866">(Jul 28 2021 at 13:39)</a>:</h4>
<p>You shouldn't need to use enableWhenExpression at all there.  You'd just have enableWhen.question=first, operator=exists, answerBoolean=true</p>



<a name="247470441"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179255-questionnaire/topic/EnableWhenExpression%20in%20repeatable%20group/near/247470441" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179255-questionnaire/topic/EnableWhenExpression.20in.20repeatable.20group.html#247470441">(Jul 28 2021 at 14:58)</a>:</h4>
<p>Also, what is %parent?  I don't think there is such a thing, unless you create a variable named that.  Speaking of which, if you do define a variable on the group, you can capture the value of item "first", and each repetition of the group will have its own copy of the variable.</p>



<a name="247477433"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179255-questionnaire/topic/EnableWhenExpression%20in%20repeatable%20group/near/247477433" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ilya Beda <a href="https://fhir.github.io/chat-archive/stream/179255-questionnaire/topic/EnableWhenExpression.20in.20repeatable.20group.html#247477433">(Jul 28 2021 at 15:53)</a>:</h4>
<p>It is my question - what should I use for <code>%parent</code> to work exactly as I described.<br>
<span class="user-mention" data-user-id="191320">@Lloyd McKenzie</span> You are right, in this particular case, I can use <code>enableWhen</code> instead of <code>enableWhenExpression</code>.<br>
However, I provided a very simplified version of the Questionnaire.<br>
In the real-life case, I can't use <code>enableWhen</code>, I need <code>enableWhenExpression</code>.</p>



<a name="247478377"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179255-questionnaire/topic/EnableWhenExpression%20in%20repeatable%20group/near/247478377" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179255-questionnaire/topic/EnableWhenExpression.20in.20repeatable.20group.html#247478377">(Jul 28 2021 at 16:00)</a>:</h4>
<p>So, I don't think you want %parent, but define a %first on the group, as "item.where(linkId='first')"</p>



<a name="247507719"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179255-questionnaire/topic/EnableWhenExpression%20in%20repeatable%20group/near/247507719" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179255-questionnaire/topic/EnableWhenExpression.20in.20repeatable.20group.html#247507719">(Jul 28 2021 at 19:43)</a>:</h4>
<p><span class="user-mention" data-user-id="196255">@Ilya Beda</span> I am sorry I misunderstood what you were asking about %parent.  I played with your test Questionnaire in LHC-Forms, and there I needed to change enableWhenExpression to calculatedExpression, because we don't support enableWhenExpression yet.  However, I have a sample form to work that shows a count of either 0 or 1 for  each repetition of the group,  depending on whether the first question in each repetition is filled in.  You can use the "Load From File" button at <a href="https://lhcforms.nlm.nih.gov/lhcforms">https://lhcforms.nlm.nih.gov/lhcforms</a> to try the Questionnaire below.  Each repitition of the group gets its own group variable.  I would not recommend putting %context into a variable on the group, because that causes an endless loop, because the %context includes the child question answers, and the child question answers depend on that variable.</p>
<div class="codehilite"><pre><span></span><code>{
  &quot;resourceType&quot;: &quot;Questionnaire&quot;,
  &quot;item&quot;: [
    {
      &quot;type&quot;: &quot;group&quot;,
      &quot;linkId&quot;: &quot;my-group&quot;,
      &quot;text&quot;: &quot;some group&quot;,
      &quot;repeats&quot;: true,
      &quot;extension&quot;: [
        {
          &quot;url&quot;: &quot;http://hl7.org/fhir/StructureDefinition/variable&quot;,
          &quot;valueExpression&quot;: {
            &quot;name&quot;: &quot;count&quot;,
            &quot;language&quot;: &quot;text/fhirpath&quot;,
            &quot;expression&quot;: &quot;item.where(linkId=&#39;first&#39;).count()&quot;
          }
        }
      ],
      &quot;item&quot;: [
        {
          &quot;type&quot;: &quot;text&quot;,
          &quot;linkId&quot;: &quot;first&quot;
        },
        {
          &quot;type&quot;: &quot;string&quot;,
          &quot;linkId&quot;: &quot;second&quot;,
          &quot;readonly&quot;: true,
          &quot;extension&quot;: [
            {
              &quot;url&quot;: &quot;http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-calculatedExpression&quot;,
              &quot;valueExpression&quot;: {
                &quot;language&quot;: &quot;text/fhirpath&quot;,
                &quot;expression&quot;: &quot;%count&quot;
              }
            }
          ]
        }
      ]
    }
  ]
}
</code></pre></div>



<a name="247564218"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179255-questionnaire/topic/EnableWhenExpression%20in%20repeatable%20group/near/247564218" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ilya Beda <a href="https://fhir.github.io/chat-archive/stream/179255-questionnaire/topic/EnableWhenExpression.20in.20repeatable.20group.html#247564218">(Jul 29 2021 at 10:04)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="195344">@Paul Lynch</span> <br>
Thank you for sharing your example.<br>
I have a question about QuestionnaireResponse produced by LHC-Forms.</p>
<p>It uses duplicated items with the same linkId if the type of "my-group" is a group.</p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code><span class="p">{</span>
  <span class="nt">"resourceType"</span><span class="p">:</span> <span class="s2">"QuestionnaireResponse"</span><span class="p">,</span>
  <span class="nt">"meta"</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">"profile"</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaireresponse|2.7"</span>
    <span class="p">],</span>
    <span class="nt">"tag"</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nt">"code"</span><span class="p">:</span> <span class="s2">"lformsVersion: 29.0.3"</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="nt">"status"</span><span class="p">:</span> <span class="s2">"completed"</span><span class="p">,</span>
  <span class="nt">"authored"</span><span class="p">:</span> <span class="s2">"2021-07-29T09:59:46.758Z"</span><span class="p">,</span>
  <span class="nt">"item"</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">"linkId"</span><span class="p">:</span> <span class="s2">"my-group"</span><span class="p">,</span>
      <span class="nt">"text"</span><span class="p">:</span> <span class="s2">"some group"</span><span class="p">,</span>
      <span class="nt">"item"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nt">"linkId"</span><span class="p">:</span> <span class="s2">"first"</span><span class="p">,</span>
          <span class="nt">"answer"</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="nt">"valueString"</span><span class="p">:</span> <span class="s2">"43"</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="nt">"linkId"</span><span class="p">:</span> <span class="s2">"second"</span><span class="p">,</span>
          <span class="nt">"answer"</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="nt">"valueString"</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">"linkId"</span><span class="p">:</span> <span class="s2">"my-group"</span><span class="p">,</span>
      <span class="nt">"text"</span><span class="p">:</span> <span class="s2">"some group"</span><span class="p">,</span>
      <span class="nt">"item"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nt">"linkId"</span><span class="p">:</span> <span class="s2">"second"</span><span class="p">,</span>
          <span class="nt">"answer"</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="nt">"valueString"</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">"linkId"</span><span class="p">:</span> <span class="s2">"my-group"</span><span class="p">,</span>
      <span class="nt">"text"</span><span class="p">:</span> <span class="s2">"some group"</span><span class="p">,</span>
      <span class="nt">"item"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nt">"linkId"</span><span class="p">:</span> <span class="s2">"first"</span><span class="p">,</span>
          <span class="nt">"answer"</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="nt">"valueString"</span><span class="p">:</span> <span class="s2">"434"</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="nt">"linkId"</span><span class="p">:</span> <span class="s2">"second"</span><span class="p">,</span>
          <span class="nt">"answer"</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="nt">"valueString"</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<p>However, If I change type of the "my-group" to text it uses one item with multiple answers.<br>
 Also  the calculatedExpression stops to work.</p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code><span class="p">{</span>
  <span class="nt">"resourceType"</span><span class="p">:</span> <span class="s2">"QuestionnaireResponse"</span><span class="p">,</span>
  <span class="nt">"meta"</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">"profile"</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaireresponse|2.7"</span>
    <span class="p">],</span>
    <span class="nt">"tag"</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nt">"code"</span><span class="p">:</span> <span class="s2">"lformsVersion: 29.0.3"</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="nt">"status"</span><span class="p">:</span> <span class="s2">"completed"</span><span class="p">,</span>
  <span class="nt">"authored"</span><span class="p">:</span> <span class="s2">"2021-07-29T09:58:02.083Z"</span><span class="p">,</span>
  <span class="nt">"item"</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">"linkId"</span><span class="p">:</span> <span class="s2">"my-group"</span><span class="p">,</span>
      <span class="nt">"text"</span><span class="p">:</span> <span class="s2">"some group"</span><span class="p">,</span>
      <span class="nt">"answer"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nt">"valueString"</span><span class="p">:</span> <span class="s2">"other"</span><span class="p">,</span>
          <span class="nt">"item"</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="nt">"linkId"</span><span class="p">:</span> <span class="s2">"first"</span><span class="p">,</span>
              <span class="nt">"answer"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="nt">"valueString"</span><span class="p">:</span> <span class="s2">"qwer"</span>
                <span class="p">}</span>
              <span class="p">]</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="nt">"linkId"</span><span class="p">:</span> <span class="s2">"second"</span><span class="p">,</span>
              <span class="nt">"answer"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="nt">"valueString"</span><span class="p">:</span> <span class="mi">0</span>
                <span class="p">}</span>
              <span class="p">]</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="nt">"valueString"</span><span class="p">:</span> <span class="s2">"qqq"</span><span class="p">,</span>
          <span class="nt">"item"</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="nt">"linkId"</span><span class="p">:</span> <span class="s2">"first"</span><span class="p">,</span>
              <span class="nt">"answer"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="nt">"valueString"</span><span class="p">:</span> <span class="s2">"qqq"</span>
                <span class="p">}</span>
              <span class="p">]</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="nt">"linkId"</span><span class="p">:</span> <span class="s2">"second"</span><span class="p">,</span>
              <span class="nt">"answer"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="nt">"valueString"</span><span class="p">:</span> <span class="mi">0</span>
                <span class="p">}</span>
              <span class="p">]</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<p>It looks inconsistent.<br>
From my opinion the second form looks better to me because it doesn't duplicates items wiht the same linkId.</p>



<a name="247580539"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179255-questionnaire/topic/EnableWhenExpression%20in%20repeatable%20group/near/247580539" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Manning <a href="https://fhir.github.io/chat-archive/stream/179255-questionnaire/topic/EnableWhenExpression.20in.20repeatable.20group.html#247580539">(Jul 29 2021 at 13:08)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="196255">@Ilya Beda</span>, how are you converting your Questionnaire resources to/from JSON/YAML? <span class="user-mention" data-user-id="235060">@Grey Faulkenberry</span> created a package for this a while back using Dart, available <a href="https://pub.dev/packages/fhir_yaml">here</a></p>



<a name="247586291"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179255-questionnaire/topic/EnableWhenExpression%20in%20repeatable%20group/near/247586291" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179255-questionnaire/topic/EnableWhenExpression.20in.20repeatable.20group.html#247586291">(Jul 29 2021 at 13:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="196255">Ilya Beda</span> <a href="#narrow/stream/179255-questionnaire/topic/EnableWhenExpression.20in.20repeatable.20group/near/247564218">said</a>:</p>
<blockquote>
<p>It looks inconsistent.</p>
</blockquote>
<p>I agree, but I think that is the way a QuestionnaireResponse is supposed to be.  Answers to child items of a question go under item.answer.item.answer, while answers to child items of a group go under item.item.answer.</p>



<a name="247590204"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179255-questionnaire/topic/EnableWhenExpression%20in%20repeatable%20group/near/247590204" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ilya Beda <a href="https://fhir.github.io/chat-archive/stream/179255-questionnaire/topic/EnableWhenExpression.20in.20repeatable.20group.html#247590204">(Jul 29 2021 at 14:25)</a>:</h4>
<p><span class="user-mention" data-user-id="364926">@John Manning</span> I am using aidbox as FHIR server, it provides such a feature</p>



<a name="247590659"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179255-questionnaire/topic/EnableWhenExpression%20in%20repeatable%20group/near/247590659" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ilya Beda <a href="https://fhir.github.io/chat-archive/stream/179255-questionnaire/topic/EnableWhenExpression.20in.20repeatable.20group.html#247590659">(Jul 29 2021 at 14:28)</a>:</h4>
<p><span class="user-mention" data-user-id="195344">@Paul Lynch</span> does it mention somewhere in the spec? </p>
<p>Duplication of item with same id confuses a lot. </p>
<p>I am using item.item.answer when <code>repeats: false</code></p>



<a name="247591979"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179255-questionnaire/topic/EnableWhenExpression%20in%20repeatable%20group/near/247591979" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179255-questionnaire/topic/EnableWhenExpression.20in.20repeatable.20group.html#247591979">(Jul 29 2021 at 14:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="196255">Ilya Beda</span> <a href="#narrow/stream/179255-questionnaire/topic/EnableWhenExpression.20in.20repeatable.20group/near/247590659">said</a>:</p>
<blockquote>
<p>I am using item.item.answer when <code>repeats: false</code></p>
</blockquote>
<p>I don't think that is correct unless the containing item is a group.  If both are questions, <a href="https://www.hl7.org/fhir/questionnaireresponse-definitions.html#QuestionnaireResponse.item">https://www.hl7.org/fhir/questionnaireresponse-definitions.html#QuestionnaireResponse.item</a> says:  "When dealing with questions, nesting must occur within each answer because some questions may have multiple answers (and the nesting occurs for each answer)."</p>
<p>For when the containing item is a group, I don't see how you can avoid repeating the group and its linkId for each repetition of the group.  But, the specification could be more clear on that point.  You might want to submit a change request.</p>



<a name="247609528"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179255-questionnaire/topic/EnableWhenExpression%20in%20repeatable%20group/near/247609528" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179255-questionnaire/topic/EnableWhenExpression.20in.20repeatable.20group.html#247609528">(Jul 29 2021 at 16:48)</a>:</h4>
<p>If you're nesting a question within a question, the child <em>must</em> be nested under answer.  repeats has no bearing on how nesting works.  We've approved a change to make this rule more explicit.</p>



<a name="247680461"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179255-questionnaire/topic/EnableWhenExpression%20in%20repeatable%20group/near/247680461" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Laletin <a href="https://fhir.github.io/chat-archive/stream/179255-questionnaire/topic/EnableWhenExpression.20in.20repeatable.20group.html#247680461">(Jul 30 2021 at 08:05)</a>:</h4>
<p>What about %context value in repeatable questions with subquestions? I was trying to re-write the example from <span class="user-mention" data-user-id="195344">@Paul Lynch</span>. Here I need to calculate <code>second-question</code> that depends on <code>first-question</code>.</p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code><span class="p">{</span>
  <span class="nt">"resourceType"</span><span class="p">:</span> <span class="s2">"Questionnaire"</span><span class="p">,</span>
  <span class="nt">"item"</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">"type"</span><span class="p">:</span> <span class="s2">"text"</span><span class="p">,</span>
      <span class="nt">"linkId"</span><span class="p">:</span> <span class="s2">"top-question"</span><span class="p">,</span>
      <span class="nt">"text"</span><span class="p">:</span> <span class="s2">"top question"</span><span class="p">,</span>
      <span class="nt">"repeats"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nt">"extension"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nt">"url"</span><span class="p">:</span> <span class="s2">"http://hl7.org/fhir/StructureDefinition/variable"</span><span class="p">,</span>
          <span class="nt">"valueExpression"</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"count"</span><span class="p">,</span>
            <span class="nt">"language"</span><span class="p">:</span> <span class="s2">"text/fhirpath"</span><span class="p">,</span>
            <span class="nt">"expression"</span><span class="p">:</span> <span class="s2">"item.where(linkId='first-subquestion').count()"</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">"item"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nt">"type"</span><span class="p">:</span> <span class="s2">"text"</span><span class="p">,</span>
          <span class="nt">"text"</span><span class="p">:</span> <span class="s2">"First subquestion"</span><span class="p">,</span>
          <span class="nt">"linkId"</span><span class="p">:</span> <span class="s2">"first-subquestion"</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="nt">"type"</span><span class="p">:</span> <span class="s2">"string"</span><span class="p">,</span>
          <span class="nt">"linkId"</span><span class="p">:</span> <span class="s2">"second-subquestion"</span><span class="p">,</span>
          <span class="nt">"text"</span><span class="p">:</span> <span class="s2">"Second subquestion"</span><span class="p">,</span>
          <span class="nt">"readonly"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nt">"extension"</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="nt">"url"</span><span class="p">:</span> <span class="s2">"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-calculatedExpression"</span><span class="p">,</span>
              <span class="nt">"valueExpression"</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">"language"</span><span class="p">:</span> <span class="s2">"text/fhirpath"</span><span class="p">,</span>
                <span class="nt">"expression"</span><span class="p">:</span> <span class="s2">"%count"</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<p>Are there any ideas what should be placed into %context in my example?<br>
I assume it must be answer[i] for each answer for 'top-question' . But according to the spec, %context shall refer to QuestionnaireResponse.item (<a href="https://build.fhir.org/ig/HL7/sdc/expressions.html#fhirpath-and-questionnaire">https://build.fhir.org/ig/HL7/sdc/expressions.html#fhirpath-and-questionnaire</a>)</p>



<a name="247689884"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179255-questionnaire/topic/EnableWhenExpression%20in%20repeatable%20group/near/247689884" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Laletin <a href="https://fhir.github.io/chat-archive/stream/179255-questionnaire/topic/EnableWhenExpression.20in.20repeatable.20group.html#247689884">(Jul 30 2021 at 10:15)</a>:</h4>
<p>Possible solution - connected subquestions can be wrapped into a group under top-question. What do you think?</p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code><span class="p">{</span>
    <span class="nt">"resourceType"</span><span class="p">:</span> <span class="s2">"Questionnaire"</span><span class="p">,</span>
    <span class="nt">"item"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">"type"</span><span class="p">:</span> <span class="s2">"text"</span><span class="p">,</span>
            <span class="nt">"linkId"</span><span class="p">:</span> <span class="s2">"top-question"</span><span class="p">,</span>
            <span class="nt">"text"</span><span class="p">:</span> <span class="s2">"top question"</span><span class="p">,</span>
            <span class="nt">"repeats"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nt">"item"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="nt">"type"</span><span class="p">:</span> <span class="s2">"group"</span><span class="p">,</span>
                    <span class="nt">"text"</span><span class="p">:</span> <span class="s2">"group"</span><span class="p">,</span>
                    <span class="nt">"extension"</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="nt">"url"</span><span class="p">:</span> <span class="s2">"http://hl7.org/fhir/StructureDefinition/variable"</span><span class="p">,</span>
                            <span class="nt">"valueExpression"</span><span class="p">:</span> <span class="p">{</span>
                                <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"count"</span><span class="p">,</span>
                                <span class="nt">"language"</span><span class="p">:</span> <span class="s2">"text/fhirpath"</span><span class="p">,</span>
                                <span class="nt">"expression"</span><span class="p">:</span> <span class="s2">"item.where(linkId='first-subquestion').count()"</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">],</span>
                    <span class="nt">"item"</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="nt">"type"</span><span class="p">:</span> <span class="s2">"text"</span><span class="p">,</span>
                            <span class="nt">"text"</span><span class="p">:</span> <span class="s2">"First subquestion"</span><span class="p">,</span>
                            <span class="nt">"linkId"</span><span class="p">:</span> <span class="s2">"first-subquestion"</span>
                        <span class="p">},</span>
                        <span class="p">{</span>
                            <span class="nt">"type"</span><span class="p">:</span> <span class="s2">"string"</span><span class="p">,</span>
                            <span class="nt">"linkId"</span><span class="p">:</span> <span class="s2">"second-subquestion"</span><span class="p">,</span>
                            <span class="nt">"text"</span><span class="p">:</span> <span class="s2">"Second subquestion"</span><span class="p">,</span>
                            <span class="nt">"readonly"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
                            <span class="nt">"extension"</span><span class="p">:</span> <span class="p">[</span>
                                <span class="p">{</span>
                                    <span class="nt">"url"</span><span class="p">:</span> <span class="s2">"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-calculatedExpression"</span><span class="p">,</span>
                                    <span class="nt">"valueExpression"</span><span class="p">:</span> <span class="p">{</span>
                                        <span class="nt">"language"</span><span class="p">:</span> <span class="s2">"text/fhirpath"</span><span class="p">,</span>
                                        <span class="nt">"expression"</span><span class="p">:</span> <span class="s2">"%count"</span>
                                    <span class="p">}</span>
                                <span class="p">}</span>
                            <span class="p">]</span>
                        <span class="p">}</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>



<a name="247710626"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179255-questionnaire/topic/EnableWhenExpression%20in%20repeatable%20group/near/247710626" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179255-questionnaire/topic/EnableWhenExpression.20in.20repeatable.20group.html#247710626">(Jul 30 2021 at 13:52)</a>:</h4>
<p>I think in <br>
<span class="user-mention silent" data-user-id="421492">Vadim Laletin</span> <a href="#narrow/stream/179255-questionnaire/topic/EnableWhenExpression.20in.20repeatable.20group/near/247680461">said</a>:</p>
<blockquote>
<p>What about %context value in repeatable questions with subquestions?<br>
Are there any ideas what should be placed into %context in my example?<br>
I assume it must be answer[i] for each answer for 'top-question' . But according to the spec, %context shall refer to QuestionnaireResponse.item (<a href="https://build.fhir.org/ig/HL7/sdc/expressions.html#fhirpath-and-questionnaire">https://build.fhir.org/ig/HL7/sdc/expressions.html#fhirpath-and-questionnaire</a>)</p>
</blockquote>
<p>For items, %context is always the QuestionnaireResponse item.  Is there a problem with that?</p>



<a name="247714581"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179255-questionnaire/topic/EnableWhenExpression%20in%20repeatable%20group/near/247714581" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Laletin <a href="https://fhir.github.io/chat-archive/stream/179255-questionnaire/topic/EnableWhenExpression.20in.20repeatable.20group.html#247714581">(Jul 30 2021 at 14:22)</a>:</h4>
<p><span class="user-mention" data-user-id="195344">@Paul Lynch</span> In that case how it is possible to use first-question in caculatedExpression of the second-question for every top-question’s answer. %context will be set to QuestionnaireResponse.item that contains:</p>
<div class="codehilite"><pre><span></span><code>{
    ”linkId”: ”top-question”,
     ”answer”: […answer1, answer2, ….]
}
</code></pre></div>
<p>Where answer1 and  answer2 are represented as:</p>
<div class="codehilite"><pre><span></span><code>{
    ”value”: {…},
     ”item”: [
        {
            ”linkId”: ”first-question”,
            ”answer”: {…}
        },
        {
            ”linkId”: ”second-question”,
            ”answer”: {…}       // THIS answer should be calculated from first-question for every top-question.answer[i]
        }
    ]
}
</code></pre></div>



<a name="247721110"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179255-questionnaire/topic/EnableWhenExpression%20in%20repeatable%20group/near/247721110" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179255-questionnaire/topic/EnableWhenExpression.20in.20repeatable.20group.html#247721110">(Jul 30 2021 at 15:12)</a>:</h4>
<p>I see.  The problem is that the variable in the top-question group sees all of the answers for all of the repetitions, because the repetitions are under item.answer.item, and the top-question variable FHIRPath does not know which index is of interest (even if a separate copy of the variable could be created for each repetition).  I think your work around of nesting the sub-questions inside a sub-group and putting the variable on the sub-group is the only way to make that work.  Here is a complete form, without that workaround that demonstrates the issue in LHC-Forms (and can tried at <a href="https://lhcforms.nlm.nih.gov/lhcforms">https://lhcforms.nlm.nih.gov/lhcforms</a>):</p>
<div class="codehilite"><pre><span></span><code>{
  &quot;status&quot;: &quot;draft&quot;,
  &quot;resourceType&quot;: &quot;Questionnaire&quot;,
  &quot;meta&quot;: {
    &quot;profile&quot;: [
      &quot;http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire|2.7&quot;
    ],
    &quot;tag&quot;: [
      {
        &quot;code&quot;: &quot;lformsVersion: 29.1.2&quot;
      }
    ]
  },
  &quot;item&quot;: [
    {
      &quot;type&quot;: &quot;string&quot;,
      &quot;required&quot;: false,
      &quot;repeats&quot;: true,
      &quot;linkId&quot;: &quot;topq&quot;,
      &quot;text&quot;: &quot;topq&quot;,
      &quot;extension&quot;: [
        {
          &quot;url&quot;: &quot;http://hl7.org/fhir/StructureDefinition/variable&quot;,
          &quot;valueExpression&quot;: {
            &quot;name&quot;: &quot;count&quot;,
            &quot;language&quot;: &quot;text/fhirpath&quot;,
            &quot;expression&quot;: &quot;answer.item.where(linkId=&#39;name&#39;).answer.count()&quot;
          }
        }
      ],
      &quot;item&quot;: [
        {
          &quot;type&quot;: &quot;string&quot;,
          &quot;required&quot;: false,
          &quot;repeats&quot;: true,
          &quot;linkId&quot;: &quot;name&quot;,
          &quot;text&quot;: &quot;name&quot;
        },
        {
          &quot;type&quot;: &quot;string&quot;,
          &quot;required&quot;: false,
          &quot;repeats&quot;: true,
          &quot;linkId&quot;: &quot;count of names&quot;,
          &quot;text&quot;: &quot;count of names&quot;,
          &quot;extension&quot;: [
            {
              &quot;url&quot;: &quot;http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-calculatedExpression&quot;,
              &quot;valueExpression&quot;: {
                &quot;language&quot;: &quot;text/fhirpath&quot;,
                &quot;expression&quot;: &quot;%count&quot;
              }
            }
          ]
        }
      ]
    }
  ]
}
</code></pre></div>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
