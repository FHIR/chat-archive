---
layout: page
title: "FHIR Chat  · Tx server issues · pascal"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179281-pascal/index.html">pascal</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179281-pascal/topic/Tx.20server.20issues.html">Tx server issues</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="245877208"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179281-pascal/topic/Tx%20server%20issues/near/245877208" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jose Costa Teixeira <a href="https://fhir.github.io/chat-archive/stream/179281-pascal/topic/Tx.20server.20issues.html#245877208">(Jul 13 2021 at 19:45)</a>:</h4>
<p>Looking at the code and trying to find what could be reasons for eventual leaks, I found a few things that could be worth looking at, but I need another pair of eyes to look at these:</p>



<a name="245877420"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179281-pascal/topic/Tx%20server%20issues/near/245877420" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jose Costa Teixeira <a href="https://fhir.github.io/chat-archive/stream/179281-pascal/topic/Tx.20server.20issues.html#245877420">(Jul 13 2021 at 19:47)</a>:</h4>
<ol>
<li>I see quite some lines like SomeObj.doSomething( var1, var2, TSomeOtherObject.create(var3)).<br>
I think this causes the SomeOtherObject to be created but I was not sure whether they will get properly disposed of.<br>
Example: </li>
</ol>
<div class="codehilite" data-code-language="Delphi"><pre><span></span><code><span class="n">FOthers</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ics</span><span class="o">.</span><span class="n">systemUri</span><span class="o">,</span> <span class="n">TFhirCodeSystemProvider</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">ffactory</span><span class="o">.</span><span class="n">link</span><span class="o">,</span> <span class="n">TFHIRCodeSystemEntry</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">FFactory</span><span class="o">.</span><span class="n">wrapCodeSystem</span><span class="p">(</span><span class="n">FValueSet</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">Link</span><span class="p">))))</span><span class="o">;</span>
</code></pre></div>



<a name="245877863"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179281-pascal/topic/Tx%20server%20issues/near/245877863" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jose Costa Teixeira <a href="https://fhir.github.io/chat-archive/stream/179281-pascal/topic/Tx.20server.20issues.html#245877863">(Jul 13 2021 at 19:51)</a>:</h4>
<p>A very common case of this happens with HTTPLanguages, lines like  this:</p>
<div class="codehilite" data-code-language="Delphi"><pre><span></span><code><span class="n">cs</span><span class="o">.</span><span class="n">displays</span><span class="p">(</span><span class="n">code</span><span class="o">,</span> <span class="n">displays</span><span class="o">,</span> <span class="n">THTTPLanguages</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="s">'en'</span><span class="p">))</span><span class="o">;</span>
</code></pre></div>



<a name="245877924"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179281-pascal/topic/Tx%20server%20issues/near/245877924" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jose Costa Teixeira <a href="https://fhir.github.io/chat-archive/stream/179281-pascal/topic/Tx.20server.20issues.html#245877924">(Jul 13 2021 at 19:51)</a>:</h4>
<p>(this happens many times)</p>



<a name="245878247"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179281-pascal/topic/Tx%20server%20issues/near/245878247" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jose Costa Teixeira <a href="https://fhir.github.io/chat-archive/stream/179281-pascal/topic/Tx.20server.20issues.html#245878247">(Jul 13 2021 at 19:54)</a>:</h4>
<ol start="2">
<li>Another thing I noticed is that sometimes the object that is a result of a function is created and it is not destroyed in the function (so it needs to be destroyed elsewhere). </li>
</ol>
<div class="codehilite" data-code-language="Delphi"><pre><span></span><code><span class="bp">result</span> <span class="o">:=</span> <span class="n">TResourceWithReference</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">id</span><span class="o">,</span> <span class="n">parser</span><span class="o">.</span><span class="n">parseResource</span><span class="p">(</span><span class="n">s</span><span class="p">))</span><span class="o">;</span>
</code></pre></div>
<p>Sometimes we  do see some functions that do a </p>
<div class="codehilite" data-code-language="Delphi"><pre><span></span><code><span class="k">try</span>
   <span class="bp">result</span> <span class="o">=</span> <span class="n">TSomeObject</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">whatever</span><span class="p">)</span>
<span class="k">finally</span>
   <span class="bp">result</span><span class="o">.</span><span class="n">free</span>
</code></pre></div>
<p>I do not know if this explicit destroy is needed</p>



<a name="245878709"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179281-pascal/topic/Tx%20server%20issues/near/245878709" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jose Costa Teixeira <a href="https://fhir.github.io/chat-archive/stream/179281-pascal/topic/Tx.20server.20issues.html#245878709">(Jul 13 2021 at 19:58)</a>:</h4>
<p>These being very common findings, I don't know if any of these is causing a leak, but we could start looking at it. However, we cannot isolate one by one, nor I know if they should even be fixed.<br>
One way to move forward would be to try and detect what kind of requests cause memory footprint to grow.</p>



<a name="245878818"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179281-pascal/topic/Tx%20server%20issues/near/245878818" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jose Costa Teixeira <a href="https://fhir.github.io/chat-archive/stream/179281-pascal/topic/Tx.20server.20issues.html#245878818">(Jul 13 2021 at 19:59)</a>:</h4>
<p>And to do this, we can just throw 1000s of requests to the server until we find one request that causes a leak. We do it one at a time</p>



<a name="245878931"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179281-pascal/topic/Tx%20server%20issues/near/245878931" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jose Costa Teixeira <a href="https://fhir.github.io/chat-archive/stream/179281-pascal/topic/Tx.20server.20issues.html#245878931">(Jul 13 2021 at 20:00)</a>:</h4>
<p>I don't know what are the types of requests that we see on the server, but I guess we have some GETs and mostly operations?</p>



<a name="245879114"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179281-pascal/topic/Tx%20server%20issues/near/245879114" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jose Costa Teixeira <a href="https://fhir.github.io/chat-archive/stream/179281-pascal/topic/Tx.20server.20issues.html#245879114">(Jul 13 2021 at 20:01)</a>:</h4>
<p>we could select a few of those, but we should do it on a replica of the server, which actually contains the necessary content to work (at least part of SNOMED, LOINC...)</p>



<a name="245879402"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179281-pascal/topic/Tx%20server%20issues/near/245879402" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jose Costa Teixeira <a href="https://fhir.github.io/chat-archive/stream/179281-pascal/topic/Tx.20server.20issues.html#245879402">(Jul 13 2021 at 20:03)</a>:</h4>
<p>Sadly, I do not have the server working since it moved to Lazarus. If we could get a replica of our server as a VM that I could run locally, i can setup jmeter to throw stuff at  the server to try</p>



<a name="245882590"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179281-pascal/topic/Tx%20server%20issues/near/245882590" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179281-pascal/topic/Tx.20server.20issues.html#245882590">(Jul 13 2021 at 20:29)</a>:</h4>
<p>THTTPLanguages is a record, not an object, so it doesn't live on the stack</p>



<a name="245882729"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179281-pascal/topic/Tx%20server%20issues/near/245882729" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179281-pascal/topic/Tx.20server.20issues.html#245882729">(Jul 13 2021 at 20:29)</a>:</h4>
<p>lists own the objects, and free them when they are removed from the lsit</p>



<a name="245882984"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179281-pascal/topic/Tx%20server%20issues/near/245882984" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179281-pascal/topic/Tx.20server.20issues.html#245882984">(Jul 13 2021 at 20:30)</a>:</h4>
<p>The server is not going down because it runs out of memory, so far as I can figure</p>



<a name="245883013"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179281-pascal/topic/Tx%20server%20issues/near/245883013" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179281-pascal/topic/Tx.20server.20issues.html#245883013">(Jul 13 2021 at 20:30)</a>:</h4>
<p>the server still compiles and runs under delphi</p>



<a name="245885531"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179281-pascal/topic/Tx%20server%20issues/near/245885531" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jose Costa Teixeira <a href="https://fhir.github.io/chat-archive/stream/179281-pascal/topic/Tx.20server.20issues.html#245885531">(Jul 13 2021 at 20:50)</a>:</h4>
<p>I'll get started on this, getting the server to run. Should I do this in a VM for us all to share, for future debugging? just because the setup is not that trivial.</p>



<a name="245885815"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179281-pascal/topic/Tx%20server%20issues/near/245885815" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Hausam <a href="https://fhir.github.io/chat-archive/stream/179281-pascal/topic/Tx.20server.20issues.html#245885815">(Jul 13 2021 at 20:53)</a>:</h4>
<p>I've been able to get the code to run under FPC - but I haven't done the rest of the setup yet with SQL Server, etc.  I'm just using the Console for the moment.</p>



<a name="248442783"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179281-pascal/topic/Tx%20server%20issues/near/248442783" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jose Costa Teixeira <a href="https://fhir.github.io/chat-archive/stream/179281-pascal/topic/Tx.20server.20issues.html#248442783">(Aug 05 2021 at 06:29)</a>:</h4>
<p><a href="https://tx.fhir.org/r4/ValueSet/iso3166-1-3/$validate-code?system=urn:iso:std:iso:3166&amp;code=USA">https://tx.fhir.org/r4/ValueSet/iso3166-1-3/$validate-code?system=urn:iso:std:iso:3166&amp;code=USA</a></p>



<a name="248442855"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179281-pascal/topic/Tx%20server%20issues/near/248442855" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jose Costa Teixeira <a href="https://fhir.github.io/chat-archive/stream/179281-pascal/topic/Tx.20server.20issues.html#248442855">(Aug 05 2021 at 06:30)</a>:</h4>
<p>At a first glance, I think the issue would come from a line like this: </p>
<div class="codehilite" data-code-language="Delphi"><pre><span></span><code><span class="k">procedure</span> <span class="nc">TCountryCodeServices</span><span class="o">.</span><span class="nf">Close</span><span class="p">(</span><span class="n">ctxt</span><span class="o">:</span> <span class="n">TCodeSystemProviderFilterPreparationContext</span><span class="p">)</span><span class="o">;</span>
<span class="k">begin</span>
  <span class="k">raise</span> <span class="n">ETerminologyTodo</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s">'TCountryCodeServices.Close'</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>
</code></pre></div>



<a name="248503453"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179281-pascal/topic/Tx%20server%20issues/near/248503453" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Hausam <a href="https://fhir.github.io/chat-archive/stream/179281-pascal/topic/Tx.20server.20issues.html#248503453">(Aug 05 2021 at 16:46)</a>:</h4>
<p>Yes, that seems likely the case.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
