---
layout: page
title: "FHIR Chat  · Repeating choice elements · methodology"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/index.html">methodology</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html">Repeating choice elements</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="179379451"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/179379451" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#179379451">(Oct 29 2019 at 22:06)</a>:</h4>
<p>We currently have a number of places where we have a particularly unwieldy definition link this:</p>



<a name="179379506"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/179379506" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#179379506">(Oct 29 2019 at 22:06)</a>:</h4>
<p><a href="/user_uploads/10155/4dD-sDji4RBCefh_RO3gk3ji/pasted_image.png" target="_blank" title="pasted_image.png">pasted image</a></p>
<div class="message_inline_image"><a href="/user_uploads/10155/4dD-sDji4RBCefh_RO3gk3ji/pasted_image.png" target="_blank" title="pasted image"><img src="/user_uploads/10155/4dD-sDji4RBCefh_RO3gk3ji/pasted_image.png"></a></div>



<a name="179379527"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/179379527" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#179379527">(Oct 29 2019 at 22:07)</a>:</h4>
<p>or, as an alternative:</p>



<a name="179379869"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/179379869" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#179379869">(Oct 29 2019 at 22:10)</a>:</h4>
<p><a href="/user_uploads/10155/XufqNOY9fsO3qdpW5VXL9roj/pasted_image.png" target="_blank" title="pasted_image.png">pasted image</a></p>
<div class="message_inline_image"><a href="/user_uploads/10155/XufqNOY9fsO3qdpW5VXL9roj/pasted_image.png" target="_blank" title="pasted image"><img src="/user_uploads/10155/XufqNOY9fsO3qdpW5VXL9roj/pasted_image.png"></a></div>



<a name="179379962"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/179379962" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#179379962">(Oct 29 2019 at 22:11)</a>:</h4>
<p>Neither of these patterns are particularly rewarding, and I'd like it if we could come up with a better approach such that the structure definition could just say:</p>
<p><code>Instantiates[x] : Canonical(Definition) | uri  0..*</code></p>



<a name="179379988"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/179379988" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#179379988">(Oct 29 2019 at 22:11)</a>:</h4>
<p>This thread is discussing options to get to that point.</p>



<a name="179380008"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/179380008" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#179380008">(Oct 29 2019 at 22:11)</a>:</h4>
<p>note that the fundamental underlying problem is how these things are represented in json, as an array with no type</p>



<a name="179396748"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/179396748" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#179396748">(Oct 30 2019 at 02:13)</a>:</h4>
<p>Note that making any changes in this space will likely involve breaking reference implementations, parsers and serializers and involves changing 'normative' content, so it's something that would need to meet with near universal acceptance by implementers if we were going to fix it.</p>



<a name="179399149"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/179399149" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#179399149">(Oct 30 2019 at 03:16)</a>:</h4>
<p>right. It's not clear that this would count as a 'breaking change' since past content would (must) continue to be valid. but it's still a significant change</p>



<a name="182014040"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182014040" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182014040">(Nov 27 2019 at 12:34)</a>:</h4>
<p>The most obvious thing to do is the simplest, rather than the nicest. To say that if the array is polymorphic, then all entries are Tuples with value and type properties:</p>
<div class="codehilite"><pre><span></span>  <span class="s2">&quot;instantiates&quot;</span> <span class="err">:</span> <span class="p">[{</span>
    <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="s2">&quot;http://someuri&quot;</span><span class="p">,</span>
    <span class="nt">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;uri&quot;</span>
  <span class="p">},{</span>
    <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;reference&quot;</span> <span class="p">:</span> <span class="s2">&quot;http://someuri&quot;</span> <span class="p">},</span>
    <span class="nt">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;Reference&quot;</span>
  <span class="p">}]</span>
</pre></div>



<a name="182014214"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182014214" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182014214">(Nov 27 2019 at 12:36)</a>:</h4>
<p>the XML would be:</p>
<div class="codehilite"><pre><span></span>  <span class="nt">&lt;instantiatesUri</span> <span class="na">value=</span><span class="s">&quot;http://someuri&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;instantiatesReference&gt;</span>
     <span class="nt">&lt;reference</span> <span class="na">value=</span><span class="s">&quot;http://someuri&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/instantiatesReference&gt;</span>
</pre></div>



<a name="182072866"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182072866" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182072866">(Nov 28 2019 at 00:53)</a>:</h4>
<p>Not sure how that can be a non-breaking change?</p>



<a name="182075991"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182075991" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182075991">(Nov 28 2019 at 02:04)</a>:</h4>
<p>it doesn't change anything that is already exchanged</p>



<a name="182091001"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182091001" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Beale <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182091001">(Nov 28 2019 at 08:39)</a>:</h4>
<p>The key question is whether the choice of which to use is mostly/always at run-time, or whether the intention is that one of these options will always be profiled out to leave the one that is thought to be required in some particular operational situation.</p>



<a name="182096949"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182096949" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182096949">(Nov 28 2019 at 10:18)</a>:</h4>
<p>I think it's a 50:50 mix of those things</p>



<a name="182102336"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182102336" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Beale <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182102336">(Nov 28 2019 at 11:49)</a>:</h4>
<p>If in any Resource, it is not knowable, I.e has to be assumed to be runtime, you can use  a wrapper class/type that contains the variant ways of representing the reference, and at the point of reference you don't have any 'multiple' problem at all.</p>



<a name="182119714"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182119714" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182119714">(Nov 28 2019 at 16:03)</a>:</h4>
<p>That seems like an implementation strategy, but it's not clear how it adds value to the specification (and equally viable implementation strategy is just to point to Object or equivalent and have logic that checks whether the Object is one of the allowed types.</p>



<a name="182119769"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182119769" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182119769">(Nov 28 2019 at 16:04)</a>:</h4>
<p>A key thing is that our choices aren't generally driven by shared attributes, but rather by shared capabilities.  It's totally fine to have two classes as part of a choice that have no overlapping attributes at all.</p>



<a name="182119906"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182119906" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182119906">(Nov 28 2019 at 16:06)</a>:</h4>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span> I guess we lucked out that OO decided 'instantiates' wasn't core for Observation.  However, it would still break the serialization of instantiates[x] everywhere it does appear and the serialization was supposed to be normative.  Howe can we say that's allowed?</p>



<a name="182119923"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182119923" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182119923">(Nov 28 2019 at 16:06)</a>:</h4>
<blockquote>
<p>it would still break the serialization of instantiates[x] everywhere it does appear</p>
</blockquote>
<p>How do you figure that?</p>



<a name="182120462"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182120462" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182120462">(Nov 28 2019 at 16:15)</a>:</h4>
<p>Instead of showing up as "instantiatesUri" as the JSON propery it'll show up as "instantiates"</p>



<a name="182120519"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182120519" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182120519">(Nov 28 2019 at 16:16)</a>:</h4>
<p>only it it's cardinality is 0..*, and nothing like that exists right now</p>



<a name="182120593"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182120593" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182120593">(Nov 28 2019 at 16:17)</a>:</h4>
<p>So this would only change the names if the element repeated, but not if maxOccurs=1?  The creates a different kind of pain...</p>



<a name="182120649"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182120649" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182120649">(Nov 28 2019 at 16:18)</a>:</h4>
<p>yes that's what I proposed.</p>



<a name="182120686"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182120686" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182120686">(Nov 28 2019 at 16:18)</a>:</h4>
<p>because I don't see a way not to have that pain in the json format.</p>



<a name="182129530"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182129530" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Beale <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182129530">(Nov 28 2019 at 18:49)</a>:</h4>
<blockquote>
<p>That seems like an implementation strategy, but it's not clear how it adds value to the specification (and equally viable implementation strategy is just to point to Object or equivalent and have logic that checks whether the Object is one of the allowed types.</p>
</blockquote>
<p>Well it's a modelling strategy - it simplifies the Resource definitions. The variant reference / inline attributes are now in some class/definition that can contain various kinds of references and/or values. Secondly, it seems unwieldy having two data items for instantiatesUri and instantiatesCanonical - presumably only one of them will ever be set at any time, and they are both in fact URIs. As far as I can see, the construct canonical(T) indicates that the target of the URI must be a Resource of type T, but does that turn into anything concrete? Anyway, is there any reason a reference to a protocol (where this kind of thing appears in <a href="http://hl7.org/fhir/servicerequest.html" target="_blank" title="http://hl7.org/fhir/servicerequest.html">http://hl7.org/fhir/servicerequest.html</a>) can't easily change from something that might happen to be FHIR Resource-represented or representable to something else? That would be another reason to get rid of the pattern instantiatesUri / instantiatesCanonical.</p>



<a name="182129728"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182129728" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182129728">(Nov 28 2019 at 18:52)</a>:</h4>
<blockquote>
<p>is there any reason a reference to a protocol (where this kind of thing appears in <a href="http://hl7.org/fhir/servicerequest.html" target="_blank" title="http://hl7.org/fhir/servicerequest.html">http://hl7.org/fhir/servicerequest.html</a>) can't easily change from something that might happen to be FHIR Resource-represented or representable to something else</p>
</blockquote>
<p>I'm not quite sure what you mean there. The principle is that it might refer to a formally defined protocol - using a PlanDefinition - but it might just refer to some published paper or something published elsewhere. but when profiling, people may want to make a rule that it has to be one or the other. Though they might not either. </p>
<p>It is very unwieldy - I don't like where we are at all here. Hence the discussion.</p>



<a name="182131214"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182131214" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182131214">(Nov 28 2019 at 19:21)</a>:</h4>
<p>It is possible to have more than one.  A single action could follow more than one protocol or be part of more than one order set.  And they might be any combination of resource or web page/PDF.  </p>
<p>I don't understand how introducing wrapper classes would simplify.  Providing a list of candidate types seems simpler than having a class containing multiple properties restricting to only one.</p>



<a name="182134423"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182134423" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Beale <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182134423">(Nov 28 2019 at 20:32)</a>:</h4>
<blockquote>
<blockquote>
<p>is there any reason a reference to a protocol (where this kind of thing appears in <a href="http://hl7.org/fhir/servicerequest.html" target="_blank" title="http://hl7.org/fhir/servicerequest.html">http://hl7.org/fhir/servicerequest.html</a>) can't easily change from something that might happen to be FHIR Resource-represented or representable to something else</p>
</blockquote>
<p>I'm not quite sure what you mean there. The principle is that it might refer to a formally defined protocol - using a PlanDefinition - but it might just refer to some published paper or something published elsewhere. but when profiling, people may want to make a rule that it has to be one or the other. Though they might not either. </p>
<p>It is very unwieldy - I don't like where we are at all here. Hence the discussion.</p>
</blockquote>
<p>Right - today it points to an NCI PDF, next month (perhaps due to a new research paper in the BMJ) some places decide to move over to some better <a href="http://NICE.org.uk" target="_blank" title="http://NICE.org.uk">NICE.org.uk</a> protocol, for which, let's just say, the Interopen people here happen to have built a PlanDefinition profile, and suddenly those data refs inside various FHIR resources being generated days after that now have a null in the instantiatesUri field, and a new, different URI in the instantiatesCanonical field. Now let's imagine that a year later, everyone moves on yet again to another protocol, say developed by U Waterloo and the refs are now all pointing to HTML pages on their site. You get the idea.</p>
<p>So I think that patterns such as these need to reflect better the very fluid states of affairs in the real world, and thus to assume less, and perhaps unexpectedly, the models actually can be made cleaner, even though the reality they represent is messier than one might like.</p>



<a name="182134970"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182134970" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182134970">(Nov 28 2019 at 20:46)</a>:</h4>
<p>I think you are saying that because it's a URI in either case, the differentiation of what the URI refers to shouldn't be explicit in the instance.</p>



<a name="182135314"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182135314" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182135314">(Nov 28 2019 at 20:54)</a>:</h4>
<p>I think the whole grounds for the pattern in the first place is because some group of implementers very much wanted it to be explicit in the instance</p>



<a name="182137852"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182137852" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Beale <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182137852">(Nov 28 2019 at 21:55)</a>:</h4>
<p>Firstly, how are you going to make the type (e.g. ActivityDefinition) explicit in the URI? Secondly, why are there 2 URI fields when they are (slightly) alternative representations for one actual reference. This is from ServiceRequest, but I think the same argument applies to the other instances of this. You don't use 2 fields to carry one thing at runtime, especially when in all cases it is a URI.</p>
<p>Anyway, do you know what the implementers  /designers were really thinking when they created this? Maybe they don't know much about modelling techniques and thought that was the way to capture a single data item that can have different format URIs? Maybe they know all about modelling and had something more esoteric in mind. It is not clear from the definition. Maybe worth finding out about.</p>



<a name="182138255"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182138255" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182138255">(Nov 28 2019 at 22:06)</a>:</h4>
<blockquote>
<p>Anyway, do you know what the implementers /designers were really thinking when they created this?</p>
</blockquote>
<p>Yes because I asked as soon as I saw the pattern</p>



<a name="182138285"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182138285" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Beale <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182138285">(Nov 28 2019 at 22:07)</a>:</h4>
<p>And... are you saying it's the right pattern for the design intention?</p>



<a name="182138336"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182138336" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182138336">(Nov 28 2019 at 22:08)</a>:</h4>
<p>no. I question both the design intention and the instantiation</p>



<a name="182138414"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182138414" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Beale <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182138414">(Nov 28 2019 at 22:10)</a>:</h4>
<p>Right. So, wouldn't you agree that we need to get more rigorous about this kind of thing? Because at the moment, things like this are getting cemented into the foundations and are starting to become unchangeable legacy way too soon...</p>



<a name="182138431"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182138431" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182138431">(Nov 28 2019 at 22:11)</a>:</h4>
<p>I agree we should question the design yes</p>



<a name="182138480"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182138480" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182138480">(Nov 28 2019 at 22:12)</a>:</h4>
<p>but it always helps to understand the requirements. For instance, why did the designers want to make a statement about the target explicit in the source ?</p>



<a name="182138934"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182138934" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Beale <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182138934">(Nov 28 2019 at 22:24)</a>:</h4>
<p>Not the target, the type of target. We have the same thing in openEHR, when you want to constrain a URI to point to a type of thing, it's actually not that easy.</p>



<a name="182138950"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182138950" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182138950">(Nov 28 2019 at 22:24)</a>:</h4>
<p>how is it done in openEHR?</p>



<a name="182139104"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182139104" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Beale <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182139104">(Nov 28 2019 at 22:28)</a>:</h4>
<p>Well we don't have any pretty method right now, but the right way to do it would be to store the constraint in the relevant archetype node. It means having to have a specific archetype node type for references. The type constraint, unlike nearly every other archetype constraint, isn't a constraint on the runtime value of anything; instead, it just retains the fact that the designers want the URI pointing to a type XYZ thing at runtime. Now, in openEHR at least, when data are being created, you have the archetypes (or bits thereof, within templates) live in memory, in a data-constructor context. So the data builder can find out what that type info was for a URI field, and assuming it has some way to determine the dynamic type of the attached data object, it can do the usual check: does this data satisfy the archetype constraint.</p>



<a name="182139121"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182139121" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Beale <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182139121">(Nov 28 2019 at 22:29)</a>:</h4>
<p>So most if not all of this logic could be replicated in FHIR-land, but it probably needs some special node type in StructureDefinition or somewhere.</p>



<a name="182139133"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182139133" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Beale <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182139133">(Nov 28 2019 at 22:29)</a>:</h4>
<p>I have FHIR DSTU4 in the ADL workbench, I could show how this works in archetypes at some future date.</p>



<a name="182139275"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182139275" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182139275">(Nov 28 2019 at 22:32)</a>:</h4>
<p>well, in fact, we have the field- targetProfile. We just have a set of methodology rules built in that mean that you can't have a type that <em>might</em> have a targetProfile.</p>



<a name="182139352"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182139352" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182139352">(Nov 28 2019 at 22:35)</a>:</h4>
<p>either it does or doesn't. And so you end up where we are</p>



<a name="182139436"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182139436" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182139436">(Nov 28 2019 at 22:37)</a>:</h4>
<p>so a different approach to this problem is to either define a new type that <em>may</em> have a target profile. (or adapt either uri or canonical so that it may have a targetProfile or not)</p>
<p>or Define a special value for targetProfile that means, not a resource</p>



<a name="182139497"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182139497" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182139497">(Nov 28 2019 at 22:38)</a>:</h4>
<p>that reminds me, though, of one of the differences here - the resolution path for a canonical is different to the resolution path for a uri, which is one reason to make them separate</p>



<a name="182139503"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182139503" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Beale <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182139503">(Nov 28 2019 at 22:38)</a>:</h4>
<p>Right, so you have to have a wrapper type, that carries a URI reference, and some other optional constraint info, e.g. the target canonical type if there is one. Then the Resource definition can just have one field 'protocol' or whatever, with the type constraints, but now understood as: if this URI points to a Resource at runtime, it should be of one of these types...</p>



<a name="182139529"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182139529" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Beale <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182139529">(Nov 28 2019 at 22:39)</a>:</h4>
<p>Well, all the more reason to hide that detail in a small type...</p>



<a name="182139530"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182139530" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182139530">(Nov 28 2019 at 22:39)</a>:</h4>
<p>hah- you've ended up exactly where we'd be, if not that the JSON foramt doesn't support that construct. Which is why we disallow it. I'm proposing a solution...</p>



<a name="182139588"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182139588" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Beale <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182139588">(Nov 28 2019 at 22:40)</a>:</h4>
<p>Well that's the tail wagging the dog, but anyway, why doesn't it work? I can think of a JSON structure to do the openEHR equivalent...</p>



<a name="182139601"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182139601" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Beale <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182139601">(Nov 28 2019 at 22:41)</a>:</h4>
<p>isn't the problem in the StructureDefinition meta-type on which the JSON is based?</p>



<a name="182139603"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182139603" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Beale <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182139603">(Nov 28 2019 at 22:41)</a>:</h4>
<p>(i.e. you need a new meta-type)</p>



<a name="182139605"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182139605" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182139605">(Nov 28 2019 at 22:41)</a>:</h4>
<p>because json isn't inherently polymorphic. And we didn't define the structure to do that - much argument about pros and cons back then.</p>



<a name="182139612"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182139612" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Beale <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182139612">(Nov 28 2019 at 22:41)</a>:</h4>
<p>you need to use _type in JSON. If you don't, you're dead.</p>



<a name="182139615"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182139615" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Beale <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182139615">(Nov 28 2019 at 22:41)</a>:</h4>
<p>Seriously...</p>



<a name="182139681"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182139681" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Beale <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182139681">(Nov 28 2019 at 22:43)</a>:</h4>
<div class="codehilite"><pre><span></span>{
    &quot;message&quot;: &quot;Error message&quot;,
    &quot;code&quot;: 90000,
    &quot;errors&quot;: [
        {
            &quot;_type&quot;: &quot;DV_CODED_TEXT&quot;,
            &quot;value&quot;: &quot;Error message&quot;,
            &quot;defining_code&quot;: {
                &quot;terminology_id&quot;: {
                    &quot;value&quot;: &quot;local&quot;
                },
                &quot;code_string&quot;: &quot;9000&quot;
            }
        },
        {
            &quot;_type&quot;: &quot;DV_CODED_TEXT&quot;,
            &quot;value&quot;: &quot;Secondary error message&quot;,
            &quot;defining_code&quot;: {
                &quot;terminology_id&quot;: {
                    &quot;value&quot;: &quot;local&quot;
                },
                &quot;code_string&quot;: &quot;8000&quot;
            }
        }
    ]
}
</pre></div>



<a name="182139688"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182139688" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182139688">(Nov 28 2019 at 22:43)</a>:</h4>
<p>I'll take that as an endorsement of my proposal then, since that is what my proposal was</p>



<a name="182139746"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182139746" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Beale <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182139746">(Nov 28 2019 at 22:44)</a>:</h4>
<p>that's just some openEHR EHR data, but you get the idea - those fields starting with '_type' are polymorphic fields.</p>



<a name="182139756"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182139756" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Beale <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182139756">(Nov 28 2019 at 22:44)</a>:</h4>
<p>I would strongly recommend using that generally, it's crippling not having it.</p>



<a name="182139777"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/182139777" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Beale <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#182139777">(Nov 28 2019 at 22:45)</a>:</h4>
<p>(we do the same in JSON archetype serialisation, I just don't  have one to hand right now)</p>



<a name="184830694"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/184830694" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#184830694">(Jan 05 2020 at 03:08)</a>:</h4>
<p>Makes json de-serialization totally custom doesn't it?<br>
And would need to switch on that property before trying to understand the other fields.</p>



<a name="184836533"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/184836533" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#184836533">(Jan 05 2020 at 06:39)</a>:</h4>
<p>yes, like we do already with resourceType</p>



<a name="185217085"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/211987-methodology/topic/Repeating%20choice%20elements/near/185217085" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Beale <a href="https://fhir.github.io/chat-archive/stream/211987-methodology/topic/Repeating.20choice.20elements.html#185217085">(Jan 09 2020 at 14:39)</a>:</h4>
<p>Well you can use normal JSON deserialsation, but then you have to post-process the resulting data tree. That implies using an intermediate class model that represents a generic data tree that can be further traversed to generate the 'real' class instances. There are other strategies. JSON just ins't semantically very strong.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
