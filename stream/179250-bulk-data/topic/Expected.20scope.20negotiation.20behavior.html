---
layout: page
title: "FHIR Chat  · Expected scope negotiation behavior · bulk data"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/index.html">bulk data</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/topic/Expected.20scope.20negotiation.20behavior.html">Expected scope negotiation behavior</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="253448999"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179250-bulk%20data/topic/Expected%20scope%20negotiation%20behavior/near/253448999" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Ignatov <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/topic/Expected.20scope.20negotiation.20behavior.html#253448999">(Sep 15 2021 at 16:53)</a>:</h4>
<p>In Backend Services Authentication a client could request a <code>system/Patient.*</code> scope, but it is not explicitly described what the expected behavior of the servers should be in this case. The possible outcomes are:</p>
<ol>
<li>The request is rejected because it implies write access and a client should only have read access</li>
<li>The scope is converted under the hood to <code>system/Patient.read</code></li>
<li>The scope is rejected/ignored and not granted (but you don't get an error)</li>
<li>Other?</li>
</ol>
<p>The reason for asking is that there is a potentially incorrect test in Inferno that asks for <code>system/Patient.*</code> and expects that to NOT result in an error.</p>
<p>Also note that many clients would request <code>system/*.read</code> or even <code>system/*.*</code>, expecting to be granted whatever specific scopes are available to them (for example <code>system/*.read</code> =&gt; <code>system/Patient.read, system/Observation.read</code>. </p>
<p>There are even some Bulk Data servers that requre clients to request <code>sustem/*.*</code>. That is not correct in my opinion, but that is the current state of things.</p>



<a name="253451108"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179250-bulk%20data/topic/Expected%20scope%20negotiation%20behavior/near/253451108" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/topic/Expected.20scope.20negotiation.20behavior.html#253451108">(Sep 15 2021 at 17:05)</a>:</h4>
<p>To be clear, in Keycloak a client app can only request the scopes they are allowed to request.  If they ask for a scope that they are not allowed to, the server will reject the request (number 1 above).  It makes sense to me that some implementations would want to grant a tighter set of scopes instead (number 2 above), but I think that a server should be allowed to reject a request with overly broad scopes (like write access when only read access is allowed).  Inferno <code>Auth-14: Token endpoint supports wildcard action scopes</code> does not allow that.</p>



<a name="253458314"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179250-bulk%20data/topic/Expected%20scope%20negotiation%20behavior/near/253458314" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/topic/Expected.20scope.20negotiation.20behavior.html#253458314">(Sep 15 2021 at 17:50)</a>:</h4>
<p>(1), (2), and (3) are all valid behaviors according to our current spec.</p>



<a name="253458826"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179250-bulk%20data/topic/Expected%20scope%20negotiation%20behavior/near/253458826" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Ignatov <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/topic/Expected.20scope.20negotiation.20behavior.html#253458826">(Sep 15 2021 at 17:53)</a>:</h4>
<p>OK, then the test should not expect <code>system/Patient.*</code> to be handled without an error.</p>
<blockquote>
<p>valid behaviors according to our current spec </p>
</blockquote>
<p>Where is that described?</p>



<a name="253459392"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179250-bulk%20data/topic/Expected%20scope%20negotiation%20behavior/near/253459392" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/topic/Expected.20scope.20negotiation.20behavior.html#253459392">(Sep 15 2021 at 17:56)</a>:</h4>
<blockquote>
<p>As with any requested scope, the scopes ultimately granted by the authorization server may differ from the scopes requested by the client! When dealing with wildcard clinical scope requests, this is often true.</p>
</blockquote>
<p><a href="http://build.fhir.org/ig/HL7/smart-app-launch/scopes-and-launch-context.html">http://build.fhir.org/ig/HL7/smart-app-launch/scopes-and-launch-context.html</a></p>



<a name="253459414"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179250-bulk%20data/topic/Expected%20scope%20negotiation%20behavior/near/253459414" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/topic/Expected.20scope.20negotiation.20behavior.html#253459414">(Sep 15 2021 at 17:56)</a>:</h4>
<p>That's probably the most explicit statement.</p>



<a name="253459458"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179250-bulk%20data/topic/Expected%20scope%20negotiation%20behavior/near/253459458" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/topic/Expected.20scope.20negotiation.20behavior.html#253459458">(Sep 15 2021 at 17:56)</a>:</h4>
<p>We don't have specific guidance on rejection.</p>



<a name="253585793"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179250-bulk%20data/topic/Expected%20scope%20negotiation%20behavior/near/253585793" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yunwei Wang <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/topic/Expected.20scope.20negotiation.20behavior.html#253585793">(Sep 16 2021 at 13:56)</a>:</h4>
<p><span class="user-mention" data-user-id="193731">@Vladimir Ignatov</span> </p>
<blockquote>
<p>test in Inferno that asks for system/Patient.* and expects that to NOT result in an error.</p>
</blockquote>
<p>Can you clarify if this is in Inferno Program or Inferno Community?</p>



<a name="253587290"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179250-bulk%20data/topic/Expected%20scope%20negotiation%20behavior/near/253587290" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Ignatov <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/topic/Expected.20scope.20negotiation.20behavior.html#253587290">(Sep 16 2021 at 14:05)</a>:</h4>
<p>I think it was in community but <span class="user-mention" data-user-id="191676">@Lee Surprenant</span> should confirm that. What is the difference though - aren't they using the same test suite?</p>
<p>I intended to make some commits/PRs for the few issues we discovered during the connectathon but I don't have the time to do it yet. <br>
What is the right way to do this now? Are you using tests from <a href="https://github.com/smart-on-fhir/bdt">https://github.com/smart-on-fhir/bdt</a> or do you have your own fork?</p>



<a name="253587489"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179250-bulk%20data/topic/Expected%20scope%20negotiation%20behavior/near/253587489" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/topic/Expected.20scope.20negotiation.20behavior.html#253587489">(Sep 16 2021 at 14:06)</a>:</h4>
<p>Yes, community edition</p>



<a name="253589023"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179250-bulk%20data/topic/Expected%20scope%20negotiation%20behavior/near/253589023" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Ignatov <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/topic/Expected.20scope.20negotiation.20behavior.html#253589023">(Sep 16 2021 at 14:16)</a>:</h4>
<p>For this issue we have 2 choices. </p>
<ol>
<li>Remove the test</li>
<li>Modify it to request <code>system/*.read</code> instead. That would match the test name and description. </li>
</ol>
<p>As far as I can recall, one of the CMS servers wasn't accepting  <code>system/*.read</code> and was insisting for <code>system/*.*</code> instead. Such a server would fail if we choose option 2, but that is incorrect implementation anyway. What do you think?</p>



<a name="253589751"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179250-bulk%20data/topic/Expected%20scope%20negotiation%20behavior/near/253589751" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yunwei Wang <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/topic/Expected.20scope.20negotiation.20behavior.html#253589751">(Sep 16 2021 at 14:21)</a>:</h4>
<p>Inferno Program use its own testing module while Inferno Community wraps around bdt. In Inferno Program, we test <code>system/*.read</code> and make this scope configurable so the tester could change the scope before testing.</p>



<a name="253590957"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179250-bulk%20data/topic/Expected%20scope%20negotiation%20behavior/near/253590957" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Ignatov <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/topic/Expected.20scope.20negotiation.20behavior.html#253590957">(Sep 16 2021 at 14:29)</a>:</h4>
<p>To be clear, there is a default "scope" option in bdt. It is for the scope that should be used in any auth requests during the test flow. However, in this particular test the scope is intentionally hard-coded to <code>system/Patient.*</code>.</p>
<p>In other words, the scope option allows the tester to set the default scope to anything (like <code>system/*.*</code>) so that other Bulk Data tests are executed even if the authentication part is not using the standard <code>system/*.read</code>.</p>



<a name="267639251"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179250-bulk%20data/topic/Expected%20scope%20negotiation%20behavior/near/267639251" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/topic/Expected.20scope.20negotiation.20behavior.html#267639251">(Jan 11 2022 at 20:18)</a>:</h4>
<p>Our implementation is still failing this inferno test. Is there anything we can do to help move this one forward? Maybe open an issue on the inferno-community and/or bdt repos?</p>



<a name="267658703"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179250-bulk%20data/topic/Expected%20scope%20negotiation%20behavior/near/267658703" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gottlieb <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/topic/Expected.20scope.20negotiation.20behavior.html#267658703">(Jan 11 2022 at 22:57)</a>:</h4>
<p>Yup, if wildcard scope support isn't required in the spec, seems like there shouldn't be core tests around it. Can you open an issue at <a href="https://github.com/smart-on-fhir/bdt">https://github.com/smart-on-fhir/bdt</a> ?</p>



<a name="267658731"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179250-bulk%20data/topic/Expected%20scope%20negotiation%20behavior/near/267658731" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gottlieb <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/topic/Expected.20scope.20negotiation.20behavior.html#267658731">(Jan 11 2022 at 22:57)</a>:</h4>
<p>Relatedly, are there tests around scope that would be helpful in dbt? For example, is it worth having implementations indicate the scopes they think they support for this client_id in the config and then testing those?</p>



<a name="267666284"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179250-bulk%20data/topic/Expected%20scope%20negotiation%20behavior/near/267666284" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/topic/Expected.20scope.20negotiation.20behavior.html#267666284">(Jan 12 2022 at 00:17)</a>:</h4>
<p>vlad seems to have gotten to this one too (awesome!):  <a href="https://github.com/smart-on-fhir/bdt/issues/6">https://github.com/smart-on-fhir/bdt/issues/6</a></p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
