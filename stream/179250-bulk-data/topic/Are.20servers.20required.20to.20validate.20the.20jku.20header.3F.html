---
layout: page
title: "FHIR Chat  · Are servers required to validate the jku header? · bulk data"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/index.html">bulk data</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/topic/Are.20servers.20required.20to.20validate.20the.20jku.20header.3F.html">Are servers required to validate the jku header?</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="253447897"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179250-bulk%20data/topic/Are%20servers%20required%20to%20validate%20the%20jku%20header%3F/near/253447897" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/topic/Are.20servers.20required.20to.20validate.20the.20jku.20header.3F.html#253447897">(Sep 15 2021 at 16:47)</a>:</h4>
<p>inferno <code>Auth-18: Token endpoint validates the jku token header</code> claims that servers should reject a JWT if it has a jku that doesn't match the jwks url that the client was registered with.</p>
<p>Keycloak seems to ignore the jku header.<br>
The SMART Backend Services spec does have the following from <a href="http://build.fhir.org/ig/HL7/bulk-data/authorization.html#signature-verification">http://build.fhir.org/ig/HL7/bulk-data/authorization.html#signature-verification</a></p>
<div class="codehilite"><pre><span></span><code>To resolve a key to verify signatures, a FHIR authorization server SHALL follow this algorithm:

If the jku header is present, verify that the jku is whitelisted (i.e., that it matches the JWKS URL value supplied at registration time for the specified client_id).
If the jku header is not whitelisted, the signature verification fails.
</code></pre></div>
<p>So in this case I think the test is accurately testing what is in the specification.  What was surprising to me is that this goes beyond standard JWT validation.<br>
What is the rationale for being so stringent on this jku field...is it important for security?</p>



<a name="253458776"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179250-bulk%20data/topic/Are%20servers%20required%20to%20validate%20the%20jku%20header%3F/near/253458776" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/topic/Are.20servers.20required.20to.20validate.20the.20jku.20header.3F.html#253458776">(Sep 15 2021 at 17:53)</a>:</h4>
<p>The aim is to ensure that a client registers its JWKS URL(s) ahead of time; we already require that registration <em>needs</em> to result in a client having registered a JWKS URL and/or directly registering a JWKS (but that option is less relevant here).</p>
<p>So, if a client has registered JWKS URLs ahead of time, why would it be embedding a <em>different</em> JWKS URL in its access tokens? (I agree with your point Lee that ignoring these should be safe, but the presence of an unexpected JWKS URL in one of these tokens implies that something unexpected is going on... and we'd rather avoid that.)</p>



<a name="253461636"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179250-bulk%20data/topic/Are%20servers%20required%20to%20validate%20the%20jku%20header%3F/near/253461636" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/topic/Are.20servers.20required.20to.20validate.20the.20jku.20header.3F.html#253461636">(Sep 15 2021 at 18:09)</a>:</h4>
<p>Yeah, it sound fine to me in principle.  Its just that this popular OIDC implementation happens to ignore it and that means it can't pass this test.  So it makes me wonder if its better/easier to try loosening the constraint or patching the server impl.  I wonder whether other OIDC servers that support JWT do this validation of the jku or not.  Any good way to find that answer?</p>



<a name="253463657"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179250-bulk%20data/topic/Are%20servers%20required%20to%20validate%20the%20jku%20header%3F/near/253463657" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/topic/Are.20servers.20required.20to.20validate.20the.20jku.20header.3F.html#253463657">(Sep 15 2021 at 18:23)</a>:</h4>
<p>I don't know how to find answers, other than asking developers for other OIDC servers.</p>
<p>If we wanted to relax the language it'd be to say something like:</p>
<ul>
<li>Servers MAY use the <code>jku</code> claim as a hint about which keyset to use, after validating that the value is part of a client's pre-registered list of JWKS URLs</li>
<li>Servers SHALL NOT dereference the <code>jku</code> if it is not part of a client's pre-registered list of JWKS URLs</li>
</ul>
<p>^^ ?</p>



<a name="253466018"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179250-bulk%20data/topic/Are%20servers%20required%20to%20validate%20the%20jku%20header%3F/near/253466018" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/topic/Are.20servers.20required.20to.20validate.20the.20jku.20header.3F.html#253466018">(Sep 15 2021 at 18:39)</a>:</h4>
<p>yes, exactly</p>



<a name="253466265"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179250-bulk%20data/topic/Are%20servers%20required%20to%20validate%20the%20jku%20header%3F/near/253466265" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179250-bulk-data/topic/Are.20servers.20required.20to.20validate.20the.20jku.20header.3F.html#253466265">(Sep 15 2021 at 18:41)</a>:</h4>
<p>i'm also willing to look into plugging this conformance gap in keycloak...but first wanted to understand how important validation of jku is in practice.  I can try it in a couple other OIDC servers that I have access to and it might help shape my opinion...honestly not sure what is best in this case</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
