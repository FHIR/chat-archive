---
layout: page
title: "FHIR Chat  · Understanding STU3 -&gt; R4 map for DocumentReference · mapping-framework"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/index.html">mapping-framework</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/Understanding.20STU3.20-.3E.20R4.20map.20for.20DocumentReference.html">Understanding STU3 -&gt; R4 map for DocumentReference</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="185476328"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/Understanding%20STU3%20-%3E%20R4%20map%20for%20DocumentReference/near/185476328" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Morten Ernebjerg <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/Understanding.20STU3.20-.3E.20R4.20map.20for.20DocumentReference.html#185476328">(Jan 13 2020 at 09:22)</a>:</h4>
<p>I'm looking at the <a href="https://github.com/FHIR/interversion/blob/master/r4/R3toR4/DocumentReference.map" target="_blank" title="https://github.com/FHIR/interversion/blob/master/r4/R3toR4/DocumentReference.map">STU3 -&gt; R4 map for DocumentReference (on Github)</a> and cannot quite understand the mapping rule for the reference field "author". According to the <a href="https://www.hl7.org/fhir/diff.html" target="_blank" title="https://www.hl7.org/fhir/diff.html">diff summary</a>, all that has changed for this field is that one can now also reference PractitionerRole. But the mapping rule is the following:</p>
<div class="codehilite"><pre><span></span>src.author as s -&gt; tgt.agent as t then agent(s, t);
(...)
group agent(source src, target tgt) extends BackboneElement {
  src -&gt;  tgt.type as cc,  cc.coding as c,  c.system = &#39;http://terminology.hl7.org/CodeSystem/v3-ParticipationType&#39;,  c.code = &#39;AUT&#39; &quot;author&quot;;
  src -&gt; tgt.who as vt0 then Reference(src, vt0) &quot;who&quot;;
}
</pre></div>


<p>Why is this needed?</p>



<a name="185500466"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/Understanding%20STU3%20-%3E%20R4%20map%20for%20DocumentReference/near/185500466" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/Understanding.20STU3.20-.3E.20R4.20map.20for.20DocumentReference.html#185500466">(Jan 13 2020 at 15:00)</a>:</h4>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span></p>



<a name="185559737"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/Understanding%20STU3%20-%3E%20R4%20map%20for%20DocumentReference/near/185559737" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/Understanding.20STU3.20-.3E.20R4.20map.20for.20DocumentReference.html#185559737">(Jan 14 2020 at 02:31)</a>:</h4>
<p>looks like an error to me</p>



<a name="185570955"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/Understanding%20STU3%20-%3E%20R4%20map%20for%20DocumentReference/near/185570955" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Morten Ernebjerg <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/Understanding.20STU3.20-.3E.20R4.20map.20for.20DocumentReference.html#185570955">(Jan 14 2020 at 07:29)</a>:</h4>
<p>Should I put in a change request or  is it easier "off the books"?</p>



<a name="185608909"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/Understanding%20STU3%20-%3E%20R4%20map%20for%20DocumentReference/near/185608909" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Johannes Oehm <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/Understanding.20STU3.20-.3E.20R4.20map.20for.20DocumentReference.html#185608909">(Jan 14 2020 at 15:54)</a>:</h4>
<p><span class="user-mention" data-user-id="194703">@Morten Ernebjerg</span>  I'm curious if You could execute the migration scripts from the github repository? I'm also in the process of learning the mapping language and tried to get a Patient mapping running, but when I try to run anything but an empty Resource, a get various errors for the different datatypes</p>



<a name="185679895"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/Understanding%20STU3%20-%3E%20R4%20map%20for%20DocumentReference/near/185679895" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Morten Ernebjerg <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/Understanding.20STU3.20-.3E.20R4.20map.20for.20DocumentReference.html#185679895">(Jan 15 2020 at 09:07)</a>:</h4>
<p><span class="user-mention" data-user-id="250685">@Johannes Oehm</span> I actually haven't tried to run the mapping yet - I was looking it at to get a better understanding of what STU3 -&gt; R4 transformation of resources involves.</p>



<a name="185955971"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/Understanding%20STU3%20-%3E%20R4%20map%20for%20DocumentReference/near/185955971" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oliver Egger <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/Understanding.20STU3.20-.3E.20R4.20map.20for.20DocumentReference.html#185955971">(Jan 17 2020 at 20:56)</a>:</h4>
<p>hi <span class="user-mention" data-user-id="250685">@Johannes Oehm</span> you should be able to execute the maps directly via the validator, for an example see the <a href="https://github.com/ahdis/fhir-mapping-tutorial" target="_blank" title="https://github.com/ahdis/fhir-mapping-tutorial">fhir tutorial with the java validator</a> or with a <a href="https://github.com/ahdis/matchbox/blob/master/matchbox-fml.md" target="_blank" title="https://github.com/ahdis/matchbox/blob/master/matchbox-fml.md">local setup</a></p>



<a name="186104427"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/Understanding%20STU3%20-%3E%20R4%20map%20for%20DocumentReference/near/186104427" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Johannes Oehm <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/Understanding.20STU3.20-.3E.20R4.20map.20for.20DocumentReference.html#186104427">(Jan 20 2020 at 14:05)</a>:</h4>
<p>@Oliver Egger Yes, I also tried your patched version of the FHIR validator, but I'm getting the following message: <br>
C:\Users\oehmj\VSCodeProjects\fhir-mapping-tutorial&gt; java -jar org.hl7.fhir.validator.jar C:\Users\oehmj\IdeaProjects\org.hl7.fhir.core\patient.fhir.json -transform <a href="http://hl7.org/fhir/StructureMap/Patient4to3" target="_blank" title="http://hl7.org/fhir/StructureMap/Patient4to3">http://hl7.org/fhir/StructureMap/Patient4to3</a> -version 4.0.1 -ig ..\fhir-mapping\R4toR3\ -log test.txt -output ./r4tor3out.xml<br>
FHIR Validation tool Version 4.1.38-SNAPSHOT (Git# 363b38be9bc0). Built 2020-01-05T21:22:05.612+01:00 (14 days old)<br>
Detected Java version: 1.8.0_241 from C:\Program Files\Java\jre1.8.0_241 on amd64 (64bit). 2711MB available<br>
Arguments: C:\Users\oehmj\IdeaProjects\org.hl7.fhir.core\patient.fhir.json -transform <a href="http://hl7.org/fhir/StructureMap/Patient4to3" target="_blank" title="http://hl7.org/fhir/StructureMap/Patient4to3">http://hl7.org/fhir/StructureMap/Patient4to3</a> -version 4.0.1 -ig ..\fhir-mapping\R4toR3\ -log test.txt -output ./r4tor3out.xml<br>
Directories: Current = C:\Users\oehmj\VSCodeProjects\fhir-mapping-tutorial, Package Cache = C:\Users\oehmj\.fhir\packages<br>
  .. FHIR Version 4.0, definitions from hl7.fhir.r4.core#4.0.1<br>
  .. connect to tx server @ <a href="http://tx.fhir.org" target="_blank" title="http://tx.fhir.org">http://tx.fhir.org</a><br>
    (v4.0.1)</p>
<ul>
<li>.. load IG from ..\fhir-mapping\R4toR3\<br>
 ...Failure: Unable to determine StructureDefinition for target type<br>
org.hl7.fhir.exceptions.FHIRException: Unable to determine StructureDefinition for target type<br>
        at org.hl7.fhir.r5.validation.ValidationEngine.getTargetResourceFromStructureMap(ValidationEngine.java:1260)<br>
        at org.hl7.fhir.r5.validation.ValidationEngine.transform(ValidationEngine.java:1234)<br>
        at org.hl7.fhir.r5.validation.ValidationEngine.transform(ValidationEngine.java:1222)<br>
        at org.hl7.fhir.r5.validation.Validator.main(Validator.java:592)</li>
</ul>
<p>The official version of the Validator gets into an NPE when it's trying to load the maps vom the ImplementationGuide, I also tried a local fix for that problem, but then imports in the mapping script seem to be unresolved.</p>



<a name="186422889"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/Understanding%20STU3%20-%3E%20R4%20map%20for%20DocumentReference/near/186422889" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oliver Egger <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/Understanding.20STU3.20-.3E.20R4.20map.20for.20DocumentReference.html#186422889">(Jan 23 2020 at 19:04)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="250685">@Johannes Oehm</span> sorry that was maybe a misunderstanding, executing the mappings for version conversion R4toR3 is not directly possible with the java validator. The fhir java build uses the maps to transform them, but adjusts the StructureDefinitions that multiple versions are possible.</p>



<a name="189567963"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/Understanding%20STU3%20-%3E%20R4%20map%20for%20DocumentReference/near/189567963" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/Understanding.20STU3.20-.3E.20R4.20map.20for.20DocumentReference.html#189567963">(Mar 03 2020 at 06:57)</a>:</h4>
<p>see <a href="https://confluence.hl7.org/display/FHIR/Using+the+FHIR+Validator#UsingtheFHIRValidator-VersionConversion" target="_blank" title="https://confluence.hl7.org/display/FHIR/Using+the+FHIR+Validator#UsingtheFHIRValidator-VersionConversion">https://confluence.hl7.org/display/FHIR/Using+the+FHIR+Validator#UsingtheFHIRValidator-VersionConversion</a> for new instructions</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
