---
layout: page
title: "FHIR Chat  · Rule Evaluation Order · mapping-framework"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/index.html">mapping-framework</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/Rule.20Evaluation.20Order.html">Rule Evaluation Order</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="171794689"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/Rule%20Evaluation%20Order/near/171794689" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Justin Pombrio <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/Rule.20Evaluation.20Order.html#171794689">(Jul 26 2019 at 18:02)</a>:</h4>
<p>In what order are rules applied?</p>
<p>The docs for R3 say "Rules in a group may be applied in any order; there is no sense of sequentially applying one rule after another.". But the docs for R4 don't say anything one way or the other, as far as I've seen.</p>
<p>This seems to me like a very important consideration. If I understand correctly, since fields on <code>target</code> can be overwritten (if it has arity 0..1, and you set it twice), the order that rules are applied can make a big difference: the second rule to be applied could overwrite the result of the first rule. And since rules can have <code>where</code> clauses, it may not be obvious whether two rules might clobber each other, or in what situations. So if the order in which rules are applied is unspecified, then rule authors must be careful not to write overlapping rules, or else the output of the mapping cannot be fully predicted. Is this right?</p>



<a name="171806433"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/Rule%20Evaluation%20Order/near/171806433" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/Rule.20Evaluation.20Order.html#171806433">(Jul 26 2019 at 20:10)</a>:</h4>
<p>yes</p>



<a name="171807612"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/Rule%20Evaluation%20Order/near/171807612" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Justin Pombrio <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/Rule.20Evaluation.20Order.html#171807612">(Jul 26 2019 at 20:28)</a>:</h4>
<p>Then I think the docs should say that the rule order is unspecified, and that it's up to rule authors to avoid overlapping rules. (I don't aim to give you a huge list of doc fix-me-ups. My previous comment about trees vs. DAGs is pretty minor. _This_, though, is I think a very important point.)</p>



<a name="171807923"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/Rule%20Evaluation%20Order/near/171807923" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/Rule.20Evaluation.20Order.html#171807923">(Jul 26 2019 at 20:33)</a>:</h4>
<p>can you create a task?</p>



<a name="171808788"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/Rule%20Evaluation%20Order/near/171808788" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Justin Pombrio <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/Rule.20Evaluation.20Order.html#171808788">(Jul 26 2019 at 20:47)</a>:</h4>
<p>I'll try!</p>



<a name="171950092"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/Rule%20Evaluation%20Order/near/171950092" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Justin Pombrio <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/Rule.20Evaluation.20Order.html#171950092">(Jul 29 2019 at 14:29)</a>:</h4>
<p>Submitted!</p>



<a name="171978949"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/Rule%20Evaluation%20Order/near/171978949" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Justin Pombrio <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/Rule.20Evaluation.20Order.html#171978949">(Jul 29 2019 at 20:07)</a>:</h4>
<p>On the same note, I want to strongly recommend that future versions of the mapping spec either (i) fix an order for rule application (first-to-last), or<br>
(ii) design the language in such a way that it can be statically verified whether rules overlap, and disallow overlapping rules. I'm scared by the prospect of health care data being improperly transformed due to subtle evaluation order issues.</p>



<a name="171981901"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/Rule%20Evaluation%20Order/near/171981901" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/Rule.20Evaluation.20Order.html#171981901">(Jul 29 2019 at 20:44)</a>:</h4>
<ul>
<li>we do not want to fix the order, else you cannot parallelise the processing. </li>
<li>I don't think there's any prospect of static verification</li>
<li>there's places where it's useful to not care about order</li>
</ul>



<a name="171981920"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/Rule%20Evaluation%20Order/near/171981920" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/Rule.20Evaluation.20Order.html#171981920">(Jul 29 2019 at 20:45)</a>:</h4>
<p><span class="user-mention" data-user-id="193934">@Keith Duddy</span></p>



<a name="171982207"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/Rule%20Evaluation%20Order/near/171982207" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Zautke <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/Rule.20Evaluation.20Order.html#171982207">(Jul 29 2019 at 20:49)</a>:</h4>
<p>For repeating elements you already have the list modes available, like 'first' and 'last'. So the you would only need to check for duplicate rules on non-repeating elements</p>



<a name="171982340"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/Rule%20Evaluation%20Order/near/171982340" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Zautke <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/Rule.20Evaluation.20Order.html#171982340">(Jul 29 2019 at 20:51)</a>:</h4>
<p>And if you really wanted to you could define a "guard" function in FHIRPath that does an "exist" check for you before applying a rule</p>



<a name="172028778"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/Rule%20Evaluation%20Order/near/172028778" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Keith Duddy <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/Rule.20Evaluation.20Order.html#172028778">(Jul 30 2019 at 11:36)</a>:</h4>
<p>Thanks for the @ mention Grahame, I've been distracted and haven't been following this topic. In the 3 model transformation projects that I've been involved with, the importance of "declarative" rather than "imperative" has been the key to the combination of rules and the ability of a transformation to be refined and added to. Think BASIC line  numbering vs function/procedure definition and invocation from anywhere. 3G language compilers/interpreters work out what needs to invoke what in which order, rather than just going from 10 to 20 [to 23 and then] to 30 and then GOTO &lt;somewhere&gt;. The transformation compiler/interpreter needs to deduce from the dependencies between the rules what needs to be executed before the rules on which it depends. </p>
<p>It's always possible to write contradictory rules, or unintentional overwriting of the same content determined by another rule -- in these cases the compiler/interpreter should alert you to the rules that are inconsistent, and refuse to execute until you write a coherent set of rules that work together, rather than just producing a mish-mash output that seems to do what you specify, but in fact is arbitrarily creating bad outputs from your input. </p>
<p>...|&lt;</p>



<a name="172028908"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/Rule%20Evaluation%20Order/near/172028908" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Keith Duddy <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/Rule.20Evaluation.20Order.html#172028908">(Jul 30 2019 at 11:38)</a>:</h4>
<p>Or you can just write XSLT transforms on the XML serialisation of FHIR if you want _that_ kind of transformation language....</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
