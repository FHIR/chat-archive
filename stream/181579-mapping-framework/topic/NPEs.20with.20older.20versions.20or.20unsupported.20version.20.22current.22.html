---
layout: page
title: "FHIR Chat  · NPEs with older versions or unsupported version &quot;current&quot; · mapping-framework"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/index.html">mapping-framework</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/NPEs.20with.20older.20versions.20or.20unsupported.20version.20.22current.22.html">NPEs with older versions or unsupported version &quot;current&quot;</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="184473174"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/NPEs%20with%20older%20versions%20or%20unsupported%20version%20%22current%22/near/184473174" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harrison Tarr <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/NPEs.20with.20older.20versions.20or.20unsupported.20version.20.22current.22.html#184473174">(Dec 30 2019 at 13:41)</a>:</h4>
<p>Hi all,<br>
i'm trying to learn and play with the fhir mapping language. i'm using the resources in <br>
<a href="https://www.hl7.org/fhir/mapping-tutorial.html" target="_blank" title="https://www.hl7.org/fhir/mapping-tutorial.html">https://www.hl7.org/fhir/mapping-tutorial.html</a><br>
<a href="https://wiki.hl7.org/index.php?title=Using_the_FHIR_Mapping_Language" target="_blank" title="https://wiki.hl7.org/index.php?title=Using_the_FHIR_Mapping_Language">https://wiki.hl7.org/index.php?title=Using_the_FHIR_Mapping_Language</a><br>
<a href="https://www.devdays.com/wp-content/uploads/2018/06/DD18-US-R4-Mapping-Language-Grahame-Grieve-2018-06-21.pdf" target="_blank" title="https://www.devdays.com/wp-content/uploads/2018/06/DD18-US-R4-Mapping-Language-Grahame-Grieve-2018-06-21.pdf">https://www.devdays.com/wp-content/uploads/2018/06/DD18-US-R4-Mapping-Language-Grahame-Grieve-2018-06-21.pdf</a> and <br>
<a href="https://github.com/ahdis/fhir-mapping-tutorial" target="_blank" title="https://github.com/ahdis/fhir-mapping-tutorial">https://github.com/ahdis/fhir-mapping-tutorial</a></p>
<p>i'm trying to use the command line jar to take in a source XML file, like in the tutorial example step 1, and convert it to the TRight format. i used implemented resource files for the TLeft and TRight structure defs and the map from the github link. I had to make some updates to the SDs and the map - it seems they were made for an older format? i noticed some differences between the hl7 documentation and the PDF / github. </p>
<p>my current issue is that i'm running into an inevitable NPE when trying to use version 3.0 or 4.0:<br>
lines 844 or 855 of the <code>ValidatorEngine</code> (3.0 / 4.0 respectively) are </p>
<div class="codehilite"><pre><span></span>        res = new org.hl7.fhir.dstu3.utils.StructureMapUtilities(null).parse(new String(content));
        res = new org.hl7.fhir.r4.utils.StructureMapUtilities(null).parse(new String(content), fn);
</pre></div>


<p>then later in the StructureMapUtilities constructor, it attempts to call a method on the null and it throws an NPE.<br>
I noticed that the current version if statement uses different parse logic:</p>
<div class="codehilite"><pre><span></span>        r = new StructureMapUtilities(context, null, null).parse(TextFile.bytesToString(content), fn);
</pre></div>


<p>however, i can't figure out how to get into that if-block, since it checks for equality to <code>4.1</code> but the version variable is always set to <code>"current"</code> at that point. </p>
<p>any assistance or add'l resources would be super helpful!</p>



<a name="184473354"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/NPEs%20with%20older%20versions%20or%20unsupported%20version%20%22current%22/near/184473354" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harrison Tarr <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/NPEs.20with.20older.20versions.20or.20unsupported.20version.20.22current.22.html#184473354">(Dec 30 2019 at 13:43)</a>:</h4>
<p><a href="/user_uploads/10155/xsMyK8XxIl8qWp-HdYaJKVK4/structuredefinition-tright.xml" target="_blank" title="structuredefinition-tright.xml">structuredefinition-tright.xml</a> <a href="/user_uploads/10155/6inDIelDKoDBk2yGPKmZyrd0/structuredefinition-tleft.xml" target="_blank" title="structuredefinition-tleft.xml">structuredefinition-tleft.xml</a> <a href="/user_uploads/10155/gJgb5tvsxybbur8_iM-XLuye/step1.map" target="_blank" title="step1.map">step1.map</a> </p>
<p>i've attached my edited versions of the structure documents and map</p>



<a name="184533946"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/NPEs%20with%20older%20versions%20or%20unsupported%20version%20%22current%22/near/184533946" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Hay <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/NPEs.20with.20older.20versions.20or.20unsupported.20version.20.22current.22.html#184533946">(Dec 31 2019 at 09:19)</a>:</h4>
<p>Hi Harrison - take a look at <a href="https://fhirblog.com/2019/12/20/making-a-transaction-bundle-using-the-mapping-language/" target="_blank" title="https://fhirblog.com/2019/12/20/making-a-transaction-bundle-using-the-mapping-language/">https://fhirblog.com/2019/12/20/making-a-transaction-bundle-using-the-mapping-language/</a> and the prior post it references. That might help you (I'm learning too :) )</p>



<a name="184739209"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/NPEs%20with%20older%20versions%20or%20unsupported%20version%20%22current%22/near/184739209" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/NPEs.20with.20older.20versions.20or.20unsupported.20version.20.22current.22.html#184739209">(Jan 03 2020 at 14:54)</a>:</h4>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span></p>



<a name="184863578"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/NPEs%20with%20older%20versions%20or%20unsupported%20version%20%22current%22/near/184863578" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oliver Egger <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/NPEs.20with.20older.20versions.20or.20unsupported.20version.20.22current.22.html#184863578">(Jan 05 2020 at 20:33)</a>:</h4>
<p><span class="user-mention" data-user-id="246988">@Harrison Tarr</span> : the ahdis repo you were referring to was based on STU3, the maps and structuredefinitions have been now updated to R4, thanks for your  notice. To use the maps with the java validator you need currently a patched version <a href="https://github.com/ahdis/org.hl7.fhir.core/releases/download/4.1.38-dev/org.hl7.fhir.validation.cli-4.1.38-SNAPSHOT.jar" target="_blank" title="https://github.com/ahdis/org.hl7.fhir.core/releases/download/4.1.38-dev/org.hl7.fhir.validation.cli-4.1.38-SNAPSHOT.jar">https://github.com/ahdis/org.hl7.fhir.core/releases/download/4.1.38-dev/org.hl7.fhir.validation.cli-4.1.38-SNAPSHOT.jar</a>, otherwise the maps cannot be loaded, I need to provide a pull reqeuest for this.</p>



<a name="184863712"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/NPEs%20with%20older%20versions%20or%20unsupported%20version%20%22current%22/near/184863712" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oliver Egger <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/NPEs.20with.20older.20versions.20or.20unsupported.20version.20.22current.22.html#184863712">(Jan 05 2020 at 20:36)</a>:</h4>
<p>The validator uses the r5.StructureMapUtilities, how you do end up in dstu3 or r4 NPE's?</p>



<a name="185135407"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/NPEs%20with%20older%20versions%20or%20unsupported%20version%20%22current%22/near/185135407" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harrison Tarr <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/NPEs.20with.20older.20versions.20or.20unsupported.20version.20.22current.22.html#185135407">(Jan 08 2020 at 17:22)</a>:</h4>
<p><span class="user-mention" data-user-id="191478">@Oliver Egger</span> <br>
when i run it with the jar you provided, i get this output:</p>
<div class="codehilite"><pre><span></span> .. FHIR Version current, definitions from hl7.fhir.r5.core#current
  .. connect to tx server @ http://tx.fhir.org
    (vcurrent)
+  .. load IG from /Users/harrison/projects/helios/fhir-mapping-tutorial/maptutorial/step1/logical/
* load file: structuredefinition-tright.xml - ignored due to error: Unsupported version current
* load file: structuredefinition-tleft.xml - ignored due to error: Unsupported version current
+  .. load IG from /Users/harrison/projects/helios/fhir-mapping-tutorial/maptutorial/step1/map/step1.map
* load file: /Users/harrison/projects/helios/fhir-mapping-tutorial/maptutorial/step1/map/step1.map - ignored due to error: Unsupported version current
 ...Failure: This does not appear to be a FHIR resource (unknown namespace/name &#39;http://hl7.org/fhir/tutorial::TLeft&#39;) at line 0 col 0
org.hl7.fhir.exceptions.FHIRFormatError: This does not appear to be a FHIR resource (unknown namespace/name &#39;http://hl7.org/fhir/tutorial::TLeft&#39;) at line 0 col 0
    at org.hl7.fhir.r5.elementmodel.ParserBase.logError(ParserBase.java:88)
    at org.hl7.fhir.r5.elementmodel.ParserBase.getDefinition(ParserBase.java:110)
    at org.hl7.fhir.r5.elementmodel.XmlParser.parse(XmlParser.java:171)
    at org.hl7.fhir.r5.elementmodel.XmlParser.parse(XmlParser.java:163)
    at org.hl7.fhir.r5.elementmodel.XmlParser.parse(XmlParser.java:135)
    at org.hl7.fhir.r5.elementmodel.Manager.parse(Manager.java:78)
    at org.hl7.fhir.r5.validation.ValidationEngine.transform(ValidationEngine.java:1229)
    at org.hl7.fhir.r5.validation.ValidationEngine.transform(ValidationEngine.java:1222)
    at org.hl7.fhir.r5.validation.Validator.main(Validator.java:592)
</pre></div>


<p>i think that's caused by the second error i mentioned above, where it interprets the version as "current" but then tries to compare it to "4.1". this is still using the same SD and map file that i provided above</p>



<a name="185140676"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/NPEs%20with%20older%20versions%20or%20unsupported%20version%20%22current%22/near/185140676" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oliver Egger <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/NPEs.20with.20older.20versions.20or.20unsupported.20version.20.22current.22.html#185140676">(Jan 08 2020 at 18:17)</a>:</h4>
<p>please try with the updated structuredefintions and map in the repo, they had all to be adjusted.</p>



<a name="185151607"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/NPEs%20with%20older%20versions%20or%20unsupported%20version%20%22current%22/near/185151607" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harrison Tarr <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/NPEs.20with.20older.20versions.20or.20unsupported.20version.20.22current.22.html#185151607">(Jan 08 2020 at 20:08)</a>:</h4>
<p><span class="user-mention" data-user-id="191478">@Oliver Egger</span> fantastic! i just pulled and reran according to the instructions and step 1 worked! i see that according to the readme some of the following steps fail, is that because of missing support in the jar or something else? <br>
in any case, thank you so much for your help!</p>



<a name="185154526"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/181579-mapping-framework/topic/NPEs%20with%20older%20versions%20or%20unsupported%20version%20%22current%22/near/185154526" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oliver Egger <a href="https://fhir.github.io/chat-archive/stream/181579-mapping-framework/topic/NPEs.20with.20older.20versions.20or.20unsupported.20version.20.22current.22.html#185154526">(Jan 08 2020 at 20:42)</a>:</h4>
<p><span class="user-mention" data-user-id="246988">@Harrison Tarr</span>  glad that it works. some of the steps fail because the java mapping language implementation does not work with the map provided for the fhir tutorial. as i am also learning to work with the fhir mapping language I did not yet check if its an issued in the tutorial or in the fhir mapping language implementation, the jar is just the same as the validator, just a different branch with a few commits ahead and behind, see <a href="https://github.com/ahdis/org.hl7.fhir.core" target="_blank" title="https://github.com/ahdis/org.hl7.fhir.core">https://github.com/ahdis/org.hl7.fhir.core</a></p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
