---
layout: page
title: "FHIR Chat  · Nested Sections Bug · cimpl"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/197290-cimpl/index.html">cimpl</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/197290-cimpl/topic/Nested.20Sections.20Bug.html">Nested Sections Bug</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="171037268"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/197290-cimpl/topic/Nested%20Sections%20Bug/near/171037268" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kurt Allen <a href="https://fhir.github.io/chat-archive/stream/197290-cimpl/topic/Nested.20Sections.20Bug.html#171037268">(Jul 16 2019 at 23:53)</a>:</h4>
<p>Hello <span class="user-mention" data-user-id="191469">@Chris Moesel</span>  and <span class="user-mention" data-user-id="191447">@Mark Kramer</span> <br>
I think there may be a bug in how nested Composition sections are handled. I create a section called "Findings", and then create two sections under findings (Left Breast Finding" and "Right Breast Finding". Finding gets created correctly, but it looks like the sub sections never get created, and Findings.Section is not sliced for left and right. Could this have anything to do with my mapping? I have attached the CIMPL and map file.<br>
Alternately, you can grab the whole project at <br>
<a href="https://github.com/applicadia/Fhir-BreastRadiologyReport" target="_blank" title="https://github.com/applicadia/Fhir-BreastRadiologyReport">https://github.com/applicadia/Fhir-BreastRadiologyReport</a><br>
Thanks!<br>
Kurt A.</p>
<p><a href="/user_uploads/10155/L0mo1vmhmOwoAVNp3bf8oRkJ/BreastRadiologyDocument.txt" target="_blank" title="BreastRadiologyDocument.txt">BreastRadiologyDocument.txt</a> <a href="/user_uploads/10155/nr6ZvGd_4c54SpHSZvDYKLQc/BreastRadiologyDocument_map.txt" target="_blank" title="BreastRadiologyDocument_map.txt">BreastRadiologyDocument_map.txt</a><br>
<a href="user_uploads/10155/eQepznJ5AVhvF-CiZ3s2BRkz/structuredefinition-breastrad-BreastRadiologyDocument-extension.json" target="_blank" title="user_uploads/10155/eQepznJ5AVhvF-CiZ3s2BRkz/structuredefinition-breastrad-BreastRadiologyDocument-extension.json">structuredefinition-breastrad-BreastRadiologyDocument-extension.json</a><br>
<a href="user_uploads/10155/4Mk5-EPyUYtNqQygYNC4WKFo/structuredefinition-breastrad-BreastRadiologyDocument.json" target="_blank" title="user_uploads/10155/4Mk5-EPyUYtNqQygYNC4WKFo/structuredefinition-breastrad-BreastRadiologyDocument.json">structuredefinition-breastrad-BreastRadiologyDocument.json</a></p>



<a name="171081604"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/197290-cimpl/topic/Nested%20Sections%20Bug/near/171081604" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/197290-cimpl/topic/Nested.20Sections.20Bug.html#171081604">(Jul 17 2019 at 14:09)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="192611">@Kurt Allen</span> </p>
<p>The mapping for composition is missing a slicing directive for <code>section</code>.  If you look at the <code>Composition</code> mapping in  <code>obf_foundation_map_r4.txt</code>, you need to change the line that maps <code>section</code> to this:</p>
<div class="codehilite"><pre><span></span>Section maps to section (slice on = code; slice strategy = includes)
</pre></div>


<p>This will tell it to slice sections using <code>code</code> as the differentiator -- and that the CIMPL <code>includes</code> constraint defines what the slices are.</p>
<p>Note that the latest mappings in our shr_spec <a href="https://github.com/standardhealth/shr_spec/tree/dev6" target="_blank" title="https://github.com/standardhealth/shr_spec/tree/dev6">dev6</a> branch already contain this fix <a href="https://github.com/standardhealth/shr_spec/blob/4f055c0b1c050532871cde7aad5847960377feba/spec/obf_foundation_map_r4.txt#L39" target="_blank" title="https://github.com/standardhealth/shr_spec/blob/4f055c0b1c050532871cde7aad5847960377feba/spec/obf_foundation_map_r4.txt#L39">here</a> and also contain some other fixes that may benefit you (for example, fixes to invalid value sets that get reported in the IG qa.html).  If possible, you may want to consider updating all of the definitions you copied over from us (like obf, shr.core, etc) so you can benefit from our recent updates.</p>
<p>After applying the mapping change above, I found that your <code>BreastRadiologyReport</code> seemed more like you would expect.  Here's a partial screenshot of the results:</p>
<p><a href="/user_uploads/10155/mz97Tjo8nEGaNHmsOE8Z30NH/pasted_image.png" target="_blank" title="pasted_image.png">pasted image</a></p>
<div class="message_inline_image"><a href="/user_uploads/10155/mz97Tjo8nEGaNHmsOE8Z30NH/pasted_image.png" target="_blank" title="pasted image"><img src="/user_uploads/10155/mz97Tjo8nEGaNHmsOE8Z30NH/pasted_image.png"></a></div>



<a name="171098046"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/197290-cimpl/topic/Nested%20Sections%20Bug/near/171098046" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kurt Allen <a href="https://fhir.github.io/chat-archive/stream/197290-cimpl/topic/Nested.20Sections.20Bug.html#171098046">(Jul 17 2019 at 17:25)</a>:</h4>
<p>Yo <span class="user-mention" data-user-id="191469">@Chris Moesel</span> <br>
I must be doing something wrong here. I got the latest shr-spec from git, copied it over and deleted the deprecated*.txt files (they caused compile errors), rebuilt shr-cli (6.2.2 #219)  and reran everything. </p>
<p>I get a findings section, but no FindingsLeftBreast or FindingsRightBreast.<br>
Attached is the html file, and the git hub repo is up to date (development branch).</p>
<p>Also, FYI: I tried getting 6.3, but had compile errors in the shr-spec files. I see that you tightened type checking (yah!!!) and some of the shr-spec files had some issues. 6.3 showed me some errors in my code that I needed to clean up,so kudos on 6.3, but shr-spec probably needs some attention.</p>
<p>Any ideas?</p>
<p>Best,<br>
Kurt A.</p>
<p><a href="/user_uploads/10155/R7XY7Jx5eoOuhcEzSIxEqB8U/Breast-Radiology-Reporting.html" target="_blank" title="Breast-Radiology-Reporting.html">Breast-Radiology-Reporting.html</a></p>



<a name="171101085"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/197290-cimpl/topic/Nested%20Sections%20Bug/near/171101085" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/197290-cimpl/topic/Nested.20Sections.20Bug.html#171101085">(Jul 17 2019 at 17:50)</a>:</h4>
<p>Hi Kurt.  Yes, 6.3 was just released today and the spec team is catching up on fixing some of the type inconsistencies it brings to light.  I expect the fixes will be pushed to shr_spec soon.</p>
<p>As for the continued issue w/ the Findings, I'll take a look.  I'm not sure why you'd get something different than I get.</p>



<a name="171102925"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/197290-cimpl/topic/Nested%20Sections%20Bug/near/171102925" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kurt Allen <a href="https://fhir.github.io/chat-archive/stream/197290-cimpl/topic/Nested.20Sections.20Bug.html#171102925">(Jul 17 2019 at 18:08)</a>:</h4>
<p>thx</p>



<a name="171103963"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/197290-cimpl/topic/Nested%20Sections%20Bug/near/171103963" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/197290-cimpl/topic/Nested.20Sections.20Bug.html#171103963">(Jul 17 2019 at 18:19)</a>:</h4>
<p>Oh... I see now.  You're using sub-sections.  In the <code>master</code> branch (that I originally tested with), <code>FindingsLeftBreast</code> and <code>FindingsRightBreast</code> were in the top-level sections.  But I see here that you are now employing nested sections, so <code>Findings</code> is the top-level section and the left/right breast findings are a nested section within that.</p>
<p>Hopefully we can support that!  It will require at least some additional mapping...  I'm working on it -- but if you don't hear from me for a while it's because I'm currently in an airport and due to board soon.</p>



<a name="171104406"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/197290-cimpl/topic/Nested%20Sections%20Bug/near/171104406" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/197290-cimpl/topic/Nested.20Sections.20Bug.html#171104406">(Jul 17 2019 at 18:24)</a>:</h4>
<p>OK.  It looks like I got it to work.  I'm assuming you don't want to modify the files that we (the SHR team) provide, so... you can update the specific <code>BreastRadiologyDocument</code> mapping to be this:</p>
<div class="codehilite"><pre><span></span>Grammar: Map 6.0
Namespace: breastrad
Target: FHIR_R4

BreastRadiologyDocument maps to Composition:
    Section.Section maps to section.section (slice on = code; slice strategy = includes)
    Section.Section.Title maps to section.section.title
    Section.Section.Code maps to section.section.code
    Section.Section.Author maps to section.section.author
    Section.Section.FocalSubject maps to section.section.focus
    Section.Section.Narrative maps to section.section.text
    Section.Section.Type maps to section.section.mode
    Section.Section.SortOrder maps to section.section.orderedBy // terrible FHIR name!
    Section.Section.DomainResource maps to section.section.entry  (slice on = reference.resolve(); slice on type = profile; slice strategy = includes)
    Section.Section.EmptyReason maps to section.section.emptyReason
    Section.Section.Section maps to section.section.section
</pre></div>


<p>You can see that I essentially just mapped one more level down.  You'd need to continue to do that for each level of section you need.  We probably need to figure out a way to define recursive mapping statements!   Anyway, that worked for me.  Hopefully it will work for you too!</p>



<a name="171104439"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/197290-cimpl/topic/Nested%20Sections%20Bug/near/171104439" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/197290-cimpl/topic/Nested.20Sections.20Bug.html#171104439">(Jul 17 2019 at 18:25)</a>:</h4>
<p>(FYI -- it inherits all the other mappings from the parent mapping, which is why I just have the new mappings defined above)</p>



<a name="171104450"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/197290-cimpl/topic/Nested%20Sections%20Bug/near/171104450" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/197290-cimpl/topic/Nested.20Sections.20Bug.html#171104450">(Jul 17 2019 at 18:25)</a>:</h4>
<p>Gotta get on my plane.  Good luck!</p>



<a name="171114635"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/197290-cimpl/topic/Nested%20Sections%20Bug/near/171114635" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kurt Allen <a href="https://fhir.github.io/chat-archive/stream/197290-cimpl/topic/Nested.20Sections.20Bug.html#171114635">(Jul 17 2019 at 20:29)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="191469">@Chris Moesel</span> </p>
<p>Looks like that worked. <br>
This approach might get cumbersome if nesting gets very deep. I wonder if you don't need to add some form of mapping resource fragments like</p>
<p>BreastRadiologyDocument.Section maps to Composition.section:<br>
...</p>
<p>and then this mapping could be applied recursively to itself unless explicitly overruled in a specific rule for a specific nested element.</p>
<p>(i.e. BreastRadiologyDocument.Section.Section, BreastRadiologyDocument.Section.Section.Section, ... would all have BreastRadiologyDocument.Section applied to them since they are all BreastRadiologyDocument.Section's)</p>
<p>Just a thought.</p>
<p>Anyways, this item is fixed and many thanks. Hope your flite is extremely uneventful and that you are  flying somewhere fun!</p>
<p>Best,<br>
Kurt A</p>



<a name="171123900"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/197290-cimpl/topic/Nested%20Sections%20Bug/near/171123900" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/197290-cimpl/topic/Nested.20Sections.20Bug.html#171123900">(Jul 17 2019 at 22:48)</a>:</h4>
<p>Yeah, I was thinking maybe something along those same lines.  We'd have to think on it a bit more...  We're also considering a significant rewrite of the mapping language -- so maybe a new grammar would lend itself to a more obvious solution as well.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
