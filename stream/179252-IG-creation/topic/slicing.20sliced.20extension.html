---
layout: page
title: "FHIR Chat  · slicing sliced extension · IG creation"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/index.html">IG creation</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html">slicing sliced extension</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="263848712"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263848712" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263848712">(Dec 06 2021 at 13:24)</a>:</h4>
<p>I have explained a slicing problem I am having over on the sushi stream<br>
<a href="#narrow/stream/215610-shorthand/topic/slicing.20an.20extension.20on.20a.20slice">https://chat.fhir.org/#narrow/stream/215610-shorthand/topic/slicing.20an.20extension.20on.20a.20slice</a><br>
I started on the sushi stream because I initially was worried I was not using sushi right. <br>
I am not having trouble with sushi, but rather the validation in the IG build.  <br>
Specifically my examples are failing validation, but I have checked the error message and looked at the JSON created by sushi. I can't figure out what I have done wrong.</p>
<div class="codehilite"><pre><span></span><code>Slicing cannot be evaluated: Could not match discriminator ([url]) for slice AuditEvent.agent:user.extension:otherId/subject-id in profile http://profiles.ihe.net/ITI/BasicAudit/StructureDefinition/ITI.BasicAudit.SAMLaccessTokenUse.Comprehensive.Norway - the discriminator [url] does not have fixed value, binding or existence assertions
</code></pre></div>
<p>my github repo - <a href="https://github.com/IHE/ITI.BasicAudit">https://github.com/IHE/ITI.BasicAudit</a></p>



<a name="263849021"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263849021" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263849021">(Dec 06 2021 at 13:26)</a>:</h4>
<p>the specifics of the error</p>
<div class="codehilite"><pre><span></span><code>- the discriminator [url] does not have fixed value, binding or existence assertions
</code></pre></div>
<p>Yet, I definitely have a fixed code in my example</p>
<div class="codehilite"><pre><span></span><code>        {
          &quot;url&quot; : &quot;http://profiles.ihe.net/ITI/BasicAudit/StructureDefinition/ihe-otherId&quot;,
          &quot;valueReference&quot; : {
            &quot;identifier&quot; : {
              &quot;type&quot; : {
                &quot;coding&quot; : [
                  {
                    &quot;system&quot; : &quot;http://profiles.ihe.net/ITI/BasicAudit/CodeSystem/OtherIdentifierTypes&quot;,
                    &quot;code&quot; : &quot;SAML-subject-id&quot;
                  }
                ]
              },
              &quot;value&quot; : &quot;JohnDoe&quot;
            }
          }
</code></pre></div>



<a name="263856772"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263856772" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263856772">(Dec 06 2021 at 14:26)</a>:</h4>
<p>It's not complaining about the example, it's complaining about the profile.</p>



<a name="263859803"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263859803" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263859803">(Dec 06 2021 at 14:47)</a>:</h4>
<p>I seek only to make IG builder happy... so, what ever it takes</p>



<a name="263865641"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263865641" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263865641">(Dec 06 2021 at 15:24)</a>:</h4>
<p>Check the profile for fixed values for the URL.</p>



<a name="263901937"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263901937" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263901937">(Dec 06 2021 at 19:21)</a>:</h4>
<p>im not sure which URL is in question. Here is the fragment from the JSON created by sushi</p>
<div class="codehilite"><pre><span></span><code>      {
        &quot;id&quot; : &quot;AuditEvent.agent:user.extension:otherId/subject-id&quot;,
        &quot;path&quot; : &quot;AuditEvent.agent.extension&quot;,
        &quot;sliceName&quot; : &quot;otherId/subject-id&quot;,
        &quot;short&quot; : &quot;Extension&quot;,
</code></pre></div>
<p>is that "id" what is being refered to as a URL?</p>



<a name="263902391"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263902391" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263902391">(Dec 06 2021 at 19:23)</a>:</h4>
<p>Here is the Profile that this error is coming from <br>
<a href="http://build.fhir.org/ig/IHE/ITI.BasicAudit/branches/main/StructureDefinition-ITI.BasicAudit.SAMLaccessTokenUse.Comprehensive.html">http://build.fhir.org/ig/IHE/ITI.BasicAudit/branches/main/StructureDefinition-ITI.BasicAudit.SAMLaccessTokenUse.Comprehensive.html</a></p>



<a name="263904049"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263904049" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263904049">(Dec 06 2021 at 19:29)</a>:</h4>
<p>Im getting lots of similar errors. so I fully expect I am not doing something right.  but others are indicating that my sushi seems to be written rigtht... so I thus want to dig deeper into the json that sushi creates to see if it is not doing something right.</p>



<a name="263915578"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263915578" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263915578">(Dec 06 2021 at 20:09)</a>:</h4>
<p>I'll take a look at it as well to see if anything jumps out at me.</p>



<a name="263917650"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263917650" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263917650">(Dec 06 2021 at 20:16)</a>:</h4>
<p>It looks to me like it might be an issue with the snapshot generator.  Here's what we have in the differential for the otherId extension element and its subject-id reslice:</p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code>      <span class="p">{</span>
        <span class="nt">"id"</span> <span class="p">:</span> <span class="s2">"AuditEvent.agent:user.extension:otherId"</span><span class="p">,</span>
        <span class="nt">"path"</span> <span class="p">:</span> <span class="s2">"AuditEvent.agent.extension"</span><span class="p">,</span>
        <span class="nt">"sliceName"</span> <span class="p">:</span> <span class="s2">"otherId"</span><span class="p">,</span>
        <span class="nt">"slicing"</span> <span class="p">:</span> <span class="p">{</span>
          <span class="nt">"discriminator"</span> <span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="nt">"type"</span> <span class="p">:</span> <span class="s2">"pattern"</span><span class="p">,</span>
              <span class="nt">"path"</span> <span class="p">:</span> <span class="s2">"valueReference.identifier.type"</span>
            <span class="p">}</span>
          <span class="p">],</span>
          <span class="nt">"rules"</span> <span class="p">:</span> <span class="s2">"open"</span>
        <span class="p">},</span>
        <span class="nt">"min"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nt">"max"</span> <span class="p">:</span> <span class="s2">"*"</span><span class="p">,</span>
        <span class="nt">"type"</span> <span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="nt">"code"</span> <span class="p">:</span> <span class="s2">"Extension"</span><span class="p">,</span>
            <span class="nt">"profile"</span> <span class="p">:</span> <span class="p">[</span>
              <span class="s2">"http://profiles.ihe.net/ITI/BasicAudit/StructureDefinition/ihe-otherId"</span>
            <span class="p">]</span>
          <span class="p">}</span>
        <span class="p">],</span>
        <span class="nt">"mustSupport"</span> <span class="p">:</span> <span class="kc">true</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nt">"id"</span> <span class="p">:</span> <span class="s2">"AuditEvent.agent:user.extension:otherId/subject-id"</span><span class="p">,</span>
        <span class="nt">"path"</span> <span class="p">:</span> <span class="s2">"AuditEvent.agent.extension"</span><span class="p">,</span>
        <span class="nt">"sliceName"</span> <span class="p">:</span> <span class="s2">"otherId/subject-id"</span><span class="p">,</span>
        <span class="nt">"min"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nt">"max"</span> <span class="p">:</span> <span class="s2">"1"</span>
      <span class="p">}</span>
</code></pre></div>
<p><em>(Note that for brevity I've left out the elements that set the value reference)</em></p>



<a name="263919204"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263919204" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263919204">(Dec 06 2021 at 20:21)</a>:</h4>
<p>But when the snapshot gets generated, the <code>subject-id</code> reslice gets the plain <code>Extension</code> type instead of the <code>http://profiles.ihe.net/ITI/BasicAudit/StructureDefinition/ihe-otherId</code> extension type it should be inheriting from the slice base:</p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code>    <span class="p">{</span>
        <span class="nt">"id"</span> <span class="p">:</span> <span class="s2">"AuditEvent.agent:user.extension:otherId/subject-id"</span><span class="p">,</span>
        <span class="nt">"path"</span> <span class="p">:</span> <span class="s2">"AuditEvent.agent.extension"</span><span class="p">,</span>
        <span class="nt">"sliceName"</span> <span class="p">:</span> <span class="s2">"otherId/subject-id"</span><span class="p">,</span>
        <span class="nt">"short"</span> <span class="p">:</span> <span class="s2">"Extension"</span><span class="p">,</span>
        <span class="nt">"definition"</span> <span class="p">:</span> <span class="s2">"An Extension"</span><span class="p">,</span>
        <span class="nt">"min"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nt">"max"</span> <span class="p">:</span> <span class="s2">"1"</span><span class="p">,</span>
        <span class="nt">"base"</span> <span class="p">:</span> <span class="p">{</span>
          <span class="nt">"path"</span> <span class="p">:</span> <span class="s2">"Element.extension"</span><span class="p">,</span>
          <span class="nt">"min"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
          <span class="nt">"max"</span> <span class="p">:</span> <span class="s2">"*"</span>
        <span class="p">},</span>
        <span class="nt">"type"</span> <span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="nt">"code"</span> <span class="p">:</span> <span class="s2">"Extension"</span>
          <span class="p">}</span>
        <span class="p">],</span>
        <span class="nt">"constraint"</span> <span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="nt">"key"</span> <span class="p">:</span> <span class="s2">"ele-1"</span><span class="p">,</span>
            <span class="nt">"severity"</span> <span class="p">:</span> <span class="s2">"error"</span><span class="p">,</span>
            <span class="nt">"human"</span> <span class="p">:</span> <span class="s2">"All FHIR elements must have a @value or children"</span><span class="p">,</span>
            <span class="nt">"expression"</span> <span class="p">:</span> <span class="s2">"hasValue() or (children().count() &gt; id.count())"</span><span class="p">,</span>
            <span class="nt">"xpath"</span> <span class="p">:</span> <span class="s2">"@value|f:*|h:div"</span><span class="p">,</span>
            <span class="nt">"source"</span> <span class="p">:</span> <span class="s2">"http://hl7.org/fhir/StructureDefinition/Element"</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="nt">"key"</span> <span class="p">:</span> <span class="s2">"ext-1"</span><span class="p">,</span>
            <span class="nt">"severity"</span> <span class="p">:</span> <span class="s2">"error"</span><span class="p">,</span>
            <span class="nt">"human"</span> <span class="p">:</span> <span class="s2">"Must have either extensions or value[x], not both"</span><span class="p">,</span>
            <span class="nt">"expression"</span> <span class="p">:</span> <span class="s2">"extension.exists() != value.exists()"</span><span class="p">,</span>
            <span class="nt">"xpath"</span> <span class="p">:</span> <span class="s2">"exists(f:extension)!=exists(f:*[starts-with(local-name(.), \"value\")])"</span><span class="p">,</span>
            <span class="nt">"source"</span> <span class="p">:</span> <span class="s2">"http://hl7.org/fhir/StructureDefinition/Extension"</span>
          <span class="p">}</span>
        <span class="p">],</span>
        <span class="nt">"isModifier"</span> <span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nt">"isSummary"</span> <span class="p">:</span> <span class="kc">false</span>
      <span class="p">}</span>
</code></pre></div>
<p>Furthermore, when the snapshot drills into the <code>subject-id</code> reslice, it doesn't fix the <code>uri</code> in the <code>AuditEvent.agent:user.extension:otherId/subject-id.url</code> element, presumably because it is creating those elements based off <code>Extension</code> when it <em>should</em> be creating them based off the elements in the <code>http://profiles.ihe.net/ITI/BasicAudit/StructureDefinition/ihe-otherId</code> extension.</p>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span> - is this a known limitation of the snapshot generator?</p>



<a name="263919760"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263919760" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263919760">(Dec 06 2021 at 20:24)</a>:</h4>
<p>BTW -- I also agree w/ what <span class="user-mention" data-user-id="192166">@Jean Duteau</span> noted in the corresponding thread in the <a class="stream" data-stream-id="215610" href="/#narrow/stream/215610-shorthand">#shorthand</a> channel, which is that the discriminator also needs to be updated to <code>value.identifier.type</code> or <code>(value as Reference).identifier.type</code> since <code>valueReference</code> is not a valid path in FHIRPath.</p>



<a name="263920572"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263920572" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263920572">(Dec 06 2021 at 20:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="191469">Chris Moesel</span> <a href="#narrow/stream/179252-IG-creation/topic/slicing.20sliced.20extension/near/263919760">said</a>:</p>
<blockquote>
<p>BTW -- I also agree w/ what <span class="user-mention silent" data-user-id="192166">Jean Duteau</span> noted in the corresponding thread in the <a class="stream" data-stream-id="215610" href="/#narrow/stream/215610-shorthand">#shorthand</a> channel, which is that the discriminator also needs to be updated to <code>value.identifier.type</code> or <code>(value as Reference).identifier.type</code> since <code>valueReference</code> is not a valid path in FHIRPath.</p>
</blockquote>
<p>I can try,  sushi does not like either of those suggestions.</p>



<a name="263920791"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263920791" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263920791">(Dec 06 2021 at 20:34)</a>:</h4>
<p>this is what I have</p>
<div class="codehilite"><pre><span></span><code>* agent[user].extension[otherId][subject-id].valueReference.identifier.type = OtherIdentifierTypes#SAML-subject-id
</code></pre></div>
<p>what do you recommend I try?</p>



<a name="263921273"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263921273" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263921273">(Dec 06 2021 at 20:38)</a>:</h4>
<p><span class="user-mention" data-user-id="191404">@John Moehrke</span> -- I'm talking about the discriminator path only.  E.g., you probably have some FSH something like this:</p>
<div class="codehilite"><pre><span></span><code>* agent[user].extension[otherId] ^slicing.discriminator.path = &quot;valueReference.identifier.type&quot;
</code></pre></div>
<p>But that needs to be this:</p>
<div class="codehilite"><pre><span></span><code>* agent[user].extension[otherId] ^slicing.discriminator.path = &quot;value.identifier.type&quot;
</code></pre></div>
<p>or this:</p>
<div class="codehilite"><pre><span></span><code>* agent[user].extension[otherId] ^slicing.discriminator.path = &quot;(value as Reference).identifier.type&quot;
</code></pre></div>



<a name="263921603"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263921603" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263921603">(Dec 06 2021 at 20:41)</a>:</h4>
<p>ah, I tried the second, and sushi passed. Ill run that thru</p>



<a name="263922379"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263922379" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263922379">(Dec 06 2021 at 20:48)</a>:</h4>
<p>that built, but did not change the result</p>



<a name="263922899"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263922899" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263922899">(Dec 06 2021 at 20:53)</a>:</h4>
<p>I do have a more simple one that is equally failing. This one is not doing anything with an extension. it is just slicing a slice. The first slice defines .entity[consent]; this second slice within that first one.. This is also just a #value slice on a less deep .type element.</p>
<div class="codehilite"><pre><span></span><code>* entity[consent].detail ^slicing.discriminator.type = #value
* entity[consent].detail ^slicing.discriminator.path = &quot;type&quot;
* entity[consent].detail ^slicing.rules = #open
* entity[consent].detail contains
    acp 0..1 and
    patient-id 0..1
* entity[consent].detail[acp].type = &quot;urn:ihe:iti:xua:2012:acp&quot;
* entity[consent].detail[acp].valueString 1..1 MS
* entity[consent].detail[acp].valueString ^short = &quot;Home Community ID where the Consent is.&quot;
* entity[consent].detail[patient-id].type = &quot;urn:oasis:names:tc:xacml:2.0:resource:resource-id&quot;
* entity[consent].detail[patient-id].valueString 1..1 MS
* entity[consent].detail[patient-id].valueString ^short = &quot;The Patient Identity where the Consent is.&quot;
</code></pre></div>



<a name="263923653"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263923653" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263923653">(Dec 06 2021 at 20:59)</a>:</h4>
<p>Ah... that last one <em>might</em> be due to a mismatch between the discriminator type and the type of fixed value (pattern vs fixed).  If the discriminator type is <code>#value</code>, then you should put <code>(exactly)</code> at the end of the assignment rule for the path being discriminated on.  E.g.:</p>
<div class="codehilite"><pre><span></span><code>* entity[consent].detail[acp].type = &quot;urn:ihe:iti:xua:2012:acp&quot; (exactly)
// ...
* entity[consent].detail[patient-id].type = &quot;urn:oasis:names:tc:xacml:2.0:resource:resource-id&quot; (exactly)
</code></pre></div>
<p>Or you can leave those as-is and change the discriminator type to <code>#pattern</code>.</p>



<a name="263925076"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263925076" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263925076">(Dec 06 2021 at 21:10)</a>:</h4>
<p>note that in this case .type is a datatype string</p>



<a name="263926104"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263926104" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263926104">(Dec 06 2021 at 21:19)</a>:</h4>
<p>Yep. String datatypes can use pattern too since string also allows for <code>id</code> and <code>extension</code> sub-elements.</p>



<a name="263926801"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263926801" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263926801">(Dec 06 2021 at 21:25)</a>:</h4>
<p>well, that didn't change any results.</p>



<a name="263927200"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263927200" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263927200">(Dec 06 2021 at 21:29)</a>:</h4>
<p>so, clarification.. the slicing I have on .entity is not throwing the same errors... sorry. (different problem, will bring that up later)</p>



<a name="263927319"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263927319" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263927319">(Dec 06 2021 at 21:30)</a>:</h4>
<p>all of my errors (42) are around slicing of my extension</p>



<a name="263931143"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263931143" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263931143">(Dec 06 2021 at 22:03)</a>:</h4>
<p>I might have stumbled on an issue... In my case I had a base profile that setup the initial conditions for the .agent[user] slice. I derived a second profile off of that and further elaborated what you see. When I explicitly copy that first profile in to the second; The problems are less noisy, but not sure they are better</p>
<div class="codehilite"><pre><span></span><code>AuditEvent.agent[0].extension[0] (l32/c10)  error   Slicing cannot be evaluated: illegal expression syntax in discriminator (group) (@char 3)
AuditEvent.agent[0].extension[1] (l43/c10)  error   Slicing cannot be evaluated: illegal expression syntax in discriminator (group) (@char 3)
AuditEvent.agent[0].extension[2] (l59/c10)  error   Slicing cannot be evaluated: illegal expression syntax in discriminator (group) (@char 3)
AuditEvent.agent[0].extension[3] (l75/c10)  error   Slicing cannot be evaluated: illegal expression syntax in discriminator (group) (@char 3)
</code></pre></div>



<a name="263932352"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263932352" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263932352">(Dec 06 2021 at 22:12)</a>:</h4>
<p>Those errors seem very different.  I don't know what's going on there.</p>



<a name="263933225"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263933225" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263933225">(Dec 06 2021 at 22:19)</a>:</h4>
<p>I cloned your repo and built it -- then <em>manually</em> edited the JSON StructureDefinition profile so that the slices declared the correct type (for the ihe-otherId extension).  When I did that, the errors changed to errors like this:</p>
<blockquote>
<p>AuditEvent.agent[0].extension[1] (l43/c10)   error   Profile <a href="http://profiles.ihe.net/ITI/BasicAudit/StructureDefinition/ITI.BasicAudit.SAMLaccessTokenUse.Comprehensive.Norway">http://profiles.ihe.net/ITI/BasicAudit/StructureDefinition/ITI.BasicAudit.SAMLaccessTokenUse.Comprehensive.Norway</a>, Element matches more than one slice - otherId, otherId/subject-id</p>
</blockquote>
<p>I don't understand this error because <code>otherId/subject-id</code> is a <em>reslice</em> of <code>otherId</code> -- so of course the element matches against both.  It can't match on <code>otherId/subect-id</code> without also matching on <code>otherId</code>.  <span class="user-mention" data-user-id="191320">@Lloyd McKenzie</span>, am I missing something?  Wouldn't you <em>expect</em> an element that matches a reslice to also match the top-level slice?  Shouldn't the validator know to prefer the more specific re-slice?</p>



<a name="263940409"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/263940409" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#263940409">(Dec 06 2021 at 23:38)</a>:</h4>
<p>Yeah, that seems a little odd as a message.  <span class="user-mention" data-user-id="191316">@Grahame Grieve</span>?</p>



<a name="264008943"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/264008943" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#264008943">(Dec 07 2021 at 14:29)</a>:</h4>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span> here is my github repo with this IG <a href="https://github.com/IHE/ITI.BasicAudit">https://github.com/IHE/ITI.BasicAudit</a></p>



<a name="264014548"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/264014548" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#264014548">(Dec 07 2021 at 15:13)</a>:</h4>
<p>I created a mini IG that has the minimum needed to show the problem I have <a href="https://github.com/JohnMoehrke/SlicingSlicedExtension">https://github.com/JohnMoehrke/SlicingSlicedExtension</a></p>



<a name="264014626"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/264014626" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#264014626">(Dec 07 2021 at 15:14)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Extension: OtherId
Title: &quot;AuditEvent.agent other identifiers&quot;
Description: &quot;Carries other identifiers that are known for an agent.&quot;
* value[x] only Reference


Profile:        SecondSliceProfile
Parent:         AuditEvent
Title:          &quot;Profile with slices of extension in a slice&quot;
Description:    &quot;&quot;&quot;
- slices .agent[user]
- slices .agent extension otherId
&quot;&quot;&quot;
* agent.extension contains OtherId named otherId 0..* MS
* agent ^slicing.discriminator.type = #pattern
* agent ^slicing.discriminator.path = &quot;type&quot;
* agent ^slicing.rules = #open
* agent contains
    user 1..
* agent[user].type = http://terminology.hl7.org/CodeSystem/v3-ParticipationType#IRCP &quot;information recipient&quot;
* agent[user].who 1..1
* agent[user].extension[otherId] ^slicing.discriminator.type = #pattern
* agent[user].extension[otherId] ^slicing.discriminator.path = &quot;(value as Reference).identifier.type&quot;
* agent[user].extension[otherId] ^slicing.rules = #open
* agent[user].extension[otherId] contains
    npi 0..1 and
    provider-id 0..1
* agent[user].extension[otherId][npi].valueReference.identifier.type = http://terminology.hl7.org/CodeSystem/v2-0203#NPI
* agent[user].extension[otherId][provider-id].valueReference.identifier.type = http://terminology.hl7.org/CodeSystem/v2-0203#PRN
</code></pre></div>



<a name="264114245"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/264114245" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#264114245">(Dec 08 2021 at 05:34)</a>:</h4>
<p>the problem is here:</p>
<blockquote>
<p>Slice: Unordered, Open by pattern:(value as Reference).identifier.type</p>
</blockquote>
<p>because the rule is <a href="https://hl7.org/fhir/fhirpath.html#simple">https://hl7.org/fhir/fhirpath.html#simple</a>:</p>
<blockquote>
<ul>
<li>All statements SHALL start with the name of the context element (e.g. on a Patient resource, <a href="http://Patient.contact.name">Patient.contact.name</a>.), or SHALL be simply "$this" to refer to the element that has focus</li>
<li>Operators SHALL NOT be used</li>
<li>Only the following functions may be used:<ul>
<li>.resolve()</li>
<li>.extension("url")</li>
<li>.ofType(type)</li>
</ul>
</li>
</ul>
</blockquote>



<a name="264114260"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/264114260" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#264114260">(Dec 08 2021 at 05:34)</a>:</h4>
<p>so the descriminator needs to be</p>



<a name="264114269"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/264114269" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#264114269">(Dec 08 2021 at 05:35)</a>:</h4>
<p><code>$this.value.ofType(Reference).identifier.type</code></p>



<a name="264144925"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/264144925" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#264144925">(Dec 08 2021 at 12:00)</a>:</h4>
<p>I knew it was my fault. Thankyou <span class="user-mention" data-user-id="191316">@Grahame Grieve</span> <br>
Note, I now get an error <code> illegal use of ofType() </code></p>



<a name="264193620"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/264193620" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#264193620">(Dec 08 2021 at 17:54)</a>:</h4>
<p>did you commit that?</p>



<a name="264197622"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/264197622" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#264197622">(Dec 08 2021 at 18:19)</a>:</h4>
<p>yes</p>



<a name="264303685"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/264303685" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#264303685">(Dec 09 2021 at 13:52)</a>:</h4>
<p>any other recommendations for solving this? My sample IG has the last recommendation, and qa shows the new failure.<br>
<a href="https://github.com/JohnMoehrke/SlicingSlicedExtension/">https://github.com/JohnMoehrke/SlicingSlicedExtension/</a></p>



<a name="264352517"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/264352517" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#264352517">(Dec 09 2021 at 19:18)</a>:</h4>
<p>it's on my todo list</p>



<a name="265793413"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/265793413" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#265793413">(Dec 22 2021 at 11:27)</a>:</h4>
<p>so I had a go at this but I think there's something wrong with your definitions. Have a look at the test case I've just added to the validator tests - which seems to work, and compare it with yours. I don't think you've got the slicing set up quite right</p>



<a name="265810614"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/265810614" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#265810614">(Dec 22 2021 at 14:26)</a>:</h4>
<p>The difference I detect is that you don't use the '/' character in the sliceName and the id of that slice. I see that id datatype doesn't allow '/' character. (I did see it in other id elements in that example. Seems like a sushi problem?</p>



<a name="265812179"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/265812179" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#265812179">(Dec 22 2021 at 14:43)</a>:</h4>
<p>I have not had the time to look at Grahame's example, but the <code>/</code> character is used when you are re-slicing.  In other words, if there is an existing slice defined and you need to create sub-slices within that slice, this is called re-slicing.  And in re-slicing, the sliceName is <code>${parentSliceName}/{subSliceName}</code>.  See <a href="http://hl7.org/fhir/R4/profiling.html#reslicinghttp://hl7.org/fhir/R4/profiling.html#reslicing">Re-profiling and Re-slicing</a> (particularly the last paragraph).</p>



<a name="265813300"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/265813300" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#265813300">(Dec 22 2021 at 14:53)</a>:</h4>
<p>sorry for the distraction, I tried fixing the '/'.. not the problem.</p>



<a name="265915133"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/265915133" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#265915133">(Dec 23 2021 at 13:13)</a>:</h4>
<p>latest build still fails on this.  Deeper discussion of the problem <a href="#narrow/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this">https://chat.fhir.org/#narrow/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this</a><br>
The problem is identified, the solution is not so clear. Is this sushi or validator issue to resolve?</p>



<a name="265915673"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/265915673" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#265915673">(Dec 23 2021 at 13:20)</a>:</h4>
<p>well, it passes my test. did you compare the two?</p>



<a name="265915844"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/265915844" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#265915844">(Dec 23 2021 at 13:23)</a>:</h4>
<p>yes, that is what is in the other stream</p>



<a name="265915946"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/265915946" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#265915946">(Dec 23 2021 at 13:24)</a>:</h4>
<p>I didn't want to duplicate, and the issue is related to sushi handling</p>



<a name="265944826"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/265944826" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#265944826">(Dec 23 2021 at 19:16)</a>:</h4>
<p>I'm not so sure it is related to SUSHI handling.  John's solution was to remove the <code>sliceName</code> property from the element with id: <code>AuditEvent.agent:user.extension:otherId</code>.  Since that element clearly <em>is</em> a slice, then I think it's completely appropriate for SUSHI to include the <code>sliceName</code> in the differential.  In fact, based on previous conversations, I was under the impression that we <em>must</em> always put <code>sliceName</code> in the differential for a slice element.</p>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span> -- I also found some things in your test example that didn't seem right to me based on my understanding of slicing, re-slicing, and the relationship between <code>sliceName</code> and <code>id</code>.</p>



<a name="265944845"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/265944845" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#265944845">(Dec 23 2021 at 19:17)</a>:</h4>
<p>Details are in the <a href="#narrow/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this/near/265819221">other thread</a>.</p>



<a name="266504929"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/266504929" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#266504929">(Dec 31 2021 at 13:59)</a>:</h4>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span> poke</p>



<a name="275395462"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/275395462" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#275395462">(Mar 15 2022 at 16:14)</a>:</h4>
<p>I have created a test IG that focuses only on the situation I have. I am slicing an extension that is within a slice.. and am struggling. -- <a href="http://build.fhir.org/ig/JohnMoehrke/SlicingSlicedExtension/branches/main/index.html">http://build.fhir.org/ig/JohnMoehrke/SlicingSlicedExtension/branches/main/index.html</a></p>



<a name="275395649"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/275395649" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#275395649">(Mar 15 2022 at 16:14)</a>:</h4>
<p>I keep getting errors, so I presume I am defining my slicing discriminator</p>
<div class="codehilite"><pre><span></span><code>* agent[user].extension[extOtherId] ^slicing.discriminator.type = #value
* agent[user].extension[extOtherId] ^slicing.discriminator.path = &quot;$this.value.ofType(Reference).identifier.type&quot;
* agent[user].extension[extOtherId] ^slicing.rules = #open
* agent[user].extension[extOtherId] contains
</code></pre></div>



<a name="275395685"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/275395685" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#275395685">(Mar 15 2022 at 16:15)</a>:</h4>
<p>tried #value and #pattern.. same result</p>



<a name="275395780"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/275395780" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#275395780">(Mar 15 2022 at 16:15)</a>:</h4>
<p>so on my examples in that IG I get validation error</p>
<div class="codehilite"><pre><span></span><code>Slicing cannot be evaluated: Could not match discriminator ([$this.value.ofType(Reference).identifier.type]) for slice AuditEvent.agent:user.extension:extOtherId in profile http://johnmoehrke.github.io/SlicingSlicedExtension/StructureDefinition/ThirdSliceProfile - the discriminator [$this.value.ofType(Reference).identifier.type] does not have fixed value, binding or existence assertions
</code></pre></div>



<a name="275577171"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/275577171" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#275577171">(Mar 16 2022 at 21:05)</a>:</h4>
<p>OK. I have been looking into this and experimenting w/ it.  I think it comes down to quirks (bugs?) in snapshot generation.</p>
<p>Here is the basic slicing structure of John's example profile:</p>
<ul>
<li><code>AuditEvent.agent</code> is sliced by <code>pattern</code> on <code>type</code><ul>
<li>Slices: <code>user</code>, <code>userorg</code></li>
</ul>
</li>
<li><code>AuditEvent.agent.extension</code> is sliced by <code>value</code> on <code>url</code> (typical extension slicing)<ul>
<li>Slices: <code>extOtherId</code></li>
</ul>
</li>
<li><code>AuditEvent.agent:user.extension:extOtherId</code> is <em>resliced</em> by <code>pattern</code> on <code>$this.value.ofType(Reference).identifier.type</code><ul>
<li>Slices: <code>extOtherId/npi</code>, <code>extOtherId/provider-id</code></li>
</ul>
</li>
</ul>
<p>The first problem I noticed is that the snapshot generator was putting the re-slicing information on the <em>wrong</em> element. John's example had this in the differential:</p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent:user"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"sliceName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"min"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"max"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="w"></span>
<span class="p">},</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent:user.extension:extOtherId"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent.extension"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"sliceName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"extOtherId"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"slicing"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">"discriminator"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"pattern"</span><span class="p">,</span><span class="w"> </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$this.value.ofType(Reference).identifier.type"</span><span class="w"> </span><span class="p">}],</span><span class="w"></span>
<span class="w">    </span><span class="nt">"rules"</span><span class="p">:</span><span class="w"> </span><span class="s2">"open"</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nt">"min"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"max"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Extension"</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">"profile"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"http://johnmoehrke.github.io/SlicingSlicedExtension/StructureDefinition/OtherId"</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="w">  </span><span class="nt">"mustSupport"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Note that the re-slicing info is on <code>AuditEvent.agent:user.extension:extOtherId</code>.</p>
<p>But the snapshot was coming out like this (I've omitted properties for brevity):</p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent:user"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"sliceName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"..."</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w"></span>
<span class="p">},</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent:user.id"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent.id"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"..."</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w"></span>
<span class="p">},</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent:user.extension"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent.extension"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"slicing"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">"discriminator"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"pattern"</span><span class="p">,</span><span class="w"> </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$this.value.ofType(Reference).identifier.type"</span><span class="w"> </span><span class="p">}],</span><span class="w"></span>
<span class="w">    </span><span class="nt">"rules"</span><span class="p">:</span><span class="w"> </span><span class="s2">"open"</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nt">"..."</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w"></span>
<span class="p">},</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent:user.extension:extOtherId"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent.extension"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"sliceName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"extOtherId"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"..."</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Extension"</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">"profile"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">        </span><span class="s2">"http://johnmoehrke.github.io/SlicingSlicedExtension/StructureDefinition/OtherId"</span><span class="w"></span>
<span class="w">      </span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="w">  </span><span class="nt">"..."</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Note that the re-slicing information (by pattern on the identifier type) is now on the <em>wrong</em> element.  It's on <code>AuditEvent.agent:user.extension</code> instead of <code>AuditEvent.agent:user.extension:extOtherId</code>.</p>
<p>I wondered if maybe the snapshot generator needed the <code>AuditEvent.agent:user.extension</code> to redeclare its slicing in the differential (even though the slicing was already declared in the sliced element).  So I added that element to the differential as below:</p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent:user"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"sliceName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"min"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"max"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="w"></span>
<span class="p">},</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent:user.extension"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent.extension"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"slicing"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">"discriminator"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"value"</span><span class="p">,</span><span class="w"> </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"url"</span><span class="w"> </span><span class="p">}],</span><span class="w"></span>
<span class="w">    </span><span class="nt">"ordered"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">"rules"</span><span class="p">:</span><span class="w"> </span><span class="s2">"open"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">},</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent:user.extension:extOtherId"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent.extension"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"sliceName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"extOtherId"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"slicing"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">"discriminator"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"pattern"</span><span class="p">,</span><span class="w"> </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$this.value.ofType(Reference).identifier.type"</span><span class="w"> </span><span class="p">}],</span><span class="w"></span>
<span class="w">    </span><span class="nt">"rules"</span><span class="p">:</span><span class="w"> </span><span class="s2">"open"</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nt">"min"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"max"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Extension"</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">"profile"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"http://johnmoehrke.github.io/SlicingSlicedExtension/StructureDefinition/OtherId"</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="w">  </span><span class="nt">"mustSupport"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>(The 2nd element above is what I added to the differential in John's example).</p>
<p>But now the snapshot generator had the <em>correct</em> slicing on <code>AuditEvent.agent:user.extension</code>, but completely <em>omitted</em> the reslicing on <code>AuditEvent.agent:user.extension:extOtherId</code>:</p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent:user"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"sliceName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"..."</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w"></span>
<span class="p">},</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent:user.id"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent.id"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"..."</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w"></span>
<span class="p">},</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent:user.extension"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent.extension"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"slicing"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">"discriminator"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"value"</span><span class="p">,</span><span class="w"> </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"url"</span><span class="w"> </span><span class="p">}],</span><span class="w"></span>
<span class="w">    </span><span class="nt">"ordered"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">"rules"</span><span class="p">:</span><span class="w"> </span><span class="s2">"open"</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nt">"..."</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w"></span>
<span class="p">},</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent:user.extension:extOtherId"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuditEvent.agent.extension"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"sliceName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"extOtherId"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"_NOTE: We should see a slicing here with the re-slicing information"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"..."</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Extension"</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">"profile"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">        </span><span class="s2">"http://johnmoehrke.github.io/SlicingSlicedExtension/StructureDefinition/OtherId"</span><span class="w"></span>
<span class="w">      </span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="w">  </span><span class="nt">"..."</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Note that the <code>slicing</code> is <em>gone</em> from <code>AuditEvent.agent:user.extension:extOtherId</code>. Without that reslicing info, the <code>extOtherId/npi</code> and <code>extOtherId/provider-id</code> slices aren't valid slices (since they're no longer unique according to the discriminator). So that just caused <em>different</em> errors in validation.</p>
<p>I'd prefer that we do not need to redeclare slicings that have already been defined on a sliced element (approach 1 above), but I know the IG Publisher is limited in its ability to see and carry over constraints from the sliced element.</p>
<p>But I'm pretty sure approach 2 above <em>should work</em>.  I'm not sure why the snapshot generator is <em>dropping</em> the reslicing information on <code>AuditEvent.agent:user.extension:extOtherId</code>. <span class="user-mention" data-user-id="191316">@Grahame Grieve</span>?</p>



<a name="276077644"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/276077644" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#276077644">(Mar 21 2022 at 16:26)</a>:</h4>
<p><span class="user-mention" data-user-id="191320">@Lloyd McKenzie</span> <span class="user-mention" data-user-id="191316">@Grahame Grieve</span> can you help with how this should look?</p>



<a name="276102402"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/276102402" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#276102402">(Mar 21 2022 at 19:31)</a>:</h4>
<p>given some discussion today in security, that leads my use-case to be simplified to just adding extensions that are Identifiers, rather that References that I only use as Identifiers. So I simplified my test IG, and even the more simple version fails.  Note that this doesn't even slice the extension within a slice, I defined the fine grain slice in a way independent of the gross slice... so I am very conflused as to why this one is not working.</p>



<a name="276103590"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/276103590" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#276103590">(Mar 21 2022 at 19:41)</a>:</h4>
<p>in this version I am defining the otherId slice independent of the user slice, and using the more simple Identifier. Thus my discriminator is much easier too. but still no love at the example validation.</p>



<a name="276869911"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/276869911" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#276869911">(Mar 28 2022 at 13:05)</a>:</h4>
<p>I am still stuck. Might this be similar to the nested sections slicing problem? Seems similar.</p>



<a name="276870301"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/276870301" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> João Almeida <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#276870301">(Mar 28 2022 at 13:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="191404">John Moehrke</span> <a href="#narrow/stream/179252-IG-creation/topic/slicing.20sliced.20extension/near/276869911">said</a>:</p>
<blockquote>
<p>I am still stuck. Might this be similar to the nested sections slicing problem? Seems similar.</p>
</blockquote>
<p>sushi works with your example or only the IG Publisher?<br>
The nested section only fails on the IGPub</p>



<a name="276870357"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/276870357" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#276870357">(Mar 28 2022 at 13:08)</a>:</h4>
<p>yes, for me it really only fails on validating my examples.</p>



<a name="276870405"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/276870405" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#276870405">(Mar 28 2022 at 13:09)</a>:</h4>
<p>see above for the long discussion.</p>



<a name="276870511"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/276870511" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#276870511">(Mar 28 2022 at 13:09)</a>:</h4>
<p>it seems that the validator is expecting something in the profile that I am not smart enough to put in there.</p>



<a name="276870934"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/276870934" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> João Almeida <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#276870934">(Mar 28 2022 at 13:13)</a>:</h4>
<p>yes indeed, the "symptoms" seem similar to the nested section</p>



<a name="277081117"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/277081117" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#277081117">(Mar 30 2022 at 00:24)</a>:</h4>
<p>well, I think that the snapshot is correct, and what is trying to be done is the problem</p>



<a name="277081338"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/277081338" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#277081338">(Mar 30 2022 at 00:29)</a>:</h4>
<p>the problem is that the all slices definition of agent defines a slice OtherId, and then so does the user slice on it. So that overrides the slice</p>



<a name="277146624"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/277146624" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#277146624">(Mar 30 2022 at 13:46)</a>:</h4>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span> -- my understanding was that the validator cannot (or does not) look back to the all slices definition during validation.  In the past, we've had to repeat constraints (such as extension declarations) in each slice for this very reason.  So without the <code>OtherId</code> slice definition on the agent slice (which I view as redundant, rather than an override), the validator wouldn't know the <code>OtherId</code> slice exists.  Is my understanding incorrect?  Does the validator consider the all-slice constraints now when processing each individual slice?</p>



<a name="277149945"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/277149945" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#277149945">(Mar 30 2022 at 14:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="191316">Grahame Grieve</span> <a href="#narrow/stream/179252-IG-creation/topic/slicing.20sliced.20extension/near/277081338">said</a>:</p>
<blockquote>
<p>the problem is that the all slices definition of agent defines a slice OtherId, and then so does the user slice on it. So that overrides the slice</p>
</blockquote>
<p>I would far prefer this, but it gives the same problem.</p>



<a name="277227151"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/277227151" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#277227151">(Mar 31 2022 at 02:53)</a>:</h4>
<p>well,  I think that <span class="user-mention" data-user-id="191469">@Chris Moesel</span> is right, but the slice doesn't pick up anything from the all slices slice, and so the validator doesn't know how to resolve the slices</p>



<a name="277274173"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/277274173" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#277274173">(Mar 31 2022 at 12:43)</a>:</h4>
<p>so, what should the json look like?</p>



<a name="277279097"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/277279097" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#277279097">(Mar 31 2022 at 13:20)</a>:</h4>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span> - John and I have experimented w/ many different formations of the SD and haven't been able to find a successful representation that passes instance validation without error.  If you can provide a differential that works, I suspect we can learn from it and then apply it to future situations.  But like John, I am stumped -- and I don't know if everything we've tried is truly wrong or if we're just hitting validator or publisher bugs/limitations.</p>



<a name="277823210"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/277823210" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#277823210">(Apr 05 2022 at 03:23)</a>:</h4>
<p><span class="user-mention" data-user-id="191469">@Chris Moesel</span> <span class="user-mention" data-user-id="191404">@John Moehrke</span> I have spent a few days looking at this. I do not believe that what you are doing with the slices makes sense or is documented.</p>



<a name="277823214"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/277823214" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#277823214">(Apr 05 2022 at 03:23)</a>:</h4>
<p>the relevant documentation is</p>



<a name="277823219"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/277823219" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#277823219">(Apr 05 2022 at 03:23)</a>:</h4>
<blockquote>
<p>In addition to the above, there are times when Profile C will need to further slice a slice defined in B. In this case, there's a need to reference both the ElementDefinition.sliceName of the original slice from Profile B as well as to define an ElementDefinition.sliceName for the slice defined within Profile C. This is done by separating the names using "/". For example, if Profile B defines the slice "example", and profile C defines the slice "example/example1", then this is deemed to be "example1" slice of the example slice. This process can continue indefinitely by separating each layer of slicing names with the "/" character. This pattern applies to @default too: @default/@default.</p>
</blockquote>



<a name="277823276"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/277823276" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#277823276">(Apr 05 2022 at 03:24)</a>:</h4>
<p>The documentation talks about doing this from one profile to another. There's nowhere that says you can just go right ahead and do this in the same profile</p>



<a name="277823283"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/277823283" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#277823283">(Apr 05 2022 at 03:24)</a>:</h4>
<p>which is what's happening here.</p>



<a name="277823292"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/277823292" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#277823292">(Apr 05 2022 at 03:24)</a>:</h4>
<p>but I went ahead and implemented the snapshot generation to do that anyway. But then validation gives you:</p>



<a name="277823325"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/277823325" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#277823325">(Apr 05 2022 at 03:25)</a>:</h4>
<p>RROR: AuditEvent.agent[0].extension[0]: Profile <a href="http://hl7.org/fhir/test/StructureDefinition/Slice23">http://hl7.org/fhir/test/StructureDefinition/Slice23</a>, Element matches more than one slice - extOtherId, extOtherId/npi</p>



<a name="277823329"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/277823329" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#277823329">(Apr 05 2022 at 03:25)</a>:</h4>
<p>and indeed it does, and must.</p>



<a name="277823344"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/277823344" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#277823344">(Apr 05 2022 at 03:26)</a>:</h4>
<p>I don't see how what you're doing can work</p>



<a name="277823516"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/277823516" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#277823516">(Apr 05 2022 at 03:29)</a>:</h4>
<p>so what are you actually trying to achieve?</p>



<a name="277867014"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/277867014" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#277867014">(Apr 05 2022 at 12:08)</a>:</h4>
<p>Here is what I am trying to do, I would be happy for someone to express how to do this in json/xml.</p>
<ol>
<li>I need to slice the AuditEvent.agent as there are multiple kinds of agent the profile is defining, so want to identify a slice for the (user) agent.</li>
<li>In that slice for describing the user, I have more identifiers to record than the AuditEvent.agent supports. so I add an extension (extOtherIds)</li>
<li>In that extension that allows me to record more identifiers, I have a some flavors of identifier that I also want to define (npi, and prn)</li>
</ol>
<p>Note: For 2, I have tried to define this in the first (user) slice, and have tried it at the root. </p>
<p>Here is my github - <a href="https://github.com/JohnMoehrke/SlicingSlicedExtension">https://github.com/JohnMoehrke/SlicingSlicedExtension</a></p>



<a name="277867374"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179252-IG%20creation/topic/slicing%20sliced%20extension/near/277867374" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179252-IG-creation/topic/slicing.20sliced.20extension.html#277867374">(Apr 05 2022 at 12:11)</a>:</h4>
<p>This github is very focused only on this problem/need.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
