---
layout: page
title: "FHIR Chat  · issue with boundsDuration · conformance"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/index.html">conformance</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/issue.20with.20boundsDuration.html">issue with boundsDuration</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="276562290"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/issue%20with%20boundsDuration/near/276562290" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ilia Kaplan <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/issue.20with.20boundsDuration.html#276562290">(Mar 25 2022 at 01:45)</a>:</h4>
<p>Hi there !<br>
<a href="/user_uploads/10155/hSaG-_l1x7tgyHf8Q2xF_GC7/drt-1.xml">drt-1.xml</a></p>
<p>I'm trying to validate the attached observation file . Both Java validator and hapi server (<a href="https://hapi.fhir.org/baseR4/Observation/$validate">https://hapi.fhir.org/baseR4/Observation/$validate</a>)<br>
state about 2 violated rules : drt-1 and qty-3 when examining Observation.effective.ofType(Timing).repeat.bounds.ofType(Duration).</p>
<p><strong>drt-1</strong> rule dictates "There SHALL be a code if there is a value and it SHALL be an expression of time. If system is present, it SHALL be UCUM"<br>
My boundsDuration look as below , and as I understand it doesn't violates what the rule dictates. however Java validator and hapi server consider it as violation . What I'm missing here ?<br>
&lt;effectiveTiming&gt;<br>
&lt;repeat&gt;<br>
&lt;boundsDuration&gt;<br>
&lt;value value="10"/&gt;<br>
&lt;unit value="day"/&gt;<br>
&lt;code value="d"/&gt;<br>
&lt;/boundsDuration&gt;<br>
&lt;/repeat&gt;<br>
&lt;/effectiveTiming&gt;</p>
<p><strong>qty-3</strong> rule<br>
According to observation.sch (schematron definition for observation ) qty-3 rule is not defined on effectiveTiming/f:repeat/f:boundsDuration at all . So how come the rule is violated ?</p>
<p>I would appreciate if you could enlighten me what I' missing here .<br>
Thanks ,<br>
Ilia</p>



<a name="276563329"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/issue%20with%20boundsDuration/near/276563329" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Townley-O&#x27;Neill <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/issue.20with.20boundsDuration.html#276563329">(Mar 25 2022 at 02:02)</a>:</h4>
<p><a href="http://hl7.org/fhir/R4/datatypes.html#quantity">qty-3</a> requires that system be present when code is.</p>
<p><a href="http://hl7.org/fhir/R4/datatypes.html#Duration">drt-1</a> does not mention that in its text, but does include it in its FHIRPath</p>
<blockquote>
<p>There SHALL be a code if there is a value and it SHALL be an expression of time. If system is present, it SHALL be UCUM.  </p>
</blockquote>
<blockquote>
<p>code.exists() implies ((system = %ucum) and value.exists())</p>
</blockquote>
<p>You need to include the system</p>
<blockquote>
<p>&lt;value value="10"/&gt;<br>
&lt;unit value="day"/&gt;<br>
&lt;system value="http://unitsofmeasure.org"/&gt;<br>
&lt;code value="d"/&gt;</p>
</blockquote>



<a name="276563528"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/issue%20with%20boundsDuration/near/276563528" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Townley-O&#x27;Neill <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/issue.20with.20boundsDuration.html#276563528">(Mar 25 2022 at 02:05)</a>:</h4>
<p>(deleted)</p>



<a name="276565028"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/issue%20with%20boundsDuration/near/276565028" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ilia Kaplan <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/issue.20with.20boundsDuration.html#276565028">(Mar 25 2022 at 02:33)</a>:</h4>
<p><strong>qty-3</strong> -  I'm aware of "system to be present when code is"  requirement of qty-3  . What I can't understand is why it's fired on <br>
f:Observation/f:effectiveTiming/f:repeat/f:boundsDuration . I mean this rule even not defined for f:Observation/f:effectiveTiming/f:repeat/f:boundsDuration, only <strong>drt-1</strong> supposed to be validated when examining this Xpath . <br>
see attached <a href="/user_uploads/10155/uusgOSJA3q6gx3k37HJu7bee/observation.sch">observation.sch</a></p>
<p><strong>drt-1</strong> - Looking into FHIRPath makes it more clear - the system should be present . What is misleading here is schematron definition <br>
(f:code or not(f:value)) and (not(exists(f:system)) or f:system/@value='<a href="http://unitsofmeasure.org">http://unitsofmeasure.org</a>')<br>
that defines system as optional element. Then the question is what should be the source of truth when it comes to validation: <br>
FHIRPath or schematron ?</p>



<a name="276578220"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/issue%20with%20boundsDuration/near/276578220" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Townley-O&#x27;Neill <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/issue.20with.20boundsDuration.html#276578220">(Mar 25 2022 at 05:30)</a>:</h4>
<p><span class="user-mention" data-user-id="475403">@Ilia Kaplan</span> <br>
<strong>qty-3</strong> duration inherits from quantity, see <a href="http://hl7.org/fhir/R4/datatypes.html#QuantityVariations">http://hl7.org/fhir/R4/datatypes.html#QuantityVariations</a></p>
<p><strong>drt-1</strong> FHIRPath is what is in formal definitions, e.g. of <a href="http://hl7.org/fhir/R4/duration.profile.xml.html">duration</a> . FHIRPath is more expressive than Schematron and the Schematrons are generated from the FHIRPath.</p>
<p>Have you seen <a href="https://hl7.org/fhir/R4/validation.html">https://hl7.org/fhir/R4/validation.html</a>  and <a href="https://hl7.org/fhir/R4/conformance-rules.html#constraints">https://hl7.org/fhir/R4/conformance-rules.html#constraints</a> ?</p>



<a name="276955071"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/issue%20with%20boundsDuration/near/276955071" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ilia Kaplan <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/issue.20with.20boundsDuration.html#276955071">(Mar 29 2022 at 03:48)</a>:</h4>
<p>Hi <br>
I've seen those pages , but some essential things are still unclear for me.<br>
Given the attached sample  - how the rule defined on quantity datatype is validated ?</p>
<ul>
<li>Is it defined in some sort of another schematron file ? where the validator has to access in order  to check it  </li>
<li>how the validators actually knows that in Observation/f:effectiveTiming/f:repeat/f:boundsDuration it has to check not only the schematron based rules  but also to expand its search to the rules defined on datatype level ?</li>
</ul>



<a name="276959147"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/issue%20with%20boundsDuration/near/276959147" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Townley-O&#x27;Neill <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/issue.20with.20boundsDuration.html#276959147">(Mar 29 2022 at 05:15)</a>:</h4>
<p>The <a href="https://hl7.org/fhir/R4/validation.html#jar">validator</a> does not use Schematron, or any of the other  validation methods. It is written in Java and the source is in <a href="https://github.com/hapifhir/org.hl7.fhir.core">GitHub</a> if you want to see the details. I just use it. <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="277009911"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/issue%20with%20boundsDuration/near/277009911" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/issue.20with.20boundsDuration.html#277009911">(Mar 29 2022 at 14:09)</a>:</h4>
<p>If using Schematron and not the HL7 validator, the fully generated Schematron sets the context for each element and lists all inherited invariants.</p>



<a name="277074612"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/issue%20with%20boundsDuration/near/277074612" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/issue.20with.20boundsDuration.html#277074612">(Mar 29 2022 at 22:48)</a>:</h4>
<p>The validator always checks both element and type constraints.</p>



<a name="277915358"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/issue%20with%20boundsDuration/near/277915358" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ilia Kaplan <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/issue.20with.20boundsDuration.html#277915358">(Apr 05 2022 at 17:31)</a>:</h4>
<p>Hi again <br>
thank you for the clarifications . </p>
<p>Our team has started to work on building FHIR validator which is based on Schematron , and I have some concerns if we adopt the right approach. </p>
<ol>
<li>
<p>Is Schematron validation reliable in a long term perspective ? I noticed this warning message on hapi page <br>
<a href="https://hapifhir.io/hapi-fhir/docs/validation/schema_validator.html">https://hapifhir.io/hapi-fhir/docs/validation/schema_validator.html</a></p>
</li>
<li>
<p>Is it correct assumption that most of the FHIR providers just use Java validator or something that's built on top of it ?</p>
</li>
<li>
<p>The drt-1 issue mentioned above basically claims that Schematron is not  really source of truth when it comes to validation . FHIRPath definition of the rule is more reliable . If that's the case - to what extent we can trust schematron  ? BTw , is there any repository of rules expressed using FHIRPath like schematron files ?</p>
</li>
<li>
<p>Is there any way to validate inherited rules as it's required in case of qty-3 mentioned above? <span class="user-mention" data-user-id="191320">@Lloyd McKenzie</span> what is fully generated Schematron ? I have Schematron files per resource and fhir-invariants.sch.  I couldn't find anything in these files that can invoke <strong>qty-3</strong> on f:Observation/f:effectiveTiming/f:repeat/f:boundsDuration </p>
</li>
<li>
<p>Schematron validation has no coverage for validating system codes and resources (ex. "Unable to resolve resource" ). <br>
Validating system codes and resources  seem to be much more wider and complicated rather than validating schematron rules. <br>
Could you point me to some resources that guide how to approach these topics ?</p>
</li>
</ol>



<a name="277940022"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/issue%20with%20boundsDuration/near/277940022" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/issue.20with.20boundsDuration.html#277940022">(Apr 05 2022 at 20:38)</a>:</h4>
<ol>
<li>Schematron is incapable of checking value sets, certain types of invariants, resolving references, and doing a number of other things.  Also, it obviously only works on XML and well over 50% of FHIR instances are JSON.  In short, Schematron can work for the things it's good at, but unless there's a reason you <em>must</em> use Schematron, you're probably better starting with the existing Java or .NET validator</li>
<li>Most systems do their own validation based on business rules plus, possibly some light-weight schema validation to do a sanity check.  However, for those systems that do full validation, then yes, either the Java or .NET validator as the most common foundation.  (Writing a FHIR validator is a <em>lot</em> of work and hard to get right - slicing can be downright miserable, so leveraging existing work often makes more sense than rolling your own.)</li>
<li>Existing models are supposed to be expressed in both FHIRPath and XPath.  However, the requirement for XPath is being dropped in R5.  And in practice, some invariants simply can't be expressed in XPath (e.g. anything that depends on 'resolve()').  And I know of a number of IGs that just fill the XPath for their invariants with 'true()' and don't bother - even if the invariant <em>could</em> be expressed in XPath because the XPath isn't visible in their specs and it's their belief that no-one cares.  (And few people know how to write XPath 2.)  The fact that XPath errors get picked up this late is a symptom of the fact that XPath/Schematron aren't widely used</li>
<li>The generated schematron files are <em>supposed</em> to handle this.  However, it's possible they don't and no-one's noticed.  You could file a change request and we can fix it as a tooling bug.</li>
<li>If you mean "how to approach these topics using schematron", the answer is 'no'.  XPath has no capability to do it.  That's one of the reasons we chose to create FHIRPath.  (Lack of library support for XPath 2, need to support other syntaxes, and a few other considerations came into play too.)</li>
</ol>



<a name="277972568"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/issue%20with%20boundsDuration/near/277972568" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ilia Kaplan <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/issue.20with.20boundsDuration.html#277972568">(Apr 06 2022 at 03:50)</a>:</h4>
<p>In 5. I meant how tp approach value sets, resolving references and other things that can't be covered by Schematron</p>



<a name="277972964"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/issue%20with%20boundsDuration/near/277972964" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/issue.20with.20boundsDuration.html#277972964">(Apr 06 2022 at 04:00)</a>:</h4>
<p>You'll need to do them by writing code - or you could just leverage one of the existing open-source validators.  What is your objective in writing your own?</p>



<a name="277977352"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/issue%20with%20boundsDuration/near/277977352" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ilia Kaplan <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/issue.20with.20boundsDuration.html#277977352">(Apr 06 2022 at 05:33)</a>:</h4>
<p>writing my own was not my decision , I tend to think that leveraging existing code for validator will require less effort and it eventually will do better job</p>



<a name="278023549"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/issue%20with%20boundsDuration/near/278023549" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/issue.20with.20boundsDuration.html#278023549">(Apr 06 2022 at 13:32)</a>:</h4>
<p>I would agree.  There's a <em>lot</em> of development effort that's gone into the existing ones.  If you decide (or are told) that you must create your own, do check out the test cases, which are maintained here: <a href="https://github.com/FHIR/fhir-test-cases/tree/master/validator">https://github.com/FHIR/fhir-test-cases/tree/master/validator</a></p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
