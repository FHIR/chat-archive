---
layout: page
title: "FHIR Chat  · Checking document Bundle completeness with Invariant · conformance"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/index.html">conformance</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Checking.20document.20Bundle.20completeness.20with.20Invariant.html">Checking document Bundle completeness with Invariant</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="199506303"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Checking%20document%20Bundle%20completeness%20with%20Invariant/near/199506303" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Checking.20document.20Bundle.20completeness.20with.20Invariant.html#199506303">(Jun 02 2020 at 15:08)</a>:</h4>
<p>I want to check a document type Bundle for completeness (as in: all Resources referenced by the Composition shall be contained in the Bundle).</p>
<p>The Invariant I came up with does exactly that when I run it through the FHIRPath.js demo tool:<br>
<code>Bundle.entry.descendants().reference.distinct().subsetOf(Bundle.entry.fullUrl)</code><br>
It picks up missing Ressources but allows for additional content in the Bundle.</p>
<p>However it doesn not work in Simplifier. I picked this up with support and  they said (if I understand it correctly) that the evaluation failes because the datatypes of reference (string) and fullUrl (uri) don't match.</p>
<p>I tried a couple more variants, e.g. <code>Bundle.entry.descendants().reference.distinct().all(Bundle.entry.fullUrl.contains($this))</code> but I keep running into the same error.</p>
<p>I can't figure out a way to work around this, but I assume that checking the completeness of Bundles is a universal use case. It shouldn't be that hard...<br>
How can I make this work?</p>



<a name="199509027"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Checking%20document%20Bundle%20completeness%20with%20Invariant/near/199509027" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Checking.20document.20Bundle.20completeness.20with.20Invariant.html#199509027">(Jun 02 2020 at 15:24)</a>:</h4>
<p>I don't know that 'reference' is unique only to Reference.reference.  Also, the reference can be a local reference, which wouldn't match the fullUrl.  I don't think there's a good way to express this in FHIRPath.</p>



<a name="199585519"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Checking%20document%20Bundle%20completeness%20with%20Invariant/near/199585519" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Checking.20document.20Bundle.20completeness.20with.20Invariant.html#199585519">(Jun 03 2020 at 07:04)</a>:</h4>
<p>Oh, you mean a contained reference? I think that could be easily caught by adding<br>
Bundle.entry.descendants().reference.distinct()<em>.where($this.contains('#').not())</em>...<br>
(or something similar)...</p>



<a name="199589489"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Checking%20document%20Bundle%20completeness%20with%20Invariant/near/199589489" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthijs van der Wielen <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Checking.20document.20Bundle.20completeness.20with.20Invariant.html#199589489">(Jun 03 2020 at 07:59)</a>:</h4>
<p>The way I tested this is that the first part "Bundle.entry.descendants().reference.distinct()" returns "string value" and the second part "entry.fullUrl()" returns a "uri value". <br>
The use of "subsetOf" seems pretty straightforward in the spec, however it does not allow the comparison of string and uri values (it seems). And I couldn't figure out how to use a cast to transform the uri into a string or vice versa, to see if the "subsetOf" would work.</p>



<a name="199592598"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Checking%20document%20Bundle%20completeness%20with%20Invariant/near/199592598" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Checking.20document.20Bundle.20completeness.20with.20Invariant.html#199592598">(Jun 03 2020 at 08:33)</a>:</h4>
<p>The funny thing is however, that the JavaScript implementation doesn't seem to run into that issue. So I wonder which one is the expected behavior and which one isn't...</p>



<a name="199592802"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Checking%20document%20Bundle%20completeness%20with%20Invariant/near/199592802" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Checking.20document.20Bundle.20completeness.20with.20Invariant.html#199592802">(Jun 03 2020 at 08:35)</a>:</h4>
<p>Hm, I guess the Specification doesn't take sides here: </p>
<blockquote>
<p>Because FHIRPath may be used in different situations and environments requiring different levels of type safety, implementations may make different choices about how much type checking should be done at compile-time versus run-time, and in what situations. Some implementations requiring a high degree of type-safety may choose to perform strict type-checking at compile-time for all invocations. On the other hand, some implementations may be unconcerned with compile-time versus run-time checking and may choose to defer all correctness checks to run-time.</p>
</blockquote>
<p>Source: <a href="http://hl7.org/fhirpath/N1/#type-safety-and-strict-evaluation">http://hl7.org/fhirpath/N1/#type-safety-and-strict-evaluation</a></p>



<a name="199593112"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Checking%20document%20Bundle%20completeness%20with%20Invariant/near/199593112" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Checking.20document.20Bundle.20completeness.20with.20Invariant.html#199593112">(Jun 03 2020 at 08:39)</a>:</h4>
<p>The Conversion Table doesn't even mention the URI Type: <a href="http://hl7.org/fhirpath/N1/#conversion">http://hl7.org/fhirpath/N1/#conversion</a></p>



<a name="199593535"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Checking%20document%20Bundle%20completeness%20with%20Invariant/near/199593535" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Checking.20document.20Bundle.20completeness.20with.20Invariant.html#199593535">(Jun 03 2020 at 08:44)</a>:</h4>
<p>Although, the more I read about types and conversion, the more I think that URI types shouldn't even exist in FHIRPath and just simply be treated as strings... There is no mention whatsoever of URI types in the FHIRPath spec...</p>



<a name="199593556"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Checking%20document%20Bundle%20completeness%20with%20Invariant/near/199593556" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Checking.20document.20Bundle.20completeness.20with.20Invariant.html#199593556">(Jun 03 2020 at 08:44)</a>:</h4>
<p>Ah. There it is!<br>
<a href="http://hl7.org/fhir/fhirpath.html#types">http://hl7.org/fhir/fhirpath.html#types</a></p>



<a name="199593619"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Checking%20document%20Bundle%20completeness%20with%20Invariant/near/199593619" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Checking.20document.20Bundle.20completeness.20with.20Invariant.html#199593619">(Jun 03 2020 at 08:45)</a>:</h4>
<p><a href="/user_uploads/10155/qct7ZaSrKThnCgvu_3EVehxR/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/10155/qct7ZaSrKThnCgvu_3EVehxR/image.png" title="image.png"><img src="/user_uploads/10155/qct7ZaSrKThnCgvu_3EVehxR/image.png"></a></div>



<a name="199593733"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Checking%20document%20Bundle%20completeness%20with%20Invariant/near/199593733" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Checking.20document.20Bundle.20completeness.20with.20Invariant.html#199593733">(Jun 03 2020 at 08:46)</a>:</h4>
<p>So, the FHIR types string and uri should be the same in FHIRPath...</p>



<a name="199594050"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Checking%20document%20Bundle%20completeness%20with%20Invariant/near/199594050" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthijs van der Wielen <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Checking.20document.20Bundle.20completeness.20with.20Invariant.html#199594050">(Jun 03 2020 at 08:50)</a>:</h4>
<p>Interesting! So why won't the subsetOf not work in the fhirpath tester?</p>



<a name="199596848"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Checking%20document%20Bundle%20completeness%20with%20Invariant/near/199596848" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Checking.20document.20Bundle.20completeness.20with.20Invariant.html#199596848">(Jun 03 2020 at 09:22)</a>:</h4>
<p>...because there's a bug in the .NET implementation ...?</p>



<a name="199598327"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Checking%20document%20Bundle%20completeness%20with%20Invariant/near/199598327" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Checking.20document.20Bundle.20completeness.20with.20Invariant.html#199598327">(Jun 03 2020 at 09:36)</a>:</h4>
<p>Bundle.entry.fullUrl should return a collection of strings instead of a collection of uris, IMO</p>



<a name="199602044"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Checking%20document%20Bundle%20completeness%20with%20Invariant/near/199602044" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthijs van der Wielen <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Checking.20document.20Bundle.20completeness.20with.20Invariant.html#199602044">(Jun 03 2020 at 10:21)</a>:</h4>
<p>I've created a ticket for the .NET team. They will look into it. <a href="https://github.com/FirelyTeam/fhir-net-api/issues/1389">https://github.com/FirelyTeam/fhir-net-api/issues/1389</a></p>



<a name="199611490"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Checking%20document%20Bundle%20completeness%20with%20Invariant/near/199611490" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Checking.20document.20Bundle.20completeness.20with.20Invariant.html#199611490">(Jun 03 2020 at 12:16)</a>:</h4>
<p>Excellent, thanks!</p>



<a name="199647744"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Checking%20document%20Bundle%20completeness%20with%20Invariant/near/199647744" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Checking.20document.20Bundle.20completeness.20with.20Invariant.html#199647744">(Jun 03 2020 at 17:09)</a>:</h4>
<p>I don't mean a contained reference.  I mean that the references in your instance might say "Patient/5", but the fullUrls you're comparing them against would say "<a href="http://somewhere.org/Patient/5">http://somewhere.org/Patient/5</a>" - and thus won't match.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
