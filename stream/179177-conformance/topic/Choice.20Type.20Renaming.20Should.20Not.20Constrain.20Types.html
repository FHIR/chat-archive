---
layout: page
title: "FHIR Chat  · Choice Type Renaming Should Not Constrain Types · conformance"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/index.html">conformance</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Choice.20Type.20Renaming.20Should.20Not.20Constrain.20Types.html">Choice Type Renaming Should Not Constrain Types</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="231567274"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Choice%20Type%20Renaming%20Should%20Not%20Constrain%20Types/near/231567274" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Choice.20Type.20Renaming.20Should.20Not.20Constrain.20Types.html#231567274">(Mar 24 2021 at 00:59)</a>:</h4>
<p>My understanding from firely's excellent <a href="https://fire.ly/2019/09/13/type-slicing-in-fhir-r4/">Type Slicing in FHIR R4</a> article and from <a href="http://hl7.org/fhir/elementdefinition.html#typesx">section 2.30.0.4.2</a> in the spec is that the use of choice type renaming (e.g., <code>valueQuantity</code>) should <em>not</em> constrain the available types in the choice.  That section of the spec specifically states:</p>
<blockquote>
<p>The inclusion of a type specific path (such as "Patient.deceasedBoolean") SHALL NOT be interpreted as constraining allowed types, but instead, it constrains the use of a particular type</p>
</blockquote>
<p>This is a change introduced in R4.  Prior to R4, the use of choice type renaming <em>did</em> constrain the available types.  But in R4, that behavior was removed (as detailed in firely's blog).</p>



<a name="231567555"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Choice%20Type%20Renaming%20Should%20Not%20Constrain%20Types/near/231567555" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Choice.20Type.20Renaming.20Should.20Not.20Constrain.20Types.html#231567555">(Mar 24 2021 at 01:02)</a>:</h4>
<p>But... <span class="user-mention" data-user-id="397998">@Max Körlinge</span> discovered over in the <a href="#narrow/stream/215610-shorthand/topic/Adding.20a.20value.20type.20to.20value.5Bx.5D/near/231534976">#shorthand stream</a> that when the differential contains elements that use the type slice renaming syntax, the IG Publisher is generating a snapshot that constrains the types only to the ones noted in the differential and produces a <em>closed</em> type slicing.  This seems to go directly against what the spec states should happen.</p>



<a name="231568039"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Choice%20Type%20Renaming%20Should%20Not%20Constrain%20Types/near/231568039" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Choice.20Type.20Renaming.20Should.20Not.20Constrain.20Types.html#231568039">(Mar 24 2021 at 01:09)</a>:</h4>
<p>I have an example project (which I will attach) that reproduces the behavior.  The differential of an Observation contains only these two elements:</p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code><span class="p">[{</span>
  <span class="nt">"id"</span><span class="p">:</span> <span class="s2">"Observation.valueCodeableConcept"</span><span class="p">,</span>
  <span class="nt">"path"</span><span class="p">:</span> <span class="s2">"Observation.valueCodeableConcept"</span><span class="p">,</span>
  <span class="nt">"min"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nt">"max"</span><span class="p">:</span> <span class="s2">"1"</span><span class="p">,</span>
  <span class="nt">"type"</span><span class="p">:</span> <span class="p">[{</span> <span class="nt">"code"</span><span class="p">:</span> <span class="s2">"CodeableConcept"</span> <span class="p">}],</span>
  <span class="nt">"mustSupport"</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">},</span>
<span class="p">{</span>
  <span class="nt">"id"</span><span class="p">:</span> <span class="s2">"Observation.valueQuantity"</span><span class="p">,</span>
  <span class="nt">"path"</span><span class="p">:</span> <span class="s2">"Observation.valueQuantity"</span><span class="p">,</span>
  <span class="nt">"min"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nt">"max"</span><span class="p">:</span> <span class="s2">"1"</span><span class="p">,</span>
  <span class="nt">"type"</span><span class="p">:</span> <span class="p">[{</span> <span class="nt">"code"</span><span class="p">:</span> <span class="s2">"Quantity"</span> <span class="p">}],</span>
  <span class="nt">"mustSupport"</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">}]</span>
</code></pre></div>
<p>but when you build it w/ the IG Publisher, the <code>value[x]</code> element gets generated like this (with irrelevant properties removed for brevity):</p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code><span class="p">{</span>
  <span class="nt">"id"</span><span class="p">:</span> <span class="s2">"Observation.value[x]"</span><span class="p">,</span>
  <span class="nt">"path"</span><span class="p">:</span> <span class="s2">"Observation.value[x]"</span><span class="p">,</span>
  <span class="nt">"slicing"</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">"discriminator"</span><span class="p">:</span> <span class="p">[{</span> <span class="nt">"type"</span><span class="p">:</span> <span class="s2">"type"</span><span class="p">,</span> <span class="nt">"path"</span><span class="p">:</span> <span class="s2">"$this"</span> <span class="p">}],</span>
    <span class="nt">"ordered"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nt">"rules"</span><span class="p">:</span> <span class="s2">"closed"</span>
  <span class="p">},</span>
  <span class="nt">"type"</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span> <span class="nt">"code"</span><span class="p">:</span> <span class="s2">"CodeableConcept"</span> <span class="p">},</span>
    <span class="p">{</span> <span class="nt">"code"</span><span class="p">:</span> <span class="s2">"Quantity"</span> <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>



<a name="231568290"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Choice%20Type%20Renaming%20Should%20Not%20Constrain%20Types/near/231568290" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Choice.20Type.20Renaming.20Should.20Not.20Constrain.20Types.html#231568290">(Mar 24 2021 at 01:13)</a>:</h4>
<p>This seems wrong to me based on my understanding of the R4 spec, but I wanted confirmation before I file a bug against the publisher.  Also, I'm not sure where I am supposed to file bugs against the publisher (Jira? GitHub?).  You can reproduce using this simple FSH project: <a href="/user_uploads/10155/wUeyYOaKjUl3vBMY7JqdJobM/ChoiceConstraintsIG.zip">ChoiceConstraintsIG.zip</a></p>



<a name="232647824"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Choice%20Type%20Renaming%20Should%20Not%20Constrain%20Types/near/232647824" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ward Weistra <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Choice.20Type.20Renaming.20Should.20Not.20Constrain.20Types.html#232647824">(Mar 31 2021 at 19:10)</a>:</h4>
<p>Just verified that this does not seem to happen with the .NET SDK. <a href="https://simplifier.net/testproject153/myobservationwithchoices">This is the resource on Simplifier</a>. Looking at the rendering or downloading (Download &gt; Download with snapshot) the slicing is not constrained to Quantity only.</p>



<a name="234799793"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Choice%20Type%20Renaming%20Should%20Not%20Constrain%20Types/near/234799793" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Choice.20Type.20Renaming.20Should.20Not.20Constrain.20Types.html#234799793">(Apr 16 2021 at 06:14)</a>:</h4>
<p>I think it looks like a bug. The code is the snapshot generator, so bugs here: <a href="https://github.com/hapifhir/org.hl7.fhir.core/issues">https://github.com/hapifhir/org.hl7.fhir.core/issues</a>, and the test cases for it are here: <a href="https://github.com/FHIR/fhir-test-cases/tree/master/r5/snapshot-generation">https://github.com/FHIR/fhir-test-cases/tree/master/r5/snapshot-generation</a> - see <a href="https://github.com/FHIR/fhir-test-cases/blob/master/r5/snapshot-generation/manifest.xml">https://github.com/FHIR/fhir-test-cases/blob/master/r5/snapshot-generation/manifest.xml</a> for an overview, and the relevant test cases of the obs-X ones</p>



<a name="235698141"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Choice%20Type%20Renaming%20Should%20Not%20Constrain%20Types/near/235698141" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ward Weistra <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Choice.20Type.20Renaming.20Should.20Not.20Constrain.20Types.html#235698141">(Apr 22 2021 at 15:25)</a>:</h4>
<p>Seen this <span aria-label="point up" class="emoji emoji-1f446" role="img" title="point up">:point_up:</span> <span class="user-mention" data-user-id="191469">@Chris Moesel</span> ?</p>



<a name="235700693"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Choice%20Type%20Renaming%20Should%20Not%20Constrain%20Types/near/235700693" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Choice.20Type.20Renaming.20Should.20Not.20Constrain.20Types.html#235700693">(Apr 22 2021 at 15:42)</a>:</h4>
<p>Yeah, but forgot to file a bug and didn't get a chance to look at the test cases.  <span class="user-mention" data-user-id="191316">@Grahame Grieve</span> -- are you looking for both a bug report and some failing test cases?</p>



<a name="235744707"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Choice%20Type%20Renaming%20Should%20Not%20Constrain%20Types/near/235744707" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Choice.20Type.20Renaming.20Should.20Not.20Constrain.20Types.html#235744707">(Apr 22 2021 at 20:45)</a>:</h4>
<p>well there's already test cases - do you think they're wrong?</p>



<a name="235762213"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Choice%20Type%20Renaming%20Should%20Not%20Constrain%20Types/near/235762213" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Choice.20Type.20Renaming.20Should.20Not.20Constrain.20Types.html#235762213">(Apr 22 2021 at 23:05)</a>:</h4>
<p>OK.  I just took a look.  Unless I'm missing it, I don't see any test cases that actually exercise this feature.  I'm concerned about how the snapshot generator handles choice type renaming in the differential.  I see many tests with something like this:</p>
<div class="codehilite" data-code-language="XML"><pre><span></span><code><span class="nt">&lt;differential&gt;</span>
    <span class="nt">&lt;element&gt;</span>
      <span class="nt">&lt;path</span> <span class="na">value=</span><span class="s">"Observation.value[x]"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;slicing&gt;</span>
        <span class="nt">&lt;rules</span> <span class="na">value=</span><span class="s">"open"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/slicing&gt;</span>
    <span class="nt">&lt;/element&gt;</span>
    <span class="nt">&lt;element&gt;</span>
      <span class="nt">&lt;path</span> <span class="na">value=</span><span class="s">"Observation.value[x]"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;sliceName</span> <span class="na">value=</span><span class="s">"valueQuantity"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;type&gt;</span>
        <span class="nt">&lt;code</span> <span class="na">value=</span><span class="s">"Quantity"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/type&gt;</span>
      <span class="nt">&lt;binding&gt;</span>
        <span class="nt">&lt;strength</span> <span class="na">value=</span><span class="s">"required"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;valueSet</span> <span class="na">value=</span><span class="s">"http://somewhere/something-else"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/binding&gt;</span>
    <span class="nt">&lt;/element&gt;</span>
<span class="nt">&lt;/differential&gt;</span>
</code></pre></div>
<p>But the issue I raised would require a test that looks more like this:</p>
<div class="codehilite" data-code-language="XML"><pre><span></span><code><span class="nt">&lt;differential&gt;</span>
    <span class="nt">&lt;element&gt;</span>
      <span class="nt">&lt;path</span> <span class="na">value=</span><span class="s">"Observation.valueQuantity"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;type&gt;</span>
        <span class="nt">&lt;code</span> <span class="na">value=</span><span class="s">"Quantity"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/type&gt;</span>
      <span class="nt">&lt;binding&gt;</span>
        <span class="nt">&lt;strength</span> <span class="na">value=</span><span class="s">"required"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;valueSet</span> <span class="na">value=</span><span class="s">"http://somewhere/something-else"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/binding&gt;</span>
    <span class="nt">&lt;/element&gt;</span>
<span class="nt">&lt;/differential&gt;</span>
</code></pre></div>
<p>This test case should actually act exactly like the test case above it -- because when choice type renaming (e.g., path <code>Observation.valueQuantity</code>) is used in R4:</p>
<ul>
<li>open type slicing should be inferred</li>
<li>correct sliceName (<code>valueQuantity</code>) should be inferred</li>
<li>value[x] base element should <em>not</em> be type-constrained to only Quantity (this is where I think the snapshot generator does it wrong)</li>
</ul>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
