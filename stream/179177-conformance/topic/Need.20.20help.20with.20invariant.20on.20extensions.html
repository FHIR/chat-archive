---
layout: page
title: "FHIR Chat  · Need  help with invariant on extensions · conformance"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/index.html">conformance</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Need.20.20help.20with.20invariant.20on.20extensions.html">Need  help with invariant on extensions</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="153888516"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Need%20%20help%20with%20invariant%20on%20extensions/near/153888516" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Need.20.20help.20with.20invariant.20on.20extensions.html#153888516">(May 08 2017 at 16:01)</a>:</h4>
<p>I created this profile: <a href="https://simplifier.net/BasisprofilDE/address-de-basis" target="_blank" title="https://simplifier.net/BasisprofilDE/address-de-basis">https://simplifier.net/BasisprofilDE/address-de-basis</a><br>
It has two extensions on Adress.line: one for the house number and one for the street name<br>
I added a constraint to each which is supposed to test whether the extensions are populated and make sure, that Address.line is also filled.<br>
The point is to prevent implementers from only using the extensions without populating the Adress.line element.</p>
<p>However, this  doesn't seem to work:</p>
<div class="codehilite"><pre><span></span>            <span class="nt">&lt;constraint&gt;</span>
                <span class="nt">&lt;key</span> <span class="na">value=</span><span class="s">&quot;add-1&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;severity</span> <span class="na">value=</span><span class="s">&quot;error&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;human</span> <span class="na">value=</span><span class="s">&quot;Wenn die Extension Hausnummer verwendet wird, muss auch die Adress-Zeile gefüllt werden&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;expression</span> <span class="na">value=</span><span class="s">&quot;line.extension:Hausnummer.empty() or line.exists()&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/constraint&gt;</span>
</pre></div>


<p>When I try to validate the example on Simplifier, I get this error:<br>
Evaluation of FhirPath for constraint 'add-1' failed: Compilation failed: Parsing failure: unexpected ':'; expected end of input (Line 1, Column 15); recently consumed: .extension </p>
<p>Location: Organization.address[0] </p>
<p>Apparently my expression is wrong...</p>



<a name="153888521"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Need%20%20help%20with%20invariant%20on%20extensions/near/153888521" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Marten Smits <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Need.20.20help.20with.20invariant.20on.20extensions.html#153888521">(May 08 2017 at 16:43)</a>:</h4>
<p>I think it should be :</p>
<p><code>line.extension(http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-streetName).empty() or line.exists()</code></p>



<a name="153888527"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Need%20%20help%20with%20invariant%20on%20extensions/near/153888527" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Need.20.20help.20with.20invariant.20on.20extensions.html#153888527">(May 08 2017 at 17:16)</a>:</h4>
<div class="codehilite"><pre><span></span>line.extension(&#39;http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-streetName&#39;).empty() or line.exists()
</pre></div>



<a name="153888601"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Need%20%20help%20with%20invariant%20on%20extensions/near/153888601" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Need.20.20help.20with.20invariant.20on.20extensions.html#153888601">(May 09 2017 at 08:25)</a>:</h4>
<p>Thank you! That helped!<br>
I think the FHIRPath documentation could need an example for this...<br>
I had trouble finding hints at <a href="http://hl7.org/fhirpath/" target="_blank" title="http://hl7.org/fhirpath/">http://hl7.org/fhirpath/</a> about how to deal with extensions like this.</p>



<a name="153888603"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Need%20%20help%20with%20invariant%20on%20extensions/near/153888603" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Marten Smits <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Need.20.20help.20with.20invariant.20on.20extensions.html#153888603">(May 09 2017 at 08:34)</a>:</h4>
<p>I agree, that documentation page needs some love. Happy to help with that!</p>



<a name="153888605"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Need%20%20help%20with%20invariant%20on%20extensions/near/153888605" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Need.20.20help.20with.20invariant.20on.20extensions.html#153888605">(May 09 2017 at 08:41)</a>:</h4>
<p>you can create tasks for FHIRPath in gForge</p>



<a name="153888608"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Need%20%20help%20with%20invariant%20on%20extensions/near/153888608" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Need.20.20help.20with.20invariant.20on.20extensions.html#153888608">(May 09 2017 at 08:50)</a>:</h4>
<p><a href="http://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=13350" target="_blank" title="http://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=13350">GF#13350</a></p>



<a name="153888610"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Need%20%20help%20with%20invariant%20on%20extensions/near/153888610" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Need.20.20help.20with.20invariant.20on.20extensions.html#153888610">(May 09 2017 at 08:50)</a>:</h4>
<p>BTW: Gforge still lists only "fluentpath" in the HTML Page(s) box</p>



<a name="153888620"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Need%20%20help%20with%20invariant%20on%20extensions/near/153888620" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Need.20.20help.20with.20invariant.20on.20extensions.html#153888620">(May 09 2017 at 09:22)</a>:</h4>
<p><span class="user-mention" data-user-id="191320">@Lloyd McKenzie</span> please rename fluentpath to fhirpath</p>



<a name="153888649"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Need%20%20help%20with%20invariant%20on%20extensions/near/153888649" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Need.20.20help.20with.20invariant.20on.20extensions.html#153888649">(May 09 2017 at 12:15)</a>:</h4>
<p>Done</p>



<a name="153895561"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Need%20%20help%20with%20invariant%20on%20extensions/near/153895561" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Need.20.20help.20with.20invariant.20on.20extensions.html#153895561">(Jun 28 2017 at 21:47)</a>:</h4>
<p>About this: </p>
<div class="codehilite"><pre><span></span>line.extension(&#39;http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-streetName&#39;).empty() or line.exists()
</pre></div>


<p>does line.exists() return true if it's value is empty but it has extensions?<br>
The invariant doesn't seem to work (at least not on simplifier, currently)</p>



<a name="153895600"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Need%20%20help%20with%20invariant%20on%20extensions/near/153895600" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Need.20.20help.20with.20invariant.20on.20extensions.html#153895600">(Jun 29 2017 at 06:20)</a>:</h4>
<p>yes. Looks like it needs .hasValue()</p>



<a name="153895601"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Need%20%20help%20with%20invariant%20on%20extensions/near/153895601" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Need.20.20help.20with.20invariant.20on.20extensions.html#153895601">(Jun 29 2017 at 06:20)</a>:</h4>
<p>not .exists()</p>



<a name="153895629"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Need%20%20help%20with%20invariant%20on%20extensions/near/153895629" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Stefan Lang <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Need.20.20help.20with.20invariant.20on.20extensions.html#153895629">(Jun 29 2017 at 07:57)</a>:</h4>
<p>Sounds obvious, when you don't stumble upon such things around midnight <img alt=":joy:" class="emoji" src="/static/generated/emoji/images/emoji/joy.png" title=":joy:"><br>
I also just confirmed it's not a Simplifier issue; same behaviour for the official validator.</p>



<a name="153895635"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Need%20%20help%20with%20invariant%20on%20extensions/near/153895635" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Need.20.20help.20with.20invariant.20on.20extensions.html#153895635">(Jun 29 2017 at 08:48)</a>:</h4>
<p>Can anyone explain, why this example</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;Patient&gt;</span>
    <span class="nt">&lt;meta&gt;</span>
        <span class="nt">&lt;profile</span> <span class="na">value=</span><span class="s">&quot;http://fhir.de/StructureDefinition/patient-de-basis&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/meta&gt;</span>
    <span class="nt">&lt;identifier&gt;</span>
        <span class="nt">&lt;system</span> <span class="na">value=</span><span class="s">&quot;http://fhir.de/NamingSystem/gkv/kvid-10&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;value</span> <span class="na">value=</span><span class="s">&quot;G995030567&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/identifier&gt;</span>
    <span class="nt">&lt;name&gt;</span>
        <span class="nt">&lt;family</span> <span class="na">value=</span><span class="s">&quot;Mustermann&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;given</span> <span class="na">value=</span><span class="s">&quot;Max&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;address&gt;</span>
        <span class="nt">&lt;line&gt;</span>
            <span class="nt">&lt;extension</span> <span class="na">url=</span><span class="s">&quot;http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-streetName&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;valueString</span> <span class="na">value=</span><span class="s">&quot;Testwegs&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/extension&gt;</span>
        <span class="nt">&lt;/line&gt;</span>
    <span class="nt">&lt;/address&gt;</span>
<span class="nt">&lt;/Patient&gt;</span>
</pre></div>


<p><a href="https://simplifier.net/LHITCSandbox/Patient-example345/~xml" target="_blank" title="https://simplifier.net/LHITCSandbox/Patient-example345/~xml">https://simplifier.net/LHITCSandbox/Patient-example345/~xml</a><br>
successfully validates against this Patient profile<br>
<a href="https://simplifier.net/BasisprofilDE/patient-de-basis" target="_blank" title="https://simplifier.net/BasisprofilDE/patient-de-basis">https://simplifier.net/BasisprofilDE/patient-de-basis</a><br>
which references this Address profile<br>
<a href="https://simplifier.net/BasisprofilDE/address-de-basis" target="_blank" title="https://simplifier.net/BasisprofilDE/address-de-basis">https://simplifier.net/BasisprofilDE/address-de-basis</a><br>
which has this constraint on the streetname-extension:<br>
<code>line.extension('http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-streetName').empty() or line.hasValue())</code></p>
<p>What we're trying to accomplish here is to enforce that the address.line value is populated, whenever one of the line-extensions is populated</p>



<a name="153895689"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Need%20%20help%20with%20invariant%20on%20extensions/near/153895689" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Need.20.20help.20with.20invariant.20on.20extensions.html#153895689">(Jun 29 2017 at 19:41)</a>:</h4>
<p>Ok, I did two things:<br>
a) I moved the invariants from the extensions to the Address. I assume the FHIR-Path expressions are always relative to the node to which they are assigned? In that case of course the expression couldn't be evaluated, as the extensions themselves don't have a line attribute<br>
b) opened and saved the patient profile in forge and re- commited it to simplifier <br>
I didn't realize, the address profile is embedded in the snapshot of the patient profile!<br>
I thought that was a reference that's evaluated at runtime during validation. But apparently not.</p>
<p>Anyway: it's working now!</p>



<a name="153895823"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Need%20%20help%20with%20invariant%20on%20extensions/near/153895823" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Need.20.20help.20with.20invariant.20on.20extensions.html#153895823">(Jun 30 2017 at 11:19)</a>:</h4>
<p>"I didn't realize, the address profile is embedded in the snapshot of the patient profile!"</p>
<p>Yes, if a differential adds a constraint on an element that is a datatype (in this case of type Address), the node will be expanded into the profile, to be able to express that constraint. All non-changed properties of the datatype will then also be copied into the snapshot....</p>



<a name="153895826"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Need%20%20help%20with%20invariant%20on%20extensions/near/153895826" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Need.20.20help.20with.20invariant.20on.20extensions.html#153895826">(Jun 30 2017 at 11:56)</a>:</h4>
<p>Makes sense. It's a bit tricky on Simplifier though, to maintain consistency among the profiles, as we have to maually recreate all dependent snapshots with Forge and reupload them, when changing the profile of a datatype. </p>



<a name="153895842"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Need%20%20help%20with%20invariant%20on%20extensions/near/153895842" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Need.20.20help.20with.20invariant.20on.20extensions.html#153895842">(Jun 30 2017 at 13:59)</a>:</h4>
<p>Would a console-type app help that you could run over all profiles?</p>



<a name="153895843"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Need%20%20help%20with%20invariant%20on%20extensions/near/153895843" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Need.20.20help.20with.20invariant.20on.20extensions.html#153895843">(Jun 30 2017 at 14:00)</a>:</h4>
<p>This is of course the classic case where a dependency changes, and we need to update all the snapshots.  I don't think this should be done automatically - the author of the referring SD might want to decide for him/herself when to do this....</p>



<a name="153895896"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Need%20%20help%20with%20invariant%20on%20extensions/near/153895896" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Need.20.20help.20with.20invariant.20on.20extensions.html#153895896">(Jul 01 2017 at 07:34)</a>:</h4>
<p>I think the best thing would be to have a button at the profile page in simplifier to rebuild the snapshot and one on the project page to rebuild all snapshots (once simplifier is able to create snapshots...) <br>
Until then a console app that goes through the contents of a folder and recreates all the snapshots would be a nice workaround.</p>



<a name="153895907"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Need%20%20help%20with%20invariant%20on%20extensions/near/153895907" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Stefan Lang <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Need.20.20help.20with.20invariant.20on.20extensions.html#153895907">(Jul 01 2017 at 17:05)</a>:</h4>
<p>Doesn't the official IG publisher do that?</p>



<a name="153895927"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Need%20%20help%20with%20invariant%20on%20extensions/near/153895927" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Need.20.20help.20with.20invariant.20on.20extensions.html#153895927">(Jul 03 2017 at 04:17)</a>:</h4>
<p>yes the IG Publisher regenerates all the snapshots. But you might not be using that </p>



<a name="153896062"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/Need%20%20help%20with%20invariant%20on%20extensions/near/153896062" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Martijn Harthoorn <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/Need.20.20help.20with.20invariant.20on.20extensions.html#153896062">(Jul 05 2017 at 07:57)</a>:</h4>
<p><span class="user-mention" data-user-id="191450">@Simone Heckmann</span> "a button at the profile page" -- we are working on that right now.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
