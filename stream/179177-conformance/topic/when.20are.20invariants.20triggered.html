---
layout: page
title: "FHIR Chat  · when are invariants triggered · conformance"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/index.html">conformance</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html">when are invariants triggered</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="246979958"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/246979958" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#246979958">(Jul 23 2021 at 13:52)</a>:</h4>
<p>I have an odd validation issue with an invariant on an Extension: i get an error in Java, but not in .net.</p>



<a name="246980030"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/246980030" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#246980030">(Jul 23 2021 at 13:53)</a>:</h4>
<p>Specifics?</p>



<a name="246980078"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/246980078" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#246980078">(Jul 23 2021 at 13:53)</a>:</h4>
<p>It is an extension from the german base profiles: <a href="https://simplifier.net/basisprofil-de-r4/genderamtlichde">https://simplifier.net/basisprofil-de-r4/genderamtlichde</a> which contains an invariant:<br>
<code>%resource.where(gender='other').exists()</code></p>



<a name="246980189"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/246980189" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#246980189">(Jul 23 2021 at 13:54)</a>:</h4>
<p>If i dont have the Extension in an Instance and gender is NOT other: Java validator throws the error, .Net accepts it.</p>



<a name="246980301"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/246980301" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#246980301">(Jul 23 2021 at 13:55)</a>:</h4>
<p>To me it seems, that .Net evaluates the expression only if in the instance the field is populated. The Java Validater evaluates the invariant independent from wheter the instance uses the extension?</p>



<a name="246980474"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/246980474" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#246980474">(Jul 23 2021 at 13:56)</a>:</h4>
<p>I tried to get the correct behaviour from the FHIR spec, but wasn't succesfull.</p>



<a name="246991798"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/246991798" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#246991798">(Jul 23 2021 at 15:27)</a>:</h4>
<p>To reproduce:</p>
<p><strong>java</strong><br>
<code>java -jar ~/Downloads/validator_cli.jar 'https://simplifier.net/isik/relatedperson-example/$download?format=json'  -version 4.0 -ig de.gematik.isik-basismodul#1.0.0</code><br>
will show an error</p>
<p><strong>.net</strong><br>
<a href="https://simplifier.net/isik/relatedperson-example/$validate">https://simplifier.net/isik/relatedperson-example/$validate</a><br>
won't complain about the invariant contained in an extension</p>
<p>used invariant inside an gender extension: <code>%resource.where(gender='other').exists()</code></p>



<a name="246991986"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/246991986" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#246991986">(Jul 23 2021 at 15:28)</a>:</h4>
<p>Is the error one you would expect?  I.e. is it the Java or .NET implementation that need fixing (or both)?</p>



<a name="246992051"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/246992051" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#246992051">(Jul 23 2021 at 15:28)</a>:</h4>
<p>any ideas why? <span class="user-mention" data-user-id="191316">@Grahame Grieve</span> <span class="user-mention" data-user-id="191328">@Ewout Kramer</span> <br>
The only thing in the spec about the correct behaviour was </p>
<blockquote>
<p>"Expression   : A FHIRPath expression that must evaluate to true when run on the element"</p>
</blockquote>



<a name="246992074"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/246992074" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#246992074">(Jul 23 2021 at 15:28)</a>:</h4>
<p>Which is ambigous to me</p>



<a name="246992119"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/246992119" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#246992119">(Jul 23 2021 at 15:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="191320">Lloyd McKenzie</span> <a href="#narrow/stream/179177-conformance/topic/when.20are.20invariants.20triggered/near/246991986">said</a>:</p>
<blockquote>
<p>Is the error one you would expect?  I.e. is it the Java or .NET implementation that need fixing (or both)?</p>
</blockquote>
<p>so i would say: i don't know?</p>



<a name="246992472"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/246992472" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#246992472">(Jul 23 2021 at 15:31)</a>:</h4>
<p>i was thinking, that .Net is right here, and invariants are only invoked if the element on which the invariant is placed is present in an instance.</p>



<a name="246992506"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/246992506" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#246992506">(Jul 23 2021 at 15:31)</a>:</h4>
<p>but now i'm not so sure anymore.</p>



<a name="246992751"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/246992751" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#246992751">(Jul 23 2021 at 15:33)</a>:</h4>
<p>i tried to recreate a very simple example, placing an invariant on Patient.name.given, works in .net:<br>
<a href="https://simplifier.net/patrickssandbox/testinstance/$validate">https://simplifier.net/patrickssandbox/testinstance/$validate</a></p>



<a name="246993133"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/246993133" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#246993133">(Jul 23 2021 at 15:36)</a>:</h4>
<p>and no error in java.</p>



<a name="246993330"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/246993330" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#246993330">(Jul 23 2021 at 15:37)</a>:</h4>
<p>To me these are 2 issues:</p>
<ul>
<li>when does an invariant  hast to be run on an element? Always or only if present? I think the latter.</li>
<li>the java validator evaluates invariants differently if they are part of an extension or part of the profile itself</li>
</ul>



<a name="246994557"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/246994557" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#246994557">(Jul 23 2021 at 15:47)</a>:</h4>
<p>As I read it again, this does seem like a Java error.  Invariants defined in an extension should only fire if the extension profile (based on URL slicing) is determined to apply.  Can you submit a tracker issue against the validator?</p>



<a name="247010682"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/247010682" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#247010682">(Jul 23 2021 at 17:52)</a>:</h4>
<p>sure: <a href="https://github.com/hapifhir/org.hl7.fhir.core/issues/563">https://github.com/hapifhir/org.hl7.fhir.core/issues/563</a></p>



<a name="247073835"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/247073835" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#247073835">(Jul 24 2021 at 13:04)</a>:</h4>
<p>Update: I mixed up the invariant yesterday.<br>
The reason for the error was that the java validator imho does a correct fhirpath interpretation:<br>
invariant: <code>gender='other' implies gender.extension('http://fhir.de/StructureDefinition/gender-amtlich-de').exists()</code></p>



<a name="247073851"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/247073851" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#247073851">(Jul 24 2021 at 13:05)</a>:</h4>
<p>if gender is missing -&gt; gender = 'other' evaluates to []</p>



<a name="247073862"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/247073862" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#247073862">(Jul 24 2021 at 13:05)</a>:</h4>
<p>[] implies ender.extension('http://fhir.de/StructureDefinition/gender-amtlich-de').exists() only evaluates to true if the right argument evaluates to true.</p>



<a name="247073941"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/247073941" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#247073941">(Jul 24 2021 at 13:07)</a>:</h4>
<p>Will close the issue and start a new thread about the different behaviour of equals in different fhirpath implementations.</p>



<a name="247082282"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/247082282" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Zautke <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#247082282">(Jul 24 2021 at 16:12)</a>:</h4>
<p><span class="user-mention" data-user-id="191451">@Patrick Werner</span> I think we need to switch back and forth a bit between the issues. The latest version of the .NET SDK correctly returns an empty collection of the comparison part. However, it will return true for the following statement: <code>{} implies true</code>. If I understand the differences in the FHIRPath engines correctly, the java engine will return an empty collection in this case.</p>



<a name="247083320"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/247083320" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#247083320">(Jul 24 2021 at 16:42)</a>:</h4>
<p>Thanks for the clarification. Will continue in the other thread: <a href="#narrow/stream/179177-conformance/topic/different.20implementations.3A.20fhirpath.3A.20.5B.5D.20.3D.20'string">https://chat.fhir.org/#narrow/stream/179177-conformance/topic/different.20implementations.3A.20fhirpath.3A.20.5B.5D.20.3D.20'string</a>'</p>



<a name="247083568"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/247083568" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Zautke <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#247083568">(Jul 24 2021 at 16:48)</a>:</h4>
<p><span class="user-mention" data-user-id="191451">@Patrick Werner</span> and I continued to debug the issue. All engines, in their latest versions, handle the implies statements with an empty input collection equally</p>



<a name="247083573"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/247083573" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#247083573">(Jul 24 2021 at 16:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="193430">Alexander Zautke</span> <a href="#narrow/stream/179177-conformance/topic/when.20are.20invariants.20triggered/near/247082282">said</a>:</p>
<blockquote>
<p>{} implies true```. If I understand the differences in the FHIRPath engines correctly, the java engine will return an empty collection in this case.</p>
</blockquote>
<p>The java engines returns true and is compliant to the spec as well</p>



<a name="247083645"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/247083645" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Zautke <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#247083645">(Jul 24 2021 at 16:50)</a>:</h4>
<p>The potentially unexpected issue might be the case where gender is optional, than the result of the statement above  depends on the existence of the extension</p>



<a name="247083798"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/247083798" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#247083798">(Jul 24 2021 at 16:54)</a>:</h4>
<p>exactly</p>



<a name="247084506"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/247084506" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Zautke <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#247084506">(Jul 24 2021 at 17:13)</a>:</h4>
<p>As <code>{} and false</code> results in false, adding <code>gender.exists()</code> to the expression, should fix this</p>



<a name="247319759"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/247319759" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#247319759">(Jul 27 2021 at 11:14)</a>:</h4>
<p>For reference: <a href="http://hl7.org/fhirpath/#implies">http://hl7.org/fhirpath/#implies</a></p>



<a name="247319780"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/247319780" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#247319780">(Jul 27 2021 at 11:15)</a>:</h4>
<p>So, yes, <code>{} implies true</code> == <code>true</code>.</p>



<a name="247319826"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/247319826" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#247319826">(Jul 27 2021 at 11:15)</a>:</h4>
<p>If my memory serves me correctly, we added explicit unit tests to the FhirPath test suites at the beginning of 2020, so it seems these resulted in the latest versions of the engines aligning on this (if I understand Alex and Patrick correctly).</p>



<a name="247803313"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179177-conformance/topic/when%20are%20invariants%20triggered/near/247803313" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179177-conformance/topic/when.20are.20invariants.20triggered.html#247803313">(Jul 31 2021 at 13:02)</a>:</h4>
<p>Correct. Only issue was Simplifier using an older/different .net version.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
