---
layout: page
title: "FHIR Chat  · Generate Snapshot from StructureDefinition · hapi"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/index.html">hapi</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Generate.20Snapshot.20from.20StructureDefinition.html">Generate Snapshot from StructureDefinition</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="226666837"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Generate%20Snapshot%20from%20StructureDefinition/near/226666837" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Mate <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Generate.20Snapshot.20from.20StructureDefinition.html#226666837">(Feb 17 2021 at 14:53)</a>:</h4>
<p>Hello everybody,</p>
<p>I have a "differential" StructureDefinition (exported from Simplifier) and would like to derive a Snapshot from it using the HAPI library.</p>
<p>Unfortunately I cannot get the sample code from <a href="https://hapifhir.io/hapi-fhir/docs/validation/examples.html">https://hapifhir.io/hapi-fhir/docs/validation/examples.html</a> working, as it seems to be outdated. I've tried adopting it to the most recent version of the HAPI library (5.2.1) with no real success. </p>
<p>This is what I came up with (not really knowing what I am doing):</p>
<div class="codehilite" data-code-language="Java"><pre><span></span><code><span class="n">StructureDefinition</span> <span class="n">differential</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="na">parseResource</span><span class="p">(</span><span class="n">StructureDefinition</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">jsonData</span><span class="p">);</span>
<span class="n">DefaultProfileValidationSupport</span> <span class="n">defaultSupport</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultProfileValidationSupport</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="n">SnapshotGeneratingValidationSupport</span> <span class="n">snapshotGenerator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SnapshotGeneratingValidationSupport</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="n">ValidationSupportChain</span> <span class="n">chain</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ValidationSupportChain</span><span class="p">(</span><span class="n">defaultSupport</span><span class="p">,</span> <span class="n">snapshotGenerator</span><span class="p">);</span>
<span class="n">ValidationSupportContext</span> <span class="n">theValidationSupportContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ValidationSupportContext</span><span class="p">(</span><span class="n">defaultSupport</span><span class="p">);</span>
<span class="n">StructureDefinition</span> <span class="n">snapshot</span> <span class="o">=</span> <span class="p">(</span><span class="n">StructureDefinition</span><span class="p">)</span> <span class="n">chain</span><span class="p">.</span><span class="na">generateSnapshot</span><span class="p">(</span><span class="n">theValidationSupportContext</span><span class="p">,</span> <span class="n">differential</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="s">""</span><span class="p">);</span>
</code></pre></div>
<p>I then found the following code from Graham in this chat:</p>
<div class="codehilite" data-code-language="Java"><pre><span></span><code><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">makeSnapshot</span><span class="p">(</span><span class="n">StructureDefinition</span> <span class="n">sd</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">DefinitionException</span><span class="p">,</span> <span class="n">FHIRException</span> <span class="p">{</span>
    <span class="n">StructureDefinition</span> <span class="n">sdb</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="na">fetchResource</span><span class="p">(</span><span class="n">StructureDefinition</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">sd</span><span class="p">.</span><span class="na">getBaseDefinition</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sdb</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">makeSnapshot</span><span class="p">(</span><span class="n">sdb</span><span class="p">);</span>
        <span class="k">new</span> <span class="n">ProfileUtilities</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">).</span><span class="na">generateSnapshot</span><span class="p">(</span><span class="n">sdb</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">sd</span><span class="p">.</span><span class="na">getUrl</span><span class="p">(),</span> <span class="kc">null</span><span class="p">,</span> <span class="n">sd</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>But I could not get this working either. What is "context"? I've tried to initalize it with <code>static FhirContext context = FhirContext.forR4();</code> but this does not seem to work.</p>
<p>I would be happy if someone has a tip for me on how to get ahead here.</p>
<p>Many thanks, Sebastian</p>



<a name="226678868"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Generate%20Snapshot%20from%20StructureDefinition/near/226678868" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Mate <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Generate.20Snapshot.20from.20StructureDefinition.html#226678868">(Feb 17 2021 at 16:02)</a>:</h4>
<p>OK, thanks to <a href="https://github.com/hapifhir/hapi-fhir/blob/aa05667761bc41c12445400ef724f89e46dbf5a1/hapi-fhir-validation/src/test/java/org/hl7/fhir/r4/validation/FhirInstanceValidatorR4Test.java#L281">https://github.com/hapifhir/hapi-fhir/blob/aa05667761bc41c12445400ef724f89e46dbf5a1/hapi-fhir-validation/src/test/java/org/hl7/fhir/r4/validation/FhirInstanceValidatorR4Test.java#L281</a> I'm making some progress:</p>
<div class="codehilite" data-code-language="Java"><pre><span></span><code><span class="n">StructureDefinition</span> <span class="n">differential</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="na">parseResource</span><span class="p">(</span><span class="n">StructureDefinition</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">jsonData</span><span class="p">);</span>

<span class="n">DefaultProfileValidationSupport</span> <span class="n">defaultSupport</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultProfileValidationSupport</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="n">StructureDefinition</span> <span class="n">derived</span> <span class="o">=</span> <span class="n">differential</span><span class="p">;</span>
<span class="n">StructureDefinition</span> <span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">StructureDefinition</span><span class="p">)</span> <span class="n">defaultSupport</span><span class="p">.</span><span class="na">fetchStructureDefinition</span><span class="p">(</span><span class="n">derived</span><span class="p">.</span><span class="na">getBaseDefinition</span><span class="p">());</span>
<span class="n">IWorkerContext</span> <span class="n">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HapiWorkerContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">defaultSupport</span><span class="p">);</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">ValidationMessage</span><span class="o">&gt;</span> <span class="n">issues</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="n">ProfileUtilities</span> <span class="n">profileUtilities</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProfileUtilities</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="n">issues</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
<span class="n">profileUtilities</span><span class="p">.</span><span class="na">generateSnapshot</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">derived</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="s">""</span><span class="p">);</span>
</code></pre></div>
<p>It's still complaining "no base profile provided", but I will continue working on it tomorrow.</p>
<p>Sebastian</p>



<a name="226736746"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Generate%20Snapshot%20from%20StructureDefinition/near/226736746" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Generate.20Snapshot.20from.20StructureDefinition.html#226736746">(Feb 17 2021 at 22:19)</a>:</h4>
<p>looks like you haven't provided the base profile</p>



<a name="226779533"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Generate%20Snapshot%20from%20StructureDefinition/near/226779533" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Mate <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Generate.20Snapshot.20from.20StructureDefinition.html#226779533">(Feb 18 2021 at 08:41)</a>:</h4>
<p>The trick was to include</p>
<div class="codehilite"><pre><span></span><code>        &lt;dependency&gt;
            &lt;groupId&gt;ca.uhn.hapi.fhir&lt;/groupId&gt;
            &lt;artifactId&gt;hapi-fhir-validation-resources-r4&lt;/artifactId&gt;
            &lt;version&gt;4.2.0&lt;/version&gt;
        &lt;/dependency&gt;
</code></pre></div>
<p>into the pom.xml file. <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="226803278"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Generate%20Snapshot%20from%20StructureDefinition/near/226803278" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Mate <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Generate.20Snapshot.20from.20StructureDefinition.html#226803278">(Feb 18 2021 at 12:35)</a>:</h4>
<p>OK, I can now successfully generate snapshots based on the "official" FHIR profiles. I also figured out how to also load the other "custom" base profiles from my hard disk. But when trying to generate snapshots, I encounter errors of this type:</p>
<div class="codehilite"><pre><span></span><code>Found base profile: C:\Users\matesn\Documents\Development\Miracum GitLab\SimplifierParser\input\GeccoBaseCondition.json
Error in snapshot generation: Differential for https://www.netzwerk-universitaetsmedizin.de/fhir/StructureDefinition/chronic-lung-diseases with id: Condition.category has an element that is not marked with a snapshot match
Error in snapshot generation: Differential for https://www.netzwerk-universitaetsmedizin.de/fhir/StructureDefinition/chronic-lung-diseases with id: Condition.category.coding has an element that is not marked with a snapshot match
Error in snapshot generation: Differential for https://www.netzwerk-universitaetsmedizin.de/fhir/StructureDefinition/chronic-lung-diseases with id: Condition.category.coding:pulmonaryMedicine has an element that is not marked with a snapshot match
Error in snapshot generation: Differential for https://www.netzwerk-universitaetsmedizin.de/fhir/StructureDefinition/chronic-lung-diseases with id: Condition.category.coding:pulmonaryMedicine.system has an element that is not marked with a snapshot match
Error in snapshot generation: Differential for https://www.netzwerk-universitaetsmedizin.de/fhir/StructureDefinition/chronic-lung-diseases with id: Condition.category.coding:pulmonaryMedicine.code has an element that is not marked with a snapshot match
...
</code></pre></div>
<p>What's going on here? Any help/ideas highly appreciated.</p>
<p>Sebastian</p>



<a name="226803537"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Generate%20Snapshot%20from%20StructureDefinition/near/226803537" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Mate <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Generate.20Snapshot.20from.20StructureDefinition.html#226803537">(Feb 18 2021 at 12:38)</a>:</h4>
<p>Ah OK, found this: <a href="https://github.com/HL7/cda-ccda-2.2/issues/16">https://github.com/HL7/cda-ccda-2.2/issues/16</a> and this: <a href="https://github.com/highmed/highmed-dsf/issues/45">https://github.com/highmed/highmed-dsf/issues/45</a></p>



<a name="226803790"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Generate%20Snapshot%20from%20StructureDefinition/near/226803790" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Mate <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Generate.20Snapshot.20from.20StructureDefinition.html#226803790">(Feb 18 2021 at 12:41)</a>:</h4>
<p>OK, I see -- my base is also a differential -- I need to resolve this recursively ...</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
