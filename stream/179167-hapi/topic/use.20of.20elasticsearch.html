---
layout: page
title: "FHIR Chat  · use of elasticsearch · hapi"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/index.html">hapi</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html">use of elasticsearch</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="188360654"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188360654" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188360654">(Feb 17 2020 at 08:41)</a>:</h4>
<p><span class="user-mention" data-user-id="191319">@James Agnew</span> <br>
we see errors when trying to do valueset expansions (4.2.0) while using elasticsearch (6.8.6):</p>
<div class="codehilite"><pre><span></span>Caused by: org.hibernate.search.exception.SearchException: HSEARCH400002: Lucene query &#39;myCode:&quot;(message notification advice note)&quot;&#39; cannot be transformed into equivalent Elasticsearch query
    at org.hibernate.search.elasticsearch.impl.ToElasticsearch.fromLuceneQuery(ToElasticsearch.java:268)
    at org.hibernate.search.elasticsearch.impl.ToElasticsearch.convertBooleanQuery(ToElasticsearch.java:302)
    at org.hibernate.search.elasticsearch.impl.ToElasticsearch.fromLuceneQuery(ToElasticsearch.java:206)
    at org.hibernate.search.elasticsearch.impl.ElasticsearchLuceneQueryTranslator.convertLuceneQuery(ElasticsearchLuceneQueryTranslator.java:41)
    at org.hibernate.search.engine.impl.ImmutableSearchFactory.createQueryDescriptor(ImmutableSearchFactory.java:308)
    at org.hibernate.search.engine.impl.ImmutableSearchFactory.createHSQuery(ImmutableSearchFactory.java:291)
    at org.hibernate.search.engine.impl.MutableSearchFactory.createHSQuery(MutableSearchFactory.java:138)
    at org.hibernate.search.impl.FullTextSessionImpl.createFullTextQuery(FullTextSessionImpl.java:77)
    at org.hibernate.search.impl.FullTextSessionImpl.createFullTextQuery(FullTextSessionImpl.java:52)
    at ca.uhn.fhir.jpa.term.BaseTermReadSvcImpl.expandValueSetHandleIncludeOrExclude(BaseTermReadSvcImpl.java:614)
    at ca.uhn.fhir.jpa.term.BaseTermReadSvcImpl.lambda$expandValueSet$0(BaseTermReadSvcImpl.java:457)
    at org.springframework.transaction.support.TransactionTemplate.execute(TransactionTemplate.java:140)
...
</pre></div>


<ul>
<li>is this related to a malformed configuration/incorrect spring bindings on our side?</li>
</ul>



<a name="188362570"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188362570" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188362570">(Feb 17 2020 at 09:17)</a>:</h4>
<p>its triggered by the fact that org.apache.lucene.search.MultiPhraseQuery's are not currently mapped</p>



<a name="188363388"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188363388" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188363388">(Feb 17 2020 at 09:30)</a>:</h4>
<p>Which happens here: <a href="https://github.com/jamesagnew/hapi-fhir/blob/c5c1e3196b776c8b5cb6ddbf70845c024a73148f/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/term/BaseTermReadSvcImpl.java#L603" target="_blank" title="https://github.com/jamesagnew/hapi-fhir/blob/c5c1e3196b776c8b5cb6ddbf70845c024a73148f/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/term/BaseTermReadSvcImpl.java#L603">https://github.com/jamesagnew/hapi-fhir/blob/c5c1e3196b776c8b5cb6ddbf70845c024a73148f/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/term/BaseTermReadSvcImpl.java#L603</a></p>



<a name="188375471"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188375471" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188375471">(Feb 17 2020 at 12:50)</a>:</h4>
<p><span class="user-mention" data-user-id="191451">@Patrick Werner</span> - have you stumbled across this problem?</p>



<a name="188389106"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188389106" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188389106">(Feb 17 2020 at 15:58)</a>:</h4>
<p><span class="user-mention" data-user-id="191427">@Jens Villadsen</span> not yet, we are still using Lucene</p>



<a name="188399680"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188399680" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188399680">(Feb 17 2020 at 18:48)</a>:</h4>
<p>Currently, ElasticSearch 2.x is required as this is the version supported<br>
by the current GA release of Hibernate Search. They are seemingly very<br>
close to releasing a new major release though which will add support for<br>
ES5/6.</p>
<p>Cheers,<br>
James</p>



<a name="188399942"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188399942" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188399942">(Feb 17 2020 at 18:53)</a>:</h4>
<p>Sorry- I take that partially back.</p>
<p>It's 6.x that isn't supported, but 5.x is. So you should be able to do this using a 5.x release of ES.</p>



<a name="188405477"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188405477" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188405477">(Feb 17 2020 at 20:41)</a>:</h4>
<p>Awesome! Thx.</p>



<a name="188405526"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188405526" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188405526">(Feb 17 2020 at 20:42)</a>:</h4>
<p>I dont know why I insisted on using 6.x ...</p>



<a name="188405534"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188405534" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188405534">(Feb 17 2020 at 20:42)</a>:</h4>
<div class="message_inline_image"><a href="https://media.tenor.com/images/abcd1c505f535e2958ac85b64a901953/tenor.gif" target="_blank" title="https://media.tenor.com/images/abcd1c505f535e2958ac85b64a901953/tenor.gif"><img src="https://media.tenor.com/images/abcd1c505f535e2958ac85b64a901953/tenor.gif"></a></div>



<a name="188407783"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188407783" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188407783">(Feb 17 2020 at 21:28)</a>:</h4>
<p><span class="user-mention" data-user-id="191319">@James Agnew</span> - just tried with ES 5.6.16 ...no luck</p>



<a name="188407990"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188407990" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188407990">(Feb 17 2020 at 21:32)</a>:</h4>
<p>it is caused by <a href="https://github.com/hibernate/hibernate-search/blob/e7e19ed2a64fffce8d161802e7664438b8d53340/legacy/elasticsearch/src/main/java/org/hibernate/search/elasticsearch/impl/ToElasticsearch.java#L267" target="_blank" title="https://github.com/hibernate/hibernate-search/blob/e7e19ed2a64fffce8d161802e7664438b8d53340/legacy/elasticsearch/src/main/java/org/hibernate/search/elasticsearch/impl/ToElasticsearch.java#L267">https://github.com/hibernate/hibernate-search/blob/e7e19ed2a64fffce8d161802e7664438b8d53340/legacy/elasticsearch/src/main/java/org/hibernate/search/elasticsearch/impl/ToElasticsearch.java#L267</a> (maybe not the entirely correct branch on hibernate search) - the use of a MultiPhraseQuery seems to end there - where hibernate throws an exception</p>



<a name="188408067"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188408067" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188408067">(Feb 17 2020 at 21:34)</a>:</h4>
<p>the error is thrown before there is any interaction with ES</p>



<a name="188445204"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188445204" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188445204">(Feb 18 2020 at 12:12)</a>:</h4>
<p>Whoa, interesting.</p>
<p>What does the ValueSet that is triggering this look like?</p>



<a name="188459541"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188459541" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188459541">(Feb 18 2020 at 15:22)</a>:</h4>
<p><a href="https://docs.ehealth.sundhed.dk/latest/ig/ValueSet-message-category.html" target="_blank" title="https://docs.ehealth.sundhed.dk/latest/ig/ValueSet-message-category.html">https://docs.ehealth.sundhed.dk/latest/ig/ValueSet-message-category.html</a></p>



<a name="188459603"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188459603" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188459603">(Feb 18 2020 at 15:23)</a>:</h4>
<p>backing codesystem: <a href="https://docs.ehealth.sundhed.dk/latest/ig/CodeSystem-ehealth-message-category.html" target="_blank" title="https://docs.ehealth.sundhed.dk/latest/ig/CodeSystem-ehealth-message-category.html">https://docs.ehealth.sundhed.dk/latest/ig/CodeSystem-ehealth-message-category.html</a></p>



<a name="188460604"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188460604" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188460604">(Feb 18 2020 at 15:33)</a>:</h4>
<p><span class="user-mention" data-user-id="191319">@James Agnew</span> there you go</p>



<a name="188479690"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188479690" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188479690">(Feb 18 2020 at 18:53)</a>:</h4>
<p>Loading that and calling $expand on it</p>



<a name="188487622"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188487622" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188487622">(Feb 18 2020 at 20:24)</a>:</h4>
<p><span class="user-mention" data-user-id="191427">@Jens Villadsen</span> yup, I see this same issue with your test case. Thanks.</p>
<p>Fix has gone in: <a href="https://github.com/jamesagnew/hapi-fhir/pull/1717" target="_blank" title="https://github.com/jamesagnew/hapi-fhir/pull/1717">https://github.com/jamesagnew/hapi-fhir/pull/1717</a></p>



<a name="188487668"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188487668" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188487668">(Feb 18 2020 at 20:24)</a>:</h4>
<p>(for review, not merged yet)</p>



<a name="188489669"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188489669" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188489669">(Feb 18 2020 at 20:50)</a>:</h4>
<p><span class="user-mention" data-user-id="191319">@James Agnew</span> out of curiosity,  would you in any way consider my use of valuesets and codesystems exotic?</p>



<a name="188490026"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188490026" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188490026">(Feb 18 2020 at 20:54)</a>:</h4>
<p>Heh nope, I'd say that's about as "hello world" of expanding valuesets as it gets :)</p>



<a name="188490077"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188490077" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188490077">(Feb 18 2020 at 20:55)</a>:</h4>
<p>Although.. Technically for your specific example you could just not include any codes at all in the VS, and only include the system if your intent is to just include all codes</p>



<a name="188493110"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188493110" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188493110">(Feb 18 2020 at 21:27)</a>:</h4>
<p>hmmm ... yes that is true... can't say why that valueset ended up like that ... i don't believe thats is the general picture of the valuesets in that IG though ;)</p>



<a name="188560136"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188560136" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188560136">(Feb 19 2020 at 16:31)</a>:</h4>
<p><span class="user-mention" data-user-id="191319">@James Agnew</span>  any change that this and the update of the hl7 core validation component could go into a 4.2.1?</p>



<a name="188560630"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188560630" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188560630">(Feb 19 2020 at 16:36)</a>:</h4>
<p>as an alternative (I guess/hope) I could make it my self from <a href="https://github.com/jamesagnew/hapi-fhir/pull/1719" target="_blank" title="https://github.com/jamesagnew/hapi-fhir/pull/1719">https://github.com/jamesagnew/hapi-fhir/pull/1719</a> and <a href="https://github.com/jamesagnew/hapi-fhir/pull/1717" target="_blank" title="https://github.com/jamesagnew/hapi-fhir/pull/1717">https://github.com/jamesagnew/hapi-fhir/pull/1717</a> given that the changes are not conflicting with the rest of 4.2.0</p>



<a name="188832886"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/use%20of%20elasticsearch/near/188832886" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/use.20of.20elasticsearch.html#188832886">(Feb 22 2020 at 20:56)</a>:</h4>
<p>once done, that is</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
