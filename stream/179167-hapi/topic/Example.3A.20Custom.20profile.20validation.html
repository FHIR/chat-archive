---
layout: page
title: "FHIR Chat  · Example: Custom profile validation · hapi"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/index.html">hapi</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html">Example: Custom profile validation</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="176072065"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/176072065" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Johanna Eicher <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#176072065">(Sep 19 2019 at 06:19)</a>:</h4>
<p>Hi all,</p>
<p>could anyone be so nice to provide me with (or point me towards) an example of how to implement IValidationSupport when<br>
- Structure definitions, code systems and value sets are stored locally on the file system<br>
- Structure definitions are available as differentials only.</p>
<p>I do not have a FHIRStore, I only want to generate FHIR resources via Hapi and then validate them against custom profiles.</p>
<p>My main problem lies in the method "generateSnapshot" and how it relates to the other methods.</p>
<p>I have managed to get the validator working on snapshots (provided via the file system), but now I have the requirement to supply differentials only (which means - afaik - that I have to implement the generateSnapshot method).</p>
<p>I'm working with the following dependencies:</p>
<div class="codehilite"><pre><span></span>    &lt;dependency&gt;
        &lt;groupId&gt;ca.uhn.hapi.fhir&lt;/groupId&gt;
        &lt;artifactId&gt;hapi-fhir-structures-r4&lt;/artifactId&gt;
        &lt;version&gt;4.0.0&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;ca.uhn.hapi.fhir&lt;/groupId&gt;
        &lt;artifactId&gt;hapi-fhir-validation&lt;/artifactId&gt;
        &lt;version&gt;4.0.0&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;ca.uhn.hapi.fhir&lt;/groupId&gt;
        &lt;artifactId&gt;hapi-fhir-validation-resources-r4&lt;/artifactId&gt;
        &lt;version&gt;4.0.0&lt;/version&gt;
    &lt;/dependency&gt;
</pre></div>


<p>Thanks in advance, <br>
Johanna</p>



<a name="176081249"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/176081249" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#176081249">(Sep 19 2019 at 09:13)</a>:</h4>
<p>if you are using HAPI, then you can use ProfileUtilities to do this</p>



<a name="176082267"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/176082267" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Johanna Eicher <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#176082267">(Sep 19 2019 at 09:29)</a>:</h4>
<blockquote>
<p>if you are using HAPI, then you can use ProfileUtilities to do this</p>
</blockquote>
<p>Yes, that's what I did but I'm not sure how to invoke the method. This is what I tried:</p>
<p>class MyValidationSupport implements IValidationSupport {</p>
<div class="codehilite"><pre><span></span>    @Override
    public ValueSetExpansionOutcome expandValueSet(FhirContext theContext,
                                                   ConceptSetComponent theInclude) {
        return null;
    }

    @Override
    public List&lt;IBaseResource&gt; fetchAllConformanceResources(FhirContext theContext) {
        return null;
    }

    @Override
    public List&lt;StructureDefinition&gt; fetchAllStructureDefinitions(FhirContext theContext) {
        return structureDefinitions;
    }

    @Override
    public CodeSystem fetchCodeSystem(FhirContext theContext, String theUri) {
        return codeSystemsMap.get(theUri);
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    @Override
    public &lt;T extends IBaseResource&gt; T fetchResource(FhirContext theContext,
                                                     Class&lt;T&gt; theClass,
                                                     String theUri) {
        Validate.notBlank(theUri, &quot;theUri must not be null or blank&quot;);
        if (theClass.equals(StructureDefinition.class)) { return (T) fetchStructureDefinition(theContext,
                                                                                              theUri); }
        if (theClass.equals(ValueSet.class)) { return (T) fetchValueSet(theContext, theUri); }
        return null;
    }

    @Override
    public StructureDefinition fetchStructureDefinition(FhirContext theContext, String theUri) {
        StructureDefinition sd = structureDefinitionsMap.get(theUri);
        if (sd == null) { return sd; }
        return generateSnapshot(sd, theUri, sd.getUrl(), sd.getName());
    }

    @Override
    public ValueSet fetchValueSet(FhirContext theContext, String theUri) {
        return valueSetsMap.get(theUri);
    }

    @Override
    public StructureDefinition generateSnapshot(StructureDefinition theInput,
                                                String theUri,
                                                String theWebUrl,
                                                String theProfileName) {
        IWorkerContext context = new HapiWorkerContext(FHIRContext.instance(), this);
        ArrayList&lt;ValidationMessage&gt; messages = new ArrayList&lt;&gt;();

        StructureDefinition base = new DefaultProfileValidationSupport().fetchStructureDefinition(FHIRContext.instance(),
                                                                                                  theInput.getBaseDefinition());
        if (base == null) { throw new PreconditionFailedException(&quot;Unknown base definition: &quot; +
                                                                  theInput.getBaseDefinition()); }

        new ProfileUtilities(context, messages, null).generateSnapshot(base,
                                                                       theInput,
                                                                       theUri,
                                                                       theWebUrl,
                                                                       theProfileName);

        return theInput;
    }

    @Override
    public boolean isCodeSystemSupported(FhirContext theContext, String theSystem) {
        return codeSystems.contains(theSystem);
    }

    @Override
    public LookupCodeResult
           lookupCode(FhirContext theContext, String theSystem, String theCode) {
        return null;
    }

    private CodeValidationResult
            testIfConceptIsInList(CodeSystem theCodeSystem,
                                  String theCode,
                                  List&lt;ConceptDefinitionComponent&gt; conceptList,
                                  boolean theCaseSensitive) {
        String code = theCode;
        if (theCaseSensitive == false) {
            code = code.toUpperCase();
        }

        return testIfConceptIsInListInner(theCodeSystem, conceptList, theCaseSensitive, code);
    }

    private CodeValidationResult
            testIfConceptIsInListInner(CodeSystem theCodeSystem,
                                       List&lt;ConceptDefinitionComponent&gt; conceptList,
                                       boolean theCaseSensitive,
                                       String code) {
        CodeValidationResult retVal = null;
        for (ConceptDefinitionComponent next : conceptList) {
            String nextCandidate = next.getCode();
            if (theCaseSensitive == false) {
                nextCandidate = nextCandidate.toUpperCase();
            }
            if (nextCandidate.equals(code)) {
                retVal = new CodeValidationResult(next);
                break;
            }

            // recurse
            retVal = testIfConceptIsInList(theCodeSystem,
                                           code,
                                           next.getConcept(),
                                           theCaseSensitive);
            if (retVal != null) {
                break;
            }
        }

        if (retVal != null) {
            retVal.setCodeSystemName(theCodeSystem.getName());
            retVal.setCodeSystemVersion(theCodeSystem.getVersion());
        }

        return retVal;
    }

    @Override
    public CodeValidationResult validateCode(FhirContext theContext,
                                             String theCodeSystem,
                                             String theCode,
                                             String theDisplay) {
        CodeSystem cs = fetchCodeSystem(theContext, theCodeSystem);
        if (cs != null) {
            boolean caseSensitive = true;
            if (cs.hasCaseSensitive()) {
                caseSensitive = cs.getCaseSensitive();
            }

            CodeValidationResult retVal = testIfConceptIsInList(cs,
                                                                theCode,
                                                                cs.getConcept(),
                                                                caseSensitive);

            if (retVal != null) { return retVal; }
        }

        return new CodeValidationResult(IssueSeverity.WARNING,
                                        &quot;Unknown code: &quot; + theCodeSystem + &quot; / &quot; + theCode);
    }
}
</pre></div>



<a name="176082653"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/176082653" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#176082653">(Sep 19 2019 at 09:36)</a>:</h4>
<p>that didn't work?</p>



<a name="176082951"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/176082951" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Johanna Eicher <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#176082951">(Sep 19 2019 at 09:41)</a>:</h4>
<p>When validating a resource of type Organization for which a custom profile is defined I get lots of error messages looking like this:</p>
<div class="codehilite"><pre><span></span>Error in snapshot generation: Differential for https://fhir.bbmri.de/StructureDefinition/Biobank with id: Organization.telecom:url.system has an element that is not marked with a snapshot match
</pre></div>



<a name="176083046"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/176083046" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#176083046">(Sep 19 2019 at 09:43)</a>:</h4>
<p>that means you have a problem with your differential, probably in the order of elements</p>



<a name="176083112"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/176083112" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#176083112">(Sep 19 2019 at 09:44)</a>:</h4>
<p>if you think that's not the case, you should submit the differential as a bug report</p>



<a name="176083165"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/176083165" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Johanna Eicher <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#176083165">(Sep 19 2019 at 09:45)</a>:</h4>
<p>The differential can be used successfully to validate resources with the HL7 validation jar (<a href="https://wiki.hl7.org/Using_the_FHIR_Validator" target="_blank" title="https://wiki.hl7.org/Using_the_FHIR_Validator">https://wiki.hl7.org/Using_the_FHIR_Validator</a>). Probably then the differential shouldn't be the cause?</p>



<a name="176083288"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/176083288" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#176083288">(Sep 19 2019 at 09:47)</a>:</h4>
<p>without producing that message in the output? That's surprising. I can't think how that error could be caused by something are doing in executing the ProfileUtilities code wrongly</p>



<a name="176083571"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/176083571" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#176083571">(Sep 19 2019 at 09:52)</a>:</h4>
<p>you can get more insight by doing setDebug(true) on the profile utilities before calling generateSnapshot</p>



<a name="176083627"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/176083627" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Johanna Eicher <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#176083627">(Sep 19 2019 at 09:52)</a>:</h4>
<blockquote>
<p>without producing that message in the output? That's surprising. I can't think how that error could be caused by something are doing in executing the ProfileUtilities code wrongly</p>
</blockquote>
<p>I will double check!</p>



<a name="176086596"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/176086596" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Johanna Eicher <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#176086596">(Sep 19 2019 at 10:42)</a>:</h4>
<blockquote>
<blockquote>
<p>without producing that message in the output? That's surprising. I can't think how that error could be caused by something are doing in executing the ProfileUtilities code wrongly</p>
</blockquote>
<p>I will double check!</p>
</blockquote>
<p>I have verified that I am able to successfully validate the same resource with the latest version from <a href="https://fhir.github.io/latest-ig-publisher/org.hl7.fhir.validator.jar" target="_blank" title="https://fhir.github.io/latest-ig-publisher/org.hl7.fhir.validator.jar">https://fhir.github.io/latest-ig-publisher/org.hl7.fhir.validator.jar</a>.</p>



<a name="176093321"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/176093321" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Johanna Eicher <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#176093321">(Sep 19 2019 at 12:22)</a>:</h4>
<p>PP @ null / null : base = 0 to 25, diff = 0 to 46 (slicing = false, redirector = [])<br>
 - Organization: base = 0 (Organization) to 25 (Organization.endpoint), diff = 0 (Organization.extension) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= Organization.extension)<br>
  PP @ Organization / null : base = 1 to 25, diff = 0 to 46 (slicing = false, redirector = [])<br>
   - <a href="http://Organization.id" target="_blank" title="http://Organization.id">Organization.id</a>: base = 1 (<a href="http://Organization.id" target="_blank" title="http://Organization.id">Organization.id</a>) to 25 (Organization.endpoint), diff = 0 (Organization.extension) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= Organization.extension)<br>
   - Organization.meta: base = 2 (Organization.meta) to 25 (Organization.endpoint), diff = 0 (Organization.extension) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= Organization.extension)<br>
   - Organization.implicitRules: base = 3 (Organization.implicitRules) to 25 (Organization.endpoint), diff = 0 (Organization.extension) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= Organization.extension)<br>
   - Organization.language: base = 4 (Organization.language) to 25 (Organization.endpoint), diff = 0 (Organization.extension) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= Organization.extension)<br>
   - Organization.text: base = 5 (Organization.text) to 25 (Organization.endpoint), diff = 0 (Organization.extension) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= Organization.extension)<br>
   - Organization.contained: base = 6 (Organization.contained) to 25 (Organization.endpoint), diff = 0 (Organization.extension) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= Organization.extension)<br>
   - Organization.extension: base = 7 (Organization.extension) to 25 (Organization.endpoint), diff = 0 (Organization.extension) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= Organization.extension)<br>
    PP @ Organization / null : base = 7 to 7, diff = 1 to 1 (slicing = true, redirector = [])<br>
     - Organization.extension: base = 7 (Organization.extension) to 7 (Organization.extension), diff = 1 (Organization.extension:description) to 1 (Organization.extension:description) (slicingDone = true) (diffpath= Organization.extension)<br>
PP @ null / null : base = 0 to 4, diff = 0 to 1 (slicing = false, redirector = [])<br>
 - Extension: base = 0 (Extension) to 4 (Extension.value[x]), diff = 0 (Extension.url) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.url)<br>
  PP @ Extension / null : base = 1 to 4, diff = 0 to 1 (slicing = false, redirector = [])<br>
   - <a href="http://Extension.id" target="_blank" title="http://Extension.id">Extension.id</a>: base = 1 (<a href="http://Extension.id" target="_blank" title="http://Extension.id">Extension.id</a>) to 4 (Extension.value[x]), diff = 0 (Extension.url) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.url)<br>
   - Extension.extension: base = 2 (Extension.extension) to 4 (Extension.value[x]), diff = 0 (Extension.url) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.url)<br>
   - Extension.url: base = 3 (Extension.url) to 4 (Extension.value[x]), diff = 0 (Extension.url) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.url)<br>
   - Extension.value[x]: base = 4 (Extension.value[x]) to 4 (Extension.value[x]), diff = 1 (Extension.value[x]) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.value[x])<br>
Differential: <br>
  Extension.url : [0..null]  id = Extension.url fixed=uri<br>
  Extension.value[x] : string[1..null]  id = Extension.value[x] <br>
Snapshot: <br>
  Extension : [0..*]  id = Extension constraints=2<br>
<a href="http://Extension.id" target="_blank" title="http://Extension.id">Extension.id</a> : string[0..1]  id = <a href="http://Extension.id" target="_blank" title="http://Extension.id">Extension.id</a> <br>
  Extension.extension : Extension[0..*] (slicing by url)  id = Extension.extension <br>
  Extension.url : null[1..1]  id = Extension.url fixed=uri<br>
  Extension.value[x] : string[1..1]  id = Extension.value[x] <br>
    PP @ Organization / null : base = 7 to 7, diff = 2 to 2 (slicing = true, redirector = [])<br>
     - Organization.extension: base = 7 (Organization.extension) to 7 (Organization.extension), diff = 2 (Organization.extension:juridicalPerson) to 2 (Organization.extension:juridicalPerson) (slicingDone = true) (diffpath= Organization.extension)<br>
PP @ null / null : base = 0 to 4, diff = 0 to 1 (slicing = false, redirector = [])<br>
 - Extension: base = 0 (Extension) to 4 (Extension.value[x]), diff = 0 (Extension.url) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.url)<br>
  PP @ Extension / null : base = 1 to 4, diff = 0 to 1 (slicing = false, redirector = [])<br>
   - <a href="http://Extension.id" target="_blank" title="http://Extension.id">Extension.id</a>: base = 1 (<a href="http://Extension.id" target="_blank" title="http://Extension.id">Extension.id</a>) to 4 (Extension.value[x]), diff = 0 (Extension.url) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.url)<br>
   - Extension.extension: base = 2 (Extension.extension) to 4 (Extension.value[x]), diff = 0 (Extension.url) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.url)<br>
   - Extension.url: base = 3 (Extension.url) to 4 (Extension.value[x]), diff = 0 (Extension.url) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.url)<br>
   - Extension.value[x]: base = 4 (Extension.value[x]) to 4 (Extension.value[x]), diff = 1 (Extension.value[x]) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.value[x])<br>
Differential: <br>
  Extension.url : [0..null]  id = Extension.url fixed=uri<br>
  Extension.value[x] : string[1..null]  id = Extension.value[x] <br>
Snapshot: <br>
  Extension : [0..*]  id = Extension constraints=2<br>
<a href="http://Extension.id" target="_blank" title="http://Extension.id">Extension.id</a> : string[0..1]  id = <a href="http://Extension.id" target="_blank" title="http://Extension.id">Extension.id</a> <br>
  Extension.extension : Extension[0..*] (slicing by url)  id = Extension.extension <br>
  Extension.url : null[1..1]  id = Extension.url fixed=uri<br>
  Extension.value[x] : string[1..1]  id = Extension.value[x] <br>
    PP @ Organization / null : base = 7 to 7, diff = 3 to 3 (slicing = true, redirector = [])<br>
     - Organization.extension: base = 7 (Organization.extension) to 7 (Organization.extension), diff = 3 (Organization.extension:qualityStandard) to 3 (Organization.extension:qualityStandard) (slicingDone = true) (diffpath= Organization.extension)<br>
PP @ null / null : base = 0 to 4, diff = 0 to 1 (slicing = false, redirector = [])<br>
 - Extension: base = 0 (Extension) to 4 (Extension.value[x]), diff = 0 (Extension.url) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.url)<br>
  PP @ Extension / null : base = 1 to 4, diff = 0 to 1 (slicing = false, redirector = [])<br>
   - <a href="http://Extension.id" target="_blank" title="http://Extension.id">Extension.id</a>: base = 1 (<a href="http://Extension.id" target="_blank" title="http://Extension.id">Extension.id</a>) to 4 (Extension.value[x]), diff = 0 (Extension.url) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.url)<br>
   - Extension.extension: base = 2 (Extension.extension) to 4 (Extension.value[x]), diff = 0 (Extension.url) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.url)<br>
   - Extension.url: base = 3 (Extension.url) to 4 (Extension.value[x]), diff = 0 (Extension.url) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.url)<br>
   - Extension.value[x]: base = 4 (Extension.value[x]) to 4 (Extension.value[x]), diff = 1 (Extension.value[x]) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.value[x])<br>
Differential: <br>
  Extension.url : [0..null]  id = Extension.url fixed=uri<br>
  Extension.value[x] : CodeableConcept[0..null]  id = Extension.value[x] <br>
Snapshot: <br>
  Extension : [0..*]  id = Extension constraints=2<br>
<a href="http://Extension.id" target="_blank" title="http://Extension.id">Extension.id</a> : string[0..1]  id = <a href="http://Extension.id" target="_blank" title="http://Extension.id">Extension.id</a> <br>
  Extension.extension : Extension[0..*] (slicing by url)  id = Extension.extension <br>
  Extension.url : null[1..1]  id = Extension.url fixed=uri<br>
  Extension.value[x] : CodeableConcept[0..1]  id = Extension.value[x] <br>
   - Organization.modifierExtension: base = 8 (Organization.modifierExtension) to 25 (Organization.endpoint), diff = 4 (Organization.identifier) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= Organization.identifier)<br>
   - Organization.identifier: base = 9 (Organization.identifier) to 25 (Organization.endpoint), diff = 4 (Organization.identifier) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= Organization.identifier)<br>
    PP @ Organization / null : base = 9 to 9, diff = 5 to 7 (slicing = true, redirector = [])<br>
     - Organization.identifier: base = 9 (Organization.identifier) to 9 (Organization.identifier), diff = 5 (Organization.identifier:Bbmri-EricId) to 7 (Organization.identifier:Bbmri-EricId.value) (slicingDone = true) (diffpath= Organization.identifier)<br>
   - Organization.active: base = 10 (Organization.active) to 25 (Organization.endpoint), diff = 8 (<a href="http://Organization.name" target="_blank" title="http://Organization.name">Organization.name</a>) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= <a href="http://Organization.name" target="_blank" title="http://Organization.name">Organization.name</a>)<br>
   - Organization.type: base = 11 (Organization.type) to 25 (Organization.endpoint), diff = 8 (<a href="http://Organization.name" target="_blank" title="http://Organization.name">Organization.name</a>) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= <a href="http://Organization.name" target="_blank" title="http://Organization.name">Organization.name</a>)<br>
   - <a href="http://Organization.name" target="_blank" title="http://Organization.name">Organization.name</a>: base = 12 (<a href="http://Organization.name" target="_blank" title="http://Organization.name">Organization.name</a>) to 25 (Organization.endpoint), diff = 8 (<a href="http://Organization.name" target="_blank" title="http://Organization.name">Organization.name</a>) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= <a href="http://Organization.name" target="_blank" title="http://Organization.name">Organization.name</a>)<br>
   - Organization.alias: base = 13 (Organization.alias) to 25 (Organization.endpoint), diff = 9 (Organization.alias) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= Organization.alias)<br>
   - Organization.telecom: base = 14 (Organization.telecom) to 25 (Organization.endpoint), diff = 10 (Organization.telecom) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= Organization.telecom)<br>
    PP @ Organization / null : base = 14 to 14, diff = 11 to 13 (slicing = true, redirector = [])<br>
     - Organization.telecom: base = 14 (Organization.telecom) to 14 (Organization.telecom), diff = 11 (Organization.telecom:url) to 13 (Organization.telecom:url.value) (slicingDone = true) (diffpath= Organization.telecom)<br>
   - Organization.address: base = 15 (Organization.address) to 25 (Organization.endpoint), diff = 14 (Organization.address) to 46 (Organiza</p>



<a name="176093372"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/176093372" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Johanna Eicher <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#176093372">(Sep 19 2019 at 12:23)</a>:</h4>
<p>This is an excerpt from my log, I don't really know what to look for there.</p>



<a name="176093394"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/176093394" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Johanna Eicher <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#176093394">(Sep 19 2019 at 12:23)</a>:</h4>
<p>Eventually, I will end up with the following exception:</p>
<p>java.lang.UnsupportedOperationException<br>
    at org.hl7.fhir.r4.hapi.validation.FhirInstanceValidator$WorkerContextWrapper.expandVS(FhirInstanceValidator.java:376)<br>
    at org.hl7.fhir.r5.elementmodel.Element.getAsICoding(Element.java:807)<br>
    at org.hl7.fhir.r5.model.Base.castToCoding(Base.java:518)<br>
    at org.hl7.fhir.r5.utils.FHIRPathEngine.opMemberOf(FHIRPathEngine.java:1888)<br>
    at org.hl7.fhir.r5.utils.FHIRPathEngine.operate(FHIRPathEngine.java:1410)<br>
    at org.hl7.fhir.r5.utils.FHIRPathEngine.execute(FHIRPathEngine.java:1175)<br>
    at org.hl7.fhir.r5.utils.FHIRPathEngine.execute(FHIRPathEngine.java:1156)<br>
    at org.hl7.fhir.r5.utils.FHIRPathEngine.execute(FHIRPathEngine.java:1174)<br>
    at org.hl7.fhir.r5.utils.FHIRPathEngine.evaluate(FHIRPathEngine.java:546)<br>
    at org.hl7.fhir.r5.utils.FHIRPathEngine.evaluateToBoolean(FHIRPathEngine.java:614)<br>
    at org.hl7.fhir.r5.validation.InstanceValidator.evaluateSlicingExpression(InstanceValidator.java:2803)<br>
    at org.hl7.fhir.r5.validation.InstanceValidator.sliceMatches(InstanceValidator.java:2795)<br>
    at org.hl7.fhir.r5.validation.InstanceValidator.matchSlice(InstanceValidator.java:4313)<br>
    at org.hl7.fhir.r5.validation.InstanceValidator.assignChildren(InstanceValidator.java:4227)<br>
    at org.hl7.fhir.r5.validation.InstanceValidator.validateElement(InstanceValidator.java:3942)<br>
    at org.hl7.fhir.r5.validation.InstanceValidator.start(InstanceValidator.java:2966)<br>
    at org.hl7.fhir.r5.validation.InstanceValidator.validateResource(InstanceValidator.java:4526)<br>
    at org.hl7.fhir.r5.validation.InstanceValidator.validate(InstanceValidator.java:825)<br>
    at org.hl7.fhir.r5.validation.InstanceValidator.validate(InstanceValidator.java:751)<br>
    at org.hl7.fhir.common.hapi.validation.ValidatorWrapper.validate(ValidatorWrapper.java:116)<br>
    at org.hl7.fhir.r4.hapi.validation.FhirInstanceValidator.validate(FhirInstanceValidator.java:216)<br>
    at org.hl7.fhir.r4.hapi.validation.BaseValidatorBridge.doValidate(BaseValidatorBridge.java:20)<br>
    at org.hl7.fhir.r4.hapi.validation.BaseValidatorBridge.validateResource(BaseValidatorBridge.java:43)<br>
    at org.hl7.fhir.r4.hapi.validation.FhirInstanceValidator.validateResource(FhirInstanceValidator.java:42)<br>
    at ca.uhn.fhir.validation.FhirValidator.validateWithResult(FhirValidator.java:219)<br>
    at ca.uhn.fhir.validation.FhirValidator.validateWithResult(FhirValidator.java:186)<br>
    at de.etl.util.FHIRValidation.validate(FHIRValidation.java:425)<br>
    at de.etl.test.TestValidation.testBiobank(TestValidation.java:118)<br>
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br>
    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)<br>
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)<br>
    at java.lang.reflect.Method.invoke(Method.java:498)<br>
    at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)<br>
    at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)<br>
    at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)<br>
    at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)<br>
    at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:325)<br>
    at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:78)<br>
    at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:57)<br>
    at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)<br>
    at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)<br>
    at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)<br>
    at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)<br>
    at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)<br>
    at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)<br>
    at org.junit.runners.ParentRunner.run(ParentRunner.java:363)<br>
    at org.eclipse.jdt.internal.junit4.runner.JUnit4TestReference.run(JUnit4TestReference.java:86)<br>
    at org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:38)<br>
    at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:538)<br>
    at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:760)<br>
    at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:460)<br>
    at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:206)</p>



<a name="176104739"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/176104739" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#176104739">(Sep 19 2019 at 14:27)</a>:</h4>
<p>it looks like it succeeded this time, based on the location of the actual error, which is inside your terminology service binding?</p>



<a name="176144846"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/176144846" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#176144846">(Sep 19 2019 at 21:41)</a>:</h4>
<p>Within the HAPI ecosystem, you can use the SnapshotGeneratingValidationSupport class for snapshot generation if you only have differentials. You'll also need an instance of DefaultProfileValidationSupport to supply the standard resources.</p>
<p>You may also want to use PrePopulatedValidationSupport to inject any custom profile SD's you have, and then ValidationSupportChain to chain them all together (this is what you will pass to the FhirInstanceValidator module).</p>



<a name="176172002"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/176172002" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Johanna Eicher <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#176172002">(Sep 20 2019 at 07:50)</a>:</h4>
<blockquote>
<p>Within the HAPI ecosystem, you can use the SnapshotGeneratingValidationSupport class for snapshot generation if you only have differentials. You'll also need an instance of DefaultProfileValidationSupport to supply the standard resources.</p>
<p>You may also want to use PrePopulatedValidationSupport to inject any custom profile SD's you have, and then ValidationSupportChain to chain them all together (this is what you will pass to the FhirInstanceValidator module).</p>
</blockquote>
<p>I have tried different variants of the components you described but I'm afraid I haven't found the correct combination yet. Could you tell me which methods I need to implement in my custom validator and which validators I need to use in which order if I have:<br>
- A number of custom value sets<br>
- A number of custom code systems<br>
- A number of custom structure definitions as differentials.</p>
<p>I tried to provide the differentials via my own validation support and then have the snapshots generated by the SnapshotGeneratingValidationSupport like so:</p>
<div class="codehilite"><pre><span></span>    ValidationSupportChain support = new ValidationSupportChain(myValidationSupport,
                                                                new SnapshotGeneratingValidationSupport(FHIRContext.instance(),
                                                                                                        myValidationSupport),
                                                                new DefaultProfileValidationSupport());
    FhirInstanceValidator instanceValidator = new FhirInstanceValidator(support);
    validator.registerValidatorModule(instanceValidator);
</pre></div>


<p>I got error messages such as  "StructureDefinition has no snapshot - validation is against the snapshot, so it must be provided" which made me think that my set up is not correct. </p>
<p>Through debugging I found that none of the generateSnapshot methods of any of the three provided validators is invoked in the first place which made me think that I have to call it myself in my custom validation support. I tried this in different ways but still not successfully.</p>
<p>All these things I tried before I posted my original question when I realized that most helpful would be a working example (which I also tried to find  via various searches).</p>
<p>I would be really grateful if someone could provide such an example!</p>



<a name="176172050"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/176172050" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Johanna Eicher <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#176172050">(Sep 20 2019 at 07:51)</a>:</h4>
<blockquote>
<p>it looks like it succeeded this time, based on the location of the actual error, which is inside your terminology service binding?</p>
</blockquote>
<p>Thanks for the tip! I do think there could be another problem relating to this but I'm quite sure that my set up is not correct yet and I am trying to get to the root cause first. Hence my previous reply.</p>



<a name="176207655"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/176207655" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#176207655">(Sep 20 2019 at 16:25)</a>:</h4>
<p><span class="user-mention" data-user-id="240776">@Johanna Eicher</span> What you posted looks close- I think you need to be passing in an instance of DefaultProfileValidationSupport to the constructor of SnapshotGeneratingValidationSupport instead of <code>myValidationSupport</code> though.</p>



<a name="176345999"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/176345999" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Johanna Eicher <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#176345999">(Sep 23 2019 at 07:29)</a>:</h4>
<p>Thank you for the tip. I have tried that as well but unfortunately with the same result (...StructureDefinition has no snapshot...). </p>
<p>In all of my attempts I have not yet managed to have the method <code>ValidationSupportChain.generateSnapshot</code>invoked. From analyzing the Hapi code I'm using (see dependencies above) I could not find the trigger either.</p>
<p>Does this mean I'm missing a dependency or maybe that I have to invoke it myself?</p>



<a name="176353297"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/176353297" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#176353297">(Sep 23 2019 at 09:34)</a>:</h4>
<p>You do need to invoke it yourself on the structuredefinition before you can use it if you onlt have a differential.. Then you'd want to put it in the PrePopulated one</p>



<a name="176470099"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/176470099" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Johanna Eicher <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#176470099">(Sep 24 2019 at 14:41)</a>:</h4>
<p>I have now changed my implementation such that I only use <code>DefaultProfileValidationSupport</code>and <code>PrePopulatedValidationSupport</code> populated with my custom value sets, code systems and snapshots which I have generated from my custom differentials before:</p>
<div class="codehilite"><pre><span></span>    // Validator instance
    validator = FHIRContext.instance().newValidator();

    // Default validator
    DefaultProfileValidationSupport defSupport = new DefaultProfileValidationSupport();

    // Validator used for generating snapshots (manually)
    SnapshotGeneratingValidationSupport snapSupport = new SnapshotGeneratingValidationSupport(FHIRContext.instance(),
                                                                                              defSupport);

    // Validator providing snapshots generated from custom differentials
    PrePopulatedValidationSupport ppSupport = new PrePopulatedValidationSupport();

    // For each value set
    for (ValueSet valueSet : valueSetsMap.values()) {
        ppSupport.addValueSet(valueSet);
    }

    // For each code system
    for (CodeSystem codeSystem : codeSystemsMap.values()) {
        ppSupport.addCodeSystem(codeSystem);
    }

    // For each profile
    for (StructureDefinition sd : structureDefinitionsMap.values()) {
        snapSupport.generateSnapshot(sd, sd.getBaseDefinition(), sd.getUrl(), sd.getName());
        ppSupport.addStructureDefinition(sd);
    }

    // Add custom validation
    ValidationSupportChain support = new ValidationSupportChain(ppSupport, defSupport);
    FhirInstanceValidator instanceValidator = new FhirInstanceValidator(support);
    validator.registerValidatorModule(instanceValidator);
</pre></div>


<p>Is this now the right approach? I am getting error messages such as </p>
<div class="codehilite"><pre><span></span>Organization.extension[2].value.ofType(CodeableConcept) Code https://fhir.bbmri.de/CodeSystem/QualityStandard/oecd-guidelines was not validated because the code system is not present
</pre></div>


<p>referencing code systems that I have supplied to the validator before.</p>



<a name="176497952"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/176497952" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#176497952">(Sep 24 2019 at 19:35)</a>:</h4>
<p>Hmm, what you have look right to me.</p>
<p>Can you try putting breakpoints in DefaultProfileValidationSupport to see what is happening with the code validation?</p>



<a name="176557516"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/176557516" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Johanna Eicher <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#176557516">(Sep 25 2019 at 12:08)</a>:</h4>
<p>Through debugging, I found that the problem was caused by the fact that the method</p>
<div class="codehilite"><pre><span></span>@Override
public boolean isCodeSystemSupported(FhirContext theContext, String theSystem) {
    return false;
}
</pre></div>


<p>of the <code>PrePopulatedValidationSupport</code> class is always returning <code>false</code>. Does this mean this validator is not designed to handle custom code systems in general?</p>
<p>I think I have finally found a solution that is working for me. Instead of the <code>PrePopulatedValidationSupport</code> I am using my own validator (in addition to the default validator) which I populate with snapshots of my differentials (just like I was doing with the <code>PrePopulatedValidationSupport</code>). But now I can also implement the above mentioned method which so far seems to have solved my issues.</p>



<a name="189356786"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/189356786" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pedro Lauro <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#189356786">(Feb 28 2020 at 22:20)</a>:</h4>
<p>I'm trying to replicate this last example <span class="user-mention" data-user-id="240776">@Johanna Eicher</span> posted. I'm testing with a custom profile and a custom extension, both written as differentials. Is important to say that this custom profile uses the custom extension.</p>
<div class="codehilite"><pre><span></span>        FhirContext ctx = .....

        // Validator instance
        FhirValidator validator = ctx.newValidator();

        // Default validator
        DefaultProfileValidationSupport defSupport = new DefaultProfileValidationSupport();

        // Validator used for generating snapshots (manually)
        SnapshotGeneratingValidationSupport snapSupport =
                new SnapshotGeneratingValidationSupport(ctx, defSupport);

        // Validator providing snapshots generated from custom differentials
        PrePopulatedValidationSupport ppSupport = new PrePopulatedValidationSupport();

        IParser fhirParser = ctx.newXmlParser();

        // consider that there&#39;s a folder with all custom profiles
        List&lt;String&gt; sdFiles = fileUtil.listFolder(pathToProfilesFolder);
        for (String sdPath : sdFiles) {

            StructureDefinition sd = fhirParser.parseResource(
                    StructureDefinition.class,
                    fileUtil.readFile(sdPath));

            // the error prints after this next method call for the profile
            snapSupport.generateSnapshot(
                    sd,
                    sd.getBaseDefinition(),
                    sd.getUrl(),
                    sd.getName());

            ppSupport.addStructureDefinition(sd);
        }

        ValidationSupportChain support = new ValidationSupportChain(ppSupport, defSupport);

        // Add custom validation
        FhirInstanceValidator instanceValidator = new FhirInstanceValidator(support);
        validator.registerValidatorModule(instanceValidator);
</pre></div>


<p>When I run this code, I get the following error log after the generateSnapshot method, only for the custom profile:</p>
<div class="codehilite"><pre><span></span>Failed to find referenced profile: [CanonicalType[http://example.com/fhir/r4/StructureDefinition/CustomExtension]]
</pre></div>


<p>That is exactly the URL for my custom extension. <br>
So I thought I'd had to first include the extension and then the profile, changing the order of the listed files on my profiles folder. But that didn't changed anything. I'm still getting that error, no matter the order those are imported. <br>
No exception is thrown, but I still didn't try to validate any resources even with that log message.<br>
Should I just ignore that message log? Or should I first import all extensions and then create a new SnapshotGeneratingValidationSupport using this new 'map' of supported structures and then import the structures that makes references to those?<br>
Imagine my implementation context where I have a lot of custom profiles, one referencing the other (no cyclic ref though). Should I always rebuild the snapshot before importing the next structure? <br>
There's also the possibility that my custom structures were written incorrectly. They're created using Firely's Forge, and they seem alright, no errors or warnings. The tool appears to understand the reference between them.</p>



<a name="189451324"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/189451324" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sajith Jamal <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#189451324">(Mar 01 2020 at 22:47)</a>:</h4>
<p>Did you perhaps not disable the default rules in your validator?</p>
<div class="codehilite"><pre><span></span>// Create a validator and configure it
validator = con.newValidator();

// Typically if you are doing profile validation, you want to disable
 // the schema/schematron validation since the profile will specify
 // all the same rules (and more)
validator.setValidateAgainstStandardSchema(false);
validator.setValidateAgainstStandardSchematron(false);
</pre></div>


<p>When the above is true, even though your validation rules allow it, the default rules block it, failing your validation</p>



<a name="189470627"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/189470627" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Morten Ernebjerg <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#189470627">(Mar 02 2020 at 08:11)</a>:</h4>
<p>I am seeing the same problem as <span class="user-mention" data-user-id="240776">@Johanna Eicher</span>  with the loading of custom value sets/ code systems. Depending on the ordering of the default and the PrePopulated, validation supports, the same problem also occurs even with standard value sets as described in this thread: <a href="#narrow/stream/179167-hapi/topic/Custom.20ValueSet.20missing.20from.20validation" title="#narrow/stream/179167-hapi/topic/Custom.20ValueSet.20missing.20from.20validation">https://chat.fhir.org/#narrow/stream/179167-hapi/topic/Custom.20ValueSet.20missing.20from.20validation</a></p>



<a name="189511217"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/189511217" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pedro Lauro <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#189511217">(Mar 02 2020 at 17:00)</a>:</h4>
<p><span class="user-mention" data-user-id="194703">@Morten Ernebjerg</span> ,  my example of validation is for R4 FHIR version, and yours are for DSTU3 right? The PrePopulated class have different versions for each FHIR version, and looking at the R4 version, the isCodeSystemSupported() method doesn't have that fixed statement to always returns false:<br>
<a href="https://github.com/jamesagnew/hapi-fhir/blob/8a1fa3ea3c3a8bd15a872182461310d799f0ac7b/hapi-fhir-validation/src/main/java/org/hl7/fhir/r4/hapi/validation/PrePopulatedValidationSupport.java" target="_blank" title="https://github.com/jamesagnew/hapi-fhir/blob/8a1fa3ea3c3a8bd15a872182461310d799f0ac7b/hapi-fhir-validation/src/main/java/org/hl7/fhir/r4/hapi/validation/PrePopulatedValidationSupport.java">R4 PrePopulatedValidationSupport.java</a></p>



<a name="189512313"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/189512313" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pedro Lauro <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#189512313">(Mar 02 2020 at 17:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="234906">Sajith Jamal</span> <a href="#narrow/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation/near/189451324" title="#narrow/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation/near/189451324">said</a>:</p>
<blockquote>
<p>Did you perhaps not disable the default rules in your validator?</p>
<div class="codehilite"><pre><span></span>// Create a validator and configure it
validator = con.newValidator();

// Typically if you are doing profile validation, you want to disable
 // the schema/schematron validation since the profile will specify
 // all the same rules (and more)
validator.setValidateAgainstStandardSchema(false);
validator.setValidateAgainstStandardSchematron(false);
</pre></div>


<p>When the above is true, even though your validation rules allow it, the default rules block it, failing your validation</p>
</blockquote>
<p>Even though those are false by default, I tried setting them false, with no difference on the output. Still getting the same error.</p>



<a name="189552451"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/189552451" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sajith Jamal <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#189552451">(Mar 03 2020 at 00:32)</a>:</h4>
<p>hmmmm......<br>
another thing to try is instead of this:</p>
<div class="codehilite"><pre><span></span>// Add custom validation
        FhirInstanceValidator instanceValidator = new FhirInstanceValidator(support);
        validator.registerValidatorModule(instanceValidator);
</pre></div>


<p>try this:</p>
<div class="codehilite"><pre><span></span>ValidationSupportChain support = new ValidationSupportChain(new DefaultProfileValidationSupport(), validationSupport);
instanceValidator.setValidationSupport(support);
</pre></div>


<p>its how I got mine to work...and seems to be the difference between your code and mine</p>



<a name="189568727"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/189568727" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Morten Ernebjerg <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#189568727">(Mar 03 2020 at 07:17)</a>:</h4>
<p><span class="user-mention" data-user-id="267499">@Pedro Lauro</span> Yes, I am using STU3 - thanks for pointing out the code difference to R4, didn't check that so far!</p>



<a name="189732573"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Example%3A%20Custom%20profile%20validation/near/189732573" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pedro Lauro <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation.html#189732573">(Mar 04 2020 at 20:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="234906">Sajith Jamal</span> <a href="#narrow/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation/near/189552451" title="#narrow/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation/near/189552451">said</a>:</p>
<blockquote>
<p>hmmmm......<br>
another thing to try is instead of this:</p>
<div class="codehilite"><pre><span></span>// Add custom validation
        FhirInstanceValidator instanceValidator = new FhirInstanceValidator(support);
        validator.registerValidatorModule(instanceValidator);
</pre></div>


<p>try this:</p>
<div class="codehilite"><pre><span></span>ValidationSupportChain support = new ValidationSupportChain(new DefaultProfileValidationSupport(), validationSupport);
instanceValidator.setValidationSupport(support);
</pre></div>


<p>its how I got mine to work...and seems to be the difference between your code and mine</p>
</blockquote>
<p>Nothing different. The error happens before those instructions, while trying to generate the snapshot.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
