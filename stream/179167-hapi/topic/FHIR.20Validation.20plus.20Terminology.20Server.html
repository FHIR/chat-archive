---
layout: page
title: "FHIR Chat  · FHIR Validation plus Terminology Server · hapi"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/index.html">hapi</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html">FHIR Validation plus Terminology Server</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="179514623"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/179514623" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#179514623">(Oct 31 2019 at 09:40)</a>:</h4>
<p>I've had FHIR Validation plugged into our server for a while. <br>
Also linked in SNOMED validation using IValidationSupport interface.<br>
I'm not sure if this is the best way of doing this as it often fails (such as trying to expand large ValueSets - the Onto server says the query is too expensive). Is implementing the interface the best way of connecting to a terminology server?</p>



<a name="179518981"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/179518981" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#179518981">(Oct 31 2019 at 10:37)</a>:</h4>
<p>you should not be doing expand when validating. The validator will call $validate-code</p>



<a name="179519243"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/179519243" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#179519243">(Oct 31 2019 at 10:41)</a>:</h4>
<p>I think that's what I just realised. </p>
<p>That implies the ValueSet should be on the terminology server - is that correct?</p>



<a name="179519261"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/179519261" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#179519261">(Oct 31 2019 at 10:41)</a>:</h4>
<p>you can post it to the server when asking for $validate-code</p>



<a name="179770188"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/179770188" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Lawley <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#179770188">(Nov 04 2019 at 00:29)</a>:</h4>
<p>We have a HAPI server configured to sent all terminology operations to an external Ontoserver instance (Read, Search, Create, etc) as well as hooking in to validation through IValidationSupport.  It works quite well.</p>



<a name="179836099"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/179836099" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#179836099">(Nov 04 2019 at 14:09)</a>:</h4>
<p>Still getting stuck with expensive ecl statements expansions (which onto won't return)</p>
<p>Codes get validated against this function</p>
<p>@Override<br>
    public CodeValidationResult validateCode(FhirContext theContext, String theCodeSystem, String<br>
            theCode, String theDisplay)</p>
<p>but the instanceValidator always asks for the ValueSet to be expanded by </p>
<p>@Override<br>
    public CodeValidationResult validateCode(FhirContext theContext, String theCodeSystem, String<br>
            theCode, String theDisplay)</p>



<a name="179885337"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/179885337" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jim Steel <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#179885337">(Nov 04 2019 at 22:46)</a>:</h4>
<p>The default too costly threshold for ontoserver is 50000 results. If you need more, the server can be configured to allow more. Are you expecting that many?</p>



<a name="179886677"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/179886677" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Lawley <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#179886677">(Nov 04 2019 at 23:07)</a>:</h4>
<p>And yes, that expand call from the Hapi validation stuff is a real pain.</p>



<a name="179899452"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/179899452" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#179899452">(Nov 05 2019 at 03:47)</a>:</h4>
<p><span class="user-mention" data-user-id="191319">@James Agnew</span> I don't know why it calls expand here. It shouldn't</p>



<a name="179920711"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/179920711" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#179920711">(Nov 05 2019 at 10:57)</a>:</h4>
<p>This logic has been tweaked as of the current master, due out in 13 days. There are 3 cases for code validation:</p>
<p>1- We're validating a code with no valueset binding (as in the case of calling <code>$validate-code</code>)<br>
2- We're validating a code with a VS binding where the VS has a URL (i.e. most validations of FHIR resources with coded fields)<br>
3- We're validating a code with a VS binding where the VS has no URL (say, a contained VS within a Questionnaire definition- I've found this to be surprisingly common)</p>
<p>We never expanded for 1 since there was nothing to expand, but the expansion was there to satisfy 3. I always figured that we cached the results of the validation, so the expansion was a one-time pain. But yeah, I realize now that this is still a pain when you have big expansions.</p>
<p>The new logic only expands on 3, but instead delegates the validation to the term svc for 2. You can see this here: <a href="https://github.com/jamesagnew/hapi-fhir/blob/master/hapi-fhir-structures-r4/src/main/java/org/hl7/fhir/r4/hapi/ctx/HapiWorkerContext.java#L247" target="_blank" title="https://github.com/jamesagnew/hapi-fhir/blob/master/hapi-fhir-structures-r4/src/main/java/org/hl7/fhir/r4/hapi/ctx/HapiWorkerContext.java#L247">https://github.com/jamesagnew/hapi-fhir/blob/master/hapi-fhir-structures-r4/src/main/java/org/hl7/fhir/r4/hapi/ctx/HapiWorkerContext.java#L247</a></p>



<a name="179924947"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/179924947" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Lawley <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#179924947">(Nov 05 2019 at 12:03)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="191319">@James Agnew</span> , there's bugs in there I can see straight off - first case in the method looks for the code explicitly mentioned in the <code>compose.include</code> for a quick win, but fails to account for possible <code>compose.exclude</code> cases.</p>



<a name="179925198"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/179925198" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Lawley <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#179925198">(Nov 05 2019 at 12:07)</a>:</h4>
<p>If you must use expansion logic to handle this (your case 3), then I would suggest crafting an on-the-fly VS that composes the code with an include of the VS under examination.  The resulting expansion will have either 0 or 1 members.</p>



<a name="179926128"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/179926128" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#179926128">(Nov 05 2019 at 12:20)</a>:</h4>
<p>Ah right, the block at the top. That will actually be gone by the 4.1.0 release, it's already removed in a working branch we have going because the valueset pre-expansion makes it obsolete. Agree that approach is too naive.</p>



<a name="179926175"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/179926175" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#179926175">(Nov 05 2019 at 12:20)</a>:</h4>
<p>good idea about the custom valueset to handle case 3</p>



<a name="179960449"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/179960449" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#179960449">(Nov 05 2019 at 18:23)</a>:</h4>
<p>I don’t understand why you need expansion in case #3 anyway</p>



<a name="180019501"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/180019501" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#180019501">(Nov 06 2019 at 10:40)</a>:</h4>
<p>How else would you test whether a code is in the VS?</p>



<a name="180019838"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/180019838" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#180019838">(Nov 06 2019 at 10:45)</a>:</h4>
<p>use $validate-code</p>



<a name="180020210"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/180020210" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#180020210">(Nov 06 2019 at 10:50)</a>:</h4>
<p>I don't understand... wouldn't that just validate that the code itself is valid while not actually checking whether it's in the valueset?</p>
<p>The scenario here is things like Questionnaires with a contained VS pointed to by an <code>answerValueSet</code> reference.. So just knowing that the code exists isn't good enough</p>



<a name="180023057"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/180023057" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#180023057">(Nov 06 2019 at 11:33)</a>:</h4>
<p>Example call using $validate-code <a href="https://ontoserver.dataproducts.nhs.uk/fhir/ValueSet/$validate-code?system=http://snomed.info/sct&amp;code=122298005&amp;url=https://fhir.nhs.uk/STU3/ValueSet/DCH-FinalDeliveryType-1" target="_blank" title="https://ontoserver.dataproducts.nhs.uk/fhir/ValueSet/$validate-code?system=http://snomed.info/sct&amp;code=122298005&amp;url=https://fhir.nhs.uk/STU3/ValueSet/DCH-FinalDeliveryType-1">https://ontoserver.dataproducts.nhs.uk/fhir/ValueSet/$validate-code?system=http://snomed.info/sct&amp;code=122298005&amp;url=https://fhir.nhs.uk/STU3/ValueSet/DCH-FinalDeliveryType-1</a></p>



<a name="180023145"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/180023145" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#180023145">(Nov 06 2019 at 11:34)</a>:</h4>
<p>The url specifies the ValueSet to use.</p>



<a name="180023635"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/180023635" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#180023635">(Nov 06 2019 at 11:43)</a>:</h4>
<p>you can pass the value set inline, rather than referring to it by url. So it doesn't matter that it's an inline anonymous value set.</p>



<a name="180026014"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/180026014" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#180026014">(Nov 06 2019 at 12:19)</a>:</h4>
<p>If you pass it inline to that operation, how would the term service test membership without expanding the valueset?</p>



<a name="180047017"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/180047017" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#180047017">(Nov 06 2019 at 16:04)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="191319">@James Agnew</span> 4.1.0 is working like a charm.</p>



<a name="180047333"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/180047333" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#180047333">(Nov 06 2019 at 16:07)</a>:</h4>
<p>However it's now revealed quite a lot of new errors in UK Implementation Guide examples  :)</p>



<a name="180081929"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/180081929" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Lawley <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#180081929">(Nov 06 2019 at 22:13)</a>:</h4>
<p>You can POST a (Parameters containing a) ValueSet  to <a href="https://ontoserver.dataproducts.nhs.uk/fhir/ValueSet/$validate-code" target="_blank" title="https://ontoserver.dataproducts.nhs.uk/fhir/ValueSet/$validate-code">https://ontoserver.dataproducts.nhs.uk/fhir/ValueSet/$validate-code</a> and we do the validate without "expanding" (equivalent of what I described above)</p>



<a name="180083875"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/180083875" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#180083875">(Nov 06 2019 at 22:39)</a>:</h4>
<p>it's up the terminology service. But my implementation I have a different path for validate-code that checks the definitions directly</p>



<a name="180109541"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/180109541" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#180109541">(Nov 07 2019 at 07:50)</a>:</h4>
<p><span class="user-mention" data-user-id="191343">@Michael Lawley</span> I'll try that out. What I've done is check the onto server for a UK CodeSystem or ValueSet, if missing add it.</p>
<p>Are their any tools for visualising a SNOMED ValueSet. I can work out what the filters mean but most people won't (don't believe understanding of SNOMED is that high), they would expect to see an expansion but that's not practical in a number of cases.</p>



<a name="180110736"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/FHIR%20Validation%20plus%20Terminology%20Server/near/180110736" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Lawley <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/FHIR.20Validation.20plus.20Terminology.20Server.html#180110736">(Nov 07 2019 at 08:09)</a>:</h4>
<p>We have a new version of Shrimp coming soon that provides visualisation of ValueSets by generalising the existing CodeSystem UI to arbitrary ValueSets on the server</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
