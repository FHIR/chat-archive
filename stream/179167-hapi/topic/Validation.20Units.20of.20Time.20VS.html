---
layout: page
title: "FHIR Chat  · Validation Units of Time VS · hapi"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/index.html">hapi</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Validation.20Units.20of.20Time.20VS.html">Validation Units of Time VS</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="232765137"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Validation%20Units%20of%20Time%20VS/near/232765137" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Asher Bernardi <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Validation.20Units.20of.20Time.20VS.html#232765137">(Apr 01 2021 at 14:25)</a>:</h4>
<p>Hello!</p>
<p>I’m using HAPI FHIR 4.2.0 with R4. I’m trying to validate a ServiceRequest resource with an occurenceTiming child. However, the Timing.repeat.periodUnit element always fails with this error:</p>
<div class="codehilite"><pre><span></span><code>The value provided (&#39;wk&#39;) is not in the value set http://hl7.org/fhir/ValueSet/units-of-time|4.0.0
(http://hl7.org/fhir/ValueSet/units-of-time, and a code is required from this value set)
(error message = Unknown code[wk] in system[(none)]) -
ServiceRequest.occurrence.ofType(Timing).repeat.periodUnit
</code></pre></div>
<p>The weird thing about this is that the value “wk” is most certainly in the ValueSet units-of-time, which includes (s, min, h, d, wk, mo, and a). But after doing some hard-core debugging, I noticed that the code was not able to expand the valueset’s values. The actual code validation was happening in the method org.hl7.fhir.r4.hapi.ctx.DefaultProfileValidationSupport#validateCode. While the value set name was in fact recognized as a valid valueset, the contents of that value were empty. Programmatically, that meant that:</p>
<div class="codehilite" data-code-language="Java"><pre><span></span><code><span class="k">new</span> <span class="n">ValueSetExpanderSimple</span><span class="p">(</span><span class="k">new</span> <span class="n">HapiWorkerContext</span><span class="p">(</span><span class="n">theContext</span><span class="p">,</span> <span class="k">this</span><span class="p">)).</span><span class="na">expand</span><span class="p">(</span><span class="n">fetchValueSet</span><span class="p">(</span><span class="n">theContext</span><span class="p">,</span> <span class="s">"http://hl7.org/fhir/ValueSet/units-of-time"</span><span class="p">),</span> <span class="kc">null</span><span class="p">).</span><span class="na">getValueset</span><span class="p">().</span><span class="na">getExpansion</span><span class="p">().</span><span class="na">getContains</span><span class="p">()</span>
</code></pre></div>
<p>was an empty list. But when I tested this with other valuesets they worked just fine, expanding to the correct set of codes.</p>
<p>Is this a bug in the HAPI FHIR validation code? If so, it kind of defeats the purpose of validation… Could I have set up the validation wrong? Maybe there is some setting that I need to change? Here is the code that does the validation:</p>
<div class="codehilite" data-code-language="Java"><pre><span></span><code><span class="n">FhirValidator</span> <span class="n">validator</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="na">newValidator</span><span class="p">();</span>
<span class="n">validator</span><span class="p">.</span><span class="na">registerValidatorModule</span><span class="p">(</span><span class="k">new</span> <span class="n">FhirInstanceValidator</span><span class="p">(</span><span class="k">new</span> <span class="n">DefaultProfileValidationSupport</span><span class="p">()));</span>
<span class="n">ValidationResult</span> <span class="n">result</span> <span class="o">=</span> <span class="n">validator</span><span class="p">.</span><span class="na">validateWithResult</span><span class="p">(</span><span class="n">fhirResource</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">.</span><span class="na">isSuccessful</span><span class="p">())</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="s">"FHIR output is non-compliant: \n\t- "</span>
      <span class="o">+</span> <span class="n">result</span><span class="p">.</span><span class="na">getMessages</span><span class="p">().</span><span class="na">stream</span><span class="p">().</span><span class="na">map</span><span class="p">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="p">.</span><span class="na">getMessage</span><span class="p">()</span> <span class="o">+</span> <span class="s">" - "</span> <span class="o">+</span> <span class="n">m</span><span class="p">.</span><span class="na">getLocationString</span><span class="p">())</span>
      <span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">joining</span><span class="p">(</span><span class="s">"\n\t- "</span><span class="p">)));</span>
<span class="p">}</span>
</code></pre></div>
<p>Any advice or ideas would be helpful!</p>



<a name="232766044"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Validation%20Units%20of%20Time%20VS/near/232766044" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Venton <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Validation.20Units.20of.20Time.20VS.html#232766044">(Apr 01 2021 at 14:31)</a>:</h4>
<p>I can't speak to why the value set wasn't fetched, but I do notice, "(error message = Unknown code[wk] in system[(<strong>none</strong>)]) -"<br>
Did you populate the corresponding system in your resource, "<a href="http://unitsofmeasure.org">http://unitsofmeasure.org</a>"</p>



<a name="232766811"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Validation%20Units%20of%20Time%20VS/near/232766811" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Asher Bernardi <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Validation.20Units.20of.20Time.20VS.html#232766811">(Apr 01 2021 at 14:35)</a>:</h4>
<p>I shouldn't have to, since the value of Timing.repeat.periodUnit is a code that must be of that value set. There is nowhere to populate a valueset in that resource:<br>
<a href="/user_uploads/10155/RlrIL0BAhh76fc6Y_qG_oX3r/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/10155/RlrIL0BAhh76fc6Y_qG_oX3r/image.png" title="image.png"><img src="/user_uploads/10155/RlrIL0BAhh76fc6Y_qG_oX3r/image.png"></a></div>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
