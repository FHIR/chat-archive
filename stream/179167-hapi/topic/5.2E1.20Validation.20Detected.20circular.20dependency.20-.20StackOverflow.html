---
layout: page
title: "FHIR Chat  · 5.1 Validation Detected circular dependency - StackOverflow · hapi"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/index.html">hapi</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/5.2E1.20Validation.20Detected.20circular.20dependency.20-.20StackOverflow.html">5.1 Validation Detected circular dependency - StackOverflow</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="206914500"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/5.1%20Validation%20Detected%20circular%20dependency%20-%20StackOverflow/near/206914500" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/5.2E1.20Validation.20Detected.20circular.20dependency.20-.20StackOverflow.html#206914500">(Aug 14 2020 at 10:04)</a>:</h4>
<p>Just updated to 5.1 and getting this error.</p>
<p>Caused by: java.lang.StackOverflowError</p>
<p>I'm investigating at the moment but seems to get stuck on UK Profiles. Extract from the loop </p>
<p>2020-08-14 10:51:55.124  WARN 25744 --- [o-auto-1-exec-7] .v.s.SnapshotGeneratingValidationSupport : Detected circular dependency, already generating snapshot for: <a href="https://fhir.nhs.uk/R4/StructureDefinition/UKCore-CarePlan">https://fhir.nhs.uk/R4/StructureDefinition/UKCore-CarePlan</a><br>
2020-08-14 10:51:55.133  INFO 25744 --- [o-auto-1-exec-7] .v.v.VersionSpecificWorkerContextWrapper : Generating snapshot for StructureDefinition: <a href="https://fhir.nhs.uk/R4/StructureDefinition/UKCore-ServiceRequest">https://fhir.nhs.uk/R4/StructureDefinition/UKCore-ServiceRequest</a><br>
2020-08-14 10:51:55.137  INFO 25744 --- [o-auto-1-exec-7] .v.v.VersionSpecificWorkerContextWrapper : Generating snapshot for StructureDefinition: <a href="https://fhir.nhs.uk/R4/StructureDefinition/UKCore-ServiceRequest">https://fhir.nhs.uk/R4/StructureDefinition/UKCore-ServiceRequest</a><br>
2020-08-14 10:51:55.137  WARN 25744 --- [o-auto-1-exec-7] .v.s.SnapshotGeneratingValidationSupport : Detected circular dependency, already generating snapshot for: <a href="https://fhir.nhs.uk/R4/StructureDefinition/UKCore-ServiceRequest">https://fhir.nhs.uk/R4/StructureDefinition/UKCore-ServiceRequest</a><br>
2020-08-14 10:51:55.138  INFO 25744 --- [o-auto-1-exec-7] .v.v.VersionSpecificWorkerContextWrapper : Generating snapshot for StructureDefinition: <a href="https://fhir.nhs.uk/R4/StructureDefinition/UKCore-CarePlan">https://fhir.nhs.uk/R4/StructureDefinition/UKCore-CarePlan</a><br>
2020-08-14 10:51:55.141  INFO 25744 --- [o-auto-1-exec-7] .v.v.VersionSpecificWorkerContextWrapper : Generating snapshot for StructureDefinition: <a href="https://fhir.nhs.uk/R4/StructureDefinition/UKCore-CarePlan">https://fhir.nhs.uk/R4/StructureDefinition/UKCore-CarePlan</a></p>
<p>Is this known about?</p>



<a name="206936568"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/5.1%20Validation%20Detected%20circular%20dependency%20-%20StackOverflow/near/206936568" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/5.2E1.20Validation.20Detected.20circular.20dependency.20-.20StackOverflow.html#206936568">(Aug 14 2020 at 14:47)</a>:</h4>
<p>Seems to be a bug around.</p>
<p>SnapshotGeneratingValidationSupport</p>
<p>UK-CarePlan mentions UK-ServiceRequest twice.<br>
Similarly UK-Service mentions UK-CarePlan twice. </p>
<p>So what I believe happens. </p>
<p>Line 10: generateSnapshot is called on UK-CarePlan, <br>
this calls generateSnapeshot on UK-ServiceRequest <br>
which then calls generateSnapshot on UK-CarePlan, this is stopped because it is already doing UK-CarePlan <br>
but it removes the semaphore on this line<br>
<a href="https://github.com/jamesagnew/hapi-fhir/blob/6a8e09addf30ed03c84263faff35a7ad4fe23517/hapi-fhir-validation/src/main/java/org/hl7/fhir/common/hapi/validation/support/SnapshotGeneratingValidationSupport.java#L137">https://github.com/jamesagnew/hapi-fhir/blob/6a8e09addf30ed03c84263faff35a7ad4fe23517/hapi-fhir-validation/src/main/java/org/hl7/fhir/common/hapi/validation/support/SnapshotGeneratingValidationSupport.java#L137</a><br>
so when it is called again for the second mention of UK-CarePlan it tries to genearate the snapShot and GOTO 10</p>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span> <span class="user-mention" data-user-id="191319">@James Agnew</span> ?? Does this sound correct?? Thanks</p>



<a name="206939173"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/5.1%20Validation%20Detected%20circular%20dependency%20-%20StackOverflow/near/206939173" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/5.2E1.20Validation.20Detected.20circular.20dependency.20-.20StackOverflow.html#206939173">(Aug 14 2020 at 15:10)</a>:</h4>
<p>What does "mentions" mean in this context?</p>
<p>I thought the snapshot generator would only recurse into the base definition (though I could be wrong), which would mean that these two profiles have each other as the base?</p>



<a name="207118321"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/5.1%20Validation%20Detected%20circular%20dependency%20-%20StackOverflow/near/207118321" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/5.2E1.20Validation.20Detected.20circular.20dependency.20-.20StackOverflow.html#207118321">(Aug 17 2020 at 08:30)</a>:</h4>
<p>I mean the derived profile has a constraint on a reference which goes to another  derived profile. </p>
<p><a href="/user_uploads/10155/wL013KnWFsQftVmnDk1t7bwV/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/10155/wL013KnWFsQftVmnDk1t7bwV/image.png" title="image.png"><img src="/user_uploads/10155/wL013KnWFsQftVmnDk1t7bwV/image.png"></a></div>



<a name="207118403"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/5.1%20Validation%20Detected%20circular%20dependency%20-%20StackOverflow/near/207118403" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/5.2E1.20Validation.20Detected.20circular.20dependency.20-.20StackOverflow.html#207118403">(Aug 17 2020 at 08:32)</a>:</h4>
<p>It looks like I can get it working by stopping the semaphore removal <a href="https://github.com/NHSDigital/fhir-validation-service/blob/master/src/main/java/uk/mayfieldis/hapifhir/support/SnapshotGeneratingValidationSupport.java#L113">https://github.com/NHSDigital/fhir-validation-service/blob/master/src/main/java/uk/mayfieldis/hapifhir/support/SnapshotGeneratingValidationSupport.java#L113</a></p>



<a name="207118422"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/5.1%20Validation%20Detected%20circular%20dependency%20-%20StackOverflow/near/207118422" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/5.2E1.20Validation.20Detected.20circular.20dependency.20-.20StackOverflow.html#207118422">(Aug 17 2020 at 08:32)</a>:</h4>
<p>Still investigating though.</p>



<a name="207119771"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/5.1%20Validation%20Detected%20circular%20dependency%20-%20StackOverflow/near/207119771" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/5.2E1.20Validation.20Detected.20circular.20dependency.20-.20StackOverflow.html#207119771">(Aug 17 2020 at 08:49)</a>:</h4>
<p>Ignore solution, now gets into a loop.</p>



<a name="207138160"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/5.1%20Validation%20Detected%20circular%20dependency%20-%20StackOverflow/near/207138160" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/5.2E1.20Validation.20Detected.20circular.20dependency.20-.20StackOverflow.html#207138160">(Aug 17 2020 at 12:45)</a>:</h4>
<p>I'm not a profiling expert by any means so there may be something basic I'm missing.. but it feels pretty fraught with peril to have 2 profiles depending on each other like that.</p>



<a name="207153214"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/5.1%20Validation%20Detected%20circular%20dependency%20-%20StackOverflow/near/207153214" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/5.2E1.20Validation.20Detected.20circular.20dependency.20-.20StackOverflow.html#207153214">(Aug 17 2020 at 14:53)</a>:</h4>
<p>it is still not 100% clear how the profiles are depending on each other, but if i am right these profiles aren't deriving from each other, but referencing each other via <code>targetProfile</code></p>



<a name="207153556"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/5.1%20Validation%20Detected%20circular%20dependency%20-%20StackOverflow/near/207153556" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/5.2E1.20Validation.20Detected.20circular.20dependency.20-.20StackOverflow.html#207153556">(Aug 17 2020 at 14:56)</a>:</h4>
<p>The SnapshotGenerator starts snapshotting the first profile, finding the <code>targetResource</code>referenced second profile,  starting the snapshot generation on the 2nd one, which includes the first profile via <code>targetProfile</code>which sending the process into a loop.</p>



<a name="207185520"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/5.1%20Validation%20Detected%20circular%20dependency%20-%20StackOverflow/near/207185520" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/5.2E1.20Validation.20Detected.20circular.20dependency.20-.20StackOverflow.html#207185520">(Aug 17 2020 at 19:15)</a>:</h4>
<p>Does this happen with the standalone validator?</p>



<a name="207230221"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/5.1%20Validation%20Detected%20circular%20dependency%20-%20StackOverflow/near/207230221" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/5.2E1.20Validation.20Detected.20circular.20dependency.20-.20StackOverflow.html#207230221">(Aug 18 2020 at 07:23)</a>:</h4>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span> no, tested with fresh standalone with no problems.</p>
<p><span class="user-mention" data-user-id="191451">@Patrick Werner</span>  my wording was slightly misleading. The circular targetProfiles are base UK profiles (the project I'm working on uses derivations of these, these are seem to be fine).  <br>
So I believe it's legitimate that Profile A has sibling profile B as targets and B has A as targets.</p>



<a name="208681721"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/5.1%20Validation%20Detected%20circular%20dependency%20-%20StackOverflow/near/208681721" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/5.2E1.20Validation.20Detected.20circular.20dependency.20-.20StackOverflow.html#208681721">(Sep 01 2020 at 12:46)</a>:</h4>
<p>Update: Still get the issue but have worked around it by using (base) profiles which include snapshots. <br>
The derived profiles (no snapshot) then work correctly.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
