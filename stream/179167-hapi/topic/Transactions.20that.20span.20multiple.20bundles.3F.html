---
layout: page
title: "FHIR Chat  · Transactions that span multiple bundles? · hapi"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/index.html">hapi</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Transactions.20that.20span.20multiple.20bundles.3F.html">Transactions that span multiple bundles?</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="153876193"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Transactions%20that%20span%20multiple%20bundles%3F/near/153876193" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Broadbent <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Transactions.20that.20span.20multiple.20bundles.3F.html#153876193">(Mar 13 2017 at 14:48)</a>:</h4>
<p>How do people perform transactions with very large bundles?  I have data which is reaching into the 10s-100s of gigs, which simply just won't fit into a single bundle, it is however all interdependent, and significantly complex enough that it's non trivial to split into smaller bundles.  How do I upload all this data to a hapi server in a single transaction?</p>
<p>In a previous system, it was all based on sql, so we could just open a connection, start a transaction, then stream it into the database in whatever sizes where necessary.</p>



<a name="153876199"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Transactions%20that%20span%20multiple%20bundles%3F/near/153876199" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Transactions.20that.20span.20multiple.20bundles.3F.html#153876199">(Mar 13 2017 at 15:10)</a>:</h4>
<p>seems you have a need beyond the scope of hapi. I might though suggest that it is also beyond the scope of the server... You have not provided any hint as to why you need to put so much data into one transaction. Seems you should reassess your transaction. You might be right, but you might be overly stuck in a previous paradigm. </p>



<a name="153876200"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Transactions%20that%20span%20multiple%20bundles%3F/near/153876200" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Broadbent <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Transactions.20that.20span.20multiple.20bundles.3F.html#153876200">(Mar 13 2017 at 15:17)</a>:</h4>
<p>Ok to give some context: our system consumes csv files, with mappings about how to transform a row of data into one or more fhir objects, those fhir objects can reference one another, and to take advantage of automatic resource reference hookup, they all need to be in the same bundle.</p>
<p>I have no control over how wide the csv table is, so problem number one is that I need a way of either putting an indefinite number of resources in a single bundle, or I need a way of buffering that bundle to a fhir database.</p>
<p>The second problem is that; from a user perspective, the csv file is the atomic unit in our system, if one resource generated from the whole file fails, then the whole files fails.  There doesn't seem to be a way to make a transaction span over multiple bundles, so I'm not really sure how I'm supposed to do this.</p>



<a name="153876201"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Transactions%20that%20span%20multiple%20bundles%3F/near/153876201" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Transactions.20that.20span.20multiple.20bundles.3F.html#153876201">(Mar 13 2017 at 15:31)</a>:</h4>
<p>That is similar to what I expected. So, is there a way to change the existing expectation of infinite CSV file? or the transaction nature? These seem to be the root of your current problem, and seem like the most un-natural ... I don't expect a positive answer, just pushing back on deign expectations from the past being applied to a new paradigm. </p>



<a name="153876203"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Transactions%20that%20span%20multiple%20bundles%3F/near/153876203" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Broadbent <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Transactions.20that.20span.20multiple.20bundles.3F.html#153876203">(Mar 13 2017 at 15:44)</a>:</h4>
<p>There is some leeway to push back on expectations however; it is research data, so everything is collected post humorously and submitted in one go.  From a user experience perspective it's a bit rubbish to say that they have to split up there files to contain a small number of rows.  More what I can't understand is why fhir doesn't specify something like this?  I know it's more complicated to implement than single request transactions, but it seems like pretty important functionality for any form of database, as I don't think you can ever get away from the fact that networks of interlinked resources are arbitrarily sized.</p>



<a name="153876212"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Transactions%20that%20span%20multiple%20bundles%3F/near/153876212" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Transactions.20that.20span.20multiple.20bundles.3F.html#153876212">(Mar 13 2017 at 15:53)</a>:</h4>
<p>Andrew, FHIR has not put any limits on the size of a Transaction. HAPI is a reference implementation, not the same thing as the FHIR specification. http is perfectly capable of streaming infinite sized transactions. I do however expect toolkits, reference implementations, and realistic servers to apply some reasonability to the expectation.  That said, you can also impose design criteria.  I just would not expect an off-the-shelf reference implementation to be able to hold infinite transaction for infinite parallel requests infinitely. The cloud is amazing able to scale, but not truly infinite.</p>



<a name="153876213"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Transactions%20that%20span%20multiple%20bundles%3F/near/153876213" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Transactions.20that.20span.20multiple.20bundles.3F.html#153876213">(Mar 13 2017 at 15:55)</a>:</h4>
<p>It sounds like you're doing an ETL task via REST or messaging. You might need to look at writing your own persistence layer for HAPI, so you can go directly to the database. I've done this but it takes longer to do.</p>



<a name="153876216"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Transactions%20that%20span%20multiple%20bundles%3F/near/153876216" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Broadbent <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Transactions.20that.20span.20multiple.20bundles.3F.html#153876216">(Mar 13 2017 at 16:00)</a>:</h4>
<p>Hey Kevin, that is correct.  I'm currently bound by the maximum size of a http request (which if I'm honest, I'm not sure if that is fixed or configurable).  My worry is that I will have to bundle all my resources into a single request, which means no matter how large that limit is, at some point in time, it will be hit.  I'm guessing using my own persistence layer will be the way to go.  In our previous implementation, we had our own proprietary storage based on SQL, so we could just open a connection, make several updates, then have them all commit when the transaction was completed.  I was just trying to find out if there was an equivalent in hapi/fhir</p>



<a name="153876328"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Transactions%20that%20span%20multiple%20bundles%3F/near/153876328" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Lawley <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Transactions.20that.20span.20multiple.20bundles.3F.html#153876328">(Mar 13 2017 at 22:05)</a>:</h4>
<p>Generally the max size of an HTTP request is configured in the underlying servlet engine (eg tomcat)</p>



<a name="153876562"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Transactions%20that%20span%20multiple%20bundles%3F/near/153876562" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Broadbent <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Transactions.20that.20span.20multiple.20bundles.3F.html#153876562">(Mar 14 2017 at 11:03)</a>:</h4>
<p>But isn't it still going to be a problem that you can't split your transaction into smaller chunks?  You will always hit a limit at some point in time.</p>



<a name="153876576"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Transactions%20that%20span%20multiple%20bundles%3F/near/153876576" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Lawley <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Transactions.20that.20span.20multiple.20bundles.3F.html#153876576">(Mar 14 2017 at 13:21)</a>:</h4>
<p>You're likely to need to worry about a transaction size limit too.<br>
But you should be able to handle the transation directly at the Servlet level (rather than with a HAPI provider) and feed the stream directly from the HttpServletRequest object into the parser's parseResource(Reader) method.<br>
Out of interest, how big is your Bundle?</p>



<a name="153876612"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Transactions%20that%20span%20multiple%20bundles%3F/near/153876612" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Broadbent <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Transactions.20that.20span.20multiple.20bundles.3F.html#153876612">(Mar 14 2017 at 14:43)</a>:</h4>
<p>For the example file that I've been given, a 15MB csv file produces about 1.5GB of xml data.</p>



<a name="153876702"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Transactions%20that%20span%20multiple%20bundles%3F/near/153876702" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Transactions.20that.20span.20multiple.20bundles.3F.html#153876702">(Mar 14 2017 at 20:35)</a>:</h4>
<p>That's going to consume quite a lot of server memeory and processing time.<br>
Including the validation that's going to occur on that data.</p>



<a name="153876731"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Transactions%20that%20span%20multiple%20bundles%3F/near/153876731" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Schneider <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Transactions.20that.20span.20multiple.20bundles.3F.html#153876731">(Mar 14 2017 at 22:03)</a>:</h4>
<p>To process a large bundle, it might be interesting if the server could persist the bundle to a staging area (e.g. local disk), and then use a streaming API to work its way through the bundle instead of attempting to pull the entire bundle into memory at once.</p>



<a name="153876789"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Transactions%20that%20span%20multiple%20bundles%3F/near/153876789" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Lawley <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Transactions.20that.20span.20multiple.20bundles.3F.html#153876789">(Mar 15 2017 at 02:00)</a>:</h4>
<p>Step 1, dont use XML :)  Seriously, you're going to need to ensure that the FHIR parsing library uses a streaming parser for XML of that size.</p>



<a name="153877407"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Transactions%20that%20span%20multiple%20bundles%3F/near/153877407" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Transactions.20that.20span.20multiple.20bundles.3F.html#153877407">(Mar 16 2017 at 10:08)</a>:</h4>
<p>this is really out past where we conceived of FHIR going. So there's no good answers I can think of</p>



<a name="153877444"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Transactions%20that%20span%20multiple%20bundles%3F/near/153877444" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Transactions.20that.20span.20multiple.20bundles.3F.html#153877444">(Mar 16 2017 at 11:58)</a>:</h4>
<p>Seems best to define it as an operation. In this way you can stream as much as you need to, until the server complains of unprocessed buffer space consumed. I don't think it is a 80% need, certainly not an 80% being widely used today.</p>



<a name="153877489"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Transactions%20that%20span%20multiple%20bundles%3F/near/153877489" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Schneider <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Transactions.20that.20span.20multiple.20bundles.3F.html#153877489">(Mar 16 2017 at 15:18)</a>:</h4>
<p>There is an apparent "opportunity" to improve the mechanism for loading a large external code system via FHIR.  For example, I have a code system with about 400,000 concepts.  To load a bundle containing this code system into a HAPI server, I had to increase the Java heap size to 2g.  I think the large memory footprint is related to the way FHIR defines a CodeSystem, including all its concepts, as an atomic resource.  HAPI's current workaround for dealing with large external code systems is to implement a custom loader that circumvents FHIR and interacts directly with HAPI's back-end database.</p>



<a name="153877520"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Transactions%20that%20span%20multiple%20bundles%3F/near/153877520" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Transactions.20that.20span.20multiple.20bundles.3F.html#153877520">(Mar 16 2017 at 18:52)</a>:</h4>
<p>yes, the CodeSystem resource was never intended to scale up like that. I am amazed you got it to work at all; a general purpose format that's good for all sorts of things will never be as efficient as a specific tailored format, and 400k rows makes for a big difference</p>



<a name="153877580"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Transactions%20that%20span%20multiple%20bundles%3F/near/153877580" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Schneider <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Transactions.20that.20span.20multiple.20bundles.3F.html#153877580">(Mar 17 2017 at 00:21)</a>:</h4>
<p>It's a pretty good stress test for the server.  :)</p>



<a name="153877969"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Transactions%20that%20span%20multiple%20bundles%3F/near/153877969" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Transactions.20that.20span.20multiple.20bundles.3F.html#153877969">(Mar 18 2017 at 08:44)</a>:</h4>
<p>I've been tesing mine with a 88k concept one, particularly the dotnet validator. Found some performane improvements too.</p>



<a name="153877970"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Transactions%20that%20span%20multiple%20bundles%3F/near/153877970" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Transactions.20that.20span.20multiple.20bundles.3F.html#153877970">(Mar 18 2017 at 08:44)</a>:</h4>
<p>(Good thing my server also supports compressed request and response)</p>



<a name="153878013"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Transactions%20that%20span%20multiple%20bundles%3F/near/153878013" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Teichrow <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Transactions.20that.20span.20multiple.20bundles.3F.html#153878013">(Mar 18 2017 at 19:30)</a>:</h4>
<p>Very very interesting problem domain.  We fought this battle (and kind of reached a detante) on Mirth Results when we added the REST API a couple years back.  Interestingly (or not, haha) our first non-Mirth proprietary API was making Results a Smart container (pre FHIR).  We didn't hit this issue at that point mainly due to the narrow-ish focus of the API implemented at that time.  It was the transactional boundries that were the tricky part, as I recall, and the implicit 'all or nothing' contract that the call was to preserve (say loading an entire code system...).  Anyways, fun to see folks grappling with this issue :)</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
