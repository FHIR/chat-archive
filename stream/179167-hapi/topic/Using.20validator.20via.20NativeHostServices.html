---
layout: page
title: "FHIR Chat  · Using validator via NativeHostServices · hapi"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/index.html">hapi</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Using.20validator.20via.20NativeHostServices.html">Using validator via NativeHostServices</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="183639960"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Using%20validator%20via%20NativeHostServices/near/183639960" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Morten Ernebjerg <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Using.20validator.20via.20NativeHostServices.html#183639960">(Dec 17 2019 at 11:36)</a>:</h4>
<p>I'm trying to get use the validator running (outside a HAPI server) for validation STU3 resources using <code>org.hl7.fhir.r5.validation.NativeHostServices</code>. The JDoc in this class says that the setup includes the following step:</p>
<blockquote>
<ul>
<li>call init(path) where path refers to one of the definitions files from the main build (e.g. definitions.xml.zip) - required, do only once, do before anything else</li>
</ul>
</blockquote>
<p>However, calling <code>init()</code> on a NativeHostServices instances and passing the path to a <em>definitions.json.zip</em> file does not seem to work - it  fails with the error "Unable to find/resolve/read -ig [path passed]"</p>
<p>Following the call stack, we have</p>
<p><code>init(src)</code> --&gt;  <code>new ValidationEngine(src)</code>  --&gt; <code>loadDefinitions(src, false)</code> --&gt; <code>loadIgSource(src, false, true)</code></p>
<p>In <code>loadIgSource(src,...)</code>, a comment says</p>
<blockquote>
<p>// src can be one of the following:<br>
    // - a canonical url for an ig - this will be converted to a package id and loaded into the cache<br>
    // - a package id for an ig - this will be loaded into the cache<br>
    // - a direct reference to a package ("package.tgz") - this will be extracted by the cache manager, but not put in the cache</p>
</blockquote>
<p>Passing the path to <em>definitions.json.zip</em>  does not seem to fit here and indeed, it does not match any of the conditions inside the method - it only recognizes files ending with ".tgz", "igpack.zip", or ".pack".</p>
<p>Do I need the base resource defs in another format to get this working?</p>



<a name="183679816"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Using%20validator%20via%20NativeHostServices/near/183679816" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Using.20validator.20via.20NativeHostServices.html#183679816">(Dec 17 2019 at 19:05)</a>:</h4>
<p>oh I need to add a test case for this. I'll do that later today. You need to pass in package Ids now</p>



<a name="183679921"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Using%20validator%20via%20NativeHostServices/near/183679921" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Using.20validator.20via.20NativeHostServices.html#183679921">(Dec 17 2019 at 19:06)</a>:</h4>
<p>have you looked at NativeHostServiceTester ?</p>



<a name="183735695"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Using%20validator%20via%20NativeHostServices/near/183735695" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Morten Ernebjerg <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Using.20validator.20via.20NativeHostServices.html#183735695">(Dec 18 2019 at 10:04)</a>:</h4>
<p>Right, looked into it now. Loading via an ID means loading with HTTP, right? My code might be running in an environment where internet access cannot be assumed so I'd need to be able to access the profiles locally. BTW renaming "definition.json.zip" to "definitions.json.igpack.zip" seems to make the load complete since it now matches one of the pattern, but I still need to check that  validation runs correctly.</p>



<a name="183736264"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Using%20validator%20via%20NativeHostServices/near/183736264" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Using.20validator.20via.20NativeHostServices.html#183736264">(Dec 18 2019 at 10:12)</a>:</h4>
<p>well, if the packages are installed in the local cache, then there's no need for internet access</p>



<a name="183740377"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Using%20validator%20via%20NativeHostServices/near/183740377" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Morten Ernebjerg <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Using.20validator.20via.20NativeHostServices.html#183740377">(Dec 18 2019 at 11:08)</a>:</h4>
<p>I think I may be thinking about this all wrong (Java is not my native home...). When would I load the packages into the local cache?</p>



<a name="183741063"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Using%20validator%20via%20NativeHostServices/near/183741063" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Using.20validator.20via.20NativeHostServices.html#183741063">(Dec 18 2019 at 11:19)</a>:</h4>
<p>it happens once. The NativeHostValidator will fetch it from the web and store it in local cache. But you can put it in there too, or get the java code to do it as a once off</p>



<a name="183746104"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Using%20validator%20via%20NativeHostServices/near/183746104" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Morten Ernebjerg <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Using.20validator.20via.20NativeHostServices.html#183746104">(Dec 18 2019 at 12:39)</a>:</h4>
<p>OK, thanks - I'll dive in a bit deeper.</p>



<a name="183839838"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Using%20validator%20via%20NativeHostServices/near/183839838" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Morten Ernebjerg <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Using.20validator.20via.20NativeHostServices.html#183839838">(Dec 19 2019 at 12:19)</a>:</h4>
<p>I tried getting NativeHostServicesTester to run. However, the current code in that class tries to load <code>hl7.fhir.core#4.0.0 </code>, but it fails saying "Unable to resolve version 4.0.0 for package hl7.fhir.core" (and similar for 4.0.1). When changing the version in the <code>init()</code> method call to  "hl7.fhir.core#3.0.2", it starts loading the resources but fails because of a duplicate resource:</p>
<div class="codehilite"><pre><span></span>starting...
Creating Package manager?
+  .. load IG from hl7.fhir.r3.examples#3.0.2
+  .. load IG from hl7.fhir.r3.expansions#3.0.2
+  .. load IG from hl7.fhir.r3.elements#3.0.2
Error loading ImplementationGuide-fhir.json: Duplicate Resource http://hl7.org/fhir/ImplementationGuide/fhir
Exception in thread &quot;main&quot; org.hl7.fhir.exceptions.FHIRException: Error loading ImplementationGuide-fhir.json: Duplicate Resource http://hl7.org/fhir/ImplementationGuide/fhir
    at org.hl7.fhir.r5.context.SimpleWorkerContext.fromDefinitions(SimpleWorkerContext.java:207)
    at org.hl7.fhir.r5.validation.ValidationEngine.loadDefinitions(ValidationEngine.java:406)
    at org.hl7.fhir.r5.validation.ValidationEngine.&lt;init&gt;(ValidationEngine.java:390)
    at org.hl7.fhir.r5.validation.NativeHostServices.init(NativeHostServices.java:157)
    at org.hl7.fhir.validation.tests.NativeHostServiceTester.main(NativeHostServiceTester.java:14)
Caused by: org.hl7.fhir.exceptions.DefinitionException: Duplicate Resource http://hl7.org/fhir/ImplementationGuide/fhir
    at org.hl7.fhir.r5.context.BaseWorkerContext.cacheResource(BaseWorkerContext.java:225)
    at org.hl7.fhir.r5.context.SimpleWorkerContext.loadFromFileJson(SimpleWorkerContext.java:282)
    at org.hl7.fhir.r5.context.SimpleWorkerContext.loadDefinitionItem(SimpleWorkerContext.java:216)
    at org.hl7.fhir.r5.context.SimpleWorkerContext.fromDefinitions(SimpleWorkerContext.java:204)
    ... 4 more

Process finished with exit code 1
</pre></div>


<p>Is that an issue with the code or the package being loaded?</p>



<a name="183841099"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Using%20validator%20via%20NativeHostServices/near/183841099" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Morten Ernebjerg <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Using.20validator.20via.20NativeHostServices.html#183841099">(Dec 19 2019 at 12:38)</a>:</h4>
<p>Looking at the cached file "/packages/hl7.fhir.r3.examples#3.0.2/package/.index.json", the URL <em>"http://hl7.org/fhir/ImplementationGuide/fhir"</em> does indeed occur twice,:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
      <span class="nt">&quot;filename&quot;</span><span class="p">:</span> <span class="s2">&quot;ig-r4.json&quot;</span><span class="p">,</span>
      <span class="nt">&quot;resourceType&quot;</span><span class="p">:</span> <span class="s2">&quot;ImplementationGuide&quot;</span><span class="p">,</span>
      <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;fhir&quot;</span><span class="p">,</span>
      <span class="nt">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://hl7.org/fhir/ImplementationGuide/fhir&quot;</span><span class="p">,</span>
      <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;3.0.2&quot;</span>
    <span class="p">}</span><span class="err">,</span>
<span class="err">...</span>
 <span class="p">{</span>
      <span class="nt">&quot;filename&quot;</span><span class="p">:</span> <span class="s2">&quot;ImplementationGuide-fhir.json&quot;</span><span class="p">,</span>
      <span class="nt">&quot;resourceType&quot;</span><span class="p">:</span> <span class="s2">&quot;ImplementationGuide&quot;</span><span class="p">,</span>
      <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;fhir&quot;</span><span class="p">,</span>
      <span class="nt">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://hl7.org/fhir/ImplementationGuide/fhir&quot;</span><span class="p">,</span>
      <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;3.0.2&quot;</span>
    <span class="p">}</span><span class="err">,</span>
</pre></div>


<p>Might that be the issue?</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
