---
layout: page
title: "FHIR Chat  · Security per resource · hapi"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/index.html">hapi</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Security.20per.20resource.html">Security per resource</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="153996140"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Security%20per%20resource/near/153996140" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean McIlvenna <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Security.20per.20resource.html#153996140">(Sep 12 2018 at 06:12)</a>:</h4>
<p>There are examples of implementing security for resource types, or for compartments. But, are there examples of how to secure each individual resource? For example, Joe has access to Observation/1 while Jane only has access to Observation/2? They might be able to create their own resources, but wouldn't be able to see other resources unless they are given permission by someone who already has access to the resource?</p>



<a name="153996277"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Security%20per%20resource/near/153996277" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Security.20per.20resource.html#153996277">(Sep 12 2018 at 15:10)</a>:</h4>
<p>This is a question that should be directed to the Security and Privacy stream --- It seems you are asking about an implementation detail, not FHIR model, or hapi toolkit question.</p>



<a name="153996282"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Security%20per%20resource/near/153996282" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean McIlvenna <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Security.20per.20resource.html#153996282">(Sep 12 2018 at 15:23)</a>:</h4>
<p>No.. I'm asking how to do this in HAPI</p>



<a name="153996284"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Security%20per%20resource/near/153996284" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Security.20per.20resource.html#153996284">(Sep 12 2018 at 15:30)</a>:</h4>
<p>HAPI client or HAPI server? Meaning are you trying to access a server that has this level control, or are you trying to implement a server with this level control?</p>



<a name="153996286"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Security%20per%20resource/near/153996286" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean McIlvenna <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Security.20per.20resource.html#153996286">(Sep 12 2018 at 15:33)</a>:</h4>
<p>implement a server with this level of control</p>



<a name="153996287"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Security%20per%20resource/near/153996287" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean McIlvenna <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Security.20per.20resource.html#153996287">(Sep 12 2018 at 15:33)</a>:</h4>
<p>To add a little more information:<br>
I'm considering using the Provenance resource to indicate what resources each user (who is also associated with a Person resource) is allowed to access.</p>
<p>I believe I figured out that from the "Authorization Interceptor" docs that you can create a conditional rule that runs custom logic for each request...<br>
I was thinking something like this:</p>
<p>RuleBuilder rb = new RuleBuilder();<br>
rb.allow().updateConditional().allResources().withTester(new TestAuthRuleTester(userPersonId));<br>
rb.allow().deleteConditional().allResources().withTester(new TestAuthRuleTester(userPersonId));</p>
<p>However, in my TestAuthRuleTester implementation, I'm not sure how I would gain access to the resources in the server...<br>
I took a look through the RequestDetails class and there doesn't appear to be anything that would grant me access to the resources in the DB. There is getFhirContext(), but that appears to only return resource definitions baked into the server (such as the base StructureDefinition for Observation, Patient, etc.)</p>



<a name="153996288"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Security%20per%20resource/near/153996288" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Security.20per.20resource.html#153996288">(Sep 12 2018 at 15:36)</a>:</h4>
<p>Okay, that is  a far more specific question the HAPI experts can focus on.  Yes, in those interceptors you would need to be able to access other resources (Consents, Provenance, the meta element of the resource being accessed, etc).</p>



<a name="153996289"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Security%20per%20resource/near/153996289" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Security.20per.20resource.html#153996289">(Sep 12 2018 at 15:38)</a>:</h4>
<p>what tends to throw people is when asking about Security, people often get blinders thinking you have an OAuth question. But in your case, due to the fine-grain access control, you need to add business logic above-and-beyond OAuth that is implemented at the Resource Server API.</p>



<a name="161233668"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Security%20per%20resource/near/161233668" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Security.20per.20resource.html#161233668">(Mar 20 2019 at 10:40)</a>:</h4>
<p><span class="user-mention" data-user-id="191505">@Sean McIlvenna</span> - if you intend to use <code>withTester()</code> you essentially need to inspect the datagraph and access the database using your own custom logic</p>



<a name="211935290"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Security%20per%20resource/near/211935290" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Fadeley <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Security.20per.20resource.html#211935290">(Oct 01 2020 at 16:16)</a>:</h4>
<p>I'm actually having a similar issue.</p>
<p>As we have it, a Patient is supposed to have access to their Coverage, Related Person, Contract, Patient and Explanation of Benefit details.  An example rule is like:</p>
<p>new RuleBuilder().allow().read().resourcesOfType(ExplanationOfBenefit.class).inCompartment(&lt;IdType for Patient&gt;)...</p>
<p>For the patient endpoints, this works perfectly fine for reads and searches. For EOBs however, it only permits the search request to go through if patient is explicitly mentioned either like _id=Patient/X or patient=X. Is there anyway to allow the search to go on and confirm the resources is in the Patient's compartment without stating it?</p>



<a name="211935894"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Security%20per%20resource/near/211935894" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Security.20per.20resource.html#211935894">(Oct 01 2020 at 16:21)</a>:</h4>
<p><span class="user-mention" data-user-id="348029">@James Fadeley</span> have a look at <a href="https://hapifhir.io/hapi-fhir/apidocs/hapi-fhir-server/ca/uhn/fhir/rest/server/interceptor/auth/class-use/IAuthRuleTester.html">https://hapifhir.io/hapi-fhir/apidocs/hapi-fhir-server/ca/uhn/fhir/rest/server/interceptor/auth/class-use/IAuthRuleTester.html</a> - it can be used in various ways to add custom security checks</p>



<a name="211936067"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Security%20per%20resource/near/211936067" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Security.20per.20resource.html#211936067">(Oct 01 2020 at 16:22)</a>:</h4>
<p>or eg. <a href="https://hapifhir.io/hapi-fhir/apidocs/hapi-fhir-server/ca/uhn/fhir/rest/server/interceptor/auth/SearchNarrowingInterceptor.html">https://hapifhir.io/hapi-fhir/apidocs/hapi-fhir-server/ca/uhn/fhir/rest/server/interceptor/auth/SearchNarrowingInterceptor.html</a></p>



<a name="211937349"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Security%20per%20resource/near/211937349" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Fadeley <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Security.20per.20resource.html#211937349">(Oct 01 2020 at 16:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="191427">Jens Villadsen</span> <a href="#narrow/stream/179167-hapi/topic/Security.20per.20resource/near/211936067">said</a>:</p>
<blockquote>
<p>or eg. <a href="https://hapifhir.io/hapi-fhir/apidocs/hapi-fhir-server/ca/uhn/fhir/rest/server/interceptor/auth/SearchNarrowingInterceptor.html">https://hapifhir.io/hapi-fhir/apidocs/hapi-fhir-server/ca/uhn/fhir/rest/server/interceptor/auth/SearchNarrowingInterceptor.html</a></p>
</blockquote>
<p>Thank you! I'll have a look.</p>



<a name="211946926"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Security%20per%20resource/near/211946926" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Fadeley <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Security.20per.20resource.html#211946926">(Oct 01 2020 at 17:41)</a>:</h4>
<p>So the SearchNarrowingInterceptor seems to be a step in the right direction but the AuthorizationInterceptor is still coming down hard. Is there something I'm supposed to do to connect the two, or make the AuthorizationInterceptor recognize the addendum of SearchNarrowingInterceptor?</p>



<a name="211952792"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Security%20per%20resource/near/211952792" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Security.20per.20resource.html#211952792">(Oct 01 2020 at 18:23)</a>:</h4>
<p>see <a href="https://hapifhir.io/hapi-fhir/docs/security/search_narrowing_interceptor.html">https://hapifhir.io/hapi-fhir/docs/security/search_narrowing_interceptor.html</a></p>



<a name="211957276"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Security%20per%20resource/near/211957276" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Fadeley <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Security.20per.20resource.html#211957276">(Oct 01 2020 at 18:55)</a>:</h4>
<p>I did read and apply that. The interceptor is visited first and appends the Patient IdTypes to the AuthorizedList under compartments. However, it then visits AuthorizationInterceptor and still feels the need to deny the request. </p>
<p>In the Search Narrowing:<br>
AuthorizedList cascadingList = new AuthorizedList() .addCompartment(&lt;IdType&gt;);</p>
<p>And in the Authorization Interceptor:<br>
new RuleBuilder().allow().read().resourcesOfType(ExplanationOfBenefit.class).inCompartment(&lt;IdType for Patient&gt;)...</p>
<p>And it still blocks. Is there anything I'm not grasping?</p>



<a name="211958267"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Security%20per%20resource/near/211958267" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Security.20per.20resource.html#211958267">(Oct 01 2020 at 19:02)</a>:</h4>
<p>well ... you should allow access to the resource without the requirement of the 'inCompartment</p>



<a name="211958483"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Security%20per%20resource/near/211958483" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Security.20per.20resource.html#211958483">(Oct 01 2020 at 19:03)</a>:</h4>
<p>eg: ruleBuilder.allow().read().resourcesOfType(ExplanationOfBenefit.class).withAnyId().withTester( MyTester()).andThen() ...</p>



<a name="211958951"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Security%20per%20resource/near/211958951" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Fadeley <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Security.20per.20resource.html#211958951">(Oct 01 2020 at 19:07)</a>:</h4>
<p>I'll give it a shot. Thank you!</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
