---
layout: page
title: "FHIR Chat  · Date/Time comparison · hapi"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/index.html">hapi</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Date.2FTime.20comparison.html">Date/Time comparison</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="165682531"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Date/Time%20comparison/near/165682531" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Date.2FTime.20comparison.html#165682531">(May 15 2019 at 03:14)</a>:</h4>
<p><span class="user-mention" data-user-id="191319">@James Agnew</span> I do not understand the implementation of org.hl7.fhir.r5.model.BaseDateTimeType.equalsUsingFhirPathRules(BaseDateTimeType):</p>



<a name="165682536"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Date/Time%20comparison/near/165682536" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Date.2FTime.20comparison.html#165682536">(May 15 2019 at 03:14)</a>:</h4>
<div class="codehilite"><pre><span></span>    <span class="n">BaseDateTimeType</span> <span class="n">me</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>

    <span class="c1">// Per FHIRPath rules, we compare equivalence at the lowest precision of the two values,</span>
    <span class="c1">// so if we need to, we&#39;ll clone either side and reduce its precision</span>
    <span class="kt">int</span> <span class="n">lowestPrecision</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">me</span><span class="o">.</span><span class="na">getPrecision</span><span class="o">().</span><span class="na">ordinal</span><span class="o">(),</span> <span class="n">theOther</span><span class="o">.</span><span class="na">getPrecision</span><span class="o">().</span><span class="na">ordinal</span><span class="o">());</span>
    <span class="n">TemporalPrecisionEnum</span> <span class="n">lowestPrecisionEnum</span> <span class="o">=</span> <span class="n">TemporalPrecisionEnum</span><span class="o">.</span><span class="na">values</span><span class="o">()[</span><span class="n">lowestPrecision</span><span class="o">];</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">me</span><span class="o">.</span><span class="na">getPrecision</span><span class="o">()</span> <span class="o">!=</span> <span class="n">lowestPrecisionEnum</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">me</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DateTimeType</span><span class="o">(</span><span class="n">me</span><span class="o">.</span><span class="na">getValueAsString</span><span class="o">());</span>
      <span class="n">me</span><span class="o">.</span><span class="na">setPrecision</span><span class="o">(</span><span class="n">lowestPrecisionEnum</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">theOther</span><span class="o">.</span><span class="na">getPrecision</span><span class="o">()</span> <span class="o">!=</span> <span class="n">lowestPrecisionEnum</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">theOther</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DateTimeType</span><span class="o">(</span><span class="n">theOther</span><span class="o">.</span><span class="na">getValueAsString</span><span class="o">());</span>
      <span class="n">theOther</span><span class="o">.</span><span class="na">setPrecision</span><span class="o">(</span><span class="n">lowestPrecisionEnum</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">me</span><span class="o">.</span><span class="na">hasTimezoneIfRequired</span><span class="o">()</span> <span class="o">!=</span> <span class="n">theOther</span><span class="o">.</span><span class="na">hasTimezoneIfRequired</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">me</span><span class="o">.</span><span class="na">getPrecision</span><span class="o">()</span> <span class="o">==</span> <span class="n">theOther</span><span class="o">.</span><span class="na">getPrecision</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">me</span><span class="o">.</span><span class="na">getPrecision</span><span class="o">().</span><span class="na">ordinal</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">TemporalPrecisionEnum</span><span class="o">.</span><span class="na">MINUTE</span><span class="o">.</span><span class="na">ordinal</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">theOther</span><span class="o">.</span><span class="na">getPrecision</span><span class="o">().</span><span class="na">ordinal</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">TemporalPrecisionEnum</span><span class="o">.</span><span class="na">MINUTE</span><span class="o">.</span><span class="na">ordinal</span><span class="o">())</span> <span class="o">{</span>
          <span class="kt">boolean</span> <span class="n">couldBeTheSameTime</span> <span class="o">=</span> <span class="n">couldBeTheSameTime</span><span class="o">(</span><span class="n">me</span><span class="o">,</span> <span class="n">theOther</span><span class="o">)</span> <span class="o">||</span> <span class="n">couldBeTheSameTime</span><span class="o">(</span><span class="n">theOther</span><span class="o">,</span> <span class="n">me</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">(!</span><span class="n">couldBeTheSameTime</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Same precision</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">me</span><span class="o">.</span><span class="na">getPrecision</span><span class="o">()</span> <span class="o">==</span> <span class="n">theOther</span><span class="o">.</span><span class="na">getPrecision</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">me</span><span class="o">.</span><span class="na">getPrecision</span><span class="o">().</span><span class="na">ordinal</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">TemporalPrecisionEnum</span><span class="o">.</span><span class="na">MINUTE</span><span class="o">.</span><span class="na">ordinal</span><span class="o">())</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">leftTime</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">getTime</span><span class="o">();</span>
        <span class="kt">long</span> <span class="n">rightTime</span> <span class="o">=</span> <span class="n">theOther</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">getTime</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">leftTime</span> <span class="o">==</span> <span class="n">rightTime</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">leftTime</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="na">getValueAsString</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">rightTime</span> <span class="o">=</span> <span class="n">theOther</span><span class="o">.</span><span class="na">getValueAsString</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">leftTime</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">rightTime</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
</pre></div>



<a name="165682554"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Date/Time%20comparison/near/165682554" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Date.2FTime.20comparison.html#165682554">(May 15 2019 at 03:15)</a>:</h4>
<p>we start y forcing them to the same precision... and then we compare to see if the precision that we forced them to is indeed the same precision.... uh?</p>



<a name="165682692"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Date/Time%20comparison/near/165682692" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Date.2FTime.20comparison.html#165682692">(May 15 2019 at 03:19)</a>:</h4>
<p>and given the comments:</p>



<a name="165682694"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Date/Time%20comparison/near/165682694" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Date.2FTime.20comparison.html#165682694">(May 15 2019 at 03:19)</a>:</h4>
<div class="codehilite"><pre><span></span>   <span class="o">*</span> <span class="n">This</span> <span class="n">method</span> <span class="n">returns</span><span class="o">:</span>
   <span class="o">*</span> <span class="o">&lt;</span><span class="n">ul</span><span class="o">&gt;</span>
   <span class="o">*</span>     <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;</span><span class="kc">true</span> <span class="k">if</span> <span class="n">the</span> <span class="n">given</span> <span class="n">datetimes</span> <span class="n">represent</span> <span class="n">the</span> <span class="n">exact</span> <span class="n">same</span> <span class="n">instant</span> <span class="n">with</span> <span class="n">the</span> <span class="n">same</span> <span class="nf">precision</span> <span class="o">(</span><span class="n">irrespective</span> <span class="n">of</span> <span class="n">the</span> <span class="n">timezone</span><span class="o">)&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
   <span class="o">*</span>     <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;</span><span class="kc">true</span> <span class="k">if</span> <span class="n">the</span> <span class="n">given</span> <span class="n">datetimes</span> <span class="n">represent</span> <span class="n">the</span> <span class="n">exact</span> <span class="n">same</span> <span class="n">instant</span> <span class="n">but</span> <span class="n">one</span> <span class="n">includes</span> <span class="n">milliseconds</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;.[</span><span class="mi">0</span><span class="o">]+&lt;/</span><span class="n">code</span><span class="o">&gt;</span> <span class="k">while</span> <span class="n">the</span> <span class="n">other</span> <span class="n">includes</span> <span class="n">only</span> <span class="n">SECONDS</span> <span class="nf">precision</span> <span class="o">(</span><span class="n">irrespecitve</span> <span class="n">of</span> <span class="n">the</span> <span class="n">timezone</span><span class="o">)&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
   <span class="o">*</span>     <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;</span><span class="kc">true</span> <span class="k">if</span> <span class="n">the</span> <span class="n">given</span> <span class="n">datetimes</span> <span class="n">represent</span> <span class="n">the</span> <span class="n">exact</span> <span class="n">same</span> <span class="n">year</span><span class="o">/</span><span class="n">year</span><span class="o">-</span><span class="n">month</span><span class="o">/</span><span class="n">year</span><span class="o">-</span><span class="n">month</span><span class="o">-</span><span class="n">date</span> <span class="o">(</span><span class="k">if</span> <span class="n">both</span> <span class="n">operands</span> <span class="n">have</span> <span class="n">the</span> <span class="n">same</span> <span class="n">precision</span><span class="o">)&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
   <span class="o">*</span>     <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;</span><span class="kc">false</span> <span class="k">if</span> <span class="n">both</span> <span class="n">datetimes</span> <span class="n">have</span> <span class="n">equal</span> <span class="n">precision</span> <span class="n">of</span> <span class="n">MINUTE</span> <span class="n">or</span> <span class="n">greater</span><span class="o">,</span> <span class="n">one</span> <span class="n">has</span> <span class="n">no</span> <span class="n">timezone</span> <span class="n">specified</span> <span class="n">but</span> <span class="n">the</span> <span class="n">other</span> <span class="n">does</span><span class="o">,</span> <span class="n">and</span> <span class="n">could</span> <span class="n">not</span> <span class="n">represent</span> <span class="n">the</span> <span class="n">same</span> <span class="n">instant</span> <span class="n">in</span> <span class="n">any</span> <span class="n">timezone</span><span class="o">&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
   <span class="o">*</span>     <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;</span><span class="kc">null</span> <span class="k">if</span> <span class="n">both</span> <span class="n">datetimes</span> <span class="n">have</span> <span class="n">equal</span> <span class="n">precision</span> <span class="n">of</span> <span class="n">MINUTE</span> <span class="n">or</span> <span class="n">greater</span><span class="o">,</span> <span class="n">one</span> <span class="n">has</span> <span class="n">no</span> <span class="n">timezone</span> <span class="n">specified</span> <span class="n">but</span> <span class="n">the</span> <span class="n">other</span> <span class="n">does</span><span class="o">,</span> <span class="n">and</span> <span class="n">could</span> <span class="n">potentially</span> <span class="n">represent</span> <span class="n">the</span> <span class="n">same</span> <span class="n">instant</span> <span class="n">in</span> <span class="n">any</span> <span class="n">timezone</span><span class="o">&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
   <span class="o">*</span>     <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;</span><span class="kc">false</span> <span class="k">if</span> <span class="n">the</span> <span class="n">given</span> <span class="n">datetimes</span> <span class="n">have</span> <span class="n">the</span> <span class="n">same</span> <span class="n">precision</span> <span class="n">but</span> <span class="k">do</span> <span class="n">not</span> <span class="n">represent</span> <span class="n">the</span> <span class="n">same</span> <span class="nf">instant</span> <span class="o">(</span><span class="n">irrespective</span> <span class="n">of</span> <span class="n">timezone</span><span class="o">)&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
   <span class="o">*</span>     <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;</span><span class="kc">null</span> <span class="nf">otherwise</span> <span class="o">(</span><span class="n">since</span> <span class="n">these</span> <span class="n">datetimes</span> <span class="n">are</span> <span class="n">not</span> <span class="n">comparable</span><span class="o">)&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
   <span class="o">*</span> <span class="o">&lt;/</span><span class="n">ul</span><span class="o">&gt;</span>
</pre></div>



<a name="165682750"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Date/Time%20comparison/near/165682750" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Date.2FTime.20comparison.html#165682750">(May 15 2019 at 03:20)</a>:</h4>
<p>this just outright looks like an error. And, of course, the FHIRPath tests fail. So I think I just need to fix this routine to work as described, and JUnit test it directly...?</p>



<a name="165682768"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Date/Time%20comparison/near/165682768" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Date.2FTime.20comparison.html#165682768">(May 15 2019 at 03:21)</a>:</h4>
<p>ah it does have direct tests and they all fail...</p>



<a name="165715137"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Date/Time%20comparison/near/165715137" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Date.2FTime.20comparison.html#165715137">(May 15 2019 at 13:40)</a>:</h4>
<p>The logic there is to satisfy the following text in the FhIrPaTh spec: <code>If one operand has less precision than the other, comparison is done at the lowest precision.</code></p>
<p>The idea being that if the two sides don't have the same precision, we make a copy of whichever one had the higher precision and then reduce the precision of that copy. Then we compare the copy instead of the original.</p>



<a name="166057136"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Date/Time%20comparison/near/166057136" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Date.2FTime.20comparison.html#166057136">(May 20 2019 at 05:08)</a>:</h4>
<p>this text has changed in the latest version. And that routine exists to serve the latest version of FHIRPath</p>



<a name="166059194"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Date/Time%20comparison/near/166059194" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Date.2FTime.20comparison.html#166059194">(May 20 2019 at 06:01)</a>:</h4>
<p>I checked in a revised version.</p>



<a name="166082597"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Date/Time%20comparison/near/166082597" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Date.2FTime.20comparison.html#166082597">(May 20 2019 at 13:01)</a>:</h4>
<p>sounds good</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
