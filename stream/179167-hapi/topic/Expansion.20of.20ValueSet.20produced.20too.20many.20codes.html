---
layout: page
title: "FHIR Chat  · Expansion of ValueSet produced too many codes · hapi"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/index.html">hapi</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Expansion.20of.20ValueSet.20produced.20too.20many.20codes.html">Expansion of ValueSet produced too many codes</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="233534338"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Expansion%20of%20ValueSet%20produced%20too%20many%20codes/near/233534338" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Hausam <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Expansion.20of.20ValueSet.20produced.20too.20many.20codes.html#233534338">(Apr 07 2021 at 17:57)</a>:</h4>
<p>Are folks seeing this (<code>Expansion of ValueSet produced too many codes (maximum 1,000) - Operation aborted!</code>) and how are you dealing with it?  I'm trying to use $expand and filter on the full ICD-10-CM code system (definitely &gt; 1000 codes) and am running into this issue.  Narrowing the returned results by using the filter and also trying setting the $expand 'count' parameter to a low value (e.g. 20) doesn't help eliminate the error (on HAPI 5.3.0 jpaserver-starter).</p>



<a name="233584086"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Expansion%20of%20ValueSet%20produced%20too%20many%20codes/near/233584086" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lin Zhang <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Expansion.20of.20ValueSet.20produced.20too.20many.20codes.html#233584086">(Apr 08 2021 at 00:26)</a>:</h4>
<p>Once for me.  I couldn't remember the details or my response clearly, with v5.1.0 or v5.2.0.</p>



<a name="233584693"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Expansion%20of%20ValueSet%20produced%20too%20many%20codes/near/233584693" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Hausam <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Expansion.20of.20ValueSet.20produced.20too.20many.20codes.html#233584693">(Apr 08 2021 at 00:33)</a>:</h4>
<p>Thanks, Lin.  And I'm still looking for how to fix it.</p>



<a name="233587711"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Expansion%20of%20ValueSet%20produced%20too%20many%20codes/near/233587711" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Hausam <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Expansion.20of.20ValueSet.20produced.20too.20many.20codes.html#233587711">(Apr 08 2021 at 01:12)</a>:</h4>
<p>The code system and value set have 95587 codes, so the pre-expansion took a considerable amount of time.  But now that it is finally complete, the "too many codes" issue seems to be no longer occurring.  I assume that is expected (and I think it makes sense that it would be)?</p>



<a name="233628223"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Expansion%20of%20ValueSet%20produced%20too%20many%20codes/near/233628223" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hanan Awwad <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Expansion.20of.20ValueSet.20produced.20too.20many.20codes.html#233628223">(Apr 08 2021 at 09:56)</a>:</h4>
<p>Hi Rob and Lin<br>
Value set expansion worked in a background job that is running after submitting new value set, in case you called $expand before the expansion is finished (once vs is expanded its concepts is stored in database and its status switched to expanded), the expansion will be running on RAM to return the result, hence the vs is larger than 1000 it will throw this exception "too many codes" .</p>
<p>If you wait till the job is finished and all concepts stored in db and status is switched from in progress to expanded, then you won't have this exception any more</p>



<a name="233643140"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Expansion%20of%20ValueSet%20produced%20too%20many%20codes/near/233643140" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lin Zhang <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Expansion.20of.20ValueSet.20produced.20too.20many.20codes.html#233643140">(Apr 08 2021 at 12:24)</a>:</h4>
<p><span class="user-mention" data-user-id="279021">@Hanan Awwad</span>  Wow, Thanks</p>



<a name="233643362"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Expansion%20of%20ValueSet%20produced%20too%20many%20codes/near/233643362" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Hausam <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Expansion.20of.20ValueSet.20produced.20too.20many.20codes.html#233643362">(Apr 08 2021 at 12:26)</a>:</h4>
<p><span class="user-mention" data-user-id="279021">@Hanan Awwad</span> Yes, that's exactly what I saw.  What wasn't clear in advance, though, was the schedule for performing the expansion and the amount of time to expect that it would take.  It just requires a bit of patience! :)</p>



<a name="233681070"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Expansion%20of%20ValueSet%20produced%20too%20many%20codes/near/233681070" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Silva <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Expansion.20of.20ValueSet.20produced.20too.20many.20codes.html#233681070">(Apr 08 2021 at 16:06)</a>:</h4>
<p>Related question: how do you know when the expansion is complete?   Doe HAPI log something that indicated "expansion complete"?<br>
I tried running the <a href="https://github.com/hapifhir/hapi-fhir-jpaserver-starter#running-via-docker-hub">Docker HAPI server</a> and loaded a large CodeSystem and ValueSet that referenced it and I couldn't tell if the expansion ever completed or if the docker image just ran out of RAM or (image) disk space.   I could only determine that the codes I was expecting to be loaded were not there when I performed the .../$expand?filter search.</p>



<a name="233716848"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Expansion%20of%20ValueSet%20produced%20too%20many%20codes/near/233716848" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hanan Awwad <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Expansion.20of.20ValueSet.20produced.20too.20many.20codes.html#233716848">(Apr 08 2021 at 19:47)</a>:</h4>
<p><span class="user-mention" data-user-id="298707">@John Silva</span> , either you could check the status for vs in db it should be expanded or you could debug the job that implemented inside BaseTermReadSvcImpl class</p>



<a name="233723715"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Expansion%20of%20ValueSet%20produced%20too%20many%20codes/near/233723715" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Silva <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Expansion.20of.20ValueSet.20produced.20too.20many.20codes.html#233723715">(Apr 08 2021 at 20:34)</a>:</h4>
<p>Thanks.  I'm not familiar with HAPI enough to debug this and it's happening "inside" the Docker container so it's not easy for me to debug.  I was hoping that something is logged which I can see that indicates that the expansion completed (or not).    I'm running the docker container like this so the logs come right on standard output:</p>
<p><code>docker run -p 8080:8080  hapiproject/hapi</code></p>



<a name="233727079"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Expansion%20of%20ValueSet%20produced%20too%20many%20codes/near/233727079" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hanan Awwad <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Expansion.20of.20ValueSet.20produced.20too.20many.20codes.html#233727079">(Apr 08 2021 at 21:00)</a>:</h4>
<p><span class="user-mention" data-user-id="298707">@John Silva</span>  In case its running well, for sure you will see some logs from BaseTermReadSvcImpl  class like the following <br>
ourLog.info("Pre-expanded ValueSet[{}] with URL[{}] - Saved {} concepts in {}", valueSet.getId(), valueSet.getUrl(), accumulator.getConceptsSaved(), sw.toString());</p>



<a name="233824685"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Expansion%20of%20ValueSet%20produced%20too%20many%20codes/near/233824685" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jame Dang <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Expansion.20of.20ValueSet.20produced.20too.20many.20codes.html#233824685">(Apr 09 2021 at 13:55)</a>:</h4>
<p><span class="user-mention" data-user-id="298707">@John Silva</span> : I'm not really familiar with HAPI but  I think you can try the SpringBoot version (I tried it with starter project) which is easier to see the log and config the JVM</p>



<a name="233944883"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Expansion%20of%20ValueSet%20produced%20too%20many%20codes/near/233944883" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jame Dang <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Expansion.20of.20ValueSet.20produced.20too.20many.20codes.html#233944883">(Apr 10 2021 at 10:33)</a>:</h4>
<p><span class="user-mention" data-user-id="191319">@James Agnew</span> : I tried the HAPI client to search with 5.4.0 PRE5 and the response.getTotal() always return 0 if I put the offset parameter (without the offset it is OK)? Maybe this is a bug of the HAPI 5.4.0 PRE5 ? Thanks and regards</p>



<a name="233959713"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Expansion%20of%20ValueSet%20produced%20too%20many%20codes/near/233959713" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Expansion.20of.20ValueSet.20produced.20too.20many.20codes.html#233959713">(Apr 10 2021 at 14:33)</a>:</h4>
<p>Can you replicate this on <a href="http://hapi.fhir.org">hapi.fhir.org</a>?</p>



<a name="233974372"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Expansion%20of%20ValueSet%20produced%20too%20many%20codes/near/233974372" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jame Dang <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Expansion.20of.20ValueSet.20produced.20too.20many.20codes.html#233974372">(Apr 10 2021 at 17:57)</a>:</h4>
<p><span class="user-mention" data-user-id="191319">@James Agnew</span> : I have tried to connect to <a href="http://hapi.fhir.org">hapi.fhir.org</a> (<a href="http://hapi.fhir.org/baseR4">http://hapi.fhir.org/baseR4</a>), it has the same problem  and even I remove the offset parameter the total always return 0, in the 5.4.0 PRE5 if we remove the offset it is OK. I think the <a href="http://hapi.fhir.org">http://hapi.fhir.org</a> is older than than the  5.4.0 PRE5 (which I'm using for my server), you can see <a href="http://hapi.fhir.org/baseR4/Patient">http://hapi.fhir.org/baseR4/Patient</a> the total is not exist (so I think it has problem).</p>
<p>For my server (using  5.4.0 PRE5) when I tried the link : /Patient?_getpagesoffset=2&amp;_count=1 I it run OK and I can see the total.</p>
<p>But when I use the HAPI Client (see the code bellow) the result show me the link /Patient?_count=1&amp;_offset=1 (I think the java client convert wrong parameter ) </p>
<p>The code I used for testing:<br>
          FhirContext ctx = FhirContext.forR4();<br>
          serverBaseUrl="<a href="http://hapi.fhir.org/baseR4">http://hapi.fhir.org/baseR4</a>";<br>
          IGenericClient client = ctx.newRestfulGenericClient(serverBaseUrl);<br>
          // Build a search and execute it<br>
          Bundle response = client<br>
                  .search()<br>
                  .forResource(Patient.class)<br>
//                .count(10)<br>
//                .offset(1)<br>
                  .returnBundle(Bundle.class)<br>
                  .execute();<br>
          System.out.println("Number of Responses: " + response.getTotal());//Always 0</p>



<a name="233975219"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Expansion%20of%20ValueSet%20produced%20too%20many%20codes/near/233975219" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Expansion.20of.20ValueSet.20produced.20too.20many.20codes.html#233975219">(Apr 10 2021 at 18:11)</a>:</h4>
<p>I'm not sure I follow. That client code you quoted is for a Patient search,<br>
not a ValueSet expansion. The test server is not configured to support<br>
offset searching for resources.</p>



<a name="233975407"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Expansion%20of%20ValueSet%20produced%20too%20many%20codes/near/233975407" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jame Dang <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Expansion.20of.20ValueSet.20produced.20too.20many.20codes.html#233975407">(Apr 10 2021 at 18:15)</a>:</h4>
<p><span class="user-mention" data-user-id="191319">@James Agnew</span> : I got it, but can I report the problem of the search function some where? Maybe that is a problem (I'm not sure but maybe that is a bug, I will try to see the config for offset searching)</p>



<a name="233978199"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Expansion%20of%20ValueSet%20produced%20too%20many%20codes/near/233978199" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jame Dang <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Expansion.20of.20ValueSet.20produced.20too.20many.20codes.html#233978199">(Apr 10 2021 at 18:54)</a>:</h4>
<p><span class="user-mention" data-user-id="191319">@James Agnew</span> : Sorry for inconvenience, I tried to add the .totalMode(SearchTotalModeEnum.ACCURATE) to my search and the result is OK now (I got the total).  Thank you for your support</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
