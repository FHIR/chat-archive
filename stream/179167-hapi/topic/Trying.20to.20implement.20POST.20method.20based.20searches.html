---
layout: page
title: "FHIR Chat  · Trying to implement POST method based searches · hapi"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/index.html">hapi</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Trying.20to.20implement.20POST.20method.20based.20searches.html">Trying to implement POST method based searches</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="213084485"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Trying%20to%20implement%20POST%20method%20based%20searches/near/213084485" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Venton <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Trying.20to.20implement.20POST.20method.20based.20searches.html#213084485">(Oct 12 2020 at 20:42)</a>:</h4>
<p>According to FHIR, "Because of the way that some user agents and proxies treat GET and POST requests, in addition to the get based search method above, servers that support search SHALL also support a POST based search:"</p>
<p>My code accepts the GET method currently. But when I change the request to a POST, HAPI responds:<br>
'{<br>
  "resourceType": "OperationOutcome",<br>
  "issue": [<br>
    {<br>
      "severity": "error",<br>
      "code": "processing",<br>
      "diagnostics": "Invalid request: The FHIR endpoint on this server does not know how to handle POST operation[Observation] with parameters [[]]"<br>
    }<br>
  ]<br>
}'</p>
<p>What do I have to change in order to accept POST requests? Is it a configuration change or do I need another annotation (Java) on my method handler?</p>



<a name="213266329"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Trying%20to%20implement%20POST%20method%20based%20searches/near/213266329" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lin Zhang <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Trying.20to.20implement.20POST.20method.20based.20searches.html#213266329">(Oct 14 2020 at 09:49)</a>:</h4>
<p>It seems that we might have similiar questions.</p>



<a name="213333032"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Trying%20to%20implement%20POST%20method%20based%20searches/near/213333032" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian Bacher <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Trying.20to.20implement.20POST.20method.20based.20searches.html#213333032">(Oct 14 2020 at 18:32)</a>:</h4>
<p><span class="user-mention" data-user-id="335936">@Daniel Venton</span>  Are you doing something like this: <code>POST [base]/Observation</code>? Because it needs to be <code>POST [base]/Observation/_search</code>, i.e., the URL is different for GET vs POST.</p>



<a name="213338519"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Trying%20to%20implement%20POST%20method%20based%20searches/near/213338519" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Venton <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Trying.20to.20implement.20POST.20method.20based.20searches.html#213338519">(Oct 14 2020 at 19:19)</a>:</h4>
<p>Thanks much! That was the secret sauce I need to get POST to activate my code, but now why isn't my parameter being passed in?<br>
curl --location --request POST '<a href="http://localhost:8083/R4/Observation/_search">http://localhost:8083/R4/Observation/_search</a>' \<br>
--header 'Accept: application/fhir+json' \<br>
--header 'Authorization: Bearer **' \<br>
--header 'Content-Type: application/x-www-form-urlencoded' \<br>
--data-urlencode 'patient=ZZZZZZ'</p>
<div class="codehilite"><pre><span></span><code>@Search()
public Bundle searchByIdentifier(
        @OptionalParam(name = Observation.SP_PATIENT) TokenParam thePatient) {
</code></pre></div>


<p>When I get into my method the "thePatient" parameter is null.</p>



<a name="213429852"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Trying%20to%20implement%20POST%20method%20based%20searches/near/213429852" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian Bacher <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Trying.20to.20implement.20POST.20method.20based.20searches.html#213429852">(Oct 15 2020 at 14:03)</a>:</h4>
<p>The <code>patient</code> search parameter for Observation is supposed to be a <code>reference</code> rather than a <code>token</code> so the corresponding variable should be a <code>ReferenceParam</code> rather than a <code>TokenParam</code>. At least that'd be my guess.</p>



<a name="214085296"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Trying%20to%20implement%20POST%20method%20based%20searches/near/214085296" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Venton <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Trying.20to.20implement.20POST.20method.20based.20searches.html#214085296">(Oct 21 2020 at 17:25)</a>:</h4>
<p><span class="user-mention" data-user-id="191319">@James Agnew</span> Can you explain this to me? I'm looking at RestfulServer code, particularly the param processing portion starting at line 913 of v5.1.0. The 1st line says, must have a querystring.  but inside that if there is processing of the POST body params. Making the Restful server require AT LEAST one query string parameter in order to process POST body parameters. Should it not always (GET/POST) use any of query string parameters specified AND when the method is POST use values specified in the body? Meaning that a request can be processed where all of the params are in the body?</p>
<div class="codehilite"><pre><span></span><code>        if (isNotBlank(theRequest.getQueryString())) {
            completeUrl = requestUrl + &quot;?&quot; + theRequest.getQueryString();
            if (isIgnoreServerParsedRequestParameters()) {
                String contentType = theRequest.getHeader(Constants.HEADER_CONTENT_TYPE);
                if (theRequestType == RequestTypeEnum.POST &amp;&amp; isNotBlank(contentType) &amp;&amp; contentType.startsWith(Constants.CT_X_FORM_URLENCODED)) {
                    String requestBody = toUtf8String(requestDetails.loadRequestContents());
                    params = UrlUtil.parseQueryStrings(theRequest.getQueryString(), requestBody);
                } else if (theRequestType == RequestTypeEnum.GET) {
                    params = UrlUtil.parseQueryString(theRequest.getQueryString());
                }
            }
        } else {
            completeUrl = requestUrl.toString();
        }
</code></pre></div>



<a name="214091105"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Trying%20to%20implement%20POST%20method%20based%20searches/near/214091105" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Trying.20to.20implement.20POST.20method.20based.20searches.html#214091105">(Oct 21 2020 at 18:07)</a>:</h4>
<p><span class="user-mention" data-user-id="335936">@Daniel Venton</span> </p>
<p>You can definitely perform POST based searches with no URL based parameters in HAPI. No special coding is required, it should just work automatically.</p>
<p><code>theRequest.getQueryString()</code> should return null if no URL params are present, and HAPI handles that. We do still check in case someone is using both (which I have absolutely seen people do).</p>



<a name="214093880"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Trying%20to%20implement%20POST%20method%20based%20searches/near/214093880" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Venton <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Trying.20to.20implement.20POST.20method.20based.20searches.html#214093880">(Oct 21 2020 at 18:29)</a>:</h4>
<p>When I don't have any query string parameters specified then HAPI doesn't process the POST body parameters at all.</p>



<a name="214179344"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Trying%20to%20implement%20POST%20method%20based%20searches/near/214179344" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Trying.20to.20implement.20POST.20method.20based.20searches.html#214179344">(Oct 22 2020 at 12:29)</a>:</h4>
<p><span class="user-mention" data-user-id="335936">@Daniel Venton</span>  Hmm.. This test is verifying that exact scenario and is passing: <a href="https://github.com/jamesagnew/hapi-fhir/blob/master/hapi-fhir-structures-dstu3/src/test/java/ca/uhn/fhir/rest/server/SearchPostDstu3Test.java#L110">https://github.com/jamesagnew/hapi-fhir/blob/master/hapi-fhir-structures-dstu3/src/test/java/ca/uhn/fhir/rest/server/SearchPostDstu3Test.java#L110</a></p>
<p>Are you able to see any differerence between what it's doing and what you're doing? Could you attach a debugger to the method you quoted for each and see what is happening differently?</p>



<a name="214184795"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Trying%20to%20implement%20POST%20method%20based%20searches/near/214184795" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Venton <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Trying.20to.20implement.20POST.20method.20based.20searches.html#214184795">(Oct 22 2020 at 13:15)</a>:</h4>
<p>Ok, I've isolated the difference. This line of code which calls upon the httpServletRequet interface:<br>
                if (params == null) {<br>
                    params = new HashMap&lt;&gt;(theRequest.getParameterMap());<br>
                }<br>
In my apache environment that resolves (eventually) to:<br>
package org.apache.catalina.connector;<br>
public class Request implements HttpServletRequest { </p>
<p>Doesn't return any values. </p>
<p>HAPI unit test appears to resolve to: <br>
package org.eclipse.jetty.server;<br>
public class Request implements HttpServletRequest {</p>
<p>Which does return values.</p>
<p>Meaning that it isn't HAPI's fault, BUT it does provide a suggestion. Since HAPI is capable of decoding the POST body params itself, as illustrated by this line "params = UrlUtil.parseQueryStrings(theRequest.getQueryString(), requestBody);". Perhaps it would be better if HAPI always decoded the post body params instead of relying on other (apparently flawed) implementations. Next step for me will be to see about upgrading the internal tomcat server inside of IDEA IDE to see if it's resolved by apache. </p>
<p>For any other person having the same problem Adding an ignorable query string parameter will at least let you test "/Observation/_search?_fake". This instructs HAPI to decode the POST parameters itself and since it starts with an "_" HAPI doesn't require that parameter to exist in the method signature.</p>



<a name="214250695"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Trying%20to%20implement%20POST%20method%20based%20searches/near/214250695" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Trying.20to.20implement.20POST.20method.20based.20searches.html#214250695">(Oct 22 2020 at 21:30)</a>:</h4>
<p>TBH I'm not 100% sure I understand - But if this is something you could replicate in a unit test (even just with a mock HttpServletRequest object passed directly into SearchMethodBinding or whatever, we'd gladly accept a PR with a fix</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
