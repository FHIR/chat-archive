---
layout: page
title: "FHIR Chat  · isCodeSystemSupported · hapi"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/index.html">hapi</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/isCodeSystemSupported.html">isCodeSystemSupported</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="181032116"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/isCodeSystemSupported/near/181032116" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/isCodeSystemSupported.html#181032116">(Nov 18 2019 at 16:42)</a>:</h4>
<p>I have a class implementing IValidationSupport and have started to receive UUID's on the isCodeSystemSupported interface.</p>
<p>It's also failing to validate Codes, getting errors like:</p>
<p>The value provided ('official') is not in the value set <a href="https://fhir.hl7.org.uk/STU3/ValueSet/CareConnect-NameUse-1" target="_blank" title="https://fhir.hl7.org.uk/STU3/ValueSet/CareConnect-NameUse-1">https://fhir.hl7.org.uk/STU3/ValueSet/CareConnect-NameUse-1</a> (<a href="https://fhir.hl7.org.uk/STU3/ValueSet/CareConnect-NameUse-1" target="_blank" title="https://fhir.hl7.org.uk/STU3/ValueSet/CareConnect-NameUse-1">https://fhir.hl7.org.uk/STU3/ValueSet/CareConnect-NameUse-1</a>, and a code is required from this value set) (error message = Unknown code[official] in system[(none)])</p>
<p>Suspect these are related (will investigate further)</p>



<a name="181032196"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/isCodeSystemSupported/near/181032196" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/isCodeSystemSupported.html#181032196">(Nov 18 2019 at 16:43)</a>:</h4>
<p>believe this is also occurring on <br>
public &lt;T extends IBaseResource&gt; T<br>
    fetchResource(FhirContext theContext, Class&lt;T&gt; theClass, String theUri) {</p>



<a name="181032613"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/isCodeSystemSupported/near/181032613" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/isCodeSystemSupported.html#181032613">(Nov 18 2019 at 16:46)</a>:</h4>
<p>The GUID seems to be Constants.CODESYSTEM_VALIDATE_NOT_NEEDED</p>



<a name="181033068"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/isCodeSystemSupported/near/181033068" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/isCodeSystemSupported.html#181033068">(Nov 18 2019 at 16:51)</a>:</h4>
<p>On 4.1.0</p>



<a name="181036347"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/isCodeSystemSupported/near/181036347" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/isCodeSystemSupported.html#181036347">(Nov 18 2019 at 17:25)</a>:</h4>
<p>Yup, it would be that constant.</p>
<p>That GUID is used as a standin for the codesystem being validated when a field is being validated that doesn't have an explicit codeystem (i.e. a field that is of type <code>code</code> instead of <code>coding</code>). There will always be a VS URI in that case which scopes what the CS could be.</p>
<p>I don't know that I love the current design of that API- That GUID is confusing I would agree.</p>



<a name="181054685"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/isCodeSystemSupported/near/181054685" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Lawley <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/isCodeSystemSupported.html#181054685">(Nov 18 2019 at 20:55)</a>:</h4>
<p>I can say that <span class="user-mention" data-user-id="191376">@Jim Steel</span> and I really do not like these false system URIs - since the trigger for these is a code-typed field the system URI should be known and thus should be providable?</p>



<a name="181062043"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/isCodeSystemSupported/near/181062043" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/isCodeSystemSupported.html#181062043">(Nov 18 2019 at 22:11)</a>:</h4>
<p>What I believe is happening:</p>
<p>My isCodeSystemSupported is called and responds false (as CodeSystem = c73c77eb-f4b9-49ae-a5c9-6eb727811615)<br>
So the calling ValidationSupportChain class doesn't then call my validateCode<br>
(line 220 public CodeValidationResult validateCode in ValidationSupportChain</p>
<p>Does IsCodeSystemSupported need changing to also pass over the ValueSetUrl</p>



<a name="181085959"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/isCodeSystemSupported/near/181085959" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/isCodeSystemSupported.html#181085959">(Nov 19 2019 at 06:33)</a>:</h4>
<p>Think this is the issue. DefaultProfileValidation support is trying to Validate the Code but it doesn't understand the ValueSet.</p>
<p><a href="/user_uploads/10155/nzDI1I_C6CwTCDcMC75ggju1/Screenshot-2019-11-19-at-06.32.28.png" target="_blank" title="Screenshot-2019-11-19-at-06.32.28.png">Screenshot-2019-11-19-at-06.32.28.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/10155/nzDI1I_C6CwTCDcMC75ggju1/Screenshot-2019-11-19-at-06.32.28.png" target="_blank" title="Screenshot-2019-11-19-at-06.32.28.png"><img src="/user_uploads/10155/nzDI1I_C6CwTCDcMC75ggju1/Screenshot-2019-11-19-at-06.32.28.png"></a></div>



<a name="181086007"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/isCodeSystemSupported/near/181086007" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/isCodeSystemSupported.html#181086007">(Nov 19 2019 at 06:34)</a>:</h4>
<p>and so fails</p>



<a name="181086103"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/isCodeSystemSupported/near/181086103" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/isCodeSystemSupported.html#181086103">(Nov 19 2019 at 06:36)</a>:</h4>
<p>My IsSystemSupported fails because the UUID in the image above is passed in as the CodeSystem url</p>



<a name="181148501"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/isCodeSystemSupported/near/181148501" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/isCodeSystemSupported.html#181148501">(Nov 19 2019 at 19:58)</a>:</h4>
<blockquote>
<p>I can say that @Jim Steel and I really do not like these false system URIs - since the trigger for these is a code-typed field the system URI should be known and thus should be providable?</p>
</blockquote>
<p>Well, there is a bit of a chicken and egg thing. When the validator goes to validate <code>Patient.gender</code> all it knows is the code without a system, and the ValueSet that the code is bound to. Sure, the validator could figure out what the system is since there is a valueset binding, but it would have to expand the valueset to do that and then it's basically duplicating the term service's job.</p>
<p>FWIW: the UUID was a solution to a rather glaring bug in HAPI's validator: Prior to 4.1.0, you could omit the system entirely on a Coding field and it would validate correctly if the code was appropriate for the bound VS.</p>
<p>The intent with the UUID was to solve the problem of there being 3 possible states: Code+System provided, Code provided but no system because the field is a code, Code provided but system was left blank in the resource being validated.</p>
<p>Probably the right solution here is to either add a new overload to validateCode, or to create some kind of value type for the system that can distinguish between those 3 states...</p>



<a name="181151126"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/isCodeSystemSupported/near/181151126" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/isCodeSystemSupported.html#181151126">(Nov 19 2019 at 20:31)</a>:</h4>
<p>I beginning to think the problem I'm seeing is an error in UK Profiles and has come to light because of this change.</p>



<a name="181179556"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/isCodeSystemSupported/near/181179556" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/isCodeSystemSupported.html#181179556">(Nov 20 2019 at 04:44)</a>:</h4>
<p><span class="user-mention" data-user-id="191319">@James Agnew</span> I'll do that, and start using it.</p>



<a name="181901202"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/isCodeSystemSupported/near/181901202" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/isCodeSystemSupported.html#181901202">(Nov 26 2019 at 09:00)</a>:</h4>
<p>I think I've found what is causing my issue. In ValidationSupportChain line 213-221</p>
<div class="codehilite"><pre><span></span>        ```while(var6.hasNext()) {
            next = (IValidationSupport)var6.next();
            if (theCodeSystem != null &amp;&amp; next.isCodeSystemSupported(theCtx, theCodeSystem)) {
                result = next.validateCode(theCtx, theCodeSystem, theCode, theDisplay, theValueSetUrl);
                continue label23;
            }

            ourLog.debug(&quot;Chain item {} does not support code system {}&quot;, next, theCodeSystem);
        }```
</pre></div>


<p>The code checks to see if the CodeSystem is supported BUT doesn't check if the ValueSet is supported. <br>
So the validateCode function of the first validator in the chain will always be called.</p>



<a name="181914241"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/isCodeSystemSupported/near/181914241" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/isCodeSystemSupported.html#181914241">(Nov 26 2019 at 12:01)</a>:</h4>
<p>Have worked around this (and also worked the second problem <span class="user-mention" data-user-id="191319">@James Agnew</span> mentions).</p>



<a name="181917712"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/isCodeSystemSupported/near/181917712" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/isCodeSystemSupported.html#181917712">(Nov 26 2019 at 12:51)</a>:</h4>
<p><span class="user-mention" data-user-id="191687">@Kevin Mayfield</span>  Interesting... This hasn't been an issue for any "normal" JPA server since there is only one implementation that handles custom codesystems and valuesets (the main term svc). I can see why this logic wouldn't work though if you have anything more fancy.</p>
<p>How did you work around it? Do we need an <code>isValueSetSupported</code> method?</p>



<a name="181921405"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/isCodeSystemSupported/near/181921405" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/isCodeSystemSupported.html#181921405">(Nov 26 2019 at 13:38)</a>:</h4>
<p>It wasn't clean, I reordered my validation chain, moving DefaultProfileValidation support to last. (and then added core fhir support into my first validator). </p>
<p>I think ValidationSupportChain should only call a ValidationSupport class that supports the ValueSet.</p>



<a name="181921473"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/isCodeSystemSupported/near/181921473" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Mayfield <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/isCodeSystemSupported.html#181921473">(Nov 26 2019 at 13:40)</a>:</h4>
<p>I say I think - I've had to do some other workarounds with a number of UK profiles, codes and values. So I might have come to this incorrectly.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
