---
layout: page
title: "FHIR Chat  · Getting all contained resources from an instance · hapi"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/index.html">hapi</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Getting.20all.20contained.20resources.20from.20an.20instance.html">Getting all contained resources from an instance</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="223373947"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Getting%20all%20contained%20resources%20from%20an%20instance/near/223373947" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Morten Ernebjerg <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Getting.20all.20contained.20resources.20from.20an.20instance.html#223373947">(Jan 20 2021 at 13:48)</a>:</h4>
<p>Hi HAPI crowd <span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> I am using HAPI 5.2 (with R4) and have some business logic that requires me to get all contained resources in a given resource. However, I discovered that naive way of doing this - using <code>resource,getContained()</code> - does not always work.  Specifically,  if I construct an object X and refer to it in another resource Y using the <code>setResource()</code> method (see <a href="https://hapifhir.io/hapi-fhir/docs/model/references.html">this section of the HAPI docs</a> ), then Y serializes with X as a contained resource but <code>Y.getContained()</code> returns an empty array (code example below).</p>
<p>Is there some other generic way of retrieving all contained resources (i.e. everything pointed to by local <code>#id</code> references) in a given instance, without having to loop over each field of type <code>Reference</code>?</p>
<p>The code below illustrates the issue. It's Kotlin, so <code>obj.prop = x</code> and  <code>z = obj.prop</code> correspond to <code>obj.setProp(x)</code> and <code>z = obj.getProp()</code>, respectively in Java,.</p>
<div class="codehilite" data-code-language="Kotlin"><pre><span></span><code><span class="k">val</span> <span class="py">obs</span><span class="p">:</span> <span class="n">Observation</span> <span class="p">=</span> <span class="n">Observation</span><span class="p">()</span> <span class="c1">// New Observation instance</span>
 <span class="n">obs</span><span class="p">.</span><span class="n">status</span> <span class="p">=</span> <span class="n">Observation</span><span class="p">.</span><span class="n">ObservationStatus</span><span class="p">.</span><span class="n">FINAL</span>
 <span class="k">val</span> <span class="py">cc</span> <span class="p">=</span> <span class="n">CodeableConcept</span><span class="p">()</span>
 <span class="n">cc</span><span class="p">.</span><span class="n">addCoding</span><span class="p">().</span><span class="n">display</span> <span class="p">=</span> <span class="s">"Random"</span>
 <span class="k">val</span> <span class="py">pat</span> <span class="p">=</span> <span class="n">Patient</span><span class="p">()</span> <span class="c1">// New Patient object</span>
 <span class="c1">// Set the Patient resource as the target of the reference in the subject element</span>
 <span class="n">obs</span><span class="p">.</span><span class="n">subject</span><span class="p">.</span><span class="n">resource</span> <span class="p">=</span> <span class="n">pat</span>
 <span class="c1">// Serializes as Observation with a contained Patient</span>
 <span class="k">val</span> <span class="py">obsAsJson</span> <span class="p">=</span> <span class="n">FhirContext</span><span class="p">.</span><span class="n">forR4</span><span class="p">().</span><span class="n">newJsonParser</span><span class="p">().</span><span class="n">encodeResourceToString</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
<span class="c1">// ... but this array is empty</span>
 <span class="k">val</span> <span class="py">containedArray</span> <span class="p">=</span> <span class="n">obs</span><span class="p">.</span><span class="n">contained</span>
</code></pre></div>



<a name="223377835"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Getting%20all%20contained%20resources%20from%20an%20instance/near/223377835" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Venton <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Getting.20all.20contained.20resources.20from.20an.20instance.html#223377835">(Jan 20 2021 at 14:20)</a>:</h4>
<p>I translated your code to Java and got the patient contained resource.<br>
        Observation o = new Observation();<br>
        o.setStatus(Observation.ObservationStatus.FINAL);<br>
        CodeableConcept cc = new CodeableConcept();<br>
        cc.addCoding().setDisplay("Random");<br>
        Patient p = new Patient();<br>
        o.getSubject().setResource(p);<br>
        String json = FhirContext.forR4().newJsonParser().encodeResourceToString(o);</p>
<p>{"resourceType":"Observation","contained":[{"resourceType":"Patient","id":"1"}],"status":"final","subject":{"reference":"#1"}}</p>



<a name="223378055"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Getting%20all%20contained%20resources%20from%20an%20instance/near/223378055" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Morten Ernebjerg <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Getting.20all.20contained.20resources.20from.20an.20instance.html#223378055">(Jan 20 2021 at 14:22)</a>:</h4>
<p>Interesting, let me test again...</p>



<a name="223379072"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Getting%20all%20contained%20resources%20from%20an%20instance/near/223379072" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Morten Ernebjerg <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Getting.20all.20contained.20resources.20from.20an.20instance.html#223379072">(Jan 20 2021 at 14:29)</a>:</h4>
<p>Hm, still not working on my side. When I debug and inspect the object <code>obs</code>, it has the Patient information inside the <code>subject</code> property and the <code>contained</code> property is an empty array. Consequently, <code>obs.hasContained()</code> evaluates to <em>false</em>. So I was somehow assuming the information is only moved to <code>contained</code> upon serialization. <span class="user-mention" data-user-id="335936">@Daniel Venton</span> what does you object <code>o</code> look like (as a Java object) after construction, is the <code>contained</code> property also empty? (and thanks for looking at this, BTW!)</p>



<a name="223382079"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Getting%20all%20contained%20resources%20from%20an%20instance/near/223382079" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lin Zhang <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Getting.20all.20contained.20resources.20from.20an.20instance.html#223382079">(Jan 20 2021 at 14:50)</a>:</h4>
<p>O.subject is of type Reference. Is it relevant to this question?</p>



<a name="223386211"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Getting%20all%20contained%20resources%20from%20an%20instance/near/223386211" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Venton <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Getting.20all.20contained.20resources.20from.20an.20instance.html#223386211">(Jan 20 2021 at 15:12)</a>:</h4>
<p>o.contained is null after every step until the .encode, at which time it becomes a [0] length array.  I adjusted the code a bit. What appears to be happening is the observation you are building has "helpers" that help you get to a final state observation, but is not final until those helpers are exercised (serialization). The FHIR spec says subject is a reference, but HAPI allows you to put a resource in it (the HAPI helpers convert it to a contained resource later). However, it only appears to happen on serialization instead of on-the-fly. If you want your observation to be in a final state without the serialization step, then you'll have to generate the final state without relying on the helpers. subject.reference = "#1". <a href="http://p.id">p.id</a> = "1" o.contained addresource(p). Post serialization/deserialzation the contained list is populated. New code illustrates that. Note that ser/deser is a heavy(slow) operation so probably not a production solution. <span class="user-mention" data-user-id="191319">@James Agnew</span>  may know of a way to fire the "helpers" without calling the serialization.</p>
<div class="codehilite"><pre><span></span><code>    Observation build = new Observation();
    build.setStatus(Observation.ObservationStatus.FINAL);
    Patient p = new Patient();
    build.getSubject().setResource(p);
    IParser parser = FhirContext.forR4().newJsonParser();
    String json = FhirContext.forR4().newJsonParser().encodeResourceToString(build);
    Observation post = (Observation) parser.parseResource(json);
</code></pre></div>



<a name="223487992"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Getting%20all%20contained%20resources%20from%20an%20instance/near/223487992" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Morten Ernebjerg <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Getting.20all.20contained.20resources.20from.20an.20instance.html#223487992">(Jan 21 2021 at 09:58)</a>:</h4>
<p><span class="user-mention" data-user-id="335936">@Daniel Venton</span>  Thanks for the analysis! - that makes sense. Indeed, for me the key thing is that I can extract contained resources from objects constructed by deserialization (i.e. in your code, <code>post.getContained()</code> will be non-empty)  - and that does indeed work <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> . Nonetheless, I agree that it would be nice to have it work consistently, regardless of the object construction method - otherwise, it is hard to use in environments where one does not know the origin of objects. Perhaps it would be possible to lazily trigger the internal processing when the <code>contained</code> element is accessed?</p>



<a name="226151458"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Getting%20all%20contained%20resources%20from%20an%20instance/near/226151458" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Morten Ernebjerg <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Getting.20all.20contained.20resources.20from.20an.20instance.html#226151458">(Feb 12 2021 at 15:30)</a>:</h4>
<p><span class="user-mention" data-user-id="191319">@James Agnew</span> Would this ( <span aria-label="point up" class="emoji emoji-1f446" role="img" title="point up">:point_up:</span>  - make behavior of <code>getContained()</code> independent of object construction path) be worth a GitHub issue or am I misunderstanding smt.?</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
