---
layout: page
title: "FHIR Chat  · setting contained resources · hapi"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/index.html">hapi</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/setting.20contained.20resources.html">setting contained resources</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="217427629"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/setting%20contained%20resources/near/217427629" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Håkan MacLean <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/setting.20contained.20resources.html#217427629">(Nov 20 2020 at 16:50)</a>:</h4>
<p>Hi!<br>
During the java session today I asked why my contained resources did not appear when JSON serialising and got the answer that they have to be referenced properly with their ID to appear. Thanks for the help <span class="user-mention" data-user-id="191451">@Patrick Werner</span>  and <span class="user-mention" data-user-id="191319">@James Agnew</span> ! I tried doing this, but they still don't appear. Excerpt from my code:</p>
<div class="codehilite"><pre><span></span><code>var module1 = new ActivityDefinition()
    .setKind(ActivityDefinition.ActivityDefinitionKind.TASK)
    .setUrl(&quot;url/to/module1&quot;);
module1.setId(&quot;idForModue1&quot;);

var planDefinition = new PlanDefinition();

var module1action =
    new PlanDefinition.PlanDefinitionActionComponent()
        .setDescription(&quot;module1&quot;)
        .setDefinition(new UriType(module1.getId())); //using uri instead of canonical
planDefinition.addAction(module1action);

planDefinition.setContained(List.of(module1));
</code></pre></div>

<p>And this is my output, without any contained:<br>
{<br>
  "resourceType": "PlanDefinition",<br>
  "action": [ {<br>
    "description": "module1",<br>
    "definitionUri": "idForModue1"<br>
  } ]<br>
}</p>
<p>If this is described in the standard or the HAPI docs, please just refer me to the right place in the docs.</p>



<a name="217457249"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/setting%20contained%20resources/near/217457249" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Venton <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/setting.20contained.20resources.html#217457249">(Nov 20 2020 at 20:52)</a>:</h4>
<p>I have the same problem. I'm trying to include a Provenance Resource in the contained list. Procedure doesn't reference it, Provenance references the procedure. However, this is supposed to work. All items in the contained list must either reference the parent or be referenced by the parent. <br>
I'm using 5.1.0 of hapi. Here is a test that fails. a serialized bundle that has Procedure w/Provenance. When it is deserialized the Procedure object does have the Provenance, but when re-serialized it does not. Java:<br>
    private String serializedBundle = "{\n" +<br>
            "  \"resourceType\": \"Bundle\",\n" +<br>
            "  \"id\": \"401cc9a2-5f81-4806-8f33-fbf80e94bed3\",\n" +<br>
            "  \"meta\": {\n" +<br>
            "    \"lastUpdated\": \"2020-11-20T11:38:36.350-08:00\"\n" +<br>
            "  },\n" +<br>
            "  \"type\": \"searchset\",\n" +<br>
            "  \"total\": 1,\n" +<br>
            "  \"link\": [\n" +<br>
            "    {\n" +<br>
            "      \"relation\": \"self\",\n" +<br>
            "      \"url\": \"http://localhost:8083/R4/Procedure?_id=100&amp;_revinclude=Provenance%3Atarget\"\n" +<br>
            "    }\n" +<br>
            "  ],\n" +<br>
            "  \"entry\": [\n" +<br>
            "    {\n" +<br>
            "      \"fullUrl\": \"http://localhost:8083/R4/Procedure/100\",\n" +<br>
            "      \"resource\": {\n" +<br>
            "        \"resourceType\": \"Procedure\",\n" +<br>
            "        \"id\": \"100\",\n" +<br>
            "        \"meta\": {\n" +<br>
            "          \"lastUpdated\": \"2020-10-29T12:34:55.124Z\"\n" +<br>
            "        },\n" +<br>
            "        \"contained\": [\n" +<br>
            "          {\n" +<br>
            "            \"resourceType\": \"Practitioner\",\n" +<br>
            "            \"id\": \"2\",\n" +<br>
            "            \"identifier\": [\n" +<br>
            "              {\n" +<br>
            "                \"system\": \"http://hl7.org/fhir/sid/us-npi\",\n" +<br>
            "                \"value\": \"ctc123\"\n" +<br>
            "              }\n" +<br>
            "            ]\n" +<br>
            "          },\n" +<br>
            "          {\n" +<br>
            "            \"resourceType\": \"Provenance\",\n" +<br>
            "            \"id\": \"1\",\n" +<br>
            "            \"target\": [\n" +<br>
            "              {\n" +<br>
            "                \"reference\": \"Procedure/100\"\n" +<br>
            "              }\n" +<br>
            "            ],\n" +<br>
            "            \"recorded\": \"2020-10-29T12:34:55.124Z\",\n" +<br>
            "            \"agent\": [\n" +<br>
            "              {\n" +<br>
            "                \"type\": {\n" +<br>
            "                  \"coding\": [\n" +<br>
            "                    {\n" +<br>
            "                      \"system\": \"http://terminology.hl7.org/CodeSystem/provenance-participant-type\",\n" +<br>
            "                      \"code\": \"informant\",\n" +<br>
            "                      \"display\": \"informant\"\n" +<br>
            "                    }\n" +<br>
            "                  ]\n" +<br>
            "                },\n" +<br>
            "                \"who\": {\n" +<br>
            "                  \"reference\": \"#2\"\n" +<br>
            "                }\n" +<br>
            "              }\n" +<br>
            "            ]\n" +<br>
            "          }\n" +<br>
            "        ],\n" +<br>
            "        \"status\": \"unknown\",\n" +<br>
            "        \"code\": {\n" +<br>
            "          \"coding\": [\n" +<br>
            "            {\n" +<br>
            "              \"system\": \"http://terminology.lh7.org/CodeSystem/claim-type\",\n" +<br>
            "              \"code\": \"institutional\",\n" +<br>
            "              \"display\": \"Institutional Display\"\n" +<br>
            "            }\n" +<br>
            "          ]\n" +<br>
            "        },\n" +<br>
            "        \"subject\": {\n" +<br>
            "          \"reference\": \"Patient/551261670\"\n" +<br>
            "        },\n" +<br>
            "        \"performedDateTime\": \"2020-10-29T12:34:55.124Z\"\n" +<br>
            "      }\n" +<br>
            "    }\n" +<br>
            "  ]\n" +<br>
            "}\n";</p>
<div class="codehilite"><pre><span></span><code>@Test
public void testContainedProvenance() {
    FhirContext context = FhirContext.forR4();
    IParser parser = context.newJsonParser();

    Bundle b = (Bundle) parser.parseResource(serializedBundle);

    String s = parser.encodeResourceToString(b); //&lt;- this excludes the Provenance
}
</code></pre></div>



<a name="217458410"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/setting%20contained%20resources/near/217458410" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Venton <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/setting.20contained.20resources.html#217458410">(Nov 20 2020 at 21:04)</a>:</h4>
<p>Interesting enough, although I think conceptually wrong, if I set the provenance resource to target itself, then it is included in the output.<br>
            "            \"target\": [\n" +<br>
            "              {\n" +<br>
            "                \"reference\": \"#1\"\n" +<br>
            "              },\n" +<br>
            "              {\n" +<br>
            "                \"reference\": \"Procedure/100\"\n" +<br>
            "              }\n" +<br>
            "            ],\n" +</p>



<a name="217549826"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/setting%20contained%20resources/near/217549826" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/setting.20contained.20resources.html#217549826">(Nov 22 2020 at 12:46)</a>:</h4>
<p><span class="user-mention" data-user-id="364590">@Håkan MacLean</span> <br>
You are still mixing up canonical urls with urls. ActivityDefinition.url is a canonical url.</p>



<a name="217550468"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/setting%20contained%20resources/near/217550468" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/setting.20contained.20resources.html#217550468">(Nov 22 2020 at 13:05)</a>:</h4>
<p>But i tested it with Canonical as well, was not working.</p>



<a name="217550625"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/setting%20contained%20resources/near/217550625" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/setting.20contained.20resources.html#217550625">(Nov 22 2020 at 13:08)</a>:</h4>
<p>Possibly this is a bug, as canonicals were introduced after references.</p>



<a name="217550999"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/setting%20contained%20resources/near/217550999" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/setting.20contained.20resources.html#217550999">(Nov 22 2020 at 13:20)</a>:</h4>
<p><span class="user-mention" data-user-id="335936">@Daniel Venton</span> please format your code properly, it is very hard to read and help in this form.<br>
Just had a quick look. Provenance wants to reference to Procedure, this is done via the reference string: <code>#</code></p>



<a name="217551039"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/setting%20contained%20resources/near/217551039" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/setting.20contained.20resources.html#217551039">(Nov 22 2020 at 13:20)</a>:</h4>
<p>But even with <code>#</code>it isn't working.</p>



<a name="217551050"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/setting%20contained%20resources/near/217551050" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Werner <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/setting.20contained.20resources.html#217551050">(Nov 22 2020 at 13:20)</a>:</h4>
<blockquote>
<p>Resources can only be contained in other resources if there is a reference from the resource to the contained resource, or if the contained resource references the container resource. This is intended to ensure that the meaning of the contained resource is clear, and that there is no confusion as to its significance.<br>
For a resource that references the container, the reference is "#"</p>
</blockquote>
<p><a href="https://www.hl7.org/fhir/references.html#contained">https://www.hl7.org/fhir/references.html#contained</a></p>



<a name="217567973"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/setting%20contained%20resources/near/217567973" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Håkan MacLean <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/setting.20contained.20resources.html#217567973">(Nov 22 2020 at 20:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="191451">Patrick Werner</span> <a href="#narrow/stream/179167-hapi/topic/setting.20contained.20resources/near/217549826">said</a>:</p>
<blockquote>
<p>You are still mixing up canonical urls with urls. ActivityDefinition.url is a canonical url.</p>
</blockquote>
<p>Thank you for taking the time to look into this <span class="user-mention" data-user-id="191451">@Patrick Werner</span> , really appreciate it! However I'm still confused since I'm not actually using the ActivityDefintion.url for anything atm. <br>
Currently, I'm referencing the <a href="http://ActivityDefinition.id">ActivityDefinition.id</a> (not url!) from PlanDefinition.action.definition. I also tried adding a # before the id, but that made no difference. See code below:</p>
<div class="codehilite"><pre><span></span><code>var module1 = new ActivityDefinition()
    .setKind(ActivityDefinition.ActivityDefinitionKind.TASK);
module1.setId(&quot;idForModue1&quot;);

var planDefinition = new PlanDefinition();

var module1action =
    new PlanDefinition.PlanDefinitionActionComponent()
        .setDescription(&quot;module1&quot;)
        .setDefinition(new UriType(&quot;#&quot; + module1.getId()));
planDefinition.addAction(module1action);
planDefinition.setContained(List.of(module1))
</code></pre></div>

<p>And output:<br>
{<br>
  "resourceType": "PlanDefinition",<br>
  "action": [ {<br>
    "description": "module1",<br>
    "definitionUri": "#idForModue1"<br>
  } ]<br>
}</p>
<p>Is it perhaps so that PlanDefinition.action.definition does not "count" as a reference somehow?  I also recall you mentioned using the actual java object when creating a reference, but I never got that to work either. I tried:<br>
<code>.setDefinition(new Reference(module1))</code><br>
But then I get a runtime error since Reference is not of type CanonicalType or UriType. </p>
<p>Or if you know of a working example somewhere perhaps I could look at it and debug the HAPI source code do find out how I should do it.</p>



<a name="217630163"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/setting%20contained%20resources/near/217630163" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Venton <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/setting.20contained.20resources.html#217630163">(Nov 23 2020 at 13:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="191451">Patrick Werner</span> <a href="#narrow/stream/179167-hapi/topic/setting.20contained.20resources/near/217550999">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="335936">Daniel Venton</span> please format your code properly, it is very hard to read and help in this form.<br>
Just had a quick look. Provenance wants to reference to Procedure, this is done via the reference string: <code>#</code></p>
</blockquote>
<p>It was formatted correctly until zulip got ahold of it, perhaps there is a code markup that I'm unaware of.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
