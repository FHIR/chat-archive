---
layout: page
title: "FHIR Chat  · Search Parameters and Extensions · hapi"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/index.html">hapi</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Search.20Parameters.20and.20Extensions.html">Search Parameters and Extensions</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="166912370"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Search%20Parameters%20and%20Extensions/near/166912370" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saul Kravitz <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Search.20Parameters.20and.20Extensions.html#166912370">(May 30 2019 at 14:28)</a>:</h4>
<p>(Moving here from the Implementers stream...sorry for the duplication)<br>
Any insight into how I am misusing the SearchParameter would be greatly appreciated.</p>
<p>HAPI (I've tested 3.7 and 3.8) implements search parameter definitions.<br>
See <a href="http://hapi.fhir.org/baseR4/MedicationKnowledge?productType" target="_blank" title="http://hapi.fhir.org/baseR4/MedicationKnowledge?productType">http://hapi.fhir.org/baseR4/MedicationKnowledge?productType</a> for a search parameter that allows search against the MedicationKnowledge productType field.<br>
A sample query is:<br>
<a href="http://hapi.fhir.org/baseR4/MedicationKnowledge?productType=BRANDX" target="_blank" title="http://hapi.fhir.org/baseR4/MedicationKnowledge?productType=BRANDX">http://hapi.fhir.org/baseR4/MedicationKnowledge?productType=BRANDX</a></p>
<p>I'm trying to develop a SearchParameter that will allow me to search against data in extension fields.<br>
The extensions are valueBooleans.<br>
I have two MedicationInformation Objects, one with the extension data, one without: (see <a href="http://hapi.fhir.org/baseR4/MedicationKnowledge" target="_blank" title="http://hapi.fhir.org/baseR4/MedicationKnowledge">http://hapi.fhir.org/baseR4/MedicationKnowledge</a>)<br>
1) <a href="http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK1" target="_blank" title="http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK1">http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK1</a> -- has extensions<br>
2) <a href="http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK2" target="_blank" title="http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK2">http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK2</a></p>
<p>The quantityLimit extension looks like this:<br>
{<br>
"url": "<a href="https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-QuantityLimit-extension" target="_blank" title="https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-QuantityLimit-extension">https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-QuantityLimit-extension</a>",<br>
"valueBoolean": true<br>
}</p>
<p>I have defined a SearchParameter: <a href="http://hapi.fhir.org/baseR4/SearchParameter/quantityLimit" target="_blank" title="http://hapi.fhir.org/baseR4/SearchParameter/quantityLimit">http://hapi.fhir.org/baseR4/SearchParameter/quantityLimit</a><br>
{<br>
"resourceType": "SearchParameter",<br>
"id": "quantityLimit",<br>
"meta": {<br>
"versionId": "1",<br>
"lastUpdated": "2019-02-22T08:37:56.297+00:00"<br>
},<br>
"title": "quantityLimit",<br>
"status": "active",<br>
"code": "quantityLimit",<br>
"base": [<br>
"MedicationKnowledge"<br>
],<br>
"type": "string",<br>
"expression": "MedicationKnowledge.extension(\" <a href="https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-QuantityLimit-extension.valueBoolean" target="_blank" title="https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-QuantityLimit-extension.valueBoolean">https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-QuantityLimit-extension.valueBoolean</a> \")",<br>
"xpathUsage": "normal",<br>
"comparator": [<br>
"eq"<br>
],<br>
"search": {<br>
"mode": "match"<br>
}<br>
}</p>
<p>The SearchParameter is recognized by the server, but doesn't work (as intended).</p>
<p>Searching:<br>
1) <a href="http://hapi.fhir.org/baseR4/MedicationKnowledge?quantityLimit" target="_blank" title="http://hapi.fhir.org/baseR4/MedicationKnowledge?quantityLimit">http://hapi.fhir.org/baseR4/MedicationKnowledge?quantityLimit</a> - returns two MedicationKnowledge objects... only one object has the quantityLimit extension, so this should return only one object, right?<br>
2) http://hapi.fhir.org/baseR4/MedicationKnowledge?quantityLimit="true" returns zero objects, but should return one object, right?</p>



<a name="166983292"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Search%20Parameters%20and%20Extensions/near/166983292" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Search.20Parameters.20and.20Extensions.html#166983292">(May 31 2019 at 09:52)</a>:</h4>
<p>That path doesn't look correct to me...</p>
<div class="codehilite"><pre><span></span>MedicationKnowledge.extension(\&quot; https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-QuantityLimit-extension.valueBoolean \&quot;
</pre></div>


<p>I would have expected something like</p>
<div class="codehilite"><pre><span></span>MedicationKnowledge.extension(&#39;https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-QuantityLimit-extension&#39;).value
</pre></div>



<a name="167040126"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Search%20Parameters%20and%20Extensions/near/167040126" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saul Kravitz <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Search.20Parameters.20and.20Extensions.html#167040126">(May 31 2019 at 22:31)</a>:</h4>
<p>2nd try.   A colleague told me to test my FHIRPAth expressions in the fhirpath.js tool, so these expressions work on these resources on the command line.</p>
<p>See <a href="http://hapi.fhir.org/baseR4/SearchParameter/drugTier" target="_blank" title="http://hapi.fhir.org/baseR4/SearchParameter/drugTier">http://hapi.fhir.org/baseR4/SearchParameter/drugTier</a><br>
<a href="http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK1" target="_blank" title="http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK1">http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK1</a><br>
<a href="http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK2" target="_blank" title="http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK2">http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK2</a><br>
<a href="http://hapi.fhir.org/baseR4/MedicationKnowledge/cmsip9" target="_blank" title="http://hapi.fhir.org/baseR4/MedicationKnowledge/cmsip9">http://hapi.fhir.org/baseR4/MedicationKnowledge/cmsip9</a> </p>
<p>The expression has been tested on fhirpath:<br>
~/git/fhirpath.js/bin/fhirpath --expression "MedicationKnowledge.extension.where(url='https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-DrugTierID-extension').valueCodeableConcept.coding.code" --resourceFile FormularyDrugcmsip9.json <br>
fhirpath(MedicationKnowledge.extension.where(url='https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-DrugTierID-extension').valueCodeableConcept.coding.code) =&gt;<br>
[<br>
 "GENERIC"<br>
]</p>
<p>The drugTier Search Parameter takes the most verbose (and likely to be supported approach).</p>
<p>{<br>
    "resourceType": "SearchParameter",<br>
    "id": "drugTier",<br>
    "meta": {<br>
      "versionId": "1",<br>
      "lastUpdated": "2019-02-22T08:37:56.297+00:00"<br>
    },<br>
    "title": "drugTier",<br>
    "status": "active",<br>
    "code": "drugTier",<br>
    "base": [<br>
      "MedicationKnowledge"<br>
    ],<br>
    "type": "string",<br>
    "expression": "MedicationKnowledge.extension.where(url='https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-DrugTierID-extension').valueCodeableConcept.coding.code",<br>
    "comparator": [<br>
        "eq"<br>
      ],<br>
    "search": {<br>
        "mode": "exact"<br>
      }<br>
  }</p>
<p>The extensions look like this:<br>
{<br>
        "url": "<a href="https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-DrugTierID-extension" target="_blank" title="https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-DrugTierID-extension">https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-DrugTierID-extension</a>",<br>
        "valueCodeableConcept": {<br>
          "coding": [<br>
            {<br>
              "code": "GENERIC",<br>
              "system": "<a href="https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/CodeSystem/usdrugformulary-DrugTierCS" target="_blank" title="https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/CodeSystem/usdrugformulary-DrugTierCS">https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/CodeSystem/usdrugformulary-DrugTierCS</a>",<br>
              "display": "GENERIC"<br>
            }<br>
          ]<br>
        }<br>
      }</p>
<p>GET <a href="http://hapi.fhir.org/baseR4/MedicationKnowledge?drugTier=GENERIC" target="_blank" title="http://hapi.fhir.org/baseR4/MedicationKnowledge?drugTier=GENERIC">http://hapi.fhir.org/baseR4/MedicationKnowledge?drugTier=GENERIC</a>    returns nothing<br>
GET <a href="http://hapi.fhir.org/baseR4/MedicationKnowledge?drugTier" target="_blank" title="http://hapi.fhir.org/baseR4/MedicationKnowledge?drugTier">http://hapi.fhir.org/baseR4/MedicationKnowledge?drugTier</a>    returns all 3 MedicationKnowledge resources</p>
<p>Am I configuring the searchParameter wrong, or is this a big?</p>



<a name="167078018"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Search%20Parameters%20and%20Extensions/near/167078018" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Search.20Parameters.20and.20Extensions.html#167078018">(Jun 01 2019 at 15:59)</a>:</h4>
<p>I responded to <span class="user-mention" data-user-id="215604">@Saul Kravitz</span> offline, but will include my response here for completeness and to spark any additional conversation or thoughts (if anyone has some).</p>
<p>I’m not sure exactly what’s going on here, but here is something to try.  Usually code-based searches would use the “token” type and the expression need only resolve to the CodeableConcept.</p>
<p>So try this:</p>
<ul>
<li>Change “type” to <code>"token"</code></li>
<li>Change “expression” to <code>"MedicationKnowledge.extension.where(url='https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-DrugTierID-extension').valueCodeableConcept"</code></li>
</ul>
<p>In addition, looking at the R4 SearchParameter documentation, I don’t see “search.mode”.  Are you sure that isn’t supposed to be “modifier”?  So my last suggestion is:</p>
<ul>
<li>Replace <code>"search": { "mode": "exact" }</code> with <code>"modifier": [ "exact" ]</code></li>
</ul>



<a name="167095009"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Search%20Parameters%20and%20Extensions/near/167095009" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Search.20Parameters.20and.20Extensions.html#167095009">(Jun 01 2019 at 23:42)</a>:</h4>
<p>I'm 70% sure you need <code>.value</code> in the expression and not <code>.valueCodeableConcept</code></p>



<a name="167109280"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Search%20Parameters%20and%20Extensions/near/167109280" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Search.20Parameters.20and.20Extensions.html#167109280">(Jun 02 2019 at 07:09)</a>:</h4>
<p>y</p>



<a name="167141540"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Search%20Parameters%20and%20Extensions/near/167141540" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Search.20Parameters.20and.20Extensions.html#167141540">(Jun 02 2019 at 22:26)</a>:</h4>
<blockquote>
<p>I'm 70% sure you need .value in the expression and not .valueCodeableConcept</p>
</blockquote>
<p>Ah.  Right.  That's probably true.  In that case I guess it's worth noting that <a href="https://github.com/HL7/fhirpath.js" target="_blank" title="https://github.com/HL7/fhirpath.js">fhirpath.js</a> happily worked with <code>valueCodeableConcept</code>.</p>



<a name="167152564"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Search%20Parameters%20and%20Extensions/near/167152564" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saul Kravitz <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Search.20Parameters.20and.20Extensions.html#167152564">(Jun 03 2019 at 03:41)</a>:</h4>
<p>Made all of the suggested changes...still not working (<a href="http://hapi.fhir.org/baseR4/MedicationKnowledge?drugTier=BRAND" target="_blank" title="http://hapi.fhir.org/baseR4/MedicationKnowledge?drugTier=BRAND">http://hapi.fhir.org/baseR4/MedicationKnowledge?drugTier=BRAND</a> returns 0 results).</p>
<p>One oddity is that when I PUT:<br>
{<br>
    "resourceType": "SearchParameter",<br>
    "id": "drugTier",<br>
    "meta": {<br>
      "versionId": "1",<br>
      "lastUpdated": "2019-02-22T08:37:56.297+00:00"<br>
    },<br>
    "title": "drugTier",<br>
    "status": "active",<br>
    "code": "drugTier",<br>
    "base": [<br>
      "MedicationKnowledge"<br>
    ],<br>
    "type": "token",<br>
    "expression": "MedicationKnowledge.extension.where(url='https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-DrugTierID-extension').value",<br>
    "comparator": [<br>
        "eq"<br>
      ],<br>
    "modifier": {<br>
        mode:"exact"<br>
      }<br>
  }</p>
<p>The "modifier gets lost"... here is GET of the same resource:<br>
{<br>
    "resourceType": "SearchParameter",<br>
    "id": "drugTier",<br>
    "meta": {<br>
        "versionId": "12",<br>
        "lastUpdated": "2019-06-03T03:32:55.073+00:00"<br>
    },<br>
    "title": "drugTier",<br>
    "status": "active",<br>
    "code": "drugTier",<br>
    "base": [<br>
        "MedicationKnowledge"<br>
    ],<br>
    "type": "token",<br>
    "expression": "MedicationKnowledge.extension.where(url='https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-DrugTierID-extension').value",<br>
    "comparator": [<br>
        "eq"<br>
    ]<br>
}</p>



<a name="167182249"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Search%20Parameters%20and%20Extensions/near/167182249" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Search.20Parameters.20and.20Extensions.html#167182249">(Jun 03 2019 at 12:11)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="215604">@Saul Kravitz</span> -- I think <code>modifier</code> needs to be an array.  So:</p>
<div class="codehilite"><pre><span></span>&quot;modifier&quot;: [ &quot;exact&quot; ]
</pre></div>



<a name="167187157"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Search%20Parameters%20and%20Extensions/near/167187157" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Agnew <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Search.20Parameters.20and.20Extensions.html#167187157">(Jun 03 2019 at 13:08)</a>:</h4>
<p><span class="user-mention" data-user-id="215604">@Saul Kravitz</span> your search parameter appears to work for me:</p>
<p><a href="http://hapi.fhir.org/baseR4/MedicationKnowledge?drugTier=GENERIC" target="_blank" title="http://hapi.fhir.org/baseR4/MedicationKnowledge?drugTier=GENERIC">http://hapi.fhir.org/baseR4/MedicationKnowledge?drugTier=GENERIC</a></p>



<a name="167192199"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Search%20Parameters%20and%20Extensions/near/167192199" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saul Kravitz <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Search.20Parameters.20and.20Extensions.html#167192199">(Jun 03 2019 at 13:59)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="191319">@James Agnew</span> and <span class="user-mention" data-user-id="191469">@Chris Moesel</span></p>



<a name="167210133"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Search%20Parameters%20and%20Extensions/near/167210133" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Search.20Parameters.20and.20Extensions.html#167210133">(Jun 03 2019 at 17:02)</a>:</h4>
<blockquote>
<blockquote>
<p>I'm 70% sure you need .value in the expression and not .valueCodeableConcept</p>
</blockquote>
<p>Ah.  Right.  That's probably true.  In that case I guess it's worth noting that <a href="https://github.com/HL7/fhirpath.js" target="_blank" title="https://github.com/HL7/fhirpath.js">fhirpath.js</a> happily worked with <code>valueCodeableConcept</code>.</p>
</blockquote>
<p>Yes, that is a shortcoming of fhirpath.js-- it does not know about choice types (yet).  For some discussion on that, see <a href="#narrow/stream/179266-fhirpath/topic/Paths.20for.20choice.20types" title="#narrow/stream/179266-fhirpath/topic/Paths.20for.20choice.20types">https://chat.fhir.org/#narrow/stream/179266-fhirpath/topic/Paths.20for.20choice.20types</a>.</p>



<a name="167351543"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Search%20Parameters%20and%20Extensions/near/167351543" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nicola (RIO/SS) <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Search.20Parameters.20and.20Extensions.html#167351543">(Jun 05 2019 at 02:06)</a>:</h4>
<p>I do not think it should know about this until we fix FHIR json format :)</p>
<p>choice types can (or should) be serialized as <code> {value: {Quantity: ....}}</code> and this will eliminate all of these problems</p>



<a name="167373220"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Search%20Parameters%20and%20Extensions/near/167373220" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Search.20Parameters.20and.20Extensions.html#167373220">(Jun 05 2019 at 09:50)</a>:</h4>
<p>you have to be realistic - we will not be changing the json format.</p>



<a name="167373238"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179167-hapi/topic/Search%20Parameters%20and%20Extensions/near/167373238" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179167-hapi/topic/Search.20Parameters.20and.20Extensions.html#167373238">(Jun 05 2019 at 09:51)</a>:</h4>
<p>yes, you can define a second json format, but it will be voted down and no one will implement it</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
