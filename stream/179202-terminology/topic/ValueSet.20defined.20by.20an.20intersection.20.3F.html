---
layout: page
title: "FHIR Chat  · ValueSet defined by an intersection ? · terminology"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/index.html">terminology</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html">ValueSet defined by an intersection ?</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="275643096"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275643096" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mark Kramer <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275643096">(Mar 17 2022 at 12:18)</a>:</h4>
<p>(I think the answer to this is no, but I'll ask anyway)   Is there a way to define a value set as the intersection of two other value sets? Alternatively, and specifically for SNOMED, is there a way to use filter criteria (or any other clever tricks) to define a value set as those concepts that are  common descendants (is-a hierarchy) from two or more given parent concepts?</p>



<a name="275643712"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275643712" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Hausam <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275643712">(Mar 17 2022 at 12:24)</a>:</h4>
<p>Yes, there is.  ValueSet.compose.include.valueSet is 0..*, and the comments on compose.include state "If one or more value sets are listed, the codes must be in all the value sets." - i.e. the include is the intersection of the specified value sets.</p>



<a name="275647597"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275647597" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mark Kramer <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275647597">(Mar 17 2022 at 12:58)</a>:</h4>
<p>Rob, we have never used ValueSet.compose.include like that, and I don't think that is how FHIR interprets that element. For example, <a href="http://hl7.org/fhir/us/mcode/STU2/ValueSet-mcode-radiotherapy-technique-vs.html">mcode-radiotherapy-technique-vs</a> is a value set composed of value sets, which in turn are made up of other value sets. The expansion is the UNION of all the concepts from all those value sets.</p>



<a name="275647975"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275647975" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mark Kramer <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275647975">(Mar 17 2022 at 13:00)</a>:</h4>
<p>Looking on <a href="https://www.hl7.org/fhir/valueset-definitions.html#ValueSet.compose.include.valueSet">this page</a>, the definition of that element says "Selects the concepts found in this value set (based on its value set definition). This is an absolute URI that is a reference to ValueSet.url. <strong>If multiple value sets are specified this includes the union of the contents of all of the referenced value sets</strong>."</p>



<a name="275648684"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275648684" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mark Kramer <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275648684">(Mar 17 2022 at 13:04)</a>:</h4>
<p>Tracking this down, the definition changed between 4.6.0 and 4.0.1. "Union" changed to "intersection". That's a HUGE difference, and not NOT backwards compatible AT ALL. As a normative resource, that won't fly.</p>



<a name="275649114"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275649114" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Hausam <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275649114">(Mar 17 2022 at 13:07)</a>:</h4>
<p>Right.  Because that was a mistake in R4 (and earlier) documentation and wasn't the intent, and it's being being corrected in R5.  I think the Jira task is a technical correction - I can check that.</p>



<a name="275649517"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275649517" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mark Kramer <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275649517">(Mar 17 2022 at 13:10)</a>:</h4>
<p>Ouch, ouch, ouch, ouch. No matter what the intent, that is huge breaking change. I don't think the intersection is the right intent anyway, but that's not even the issue. The issue is whether this is a breaking change on a NORMATIVE resource (YES IT IS).</p>



<a name="275650792"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275650792" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275650792">(Mar 17 2022 at 13:20)</a>:</h4>
<p>If every existing non-ballot version of FHIR treats it as a union, and every existing FHIR tool treats it as a union, and every IG that has ever used it has it expanded as a union, then <em>why</em> change it?  What possible upside could justify all the breakage and confusion? It seems to me that we should treat it as the de-facto (or common-law) intent now -- and add in a different mechanism that supports the intersection intent.  I agree w/ <span class="user-mention" data-user-id="191447">@Mark Kramer</span> -- this is <em>for sure</em> a breaking change.</p>



<a name="275650836"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275650836" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Hausam <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275650836">(Mar 17 2022 at 13:20)</a>:</h4>
<p>This was addressed in <a href="http://jira.hl7.org/browse/FHIR-25179">FHIR#25179</a> (and that issue is a CR, rather than a TC).  I agree that the change is breaking - and that isn't expected to happen with a normative resource (at least unless the entire community has agreed to the change).  The issue doesn't include much detail of how this change was justified, but the key part related to that I think is:</p>
<blockquote>
<p>Update:10/27/19: Grahame has confirmed that the definition of compose.include.valueset appears to be erroneous, when it was moved under compose.include (previously it was under compose), _ the definition was supposed to be updated </p>
</blockquote>
<p>The key question, I guess, is what to do now?</p>



<a name="275651851"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275651851" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275651851">(Mar 17 2022 at 13:28)</a>:</h4>
<p>Ah.  I see.  <a href="https://www.hl7.org/fhir/valueset.html#compositions">Other parts of the spec</a> say it is an intersection -- so we have contradictory definitions in different normative parts of the spec.  Fun!</p>



<a name="275651953"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275651953" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Hausam <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275651953">(Mar 17 2022 at 13:29)</a>:</h4>
<p>Correct.</p>



<a name="275652904"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275652904" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Hausam <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275652904">(Mar 17 2022 at 13:36)</a>:</h4>
<p>On balance, I think the <a href="http://jira.hl7.org/browse/FHIR-25179">FHIR#25179</a> resolution is likely still going to be the best course to take.</p>



<a name="275653119"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275653119" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mark Kramer <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275653119">(Mar 17 2022 at 13:38)</a>:</h4>
<p>(deleted)</p>



<a name="275653232"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275653232" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275653232">(Mar 17 2022 at 13:39)</a>:</h4>
<p>I think the kicker, though, is that FHIR IG Publisher has not treated it this way at all.  For example, Mark's <a href="http://hl7.org/fhir/us/mcode/STU2/ValueSet-mcode-radiotherapy-technique-vs.html">mcode-radiotherapy-technique-vs</a> that he links above has a single include with multiple value sets.  Not only does the expansion contain the union of those sets, but even the <em>generated narrative</em> describes it that way:<br>
<a href="/user_uploads/10155/ayRvGc5HOfCZzVXTBS0jG4gv/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/10155/ayRvGc5HOfCZzVXTBS0jG4gv/image.png" title="image.png"><img src="/user_uploads/10155/ayRvGc5HOfCZzVXTBS0jG4gv/image.png"></a></div>



<a name="275653458"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275653458" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Hausam <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275653458">(Mar 17 2022 at 13:40)</a>:</h4>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span>?</p>



<a name="275653516"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275653516" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275653516">(Mar 17 2022 at 13:41)</a>:</h4>
<p>I think the intent of treating it as an intersection makes sense, but when the spec is at odds with itself, and the reference implementation tooling (which is <em>required</em> for all HL7 publications) has taken a side already (for many years now) -- it makes sense to normalize to the position that has been widely practiced and enforced by official tooling.</p>



<a name="275654338"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275654338" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Hausam <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275654338">(Mar 17 2022 at 13:46)</a>:</h4>
<p>Possibly.  But that still means that we would have to change the further <strong>normative</strong> guidance on 'include' that contradicts this and carve out 'valueSet' as a special case, which also eliminates the possibly (at least without further additions or changes) of defining value sets based on the intersection of other value sets - which is what <span class="user-mention" data-user-id="191447">@Mark Kramer</span> is requesting.  I don't think that's a very easy choice to make, either.</p>



<a name="275654603"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275654603" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275654603">(Mar 17 2022 at 13:48)</a>:</h4>
<p>non-breaking is to introduce a new word that does what you wanted intersection to do... thus leave intersection implemented as is 'commonly implemented today', which should be explained and warned against using.</p>



<a name="275655140"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275655140" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mark Kramer <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275655140">(Mar 17 2022 at 13:52)</a>:</h4>
<p>One correction on the above -- the example I cited actually has 2 includes, with 1 value set in each. So UNION is the correct, expected behavior for that example. My mistake, mucho apologies for any confusion!</p>



<a name="275656832"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275656832" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Hausam <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275656832">(Mar 17 2022 at 14:03)</a>:</h4>
<p>I have value sets defined in IPS which use 'valueSet' and 'filter' in a single include, and the Publisher and expansion behavior is intersection, as expected.  I will check further and see if I have any that use intersection of two (or more) value sets (I don't recall for sure whether I have that or not).</p>



<a name="275659664"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275659664" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275659664">(Mar 17 2022 at 14:21)</a>:</h4>
<p>I've just created a test project that has a ValueSet w/ one include and two value sets.  The IG Publisher expands it as a <strong>UNION</strong>.  The generated narrative is a bit more ambiguous, but the expansion is definitely as union (<em>not</em> an intersection).  So it does seem that the IG Publisher is following <em>union</em> semantics even for multiple value sets in a single compose.include.  Here's the test project if you want to try it yourself: <a href="/user_uploads/10155/_dkyV8e3uJsq4ZhQm8xPI2fm/ValueSetIncludesValueSets.zip">ValueSetIncludesValueSets.zip</a></p>



<a name="275660652"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275660652" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Lawley <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275660652">(Mar 17 2022 at 14:26)</a>:</h4>
<p>FWIW, Ontoserver has always (~7 years now) treated this as an intersection</p>



<a name="275662834"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275662834" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275662834">(Mar 17 2022 at 14:41)</a>:</h4>
<blockquote>
<p>So it does seem that the IG Publisher is following <em>union</em> semantics even for multiple value sets in a single compose.include.  Here's the test project</p>
</blockquote>
<p>Good to know! Another relevant point would be whether this is actually being relied upon by any real implementation guides. Of course there could be others we are not aware of, but as Mark pointed out above there are more straightforward ways to get unions, so it's not clear that IG developers would have stumbled into this particular trap.</p>



<a name="275665889"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275665889" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Moehrke <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275665889">(Mar 17 2022 at 15:00)</a>:</h4>
<p>It is not uncommon as an IG author to ... simply throw things at the wall and see if it looks like what you need... the number of people that fully understand the power of the whole ecosystem is small... we can't always wait for one of the few FHIR gods to bless what we want to do... so if the tooling produces what we want, we go with it.</p>



<a name="275668747"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275668747" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275668747">(Mar 17 2022 at 15:17)</a>:</h4>
<p>To Josh's point, someone could probably build a script to run through all the IGs in the registry (and CI), and find how many use this construct (single include w/ multiple value sets).  That would give us a better idea of the true impact such a change would have.</p>



<a name="275674507"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275674507" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275674507">(Mar 17 2022 at 15:49)</a>:</h4>
<p>My vote is that existing use weighs more than original intent</p>



<a name="275677941"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275677941" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275677941">(Mar 17 2022 at 16:04)</a>:</h4>
<blockquote>
<p>simply throw things at the wall and see if it looks like what you need</p>
</blockquote>
<p>100%. My intuition is that people throwing things at the wall would be unlikely to reach this particular dark corner, but as Chris says it's a question that could be answered with real data. It'd be neat to have an openly published (i.e., pre-scraped) DB of every FHIR resource from every public IG, to facilitate this kind of analysis.</p>



<a name="275703361"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275703361" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mark Kramer <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275703361">(Mar 17 2022 at 18:08)</a>:</h4>
<blockquote>
<p>It'd be neat to have an openly published (i.e., pre-scraped) DB of every FHIR resource from every public IG</p>
</blockquote>
<p><span class="user-mention" data-user-id="191315">@Josh Mandel</span> Holy grail, you say?  Oh, I have one of those.  See <a href="https://www.medrxiv.org/content/10.1101/2022.03.09.22272163v1">https://www.medrxiv.org/content/10.1101/2022.03.09.22272163v1</a>.  Let me do a bit of analysis and I can tell you the answer to that question...</p>



<a name="275706292"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275706292" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mark Kramer <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275706292">(Mar 17 2022 at 18:31)</a>:</h4>
<p>So the answer is <strong>4</strong> value sets use multiple value sets in a single include, out of <a href="https://www.medrxiv.org/content/10.1101/2022.03.09.22272163v1">125 IGs surveyed</a> that collectively contain 1124 value sets. They are:</p>
<ol>
<li><a href="http://fhir.infoway-inforoute.ca/io/psca/ValueSet/substanceandpharmaceuticalbiologicproductcode">http://fhir.infoway-inforoute.ca/io/psca/ValueSet/substanceandpharmaceuticalbiologicproductcode</a></li>
<li><a href="http://hl7.org/fhir/us/dental-data-exchange/ValueSet/dental-anatomy">http://hl7.org/fhir/us/dental-data-exchange/ValueSet/dental-anatomy</a></li>
<li><a href="http://hl7.org/fhir/us/qicore/ValueSet/qicore-negation-reason">http://hl7.org/fhir/us/qicore/ValueSet/qicore-negation-reason</a></li>
<li><a href="http://hl7.org/fhir/ca/baseline/ValueSet/vaccinecodes">http://hl7.org/fhir/ca/baseline/ValueSet/vaccinecodes</a></li>
</ol>
<p>Here is the spreadsheet containing the data:<br>
<a href="/user_uploads/10155/IzYkM83IC1VRhnuqV4mWKaWd/VALUE_SETS.xlsx">VALUE_SETS.xlsx</a><br>
I might be wrong, but it looks like all of these are intended to be unions.</p>



<a name="275711511"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275711511" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275711511">(Mar 17 2022 at 19:12)</a>:</h4>
<p>Fabulous on so many levels, thanks <span class="user-mention" data-user-id="191447">@Mark Kramer</span> for the analysis. Are the analysis scripts open source too? The ones leading to the figures/tables in your manuscript?</p>
<p><a href="/user_uploads/10155/rPldGAVUDFhuQDKoePRhmUy0/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/10155/rPldGAVUDFhuQDKoePRhmUy0/image.png" title="image.png"><img src="/user_uploads/10155/rPldGAVUDFhuQDKoePRhmUy0/image.png"></a></div>



<a name="275711797"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275711797" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275711797">(Mar 17 2022 at 19:14)</a>:</h4>
<p>Yeah, agree that all of your identified examples seem to intend union semantics.</p>



<a name="275711933"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275711933" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mark Kramer <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275711933">(Mar 17 2022 at 19:15)</a>:</h4>
<p>I haven't shared the notebooks (they are Python3). The code wasn't written for reuse, only for short-term tactical purposes. Certainly not in "library-ready" form.</p>



<a name="275719791"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275719791" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275719791">(Mar 17 2022 at 20:17)</a>:</h4>
<p>now that I'm awake... I don't see that the tools treat this as a union. So far as I can see, it's treated as an intersection</p>



<a name="275720601"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275720601" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mark Kramer <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275720601">(Mar 17 2022 at 20:23)</a>:</h4>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span>  Take a gander at this: <a href="http://hl7.org/fhir/us/qicore/STU4.1/ValueSet-qicore-negation-reason.html">http://hl7.org/fhir/us/qicore/STU4.1/ValueSet-qicore-negation-reason.html</a><br>
<a href="/user_uploads/10155/vFhlt7zcok6seguGryYf_fcn/image.png">image.png</a> <br>
The expansion is clearly a union.</p>
<div class="message_inline_image"><a href="/user_uploads/10155/vFhlt7zcok6seguGryYf_fcn/image.png" title="image.png"><img src="/user_uploads/10155/vFhlt7zcok6seguGryYf_fcn/image.png"></a></div>



<a name="275723952"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275723952" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275723952">(Mar 17 2022 at 20:46)</a>:</h4>
<p>oh dear.</p>



<a name="275724051"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275724051" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275724051">(Mar 17 2022 at 20:47)</a>:</h4>
<p>just like the specification is contradictory, so is the code.</p>



<a name="275724098"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275724098" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275724098">(Mar 17 2022 at 20:47)</a>:</h4>
<p>when importing a value set, the code performs both a union and an intersection, in different places in the code.</p>



<a name="275724184"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275724184" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275724184">(Mar 17 2022 at 20:48)</a>:</h4>
<p>I missed the union bit happening when I looked at the code. And the intersection bit is quite redundant when it happens after the union happens</p>



<a name="275726204"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275726204" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275726204">(Mar 17 2022 at 21:00)</a>:</h4>
<p>but this is worse. <a href="http://tx.fhir.org">tx.fhir.org</a> does not do this, only the validator does for internal simple value sets.</p>



<a name="275737419"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275737419" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Lawley <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275737419">(Mar 17 2022 at 22:37)</a>:</h4>
<p><span class="user-mention" data-user-id="191447">@Mark Kramer</span> does your analysis also look at (single) valueset + filter or (single) valueset + concepts ?<br>
Four valuesets from 1124 needing a technical correction does not seem too much of a problem?</p>



<a name="275743519"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275743519" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mark Kramer <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275743519">(Mar 17 2022 at 23:46)</a>:</h4>
<p>I could look at that, but I did not. I only looked at multiple value sets because that was the question on the table. However, the spreadsheet attached above has all the necessary data if you want to see for yourself.</p>



<a name="275744063"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275744063" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mark Kramer <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275744063">(Mar 17 2022 at 23:53)</a>:</h4>
<p>Fortunately it looks like the demand for value set intersections, up until now, has been vanishingly small. Correcting those few cases where the intent was union but the implementation was faulty will not cause much damage.  This whole thread started because I have a case where intersections are necessary, and as a result of today’s discussion, it looks like we can clarify the spec, fix the tooling, and get the job done.</p>



<a name="275744199"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275744199" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mark Kramer <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275744199">(Mar 17 2022 at 23:55)</a>:</h4>
<p>My panic about massive breakage was overblown. I apologize about that.</p>



<a name="275750650"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275750650" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275750650">(Mar 18 2022 at 01:37)</a>:</h4>
<p>ok. So I've fixed the code. But given that the valueSets that <span class="user-mention" data-user-id="191447">@Mark Kramer</span> has identified (and thanks very much for doing excellent legwork) are published and in production, and I found at least one more value set like that that's not public, it's not very simple to 'correct' them.</p>
<p>So what I've done is that when I'm processing value sets, I check the publication date. if the publication date is prior to the end of this month, the legacy rules apply. But for anything published from now on, the correct processing rules per the <a href="http://jira.hl7.org/browse/FHIR-25179">FHIR#25179</a> task apply. <br>
(For other toolsmiths (<span class="user-mention" data-user-id="191328">@Ewout Kramer</span> FYI), I use the package date in the npm package to decide this. Core packages don't have dates; I looked them up from here: <a href="http://hl7.org/fhir/directory.html">http://hl7.org/fhir/directory.html</a>)</p>
<p>In addition, anytime the validator sees a value set, it creates this warning:</p>
<p><a href="/user_uploads/10155/1hymBBolP3t-1wh1Hdq-fJPr/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/10155/1hymBBolP3t-1wh1Hdq-fJPr/image.png" title="image.png"><img src="/user_uploads/10155/1hymBBolP3t-1wh1Hdq-fJPr/image.png"></a></div>



<a name="275751394"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275751394" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Lawley <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275751394">(Mar 18 2022 at 01:52)</a>:</h4>
<p>Do these "legacy rules" only apply in the context of the IG publisher?  We have people relying on the intersection semantics today; we need to avoid breaking things for them.</p>



<a name="275752231"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275752231" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Hausam <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275752231">(Mar 18 2022 at 02:07)</a>:</h4>
<p>I expect (and hope) that it will be limited to the IG Publisher context.</p>



<a name="275752524"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275752524" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elliot Silver <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275752524">(Mar 18 2022 at 02:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="191447">Mark Kramer</span> <a href="#narrow/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F/near/275706292">said</a>:</p>
<blockquote>
<ol>
<li><a href="http://fhir.infoway-inforoute.ca/io/psca/ValueSet/substanceandpharmaceuticalbiologicproductcode">http://fhir.infoway-inforoute.ca/io/psca/ValueSet/substanceandpharmaceuticalbiologicproductcode</a></li>
</ol>
</blockquote>
<p><span class="user-mention silent" data-user-id="191316">Grahame Grieve</span> <a href="#narrow/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F/near/275750650">said</a>:</p>
<blockquote>
<p>But given that the valueSets that <span class="user-mention silent" data-user-id="191447">Mark Kramer</span> has identified (and thanks very much for doing excellent legwork) are published and in production.</p>
</blockquote>
<p>That valueset is currently in public comment. We can update if needed. </p>
<p>(On a related note, I recall running into an issue where  we were defining a valueset A that included some specific concepts directly, and excluded valueset B which contained several of them. I can't remember if we were hoping for the include to override the exclude or vice versa, but found the result was the opposite of our expectations. If we defined valueset C that included the concepts, and then defined valueset A to include C and exclude B, the result differed.)</p>
<p>(<span class="user-mention" data-user-id="222582">@Sheridan Cook</span> )</p>



<a name="275752591"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275752591" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275752591">(Mar 18 2022 at 02:14)</a>:</h4>
<p>yes they apply in that context</p>



<a name="275752605"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275752605" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275752605">(Mar 18 2022 at 02:14)</a>:</h4>
<p><span class="user-mention" data-user-id="191380">@Elliot Silver</span> test cases are welcome for this part of the value set space</p>



<a name="275752688"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275752688" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elliot Silver <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275752688">(Mar 18 2022 at 02:16)</a>:</h4>
<p>Sure. Let me see if I can find or recreate the issue.</p>



<a name="275803185"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/275803185" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mark Kramer <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#275803185">(Mar 18 2022 at 13:38)</a>:</h4>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span> Thank you for the timely and clever fix. In the warning message, would it be possible to point out the difference between multiple value sets in one include, versus multiple includes with single value sets?</p>



<a name="277081483"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179202-terminology/topic/ValueSet%20defined%20by%20an%20intersection%20%3F/near/277081483" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179202-terminology/topic/ValueSet.20defined.20by.20an.20intersection.20.3F.html#277081483">(Mar 30 2022 at 00:32)</a>:</h4>
<p>ok</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
