---
layout: page
title: "FHIR Chat  · pascal code for signing resources using openSSL · australia"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179173-australia/index.html">australia</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179173-australia/topic/pascal.20code.20for.20signing.20resources.20using.20openSSL.html">pascal code for signing resources using openSSL</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="262526218"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179173-australia/topic/pascal%20code%20for%20signing%20resources%20using%20openSSL/near/262526218" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179173-australia/topic/pascal.20code.20for.20signing.20resources.20using.20openSSL.html#262526218">(Nov 23 2021 at 22:58)</a>:</h4>
<div class="codehilite" data-code-language="Delphi"><pre><span></span><code><span class="k">class</span> <span class="k">function</span> <span class="nc">TJWTUtils</span><span class="o">.</span><span class="nf">Sign_ES256</span><span class="p">(</span><span class="n">input</span><span class="o">:</span> <span class="n">TBytes</span><span class="o">;</span> <span class="n">key</span><span class="o">:</span> <span class="n">TJWK</span><span class="p">)</span><span class="o">:</span> <span class="n">TBytes</span><span class="o">;</span>
<span class="k">var</span>
  <span class="n">ctx</span> <span class="o">:</span> <span class="n">PEVP_MD_CTX</span><span class="o">;</span>
  <span class="n">keysize</span> <span class="o">:</span> <span class="kt">integer</span><span class="o">;</span>
  <span class="n">len</span><span class="o">,</span> <span class="n">l</span> <span class="o">:</span> <span class="kt">Cardinal</span><span class="o">;</span>
  <span class="n">p</span> <span class="o">:</span> <span class="n">System</span><span class="o">.</span><span class="kt">PByte</span><span class="o">;</span>
  <span class="n">pkey</span><span class="o">:</span> <span class="n">PEVP_PKEY</span><span class="o">;</span>
  <span class="n">PkeyCtx</span><span class="o">:</span> <span class="n">PEVP_PKEY_CTX</span><span class="o">;</span>
  <span class="n">rkey</span><span class="o">:</span> <span class="n">PEC_KEY</span><span class="o">;</span>
  <span class="n">keys</span> <span class="o">:</span> <span class="n">TJWKList</span><span class="o">;</span>
  <span class="n">keytype</span> <span class="o">:</span> <span class="kt">integer</span><span class="o">;</span>
  <span class="cm">{$IFDEF ALT}</span>
  <span class="n">Signature</span><span class="o">:</span> <span class="k">array</span> <span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="mi">8000</span><span class="p">]</span> <span class="k">of</span> <span class="kt">byte</span><span class="o">;</span>
  <span class="cm">{$ENDIF}</span>
<span class="k">begin</span>
  <span class="n">check</span><span class="p">(</span><span class="n">key</span> <span class="o">&lt;&gt;</span> <span class="k">nil</span><span class="o">,</span> <span class="s">'A key must be provided for ES256'</span><span class="p">)</span><span class="o">;</span>
  <span class="n">len</span> <span class="o">:=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="o">@</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">;</span>
  <span class="n">l</span> <span class="o">:=</span> <span class="nb">length</span><span class="p">(</span><span class="n">input</span><span class="p">)</span><span class="o">;</span>
  <span class="cm">{$IFDEF ALT}</span>
  <span class="k">for</span> <span class="n">keysize</span> <span class="o">:=</span> <span class="mi">0</span> <span class="k">to</span> <span class="mi">8000</span> <span class="k">do</span>
    <span class="n">Signature</span><span class="p">[</span><span class="n">keysize</span><span class="p">]</span> <span class="o">:=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="cm">{$ENDIF}</span>

  <span class="c1">// 1. Load the RSA private Key from FKey</span>
  <span class="n">rkey</span> <span class="o">:=</span> <span class="n">key</span><span class="o">.</span><span class="n">LoadEC</span><span class="p">(</span><span class="k">true</span><span class="p">)</span><span class="o">;</span>
  <span class="k">try</span>
    <span class="n">pkey</span> <span class="o">:=</span> <span class="n">EVP_PKEY_new</span><span class="o">;</span>
    <span class="k">try</span>
      <span class="n">check</span><span class="p">(</span><span class="n">EVP_PKEY_set1_EC_KEY</span><span class="p">(</span><span class="n">pkey</span><span class="o">,</span> <span class="n">rkey</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="s">'openSSL EVP_PKEY_set1_RSA failed'</span><span class="p">)</span><span class="o">;</span>

      <span class="c1">// 2. do the signing</span>
      <span class="n">keysize</span> <span class="o">:=</span> <span class="n">EVP_PKEY_size</span><span class="p">(</span><span class="n">pkey</span><span class="p">)</span><span class="o">;</span>
      <span class="nb">SetLength</span><span class="p">(</span><span class="bp">result</span><span class="o">,</span> <span class="n">keysize</span><span class="p">)</span><span class="o">;</span>
      <span class="n">ctx</span> <span class="o">:=</span> <span class="n">EVP_MD_CTX_new</span><span class="o">;</span>
      <span class="k">try</span>
        <span class="n">check</span><span class="p">(</span><span class="n">EVP_DigestSignInit</span><span class="p">(</span><span class="n">ctx</span><span class="o">,</span> <span class="o">@</span><span class="n">PkeyCtx</span><span class="o">,</span> <span class="n">EVP_sha256</span><span class="o">,</span> <span class="k">nil</span><span class="o">,</span> <span class="n">pKey</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="s">'openSSL EVP_DigestInit_ex failed'</span><span class="p">)</span><span class="o">;</span>
  <span class="cm">{$IFNDEF ALT}</span>
        <span class="n">check</span><span class="p">(</span><span class="n">EVP_DigestUpdate</span><span class="p">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">p</span><span class="o">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="s">'openSSL EVP_DigestUpdate failed'</span><span class="p">)</span><span class="o">;</span>
        <span class="n">check</span><span class="p">(</span><span class="n">EVP_DigestSignFinal</span><span class="p">(</span><span class="n">ctx</span><span class="o">,</span> <span class="o">@</span><span class="bp">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">,</span> <span class="o">@</span><span class="n">len</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="s">'openSSL EVP_DigestSignFinal failed'</span><span class="p">)</span><span class="o">;</span>
  <span class="cm">{$ELSE}</span>
        <span class="n">check</span><span class="p">(</span><span class="n">EVP_DigestSign</span><span class="p">(</span><span class="n">ctx</span><span class="o">,</span> <span class="o">@</span><span class="bp">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">,</span> <span class="o">@</span><span class="n">len</span><span class="o">,</span> <span class="n">p</span><span class="o">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="s">'openSSL EVP_DigestSign failed'</span><span class="p">)</span><span class="o">;</span>
  <span class="cm">{$ENDIF}</span>
        <span class="nb">SetLength</span><span class="p">(</span><span class="bp">result</span><span class="o">,</span> <span class="n">len</span><span class="p">)</span><span class="o">;</span>
      <span class="k">finally</span>
        <span class="n">EVP_MD_CTX_free</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span><span class="o">;</span>
      <span class="k">end</span><span class="o">;</span>
      <span class="bp">result</span> <span class="o">:=</span> <span class="n">DERTobase</span><span class="p">(</span><span class="bp">result</span><span class="p">)</span><span class="o">;</span>
    <span class="k">finally</span>
      <span class="n">EVP_PKEY_free</span><span class="p">(</span><span class="n">pKey</span><span class="p">)</span><span class="o">;</span>
    <span class="k">end</span><span class="o">;</span>
  <span class="k">finally</span>
    <span class="n">EC_KEY_free</span><span class="p">(</span><span class="n">rkey</span><span class="p">)</span><span class="o">;</span>
  <span class="k">end</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>
</code></pre></div>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
