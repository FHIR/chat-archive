---
layout: page
title: "FHIR Chat  · Where does the $this come from? · fhirpath"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/index.html">fhirpath</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Where.20does.20the.20.24this.20come.20from.3F.html">Where does the $this come from?</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="267366502"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Where%20does%20the%20%24this%20come%20from%3F/near/267366502" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tilo Christ <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Where.20does.20the.20.24this.20come.20from.3F.html#267366502">(Jan 09 2022 at 16:54)</a>:</h4>
<p>I am trying to figure out the proper execution of this test case <code>Patient.name.first().subsetOf($this.name)</code>. In this expression, what is populating $this? The fact that its name is accessed seems to suggest that the entire patient should be in $this, but I cannot find any documentation that would suggest that $this = %context?</p>



<a name="267379556"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Where%20does%20the%20%24this%20come%20from%3F/near/267379556" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Where.20does.20the.20.24this.20come.20from.3F.html#267379556">(Jan 09 2022 at 21:51)</a>:</h4>
<p>$this is definitely not %context</p>



<a name="267379610"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Where%20does%20the%20%24this%20come%20from%3F/near/267379610" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Where.20does.20the.20.24this.20come.20from.3F.html#267379610">(Jan 09 2022 at 21:52)</a>:</h4>
<p>My understanding is that it should be the name value, but I'll take a closer look.</p>



<a name="267379636"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Where%20does%20the%20%24this%20come%20from%3F/near/267379636" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Where.20does.20the.20.24this.20come.20from.3F.html#267379636">(Jan 09 2022 at 21:53)</a>:</h4>
<p>(I.e. I don't understand what it's doing here or if it's valid)</p>



<a name="267380454"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Where%20does%20the%20%24this%20come%20from%3F/near/267380454" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Where.20does.20the.20.24this.20come.20from.3F.html#267380454">(Jan 09 2022 at 22:12)</a>:</h4>
<p>I think it's invalid.</p>



<a name="267380483"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Where%20does%20the%20%24this%20come%20from%3F/near/267380483" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Where.20does.20the.20.24this.20come.20from.3F.html#267380483">(Jan 09 2022 at 22:13)</a>:</h4>
<p>As $this represents a currently processing item in the evaluation of a function that takes an expression. Which in this case would be the name is the value, not the patient.</p>



<a name="267380618"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Where%20does%20the%20%24this%20come%20from%3F/near/267380618" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Where.20does.20the.20.24this.20come.20from.3F.html#267380618">(Jan 09 2022 at 22:16)</a>:</h4>
<p>%context is the start point for the entire evaluation, also note in the fhir spec the %resource and %root Resource which are also closely related.</p>



<a name="267380651"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Where%20does%20the%20%24this%20come%20from%3F/near/267380651" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Where.20does.20the.20.24this.20come.20from.3F.html#267380651">(Jan 09 2022 at 22:18)</a>:</h4>
<p><a href="/user_uploads/10155/vefS9RSiC7YMs2Wfp1tmpVy9/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/10155/vefS9RSiC7YMs2Wfp1tmpVy9/image.png" title="image.png"><img src="/user_uploads/10155/vefS9RSiC7YMs2Wfp1tmpVy9/image.png"></a></div>



<a name="267381321"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Where%20does%20the%20%24this%20come%20from%3F/near/267381321" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tilo Christ <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Where.20does.20the.20.24this.20come.20from.3F.html#267381321">(Jan 09 2022 at 22:35)</a>:</h4>
<p>thanks, maybe I expressed myself a bit unclear. I am aware that %context and $this are two different things. I am using $this in expressions of aggregator and .where and understand how it holds the currently iterated item. For this subsetOf example (again taken from the FHIRPath test suite) I don't understand what it should be populated with and because of which part of the spec. Since the author of the test is trying to access a .name property on it, I think it must somehow be the patient, but I don't get what would make the patient go into $this. In the fhirpath.js this test passes. When I rewrite it to Patient.name.first().subsetOf(%context.name) it will also pass.</p>



<a name="267386312"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Where%20does%20the%20%24this%20come%20from%3F/near/267386312" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Where.20does.20the.20.24this.20come.20from.3F.html#267386312">(Jan 10 2022 at 00:41)</a>:</h4>
<p>Maybe it's accidentally passing as comes out with an empty set or something.</p>



<a name="267758257"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Where%20does%20the%20%24this%20come%20from%3F/near/267758257" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tilo Christ <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Where.20does.20the.20.24this.20come.20from.3F.html#267758257">(Jan 12 2022 at 17:31)</a>:</h4>
<p>I'm still trying to get a full understanding of the proper application of $this. If I have the expression <code>(0|1).iif($this = 0, $index, false)</code>, what should be the proper way to think about this? Should <code>$this</code> be unpopulated, because <code>iif</code> is not designed to iterate over an input collection? Or should <code>iif</code> be executed 2 times, each time providing a single item (0, and 1) in $this, and the corresponding index in $index? Or put (0|1) into $this and set $index to 0? I'm trying to find the answer from reading the spec and not just by executing fhirpath.js and then doing whatever it does, without understanding why (fhirpath.js puts [0, 1] into $this, and empty collection into $index).</p>



<a name="268047816"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Where%20does%20the%20%24this%20come%20from%3F/near/268047816" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tilo Christ <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Where.20does.20the.20.24this.20come.20from.3F.html#268047816">(Jan 14 2022 at 17:47)</a>:</h4>
<p>Sorry, still trying to get any input on the proper handling of $this. I have thus far tried several implementations of FHIRPath, they all behave different, and I'm really unclear how to read the spec. When I do something like <code>Patient.name.iif(true, $this, 0)</code>, I have seen the following behaviours:</p>
<ul>
<li>engine signals error</li>
<li>engine puts a list of the names into $this</li>
<li>engine puts the entire patient resource into $this</li>
</ul>
<p>The FHIRPath test suite contains tests which imply that the last option (entire patient) is the right one, but I have only seen this behaviour on the HAPI FHIRPath engine, and cannot find something about this in the spec.</p>



<a name="268071372"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Where%20does%20the%20%24this%20come%20from%3F/near/268071372" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Where.20does.20the.20.24this.20come.20from.3F.html#268071372">(Jan 14 2022 at 20:54)</a>:</h4>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span> <span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> <span class="user-mention" data-user-id="195344">@Paul Lynch</span></p>



<a name="268086829"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Where%20does%20the%20%24this%20come%20from%3F/near/268086829" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Where.20does.20the.20.24this.20come.20from.3F.html#268086829">(Jan 14 2022 at 23:17)</a>:</h4>
<p>I agree that's pretty unclear in the spec. The section discussion says "The functions in this section operator on collections with a single item", which makes sense for all the other functions in that section (conversion functions), but <code>iif</code> isn't really a conversion function, it's more a conditional operator, so it's not clear that that applies. The examples in the spec of <code>iif</code> are all stand-alone (i.e. not invoked using the <code>.</code> notation), which is how I have always used <code>iif</code>. So I would expect <code>Patient.name.iif(true, $this, 0)</code> to be invalid, I would write <code>Patient.name.select(iif(true, $this, 0)</code>, and then the $this is clearly iterating over the names.</p>



<a name="268091245"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Where%20does%20the%20%24this%20come%20from%3F/near/268091245" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tilo Christ <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Where.20does.20the.20.24this.20come.20from.3F.html#268091245">(Jan 15 2022 at 00:14)</a>:</h4>
<p><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span>  that makes a lot of sense. The other item that I'm still trying to figure out is a test case from the test suite, also related to $this. It is this one: <code>Patient.name.supersetOf($this.name.first()) = true</code>. For this one, the HAPI FHIRPath engine puts the Patient resource into $this, (and also in the iif-example I gave, it is the engine that put the entire patient into $this)). Is there any explanation from the spec for that behaviour, or is this in your mind also something that should behave differently or not at all?</p>



<a name="269134366"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Where%20does%20the%20%24this%20come%20from%3F/near/269134366" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Where.20does.20the.20.24this.20come.20from.3F.html#269134366">(Jan 24 2022 at 16:50)</a>:</h4>
<p><span class="user-mention" data-user-id="192169">@Tilo Christ</span> the spec says that <code>$this</code> is only used when the function takes an <code>expression</code> as a parameter, and <code>supersetOf</code> explicitly takes a collection (i.e. it's not an interating operator). So I think this test is, based on the spec, invalid. It seems like the implementations took the approach of considering the root evaluation an "iteration" context so that <code>$this</code> would be available, but I don't see any language in the spec that supports that.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
