---
layout: page
title: "FHIR Chat  · iif() · fhirpath"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/index.html">fhirpath</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/iif().html">iif()</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="225362667"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/iif%28%29/near/225362667" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Nash <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/iif().html#225362667">(Feb 05 2021 at 21:52)</a>:</h4>
<p>Hey folks, I'm looking at the FHIRPath spec and cannot seem to reconcile what's written with the behavior I see in fhirpath.js.</p>
<p>The spec's definition is <code>iif(criterion: expression, true-result: collection [, otherwise-result: collection]) : collection</code></p>
<p>When I use fhirpath.js I see <code>Patient.address.first().text.iif(contains('Rainbow'), $this, {}))</code> return <code>'534 Erewhon St PeasantVille, Rainbow, Vic  3999'</code> yet I would expect the result to be the Patient resource. Is the implementation wrong or I am misunderstanding something about the spec. I would expect <code>true-result</code> to have an <code>expression</code> type in order to see the behavior I'm seeing.</p>



<a name="225363951"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/iif%28%29/near/225363951" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/iif().html#225363951">(Feb 05 2021 at 22:04)</a>:</h4>
<p>$this is the 'current context node', which in this case is the first repetition of address.text.  If you want to return the context resource, use <code>%resource</code></p>



<a name="225364479"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/iif%28%29/near/225364479" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Nash <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/iif().html#225364479">(Feb 05 2021 at 22:08)</a>:</h4>
<p>That seems wrong to me. Take for example <code>Patient.address.first().text.union($this)</code> that returns <code>'534 Erewhon St PeasantVille, Rainbow, Vic  3999' | Patient</code> Both the first parameter of <code>union</code> and the second parameter of <code>iif </code> are of type <code>collection</code> Why would they have different results?</p>



<a name="225364718"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/iif%28%29/near/225364718" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/iif().html#225364718">(Feb 05 2021 at 22:10)</a>:</h4>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span> <span class="user-mention" data-user-id="195344">@Paul Lynch</span> <span class="user-mention" data-user-id="191359">@Bryn Rhodes</span></p>



<a name="225368680"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/iif%28%29/near/225368680" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/iif().html#225368680">(Feb 05 2021 at 22:51)</a>:</h4>
<p>From <a href="http://hl7.org/fhirpath/#functions">http://hl7.org/fhirpath/#functions</a>:</p>



<a name="225368697"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/iif%28%29/near/225368697" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/iif().html#225368697">(Feb 05 2021 at 22:51)</a>:</h4>
<blockquote>
<p>If the function takes an expression as a parameter, the function will evaluate the expression passed for the <br>
parameter with respect to each of the items in the input collection. These expressions may refer to the special $this and $index elements, which represent the item from the input collection currently under evaluation, and its index in the collection, respectively.</p>
</blockquote>
<p>The function iif takes an expression as its first parameter, so $this gets set each item in turn in the array to which iif is applied.</p>



<a name="225370249"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/iif%28%29/near/225370249" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Nash <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/iif().html#225370249">(Feb 05 2021 at 23:09)</a>:</h4>
<p>I would expect the spec to say "If the function takes an expression as a parameter, the function will evaluate the expression passed for <strong>every</strong> parameter with respect to each of the items in the input collection" or something along those lines if that applied to every parameter. Separately, if that's the behavior we expect shouldn't the signature be <code>iif(criterion: expression, true-result: expression [, otherwise-result: expression]) : collection</code> and not <code>iif(criterion: expression, true-result: collection [, otherwise-result: collection]) : collection</code></p>



<a name="225540943"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/iif%28%29/near/225540943" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/iif().html#225540943">(Feb 08 2021 at 13:07)</a>:</h4>
<p>It doesn't say every parameter has to be an expression; it is enough that one of them is.  That's how I read it, anyway.  <span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> ?</p>



<a name="225548540"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/iif%28%29/near/225548540" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/iif().html#225548540">(Feb 08 2021 at 14:07)</a>:</h4>
<p>Only the arguments indicated as <code>expression</code> are iterated. It's not clear what the behavior would mean otherwise, cartesian product? In fact, it's not clear to me in any of these examples that the <code>$this</code> reference is well defined? $this is only accessible within an iteration context.</p>



<a name="225557605"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/iif%28%29/near/225557605" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ryan moehrke <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/iif().html#225557605">(Feb 08 2021 at 15:12)</a>:</h4>
<p>is iif iterated though? I wouldn't expect to get multiple true/false results from an iif expression</p>



<a name="225565807"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/iif%28%29/near/225565807" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/iif().html#225565807">(Feb 08 2021 at 16:07)</a>:</h4>
<p><span class="user-mention" data-user-id="237342">@ryan moehrke</span>  Good point. Immediately above description for iif, it says, "The functions in this section operate on collections with a single item. If there is more than one item, the evaluation of the expression will end and signal an error to the calling environment."  fhirpath.js throws an error for more than one argument.... but it still sets "iterates" over the one item and sets "$this", because it takes an expression.</p>
<div class="codehilite"><pre><span></span><code>(3).iif($this&gt;1, &#39;a&#39;, &#39;b&#39;) =&gt; [&#39;a&#39;]
</code></pre></div>



<a name="225566899"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/iif%28%29/near/225566899" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/iif().html#225566899">(Feb 08 2021 at 16:14)</a>:</h4>
<p><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> fhirpath.js' implementation views that iteration context at the iif call, not just its argument, so that when $this is set, the same value is available to any of the arguments, not just the expression argument.</p>



<a name="225572037"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/iif%28%29/near/225572037" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/iif().html#225572037">(Feb 08 2021 at 16:45)</a>:</h4>
<p><span class="user-mention" data-user-id="195344">@Paul Lynch</span> , that's a reasonable interpretation given it's a singleton function, I'm looking at what the CQL engine would do here and I think it's actually aligned with the JS engine there. <span class="user-mention" data-user-id="191316">@Grahame Grieve</span> , does the FHIRPath engine support the true-result and otherwise-result arguments to iif as expressions with access to the iteration context?</p>



<a name="225590759"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/iif%28%29/near/225590759" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Nash <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/iif().html#225590759">(Feb 08 2021 at 18:56)</a>:</h4>
<p>To separate out the discussion regarding the appropriate use of $this from the original inquiry, you could replace $this in my original examples with first(). That is, <code>Patient.address.first().text.iif(contains('Rainbow'), first(), {}))</code>and <code>Patient.address.first().text.union(first())</code></p>



<a name="225590983"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/iif%28%29/near/225590983" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Nash <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/iif().html#225590983">(Feb 08 2021 at 18:57)</a>:</h4>
<p>Nonetheless, Bryn's last question is a good summary of what I'm asking.</p>



<a name="225591910"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/iif%28%29/near/225591910" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ryan moehrke <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/iif().html#225591910">(Feb 08 2021 at 19:04)</a>:</h4>
<p>Patient.where(address.first().text.contains('Rainbow'))<br>
Patient.where(address.text.where(contains('Rainbow'))) if you want any address that contains Rainbow<br>
iif(Patient.address.first().text.contains('Rainbow'), Patient, {})) if you really want to use iif<br>
should all work for your usecase too (fhirpath has a lot of options)</p>



<a name="225607389"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/iif%28%29/near/225607389" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Nash <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/iif().html#225607389">(Feb 08 2021 at 20:59)</a>:</h4>
<p>Thanks, Ryan. To be clear, my issue isn't about "how do I do this particular thing" but, rather, what does the spec say should happen in this particular situation.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
