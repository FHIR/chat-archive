---
layout: page
title: "FHIR Chat  · Discrepancy in Timing.repeat · fhirpath"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/index.html">fhirpath</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Discrepancy.20in.20Timing.2Erepeat.html">Discrepancy in Timing.repeat</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="271189742"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Discrepancy%20in%20Timing.repeat/near/271189742" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ose Umolu <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Discrepancy.20in.20Timing.2Erepeat.html#271189742">(Feb 08 2022 at 20:57)</a>:</h4>
<p>I wanted to get some clarity on one of the constraints in Timing.repeat (<a href="http://hl7.org/fhir/R4/datatypes-definitions.html#Timing.repeat">http://hl7.org/fhir/R4/datatypes-definitions.html#Timing.repeat</a>) ; <code>tim-9</code>:</p>
<p><code>offset.empty() or (when.exists() and ((when in ('C' | 'CM' | 'CD' | 'CV')).not()))</code></p>
<p>It looks like <code>when</code> is a repeated field: <a href="http://hl7.org/fhir/R4/datatypes-definitions.html#Timing.repeat">http://hl7.org/fhir/R4/datatypes-definitions.html#Timing.repeat</a></p>
<p>But it also looks like the <code>in</code> operation does not allow repeated fields on its LHS (it is supposed to error out): <a href="http://hl7.org/fhirpath/index.html#in-membership">http://hl7.org/fhirpath/index.html#in-membership</a>; <code>If the left operand has multiple items, an exception is thrown.</code></p>
<p>So is <code>when in ('C' | 'CM' | 'CD' | 'CV')</code> an invalid expression? or am I misunderstanding how <code>in</code> works.</p>
<p>And if it is invalid, what would the replacement be?</p>



<a name="271192884"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Discrepancy%20in%20Timing.repeat/near/271192884" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Discrepancy.20in.20Timing.2Erepeat.html#271192884">(Feb 08 2022 at 21:22)</a>:</h4>
<p>Yeah, this will run fine so long as there is only ever one "when" in an instance. It should probably be:</p>
<div class="codehilite"><pre><span></span><code>offset.empty() or (when.exists() and when.all(($this in (&#39;C&#39; | &#39;CM&#39; | &#39;CD&#39; | &#39;CV&#39;)).not()))
</code></pre></div>



<a name="271195276"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Discrepancy%20in%20Timing.repeat/near/271195276" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick George <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Discrepancy.20in.20Timing.2Erepeat.html#271195276">(Feb 08 2022 at 21:42)</a>:</h4>
<p>So just to be 100% clear, in a case where the when clause is satisfied for one but not all of the Timing.repeat.when, <br>
a) the current expression evalatuates to an exception<br>
b) it should evaluate to false</p>



<a name="271196997"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Discrepancy%20in%20Timing.repeat/near/271196997" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick George <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Discrepancy.20in.20Timing.2Erepeat.html#271196997">(Feb 08 2022 at 21:57)</a>:</h4>
<p>is that accurate?</p>



<a name="271197096"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Discrepancy%20in%20Timing.repeat/near/271197096" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ose Umolu <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Discrepancy.20in.20Timing.2Erepeat.html#271197096">(Feb 08 2022 at 21:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="191359">Bryn Rhodes</span> <a href="#narrow/stream/179266-fhirpath/topic/Discrepancy.20in.20Timing.2Erepeat/near/271192884">said</a>:</p>
<blockquote>
<p>Yeah, this will run fine so long as there is only ever one "when" in an instance. It should probably be:</p>
<p><div class="codehilite"><pre><span></span><code>offset.empty() or (when.exists() and when.all(($this in (&#39;C&#39; | &#39;CM&#39; | &#39;CD&#39; | &#39;CV&#39;)).not()))
</code></pre></div><br>
</p>
</blockquote>
<p>Interesting, okay. What happens when there is more than one "when" instance? <br>
Is there an implied restriction in the constraint that there should be only one instance of "when"?</p>



<a name="271212641"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Discrepancy%20in%20Timing.repeat/near/271212641" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Discrepancy.20in.20Timing.2Erepeat.html#271212641">(Feb 09 2022 at 00:18)</a>:</h4>
<p>No, an exception evaluating a constraint is, I would think, an error condition, not part of the constraint definition.</p>



<a name="271220483"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Discrepancy%20in%20Timing.repeat/near/271220483" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick George <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Discrepancy.20in.20Timing.2Erepeat.html#271220483">(Feb 09 2022 at 01:53)</a>:</h4>
<p>I guess my point being - If I asked you, "does this resource pass this fhirpath constraint", on a multi-valued when resource, how would you answer?</p>
<p>Our current plan is to just in place replace the expression with your sugggested  replacement - does that make sense to you.  Do you think we can propose it e.g., for r5?</p>



<a name="271225735"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Discrepancy%20in%20Timing.repeat/near/271225735" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Discrepancy.20in.20Timing.2Erepeat.html#271225735">(Feb 09 2022 at 03:18)</a>:</h4>
<p>This <a href="https://hl7.org/fhir/conformance-rules.html#constraints">language</a> indicates that the invariant must evaluate to true, so by that requirement, no, an exception during evaluation of the constraint would have to be considered a failure of the constraint and the resource don't pass the constraint. I would suggest submitting a tracker to correct the invariant with the suggested expression, that's just my read of the intent, should definitely be brought up with FHIR-I to confirm my interpretation there and to get the spec invariant corrected.</p>



<a name="271226757"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Discrepancy%20in%20Timing.repeat/near/271226757" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Discrepancy.20in.20Timing.2Erepeat.html#271226757">(Feb 09 2022 at 03:37)</a>:</h4>
<p>As far as the interpretation of an exception when evaluating a constraint, that's probably worth some clarifying language in the spec as well. I'll submit a tracker on that: <a href="https://jira.hl7.org/browse/FHIR-35990">https://jira.hl7.org/browse/FHIR-35990</a></p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
