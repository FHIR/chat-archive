---
layout: page
title: "FHIR Chat  · repeat(&#x27;someString&#x27;) · fhirpath"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/index.html">fhirpath</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html">repeat(&#x27;someString&#x27;)</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="276259415"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/276259415" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#276259415">(Mar 22 2022 at 21:46)</a>:</h4>
<p>repeat takes an expression, which could be a constant.  What should the behavior be in that case?  If you have a collection "a", and call a.repeat('blue'), would you expect to get one blue for each item in 'a', or one blue in total?  (I am not suggesting this is a useful thing to do, but trying to nail down what the correct behavior would be.)</p>



<a name="276271148"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/276271148" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#276271148">(Mar 23 2022 at 00:03)</a>:</h4>
<p>The definition says:</p>
<blockquote>
<p>as long as the projection yields new items</p>
</blockquote>
<p>So if you call <code>a.repeat('blue')</code>, let's say initially <code>a</code> refers to a collection like<code>[1,2,3]</code>. The way I read it, the processing would be:</p>
<h3>Begin Round 1 with inputs = <code>[1, 2, 3]</code></h3>
<ul>
<li>Evaluate <code>'blue'</code> for the input item <code>1</code><ul>
<li>--&gt; evaluated items is <code>[1]</code></li>
<li>--&gt; Round 1 output is <code>['blue']</code></li>
</ul>
</li>
<li>Evaluate <code>'blue'</code> for the input item <code>2</code><ul>
<li>--&gt; evaluated items is <code>[1, 2]</code></li>
<li>--&gt; output is <code>['blue']</code>  (tried adding a 2nd time but it's not unique!)</li>
</ul>
</li>
<li>Evaluate <code>'blue'</code> for the input item <code>3</code><ul>
<li>--&gt; evaluated items is <code>[1, 2, 3]</code></li>
<li>--&gt; output is <code>['blue']</code>(tried adding a 3nd time but it's not unique!)</li>
</ul>
</li>
</ul>
<h3>Round 1 complete, and the (outputs - evaluated) is not empty, so... begin Round 2 with inputs = <code>['blue']</code> (from Round 1's outputs)</h3>
<ul>
<li>Evaluate <code>'blue'</code> for the input item <code>'blue'</code><ul>
<li>--&gt; evaluated items is <code>[1, 2, 3, 'blue']</code></li>
<li>--&gt; output is <code>['blue']</code>(tried adding a 4th time but it's not unique!)</li>
</ul>
</li>
</ul>
<h3>Round 2 complete and (outputs - evaluated) is empty, so ... we're done!</h3>



<a name="276271352"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/276271352" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#276271352">(Mar 23 2022 at 00:06)</a>:</h4>
<p>Ooh, I see BTW why you're asking -- the <a href="https://hl7.github.io/fhirpath.js">https://hl7.github.io/fhirpath.js</a> crashes when you ask it to evaluate <code>Patient.name.repeat('test')</code> ;-)</p>



<a name="276386847"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/276386847" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#276386847">(Mar 23 2022 at 19:21)</a>:</h4>
<p>Indeed it does.  I came across this when I accidentally wrote Questionnaire.repeat('item') instead of Questionnaire.repeat(item).</p>



<a name="276387654"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/276387654" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#276387654">(Mar 23 2022 at 19:28)</a>:</h4>
<p>It is not clear to me from the documentation that the check for existing items occurs after each item or after each round, and I am not sure which is the better approach because it is hard to image a use case for doing this.  Anyway, as Bryn agrees with your interpretation, I will file a tracker item to add a clarification.  Thanks for the very clear example.</p>



<a name="276388801"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/276388801" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#276388801">(Mar 23 2022 at 19:38)</a>:</h4>
<p><a href="http://jira.hl7.org/browse/FHIR-36588">FHIR-36588</a></p>



<a name="276545313"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/276545313" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#276545313">(Mar 24 2022 at 22:03)</a>:</h4>
<p>p.s. That kills the dotnet fhirpath engine too. It never checks if the new node already existed (using <code>=</code>) so execution never stops.<br>
This is where that code is in the donet SDK, will log it.<br>
<a href="https://github.com/FirelyTeam/firely-net-common/blob/ba31e20d00dd0f2c5e0d56ceefa4fff4d686b309/src/Hl7.FhirPath/FhirPath/Expressions/SymbolTableInit.cs#L347">https://github.com/FirelyTeam/firely-net-common/blob/ba31e20d00dd0f2c5e0d56ceefa4fff4d686b309/src/Hl7.FhirPath/FhirPath/Expressions/SymbolTableInit.cs#L347</a></p>



<a name="276552468"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/276552468" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#276552468">(Mar 24 2022 at 23:25)</a>:</h4>
<p><a href="https://github.com/FirelyTeam/firely-net-sdk/issues/2018">https://github.com/FirelyTeam/firely-net-sdk/issues/2018</a></p>



<a name="277219763"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/277219763" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#277219763">(Mar 31 2022 at 00:31)</a>:</h4>
<p>that also did it for the Java engine as well. Fixed next release</p>



<a name="277436862"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/277436862" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#277436862">(Apr 01 2022 at 15:39)</a>:</h4>
<p><span class="user-mention" data-user-id="191315">@Josh Mandel</span>  We made a change to add the uniqueness check in your algorithm above, but I am having some doubts about that.  I think if you write Questionnaire.repeat(extension), you just want all of the extensions, and don't care whether they are unique or not.</p>



<a name="277450878"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/277450878" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#277450878">(Apr 01 2022 at 17:19)</a>:</h4>
<p>Thinking about a FHIR Questionnaire as a tree of nodes.... you're saying you want to see <em>the same node</em> more than once? Or just that if semantically equivalent nodes appear at different positions in the tree, you'd want to see all of those?</p>



<a name="277450938"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/277450938" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#277450938">(Apr 01 2022 at 17:19)</a>:</h4>
<p>The latter.  I don't think repeat could find the exact same node in a tree more than once.</p>



<a name="277481554"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/277481554" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#277481554">(Apr 01 2022 at 21:42)</a>:</h4>
<p>However, the specification does say it stops when the projection does not yield "new items (as determined by the = (Equals) (=) operator).", so I don't see how my example of Questionnaire.repeat(extension) could be expected to return a complete list of the extensions on the root of the Questionnaire.   In other words, I am withdrawing my question about the algorithm.</p>



<a name="277490542"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/277490542" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#277490542">(Apr 01 2022 at 23:30)</a>:</h4>
<p>The requirement to do an Equals comparison means doing deep equals for Questionnaire items, and the complexity of the algorithm is O(n**2).  On one test Questionnaire with 772 questions, it was faster to call descendants() than to call repeat(item).  For a short questionnaire with only 10 items, descendants() and repeat(item) were about the same, which is disappointing, because I've been thinking repeat(item) should be much faster.   It is also a bit frustrating since in this case the items should all be unique due to their linkIds, and the uniqueness check is just a waste of time. We are looking at possibly building a hash to speed up comparisons, at least when there are a large of number of items.</p>



<a name="277513439"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/277513439" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#277513439">(Apr 02 2022 at 07:42)</a>:</h4>
<p>And if you're doing that on questionnaireresponse. Item, you could legitimately have dups, but this might remove them. I'm not sure if that's sensible, but if that's what the response has, it wouldn't return it.</p>



<a name="277743043"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/277743043" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#277743043">(Apr 04 2022 at 14:56)</a>:</h4>
<p>Maybe we should have repeat(...) and repeatUnique(...)?</p>



<a name="277743644"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/277743644" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#277743644">(Apr 04 2022 at 15:00)</a>:</h4>
<p>I am not sure there is really a need for the uniqueness check, except as a way to avoid endless loops like repeat('someString').  If someone wanted uniqueness, they could always call repeat(something).distinct().</p>



<a name="277752076"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/277752076" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#277752076">(Apr 04 2022 at 15:53)</a>:</h4>
<p>I like that concept, and engines could just have (effectively) a "stack depth limit" or "iteration limit" that could prevent <em>actual endless loops</em> in unbounded or pathological cases.</p>



<a name="277795690"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/277795690" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#277795690">(Apr 04 2022 at 21:23)</a>:</h4>
<p>but this would be a breaking change to normative content.</p>



<a name="277795715"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/277795715" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#277795715">(Apr 04 2022 at 21:23)</a>:</h4>
<p>so you'd really have to propose adding a .repeatNonUnique(xxx)</p>



<a name="277804733"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/277804733" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#277804733">(Apr 04 2022 at 22:53)</a>:</h4>
<p>And to propose deprecating the old one</p>



<a name="277816641"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/277816641" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#277816641">(Apr 05 2022 at 01:20)</a>:</h4>
<p>I'll propose some tests with expected results to conoare/discuss.<br>
(for unit testing the implementations with)</p>



<a name="277818339"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/277818339" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#277818339">(Apr 05 2022 at 01:54)</a>:</h4>
<p>why deprecate ?</p>



<a name="277824370"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/277824370" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#277824370">(Apr 05 2022 at 03:46)</a>:</h4>
<p>If (from the discussion above) all known use cases are accounted for by other invocations and performance with the old definition is likely to be an issue.</p>



<a name="277824743"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/277824743" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#277824743">(Apr 05 2022 at 03:55)</a>:</h4>
<p>but it still works, so why force people to change?</p>



<a name="277826392"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/277826392" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#277826392">(Apr 05 2022 at 04:28)</a>:</h4>
<p>If it works reliably, no reason. If it's a performance pitfall that people will hit when they least expect, that's a reason.</p>



<a name="277826675"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/277826675" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#277826675">(Apr 05 2022 at 04:34)</a>:</h4>
<p>it does work reliably and it's the right thing to do in many cases. Paul found one case where it's slower than an alternative, but that's no grounds to deprecate it</p>



<a name="277937052"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/repeat%28%27someString%27%29/near/277937052" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/repeat(&#x27;someString&#x27;).html#277937052">(Apr 05 2022 at 20:11)</a>:</h4>
<p>Created <a href="http://jira.hl7.org/browse/FHIR-36708">FHIR-36708</a> for "repeatNonUnique".</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
