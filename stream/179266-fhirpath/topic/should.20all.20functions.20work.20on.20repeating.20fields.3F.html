---
layout: page
title: "FHIR Chat  · should all functions work on repeating fields? · fhirpath"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/index.html">fhirpath</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/should.20all.20functions.20work.20on.20repeating.20fields.3F.html">should all functions work on repeating fields?</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="275591971"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/should%20all%20functions%20work%20on%20repeating%20fields%3F/near/275591971" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/should.20all.20functions.20work.20on.20repeating.20fields.3F.html#275591971">(Mar 16 2022 at 23:52)</a>:</h4>
<p>Yes, open JIRAs please, that clarification is supposed to be on each function, but apparently we missed some.</p>



<a name="275591984"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/should%20all%20functions%20work%20on%20repeating%20fields%3F/near/275591984" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/should.20all.20functions.20work.20on.20repeating.20fields.3F.html#275591984">(Mar 16 2022 at 23:53)</a>:</h4>
<p>Actually one JIRA would be fine with all of them listed</p>



<a name="275592105"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/should%20all%20functions%20work%20on%20repeating%20fields%3F/near/275592105" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/should.20all.20functions.20work.20on.20repeating.20fields.3F.html#275592105">(Mar 16 2022 at 23:54)</a>:</h4>
<p>But to answer the question, length() expects a singleton. Basically, unless the function is something that will by it's nature iterate over the items in the collection (like .where, .select, etc), then it's a singleton. Another way to think about it is if you would have to supply collection semantics, then it's a singleton. For example, in .length(), what should it do if it gets multiple items? Compute the total length or return the length of each?</p>



<a name="275660298"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/should%20all%20functions%20work%20on%20repeating%20fields%3F/near/275660298" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/should.20all.20functions.20work.20on.20repeating.20fields.3F.html#275660298">(Mar 17 2022 at 14:24)</a>:</h4>
<p>I think i'll do 2 issues:  one for fhirpath and one for fhir.  its actually the latter one that defines <code>memberOf</code> which was the original function that raised this question</p>



<a name="275660396"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/should%20all%20functions%20work%20on%20repeating%20fields%3F/near/275660396" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/should.20all.20functions.20work.20on.20repeating.20fields.3F.html#275660396">(Mar 17 2022 at 14:25)</a>:</h4>
<blockquote>
<p>if you would have to supply collection semantics, then it's a singleton...<br>
For example, in .length(), what should it do if it gets multiple items?</p>
</blockquote>
<p>That matches our implementation, but the verbiage in the spec about all functions operating over collections got me worried that maybe we had it wrong.</p>



<a name="275661140"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/should%20all%20functions%20work%20on%20repeating%20fields%3F/near/275661140" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/should.20all.20functions.20work.20on.20repeating.20fields.3F.html#275661140">(Mar 17 2022 at 14:30)</a>:</h4>
<p>I think the alternative would be for any function that operates over singletons to instead apply the function for each input element and produce a 1-to-1 mapping to the output collection.<br>
For example, for <code>length()</code> it <em>could</em> execute the function against <em>each</em> string in the input collection and return a collection of integers.</p>
<p>Personally, I think that interpretation would have some nice properties.<br>
Because the current FHIRPath specification requires FHIRPath authors to be super-aware of any repeating elements in the model.<br>
This is probably the number 1 mistake I've seen with FHIRPath expressions "in the wild".</p>



<a name="275661208"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/should%20all%20functions%20work%20on%20repeating%20fields%3F/near/275661208" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/should.20all.20functions.20work.20on.20repeating.20fields.3F.html#275661208">(Mar 17 2022 at 14:30)</a>:</h4>
<p>Has anything like that ever been considered?</p>



<a name="275662281"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/should%20all%20functions%20work%20on%20repeating%20fields%3F/near/275662281" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/should.20all.20functions.20work.20on.20repeating.20fields.3F.html#275662281">(Mar 17 2022 at 14:37)</a>:</h4>
<blockquote>
<p>This is probably the number 1 mistake I've seen with FHIRPath expressions "in the wild".</p>
</blockquote>
<p>One thing that contributes to that issue is that I think most engines will happily execute the function if you apply it to a resource such that only a single element is present.<br>
That leads to issues like <a href="https://jira.hl7.org/browse/FHIR-36328">https://jira.hl7.org/browse/FHIR-36328</a> where the expression seems to work for some input (e.g. when the repeating element is only there once) but then fails when you try applying it to a resource that has more than a single instance of the repeating element.</p>



<a name="275662458"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/should%20all%20functions%20work%20on%20repeating%20fields%3F/near/275662458" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/should.20all.20functions.20work.20on.20repeating.20fields.3F.html#275662458">(Mar 17 2022 at 14:38)</a>:</h4>
<p>Do any of the engines / other tools warn users when they use singleton functions against a model that could lead to multiple inputs?</p>



<a name="275662776"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/should%20all%20functions%20work%20on%20repeating%20fields%3F/near/275662776" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/should.20all.20functions.20work.20on.20repeating.20fields.3F.html#275662776">(Mar 17 2022 at 14:40)</a>:</h4>
<p>Yes.  <a href="https://hl7.github.io/fhirpath.js/">https://hl7.github.io/fhirpath.js/</a>.  ('aaa'| 'zzz').length()   =&gt; <code>Error: Unexpected collection["aaa","zzz"]; expected singleton of type String</code></p>



<a name="275663337"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/should%20all%20functions%20work%20on%20repeating%20fields%3F/near/275663337" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/should.20all.20functions.20work.20on.20repeating.20fields.3F.html#275663337">(Mar 17 2022 at 14:44)</a>:</h4>
<p>I mean if you have an expression like <code>Observation.component.value is string</code> (just an example off the top of my head)</p>



<a name="275663402"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/should%20all%20functions%20work%20on%20repeating%20fields%3F/near/275663402" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/should.20all.20functions.20work.20on.20repeating.20fields.3F.html#275663402">(Mar 17 2022 at 14:44)</a>:</h4>
<p>that will execute on any Observations with 0 or 1 components</p>



<a name="275663445"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/should%20all%20functions%20work%20on%20repeating%20fields%3F/near/275663445" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/should.20all.20functions.20work.20on.20repeating.20fields.3F.html#275663445">(Mar 17 2022 at 14:44)</a>:</h4>
<p>but if you run that against an Observation with 2 components... kablooey</p>



<a name="275663480"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/should%20all%20functions%20work%20on%20repeating%20fields%3F/near/275663480" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/should.20all.20functions.20work.20on.20repeating.20fields.3F.html#275663480">(Mar 17 2022 at 14:45)</a>:</h4>
<p>it would be interesting to use model-awareness to warn FHIRPath authors about that</p>



<a name="275664337"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/should%20all%20functions%20work%20on%20repeating%20fields%3F/near/275664337" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/should.20all.20functions.20work.20on.20repeating.20fields.3F.html#275664337">(Mar 17 2022 at 14:50)</a>:</h4>
<p>Yes, a warning in such cases could be helpful.</p>



<a name="275667427"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/should%20all%20functions%20work%20on%20repeating%20fields%3F/near/275667427" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/should.20all.20functions.20work.20on.20repeating.20fields.3F.html#275667427">(Mar 17 2022 at 15:09)</a>:</h4>
<p>When you evaluate FHIRPath expressions in CQL, the translator does this with a "list demotion" and will issue a warning whenever it happens, yes.</p>



<a name="275706398"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/should%20all%20functions%20work%20on%20repeating%20fields%3F/near/275706398" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/should.20all.20functions.20work.20on.20repeating.20fields.3F.html#275706398">(Mar 17 2022 at 18:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="191676">Lee Surprenant</span> <a href="#narrow/stream/179266-fhirpath/topic/should.20all.20functions.20work.20on.20repeating.20fields.3F/near/275660298">said</a>:</p>
<blockquote>
<p>I think i'll do 2 issues:  one for fhirpath and one for fhir.  its actually the latter one that defines <code>memberOf</code> which was the original function that raised this question</p>
</blockquote>
<p><a href="http://jira.hl7.org/browse/FHIR-36335">FHIR-36335</a> (fhirpath) and <a href="http://jira.hl7.org/browse/FHIR-36334">FHIR-36334</a> (fhir)</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
