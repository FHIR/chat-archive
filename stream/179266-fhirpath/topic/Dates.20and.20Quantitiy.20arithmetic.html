---
layout: page
title: "FHIR Chat  · Dates and Quantitiy arithmetic · fhirpath"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/index.html">fhirpath</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html">Dates and Quantitiy arithmetic</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="165911177"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/165911177" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#165911177">(May 17 2019 at 15:45)</a>:</h4>
<p>The simple implementation of Date &amp; Quantity arithmetic I had hoped to implement in fhirpath.js was as follows:<br>
1) Convert the date (or datetime, or time) to milliseconds<br>
2) Use our JavaScript UCUM conversion library (ucum-lhc) to convert the quantity to milliseconds<br>
3) Add/subtract the quantity ms from the date ms<br>
4) Convert back to a date string and truncate to the precision of the date</p>
<p>However, having read the resolutions to <a href="https://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=20682&amp;start=0" target="_blank" title="https://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=20682&amp;start=0">GF#20682</a>, <a href="https://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=14089&amp;start=0" target="_blank" title="https://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=14089&amp;start=0">GF#14089</a>, and <a href="https://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=13365" target="_blank" title="https://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=13365">GF#13365</a>, it seems like things are a lot more complicated, and from a UCUM point of view, inconsistent.  As I understand the behavior from the spec, we have:</p>
<ul>
<li>@2019-02-01 + 1 'mo' = @2019-03-01</li>
<li>@2019-02-01 + 30.4375 'd' = @2019-03-03  (even though in UCUM 1 'mo' = 30.4375 'd')</li>
<li>@2019-02-01  + 1.0001 ' mo'  = @2019-03-03  (because the month amount is no longer a whole number, and gets interpreted per UCUM)</li>
<li>@2019-01-30 + 1 'mo' = ???</li>
</ul>
<p>Is that correct?</p>



<a name="165941735"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/165941735" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#165941735">(May 17 2019 at 22:26)</a>:</h4>
<p>yes that's correct. (including the last one ;-) )</p>



<a name="165941777"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/165941777" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#165941777">(May 17 2019 at 22:27)</a>:</h4>
<p>:-) So, the "last one" was meant as a hidden question.  Are you saying the answer to @2019-01-30 + 1 'mo'  is undefined (or maybe throws an error?)</p>



<a name="165941873"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/165941873" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#165941873">(May 17 2019 at 22:28)</a>:</h4>
<p>no I think it should not be undefined or result in an error - both would be very unmanagable in practice, but I do not know what the result should be. I just asked my daughter (since she was around) the question in plain english context and she wasn't sure what the right answer is</p>



<a name="166091822"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/166091822" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#166091822">(May 20 2019 at 14:58)</a>:</h4>
<p><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> ?</p>



<a name="166094976"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/166094976" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#166094976">(May 20 2019 at 15:37)</a>:</h4>
<p>And I guess @2019-03-31 + 1 'mo' = ?</p>



<a name="166095051"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/166095051" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#166095051">(May 20 2019 at 15:38)</a>:</h4>
<p>Asked my firely colleagues here.... the common tendency seems to be "end of the next month"</p>



<a name="166095106"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/166095106" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#166095106">(May 20 2019 at 15:39)</a>:</h4>
<p>And now, @2016-02-29 + 1 'a' ?</p>



<a name="166095128"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/166095128" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#166095128">(May 20 2019 at 15:39)</a>:</h4>
<p>That would be @2017-02-28 by the same logic.</p>



<a name="166095232"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/166095232" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#166095232">(May 20 2019 at 15:40)</a>:</h4>
<p>Could be a pain to implement. Let's me check what the .NET stack does...</p>



<a name="166095366"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/166095366" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#166095366">(May 20 2019 at 15:42)</a>:</h4>
<p>Yep:<br>
new DateTime(2019,01,30).AddMonths(1) == new DateTime(2019,2,28)</p>



<a name="166095430"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/166095430" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#166095430">(May 20 2019 at 15:43)</a>:</h4>
<p>new DateTime(2016,02,29).AddYears(1) == new DateTime(2017,2,28)</p>



<a name="166106311"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/166106311" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#166106311">(May 20 2019 at 18:08)</a>:</h4>
<p>@2019-02-28 + 1 'mo' = @2019-03-28 ? <br>
Then:<br>
@2019-01-31 + 1 'mo' + 1 'mo' = @2019-03-28</p>



<a name="166106348"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/166106348" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jean Duteau <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#166106348">(May 20 2019 at 18:09)</a>:</h4>
<p>And @2019-01-31 + 2 'mo' = @2019-03-31?</p>



<a name="166110905"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/166110905" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#166110905">(May 20 2019 at 19:08)</a>:</h4>
<p>It is on the .NET stack.</p>



<a name="166114475"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/166114475" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#166114475">(May 20 2019 at 19:51)</a>:</h4>
<p>moment.js also behaves that way.  I guess we can live with that behavior.</p>



<a name="166116116"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/166116116" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#166116116">(May 20 2019 at 20:14)</a>:</h4>
<p>CQL defines this behavior according to the ISO 8601 guidelines, which allow for "agreement": <a href="https://cql.hl7.org/05-languagesemantics.html#datetime-arithmetic-1" target="_blank" title="https://cql.hl7.org/05-languagesemantics.html#datetime-arithmetic-1">https://cql.hl7.org/05-languagesemantics.html#datetime-arithmetic-1</a></p>



<a name="166116493"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/166116493" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#166116493">(May 20 2019 at 20:19)</a>:</h4>
<p>And yes, that's consistent with the .NET and Java stacks, same behavior.</p>



<a name="166116715"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/166116715" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#166116715">(May 20 2019 at 20:22)</a>:</h4>
<p>The one clarification I would suggest here is that <code>1.0001 'mo'</code> doesn't make sense in this context, because a month isn't a definite quantity. The Java engine ignores the fractional component so that <code>@2019-02-01 + 1.0001 'mo'</code> is actually <code>@2019-03-01</code>.</p>



<a name="166116894"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/166116894" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#166116894">(May 20 2019 at 20:24)</a>:</h4>
<p>'mo' is a definite quantity in UCUM.  I think that is why the resolution of those tracker items follow the UCUM definition for non-whole numbers.</p>



<a name="166118486"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/166118486" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#166118486">(May 20 2019 at 20:46)</a>:</h4>
<p>Right, we're just saying that when you use UCUM months and years in calendar calculations, the calculations round for calendar semantics, consistent with ISO 8601 definitions.</p>



<a name="166152013"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/166152013" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#166152013">(May 21 2019 at 08:23)</a>:</h4>
<p>And the only way to add calender months in .NET is using the AddMonths() function as shown above, which takes an integer parameter.</p>



<a name="167298953"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/167298953" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#167298953">(Jun 04 2019 at 14:24)</a>:</h4>
<p>The spec currently says, "For partial date/time values, the operation is performed by converting the time-valued quantity to the highest precision in the partial...."  I assume that is only done if the time-valued quantity is at a higher precision than the partial date/time?  Otherwise, if one follows that sentence as written, @2019-01-01 + 1 'a'  would need to be converted to @2019-01-01 + 365 'd'  before processing the addition, which would cause problems in leap years.  I think if the text is changed to limit that conversion to when the partial date/time has less precision than the quantity, it should be okay.</p>



<a name="167467899"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/167467899" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bas van den Heuvel <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#167467899">(Jun 06 2019 at 10:01)</a>:</h4>
<p>What is the current situation on this topic?<br>
If I understand the topic correctly. The operations like @2014-02-04T15:32:29 + 1 'mo'. Adding UCUM values to FHIRPath Date/DateTime/Time values is not allowed. <br>
Is this true?</p>
<p>(related to tracker item 21601https://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=21601)</p>



<a name="167492513"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/167492513" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#167492513">(Jun 06 2019 at 15:32)</a>:</h4>
<p>I think that a clarification will be added to the FhirPath spec describing the logic we discussed in this thread.</p>



<a name="167492522"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/167492522" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#167492522">(Jun 06 2019 at 15:32)</a>:</h4>
<p><span class="user-mention" data-user-id="194452">@Bas van den Heuvel</span>  See the recent resolution of <a href="https://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=20682&amp;start=0" target="_blank" title="https://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=20682&amp;start=0">https://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=20682&amp;start=0</a>.  Quantities with UCUM units are still allowed to be added to date/time.</p>



<a name="167493987"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/167493987" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#167493987">(Jun 06 2019 at 15:46)</a>:</h4>
<blockquote>
<p>The spec currently says, "For partial date/time values, the operation is performed by converting the time-valued quantity to the highest precision in the partial...."  I assume that is only done if the time-valued quantity is at a higher precision than the partial date/time?  Otherwise, if one follows that sentence as written, @2019-01-01 + 1 'a'  would need to be converted to @2019-01-01 + 365 'd'  before processing the addition, which would cause problems in leap years.  I think if the text is changed to limit that conversion to when the partial date/time has less precision than the quantity, it should be okay.</p>
</blockquote>
<p><a href="https://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=22677" target="_blank" title="https://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=22677">GF#22677</a></p>



<a name="167670558"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Dates%20and%20Quantitiy%20arithmetic/near/167670558" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Dates.20and.20Quantitiy.20arithmetic.html#167670558">(Jun 08 2019 at 22:20)</a>:</h4>
<p><span class="user-mention" data-user-id="195344">@Paul Lynch</span> , thank you for submitting that, that is definitely the intent and I agree with the proposed clarification to address it.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
