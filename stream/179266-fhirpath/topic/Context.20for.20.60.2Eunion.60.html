---
layout: page
title: "FHIR Chat  · Context for `.union` · fhirpath"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/index.html">fhirpath</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html">Context for `.union`</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="276089909"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/276089909" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#276089909">(Mar 21 2022 at 17:53)</a>:</h4>
<p>From <a class="stream" data-stream-id="179298" href="/#narrow/stream/179298-fhirpath.2Ejs">#fhirpath.js</a> discussion...</p>
<p>Is it expected that</p>
<div class="codehilite"><pre><span></span><code>name.select(use | given)
</code></pre></div>

<p>should return different results from</p>
<div class="codehilite"><pre><span></span><code>name.select(use.union(given))
</code></pre></div>

<p>? I would have expected these to be equivalent but in fhirpath.js, <code>union</code> appears to be operating at the root level even when it occurs inside a <code>select</code>.</p>



<a name="276102160"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/276102160" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Sedinkin <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#276102160">(Mar 21 2022 at 19:28)</a>:</h4>
<p>I think that the right replacement for:<br>
<code>name.select(use | given)</code><br>
using union() is:<br>
<code>name.select(use.union($this.given))</code></p>
<p>It does not work for fhirpath.js right now, but I can fix that if there are no objections.</p>



<a name="276114038"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/276114038" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#276114038">(Mar 21 2022 at 21:09)</a>:</h4>
<p>That doesn't quite sound correct to me; the <a href="https://hl7.org/fhirpath/#unionother-collection">spec says</a>:</p>
<div class="codehilite"><pre><span></span><code>a.union(b)
is synonymous with
a | b
</code></pre></div>
<p>... and so I expect this holds true anywhere the expression occurs (including within a <code>select</code> expression).</p>



<a name="276116245"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/276116245" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#276116245">(Mar 21 2022 at 21:26)</a>:</h4>
<p>The spec is referring to two collections, "A" and "B" (uppercase), and then gives the example in lowercase.  I would interpret that as referring to two collections, not two properties of a parent node.</p>



<a name="276133068"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/276133068" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#276133068">(Mar 22 2022 at 01:08)</a>:</h4>
<p><span class="user-mention" data-user-id="191328">@Ewout Kramer</span> can you shed any light on the intention here?</p>



<a name="276252845"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/276252845" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#276252845">(Mar 22 2022 at 20:55)</a>:</h4>
<p>I don't think we intended to imply any difference in using uppercase versus lower case for those examples. I also don't think that there's any difference between whether the union operates on two collections or on two properties of a parent node (assuming those properties are accessible within the current scope), they would both be interpreted as collection arguments to the union operator.</p>



<a name="276253194"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/276253194" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#276253194">(Mar 22 2022 at 20:58)</a>:</h4>
<p>And in the example above:</p>
<div class="codehilite"><pre><span></span><code>name.select(use.union($this.given))
</code></pre></div>
<p>This is equivalent to:</p>
<div class="codehilite"><pre><span></span><code>name.select(use.union(given))
</code></pre></div>
<p>In other words, the <code>$this</code> is still referring to the iterator introduced by the <code>.select()</code>, union does not introduce an iteration scope. So although the <code>use.union($this.given)</code> should still work, it's not necessary to use <code>$this</code>.</p>



<a name="276253534"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/276253534" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#276253534">(Mar 22 2022 at 21:01)</a>:</h4>
<p>union does not introduce an iteration scope, but in that example, what is the scope for the collection in "union(...)"?</p>



<a name="276254264"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/276254264" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#276254264">(Mar 22 2022 at 21:06)</a>:</h4>
<p>I'm not sure I understand the question.</p>



<a name="276254601"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/276254601" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#276254601">(Mar 22 2022 at 21:09)</a>:</h4>
<p>The expression <code>use.union(given)</code> is the same as saying <code>use | given</code>, both are just invoking the <code>.union()</code> function, which takes two arguments, and both those arguments are evaluated in the same scope, which in this case is the one introduced by the <code>select()</code> function.</p>



<a name="276254611"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/276254611" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#276254611">(Mar 22 2022 at 21:09)</a>:</h4>
<p>Is that what you're asking?</p>



<a name="276254866"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/276254866" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#276254866">(Mar 22 2022 at 21:11)</a>:</h4>
<p>Yes.  That is clear answer.  I think the spec could use some clarification on that point, because it introduces "A" and "B" without any context of where they are coming from.  This example from Patient would be better.</p>



<a name="276257149"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/276257149" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#276257149">(Mar 22 2022 at 21:27)</a>:</h4>
<p>That's fair, submit a tracker?</p>



<a name="276258394"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/276258394" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#276258394">(Mar 22 2022 at 21:36)</a>:</h4>
<p><a href="http://jira.hl7.org/browse/FHIR-36494">FHIR-36494</a></p>



<a name="276412245"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/276412245" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#276412245">(Mar 23 2022 at 22:48)</a>:</h4>
<p>Which is the version that is a concatenation of collections that doesn't remove duplicates?<br>
(I know that | does remove duplicates)</p>



<a name="276421109"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/276421109" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#276421109">(Mar 24 2022 at 00:42)</a>:</h4>
<p>"combine"?  <a href="https://hl7.org/fhirpath/#combineother-collection-collection">https://hl7.org/fhirpath/#combineother-collection-collection</a></p>



<a name="277222798"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277222798" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277222798">(Mar 31 2022 at 01:27)</a>:</h4>
<p><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> the difference between <code>name.select(use.union($this.given))</code><br>
and <code>name.select(use.union(given))</code> is catching me out.</p>



<a name="277223647"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277223647" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277223647">(Mar 31 2022 at 01:44)</a>:</h4>
<p>you say that </p>
<blockquote>
<p>In other words, the $this is still referring to the iterator introduced by the .select(), union does not introduce an iteration scope. So although the use.union($this.given) should still work, it's not necessary to use $this.</p>
</blockquote>
<p>but it's more than that. You're saying that .union() doesn't switch context on it's parameters.</p>



<a name="277223680"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277223680" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277223680">(Mar 31 2022 at 01:45)</a>:</h4>
<p>I don't get this. a.func(b),  a is the scope for b. but not for union?</p>



<a name="277225730"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277225730" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277225730">(Mar 31 2022 at 02:26)</a>:</h4>
<blockquote>
<p>I don't get this. a.func(b),  a is the scope for b. but not for union?</p>
</blockquote>
<p>That is how I read the definitions, yes. How else can <code>a | b</code> and <code>a.union(b)</code> be equivalent? It's obvious in the former expression that the context for <code>b</code> is the same as the context for <code>a</code>.</p>



<a name="277226616"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277226616" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277226616">(Mar 31 2022 at 02:44)</a>:</h4>
<p>I don’t see a as the scope for b, a is just an argument, just like b, they are independent of eachother.</p>



<a name="277289630"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277289630" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277289630">(Mar 31 2022 at 14:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="191316">Grahame Grieve</span> <a href="#narrow/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60/near/277223680">said</a>:</p>
<blockquote>
<p>I don't get this. a.func(b),  a is the scope for b. but not for union?</p>
</blockquote>
<p>Maybe in <code>a.func(b)</code> a only becomes the scope for b (one at a time) when func takes and <code>expression</code> (as in <code>repeat</code>) and not a <code>collection</code> (as in <code>union</code>)?</p>



<a name="277290031"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277290031" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277290031">(Mar 31 2022 at 14:29)</a>:</h4>
<p><code>union</code> not the only case of this, right?  Should <code>Patient.telecom.use.subsetOf(use)</code> return true?</p>



<a name="277296052"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277296052" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277296052">(Mar 31 2022 at 15:11)</a>:</h4>
<p>That's an interesting framing, re: expressions vs collections as arguments. I think it makes sense, though I have not thought through all of the implications.</p>
<p>(I think your specific subset example is challenging though: if you thought the context for evaluating the argument to the subsetOf function was <code>use</code>, you'd then be evaluating <code>use.use</code>, which wouldn't make sense.)</p>



<a name="277298175"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277298175" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277298175">(Mar 31 2022 at 15:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="191315">Josh Mandel</span> <a href="#narrow/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60/near/277296052">said</a>:</p>
<blockquote>
<p>(I think your specific subset example is challenging though: if you thought the context for evaluating the argument to the subsetOf function was <code>use</code>, you'd then be evaluating <code>use.use</code>, which wouldn't make sense.)</p>
</blockquote>
<p>Yes, my question is whether <code>Patient.telecom.use.subsetOf(use)</code> should work, just like (I think) you and Bryn are saying <code>Patient.telecom.use.union(use)</code> should work.</p>



<a name="277310538"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277310538" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277310538">(Mar 31 2022 at 16:57)</a>:</h4>
<p>I am aware of two possible interpretations:</p>
<ol>
<li><code>a.b.someFunc(c)</code> evaluates <code>c</code> in the same context that it evaluated <code>a</code> (this is how <code>.union</code> presumably works, and perhaps all functions that take a collection for their argument)</li>
<li><code>a.b.someFunc(c)</code> evaluates <code>b</code> in the context of elements of the <code>a.b</code> collection (this is how <code>.where</code> presumably works, and perhaps all functions that take an expression for their argument)</li>
</ol>
<p>... but I don't see how <code>Patient.telecom.use.subsetOf(use)</code> makes sense in <em>either</em> of these intepretations. (Under (1), the "use" argument would be looking for <code>Patient.use</code>, and  under (2), the "use" argument would be looking for <code>Patient.telecom.use.use</code> -- and neither of these exists.)</p>



<a name="277325693"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277325693" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277325693">(Mar 31 2022 at 19:00)</a>:</h4>
<p>Using the union example, wouldn't you say <code>a.b.union(c)</code> is equivalent to <code>a.b | a.c</code> ?  I did drop the select() call from the original example, which might make a difference.</p>



<a name="277326601"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277326601" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277326601">(Mar 31 2022 at 19:08)</a>:</h4>
<p>Wow, good question. I was assuming <code>a.b | c</code>. What do others expect?</p>



<a name="277326673"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277326673" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277326673">(Mar 31 2022 at 19:09)</a>:</h4>
<p>After some more thought about the effect of select(), I think if one wants the union of a.b and a.c one could write <code>a.select(b | c)</code>, or <code>a.select(b.union(c))</code>,  or <code>a.b.union(a.c)</code>, but not <code>a.b.union(c)</code>.</p>



<a name="277338113"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277338113" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277338113">(Mar 31 2022 at 20:50)</a>:</h4>
<p><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> I'm having trouble with this:</p>
<blockquote>
<p>I don’t see a as the scope for b, a is just an argument, just like b, they are independent of each other.</p>
</blockquote>
<p><code>Patient.name.exists(use = 'nickname')</code> - the scope of use is name<br>
<code>name.select(use.union(given))</code> - the scope of given is name, not use</p>
<p>I don't have any magic that can make this happen in my code unless I make a special rule for union. Or unless I'm just missing the point here</p>



<a name="277338907"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277338907" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277338907">(Mar 31 2022 at 20:57)</a>:</h4>
<p>The only difference I can see is that union takes a "collection" while exists takes an "expression".</p>



<a name="277341521"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277341521" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277341521">(Mar 31 2022 at 21:18)</a>:</h4>
<p>Consider a similar example:<br>
<code>name.select(use.contains(given))</code><br>
The scope of <code>given</code> is still <code>name</code> (and that scope was introduced by the <code>select</code>)</p>



<a name="277341596"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277341596" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277341596">(Mar 31 2022 at 21:19)</a>:</h4>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span> , does your engine have the same issue with this example?</p>



<a name="277348462"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277348462" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277348462">(Mar 31 2022 at 22:28)</a>:</h4>
<p>yes it does. For the same reason. Because scope works consistently for me</p>



<a name="277350656"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277350656" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277350656">(Mar 31 2022 at 22:52)</a>:</h4>
<p>To be clear, Grahame -- are you saying your engine's behavior reflects the behavior you <em>would like</em> the standard to specify?</p>



<a name="277354762"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277354762" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277354762">(Mar 31 2022 at 23:48)</a>:</h4>
<p>I think if we are going to have some functions setting the scope while others do not, there needs to be a clearly stated explanation of why that is.</p>



<a name="277433715"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277433715" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277433715">(Apr 01 2022 at 15:17)</a>:</h4>
<p>The <a href="https://hl7.org/fhirpath/#functions">Functions</a> section specifies that if an argument is typed as an <code>expression</code>, then the function will evaluate the input expression with respect to each item in the input collection, and that these expressions are allowed to refer to the <code>$this</code> and <code>$index</code> variables. We don't explicitly call that a <code>scope</code>, but that is what I've been calling a <code>scope</code> in this discussion. In the CQL engine this is implemented with a runtime stack, and functions that introduce a scope push a $this variable onto that stack, and that variable is allowed to resolve implicitly.</p>



<a name="277434943"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277434943" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277434943">(Apr 01 2022 at 15:25)</a>:</h4>
<p>To me, the implication of that language is that attempting to access <code>$this</code> outside the context of an expression-type argument is an error. Grahame, are you saying that in your engine, I could say: <code>Patient.name.$this</code> and the reference to <code>$this</code> would be allowed, and would return the name?</p>



<a name="277718701"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277718701" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277718701">(Apr 04 2022 at 11:49)</a>:</h4>
<p>no I don't have an issue with expressions and $this, I have an issue that you've described a particular behavior that I don't understand around scope.</p>



<a name="277718839"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277718839" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277718839">(Apr 04 2022 at 11:50)</a>:</h4>
<p>as far I understand, you're saying that scope works differently for these:</p>
<p><code>Patient.name.exists(use = 'nickname')</code><br>
<code>name.select(use.union(given))</code></p>
<p>but I don't know why you think that they're different. My engine can't differentiate them</p>



<a name="277797834"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277797834" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277797834">(Apr 04 2022 at 21:42)</a>:</h4>
<p>They are different because <code>union()</code> doesn't have arguments of type <code>expression</code>. In other words, the arguments to union can both be evaluated prior to invoking the union. Whereas the <code>expression</code> arguments to <code>exists()</code> and <code>select()</code> are evaluated iteratively within the functions.</p>



<a name="277799086"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277799086" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277799086">(Apr 04 2022 at 21:54)</a>:</h4>
<p>I don't follow. to me that's not relevant to my question. In the first case, "use" as parameter to exists() has a scope of name - the thing on which .exists is called. But the in the second case, the parameter to union() does not have the scope of 'use' but of name. Why is that different? I don't see that the .select() bit makes any difference to the evaluation there</p>



<a name="277808363"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277808363" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277808363">(Apr 04 2022 at 23:35)</a>:</h4>
<p><code>use</code> isn't a parameter to the <code>exists()</code> in this example, the expression <code>use = 'nickname'</code> is the parameter. And the reason the <code>select()</code> bit makes a difference is because it's a function with an <code>expression</code> type parameter. Functions that don't have <code>expression</code> type parameters don't introduce an iteration scope.</p>



<a name="277825794"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Context%20for%20%60.union%60/near/277825794" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60.html#277825794">(Apr 05 2022 at 04:16)</a>:</h4>
<p>I had missed that about exists() in my head and in my code</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
