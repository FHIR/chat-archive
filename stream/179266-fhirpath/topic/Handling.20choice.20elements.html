---
layout: page
title: "FHIR Chat  · Handling choice elements · fhirpath"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/index.html">fhirpath</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html">Handling choice elements</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="245937098"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/245937098" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#245937098">(Jul 14 2021 at 09:30)</a>:</h4>
<p>We recently discovered a bug in our .NET implementation where some parts of our infrastructure accept <code>Condition.onsetPeriod = ....</code> where other parts don't.   The spec is very clear about this (<a href="https://hl7.org/fhir/fhirpath.html#polymorphism">https://hl7.org/fhir/fhirpath.html#polymorphism</a>): it should be <code>Condition.onset</code>.   While we were planning to fix this, we noticed the Java implementation <em>also</em> accepts <code>Condition.onsetPeriod</code>, so now we are torn:  stick to the normative spec (and become incompatible with the Java implementation and thus quite some FP statements in the wild) or submit a tracker item to document this in the FP spec (or FHIR appendix) to allow this as some kind of backwards compat behaviour?</p>



<a name="245962310"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/245962310" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#245962310">(Jul 14 2021 at 13:53)</a>:</h4>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span></p>



<a name="246014494"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/246014494" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#246014494">(Jul 14 2021 at 20:19)</a>:</h4>
<p>And would also be interested in the results from the fhirpathjs implementation too</p>



<a name="246014520"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/246014520" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#246014520">(Jul 14 2021 at 20:20)</a>:</h4>
<p>(and Grahame's Delphi version)</p>



<a name="247353748"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/247353748" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#247353748">(Jul 27 2021 at 16:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="191367">Brian Postlethwaite</span> <a href="#narrow/stream/179266-fhirpath/topic/Handling.20choice.20elements/near/246014494">said</a>:</p>
<blockquote>
<p>And would also be interested in the results from the fhirpathjs implementation too</p>
</blockquote>
<p>fhirpath.js would accept onsetPeriod or just onset.   There are some cases when fhirpath.js cannot figure out that the field is a choice type, in which case only the name with the type would work.</p>
<p>I have never seen the advantage of removing the type from the field name (though I concede that is per spec).</p>



<a name="247426683"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/247426683" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#247426683">(Jul 28 2021 at 06:39)</a>:</h4>
<blockquote>
<p>I have never seen the advantage of removing the type from the field name (though I concede that is per spec).</p>
</blockquote>
<p>Because the name of the element in the datamodel (and thus for many, the property name of classes in generated code in C#, Java, Delphi...) is different than the specific serialization of such FHIR choice elements in json and xml.  If FhirPath was going to be used for FHIR only, we could argue they are practically the same, but FhirPath can be (and is) used for other models too, where there is no such mapping to a serialization.  Hence it made more sense to us to keep this "clean" (early version of FhirPath did use the suffixed names, before we had ofType()).</p>



<a name="249678097"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/249678097" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#249678097">(Aug 17 2021 at 04:43)</a>:</h4>
<p><span class="user-mention" data-user-id="191328">@Ewout Kramer</span>  condition.onsetPeriod should not be supported. That's a bug and surely there's a test case for that?</p>



<a name="249820529"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/249820529" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#249820529">(Aug 18 2021 at 08:27)</a>:</h4>
<p>You would think so... What we'll do is that we will fix our engine to be completely strict here, and when we are fixing that bug, we'll make sure there is a testcase for it in the suite.</p>



<a name="250029364"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/250029364" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#250029364">(Aug 19 2021 at 18:43)</a>:</h4>
<p>Late to this party, but I recently noticed that the spec has a few search parameter expression that get this wrong as well.<br>
<a href="/user_uploads/10155/oFf154gy9QpFDfBiud_9fyhK/image.png">image.png</a> </p>
<div class="message_inline_image"><a href="/user_uploads/10155/oFf154gy9QpFDfBiud_9fyhK/image.png" title="image.png"><img src="/user_uploads/10155/oFf154gy9QpFDfBiud_9fyhK/image.png"></a></div><p>Will open a jira ticket to request those to be <code>instantiates as Canonical</code> and <code>instantiates as Uri</code>.</p>



<a name="250030849"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/250030849" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#250030849">(Aug 19 2021 at 18:54)</a>:</h4>
<p><a href="http://jira.hl7.org/browse/FHIR-33214">FHIR#33214</a></p>



<a name="250042844"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/250042844" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#250042844">(Aug 19 2021 at 20:11)</a>:</h4>
<p>those are separate elements in CarePlan</p>



<a name="250572789"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/250572789" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#250572789">(Aug 25 2021 at 02:02)</a>:</h4>
<p>wow, you are totally right. i'm not sure why I was thinking this was a choice type.  i will retract that tracker</p>



<a name="250585803"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/250585803" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#250585803">(Aug 25 2021 at 07:00)</a>:</h4>
<p>Related, this is particularly nasty: <a href="http://hl7.org/fhir/2021May/ingredient.html">http://hl7.org/fhir/2021May/ingredient.html</a></p>
<p>There is both <code>concentration[x]</code> and <code>concentrationHighLimit[x]</code> - I wonder how many "naive" implementations for parsers this will break....</p>



<a name="250585851"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/250585851" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#250585851">(Aug 25 2021 at 07:01)</a>:</h4>
<p>I'm surprised that's OK with the tools. i don't think it's OK and it won't make R5</p>



<a name="250631009"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/250631009" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#250631009">(Aug 25 2021 at 14:51)</a>:</h4>
<p>just had a quick peak and R4B has concentration[x] and concentrationText... is that one ok?</p>



<a name="250642628"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/250642628" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#250642628">(Aug 25 2021 at 16:18)</a>:</h4>
<p>In R4B Ingredient, I see "concentration", but not "concentration[x]", so these 3 elements starting with "concentration" should be OK.</p>



<a name="250669353"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/250669353" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#250669353">(Aug 25 2021 at 19:29)</a>:</h4>
<p>am I in the wrong spot?  <a href="https://build.fhir.org/branches/R4B/ingredient.html">https://build.fhir.org/branches/R4B/ingredient.html</a></p>
<p><a href="/user_uploads/10155/Pgh_q-ayhMbmouaQMoi962Vi/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/10155/Pgh_q-ayhMbmouaQMoi962Vi/image.png" title="image.png"><img src="/user_uploads/10155/Pgh_q-ayhMbmouaQMoi962Vi/image.png"></a></div>



<a name="250674563"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/250674563" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#250674563">(Aug 25 2021 at 20:03)</a>:</h4>
<p>I suspect that <span class="user-mention" data-user-id="191328">@Ewout Kramer</span> was looking at the official R4B ballot: <a href="http://hl7.org/fhir/2021Mar/ingredient.html">http://hl7.org/fhir/2021Mar/ingredient.html</a></p>
<p><a href="/user_uploads/10155/ul_nTV_yyJ-fNXuy98bzJBBy/Ingredient-FHIR-v4.1.0-20210825160217.png">Ingredient-FHIR-v4.1.0-20210825160217.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/10155/ul_nTV_yyJ-fNXuy98bzJBBy/Ingredient-FHIR-v4.1.0-20210825160217.png" title="Ingredient-FHIR-v4.1.0-20210825160217.png"><img src="/user_uploads/10155/ul_nTV_yyJ-fNXuy98bzJBBy/Ingredient-FHIR-v4.1.0-20210825160217.png"></a></div>



<a name="250675365"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/250675365" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#250675365">(Aug 25 2021 at 20:08)</a>:</h4>
<p>Looks like there was a ballot comment complaining about the separate low/high properties and the resolution was to add a choice between Range and RatioRange -- resulting in the current build that <span class="user-mention" data-user-id="191676">@Lee Surprenant</span> noticed.  (JIRA issue w/ resolution to add the choice: <a href="https://jira.hl7.org/browse/FHIR-31821">https://jira.hl7.org/browse/FHIR-31821</a>).</p>



<a name="250711383"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/250711383" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#250711383">(Aug 26 2021 at 02:37)</a>:</h4>
<p>clearly, the name detection clash is failing. <span class="user-mention" data-user-id="191651">@Rik Smithies</span> this is a big deal; the names must be different, and I'll have to figure out why, but please start changing them now.</p>



<a name="250711427"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/250711427" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#250711427">(Aug 26 2021 at 02:38)</a>:</h4>
<p>you cannot have an element name nnn[x] and then any other element that starts with nnn</p>



<a name="250735799"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/250735799" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Maximilian Reith <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#250735799">(Aug 26 2021 at 07:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="191316">Grahame Grieve</span> <a href="#narrow/stream/179266-fhirpath/topic/Handling.20choice.20elements/near/249678097">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="191328">Ewout Kramer</span>  condition.onsetPeriod should not be supported. That's a bug and surely there's a test case for that?</p>
</blockquote>
<p><span class="user-mention silent" data-user-id="191328">Ewout Kramer</span> <a href="#narrow/stream/179266-fhirpath/topic/Handling.20choice.20elements/near/249820529">said</a>:</p>
<blockquote>
<p>You would think so... What we'll do is that we will fix our engine to be completely strict here, and when we are fixing that bug, we'll make sure there is a testcase for it in the suite.</p>
</blockquote>
<p>Which effects could i expect in hl7-Validator and Simplifier-Validator at existing constraints with e.g. condition.onsetPeriod in it? The constraints won't fire or will always fire?</p>



<a name="250736589"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/250736589" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#250736589">(Aug 26 2021 at 07:57)</a>:</h4>
<p>It depends on how you write them. onsertPeriod will be null, and that will propagate according to the rules here <a href="http://hl7.org/fhirpath/N1/#null-and-empty">http://hl7.org/fhirpath/N1/#null-and-empty</a>. A constraint that returns null is a constraint that is not known to be true, and so is considered to have failed</p>



<a name="250843226"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/250843226" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#250843226">(Aug 26 2021 at 21:30)</a>:</h4>
<p>I got around to looking at the tests, and I don't think that this can be true:</p>
<blockquote>
<p>While we were planning to fix this, we noticed the Java implementation also accepts Condition.onsetPeriod</p>
</blockquote>



<a name="250843308"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/250843308" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#250843308">(Aug 26 2021 at 21:30)</a>:</h4>
<p>because there is a test case for that</p>



<a name="250843344"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/250843344" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#250843344">(Aug 26 2021 at 21:30)</a>:</h4>
<div class="codehilite" data-code-language="XML"><pre><span></span><code> <span class="nt">&lt;group</span> <span class="na">name=</span><span class="s">"polymorphics"</span><span class="nt">&gt;</span>
    <span class="c">&lt;!--</span>
<span class="c">      The way FHIRpath works, it treats polymorphic values e.g. Observation.value[x] as</span>
<span class="c">      Observation.value. This catches people out - they often write Observation.valueString.</span>

<span class="c">      For this reason, some engines have a non-strict mode where this is allowed, but it's not</span>
<span class="c">      technical conformant. While this might change in the future, it's not legal in strict mode.</span>
<span class="c">      these tests test this out.</span>
<span class="c">    --&gt;</span>
        <span class="nt">&lt;test</span> <span class="na">name=</span><span class="s">"testPolymorphicsA"</span> <span class="na">inputfile=</span><span class="s">"observation-example.xml"</span><span class="nt">&gt;&lt;expression&gt;</span>Observation.value.exists()<span class="nt">&lt;/expression&gt;&lt;output</span> <span class="na">type=</span><span class="s">"boolean"</span><span class="nt">&gt;</span>true<span class="nt">&lt;/output&gt;&lt;/test&gt;</span>
        <span class="nt">&lt;test</span> <span class="na">name=</span><span class="s">"testPolymorphicsB"</span> <span class="na">inputfile=</span><span class="s">"observation-example.xml"</span><span class="nt">&gt;&lt;expression</span> <span class="na">invalid=</span><span class="s">"semantic"</span><span class="nt">&gt;</span>Observation.valueQuantity.exists()<span class="nt">&lt;/expression&gt;&lt;output</span> <span class="na">type=</span><span class="s">"boolean"</span><span class="nt">&gt;</span>false<span class="nt">&lt;/output&gt;&lt;/test&gt;</span>
        <span class="nt">&lt;modeTest</span> <span class="na">mode=</span><span class="s">"lenient/polymorphics"</span> <span class="na">name=</span><span class="s">"testPolymorphicsC"</span> <span class="na">inputfile=</span><span class="s">"observation-example.xml"</span><span class="nt">&gt;&lt;expression&gt;</span>Observation.valueQuantity.exists()<span class="nt">&lt;/expression&gt;&lt;output</span> <span class="na">type=</span><span class="s">"boolean"</span><span class="nt">&gt;</span>true<span class="nt">&lt;/output&gt;&lt;/modeTest&gt;</span>
        <span class="nt">&lt;modeTest</span> <span class="na">mode=</span><span class="s">"lenient/polymorphics"</span> <span class="na">name=</span><span class="s">"testPolymorphicsD"</span> <span class="na">inputfile=</span><span class="s">"observation-example.xml"</span><span class="nt">&gt;&lt;expression&gt;</span>Observation.valueString.exists()<span class="nt">&lt;/expression&gt;&lt;output</span> <span class="na">type=</span><span class="s">"boolean"</span><span class="nt">&gt;</span>false<span class="nt">&lt;/output&gt;&lt;/modeTest&gt;</span>
  <span class="nt">&lt;/group&gt;</span>
</code></pre></div>



<a name="250843410"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/250843410" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#250843410">(Aug 26 2021 at 21:31)</a>:</h4>
<p>the java FHIRPath implementation acccepts onsetPeriod only if set to lenient mode, and this is only set for the second pair of tests here.</p>



<a name="250843445"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/250843445" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#250843445">(Aug 26 2021 at 21:31)</a>:</h4>
<p>So I don't think that the java implementation should accept onsetPeriod <span class="user-mention" data-user-id="191328">@Ewout Kramer</span></p>



<a name="250906272"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/250906272" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#250906272">(Aug 27 2021 at 09:34)</a>:</h4>
<p>Ah - that's good news. I know we accepted in one of the very first drafts of FhirPath, but that must be years ago.</p>



<a name="251341592"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/251341592" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Maximilian Reith <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#251341592">(Aug 31 2021 at 07:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="191316">Grahame Grieve</span> <a href="#narrow/stream/179266-fhirpath/topic/Handling.20choice.20elements/near/250736589">said</a>:</p>
<blockquote>
<p>It depends on how you write them. onsertPeriod will be null, and that will propagate according to the rules here <a href="http://hl7.org/fhirpath/N1/#null-and-empty">http://hl7.org/fhirpath/N1/#null-and-empty</a>. A constraint that returns null is a constraint that is not known to be true, and so is considered to have failed</p>
</blockquote>
<p>Hmm that's bad for IGs which have relied on the output of the validator. There are a lot of profils which can not be changed in a short time and that change immediately will make them faulty . What about a transition phase in which both approaches will work?</p>



<a name="251341777"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/251341777" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#251341777">(Aug 31 2021 at 07:11)</a>:</h4>
<p>what's an example?</p>



<a name="251342348"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/251342348" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Maximilian Reith <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#251342348">(Aug 31 2021 at 07:18)</a>:</h4>
<p>I will ask them if i could use there example...guess i can reply today</p>



<a name="251373843"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/251373843" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Maximilian Reith <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#251373843">(Aug 31 2021 at 12:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="191316">Grahame Grieve</span> <a href="#narrow/stream/179266-fhirpath/topic/Handling.20choice.20elements/near/251341777">said</a>:</p>
<blockquote>
<p>what's an example?</p>
</blockquote>
<p>okay we have serveral interfaces in which this problem takes place. All of these interfaces are wide spread and cannot be  updated shortly. </p>
<p>e.g. An interface for a certificate of incapacity for work<br>
<a href="https://simplifier.net/eau/kbvpreaubundle">https://simplifier.net/eau/kbvpreaubundle</a></p>
<div class="codehilite"><pre><span></span><code>      &lt;constraint&gt;
        &lt;key value=&quot;angabeAUseitErstbescheinigung&quot; /&gt;
...
        &lt;expression value=&quot;.........**onsetPeriod**.start.exists()        )&quot; /&gt;
        &lt;source value=&quot;https://fhir.kbv.de/StructureDefinition/KBV_PR_EAU_Bundle&quot; /&gt;
      &lt;/constraint&gt;
</code></pre></div>
<p>e.g. An interface for prescriptons<br>
<a href="https://simplifier.net/erezept/kbvprerpprescription">https://simplifier.net/erezept/kbvprerpprescription</a></p>
<div class="codehilite"><pre><span></span><code>      &lt;constraint&gt;
        &lt;key value=&quot;-erp-angabeUnfallbetrieb&quot; /&gt;
...
        &lt;expression value=&quot;extension(&#39;unfallkennzeichen&#39;).**valueCoding**.code = &#39;2&#39; implies extension(&#39;unfallbetrieb&#39;).exists()&quot; /&gt;
        &lt;source value=&quot;https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Prescription&quot; /&gt;
      &lt;/constraint&gt;
</code></pre></div>
<p>e.g. An interface for vaccinations<br>
<a href="https://simplifier.net/im1x0/kbvprmiovaccinationrecordprime">https://simplifier.net/im1x0/kbvprmiovaccinationrecordprime</a></p>
<div class="codehilite"><pre><span></span><code>       &lt;constraint&gt;
        &lt;key value=&quot;Occurrence&quot; /&gt;
....
        &lt;expression value=&quot;**occurrenceDateTime**.toString().length()&amp;gt;=10&quot; /&gt;
        &lt;source value=&quot;https://fhir.kbv.de/StructureDefinition/KBV_PR_MIO_Vaccination_Record_Prime&quot; /&gt;
      &lt;/constraint&gt;
</code></pre></div>
<p>e.g. An interface for medical records for children<br>
<a href="https://simplifier.net/uh1x0/kbvprmiocmrobservationu1u3datetimeofbirth">https://simplifier.net/uh1x0/kbvprmiocmrobservationu1u3datetimeofbirth</a></p>
<div class="codehilite"><pre><span></span><code>      &lt;constraint&gt;
        &lt;key value=&quot;date-1&quot; /&gt;
...
        &lt;expression value=&quot;***valueDateTime***.toString().length()&amp;gt;=16&quot; /&gt;
        &lt;source value=&quot;https://fhir.kbv.de/StructureDefinition/KBV_PR_MIO_CMR_Observation_U1_U3_Date_Time_of_Birth|1.0.1&quot; /&gt;
      &lt;/constraint&gt;
</code></pre></div>
<p>a lot more examples are available....And a lot more interfaces will probably face such problems.</p>
<p>In this case a transition phase up to 01.07.2022 is necessary</p>



<a name="251543038"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/251543038" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Maximilian Reith <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#251543038">(Sep 01 2021 at 11:35)</a>:</h4>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span> <br>
i added your reference afterwards, so it may not have worked. This is an important topic for us.</p>



<a name="251833914"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/251833914" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Maximilian Reith <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#251833914">(Sep 03 2021 at 07:30)</a>:</h4>
<p>By the way: The first bracket looks a bit weird or not?<br>
is <a href="https://www.hl7.org/fhir/fhirpath.html#polymorphism">https://www.hl7.org/fhir/fhirpath.html#polymorphism</a> :<br>
(Observation.value as Quantity).unit</p>
<p>should be?<br>
Observation.(value as Quantity).unit</p>



<a name="251864490"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/251864490" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#251864490">(Sep 03 2021 at 11:21)</a>:</h4>
<blockquote>
<p>Observation.(value as Quantity).unit</p>
</blockquote>
<p>I think not.  <code>as</code> (and <code>in</code>) are both functions <em>and</em> operators in fhirpath.  you could do <code>(Observation.value as Quantity).unit</code> or <code>Observation.value.as(Quantity).unit</code> but <code>Observation.(value as Quantity).unit</code> doesn't look right to me</p>



<a name="252133538"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/252133538" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Maximilian Reith <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#252133538">(Sep 06 2021 at 06:48)</a>:</h4>
<p>okay thanks</p>



<a name="252257434"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/252257434" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Maximilian Reith <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#252257434">(Sep 07 2021 at 06:28)</a>:</h4>
<p>the validator might not work properly in context of an extension</p>
<p>We have a chance to update one of our interfaces, so i tried to correct this constraint:</p>
<p>FHIR-Profile_V1.0.2\KBV_PR_ERP_Prescription_ConstraintsNeu.xml (in attached zip)</p>
<p>In line 599 to 612 two variants of this constraint are available:  </p>
<p>This part is working properly, but this my be outdated in future: <br>
(extension('https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_DosageFlag').empty() or <strong>extension('https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_DosageFlag').value.as(Boolean)</strong>=false) implies text.empty()</p>
<p>The second is not working: <br>
(extension('https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_DosageFlag').empty() or <strong>(extension('https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_DosageFlag').value as Boolean)=false</strong>) implies text.empty()</p>
<p>Version 5.5.1<br>
java -jar validator_cli.jar -ig FHIR-Profile_V1.0.2 -recurse -version 4.0.1 tset1.xml <br>
<a href="/user_uploads/10155/auDhM3V8nfrqt40n5DNH8uIF/FHIR-Profile_V1.0.2.zip">FHIR-Profile_V1.0.2.zip</a></p>



<a name="252493641"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/252493641" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Maximilian Reith <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#252493641">(Sep 08 2021 at 16:45)</a>:</h4>
<p>Could somebody confirm this?</p>



<a name="253230789"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/253230789" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#253230789">(Sep 14 2021 at 10:57)</a>:</h4>
<p>can you provide a whole test case - an instance and a profile?</p>



<a name="253230795"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/253230795" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#253230795">(Sep 14 2021 at 10:57)</a>:</h4>
<p><span class="user-mention" data-user-id="195854">@Maximilian Reith</span></p>



<a name="253367353"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/253367353" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Maximilian Reith <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#253367353">(Sep 15 2021 at 06:11)</a>:</h4>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span> <br>
yes of course. it is already in the attached zip (3 posts up). tset1.xml is the instance and the profile is in the zip too in directory FHIR-Profile_V1.0.2\KBV_PR_ERP_Prescription_ConstraintsNeu.</p>



<a name="253367429"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/253367429" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Maximilian Reith <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#253367429">(Sep 15 2021 at 06:12)</a>:</h4>
<p>just use the mentioned command: java -jar validator_cli.jar -ig FHIR-Profile_V1.0.2 -recurse -version 4.0.1 tset1.xml</p>



<a name="253528934"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/253528934" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Maximilian Reith <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#253528934">(Sep 16 2021 at 04:54)</a>:</h4>
<p>i will provide a test case here: <a href="https://github.com/FHIR/fhir-test-cases/tree/master/validator">https://github.com/FHIR/fhir-test-cases/tree/master/validator</a></p>



<a name="255060132"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/255060132" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Maximilian Reith <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#255060132">(Sep 27 2021 at 14:45)</a>:</h4>
<p>I talked to <span class="user-mention" data-user-id="191451">@Patrick Werner</span> and <span class="user-mention" data-user-id="193430">@Alexander Zautke</span> . They told me a "lenient"-mode is available in HAPI. That would be a solution for us if it supports all type[x] (e.g. value[x], effected[x]) elements. But the lenient-mode needs to be integrated into the cli-validator, before the "hard" type[x]-check is implemented. Even HL7-Germany is affected by this issue.</p>



<a name="274594777"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/Handling%20choice%20elements/near/274594777" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/Handling.20choice.20elements.html#274594777">(Mar 08 2022 at 19:37)</a>:</h4>
<p>(and this one too @Lloyd)<br>
<a href="/user_uploads/10155/lP2gtwjINLzDEXnRPdlsIukN/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/10155/lP2gtwjINLzDEXnRPdlsIukN/image.png" title="image.png"><img src="/user_uploads/10155/lP2gtwjINLzDEXnRPdlsIukN/image.png"></a></div>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
