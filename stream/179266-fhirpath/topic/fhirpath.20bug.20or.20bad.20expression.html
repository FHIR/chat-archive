---
layout: page
title: "FHIR Chat  · fhirpath bug or bad expression · fhirpath"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/index.html">fhirpath</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/fhirpath.20bug.20or.20bad.20expression.html">fhirpath bug or bad expression</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="179625526"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/fhirpath%20bug%20or%20bad%20expression/near/179625526" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/fhirpath.20bug.20or.20bad.20expression.html#179625526">(Nov 01 2019 at 13:26)</a>:</h4>
<p>I've written a fhirpath expression that works on <a href="https://hl7.github.io/fhirpath.js/" target="_blank" title="https://hl7.github.io/fhirpath.js/">https://hl7.github.io/fhirpath.js/</a> but not in the java FhirPath engine implementation. More specifically the following should evaluate to true (and does so on <a href="https://hl7.github.io/fhirpath.js/" target="_blank" title="https://hl7.github.io/fhirpath.js/">https://hl7.github.io/fhirpath.js/</a>):</p>
<div class="codehilite"><pre><span></span>extension.where(&#39;http://ehealth.sundhed.dk/fhir/StructureDefinition/ehealth-responsible&#39;).valueReference in participant.extension.where(&#39;http://ehealth.sundhed.dk/fhir/StructureDefinition/ehealth-ext-careteam&#39;).valueReference or extension.where(&#39;http://ehealth.sundhed.dk/fhir/StructureDefinition/ehealth-responsible&#39;).valueReference in participant.actor.reference
</pre></div>


<p>applied on </p>
<div class="codehilite"><pre><span></span>{
   &quot;resourceType&quot;:&quot;Appointment&quot;,
   &quot;meta&quot;:{
      &quot;profile&quot;:[
         &quot;http://ehealth.sundhed.dk/fhir/StructureDefinition/ehealth-videoappointment&quot;
      ]
   },
   &quot;extension&quot;:[
      {
         &quot;url&quot;:&quot;http://ehealth.sundhed.dk/fhir/StructureDefinition/ehealth-responsible&quot;,
         &quot;valueReference&quot;:{
            &quot;reference&quot;:&quot;http://organization.inttest.ehealth.sundhed.dk/fhir/CareTeam/63d82214-ee30-4e3c-a5d7-efa1a77acb06&quot;
         }
      }
   ],
   &quot;status&quot;:&quot;booked&quot;,
   &quot;appointmentType&quot;:{
      &quot;coding&quot;:[
         {
            &quot;system&quot;:&quot;http://ehealth.sundhed.dk/cs/appointmenttype-codes&quot;,
            &quot;code&quot;:&quot;CHECKUP&quot;
         }
      ]
   },
   &quot;reason&quot;:[
      {
         &quot;coding&quot;:[
            {
               &quot;system&quot;:&quot;http://snomed.info/sct&quot;,
               &quot;code&quot;:&quot;219006&quot;
            }
         ]
      }
   ],
   &quot;description&quot;:&quot;124ba7e4-558e-4cb1-b497-9e78bab45a7a&quot;,
   &quot;start&quot;:&quot;2019-11-01T14:07:20.901+01:00&quot;,
   &quot;end&quot;:&quot;2019-11-01T14:07:20.901+01:00&quot;,
   &quot;participant&quot;:[
      {
         &quot;actor&quot;:{
            &quot;reference&quot;:&quot;http://organization.inttest.ehealth.sundhed.dk/fhir/Practitioner/dc8a1213-99ff-4553-879d-295a0a431e8d&quot;
         },
         &quot;status&quot;:&quot;accepted&quot;
      },
      {
         &quot;actor&quot;:{
            &quot;reference&quot;:&quot;http://organization.inttest.ehealth.sundhed.dk/fhir/Practitioner/54283316-077e-4d71-8280-92256de1ab2c&quot;
         },
         &quot;status&quot;:&quot;accepted&quot;
      },
      {
         &quot;extension&quot;:[
            {
               &quot;url&quot;:&quot;http://ehealth.sundhed.dk/fhir/StructureDefinition/ehealth-ext-careteam&quot;,
               &quot;valueReference&quot;:{
                  &quot;reference&quot;:&quot;http://organization.inttest.ehealth.sundhed.dk/fhir/CareTeam/63d82214-ee30-4e3c-a5d7-efa1a77acb06&quot;
               }
            }
         ]
      }
   ]
}
</pre></div>


<p>Is my expression malformed or is it a bug in the Java implementation?</p>



<a name="179629206"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/fhirpath%20bug%20or%20bad%20expression/near/179629206" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/fhirpath.20bug.20or.20bad.20expression.html#179629206">(Nov 01 2019 at 14:13)</a>:</h4>
<p>apparently rewriting it to </p>
<div class="codehilite"><pre><span></span>(extension(&#39;http://ehealth.sundhed.dk/fhir/StructureDefinition/ehealth-responsible&#39;).first().value.reference in participant.extension(&#39;http://ehealth.sundhed.dk/fhir/StructureDefinition/ehealth-ext-careteam&#39;).first().value.reference) or (extension(&#39;http://ehealth.sundhed.dk/fhir/StructureDefinition/ehealth-responsible&#39;).first().value.reference in participant.actor.reference)
</pre></div>


<p>made it work ... I can't however say how .... ?</p>



<a name="179631740"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/fhirpath%20bug%20or%20bad%20expression/near/179631740" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/fhirpath.20bug.20or.20bad.20expression.html#179631740">(Nov 01 2019 at 14:44)</a>:</h4>
<p>This bit seems incorrect to me: <code>extension.where('http://ehealth.sundhed.dk/fhir/StructureDefinition/ehealth-responsible')</code>, because what this is saying is "extensions where _the string value '<a href="http://." target="_blank" title="http://.">http://.</a>..'", which depending on the strictness of your evaluator will either be interpreted as just "true", or a type error. The expressed passed to the where function is expected to evaluate to a boolean. The rewrite is actually using the <code>extension()</code> function to access the extension.</p>



<a name="179631879"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/fhirpath%20bug%20or%20bad%20expression/near/179631879" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/fhirpath.20bug.20or.20bad.20expression.html#179631879">(Nov 01 2019 at 14:45)</a>:</h4>
<p>the rewrite also encapsulates both sides of the 'or' in parentheses which also seemed necessary</p>



<a name="179632237"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/fhirpath%20bug%20or%20bad%20expression/near/179632237" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/fhirpath.20bug.20or.20bad.20expression.html#179632237">(Nov 01 2019 at 14:49)</a>:</h4>
<p>That bit doesn't seem right to me, you shouldn't need to put that in parentheses to get it to evaluate.</p>



<a name="179634937"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/fhirpath%20bug%20or%20bad%20expression/near/179634937" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jens Villadsen <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/fhirpath.20bug.20or.20bad.20expression.html#179634937">(Nov 01 2019 at 15:21)</a>:</h4>
<p>removing 'first()' was also needed as soon as my test data was expanded</p>



<a name="179640816"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/fhirpath%20bug%20or%20bad%20expression/near/179640816" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/fhirpath.20bug.20or.20bad.20expression.html#179640816">(Nov 01 2019 at 16:26)</a>:</h4>
<p>For the extension.where, I think you need "url=" in front of the URL in the "where" call, like:</p>
<div class="codehilite"><pre><span></span>extension.where(url = &#39;http://ehealth.sundhed.dk/fhir/StructureDefinition/ehealth-responsible&#39;)...
</pre></div>



<a name="179662196"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/fhirpath%20bug%20or%20bad%20expression/near/179662196" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/fhirpath.20bug.20or.20bad.20expression.html#179662196">(Nov 01 2019 at 20:26)</a>:</h4>
<p>you can use either extension.where(url = '') or extension(''') as a short cut. won't work if you mix them. Also, valueReference is not a valid in FHIR Path - it's just value. So value.reference works</p>



<a name="179662580"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/fhirpath%20bug%20or%20bad%20expression/near/179662580" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Lynch <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/fhirpath.20bug.20or.20bad.20expression.html#179662580">(Nov 01 2019 at 20:31)</a>:</h4>
<blockquote>
<p>Also, valueReference is not a valid in FHIR Path - it's just value. </p>
</blockquote>
<p>True, and that is an issue we haven't addressed yet in fhirpath.js, for which valueReference is still necessary.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
