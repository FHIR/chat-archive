---
layout: page
title: "FHIR Chat  · FHIRPath usage question · fhirpath"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/index.html">fhirpath</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/FHIRPath.20usage.20question.html">FHIRPath usage question</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="153956675"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/FHIRPath%20usage%20question/near/153956675" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/FHIRPath.20usage.20question.html#153956675">(May 07 2018 at 19:21)</a>:</h4>
<p>Hi all,<br>
FHIRPath-newbee-question:<br>
 I have a definition for billing code 30110 in a ChargeItem resource that may not be billed in combination with the code 13250. So I need to make sure, the code 13250 does not appear in the current ChargeItem's Account. %context is supposed to be replaced with the instance of the  ChargeItem I want to validate at runtime.</p>
<div class="codehilite"><pre><span></span>    <span class="nt">&lt;applicability&gt;</span>
        <span class="nt">&lt;description</span> <span class="na">value=</span><span class="s">&quot;Exclude: 13250&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;language</span> <span class="na">value=</span><span class="s">&quot;text/fhirpath&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;expression</span> <span class="na">value=</span><span class="s">&quot;ChargeItem.where(code=&#39;http://fhir.de/CodingSystem/kbv/ebm|13250&#39; and account=%context.account).count() = 0&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/applicability&gt;</span>
</pre></div>


<p>My syntax may be way off, but before dive deeper into the FHIRPath spec to I refine it: is this generally something you could do using FHIRPath without breaking it? Or am I too far gone here...?</p>



<a name="153956740"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/FHIRPath%20usage%20question/near/153956740" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/FHIRPath.20usage.20question.html#153956740">(May 07 2018 at 20:10)</a>:</h4>
<p>The difficulty will be accessing other ChargeItems from the FHIRPath. If there's a reference in the current element, you could resolve it. Where will this expression be defined?</p>



<a name="153956746"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/FHIRPath%20usage%20question/near/153956746" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/FHIRPath.20usage.20question.html#153956746">(May 07 2018 at 20:24)</a>:</h4>
<p>Seeing the context for this question over on the conformance thread, yes, FHIRPath accesses through a specific resource provided to the evaluation as context. So you could express this with a CQL expression, but you'd have to use a retrieve:</p>



<a name="153956748"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/FHIRPath%20usage%20question/near/153956748" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/FHIRPath.20usage.20question.html#153956748">(May 07 2018 at 20:25)</a>:</h4>
<div class="codehilite"><pre><span></span>not exists ([ChargeItem: &quot;13250&quot;])
</pre></div>



<a name="153956826"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/FHIRPath%20usage%20question/near/153956826" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/FHIRPath.20usage.20question.html#153956826">(May 07 2018 at 21:53)</a>:</h4>
<blockquote>
<p>The difficulty will be accessing other ChargeItems from the FHIRPath. If there's a reference in the current element, you could resolve it. Where will this expression be defined?</p>
</blockquote>
<p>That's where I'm unsure too. There are going to be multiple ChargeItems referencing one Account. The context for the FHIRpath expression is one of these ChargeItems. It does have a direct reference to the Account, but not to any of the other ChargeItems. So I basically need to do a search for all ChargeItems which reference the same account as the one I'm evaluating from.<br>
So I'm not sure if this: <br>
ChargeItem.where(code='<a href="http://fhir.de/CodingSystem/kbv/ebm|13250" target="_blank" title="http://fhir.de/CodingSystem/kbv/ebm|13250">http://fhir.de/CodingSystem/kbv/ebm|13250</a>' and account=%context.account)<br>
is legitimate.</p>
<p>I'm currently building the ChargeItemDefinition resource, that's where the rules will live...</p>



<a name="153956876"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/FHIRPath%20usage%20question/near/153956876" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/FHIRPath.20usage.20question.html#153956876">(May 08 2018 at 05:05)</a>:</h4>
<p>so there's a reason why invariants don't include language support for searching other resources - there's all sorts of reasons why you wouldn't have access to them</p>



<a name="153956877"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/FHIRPath%20usage%20question/near/153956877" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/FHIRPath.20usage.20question.html#153956877">(May 08 2018 at 05:05)</a>:</h4>
<p>if you really want to make rules like this, the nearest we have to it is a graph definition</p>



<a name="153956891"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/FHIRPath%20usage%20question/near/153956891" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/FHIRPath.20usage.20question.html#153956891">(May 08 2018 at 06:36)</a>:</h4>
<p>Could CQL handle this <span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> ?</p>



<a name="153956898"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/FHIRPath%20usage%20question/near/153956898" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/FHIRPath.20usage.20question.html#153956898">(May 08 2018 at 07:30)</a>:</h4>
<p>So, following your suggestion, <span class="user-mention" data-user-id="191316">@Grahame Grieve</span> , I'd establish the context  by creating a Bundle of all resources the fhirpath expression needs, using a graphQL expression.<br>
Like this...?</p>
<div class="codehilite"><pre><span></span>    <span class="nt">&lt;applicability&gt;</span>
        <span class="nt">&lt;description</span> <span class="na">value=</span><span class="s">&quot;Exclude: 13250&quot;</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!-- create a Bundle of all ChargeItems in the same Account as the current ChargeItem--&gt;</span>
        <span class="nt">&lt;context</span> <span class="na">value=</span><span class="s">&quot;ChargeItem {account:Account { search ChargeItem?account={ref}}&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;language</span> <span class="na">value=</span><span class="s">&quot;text/fhirpath&quot;</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!--evaluate expression in context of the Bundle--&gt;</span>
        <span class="nt">&lt;expression</span> <span class="na">value=</span><span class="s">&quot;%context.entry.resource.where(code=&#39;http://fhir.de/CodingSystem/kbv/ebm|13250&#39;).count() = 0&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/applicability&gt;</span>
</pre></div>



<a name="153956932"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/FHIRPath%20usage%20question/near/153956932" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/FHIRPath.20usage.20question.html#153956932">(May 08 2018 at 13:14)</a>:</h4>
<p><span class="user-mention" data-user-id="191450">@Simone Heckmann</span> , yes, CQL allows access to resources, either server-wide or filtered to a particular patient.</p>



<a name="153956951"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/FHIRPath%20usage%20question/near/153956951" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/FHIRPath.20usage.20question.html#153956951">(May 08 2018 at 14:33)</a>:</h4>
<p>Thanks, <span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> ! I guess I really ned to start reading the CQL spec ;-)<br>
What I'm still having issues understanding: How do you e.g. pass context (patient, encounter...) that is given as parameters to the $apply-operation into the CQL expressions in PlanDefinition? Is there a syntax for that?</p>



<a name="153956961"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/FHIRPath%20usage%20question/near/153956961" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/FHIRPath.20usage.20question.html#153956961">(May 08 2018 at 14:49)</a>:</h4>
<p>CQL defines a Patient context that is expected to be supplied by the evaluation environment. You can access that context within CQL using "Patient" as an identifier, and when you're in Patient context, all resources returned are filtered to that Patient.</p>



<a name="153956963"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/FHIRPath%20usage%20question/near/153956963" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/FHIRPath.20usage.20question.html#153956963">(May 08 2018 at 14:50)</a>:</h4>
<p>The implementation of the $apply-operation then uses the value of the patient parameter to provide that context to the evaluation.</p>



<a name="153957096"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/FHIRPath%20usage%20question/near/153957096" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/FHIRPath.20usage.20question.html#153957096">(May 09 2018 at 04:20)</a>:</h4>
<p><span class="user-mention" data-user-id="191450">@Simone Heckmann</span> perhaps you can define for me what you're trying to do - CQL doesn't have the entry point it sounds like you want. and I suggested to use  GraphDefinition, not GraphQL. They're very different things. But I think that the real problem you have is that you are trying to say is not sensible.</p>



<a name="153957122"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/FHIRPath%20usage%20question/near/153957122" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/FHIRPath.20usage.20question.html#153957122">(May 09 2018 at 08:36)</a>:</h4>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span> <br>
ok, so in a ChargeItemDefinition, we're basically keeping stuff like prices or point values for billing codes or products.<br>
There may be surcharges/discounts that apply in certain conditions or the price may vary over time.<br>
Some billing codes may not be applicable at all in a certain scenario.</p>
<p>So, what I'm trying to do is to create an operation "$apply" consitent with the other definitional resources, that checks if an instance of a ChargeItem is applicable and returns the calculated price based with all applicable surcharges/discounts.</p>
<p>I believe in terms of logic involved this is pretty much the same thing as what PlanDefinition is doing. So I try to model ChargeItemDefinition consistently.</p>
<p>FHIRPath will work perfectly fine for conditions like:<br>
- code only applicable for inpatient encounter<br>
- discount only applicable for minors<br>
- surcharge applies for certain coverage types ...<br>
because all of these informations are directly or indirectly linked from the ChargeItem resource.</p>
<p>Problem is if I need to evaluate conditions that apply to stuff that's <em>not</em> linked from ChargeItem, like collisions with other ChargeItems in the same Account, or existence of certain diagnosis for the patient...</p>
<p>BTW, I meant to use "a text short hand form for GraphDefinition, loosely based on the graphQL language." rather than "graphQL" ;-)</p>



<a name="153957127"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/FHIRPath%20usage%20question/near/153957127" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/FHIRPath.20usage.20question.html#153957127">(May 09 2018 at 09:22)</a>:</h4>
<blockquote>
<p>The implementation of the $apply-operation then uses the value of the patient parameter to provide that context to the evaluation.</p>
</blockquote>
<p><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span>  ...but this isn't stated explicitly. The implementation "just knows" that it needs to do that. Because it isn't really <em>that</em> obvious to me since the $apply operation has many more parameters like encounter, practitioner etc. I would assume that many CQL expressions need the ecounter context as well, since it can't be inferred from the Patient resource. :thinking_face:</p>



<a name="153957156"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/FHIRPath%20usage%20question/near/153957156" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/FHIRPath.20usage.20question.html#153957156">(May 09 2018 at 12:13)</a>:</h4>
<p>This to me is feeling like its getting closer to server internal business rules, that might be better just described in narrative.</p>



<a name="153957158"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/FHIRPath%20usage%20question/near/153957158" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/FHIRPath.20usage.20question.html#153957158">(May 09 2018 at 12:29)</a>:</h4>
<p>Hm. Isn't this the same kind of rules the Clinical Reasoning Module is tackling right now?<br>
Also, I think there is a real world need for being able to distribute these kind of rules from those who make them (Payers) to those who implement them (EHR vendors) in a machine readable, standardized way. <br>
I don't assume that this is going to happen any time soon, but being able to show that this is something you <em>could</em> do with FHIR is an important sales pitch if we want vendors to adopt the FM module.</p>



<a name="153957440"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/FHIRPath%20usage%20question/near/153957440" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/FHIRPath.20usage.20question.html#153957440">(May 09 2018 at 21:38)</a>:</h4>
<p>you're certainly outside the scope of FHIRPath, which is a query language. It's a logical part of what you're doing, just like it's a part of all sorts of things we do, including CQL.</p>



<a name="153957441"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/FHIRPath%20usage%20question/near/153957441" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/FHIRPath.20usage.20question.html#153957441">(May 09 2018 at 21:39)</a>:</h4>
<p>I'm also not sure it's CQL either</p>



<a name="153957447"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/FHIRPath%20usage%20question/near/153957447" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/FHIRPath.20usage.20question.html#153957447">(May 10 2018 at 01:08)</a>:</h4>
<p><span class="user-mention" data-user-id="191450">@Simone Heckmann</span> I think you're right that this is an area that is not clear. We do say in the documentation of the $apply operation that CQL parameters defined in libraries referenced by the PlanDefinition are bound by name to the parameters of the operation, but we don't explicitly define how that relates to CQL context. I suggest that you could rely on that parameter-name binding behavior and use the name of the operation parameters in your condition expression. If you wanted to submit a tracker to clarify, that would be fantastic too.</p>



<a name="153963203"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/FHIRPath%20usage%20question/near/153963203" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simone Heckmann <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/FHIRPath.20usage.20question.html#153963203">(May 17 2018 at 12:09)</a>:</h4>
<p><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> following a discussion in PA/FM joint meeting today, I added a tracker item to suggest the introduction of a MetaDataType to harmonize the usage of machine readable expressions across resources: <a href="http://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=17227" target="_blank" title="http://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=17227">GF#17227</a><br>
This also contains a request for making the mechanisms of establishing the context more expressive.</p>



<a name="153963236"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179266-fhirpath/topic/FHIRPath%20usage%20question/near/153963236" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179266-fhirpath/topic/FHIRPath.20usage.20question.html#153963236">(May 17 2018 at 13:10)</a>:</h4>
<p>I think that's a great idea, it would keep representation consistent across the spec. I'd also like to see it as a type that can be used in an extension, though I understand that represents additional work for implementations.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
