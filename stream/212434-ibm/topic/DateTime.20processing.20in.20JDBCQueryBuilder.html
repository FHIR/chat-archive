---
layout: page
title: "FHIR Chat  · DateTime processing in JDBCQueryBuilder · ibm"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/index.html">ibm</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html">DateTime processing in JDBCQueryBuilder</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="179003307"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179003307" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179003307">(Oct 24 2019 at 22:17)</a>:</h4>
<p>Paul did some work to get our tests running in Java 11, but I have some local edits to JDBCWholeSystemSeardchTest that I believe to be confirming that we have an issue with our datetime processing</p>



<a name="179005158"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179005158" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179005158">(Oct 24 2019 at 22:39)</a>:</h4>
<p>I opened <a href="https://github.com/IBM/FHIR/issues/305" target="_blank" title="https://github.com/IBM/FHIR/issues/305">https://github.com/IBM/FHIR/issues/305</a> for this issue, but we can discuss it here</p>



<a name="179008490"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179008490" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Bastide <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179008490">(Oct 24 2019 at 23:33)</a>:</h4>
<p>I have many of the same questions as you</p>



<a name="179010687"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179010687" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179010687">(Oct 25 2019 at 00:10)</a>:</h4>
<p>I opened <a href="https://github.com/IBM/FHIR/pull/306/files" target="_blank" title="https://github.com/IBM/FHIR/pull/306/files">https://github.com/IBM/FHIR/pull/306/files</a> with what seems to be the fix. Not totally sure why it was failing in Java 11 and not Java 8, but we basically just need to avoid using Date when processing the search parameter value.</p>



<a name="179010853"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179010853" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179010853">(Oct 25 2019 at 00:14)</a>:</h4>
<p>Open question:  what should be the behavior when an instant/dateTime has<br>
some number of ms digits and the search has less precision?<br>
This PR introduces tests for this scenario too, but I've commented them out for now. Should we handle it as part of #305 or open some issue for the future?</p>



<a name="179010873"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179010873" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Bastide <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179010873">(Oct 25 2019 at 00:15)</a>:</h4>
<p>Good question... it's a hard one need to think about the various scenarios</p>



<a name="179010885"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179010885" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179010885">(Oct 25 2019 at 00:15)</a>:</h4>
<p>i think my second commit to <a href="https://github.com/IBM/FHIR/pull/306" target="_blank" title="https://github.com/IBM/FHIR/pull/306">https://github.com/IBM/FHIR/pull/306</a> outlines the scenarios pretty well: <a href="https://github.com/IBM/FHIR/pull/306/commits/64ab697f7dd7cf034628a5dfc7048b5314151851" target="_blank" title="https://github.com/IBM/FHIR/pull/306/commits/64ab697f7dd7cf034628a5dfc7048b5314151851">https://github.com/IBM/FHIR/pull/306/commits/64ab697f7dd7cf034628a5dfc7048b5314151851</a></p>



<a name="179010940"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179010940" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179010940">(Oct 25 2019 at 00:16)</a>:</h4>
<p>the commented out tests are the ones that are failing now</p>



<a name="179010951"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179010951" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Bastide <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179010951">(Oct 25 2019 at 00:17)</a>:</h4>
<p>&lt;check/&gt;</p>



<a name="179011019"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179011019" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179011019">(Oct 25 2019 at 00:18)</a>:</h4>
<p>in my opinion, those should all be passing.  to make it happen, i think we'd need to handle almost every search as an implicit range.  so <code>_lastUpdated=2019-01-01T12:00:01Z</code> should become  <code>WHERE x &gt;= 2019-01-01 12:00:01 AND x &lt; 2019-01-01 12:00:02</code></p>



<a name="179011042"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179011042" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179011042">(Oct 25 2019 at 00:18)</a>:</h4>
<p>we'd only use "exact match" semantics for search parameter values with a full 6 digit ms field</p>



<a name="179011056"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179011056" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Bastide <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179011056">(Oct 25 2019 at 00:19)</a>:</h4>
<p>right we'll have to do some dance to build the range</p>



<a name="179011062"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179011062" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179011062">(Oct 25 2019 at 00:19)</a>:</h4>
<p>we already do similar for computing the end date of implicit ranges for Year, Month, and Day precision</p>



<a name="179011071"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179011071" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179011071">(Oct 25 2019 at 00:19)</a>:</h4>
<p><a href="https://www.hl7.org/fhir/search.html#date" target="_blank" title="https://www.hl7.org/fhir/search.html#date">https://www.hl7.org/fhir/search.html#date</a> is pretty clear with those</p>



<a name="179011115"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179011115" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179011115">(Oct 25 2019 at 00:20)</a>:</h4>
<p>its just odd that it doesn't even mention fractional seconds</p>



<a name="179011187"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179011187" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179011187">(Oct 25 2019 at 00:20)</a>:</h4>
<p>in fact, if you strictly adhered to the description in this section, you'd think fractional seconds aren't even allowed</p>



<a name="179011189"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179011189" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179011189">(Oct 25 2019 at 00:21)</a>:</h4>
<blockquote>
<p>The date parameter format is yyyy-mm-ddThh:mm:ss[Z|(+|-)hh:mm] (the standard XML format).</p>
</blockquote>



<a name="179011348"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179011348" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179011348">(Oct 25 2019 at 00:23)</a>:</h4>
<p>but then the very next paragraph says </p>
<blockquote>
<p>Any degree of precision can be provided</p>
</blockquote>



<a name="179012536"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179012536" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179012536">(Oct 25 2019 at 00:40)</a>:</h4>
<p>on a related note, i think we actually lose precision of these fractional seconds in the model:</p>
<div class="codehilite"><pre><span></span>Basic basic = Basic.builder()
    .code(CodeableConcept.builder().text(string(&quot;test&quot;)).build())
    .extension(Extension.builder()
        .url(&quot;http://example.com&quot;)
        .value(DateTime.of(&quot;0001-01-01T01:01:01.100000Z&quot;))
        .build())
    .build();
System.out.println(basic);
</pre></div>


<div class="codehilite"><pre><span></span>{
    &quot;resourceType&quot;: &quot;Basic&quot;,
    &quot;extension&quot;: [
        {
            &quot;url&quot;: &quot;http://example.com&quot;,
            &quot;valueDateTime&quot;: &quot;0001-01-01T01:01:01.1Z&quot;
        }
    ],
    &quot;code&quot;: {
        &quot;text&quot;: &quot;test&quot;
    }
}
</pre></div>



<a name="179012557"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179012557" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179012557">(Oct 25 2019 at 00:40)</a>:</h4>
<p>i.e. no way to determine the number of digits provided from a parsed dateTime</p>



<a name="179012559"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179012559" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Bastide <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179012559">(Oct 25 2019 at 00:40)</a>:</h4>
<p>interesting, probably not preferred</p>



<a name="179012570"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179012570" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179012570">(Oct 25 2019 at 00:41)</a>:</h4>
<p>i doubt it matters much for 99% of use cases</p>



<a name="179012574"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179012574" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Bastide <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179012574">(Oct 25 2019 at 00:41)</a>:</h4>
<p>I think John gave me some code to do so using parseBest</p>



<a name="179012575"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179012575" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179012575">(Oct 25 2019 at 00:41)</a>:</h4>
<p>but still interesting</p>



<a name="179012728"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179012728" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179012728">(Oct 25 2019 at 00:44)</a>:</h4>
<p>it just means we can't tell the difference between a search for <code>0001-01-01T01:01:01.1Z</code> (which i'd like to handle as <code>x &gt;= 0001-01-01T01:01:01.1Z and x &lt; 0001-01-01T01:01:01.2Z</code>) vs <code>0001-01-01T01:01:01.100000Z</code> (which should only match if x is exactly <code>0001-01-01T01:01:01.100000Z</code>)</p>



<a name="179052831"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179052831" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179052831">(Oct 25 2019 at 14:12)</a>:</h4>
<p>I spoke with <span class="user-mention" data-user-id="192334">@John Timm</span> on this one and here's what I'm thinking we should do:</p>
<ol>
<li>continue storing fractional seconds in db</li>
<li>convert hh:mm:ss query param value into range queries on the db (e.g. [01:01:01,01:01:02))</li>
<li>continue to allow searches to come in with fractional seconds, and treat those as "exact matches" with infinite precision (01:01:01.1 would not find 01:01:01.100001)</li>
</ol>



<a name="179083110"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179083110" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179083110">(Oct 25 2019 at 19:52)</a>:</h4>
<p><span class="user-mention" data-user-id="192334">@John Timm</span> <span class="user-mention" data-user-id="192632">@Paul Bastide</span> I just pushed an update that implements this proposal:  <a href="https://github.com/IBM/FHIR/pull/307" target="_blank" title="https://github.com/IBM/FHIR/pull/307">https://github.com/IBM/FHIR/pull/307</a><br>
I also updated the Conformance.md to document the behavior.  Please review when you have a minute.</p>



<a name="179083265"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179083265" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Bastide <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179083265">(Oct 25 2019 at 19:54)</a>:</h4>
<p>LGTM</p>



<a name="179085286"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/DateTime%20processing%20in%20JDBCQueryBuilder/near/179085286" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/DateTime.20processing.20in.20JDBCQueryBuilder.html#179085286">(Oct 25 2019 at 20:17)</a>:</h4>
<p>merged</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
