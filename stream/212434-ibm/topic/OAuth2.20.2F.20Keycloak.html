---
layout: page
title: "FHIR Chat  · OAuth2 / Keycloak · ibm"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/index.html">ibm</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/OAuth2.20.2F.20Keycloak.html">OAuth2 / Keycloak</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="216480297"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/OAuth2%20/%20Keycloak/near/216480297" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cornelius Erbelding <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/OAuth2.20.2F.20Keycloak.html#216480297">(Nov 12 2020 at 15:08)</a>:</h4>
<p>Hi,<br>
as described in <a href="https://github.com/IBM/FHIR/issues/1703">this Issue</a>, i'm trying to use Keycloak as Authentification provider. <br>
It works via browser, but via CLI or Postman, (providing previously generated Bearer-Token) it only returns </p>
<div class="codehilite" data-code-language="HTML"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">"http://www.w3.org/1999/xhtml"</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/javascript"</span> <span class="na">language</span><span class="o">=</span><span class="s">"javascript"</span><span class="p">&gt;</span>
        <span class="kd">var</span> <span class="nx">loc</span><span class="o">=</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="o">=</span><span class="s2">"WASReqURLOidcn221075362="</span><span class="o">+</span><span class="nx">loc</span><span class="o">+</span><span class="s2">"; path=/;"</span>
    <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/javascript"</span> <span class="na">language</span><span class="o">=</span><span class="s">"javascript"</span><span class="p">&gt;</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">"https:// MYURL :8443/auth/realms/fhir/protocol/openid-connect/auth?response_type=code&amp;client_id=fhir_service&amp;state=001605193369358RtvBAm8no&amp;redirect_uri=https%3A%2F%2F MYURL %3A9443%2Foidcclient%2Fredirect%2Ffhir_service&amp;scope=openid+profile"</span><span class="p">)</span>
    <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Redirect To OP<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>

<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
<p>Maybe it's no bug, but instead some type of misconfiguration at FHIR, Keycloak or Postman?</p>
<p>Thanks a lot!<br>
Cornelius</p>



<a name="216502848"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/OAuth2%20/%20Keycloak/near/216502848" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/OAuth2.20.2F.20Keycloak.html#216502848">(Nov 12 2020 at 17:46)</a>:</h4>
<p>Thanks Cornelius, your timing is good because I've been meaning to document how to do this for a while...</p>



<a name="216502929"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/OAuth2%20/%20Keycloak/near/216502929" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/OAuth2.20.2F.20Keycloak.html#216502929">(Nov 12 2020 at 17:47)</a>:</h4>
<p>and thanks for linking your report to those open issues, it helped me identify #1672 as a duplicate of <a href="https://github.com/IBM/FHIR/issues/1546">https://github.com/IBM/FHIR/issues/1546</a> :-)</p>



<a name="216503132"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/OAuth2%20/%20Keycloak/near/216503132" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/OAuth2.20.2F.20Keycloak.html#216503132">(Nov 12 2020 at 17:48)</a>:</h4>
<p>so what I've settled in on for our deployment is using the <code>mpJwt</code> liberty feature instead of the <code>openidConnectClient</code> one</p>



<a name="216503401"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/OAuth2%20/%20Keycloak/near/216503401" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/OAuth2.20.2F.20Keycloak.html#216503401">(Nov 12 2020 at 17:51)</a>:</h4>
<p>here's a sample config snippet that you could try dropping into <code>fhir-server/configDropins/overrides</code>:</p>
<div class="codehilite"><pre><span></span><code>&lt;server&gt;
    &lt;featureManager&gt;
        &lt;!-- mpJwt-1.1 is already enabled in the default server.xml, but it doesn&#39;t hurt to repeat it here --&gt;
        &lt;feature&gt;mpJwt-1.1&lt;/feature&gt;
    &lt;/featureManager&gt;

    &lt;!-- Override the application-bnd binding of the main webapp --&gt;
    &lt;webApplication contextRoot=&quot;fhir-server/api/v4&quot; id=&quot;fhir-server-webapp&quot; location=&quot;fhir-server.war&quot; name=&quot;fhir-server-webapp&quot;&gt;
        &lt;application-bnd id=&quot;bind&quot;&gt;
            &lt;security-role id=&quot;users&quot; name=&quot;FHIRUsers&quot;&gt;
                &lt;group id=&quot;usersGroup&quot; access-id=&quot;group:https://host/auth/realms/${env.KEYCLOAK_REALM}/fhirUser&quot;/&gt;
            &lt;/security-role&gt;
        &lt;/application-bnd&gt;
    &lt;/webApplication&gt;

    &lt;!-- The MP JWT configuration that injects the caller&#39;s JWT into a
         ResourceScoped bean for inspection. --&gt;
    &lt;mpJwt id=&quot;jwtConsumer&quot;
           jwksUri=&quot;http://host/auth/realms/${env.KEYCLOAK_REALM}/protocol/openid-connect/certs&quot;
           audiences=&quot;https://host/fhir-server/api/v4&quot;
           userNameAttribute=&quot;sub&quot;
           groupNameAttribute=&quot;group&quot;
           issuer=&quot;https://host/auth/realms/${env.KEYCLOAK_REALM}&quot;
           signatureAlgorithm=&quot;RS256&quot;
           authFilterRef=&quot;filter&quot;/&gt;

    &lt;authFilter id=&quot;filter&quot;&gt;
        &lt;requestUrl urlPattern=&quot;/fhir-server&quot; /&gt;
    &lt;/authFilter&gt;
&lt;/server&gt;
</code></pre></div>



<a name="216503586"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/OAuth2%20/%20Keycloak/near/216503586" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/OAuth2.20.2F.20Keycloak.html#216503586">(Nov 12 2020 at 17:52)</a>:</h4>
<p>note that here we're actually using an additional claim called <code>group</code> to assign the user to our FHIRUsers security-role</p>



<a name="216503677"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/OAuth2%20/%20Keycloak/near/216503677" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/OAuth2.20.2F.20Keycloak.html#216503677">(Nov 12 2020 at 17:53)</a>:</h4>
<p>hopefully that helps (until i can get to providing better doc)</p>



<a name="216503848"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/OAuth2%20/%20Keycloak/near/216503848" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/OAuth2.20.2F.20Keycloak.html#216503848">(Nov 12 2020 at 17:54)</a>:</h4>
<p>also, i'm guessing there is a way to do this with the liberty openidConnect features as well; I think I just ended up down this path because I wanted to get the JWT injected into our JAX-RS stuff for something</p>



<a name="216572094"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/OAuth2%20/%20Keycloak/near/216572094" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cornelius Erbelding <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/OAuth2.20.2F.20Keycloak.html#216572094">(Nov 13 2020 at 06:31)</a>:</h4>
<p>Dear <span class="user-mention" data-user-id="191676">@Lee Surprenant</span> , thanks for your help. <br>
As far as I can see, this would be the <a href="https://github.com/IBM/FHIR/blob/master/fhir-server/liberty-config/configDropins/disabled/keycloakRP.xml"><code>keycloakRP.xml</code></a> Dropin from the  Smart-FHIR component, right? <br>
I'm assuming, the <a href="https://github.com/IBM/FHIR/blob/master/fhir-server/liberty-config/configDropins/disabled/oauthResourceServer.xml"><code>
oauthResourceServer.xml </code></a> dropin should be disabled / replaced by the one above.</p>
<p>I will try this solution and get back to you as soon as there is something to report.</p>



<a name="216599620"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/OAuth2%20/%20Keycloak/near/216599620" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/OAuth2.20.2F.20Keycloak.html#216599620">(Nov 13 2020 at 11:45)</a>:</h4>
<p>That’s right,  But for this to work you’ll need to make sure your users in keycloak belong to a group called “fhirUser”</p>



<a name="216599822"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/OAuth2%20/%20Keycloak/near/216599822" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/OAuth2.20.2F.20Keycloak.html#216599822">(Nov 13 2020 at 11:47)</a>:</h4>
<p>And configure keycloak with an audience mapper which sets the aud claim to match what the FHIR server expects</p>



<a name="216995621"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/OAuth2%20/%20Keycloak/near/216995621" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cornelius Erbelding <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/OAuth2.20.2F.20Keycloak.html#216995621">(Nov 17 2020 at 12:23)</a>:</h4>
<p>I managed to get it running. <br>
I wrote all necessary configurations into the <a href="https://github.com/IBM/FHIR/issues/1703">GitHub Issue #1703</a> for all other users facing the same problem.</p>
<p>Sadly, after enabling the token-based authorization, Browser-Access (with the desired redirect to Keycloak-Login) doesn't work anymore. <br>
Normally, the option <code>inboundPropagation="supported"</code> should issue a redirect to Keycloak-Login-UI if no token or invalid token is supplied. (while <code>inboundPropagation="required"</code> ignores missing/invalid tokens)</p>



<a name="216996211"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/OAuth2%20/%20Keycloak/near/216996211" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/OAuth2.20.2F.20Keycloak.html#216996211">(Nov 17 2020 at 12:30)</a>:</h4>
<p>awesome.  you don't mind if we nab some of that content for the documentation (<a href="https://github.com/IBM/FHIR/issues/1546">https://github.com/IBM/FHIR/issues/1546</a>) do you?</p>
<p>Are you sure that <code>inboundPropagation="required"</code> ignores missing/invalid tokens?  I really thought it errored out in those cases (but agree that it doesn't redirect).</p>



<a name="217000428"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/OAuth2%20/%20Keycloak/near/217000428" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cornelius Erbelding <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/OAuth2.20.2F.20Keycloak.html#217000428">(Nov 17 2020 at 13:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="191676">Lee Surprenant</span> <a href="#narrow/stream/212434-ibm/topic/OAuth2.20.2F.20Keycloak/near/216996211">said</a>:</p>
<blockquote>
<p>awesome.  you don't mind if we nab some of that content for the documentation (<a href="https://github.com/IBM/FHIR/issues/1546">https://github.com/IBM/FHIR/issues/1546</a>) do you?</p>
</blockquote>
<p>No problem. Since I had to do the documentation for our project anyway, I thought I can do something good for other users and you and provide the whole thing.</p>
<p><span class="user-mention silent" data-user-id="191676">Lee Surprenant</span> <a href="#narrow/stream/212434-ibm/topic/OAuth2.20.2F.20Keycloak/near/216996211">said</a>:</p>
<blockquote>
<p>Are you sure that <code>inboundPropagation="required"</code> ignores missing/invalid tokens?  I really thought it errored out in those cases (but agree that it doesn't redirect).</p>
</blockquote>
<p>You're right, it leads to an error. As written at point 12 of the <a href="https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_config_oidc_rp.html">OpenID Configuration Guide</a>:</p>
<blockquote>
<p>Optional: You can configure an OpenID Connect Client to optionally accept a valid OAuth 2.0 bearer access token as an authentication token without redirecting the request to an OpenID Connect provider. If a request contains a valid OAuth 2.0 bearer access token, then the Liberty OpenID Connect Client will automatically validate the access token, and create an authenticated subject based on the token validation result. If the request does not contain an access token or the access token is invalid, then the Liberty OpenID Connect Client continues to redirect the user to an OpenID Connect provider. This function enables the Liberty server to serve both the browser client and non-browser client like a RESTful client. You can add inboundPropagation="supported" to the configuration to enable this function.</p>
</blockquote>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
