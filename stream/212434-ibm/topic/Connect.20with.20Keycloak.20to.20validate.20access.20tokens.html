---
layout: page
title: "FHIR Chat  · Connect with Keycloak to validate access tokens · ibm"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/index.html">ibm</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/Connect.20with.20Keycloak.20to.20validate.20access.20tokens.html">Connect with Keycloak to validate access tokens</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="223544449"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/Connect%20with%20Keycloak%20to%20validate%20access%20tokens/near/223544449" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Burak Şentuna <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/Connect.20with.20Keycloak.20to.20validate.20access.20tokens.html#223544449">(Jan 21 2021 at 17:42)</a>:</h4>
<p>Hi all, i am having an issue with connecting the IBM/FHIR project to an external keycloak auth server to validate access tokens which are generated by the external keycloak server. I just enabled oauth in fhir-server-config.json file and set the auth server endpoints but i am not sure which files should i modify to connect the keycloak server from the IBM/FHIR project and validate tokens successfully. Is there any documentation, blog post etc. about it or can somebody guide me about the issue? Thanks for your support!</p>



<a name="223544603"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/Connect%20with%20Keycloak%20to%20validate%20access%20tokens/near/223544603" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/Connect.20with.20Keycloak.20to.20validate.20access.20tokens.html#223544603">(Jan 21 2021 at 17:44)</a>:</h4>
<p>hi Burak.  have you seen <a href="https://github.com/IBM/FHIR/issues/1703">https://github.com/IBM/FHIR/issues/1703</a> yet?</p>



<a name="223544742"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/Connect%20with%20Keycloak%20to%20validate%20access%20tokens/near/223544742" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/Connect.20with.20Keycloak.20to.20validate.20access.20tokens.html#223544742">(Jan 21 2021 at 17:45)</a>:</h4>
<p>specifically <a href="https://github.com/IBM/FHIR/issues/1703#issuecomment-728132487">https://github.com/IBM/FHIR/issues/1703#issuecomment-728132487</a></p>



<a name="223545368"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/Connect%20with%20Keycloak%20to%20validate%20access%20tokens/near/223545368" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Burak Şentuna <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/Connect.20with.20Keycloak.20to.20validate.20access.20tokens.html#223545368">(Jan 21 2021 at 17:50)</a>:</h4>
<p>yeah, i've implemented all the steps but i got <code>403 Forbidden</code> error always and there is no log about it. Is there any way to display more detailed logs?</p>



<a name="223545790"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/Connect%20with%20Keycloak%20to%20validate%20access%20tokens/near/223545790" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/Connect.20with.20Keycloak.20to.20validate.20access.20tokens.html#223545790">(Jan 21 2021 at 17:53)</a>:</h4>
<p>one scenario where I've found the logs lacking (from our underlying app server) is if you have not properly configured the usersGroup.  not sure if thats your issue or not, but you could double-check your server.xml / configDropins</p>



<a name="223545855"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/Connect%20with%20Keycloak%20to%20validate%20access%20tokens/near/223545855" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/Connect.20with.20Keycloak.20to.20validate.20access.20tokens.html#223545855">(Jan 21 2021 at 17:53)</a>:</h4>
<p>for example, see <a href="https://github.com/IBM/FHIR/blob/master/fhir-server/liberty-config/configDropins/disabled/keycloakRP.xml#L13">https://github.com/IBM/FHIR/blob/master/fhir-server/liberty-config/configDropins/disabled/keycloakRP.xml#L13</a></p>



<a name="223546231"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/Connect%20with%20Keycloak%20to%20validate%20access%20tokens/near/223546231" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/Connect.20with.20Keycloak.20to.20validate.20access.20tokens.html#223546231">(Jan 21 2021 at 17:56)</a>:</h4>
<p>specifically, if you use this pattern, liberty will look in the JWT access token for the value of whatever you've configured as the <code>groupNameAttribute</code>, then append that to the <code>issuer</code> and use that as the access-id in that group field.</p>



<a name="223547973"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/Connect%20with%20Keycloak%20to%20validate%20access%20tokens/near/223547973" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Burak Şentuna <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/Connect.20with.20Keycloak.20to.20validate.20access.20tokens.html#223547973">(Jan 21 2021 at 18:08)</a>:</h4>
<p>Thanks Lee! Let me check all the configuration and i will inform you about the result. Thanks for your support</p>



<a name="246810895"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/Connect%20with%20Keycloak%20to%20validate%20access%20tokens/near/246810895" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mahesh Dabi <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/Connect.20with.20Keycloak.20to.20validate.20access.20tokens.html#246810895">(Jul 22 2021 at 05:39)</a>:</h4>
<p>Hi Burak</p>
<p>Do you have any sample token of Keycloak? We are trying to enable smart-fhir but it is not honoring scopes given in config file.</p>
<p>thanks<br>
mahesh</p>



<a name="246840736"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/Connect%20with%20Keycloak%20to%20validate%20access%20tokens/near/246840736" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mahesh Dabi <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/Connect.20with.20Keycloak.20to.20validate.20access.20tokens.html#246840736">(Jul 22 2021 at 12:40)</a>:</h4>
<p><a href="/user_uploads/10155/f1jqmncQZRYmGzDWVvt73bmp/trace.log">trace.log</a> </p>
<p>Here is detailed log where trace is enabled. We have done change in config file and dropped the Smart Jar with exactly same version as FHIR server (4.8.3) in userlib. Still it is not honoring scopes. Do you get any clue from logs?</p>
<p>Mahesh</p>



<a name="246852258"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/Connect%20with%20Keycloak%20to%20validate%20access%20tokens/near/246852258" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mahesh Dabi <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/Connect.20with.20Keycloak.20to.20validate.20access.20tokens.html#246852258">(Jul 22 2021 at 14:12)</a>:</h4>
<p>Hi </p>
<p>Seems that we are getting there. Please ignore all previous messages. Now we are able to hit the URL which is denying scope properly. Here is error message. So what scope we can give so that we can create patients? </p>
<p>[7/22/21, 14:07:19:605 UTC] 0000001f AuthzPolicyEn 1   write permission for 'Patient/5cbc121b-cd71-4428-b8b7-31e53eba8184' is not granted by any of the provided scopes: [patient/Medication.read, patient/AllergyIntolerance.read, patient/CarePlan.read, patient/CareTeam.read, patient/Condition.read, patient/Device.read, patient/DiagnosticReport.read, patient/DocumentReference.read, patient/Encounter.read, patient/Goal.read, patient/Immunization.read, patient/Location.read, patient/MedicationRequest.read, patient/Observation.read, patient/Organization.read, patient/Patient.read, patient/Practitioner.read, patient/Procedure.read, patient/Provenance.read, patient/Patient.write, user/Patient.write, user/<em>.</em>, patient/<em>.</em>] with context id(s): [17ab437f80b-f1907e67-e141-467c-b3d9-c3f8ebd867be]<br>
[7/22/21, 14:07:19:605 UTC] 0000001f FHIRUserTrans 1   Marking transaction for rollback.<br>
[7/22/21, 14:07:19:605 UTC] 0000001f FHIRUserTrans 1   Rolling back transaction on current thread...<br>
[7/22/21, 14:07:19:606 UTC] 0000001f CacheTransact I   Transaction failed - afterCompletion(status = 4)<br>
[7/22/21, 14:07:19:606 UTC] 0000001f FHIRPersisten 1   Transaction rolled back - clearing local maps<br>
[7/22/21, 14:07:19:606 UTC] 0000001f FHIRResource  1   Requested interaction is not permitted by any of the passed scopes.<br>
                                 com.ibm.fhir.persistence.interceptor.FHIRPersistenceInterceptorException: Requested interaction is not permitted by any of the passed scopes.  [probeId=ac-1e-0-b2-0895b081-94c8-44d2-9a58-4b80224bf722]<br>
    at com.ibm.fhir.smart.AuthzPolicyEnforcementPersistenceInterceptor.enforce(AuthzPolicyEnforcementPersistenceInterceptor.java:374)<br>
    at com.ibm.fhir.smart.AuthzPolicyEnforcementPersistenceInterceptor.beforeCreate(AuthzPolicyEnforcementPersistenceInterceptor.java:178)<br>
    at com.ibm.fhir.persistence.interceptor.impl.FHIRPersistenceInterceptorMgr.fireBeforeCreateEvent(FHIRPersistenceInterceptorMgr.java:91)<br>
    at com.ibm.fhir.server.util.FHIRRestHelper.doCreate(FHIRRestHelper.java:265)<br>
    at com.ibm.fhir.server.operation.spi.FHIRResourceHelpers.doCreate(FHIRResourceHelpers.java:46)<br>
    at com.ibm.fhir.server.resources.Create.create(Create.java:74)<br>
    at com.ibm.fhir.server.resources.Create$Proxy$_$$_WeldClientProxy.create(Unknown Source)<br>
    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br>
    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)<br>
    at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)<br>
    at java.base/java.lang.reflect.Method.invoke(Method.java:566)<br>
    at com.ibm.ws.jaxrs20.cdi.component.JaxRsFactoryImplicitBeanCDICustomizer.serviceInvoke(JaxRsFactoryImplicitBeanCDICustomizer.java:342)<br>
    at com.ibm.ws.jaxrs20.server.LibertyJaxRsServerFactoryBean.performInvocation(LibertyJaxRsServerFactoryBean.java:641)<br>
    at com.ibm.ws.jaxrs20.server.LibertyJaxRsInvoker.performInvocation(LibertyJaxRsInvoker.java:160)<br>
    at org.apache.cxf.service.invoker.AbstractInvoker.invoke(AbstractInvoker.java:101)<br>
    at com.ibm.ws.jaxrs20.server.LibertyJaxRsInvoker.invoke(LibertyJaxRsInvoker.java:273)<br>
    at org.apache.cxf.jaxrs.JAXRSInvoker.invoke(JAXRSInvoker.java:213)<br>
    at com.ibm.ws.jaxrs20.server.LibertyJaxRsInvoker.invoke(LibertyJaxRsInvoker.java:444)<br>
    at org.apache.cxf.jaxrs.JAXRSInvoker.invoke(JAXRSInvoker.java:112)<br>
    at org.apache.cxf.interceptor.ServiceInvokerInterceptor$1.run(ServiceInvokerInterceptor.java:59)<br>
    at org.apache.cxf.interceptor.ServiceInvokerInterceptor.handleMessage(ServiceInvokerInterceptor.java:96)<br>
    at org.apache.cxf.phase.PhaseInterceptorChain.doIntercept(PhaseInterceptorChain.java:308)<br>
    at org.apache.cxf.transport.ChainInitiationObserver.onMessage(ChainInitiationObserver.java:123)<br>
    at org.apache.cxf.transport.http.AbstractHTTPDestination.invoke(AbstractHTTPDestination.java:274)<br>
    at com.ibm.ws.jaxrs20.endpoint.AbstractJaxRsWebEndpoint.invoke(AbstractJaxRsWebEndpoint.java:137)<br>
    at com.ibm.websphere.jaxrs.server.IBMRestServlet.handleRequest(IBMRestServlet.java:146)<br>
    at com.ibm.websphere.jaxrs.server.IBMRestServlet.doPost(IBMRestServlet.java:104)<br>
    at javax.servlet.http.HttpServlet.service(HttpServlet.java:706)<br>
    at com.ibm.websphere.jaxrs.server.IBMRestServlet.service(IBMRestServlet.java:96)<br>
    at com.ibm.ws.webcontainer.servlet.ServletWrapper.service(ServletWrapper.java:1258)<br>
    at com.ibm.ws.webcontainer.servlet.ServletWrapper.handleRequest(ServletWrapper.java:746)<br>
    at com.ibm.ws.webcontainer.servlet.ServletWrapper.handleRequest(ServletWrapper.java:443)<br>
    at com.ibm.ws.webcontainer.filter.WebAppFilterChain.invokeTarget(WebAppFilterChain.java:183)<br>
    at com.ibm.ws.webcontainer.filter.WebAppFilterChain.doFilter(WebAppFilterChain.java:94)<br>
    at com.ibm.fhir.server.filter.rest.FHIRRestServletFilter.doFilter(FHIRRestServletFilter.java:155)<br>
    at javax.servlet.http.HttpFilter.doFilter(HttpFilter.java:127)<br>
    at com.ibm.ws.webcontainer.filter.FilterInstanceWrapper.doFilter(FilterInstanceWrapper.java:197)<br>
    at com.ibm.ws.webcontainer.filter.WebAppFilterChain.doFilter(WebAppFilterChain.java:91)<br>
    at com.ibm.ws.security.jaspi.JaspiServletFilter.doFilter(JaspiServletFilter.java:56)<br>
    at com.ibm.ws.webcontainer.filter.FilterInstanceWrapper.doFilter(FilterInstanceWrapper.java:197)<br>
    at com.ibm.ws.webcontainer.filter.WebAppFilterChain.doFilter(WebAppFilterChain.java:91)<br>
    at com.ibm.ws.webcontainer.filter.WebAppFilterManager.doFilter(WebAppFilterManager.java:1002)<br>
    at com.ibm.ws.webcontainer.filter.WebAppFilterManager.invokeFilters(WebAppFilterManager.java:1140)<br>
    at com.ibm.ws.webcontainer.filter.WebAppFilterManager.invokeFilters(WebAppFilterManager.java:1011)<br>
    at com.ibm.ws.webcontainer.servlet.CacheServletWrapper.handleRequest(CacheServletWrapper.java:75)<br>
    at com.ibm.ws.webcontainer40.servlet.CacheServletWrapper40.handleRequest(CacheServletWrapper40.java:85)<br>
    at com.ibm.ws.webcontainer.WebContainer.handleRequest(WebContainer.java:938)<br>
    at com.ibm.ws.webcontainer.osgi.DynamicVirtualHost$2.run(DynamicVirtualHost.java:279)<br>
    at com.ibm.ws.http.dispatcher.internal.channel.HttpDispatcherLink$TaskWrapper.run(HttpDispatcherLink.java:1159)<br>
    at com.ibm.ws.http.dispatcher.internal.channel.HttpDispatcherLink.wrapHandlerAndExecute(HttpDispatcherLink.java:428)<br>
    at com.ibm.ws.http.dispatcher.internal.channel.HttpDispatcherLink.ready(HttpDispatcherLink.java:387)<br>
    at com.ibm.ws.http.channel.internal.inbound.HttpInboundLink.handleDiscrimination(HttpInboundLink.java:566)<br>
    at com.ibm.ws.http.channel.internal.inbound.HttpInboundLink.handleNewRequest(HttpInboundLink.java:500)<br>
    at com.ibm.ws.http.channel.internal.inbound.HttpInboundLink.processRequest(HttpInboundLink.java:360)<br>
    at com.ibm.ws.http.channel.internal.inbound.HttpInboundLink.ready(HttpInboundLink.java:327)<br>
    at com.ibm.ws.tcpchannel.internal.NewConnectionInitialReadCallback.sendToDiscriminators(NewConnectionInitialReadCallback.java:167)<br>
    at com.ibm.ws.tcpchannel.internal.NewConnectionInitialReadCallback.complete(NewConnectionInitialReadCallback.java:75)<br>
    at com.ibm.ws.tcpchannel.internal.WorkQueueManager.requestComplete(WorkQueueManager.java:504)<br>
    at com.ibm.ws.tcpchannel.internal.WorkQueueManager.attemptIO(WorkQueueManager.java:574)<br>
    at com.ibm.ws.tcpchannel.internal.WorkQueueManager.workerRun(WorkQueueManager.java:958)<br>
    at com.ibm.ws.tcpchannel.internal.WorkQueueManager$Worker.run(WorkQueueManager.java:1047)<br>
    at com.ibm.ws.threading.internal.ExecutorServiceImpl$RunnableWrapper.run(ExecutorServiceImpl.java:238)<br>
    at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)<br>
    at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)<br>
    at java.base/java.lang.Thread.run(Thread.java:829)</p>
<p>[7/22/21, 14:07:19:607 UTC] 0000001f FHIRResource  1   <br>
OperationOutcome:<br>
{"resourceType":"OperationOutcome","id":"ac-1e-0-b2-0895b081-94c8-44d2-9a58-4b80224bf722","issue":[{"severity":"fatal","code":"forbidden","details":{"text":"Requested interaction is not permitted by any of the passed scopes."},"expression":["&lt;empty&gt;"]}]}</p>



<a name="247964653"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/212434-ibm/topic/Connect%20with%20Keycloak%20to%20validate%20access%20tokens/near/247964653" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Surprenant <a href="https://fhir.github.io/chat-archive/stream/212434-ibm/topic/Connect.20with.20Keycloak.20to.20validate.20access.20tokens.html#247964653">(Aug 02 2021 at 20:05)</a>:</h4>
<p>Hi Mahesh, I'm back from vacation now.  Glad to hear you found some success.  The way the <code>fhir-smart</code> interceptor is currently designed, I think it would only allow a user to create resources to which they would have access.<br>
For example, a user bearing a token with <code>patient_id = 17ab437f80b-f1907e67-e141-467c-b3d9-c3f8ebd867be</code> that includes scope <code>patient/Patient.write</code> would ONLY be able to create a Patient resource by that same id.<br>
However, even then, its a case that will require some testing because most of the SMART use cases we've dealt with to date are read-only (i.e. the server is loaded some other way...typically a second instance that is not exposed externally with a different auth strategy).</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
