---
layout: page
title: "FHIR Chat  · Finding patients based on observations in time proximity · cql"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/index.html">cql</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Finding.20patients.20based.20on.20observations.20in.20time.20proximity.html">Finding patients based on observations in time proximity</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="185139883"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Finding%20patients%20based%20on%20observations%20in%20time%20proximity/near/185139883" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Finding.20patients.20based.20on.20observations.20in.20time.20proximity.html#185139883">(Jan 08 2020 at 18:08)</a>:</h4>
<p>I have a client who wanted to know how to query for data like this: "Find me all patients who had observations with  glucose &gt; 150 mg/dL(UCUM) and  and Hemoblogin  &lt; 10 mg/dK (UCUM)  on the same day"</p>
<p>"on the same day" could be "has the same data" or could be "within 24 hours" - whichever is easier.  I'm pretty sure we <em>can't</em> do that with REST, _query or graphql.  So CQL, you're my only hope! :)</p>
<p>Is it possible to write a query that would do that?  (<span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> )</p>



<a name="185142224"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Finding%20patients%20based%20on%20observations%20in%20time%20proximity/near/185142224" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Finding.20patients.20based.20on.20observations.20in.20time.20proximity.html#185142224">(Jan 08 2020 at 18:34)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="191320">@Lloyd McKenzie</span> -- I have to run to a meeting, but here is an example I wrote up showing one approach to using CQL to find patients that meet certain criteria.  The criteria is defined in the <code>Patient</code> context in terms of a specific patient and then the <code>Population</code> context (now <code>Unfiltered</code> context in CQL 1.4) aggregates it at a population level.  It obviously doesn't align with your specific query, but maybe it is still helpful as a start: <a href="https://github.com/cqframework/cql-exec-examples/blob/master/patient-finder/r4/cql/PatientFinderExample.cql" target="_blank" title="https://github.com/cqframework/cql-exec-examples/blob/master/patient-finder/r4/cql/PatientFinderExample.cql">https://github.com/cqframework/cql-exec-examples/blob/master/patient-finder/r4/cql/PatientFinderExample.cql</a></p>



<a name="185142610"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Finding%20patients%20based%20on%20observations%20in%20time%20proximity/near/185142610" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Finding.20patients.20based.20on.20observations.20in.20time.20proximity.html#185142610">(Jan 08 2020 at 18:37)</a>:</h4>
<p>The question isn't really about how to find patients based on criteria (that I can do).  It's more about how to express a criterion that is the presence of two Observations of different types with a maximum time gap between them.  That's more advanced than I know how to do.  (And could possibly be more advanced than what CQL is capable of doing.)  Understand folks are busy today at the connectathon, but wanted to raise it before I forgot to.</p>



<a name="185151138"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Finding%20patients%20based%20on%20observations%20in%20time%20proximity/near/185151138" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Finding.20patients.20based.20on.20observations.20in.20time.20proximity.html#185151138">(Jan 08 2020 at 20:03)</a>:</h4>
<p>(deleted)</p>



<a name="185151267"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Finding%20patients%20based%20on%20observations%20in%20time%20proximity/near/185151267" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Finding.20patients.20based.20on.20observations.20in.20time.20proximity.html#185151267">(Jan 08 2020 at 20:04)</a>:</h4>
<p>I can't test or compile this right now, but I think you basically want this?</p>
<div class="codehilite"><pre><span></span>define &quot;HasSameDayTestCriteria&quot;:
  exists (
    [Observation: &quot;Glucose Test&quot;] G
    with [Observation: &quot;Hemoglobin Test&quot;] H
    such that
      (G.value as Quantity) &gt; 150 &#39;mg/dL&#39;
      and (H.value as Quantity) &lt; 10 &#39;mg/dK&#39;
      and G.issued.value same day as H.issued.value
  )
</pre></div>



<a name="185151332"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Finding%20patients%20based%20on%20observations%20in%20time%20proximity/near/185151332" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Finding.20patients.20based.20on.20observations.20in.20time.20proximity.html#185151332">(Jan 08 2020 at 20:05)</a>:</h4>
<p>That assumes you've set up value sets for the observations and that you want it based on <code>issued</code> -- but it would be trivial to do it based on <code>effectiveDateTime</code> instead (although it involves more casts since those are choices).</p>



<a name="185151613"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Finding%20patients%20based%20on%20observations%20in%20time%20proximity/near/185151613" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Finding.20patients.20based.20on.20observations.20in.20time.20proximity.html#185151613">(Jan 08 2020 at 20:08)</a>:</h4>
<p>OK, it does compile at least.  That one is using <code>same day as</code>, which is looking for them to be on the same calendar day.  But if you want them within 24 hours instead, then you can replace <code>same day as</code> with <code>within 24 hours of</code>.</p>



<a name="185170581"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Finding%20patients%20based%20on%20observations%20in%20time%20proximity/near/185170581" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lloyd McKenzie <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Finding.20patients.20based.20on.20observations.20in.20time.20proximity.html#185170581">(Jan 08 2020 at 23:53)</a>:</h4>
<p>effectiveDateTime would be better.  But the fact that it's at least theoretically possible is great.  Thanks Chris!</p>



<a name="185175547"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Finding%20patients%20based%20on%20observations%20in%20time%20proximity/near/185175547" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Finding.20patients.20based.20on.20observations.20in.20time.20proximity.html#185175547">(Jan 09 2020 at 01:20)</a>:</h4>
<p>Didn't compile it, but I think you're basically looking at something like this then:</p>
<div class="codehilite"><pre><span></span>define &quot;HasSameDayTestCriteria&quot;:
  exists (
    [Observation: &quot;Glucose Test&quot;] G
    with [Observation: &quot;Hemoglobin Test&quot;] H
    such that
      (G.value as Quantity) &gt; 150 &#39;mg/dL&#39;
      and (H.value as Quantity) &lt; 10 &#39;mg/dK&#39;
      and (G.effective as DateTime) same day as (H.effective as DateTime)
  )
</pre></div>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
