---
layout: page
title: "FHIR Chat  · querying Coverage class · cql"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/index.html">cql</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/querying.20Coverage.20class.html">querying Coverage class</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="244928704"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/querying%20Coverage%20class/near/244928704" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vasyl Herman <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/querying.20Coverage.20class.html#244928704">(Jul 05 2021 at 12:15)</a>:</h4>
<p>Hello! Could you please help me?<br>
Is there a way to filter a list of Coverage by class type?</p>
<div class="codehilite"><pre><span></span><code>define &quot;Plan&quot;:
    [Coverage] C
      where C.class.type ~ Code {code:&#39;plan&#39;, system:&#39;http://terminology.hl7.org/CodeSystem/coverage-class&#39;}
</code></pre></div>



<a name="244946017"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/querying%20Coverage%20class/near/244946017" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vasyl Herman <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/querying.20Coverage.20class.html#244946017">(Jul 05 2021 at 14:59)</a>:</h4>
<p>My goal is accessing Coverage.class[type ~ plan].value which is 'MOS':</p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code>    <span class="p">{</span>
      <span class="nt">"resource"</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">"resourceType"</span><span class="p">:</span> <span class="s2">"Coverage"</span><span class="p">,</span>
        <span class="nt">"id"</span><span class="p">:</span> <span class="s2">"4bfdaffa-d11a-4e07-bbe1-521a9b44cc41"</span><span class="p">,</span>
        <span class="nt">"beneficiary"</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">"reference"</span><span class="p">:</span> <span class="s2">"Patient/95007"</span>
        <span class="p">},</span>

        <span class="nt">"payor"</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="nt">"reference"</span><span class="p">:</span> <span class="s2">"Organization/vf-soft"</span>
          <span class="p">}</span>
        <span class="p">],</span>
        <span class="nt">"type"</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">"coding"</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="nt">"system"</span><span class="p">:</span> <span class="s2">"http://terminology.hl7.org/ValueSet/v3-ActCoverageTypeCode"</span><span class="p">,</span>
              <span class="nt">"code"</span><span class="p">:</span> <span class="s2">"RETIRE"</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">},</span>
        <span class="nt">"period"</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">"start"</span><span class="p">:</span> <span class="s2">"1954-01-13T00:00:00.000+00:00"</span><span class="p">,</span>
          <span class="nt">"end"</span><span class="p">:</span> <span class="s2">"2019-01-20T23:59:59.999+00:00"</span>
        <span class="p">},</span>
        <span class="nt">"class"</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="nt">"type"</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">"coding"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="nt">"system"</span><span class="p">:</span> <span class="s2">"http://terminology.hl7.org/CodeSystem/coverage-class"</span><span class="p">,</span>
                  <span class="nt">"code"</span><span class="p">:</span> <span class="s2">"plan"</span>
                <span class="p">}</span>
              <span class="p">]</span>
            <span class="p">},</span>
            <span class="nt">"value"</span><span class="p">:</span> <span class="s2">"MOS"</span>
          <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>
<p>I am using the following cql code. </p>
<p><a href="user_uploads/10155/1SzqriSId14hARgFZlEa8tk1/Screenshot-2021-07-05-at-18.03.39.png">Screenshot-2021-07-05-at-18.03.39.png</a></p>
<div class="message_inline_image"><a href="user_uploads/10155/1SzqriSId14hARgFZlEa8tk1/Screenshot-2021-07-05-at-18.03.39.png" title="Screenshot-2021-07-05-at-18.03.39.png"><img src="user_uploads/10155/1SzqriSId14hARgFZlEa8tk1/Screenshot-2021-07-05-at-18.03.39.png"></a></div><div class="codehilite" data-code-language="Bash"><pre><span></span><code>define <span class="s2">"Plan"</span>:
    Last <span class="o">([</span>Coverage<span class="o">]</span> C
      where C.class.type ~ Code <span class="o">{</span>code:<span class="s1">'plan'</span>, system:<span class="s1">'http://terminology.hl7.org/CodeSystem/coverage-class'</span><span class="o">}</span>
      and FHIRBase.<span class="s2">"Normalize Interval"</span><span class="o">(</span> C.period <span class="o">)</span> starts before end of <span class="s2">"Measurement Period"</span>
        <span class="k">return</span> Tuple <span class="o">{</span>id: C, plan: C.class<span class="o">[</span><span class="m">0</span><span class="o">]</span>.value.value<span class="o">}</span>
        sort by end of id.period<span class="o">)</span>.plan
</code></pre></div>
<p>It looks like an error but it's working <code>Could not resolve call to operator Equivalent with signature (list&lt;FHIR.CodeableConcept&gt;,System.Code).</code><br>
Could you please correct a beginner if  is wrong?<br>
Thank you in advance.</p>



<a name="245257934"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/querying%20Coverage%20class/near/245257934" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/querying.20Coverage.20class.html#245257934">(Jul 08 2021 at 00:04)</a>:</h4>
<p>The <code>class</code> element of Coverage is itself a list so you need to do the comparion on the list elements. A sub-query something like this should do the trick:</p>
<div class="codehilite" data-code-language="cql"><pre><span></span><code>  define "Plan":
      Last ([Coverage] C
        where exists (C.class Class where Class.type ~ Code {code:'plan', system:'http://terminology.hl7.org/CodeSystem/coverage-class'})
        and FHIRBase."Normalize Interval"( C.period ) starts before end of "Measurement Period"
          return Tuple {id: C, plan: C.class[0].value.value}
          sort by end of id.period).plan
</code></pre></div>



<a name="245287789"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/querying%20Coverage%20class/near/245287789" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vasyl Herman <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/querying.20Coverage.20class.html#245287789">(Jul 08 2021 at 08:55)</a>:</h4>
<p>You are Amazing!</p>
<p>What about <code>return Tuple {id: C, plan: C.class[0].value.value}</code>, more specificaly <code>C.class.[0]</code> always returns first element, right? <br>
What if we had a list of multiple items in C.class? I mean there is no guarantee that <code>plan</code> is going to be always the first one. I'd like to reach out its value which is <code>MOS</code>.<br>
Thanks!</p>



<a name="245288050"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/querying%20Coverage%20class/near/245288050" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vasyl Herman <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/querying.20Coverage.20class.html#245288050">(Jul 08 2021 at 08:59)</a>:</h4>
<p>for instance:</p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code><span class="nt">"class"</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="nt">"type"</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">"coding"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="nt">"system"</span><span class="p">:</span> <span class="s2">"http://terminology.hl7.org/CodeSystem/coverage-class"</span><span class="p">,</span>
                  <span class="nt">"code"</span><span class="p">:</span> <span class="s2">"something-else"</span>
                <span class="p">}</span>
              <span class="p">]</span>
            <span class="p">},</span>
            <span class="nt">"value"</span><span class="p">:</span> <span class="s2">"TEST"</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="nt">"type"</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">"coding"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="nt">"system"</span><span class="p">:</span> <span class="s2">"http://terminology.hl7.org/CodeSystem/coverage-class"</span><span class="p">,</span>
                  <span class="nt">"code"</span><span class="p">:</span> <span class="s2">"plan"</span>
                <span class="p">}</span>
              <span class="p">]</span>
            <span class="p">},</span>
            <span class="nt">"value"</span><span class="p">:</span> <span class="s2">"MOS"</span>
          <span class="p">}</span>
        <span class="p">]</span>
</code></pre></div>



<a name="245334379"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/querying%20Coverage%20class/near/245334379" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/querying.20Coverage.20class.html#245334379">(Jul 08 2021 at 16:01)</a>:</h4>
<p>How about this (I removed the normalize logic and replaced it with <code>true</code> to make the structure of the query more obvious):</p>
<div class="codehilite" data-code-language="cql"><pre><span></span><code>      [Coverage] C
        let plan : First(C.class Class where Class.type ~ Code {code:'plan', system:'http://terminology.hl7.org/CodeSystem/coverage-class'})
        where true and plan is not null
        return Tuple {id: C, plan: plan.value.value}
        sort by end of id.period
</code></pre></div>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
