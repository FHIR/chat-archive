---
layout: page
title: "FHIR Chat  · resolving references · cql"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/index.html">cql</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html">resolving references</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="186871172"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/resolving%20references/near/186871172" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Georg Fette <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html#186871172">(Jan 29 2020 at 10:09)</a>:</h4>
<p>Hi, when I would like to access fields of a referenced resource, e.g.:</p>
<p>[Observation] a where a.encounter.status = something</p>
<p>How do I express that in CQL ?<br>
The above statement raises the error "Member status not found for type FHIR.Reference."</p>



<a name="186895475"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/resolving%20references/near/186895475" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Kiel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html#186895475">(Jan 29 2020 at 15:26)</a>:</h4>
<p>You can't traverse references this way in CQL. A FHIR reference in CQL is just that, the reference data type with its fields. I also assumed and even implemented reference traversal in my engine at the beginning. What you can do, is to use relationships in query:</p>
<div class="codehilite"><pre><span></span>[Observation] a
  with [Encounter] b
  such that b.status = something and EndsWith(a.encounter. reference, b.id)
</pre></div>


<p>I don't like the approach to use <code>EndsWith</code> on <code>Reference.reference</code> but that's the only thing I came up with. In all examples, I known of, they don't need such things like joining by id. Maybe we miss something here.</p>



<a name="186896289"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/resolving%20references/near/186896289" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html#186896289">(Jan 29 2020 at 15:34)</a>:</h4>
<p>We are pursuing several different approaches right now, the first is to join like <span class="user-mention" data-user-id="197470">@Alexander Kiel</span> suggested, though we often use functions to support that (an example <a href="https://github.com/DBCG/connectathon/blob/master/fhir4/cql/MATGlobalCommonFunctions_FHIR4-4.0.000.cql#L243" target="_blank" title="https://github.com/DBCG/connectathon/blob/master/fhir4/cql/MATGlobalCommonFunctions_FHIR4-4.0.000.cql#L243">here</a>). Second is using a <a href="https://cql.hl7.org/03-developersguide.html#related-context-retrieves" target="_blank" title="https://cql.hl7.org/03-developersguide.html#related-context-retrieves">related context retrieve</a>, though the FHIR model included with the current translator doesn't have enough information to work that out yet, and the Third is to enable the natural traversal in the original question (<code>a.encounter.status = something</code>), but that requires some additional tooling that is still in development in both the translator and the engine.</p>



<a name="186896776"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/resolving%20references/near/186896776" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Kiel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html#186896776">(Jan 29 2020 at 15:39)</a>:</h4>
<p><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> Is there a specification for the natural traversal? I thought one important point in CQL was, that one is able to calculate the data needed for a query and that the Retrieve expression was specially designed for that reason. With such a natural traversal, additional data might be required which is not visible through Retrieve.</p>



<a name="186900471"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/resolving%20references/near/186900471" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html#186900471">(Jan 29 2020 at 16:14)</a>:</h4>
<p>Well, the working idea of the natural traversal is that it would be an aspect of representation in the CQL, but the underlying ELM would still be expressed in terms of the actual retrieves.</p>



<a name="187892799"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/resolving%20references/near/187892799" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Georg Fette <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html#187892799">(Feb 11 2020 at 08:46)</a>:</h4>
<p>I would highly apprecitate such natural traversals. I would as well accept a workaround like in FHIRPath with a "resolve()" call. The solution with a join would be highly inefficient when it is needed to make a full iteration over another profile just to find the one that is referenced. The solution with the function obfuscating this full iteration would make the code more readable but still stays inefficient. As FHIR is a very graph like system it is necessary to be able to traverse all relations as transparent as possible to make it easily usable by everyone.</p>



<a name="187919035"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/resolving%20references/near/187919035" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html#187919035">(Feb 11 2020 at 14:57)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="196537">@Georg Fette</span> , this is on the short list for items to be addressed in the upcoming CQL ballot.</p>



<a name="231697874"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/resolving%20references/near/231697874" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html#231697874">(Mar 24 2021 at 19:50)</a>:</h4>
<p>Someone (<span class="user-mention" data-user-id="215604">@Saul Kravitz</span>) recently asked me about traversing references... do we have any good examples of this now?  I know CQL 1.5 introduces <code>resolve</code>, but we're looking for the old school approach w/ sub-queries since that currently has better support.  The example <span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> linked to above is broken, but I reckon there must be other examples out there.  If not, I can craft one, but I'm hoping for a battle-tested solution. ;-)</p>



<a name="231708519"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/resolving%20references/near/231708519" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html#231708519">(Mar 24 2021 at 21:07)</a>:</h4>
<p>Here's an updated link to that example:</p>



<a name="231708521"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/resolving%20references/near/231708521" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html#231708521">(Mar 24 2021 at 21:07)</a>:</h4>
<p><a href="https://github.com/cqframework/ecqm-content-r4/blob/master/input/cql/MATGlobalCommonFunctionsFHIR4.cql#L205">https://github.com/cqframework/ecqm-content-r4/blob/master/input/cql/MATGlobalCommonFunctionsFHIR4.cql#L205</a></p>



<a name="231708557"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/resolving%20references/near/231708557" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html#231708557">(Mar 24 2021 at 21:07)</a>:</h4>
<p>And an example of usage just a few lines below that:</p>



<a name="231708559"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/resolving%20references/near/231708559" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html#231708559">(Mar 24 2021 at 21:07)</a>:</h4>
<p><a href="https://github.com/cqframework/ecqm-content-r4/blob/master/input/cql/MATGlobalCommonFunctionsFHIR4.cql#L210">https://github.com/cqframework/ecqm-content-r4/blob/master/input/cql/MATGlobalCommonFunctionsFHIR4.cql#L210</a></p>



<a name="231708689"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/resolving%20references/near/231708689" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html#231708689">(Mar 24 2021 at 21:08)</a>:</h4>
<p>It's a limited use solution in that it assumes single-server evaluation and referencing.</p>



<a name="231708740"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/resolving%20references/near/231708740" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html#231708740">(Mar 24 2021 at 21:08)</a>:</h4>
<p>But it is functional and we have used that approach in both quality measure and decision support logic.</p>



<a name="231709021"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/resolving%20references/near/231709021" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html#231709021">(Mar 24 2021 at 21:10)</a>:</h4>
<p>And here's another example, slightly more complex "plural" reference, in answer to this same question from <span class="user-mention" data-user-id="195129">@Aziz Boxwala</span> :</p>
<div class="codehilite"><pre><span></span><code>library EncountersForDiabetesExample

using FHIR version &#39;4.0.1&#39;

include FHIRHelpers version &#39;4.0.1&#39;

valueset Diabetes: &#39;TBD&#39;

context Patient

define EncountersForDiabetes:
  [Encounter] E
    with [Condition: &quot;Diabetes&quot;] C such that C.id in E.reasonReference R return Last(Split(R.reference, &#39;/&#39;))
</code></pre></div>



<a name="231710001"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/resolving%20references/near/231710001" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html#231710001">(Mar 24 2021 at 21:16)</a>:</h4>
<p>Thanks, <span class="user-mention" data-user-id="191359">@Bryn Rhodes</span>.  Since you passed that challenge w/ flying colors... I don't suppose you have any examples where the reference is a choice, do you?  E.g., <code>Condition.stage.assessment</code> is a <code>Reference(ClinicalImpression|DiagnosticReport|Observation)</code>.  It's a little more tricky when you effectively have to issue different queries depending on the reference.  If you don't have an example, don't worry about it -- it's not rocket science and I can figure something out; but it's always nice to look for existing stuff first.</p>



<a name="231710914"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/resolving%20references/near/231710914" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html#231710914">(Mar 24 2021 at 21:23)</a>:</h4>
<p>I can't think of an example of that specifically, but I have a similar one, where the reference is choice of CodeableConcept or Reference:</p>
<div class="codehilite"><pre><span></span><code>define &quot;Active Ambulatory Naloxone Rx&quot;:
(
  (&quot;Get Active Ambulatory Medication Requests&quot;([MedicationRequest])) MR
    where date from MR.authoredOn 2 years or less on or before Today()
      and MR.medication is Reference or MR.medication in &quot;Naloxone medications&quot;
) Rx
  let Med: if Rx.medication is Reference then singleton from ([Medication: id in (Last(Split((Rx.medication as FHIR.Reference).reference, &#39;/&#39;)))]) else null
  where not(Rx.medication is Reference) or Med.code in &quot;Naloxone medications&quot;
    return
      MedicationRequest {
        id: Rx.id,
        status: Rx.status,
        intent: Rx.intent,
        category: Rx.category,
        medication: if Rx.medication is Reference then Med.code else Rx.medication as CodeableConcept,
        subject: Rx.subject,
        recorder: Rx.recorder,
        dosageInstruction: Rx.dosageInstruction,
        dispenseRequest: Rx.dispenseRequest
      }
</code></pre></div>



<a name="231711055"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/resolving%20references/near/231711055" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aziz Boxwala <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html#231711055">(Mar 24 2021 at 21:24)</a>:</h4>
<p>Thank you <span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> .</p>



<a name="231711127"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/resolving%20references/near/231711127" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html#231711127">(Mar 24 2021 at 21:25)</a>:</h4>
<p>That medication example is functional against servers that use MedicationRequest with a reference to a Medication, as well as servers that use MedicationRequest with a CodeableConcept.</p>



<a name="231711237"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/resolving%20references/near/231711237" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html#231711237">(Mar 24 2021 at 21:25)</a>:</h4>
<p>And we're currently working on some planning code that will turn the related retrieve into an include so that it only hits the server once.</p>



<a name="231711517"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/resolving%20references/near/231711517" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html#231711517">(Mar 24 2021 at 21:27)</a>:</h4>
<p><span class="user-mention" data-user-id="195129">@Aziz Boxwala</span> , on that example of "Encouters for Diabetes", do you also want to consider Encounters that have a "diagnosis" element referencing a diabetes condition?</p>



<a name="231711800"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/resolving%20references/near/231711800" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aziz Boxwala <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html#231711800">(Mar 24 2021 at 21:29)</a>:</h4>
<p><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> Should there be something in FHIRHelpers to handle references better so we hide away  this ugly code:  <code>Last(Split(R.reference, '/'))</code> or even <code> C.id in E.reasonReference R return Last(Split(R.reference, '/'))</code></p>



<a name="231713630"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/resolving%20references/near/231713630" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html#231713630">(Mar 24 2021 at 21:41)</a>:</h4>
<p>Yes, and the latest translator release (1.5.2) does support the following:</p>
<div class="codehilite"><pre><span></span><code>// If a reference is resolved in the scope of a query, that resolve can be rewritten as an include in the retrieve for that source
// MedicationRequest
define TestMedicationRequest1:
  [MedicationRequest] MR
    where MR.medication.reference.resolve().as(Medication).code ~ &quot;aspirin 325 MG / oxycodone hydrochloride 4.84 MG Oral Tablet&quot;

// Expected FHIR URL for the retrieve
// [base]/MedicationRequest?patient=123&amp;_include=MedicationRequest:medication

define TestMedicationRequest1A:
  [MedicationRequest] MR
    with [Medication] M such that MR.medication = M.reference() and M.code ~ &quot;aspirin 325 MG / oxycodone hydrochloride 4.84 MG Oral Tablet&quot;

//X.&lt;reference&gt;.references(Y) &lt;=&gt; X.&lt;reference&gt; = Y.reference()

define TestMedicationRequest1B:
  [MedicationRequest] MR
    with [MR.medication -&gt; Medication] M such that M.code ~ &quot;aspirin 325 MG / oxycodone hydrochloride 4.84 MG Oral Tablet&quot;

define TestMedicationRequest1C:
  [MedicationRequest] MR
    let M: singleton from ([MR.medication -&gt; Medication])
    where M.code ~ &quot;aspirin 325 MG / oxycodone hydrochloride 4.84 MG Oral Tablet&quot;
</code></pre></div>



<a name="231713775"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/resolving%20references/near/231713775" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html#231713775">(Mar 24 2021 at 21:42)</a>:</h4>
<p>But the engines don't support those capabilities (.resolve() and .reference() as well as the use of related-context retrieves in that way) (yet).</p>



<a name="231718057"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/resolving%20references/near/231718057" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aziz Boxwala <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/resolving.20references.html#231718057">(Mar 24 2021 at 22:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="191359">Bryn Rhodes</span> <a href="#narrow/stream/179220-cql/topic/resolving.20references/near/231711517">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="195129">Aziz Boxwala</span> , on that example of "Encouters for Diabetes", do you also want to consider Encounters that have a "diagnosis" element referencing a diabetes condition?</p>
</blockquote>
<p>Not needed <span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> . Thanks though.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
