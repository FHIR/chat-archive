---
layout: page
title: "FHIR Chat  · Fetch latest n Observations and Loop through it #CQF-Ruler · cql"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/index.html">cql</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Fetch.20latest.20n.20Observations.20and.20Loop.20through.20it.20.23CQF-Ruler.html">Fetch latest n Observations and Loop through it #CQF-Ruler</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="259921426"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Fetch%20latest%20n%20Observations%20and%20Loop%20through%20it%20%23CQF-Ruler/near/259921426" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gautham Reddy Lingampally <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Fetch.20latest.20n.20Observations.20and.20Loop.20through.20it.20.23CQF-Ruler.html#259921426">(Nov 01 2021 at 21:04)</a>:</h4>
<p>Hi,</p>
<p>I am working a POC using cqf-ruler to see if our rule based clinical decisions can be centralized. As part of this POC, I have stumbled upon one of the use case where we need to check if one of the latest 2 PTH observation results are &lt;= 400. I know we could use First() to get a latest observation. But here I need latest 2 observation.  Can someone help me with this?</p>
<p>Something like this.....<br>
define "latestPTHObservation"<br>
  [Observation: code = 'FR_PTH-I'] O<br>
    where O.effective &lt; Now() - 90 days<br>
    sort by (effective as dateTime) desc <br>
    count 2</p>



<a name="260002198"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Fetch%20latest%20n%20Observations%20and%20Loop%20through%20it%20%23CQF-Ruler/near/260002198" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Corey Sanders <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Fetch.20latest.20n.20Observations.20and.20Loop.20through.20it.20.23CQF-Ruler.html#260002198">(Nov 02 2021 at 14:24)</a>:</h4>
<p>There are probably more elegant ways to do this, but I think something like the following will meet your need.</p>
<div class="codehilite"><pre><span></span><code>define MostRecentTwoObservations:
  ObservationsOrderedMostRecent[0]
  union
  ObservationsOrderedMostRecent[1]

define ObservationsOrderedMostRecent:
     [Observation:code = &#39;FR_PTH-I&#39;] o where O.effective &lt; Now() - 90 days sort by (effective as dateTime) desc
</code></pre></div>



<a name="260157349"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Fetch%20latest%20n%20Observations%20and%20Loop%20through%20it%20%23CQF-Ruler/near/260157349" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Riley <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Fetch.20latest.20n.20Observations.20and.20Loop.20through.20it.20.23CQF-Ruler.html#260157349">(Nov 03 2021 at 16:10)</a>:</h4>
<p>I don't think there's a slicing-type operator so you're stuck doing a union-of-elements like this.</p>



<a name="260171870"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Fetch%20latest%20n%20Observations%20and%20Loop%20through%20it%20%23CQF-Ruler/near/260171870" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Fetch.20latest.20n.20Observations.20and.20Loop.20through.20it.20.23CQF-Ruler.html#260171870">(Nov 03 2021 at 17:53)</a>:</h4>
<p>You can build a slice function with Intervals:</p>
<div class="codehilite" data-code-language="cql"><pre><span></span><code>define function Slice(list List&lt;Any&gt;, range Interval&lt;Integer&gt;) returns List&lt;Any&gt;:
  ((expand { range }) X return point from X) I
    return list[I]

define "List Items":
  { 'One', 'Two', 'Three', 'Four', 'Five'}

define "Sliced List":
  Slice("List Items", Interval[0, 1])
</code></pre></div>



<a name="260181721"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Fetch%20latest%20n%20Observations%20and%20Loop%20through%20it%20%23CQF-Ruler/near/260181721" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Riley <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Fetch.20latest.20n.20Observations.20and.20Loop.20through.20it.20.23CQF-Ruler.html#260181721">(Nov 03 2021 at 19:02)</a>:</h4>
<p>What is the type of "I" at this point? The "expand" operator is only vaguely touched on in the author's guide, would be good to have more elaboration on them.</p>



<a name="260186872"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Fetch%20latest%20n%20Observations%20and%20Loop%20through%20it%20%23CQF-Ruler/near/260186872" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Fetch.20latest.20n.20Observations.20and.20Loop.20through.20it.20.23CQF-Ruler.html#260186872">(Nov 03 2021 at 19:42)</a>:</h4>
<p>"point from" returns a single point from the interval, and the interval is of type Integer, so I is an integer.</p>



<a name="260186934"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Fetch%20latest%20n%20Observations%20and%20Loop%20through%20it%20%23CQF-Ruler/near/260186934" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Fetch.20latest.20n.20Observations.20and.20Loop.20through.20it.20.23CQF-Ruler.html#260186934">(Nov 03 2021 at 19:43)</a>:</h4>
<p>A first-class Slice function would be cool though.</p>



<a name="260279302"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Fetch%20latest%20n%20Observations%20and%20Loop%20through%20it%20%23CQF-Ruler/near/260279302" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Denning <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Fetch.20latest.20n.20Observations.20and.20Loop.20through.20it.20.23CQF-Ruler.html#260279302">(Nov 04 2021 at 14:44)</a>:</h4>
<p>The name "Slice" is easily confused with the FHIR concept of slicing <a href="http://hl7.org/fhir/profiling.html#slicing">http://hl7.org/fhir/profiling.html#slicing</a> so  I would avoid naming a CQL function "Slice" at least in the CQL spec.</p>



<a name="260338519"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Fetch%20latest%20n%20Observations%20and%20Loop%20through%20it%20%23CQF-Ruler/near/260338519" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Fetch.20latest.20n.20Observations.20and.20Loop.20through.20it.20.23CQF-Ruler.html#260338519">(Nov 04 2021 at 21:38)</a>:</h4>
<p>There is a <a href="https://cql.hl7.org/09-b-cqlreference.html#take">Take</a> operator that will do exactly this, so it would be:<br>
<code>Take(ObservationsOrderedMostRecent, 2)</code></p>



<a name="260435631"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Fetch%20latest%20n%20Observations%20and%20Loop%20through%20it%20%23CQF-Ruler/near/260435631" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gautham Reddy Lingampally <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Fetch.20latest.20n.20Observations.20and.20Loop.20through.20it.20.23CQF-Ruler.html#260435631">(Nov 05 2021 at 17:13)</a>:</h4>
<p>Thank you! Bryn. I also want to loop trough the list and check if the observation value is less than x. Is there a for loop kind of a thing in CQL?<br>
Currently, I am doing <code>ObservationsOrderedMostRecent[0].value.value &lt;= x or ObservationsOrderedMostRecent[1].value.value &lt;= x</code> but want have them in a loop if possible.</p>



<a name="260530302"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Fetch%20latest%20n%20Observations%20and%20Loop%20through%20it%20%23CQF-Ruler/near/260530302" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Fetch.20latest.20n.20Observations.20and.20Loop.20through.20it.20.23CQF-Ruler.html#260530302">(Nov 06 2021 at 19:00)</a>:</h4>
<p>That would be just a where clause:</p>
<div class="codehilite"><pre><span></span><code>ObservationsOrderedMostRecent O
  where O.value &lt;= x
</code></pre></div>



<a name="260657508"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Fetch%20latest%20n%20Observations%20and%20Loop%20through%20it%20%23CQF-Ruler/near/260657508" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gautham Reddy Lingampally <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Fetch.20latest.20n.20Observations.20and.20Loop.20through.20it.20.23CQF-Ruler.html#260657508">(Nov 08 2021 at 13:40)</a>:</h4>
<p>Thank you! Bryn.</p>



<a name="261024491"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Fetch%20latest%20n%20Observations%20and%20Loop%20through%20it%20%23CQF-Ruler/near/261024491" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gautham Reddy Lingampally <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Fetch.20latest.20n.20Observations.20and.20Loop.20through.20it.20.23CQF-Ruler.html#261024491">(Nov 10 2021 at 17:31)</a>:</h4>
<p>Hi Bryn,</p>
<p>I have stumbled upon another scenario, to filter MedicationRequests based on the medication reference. I am trying to write a CQL which translates to below FHIR call.<br>
<code>MedicationRequest?category=community&amp;status=active,completed&amp;medication.code:text=Tums</code><br>
I came up with below  2 CQLs based on the another thread "resolving reference", but it doesn't seem to work on CQE-ruler (I am using dstu3). </p>
<div class="codehilite"><pre><span></span><code>exists (
    [MedicationRequest: category = &quot;HomeMeds&quot;] MR
    with [MR.medication -&gt; Medication] M
      such that M.code = &quot;Tums&quot;
        and (MR.status = &#39;active&#39; or MR.status = &#39;completed&#39;)
        and M.ingredient[0].amount.numerator.value &lt; 1890
        and MR.dosageInstruction[0].dose.value &lt; 6)
</code></pre></div>
<p>and </p>
<div class="codehilite"><pre><span></span><code>exists (
     [MedicationRequest: category = &quot;HomeMeds&quot;] MR
     with [Medication: &quot;Tums&quot;] M such that M.id in Last(Split(MR.medication.reference, &#39;/&#39;))   )
</code></pre></div>
<p>Can you please help me with this?</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
