---
layout: page
title: "FHIR Chat  · Reducing results from 2 different FHIR resources · cql"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/index.html">cql</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Reducing.20results.20from.202.20different.20FHIR.20resources.html">Reducing results from 2 different FHIR resources</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="233683786"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Reducing%20results%20from%202%20different%20FHIR%20resources/near/233683786" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Riley <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Reducing.20results.20from.202.20different.20FHIR.20resources.html#233683786">(Apr 08 2021 at 16:24)</a>:</h4>
<p>I'm trying to build a cql definition in a patient context using the FHIR library that </p>
<ul>
<li>Retreives a set of immunization resources</li>
<li>Retrieves a set of procedure resources</li>
<li>Finds the most recent index from both sets</li>
</ul>
<p>The problem is that since I'm comparing to , I need to either merge the lists together then find the most recent of the immunizations AND procedures, or I could instead find the most recent procedure and immunization, extract the datetime from each and then find the most recent from that list.</p>
<p>I'm trying to define my indexes as such:</p>
<div class="codehilite"><pre><span></span><code>context Patient
define &quot;CovidImmunization&quot;: [Immunization: &quot;Covid Vaccine Drug Exposure&quot;]

define &quot;CovidProcedure&quot;: [Procedure: &quot;Covid Vaccine Drug Exposure&quot;]

define &quot;LastCovidInstanceDT&quot;:
  Patient P
  let IDT: MostRecentImmunizationDT(&quot;CovidImmunization&quot;),
      PDT: MostRecentProcedureDT(&quot;CovidProcedure&quot;)
  if IDT after PDT
  then
    IDT
  else
    PDT
</code></pre></div>
<p>With the retrievals referencing appropriate concept sets or valuesets, ofc.<br>
And my functions for retrieving the most recent occurrences are</p>
<div class="codehilite"><pre><span></span><code>define function MostRecentImmunizationDT(ImmunizationList List&lt;FHIR.Immunization&gt;):
  from ImmunizationList I
  let result: Last(ImmunizationList I sort by (occurrence as FHIR.dateTime).value)
    return result.occurrence.value

define function MostRecentProcedureDT(ProcedureList List&lt;FHIR.Procedure&gt;):
  from ProcedureList P
  let result:Last(ProcedureList P sort by (performed as FHIR.dateTime).value)
    return result.performed.value
</code></pre></div>
<p>I'm having 3 problems here.<br>
1) As you can see, I'm trying to use the let statement for inscope definitions to prevent having to call the defined functions more than once, but I'm having a hard time getting the syntax of let to play nicely with the if conditional in the main definition should I forgo the let statement and make my main definition a top-level conditional?<br>
2), In my return statements, I can't seem to reuse the cast as statement within my return clauses, so the return statement is confused on the typing of the function return. Should I define another variable that merely captures the datetime I need and return that variable?<br>
3) This really only handles the case where the type is a FHIR.dateTime, sometimes they are also FHIR.Periods which we would transform into Intervals.</p>
<p>If there's anyway to reduce the query to a single list, that would be an interesting problem as well.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
