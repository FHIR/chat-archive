---
layout: page
title: "FHIR Chat  · Syntax error · cql"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/index.html">cql</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Syntax.20error.html">Syntax error</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="181574900"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Syntax%20error/near/181574900" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tien Thai <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Syntax.20error.html#181574900">(Nov 21 2019 at 19:22)</a>:</h4>
<p>Given:<br>
  medSupply = 10<br>
  drugStrength.value = 5.0<br>
  conversionFactor = 1.5</p>
<p>Plug those value to the following expression:<br>
  prescriptionMME: Quantity { value: medSupply * drugStrength.value * conversionFactor, unit: dailyDose.unit }</p>
<p>Getting "Expected an expression of type 'System.Decimal', but found an expression of type 'System.Quantity'" error.</p>
<p>Can you please let me know if there is anything wrong with the above expression?  Thank you.</p>



<a name="181576744"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Syntax%20error/near/181576744" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Syntax.20error.html#181576744">(Nov 21 2019 at 19:41)</a>:</h4>
<p>Without the full context of the types, it's hard to say.  But it seems to me like it's expecting <code>prescriptionMME</code> to be a <code>Decimal</code>, but you're assigning it a <code>Quantity</code>.  This may be the case since MME has an assumed unit.  But again, it's hard to say without all of the context.</p>



<a name="186818536"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Syntax%20error/near/186818536" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eghonghon Okpah <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Syntax.20error.html#186818536">(Jan 28 2020 at 19:27)</a>:</h4>
<p>Code : <br>
 define function IntervalExtension(collapsed List&lt;Interval&lt;DateTime&gt;&gt;, source List&lt;Interval&lt;DateTime&gt;&gt;): <br>
        if collapsed is null then null <br>
      else<br>
Interval[<br>
        start of collapsed,<br>
        start of collapsed + SumInDays(source sr where sr during collapsed)<br>
       ]<br>
   define function ExtendIntervals(intervals List&lt;Interval&lt;DateTime&gt;&gt;) returns List&lt;Interval&lt;DateTime&gt;&gt;:<br>
      from (collapse intervals) CollapsedInterval,<br>
         intervals  I<br>
          return (if CollapsedInterval CI includes I and I includes CollapsedInterval then  I<br>
          else ExtendIntervals(IntervalExtension(CollapsedInterval, intervals)))<br>
Error: Cannot resolve reference to expression or function ExtendIntervals() because it results in a circular reference.<br>
Wondering if there is a better way of writing this code to handle recursion.</p>



<a name="186846012"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Syntax%20error/near/186846012" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Syntax.20error.html#186846012">(Jan 29 2020 at 00:40)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="221800">@Eghonghon Okpah</span> , I'm not sure I'm following what this is trying to do? In general, yes, CQL does not support recursive functions or queries. This is by design to ensure authors cannot build infinite recursion into their expressions, but it does put some recursive patterns out of reach; this might be one such case.</p>



<a name="186846059"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Syntax%20error/near/186846059" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Syntax.20error.html#186846059">(Jan 29 2020 at 00:41)</a>:</h4>
<p>We are considering adding recursive capabilities to the language, can you help me understand this use case so we can make sure it is handled by what we end up proposing?</p>



<a name="187011803"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Syntax%20error/near/187011803" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eghonghon Okpah <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Syntax.20error.html#187011803">(Jan 30 2020 at 17:52)</a>:</h4>
<p><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span>  the goal is to compute MedicationDispenseEvents into a list of Intervals, each Interval corresponding to the date of the event and the amount dispensed, and then recursively collapsing and extending the list of Intervals until a stable result is achieved.</p>



<a name="189910292"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Syntax%20error/near/189910292" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tien Thai <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Syntax.20error.html#189910292">(Mar 06 2020 at 16:36)</a>:</h4>
<p>I am trying to convert a QDM based eCQM to FHIR based eCQM and for some reasons, it kept giving me the "Expected an expression of type 'FHIR.decimal' , but found an expression of type 'System.Decimal'" error in the function below.  Can you please help me point out what could have caused the error?  Many thanks.<br>
TT</p>
<hr>
<p>define function "EnsureMicrogramQuantity"(strength Quantity):<br>
  if strength.value &lt; 0.1<br>
    and ( PositionOf('mg', strength.unit)= 0 ) then Quantity { value: strength.value * 1000, unit: 'ug' + Substring(strength.unit, 2)}<br>
      else strength</p>



<a name="189916464"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Syntax%20error/near/189916464" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Syntax.20error.html#189916464">(Mar 06 2020 at 17:43)</a>:</h4>
<p>There are actually two quantity types available when you've declared "using FHIR version 'X.X.X'. One is the native CQL quantity (System.Quantity), and the other is the FHIR quantity (FHIR.Quanity). It's not clear from your code which you are intending to use, but here are two potential solutions:</p>
<p>If you're intending to use FHIR.Quantity:</p>
<div class="codehilite"><pre><span></span>define function &quot;EnsureMicrogramQuantity&quot;(strength FHIR.Quantity):
  if strength.value &lt; 0.1
  and ( PositionOf(&#39;mg&#39;, strength.unit)= 0 ) then
    Quantity {
      value: FHIR.decimal { value : (strength.value * 1000) },
      unit: FHIR.string { value: &#39;ug&#39; + Substring(strength.unit, 2)}
    }
  else strength
</pre></div>


<p>If you're intending to use System.Quantity:</p>
<div class="codehilite"><pre><span></span>define function &quot;EnsureMicrogramQuantity&quot;(strength System.Quantity):
  if strength.value &lt; 0.1
  and ( PositionOf(&#39;mg&#39;, strength.unit)= 0 ) then
    System.Quantity {
      value: strength.value * 1000,
      unit: &#39;ug&#39; + Substring(strength.unit, 2)
    }
  else strength
</pre></div>



<a name="189921180"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Syntax%20error/near/189921180" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tien Thai <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Syntax.20error.html#189921180">(Mar 06 2020 at 18:33)</a>:</h4>
<p>Yes, the System.Quantity clears the error.  Thanks very much for your help, Jonathan!</p>



<a name="189933445"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Syntax%20error/near/189933445" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tien Thai <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Syntax.20error.html#189933445">(Mar 06 2020 at 20:58)</a>:</h4>
<p>Hi Jonathan,</p>
<p>I am defining a function that returns an interval (see below) but kept getting an "Expected  an expression of type 'System.Decimal', but found an expression of type 'FHIR.Duration'" error .  Can you please let me know what could have caused the error?  Your help is appreciated.<br>
TT</p>
<hr>
<p>define function "MedicationRelevantPeriod"(OpioidMed "MedicationRequest"):<br>
      Interval[start of OpioidMed.dispenseRequest.validityPeriod,<br>
      case<br>
        when OpioidMed.dispenseRequest.expectedSupplyDuration is not null<br>
          then start of OpioidMed.dispenseRequest.validityPeriod + System.Quantity { value: OpioidMed.dispenseRequest.expectedSupplyDuration, unit: 'd' }<br>
        else<br>
          end of OpioidMed.dispenseRequest.validityPeriod<br>
      end]</p>



<a name="189999021"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Syntax%20error/near/189999021" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Syntax.20error.html#189999021">(Mar 08 2020 at 04:24)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="249396">@Tien Thai</span> , the issue is that the <a href="http://hl7.org/fhir/medicationrequest-definitions.html#MedicationRequest.dispenseRequest.expectedSupplyDuration" target="_blank" title="http://hl7.org/fhir/medicationrequest-definitions.html#MedicationRequest.dispenseRequest.expectedSupplyDuration">MedicationRequest.dispenseRequest.expectedSupplyDuration</a> element is a <a href="http://hl7.org/fhir/datatypes.html#Duration" target="_blank" title="http://hl7.org/fhir/datatypes.html#Duration">Duration</a>, which is a special type of Quantity, which means it has value and unit elements. So to create a Quantity out of it, you have to access the <code>value</code> element:</p>
<div class="codehilite"><pre><span></span>define function &quot;MedicationRelevantPeriod&quot;(OpioidMed &quot;MedicationRequest&quot;):
Interval[start of OpioidMed.dispenseRequest.validityPeriod,
case
when OpioidMed.dispenseRequest.expectedSupplyDuration is not null
then start of OpioidMed.dispenseRequest.validityPeriod + System.Quantity { value: OpioidMed.dispenseRequest.expectedSupplyDuration.value, unit: &#39;d&#39; }
else
end of OpioidMed.dispenseRequest.validityPeriod
end]
</pre></div>



<a name="190197726"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Syntax%20error/near/190197726" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mohammad Afaq Khan <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Syntax.20error.html#190197726">(Mar 10 2020 at 17:02)</a>:</h4>
<p><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> what is the future of CQL &amp; FHIR with machine learning? I mean I know JSON is compatible with so many different frameworks and even Tensorflow. Is there any future prospect integration with TensorFlow?</p>



<a name="190237515"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Syntax%20error/near/190237515" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Syntax.20error.html#190237515">(Mar 10 2020 at 23:36)</a>:</h4>
<p>It's certainly a possibility, and there's a FHIR tracker about supporting machine learning models with the Library resource (<a href="http://jira.hl7.org/browse/FHIR-25046" target="_blank" title="http://jira.hl7.org/browse/FHIR-25046">J#25046</a>). We've also looked at supporting predictive models as <code>external</code> calls in CQL, and enabling machine learning is a key motivator for computable guidelines work with FHIR and CQL. Would welcome any feedback on that topic, and be very interested to hear if you've done any exploration along those lines.</p>



<a name="190291614"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Syntax%20error/near/190291614" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mohammad Afaq Khan <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Syntax.20error.html#190291614">(Mar 11 2020 at 15:07)</a>:</h4>
<p>Unfortunately, I am exploring this area as well. I think it will definitely become very important in the future. Hopefully, I can catchup on this topic to be able to provide relevant feedback in time <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span> .</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
