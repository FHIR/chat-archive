---
layout: page
title: "FHIR Chat  · cql with statement · cql"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/index.html">cql</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20with.20statement.html">cql with statement</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="241626855"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20with%20statement/near/241626855" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vasyl Herman <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20with.20statement.html#241626855">(Jun 05 2021 at 09:37)</a>:</h4>
<p>Hi, folks! Could you please explain what the <code>with</code> means in this example:</p>
<div class="codehilite" data-code-language="SQL"><pre><span></span><code><span class="n">define</span> <span class="ss">"Outpatient Encounters with Advanced Illness"</span><span class="p">:</span>
  <span class="p">(</span> <span class="p">[</span><span class="n">Encounter</span><span class="p">:</span> <span class="ss">"Outpatient"</span><span class="p">]</span>
      <span class="k">union</span> <span class="p">[</span><span class="n">Encounter</span><span class="p">:</span> <span class="ss">"Nonacute Inpatient"</span><span class="p">]</span> <span class="p">)</span> <span class="n">OutpatientEncounter</span>
       <span class="k">with</span> <span class="p">[</span><span class="n">Condition</span><span class="p">:</span> <span class="ss">"Advanced Illness"</span><span class="p">]</span> <span class="n">AdvancedIllnessDiagnosis</span>
      <span class="n">such</span> <span class="n">that</span> <span class="k">exists</span> <span class="p">(</span>
      <span class="n">OutpatientEncounter</span><span class="p">.</span><span class="n">diagnosis</span><span class="p">.</span><span class="n">condition</span> <span class="n">EncounterDiagnosis</span>
      <span class="k">where</span> <span class="n">EndsWith</span><span class="p">(</span><span class="n">EncounterDiagnosis</span><span class="p">.</span><span class="n">reference</span><span class="p">,</span> <span class="n">AdvancedIllnessDiagnosis</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
      <span class="p">)</span>
      <span class="k">and</span> <span class="n">OutpatientEncounter</span><span class="p">.</span><span class="k">period</span> <span class="n">starts</span> <span class="mi">2</span> <span class="n">years</span> <span class="k">or</span> <span class="k">less</span> <span class="k">on</span> <span class="k">or</span> <span class="k">before</span>
      <span class="k">end</span> <span class="k">of</span> <span class="ss">"Measurement Period"</span>
</code></pre></div>
<p>I can't get what <code>with [Condition: "Advanced Illness"] AdvancedIllnessDiagnosis</code> means.<br>
Thanks!</p>



<a name="241776471"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20with%20statement/near/241776471" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Riley <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20with.20statement.html#241776471">(Jun 07 2021 at 13:32)</a>:</h4>
<p>With clause is making the return type a list of TUPLES where the tuple is every A and B set together where the criteria fires. So this is every encounter tested against every condition.<br>
The first clause is a standard reference check in fhir. It's checking if the reference string "EndsWith" the id of the Condition. because the format of references are like "Condition/12345".<br>
The  2nd criteria Is referencing an external definition but it's basically doing a time-check.<br>
So this is a time check for encounters that happened 2 years or less from Measurement Period, but we are also including the condition related to the encounter in the result.</p>



<a name="241788929"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20with%20statement/near/241788929" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Riley <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20with.20statement.html#241788929">(Jun 07 2021 at 14:56)</a>:</h4>
<p>The way to read this as a series of blocks is<br>
Definition Header</p>
<div class="codehilite"><pre><span></span><code>define &quot;Outpatient Encounters with Advanced Illness&quot;:
</code></pre></div>
<p>Retrievals</p>
<div class="codehilite"><pre><span></span><code>  ( [Encounter: &quot;Outpatient&quot;]
      union [Encounter: &quot;Nonacute Inpatient&quot;] ) OutpatientEncounter
       with [Condition: &quot;Advanced Illness&quot;] AdvancedIllnessDiagnosis
</code></pre></div>
<p>Filters/Criteria</p>
<div class="codehilite"><pre><span></span><code>      such that exists (
      OutpatientEncounter.diagnosis.condition EncounterDiagnosis
      where EndsWith(EncounterDiagnosis.reference, AdvancedIllnessDiagnosis.id)
      )
      and OutpatientEncounter.period starts 2 years or less on or before
      end of &quot;Measurement Period&quot;
</code></pre></div>



<a name="241790061"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20with%20statement/near/241790061" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vasyl Herman <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20with.20statement.html#241790061">(Jun 07 2021 at 15:03)</a>:</h4>
<p>Michael, I appreciate it ! It's very clear now!<br>
Is there a documentation somewhere about it?<br>
Thanks!</p>



<a name="241790627"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20with%20statement/near/241790627" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Silva <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20with.20statement.html#241790627">(Jun 07 2021 at 15:06)</a>:</h4>
<p><a href="https://cql.hl7.org/">https://cql.hl7.org/</a></p>



<a name="241790695"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20with%20statement/near/241790695" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20with.20statement.html#241790695">(Jun 07 2021 at 15:07)</a>:</h4>
<p>Specifically - <a href="https://cql.hl7.org/02-authorsguide.html#relationships">https://cql.hl7.org/02-authorsguide.html#relationships</a></p>



<a name="241796742"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20with%20statement/near/241796742" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Riley <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20with.20statement.html#241796742">(Jun 07 2021 at 15:44)</a>:</h4>
<p><span class="user-mention" data-user-id="194178">@JP</span> I have never seen the FHIR cql library properly enforce relationships through the with clause, hence why we need to use filter clauses like this to link them. I'm sure other QDM models do, but is this functionality in cql-fhir now? And if it's not, what would be needed to do so?</p>



<a name="241797306"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20with%20statement/near/241797306" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20with.20statement.html#241797306">(Jun 07 2021 at 15:48)</a>:</h4>
<p>I don't quite follow what you mean by "properly enforce relationships". Would you mind giving me an example of what you mean and what your expected behavior would be?</p>



<a name="241813873"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20with%20statement/near/241813873" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Riley <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20with.20statement.html#241813873">(Jun 07 2021 at 17:45)</a>:</h4>
<p>I might be describing a personal assumption/perference, not an actual aspect of the language, so maybe I shouldn't use the word "proper", sorry.</p>
<p>Let's say I have Condition A B and C, and Encounters D E and F and the relationships via the field "Encounter.diagnosis.condition.reference" in the Encounter FHIR resource maps out like this.<br>
D-&gt;A<br>
E-&gt;B<br>
F-&gt;C<br>
So each Encounter is associated to a different Condition. In the retrieval block I would perfer the <code>with</code> clause to only pull the tuples (A,D), (B,E), and (C,F). However I believe (haven't tested this recently) the example pulls all combinations of tuples instead: (A,D),(A,E),(A,F),(B,D),(B,E),(B,F),(C,D),(C,E),(C,F). Which is why we have to use the reference criteria block in the first place: to filter out the 6 tuples that aren't linked together.</p>
<p>When I'm trying to write a multi-query definition sometimes I do want to compare 2 separate sets to each other, but most often I'm actually just trying to pull DIRECTLY RELATED resources together. They're not really 2 different medical context, it's actually just the same medical context across 2 different resources. Maybe the <code>with</code> clause isn't the best structure to be doing that with, but it might be helpful to have a <code>with linked</code> keyword or something similar to that in the grammar because that's usually what I want to do.</p>



<a name="242267906"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20with%20statement/near/242267906" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20with.20statement.html#242267906">(Jun 10 2021 at 20:42)</a>:</h4>
<p><span class="user-mention" data-user-id="194612">@Michael Riley</span> , yes, the with clause is only for cases where you are filtering by the relationship, not for cases where you actually want the data from both sources. You can still do this without using a multi-source query, using the <code>let</code> clause:</p>
<div class="codehilite"><pre><span></span><code>define MedicationRequestAndEncounter:
  [MedicationRequest] M
    let E: [Encounter: id = Last(Split(M.encounter.reference, &#39;/&#39;))]
    return { medicationRequest: M, encounter: E }
</code></pre></div>



<a name="242751949"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20with%20statement/near/242751949" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Riley <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20with.20statement.html#242751949">(Jun 15 2021 at 15:33)</a>:</h4>
<p><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> Is that a valid retreival for FHIR resources? id is not a searchable parameter in FHIR, so you can't create a searchset from a set of ids.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
