---
layout: page
title: "FHIR Chat  · ValueSet Typing · cql"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/index.html">cql</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/ValueSet.20Typing.html">ValueSet Typing</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="224387596"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/ValueSet%20Typing/near/224387596" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Ryan <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/ValueSet.20Typing.html#224387596">(Jan 28 2021 at 20:25)</a>:</h4>
<p>Hi all,<br>
We are running into an execution issue when attempting to pass value sets into functions, and would like to see if anyone has any input on our current predicament. </p>
<p>I've attached a Word document with screenshots; references below.<br>
<a href="/user_uploads/10155/6y7u5c2hKNKl6RRUb1_vjAwg/Value-Set-Testing-Examples.pdf">Value-Set-Testing-Examples.pdf</a></p>
<p>Current specs:<br>
    cql-execution v2.1.0<br>
    cql-exex-fhir v1.5.0<br>
    cql v1.4.9</p>
<p>Intellisense seems to think that the return of a value set should be a List&lt;System.Code&gt;, see Figures 1 &amp; 2.</p>
<p>However, when executing the same CQL from Figure 1, we are left with a return consisting of an array of "oid", "version", and "codes". See Figure 3.</p>
<p>This is causing issues when calling value sets from functions where the value set is a parameter with a type of List&lt;System.Code&gt;, as seen in Figure 4.</p>
<p>The elm builds just fine for the code found in Figure 4, but will not execute.</p>
<p>However, the same code but with an explicit call to “URI”, runs just fine and as expected. Refer to Figure 5.</p>
<p>So, it seems that there’s a discrepancy with typing for both IntelliSense and cql-to-elm 1.4.9, as compared to v2.1.0 of the engine.</p>
<p>Is there a suggested workaround or solution that would allow us to pass value sets as function parameters?</p>
<p>Also tagging in <span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> . </p>
<p>Thanks in advance,<br>
Michael</p>



<a name="224594921"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/ValueSet%20Typing/near/224594921" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/ValueSet.20Typing.html#224594921">(Jan 30 2021 at 17:12)</a>:</h4>
<p>Hmm.... that seems like it should work, but I'm more familiar with the Java-based engine than with the JavaScript one. Have you tried a focused repro in the Atom plugin?</p>



<a name="226845250"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/ValueSet%20Typing/near/226845250" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/ValueSet.20Typing.html#226845250">(Feb 18 2021 at 17:10)</a>:</h4>
<p>Bryn - problems actually start with ELM generation and proceed from there.  Here's a minimal example:</p>
<p>CQL:<br>
<a href="/user_uploads/10155/IGnw6yxAdaGMWnSdv2pi8ONa/image.png">image.png</a> </p>
<div class="message_inline_image"><a href="/user_uploads/10155/IGnw6yxAdaGMWnSdv2pi8ONa/image.png" title="image.png"><img src="/user_uploads/10155/IGnw6yxAdaGMWnSdv2pi8ONa/image.png"></a></div><p>ELM generated for "Test1" -- notice the "InValueSet" type:<br>
<a href="/user_uploads/10155/UwzOMCkdyZM7VdxMvMhcGPyX/image.png">image.png</a> </p>
<div class="message_inline_image"><a href="/user_uploads/10155/UwzOMCkdyZM7VdxMvMhcGPyX/image.png" title="image.png"><img src="/user_uploads/10155/UwzOMCkdyZM7VdxMvMhcGPyX/image.png"></a></div><p>ELM generated for "Test2" -- notice the "In" type<br>
<a href="/user_uploads/10155/tVXMEqOpNdDh5eJSP-2omFJc/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/10155/tVXMEqOpNdDh5eJSP-2omFJc/image.png" title="image.png"><img src="/user_uploads/10155/tVXMEqOpNdDh5eJSP-2omFJc/image.png"></a></div>



<a name="226851104"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/ValueSet%20Typing/near/226851104" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/ValueSet.20Typing.html#226851104">(Feb 18 2021 at 17:52)</a>:</h4>
<p>That's the correct ELM generation for that pattern in CQL 1.4. The translator explicitly detects ValueSetRef when used with In to output an InValueSet, this is to ensure that the engines understand when they're being asked to do value set membership so they can pass it to a terminology service to perform.</p>



<a name="226851202"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/ValueSet%20Typing/near/226851202" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/ValueSet.20Typing.html#226851202">(Feb 18 2021 at 17:53)</a>:</h4>
<p>Calling it in a function like that results in a direct evaluation of a ValueSetRef, which my guess is that is not supported by the JavaScript engine. Tagging <span class="user-mention" data-user-id="191469">@Chris Moesel</span> for thoughts here?</p>



<a name="226854331"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/ValueSet%20Typing/near/226854331" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/ValueSet.20Typing.html#226854331">(Feb 18 2021 at 18:14)</a>:</h4>
<p>Correct -- that JavaScript engine does not yet support that.  In fact, I thought that the ability to pass value set references around as function arguments wasn't introduced until CQL 1.5.  Was it actually introduced in CQL 1.4?  Is it normative?</p>



<a name="226854640"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/ValueSet%20Typing/near/226854640" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/ValueSet.20Typing.html#226854640">(Feb 18 2021 at 18:16)</a>:</h4>
<p>Also, sorry I did not notice this thread until now...</p>



<a name="226857459"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/ValueSet%20Typing/near/226857459" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/ValueSet.20Typing.html#226857459">(Feb 18 2021 at 18:33)</a>:</h4>
<p>Passing ValueSetRefs as arguments is allowed in 1.4 (and all versions, really, it's always been a possibility), but it is discouraged since it is effectively asking the engine to perform a value set expansion at that point.</p>



<a name="226857537"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/ValueSet%20Typing/near/226857537" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/ValueSet.20Typing.html#226857537">(Feb 18 2021 at 18:33)</a>:</h4>
<p>In 1.5 we introduced ValueSet as a first class type (along with CodeSystem) so that you could pass them by reference and avoid the expansion.</p>



<a name="226857655"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/ValueSet%20Typing/near/226857655" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/ValueSet.20Typing.html#226857655">(Feb 18 2021 at 18:34)</a>:</h4>
<p>It still has the significant downside that it inhibits static analysis of data requirements though.</p>



<a name="226858040"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/ValueSet%20Typing/near/226858040" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/ValueSet.20Typing.html#226858040">(Feb 18 2021 at 18:36)</a>:</h4>
<p>Ah right.  That's what I was thinking of in 1.5. ("ValueSet as a first class type").  As for supporting <code>ValueSetRef</code>s as arguments to functions (requiring expansion), I'd have to look at that more closely to determine how difficult (or not) it would be to support it in the JS engine.</p>



<a name="226859430"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/ValueSet%20Typing/near/226859430" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/ValueSet.20Typing.html#226859430">(Feb 18 2021 at 18:44)</a>:</h4>
<p>Seems worthy of a specific CQL capability: <a href="https://github.com/cqframework/clinical_quality_language/issues/602">https://github.com/cqframework/clinical_quality_language/issues/602</a></p>



<a name="226865250"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/ValueSet%20Typing/near/226865250" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/ValueSet.20Typing.html#226865250">(Feb 18 2021 at 19:22)</a>:</h4>
<p><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> so Test1 is correct in ELM, but Test2 in the example is using the "In" type so it is interpreted as a List In(<a href="https://cql.hl7.org/09-b-cqlreference.html#in-1">https://cql.hl7.org/09-b-cqlreference.html#in-1</a>) rather than a ValueSet "In"(<a href="https://cql.hl7.org/09-b-cqlreference.html#in-valueset">https://cql.hl7.org/09-b-cqlreference.html#in-valueset</a>).  Consequently in Test2, care has to be made to normalize valueset comparisons as list comparisons.</p>
<p>Provided the ELM is changed to be "InValueSet" for both Test1 and Test2, the change in the CQL engine is straightforward.  Just need a check for OperandRef and an exec to resolve.  I thought about doing a pull request, but prob not worthwhile because of the CQL 1.5 changes coming.</p>
<p>It's also worth mentioning that since the v1.5.1 cql-to-elm transpiler already implements System.Valueset, but the engine doesn't, this scenario simply doesn't work on latest releases.  Should the v1.5.0 and v1.5.1 cql-to-elm and corresponding packages be marked as betas?</p>



<a name="226865600"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/ValueSet%20Typing/near/226865600" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/ValueSet.20Typing.html#226865600">(Feb 18 2021 at 19:24)</a>:</h4>
<p>There is a 1.5.1 translator release, but it is not a complete implementation of 1.5 support (specifically, support for trial-use capabilities is still being finalized)</p>



<a name="226866825"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/ValueSet%20Typing/near/226866825" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/ValueSet.20Typing.html#226866825">(Feb 18 2021 at 19:32)</a>:</h4>
<p>Right.  Folks may not realize this is a breaking change from v1.4 to v1.5, the Atom extension is already using it, and CQL written in Atom against it won't run in the engine.</p>
<p><a href="https://github.com/cqframework/atom_cql_support/blob/master/package.json">https://github.com/cqframework/atom_cql_support/blob/master/package.json</a><br>
<a href="/user_uploads/10155/n8dEDsekRmY-jgmm2T5eX-Xr/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/10155/n8dEDsekRmY-jgmm2T5eX-Xr/image.png" title="image.png"><img src="/user_uploads/10155/n8dEDsekRmY-jgmm2T5eX-Xr/image.png"></a></div>



<a name="226872509"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/ValueSet%20Typing/near/226872509" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/ValueSet.20Typing.html#226872509">(Feb 18 2021 at 20:10)</a>:</h4>
<p>I don't see that as a breaking change from the perspective of the language. To get the new capability you have to use the newly defined terminology types, so the library as written would still translate the same way (using a ValueSetRef) in 1.5. That particular capability of 1.4 is not supported by the JavaScript engine, but it's not a breaking change in the language, right?</p>



<a name="242091501"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/ValueSet%20Typing/near/242091501" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bill Baar <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/ValueSet.20Typing.html#242091501">(Jun 09 2021 at 16:15)</a>:</h4>
<p>Tagging <span class="user-mention" data-user-id="372239">@Michael Ryan</span>  </p>
<p>I'm still stuck on a solution.  I have this code:</p>
<p>define function "VS Cast Function"(VSet List&lt;System.Code&gt;):<br>
  ( ( cast { "VSet", 1 }[0]as Tuple {<br>
      codes List&lt;System.Code&gt;,<br>
      oid System.String,<br>
      version System.String<br>
    }<br>
  ).codes ) VSetCodes<br>
    return System.Code { code: VSetCodes.code, system: VSetCodes.system }</p>
<p>And we've revised it to this:</p>
<p>define function "VS Cast Function"(VSet System.ValueSet):<br>
  ( ( cast { "VSet", 1 }[0]as Tuple {<br>
      codes System.ValueSet,<br>
      oid System.String,<br>
      version System.String<br>
    }<br>
  ).codes ) VSetCodes<br>
    return System.Code { code: VSetCodes.code, system: VSetCodes.system }</p>
<p>The fellow next to me gets now errors but I am stuck with this message: Member code not found for type System.ValueSet. We're both using Atom, CQL 1.5 and FHIR 4.0.1 and the code came from <a href="https://github.com/cqframework/ecqm-content-r4-2021">https://github.com/cqframework/ecqm-content-r4-2021</a>.  The solution suggested here is to change the ELM to InValueSet?</p>



<a name="242105475"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/ValueSet%20Typing/near/242105475" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Ryan <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/ValueSet.20Typing.html#242105475">(Jun 09 2021 at 17:58)</a>:</h4>
<p>Bill,</p>
<p>I tried to mock up what I think should be your solution, it requires the below modification to the Claims library function "Medical Claims With Diagnosis":<br>
<a href="user_uploads/10155/b4gKZfvOj_UaM7y_LiQrfSsY/image.png">image.png</a> </p>
<div class="message_inline_image"><a href="user_uploads/10155/b4gKZfvOj_UaM7y_LiQrfSsY/image.png" title="image.png"><img src="user_uploads/10155/b4gKZfvOj_UaM7y_LiQrfSsY/image.png"></a></div><p>A caveat being that I cannot test this in my environment, which is why we created the "VS Cast Function" in the first place.</p>
<p>You should also modify NCQA_AdvancedIllnessandFrailty to:</p>
<ol>
<li>
<p>Comment out "Advanced Illness ValueSet" definition.</p>
</li>
<li>
<p>Replace all instances of "Advanced Illness ValueSet" with "Advanced Illness".</p>
</li>
</ol>
<p>I <strong>think</strong> that would work, but again I cannot verify.</p>
<p><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> and <span class="user-mention" data-user-id="390592">@Brian</span>  feel free to weigh in or correct my response.</p>
<p>Thanks,<br>
Michael</p>



<a name="243053564"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/ValueSet%20Typing/near/243053564" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vasyl Herman <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/ValueSet.20Typing.html#243053564">(Jun 17 2021 at 17:27)</a>:</h4>
<p>Hi, <span class="user-mention" data-user-id="372239">@Michael Ryan</span> <br>
I did modification to the Claims library "Medical Claims With Diagnosis" as you are suggesting:<br>
<a href="/user_uploads/10155/gnPQQA1UiseRdr1hO9i_eq-G/image.png">image.png</a> <br>
Then modified NCQA_AdvencedIllnessandFrailty. Unfortunately it doesn't work:<br>
<a href="/user_uploads/10155/o9TGFwh23HSbatbirQH4KyB0/image.png">image.png</a> <br>
I have got an <code>Could not resolve call to operator Medical Claims With Diagnosis with signature (list&lt;FHIR.Claim&gt;,System.ValueSet).</code></p>
<div class="message_inline_image"><a href="/user_uploads/10155/gnPQQA1UiseRdr1hO9i_eq-G/image.png" title="image.png"><img src="/user_uploads/10155/gnPQQA1UiseRdr1hO9i_eq-G/image.png"></a></div><div class="message_inline_image"><a href="/user_uploads/10155/o9TGFwh23HSbatbirQH4KyB0/image.png" title="image.png"><img src="/user_uploads/10155/o9TGFwh23HSbatbirQH4KyB0/image.png"></a></div>



<a name="243054882"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/ValueSet%20Typing/near/243054882" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vasyl Herman <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/ValueSet.20Typing.html#243054882">(Jun 17 2021 at 17:36)</a>:</h4>
<p>Still no support for JS Engine? or should work now?</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
