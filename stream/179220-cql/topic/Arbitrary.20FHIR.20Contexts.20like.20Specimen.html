---
layout: page
title: "FHIR Chat  · Arbitrary FHIR Contexts like Specimen · cql"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/index.html">cql</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Arbitrary.20FHIR.20Contexts.20like.20Specimen.html">Arbitrary FHIR Contexts like Specimen</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="173555710"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Arbitrary%20FHIR%20Contexts%20like%20Specimen/near/173555710" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Kiel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Arbitrary.20FHIR.20Contexts.20like.20Specimen.html#173555710">(Aug 19 2019 at 16:01)</a>:</h4>
<p><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span>  We like to count Specimens using $evaluate-measure and CQL. If I understand the mechanics of $evaluate-measure correctly, we need to specify a context of Specimen in CQL in order to be able to have a <code>InInitialPopulation</code> expression which is a predicate of Specimen in this case. In the CQL Authors Guide v1.4.1 under 1.6 Context, the contexts Patient and Practitioner are only examples. According to:</p>
<blockquote>
<p>Depending on different needs, models may define any context appropriate to their use case, but should identify a default context that is used when authors do not declare a specific context.</p>
</blockquote>
<p>contexts for all FHIR Resource types should be possible. </p>
<p>Currently I get the following error with <code>info.cqframework/cql-to-elm "1.4.6"</code>:</p>
<div class="codehilite"><pre><span></span>Could not resolve context name Specimen in model FHIR.
</pre></div>


<p>Would it be possible and the right idea to allow every FHIR Resource type as context in the model FHIR?</p>



<a name="173567937"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Arbitrary%20FHIR%20Contexts%20like%20Specimen/near/173567937" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Arbitrary.20FHIR.20Contexts.20like.20Specimen.html#173567937">(Aug 19 2019 at 18:41)</a>:</h4>
<p>We had planned on using CompartmentDefinition to specify the allowed contexts, because in addition to the resource type, we need to know the relationships to other resources (and that information needs to be part of the underlying model so the data access layer is capable of evaluating the context-specific query).</p>



<a name="173568057"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Arbitrary%20FHIR%20Contexts%20like%20Specimen/near/173568057" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Arbitrary.20FHIR.20Contexts.20like.20Specimen.html#173568057">(Aug 19 2019 at 18:42)</a>:</h4>
<p>So a server could define a CompartmentDefinition to support Specimen and then bring that in to the CQL with a specific model info.</p>



<a name="173568082"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Arbitrary%20FHIR%20Contexts%20like%20Specimen/near/173568082" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Arbitrary.20FHIR.20Contexts.20like.20Specimen.html#173568082">(Aug 19 2019 at 18:42)</a>:</h4>
<p>But specifying every FHIR Resource type would require CompartmentDefinitions for every resource.</p>



<a name="173631227"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Arbitrary%20FHIR%20Contexts%20like%20Specimen/near/173631227" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Kiel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Arbitrary.20FHIR.20Contexts.20like.20Specimen.html#173631227">(Aug 20 2019 at 05:55)</a>:</h4>
<p>Ok I can supply the CompartmentDefinition myself? I‘ll have a look at it.</p>



<a name="173631354"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Arbitrary%20FHIR%20Contexts%20like%20Specimen/near/173631354" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Arbitrary.20FHIR.20Contexts.20like.20Specimen.html#173631354">(Aug 20 2019 at 05:58)</a>:</h4>
<p>Well, yes, assuming you have a server that knows how to dynamically apply a CompartmentDefinition :)</p>



<a name="173641060"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Arbitrary%20FHIR%20Contexts%20like%20Specimen/near/173641060" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Kiel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Arbitrary.20FHIR.20Contexts.20like.20Specimen.html#173641060">(Aug 20 2019 at 09:17)</a>:</h4>
<p>I have my own Server and I see that CompartmentDefinition is the thing I need for the context. But I don't see the class CompartmentDefinition used in cql-to-elm. All I need is the cql-to-elm translater translaing my CQL with specimen context into ELM. The rest I do myself.</p>



<a name="173689132"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Arbitrary%20FHIR%20Contexts%20like%20Specimen/near/173689132" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Arbitrary.20FHIR.20Contexts.20like.20Specimen.html#173689132">(Aug 20 2019 at 19:43)</a>:</h4>
<p>Yeah, the translator would not reference CompartmentDefinition, the ModelInfo would have that information represented using ContextInfo (so you could say <code>context Specimen</code></p>



<a name="173689149"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Arbitrary%20FHIR%20Contexts%20like%20Specimen/near/173689149" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Arbitrary.20FHIR.20Contexts.20like.20Specimen.html#173689149">(Aug 20 2019 at 19:44)</a>:</h4>
<p>In other words, this would need to be a change to the FHIR model info file used by the translator.</p>



<a name="173794865"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Arbitrary%20FHIR%20Contexts%20like%20Specimen/near/173794865" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Kiel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Arbitrary.20FHIR.20Contexts.20like.20Specimen.html#173794865">(Aug 21 2019 at 13:43)</a>:</h4>
<p>Thanks I'm able to have a Specimen context by adding the following into <code>fhir-modelinfo-4.0.0.xml</code> and load it with <code>CqlTranslator.loadModelInfo</code>:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;ns4:contextInfo</span> <span class="na">name=</span><span class="s">&quot;Patient&quot;</span> <span class="na">keyElement=</span><span class="s">&quot;id&quot;</span> <span class="na">birthDateElement=</span><span class="s">&quot;birthDate.value&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ns4:contextType</span> <span class="na">name=</span><span class="s">&quot;FHIR.Patient&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/ns4:contextInfo&gt;</span>
<span class="nt">&lt;ns4:contextInfo</span> <span class="na">name=</span><span class="s">&quot;Specimen&quot;</span> <span class="na">keyElement=</span><span class="s">&quot;id&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ns4:contextType</span> <span class="na">name=</span><span class="s">&quot;FHIR.Specimen&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/ns4:contextInfo&gt;</span>
</pre></div>


<p>First queries like</p>
<div class="codehilite"><pre><span></span>library Retrieve
using FHIR version &#39;4.0.0&#39;
include FHIRHelpers version &#39;4.0.0&#39;

codesystem SampleMaterialType: &#39;https://fhir.bbmri.de/CodeSystem/SampleMaterialType&#39;

context Specimen

define InInitialPopulation:
  Specimen.type.coding ~ Code &#39;whole-blood&#39; from SampleMaterialType
</pre></div>


<p>translate.</p>
<p><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span>  What would be the way to get such special contexts into the official lib?</p>



<a name="173811005"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Arbitrary%20FHIR%20Contexts%20like%20Specimen/near/173811005" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Arbitrary.20FHIR.20Contexts.20like.20Specimen.html#173811005">(Aug 21 2019 at 16:36)</a>:</h4>
<p>For the FHIR model info, we derive that from the FHIR specification, so a compartment definition there would be the driver for that.</p>



<a name="173811022"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Arbitrary%20FHIR%20Contexts%20like%20Specimen/near/173811022" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Arbitrary.20FHIR.20Contexts.20like.20Specimen.html#173811022">(Aug 21 2019 at 16:36)</a>:</h4>
<p>What are the relationships to other resources?</p>



<a name="173861269"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Arbitrary%20FHIR%20Contexts%20like%20Specimen/near/173861269" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Kiel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Arbitrary.20FHIR.20Contexts.20like.20Specimen.html#173861269">(Aug 22 2019 at 08:05)</a>:</h4>
<p>From Specimen we need relationships to Patient and Organization at the Moment. But in the ModelInfo I don't see any context specific relationships specified. Where can I find the transformation tool from FHIR StructureDefinitions and CompartmentDefinitions to ModelInfo?</p>



<a name="173866303"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Arbitrary%20FHIR%20Contexts%20like%20Specimen/near/173866303" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Arbitrary.20FHIR.20Contexts.20like.20Specimen.html#173866303">(Aug 22 2019 at 09:30)</a>:</h4>
<p>Tooling to generate ModelInfo from StructureDefinitions is here: <a href="https://github.com/cqframework/cqf-tooling/blob/master/src/main/java/org/opencds/cqf/modelinfo/StructureDefinitionToModelInfo.java" target="_blank" title="https://github.com/cqframework/cqf-tooling/blob/master/src/main/java/org/opencds/cqf/modelinfo/StructureDefinitionToModelInfo.java">https://github.com/cqframework/cqf-tooling/blob/master/src/main/java/org/opencds/cqf/modelinfo/StructureDefinitionToModelInfo.java</a></p>



<a name="173866438"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Arbitrary%20FHIR%20Contexts%20like%20Specimen/near/173866438" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Arbitrary.20FHIR.20Contexts.20like.20Specimen.html#173866438">(Aug 22 2019 at 09:32)</a>:</h4>
<p>The CompartmentDefinition processing isn't automated yet; but would be quite easy to add to that, just haven't gotten there yet. There is a RelationshipInfo element in the ModelInfo that specifies how contexts are related to resources in the model. Would just be a matter of adding relationship infos generated from the CompartmentDefinition.</p>



<a name="174716903"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Arbitrary%20FHIR%20Contexts%20like%20Specimen/near/174716903" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Kiel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Arbitrary.20FHIR.20Contexts.20like.20Specimen.html#174716903">(Sep 02 2019 at 13:20)</a>:</h4>
<p>Should the <code>InInitialPopulation</code> expression in this library interpreted as: </p>
<p>"Has the subject of the specimen, currently in context, the gender male?"</p>
<p>If so, the retrieve expression <code>[Patient]</code> returns the one subject of the specimen in context - right?</p>
<p>At the end, I'll need a CompartmentDefinition for Specimen - I know.</p>
<div class="codehilite"><pre><span></span>library Retrieve
using FHIR version &#39;4.0.0&#39;
include FHIRHelpers version &#39;4.0.0&#39;

context Specimen

define InInitialPopulation:
  from [Patient] P where P.gender = &#39;male&#39;
</pre></div>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
