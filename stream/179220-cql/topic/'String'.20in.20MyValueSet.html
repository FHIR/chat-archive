---
layout: page
title: "FHIR Chat  · &#x27;String&#x27; in MyValueSet · cql"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/index.html">cql</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/&#x27;String&#x27;.20in.20MyValueSet.html">&#x27;String&#x27; in MyValueSet</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="261322567"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/%27String%27%20in%20MyValueSet/near/261322567" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Corey Sanders <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/&#x27;String&#x27;.20in.20MyValueSet.html#261322567">(Nov 12 2021 at 23:02)</a>:</h4>
<p>The CQL grammar allows for an expression <code>'String' in MyValueSet</code>. I'm trying to figure out how that should work in practice.</p>
<p><a href="https://cql.hl7.org/02-authorsguide.html#terminology-operators">Section 5.8.3. Terminology Operations</a> says that valueset membership is based strictly on the definition of equivalence. Equivalence for codes means that both system and code must match. If either side has just a code value and the other side has both code and system, the equivalence operation will return null.</p>
<p>1) The Java engine treats 'String' in the above expression as a Code object with a code value and null system. It passes that code object to the <code>TerminologyProvider.in(...)</code>method and the <code>R4RestFhirTerminologyProvider.in(...)</code> implementation of the TerminologyProvider will then build a request to the FHIR server ValueSet/$validate-code operation that includes a <code>code</code> parameter and optionally a <code>system</code> parameter if the system is specified in the code object. For the <code>'String' in MyValueSet</code> expression the system is always null, so the parameter isn't passed to the FHIR server.</p>
<p>The <a href="https://www.hl7.org/fhir/valueset-operation-validate-code.html">FHIR spec for $validate-code</a> says that if a code parameter is specified, then either a <code>context</code> or <code>system</code> parameter <em>MUST</em> also be provided in the validate-code request, so there seems to be a disconnect here. It shouldn't be legal to send only the <code>code</code> parameter. I confirmed at least on the IBM FHIR server I use for CQL evaluation that the ValueSet/$validate-code operation does require the system parameter when code is specified. The $validate-code throws an error if system isn't specified.</p>
<p>As one last note, the <a href="https://www.hl7.org/fhir/valueset.html">ValueSet specification</a> requires that system be present for any included codes. Strictly from a FHIR R4 perspective, you shouldn't be able to lookup a code that doesn't contain a system in a valueset. The valueset won't contain codes without system.</p>
<p>2) The <a href="https://github.com/cqframework/cql-execution/blob/b0f53070cdace518adc307ed5ec7afe0086883c3/src/datatypes/clinical.js#L67">Javascript engine</a> takes some pretty reasonable liberties when trying to handle this case. It will allow string containership as long as all the codes in the valueset share a common system value. If not, an "In (valueset) is ambiguous" error is thrown.</p>
<p>3) I tried to review samply/blaze to see how it was handled there, but as best as I can tell from <a href="https://github.com/samply/blaze/blob/a5eb4922ea9ef3cd1cec87b92a7ed3b545a56577/docs/conformance/cql.md">the conformance statement</a> the InValueSet operation is still TBD right now.</p>
<p>So, what is the expected behavior here? The design clearly allows for non-FHIR terminology support, so the FHIR rules need not apply, but that is the main use case and the Java implementation doesn't really support FHIR correctly as-is. The Javascript logic seems reasonable, but wouldn't be supported by the FHIR validate-code operation.</p>



<a name="261376724"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/%27String%27%20in%20MyValueSet/near/261376724" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/&#x27;String&#x27;.20in.20MyValueSet.html#261376724">(Nov 13 2021 at 19:47)</a>:</h4>
<p>The string overload of in is a special case that we allowed for simplicity, but that overload has specific evaluation semantics: <a href="https://cql.hl7.org/09-b-cqlreference.html#in-valueset">https://cql.hl7.org/09-b-cqlreference.html#in-valueset</a></p>



<a name="261376895"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/%27String%27%20in%20MyValueSet/near/261376895" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/&#x27;String&#x27;.20in.20MyValueSet.html#261376895">(Nov 13 2021 at 19:51)</a>:</h4>
<p>Based on those semantics, I don't think the Java implementation is doing the right thing here, because you're right, it couldn't be evaluated as a FHIR ValueSet membership test. It would actually have to be evaluated as:<br>
<code>'String' in (MyValueSet X return X.code)</code> and even then, there would have to be a check to make sure that <code>(MyValueSet X return X.code) = (MyValueSet X return all X.code)</code>.</p>



<a name="261376944"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/%27String%27%20in%20MyValueSet/near/261376944" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/&#x27;String&#x27;.20in.20MyValueSet.html#261376944">(Nov 13 2021 at 19:52)</a>:</h4>
<p>In the case that the ValueSet is also the default ValueSet for a given CodeSystem, an implementation could provide that system.</p>



<a name="261377035"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/%27String%27%20in%20MyValueSet/near/261377035" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/&#x27;String&#x27;.20in.20MyValueSet.html#261377035">(Nov 13 2021 at 19:54)</a>:</h4>
<p><a href="https://github.com/DBCG/cql_engine/issues/514">https://github.com/DBCG/cql_engine/issues/514</a></p>



<a name="261512957"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/%27String%27%20in%20MyValueSet/near/261512957" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Corey Sanders <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/&#x27;String&#x27;.20in.20MyValueSet.html#261512957">(Nov 15 2021 at 15:31)</a>:</h4>
<p>Thanks, Bryn. I was missing the extra detail in the cqlreference section.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
