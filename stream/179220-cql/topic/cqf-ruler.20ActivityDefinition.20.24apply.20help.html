---
layout: page
title: "FHIR Chat  · cqf-ruler ActivityDefinition $apply help · cql"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/index.html">cql</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html">cqf-ruler ActivityDefinition $apply help</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="242007095"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/242007095" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ravi.kuchi <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#242007095">(Jun 09 2021 at 01:10)</a>:</h4>
<p>Hi  <span class="user-mention" data-user-id="194178">@JP</span> , I am trying out the cqf-ruler-r4 by posting the ActivityDefinition defined at <a href="http://hl7.org/fhir/R4/activitydefinition-medicationorder-example.json.html">http://hl7.org/fhir/R4/activitydefinition-medicationorder-example.json.html</a> and then executing $apply on this with a Test Patient<br>
I am getting below error:<br>
{<br>
"severity": "error",<br>
"code": "processing",<br>
"diagnostics": "Failed to call access method: org.opencds.cqf.cql.engine.fhir.exception.DataProviderException: Unable to resolve path dispenseRequest.numberOfRepeatsAllowed."<br>
}<br>
Am I missing something here, I could not find any sort of examples to understand the cql that can be executed by this tool on the link <a href="https://github.com/DBCG/cqf-ruler">https://github.com/DBCG/cqf-ruler</a> and also at the link <a href="https://github.com/DBCG/cqf-ruler/wiki">https://github.com/DBCG/cqf-ruler/wiki</a></p>



<a name="242080332"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/242080332" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#242080332">(Jun 09 2021 at 15:05)</a>:</h4>
<p>Hi Ravi!</p>
<p>I'll take a look at the ruler and that example today and see if I can figure out what's going on with that example.</p>
<p>The ruler supports direct CQL execution via the $cql operation. There aren't any examples of that posted in the wiki anywhere but here's a link to the operation definition in the code. I'll add a backlog item for adding documentation for that.</p>
<p><a href="https://github.com/DBCG/cqf-ruler/blob/master/r4/src/main/java/org/opencds/cqf/r4/providers/CqlExecutionProvider.java#L233">https://github.com/DBCG/cqf-ruler/blob/master/r4/src/main/java/org/opencds/cqf/r4/providers/CqlExecutionProvider.java#L233</a></p>



<a name="242107335"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/242107335" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ravi.kuchi <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#242107335">(Jun 09 2021 at 18:12)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="194178">@JP</span> , for quick reply!<br>
Can I get some quick samples of how to use $cql and $evaluate , below is a screenshot of what I was trying to get started on using these endpoints<br>
<a href="/user_uploads/10155/5mqWgcjMJuMscTRdOZaRZfWg/Screen-Shot-2021-06-09-at-2.06.42-PM.png">Screen-Shot-2021-06-09-at-2.06.42-PM.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/10155/5mqWgcjMJuMscTRdOZaRZfWg/Screen-Shot-2021-06-09-at-2.06.42-PM.png" title="Screen-Shot-2021-06-09-at-2.06.42-PM.png"><img src="/user_uploads/10155/5mqWgcjMJuMscTRdOZaRZfWg/Screen-Shot-2021-06-09-at-2.06.42-PM.png"></a></div>



<a name="242112856"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/242112856" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ravi.kuchi <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#242112856">(Jun 09 2021 at 18:54)</a>:</h4>
<p><span class="user-mention" data-user-id="194178">@JP</span> , I am able to figure out the $evaluate part , it is really exciting !!! Thanks to this wonderful project<br>
<a href="/user_uploads/10155/A1eroneEDLDFpR8wyoJH1xik/Screen-Shot-2021-06-09-at-2.52.53-PM.png">Screen-Shot-2021-06-09-at-2.52.53-PM.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/10155/A1eroneEDLDFpR8wyoJH1xik/Screen-Shot-2021-06-09-at-2.52.53-PM.png" title="Screen-Shot-2021-06-09-at-2.52.53-PM.png"><img src="/user_uploads/10155/A1eroneEDLDFpR8wyoJH1xik/Screen-Shot-2021-06-09-at-2.52.53-PM.png"></a></div>



<a name="242113196"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/242113196" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ravi.kuchi <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#242113196">(Jun 09 2021 at 18:57)</a>:</h4>
<p>My end goal however is to write all my logic into Library and then use the evaluated library contents in the Activity and PlanDefinition Objects for creating Orders and CarePlans. Do you think my understanding is correct?</p>



<a name="242114172"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/242114172" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#242114172">(Jun 09 2021 at 19:04)</a>:</h4>
<p>Glad you got it figured out! Yes, you can include logic in a CQL library and then reference that logic in PlanDefinitions and so on. That can be in turn used to create CarePlans, cds-hooks services, etc.</p>



<a name="242142001"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/242142001" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ravi.kuchi <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#242142001">(Jun 09 2021 at 23:04)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="194178">@JP</span> , one quick help, I am executing the $apply on the bundle provided in the page <br>
<a href="https://github.com/DBCG/cql-evaluator/blob/master/evaluator.activitydefinition/src/test/resources/org/opencds/cqf/cql/evaluator/activitydefinition/r4/bundle-activityDefinitionTest.json">https://github.com/DBCG/cql-evaluator/blob/master/evaluator.activitydefinition/src/test/resources/org/opencds/cqf/cql/evaluator/activitydefinition/r4/bundle-activityDefinitionTest.json</a><br>
As per my understanding the doNotPerform should be set as per the ActivityDefinition, but I do not see that in the response, it seems that the dynamicValue is not working, can you please let me know if I am overlooking something:<br>
{<br>
    "resourceType": "MedicationRequest",<br>
    "intent": "order",<br>
    "medicationCodeableConcept": {<br>
        "coding": [<br>
            {<br>
                "system": "<a href="http://test/fhir/System">http://test/fhir/System</a>",<br>
                "code": "productCode"<br>
            }<br>
        ]<br>
    },<br>
    "subject": {<br>
        "reference": "patient-1"<br>
    }<br>
}</p>



<a name="242145937"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/242145937" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ravi.kuchi <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#242145937">(Jun 10 2021 at 00:03)</a>:</h4>
<p>I think I made it work, changed the expression with escape characters and library prefix -&gt;<br>
 "expression": "\"TestActivityDefinition\".ActiveProcedureStatus"<br>
I am going to try more complex examples, will let u know my progress</p>



<a name="242214459"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/242214459" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ravi.kuchi <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#242214459">(Jun 10 2021 at 14:23)</a>:</h4>
<p>hi <span class="user-mention" data-user-id="194178">@JP</span>, <span class="user-mention" data-user-id="191359">@Bryn Rhodes</span>  , As in another thread I stumbled upon the limitation that the dynamicValue seems to only work with Boolean dataType, I did try few things to make it work for code or quantity but am unsuccessful, if you could give me pointers as to the classes in which the changes would be it would be helpful.</p>



<a name="242234794"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/242234794" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#242234794">(Jun 10 2021 at 16:35)</a>:</h4>
<p>Hi ravi!</p>
<p>I believe the work to update that is already done - <a href="https://github.com/DBCG/cqf-ruler/pull/277/files">https://github.com/DBCG/cqf-ruler/pull/277/files</a></p>
<p>Just waiting on a review.</p>



<a name="242235049"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/242235049" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#242235049">(Jun 10 2021 at 16:37)</a>:</h4>
<p>I went ahead and reviewed and merged it, actually.</p>



<a name="242644021"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/242644021" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ravi.kuchi <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#242644021">(Jun 14 2021 at 19:00)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="194178">@JP</span>  for quick reply, I am trying a simple assignment as below  which does not seem to work, the resource is 'CommunicationRequest':<br>
{<br>
                    "path": "priority",<br>
                    "expression": {<br>
                        "language": "text/cql",</p>
<div class="codehilite"><pre><span></span><code>                  &quot;expression&quot;: &quot;routine&quot;
                }
            }
</code></pre></div>



<a name="242644123"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/242644123" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ravi.kuchi <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#242644123">(Jun 14 2021 at 19:01)</a>:</h4>
<p>I am getting below message in logs: 2021-06-14 14:59:04.757 [qtp106424296-40] WARN  o.o.c.r.p.PlanDefinitionApplyProvider [ActivityDefinitionApplyProvider.java:171] WARNING: ActivityDefinition has null value for path: priority</p>



<a name="242658717"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/242658717" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#242658717">(Jun 14 2021 at 21:03)</a>:</h4>
<p>Hmm... Could you post your complete example? I need a bit more context to figure out what's going on?</p>



<a name="242664985"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/242664985" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ravi.kuchi <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#242664985">(Jun 14 2021 at 22:06)</a>:</h4>
<p>Sure <span class="user-mention" data-user-id="194178">@JP</span> , Here is my activity Definition:<br>
{<br>
            "resourceType": "ActivityDefinition",<br>
            "id": "FMCNAactivityDefinition-test",<br>
            "name": "FMCNAactivityDefinition-test",<br>
            "title": "CreateProcedure",<br>
            "status": "draft",<br>
            "description": "Create the procedure.",<br>
            "library": [ "<a href="http://test/fhir/Library/FMCNAActivityDefinition|1.0.0">http://test/fhir/Library/FMCNAActivityDefinition|1.0.0</a>" ],<br>
            "kind": "CommunicationRequest",<br>
            "productCodeableConcept": {<br>
                "coding": [{<br>
                    "system": "<a href="http://test/fhir/System">http://test/fhir/System</a>",<br>
                    "code": "fmcnaCode"<br>
                }]<br>
            },<br>
            "dynamicValue": [<br>
                {<br>
                    "path": "subject",<br>
                    "expression": {<br>
                        "language": "text/cql",</p>
<div class="codehilite"><pre><span></span><code>                  &quot;expression&quot;: &quot;\&quot;FMCNAActivityDefinition\&quot;.Patient&quot;
                }
            },
          {
                &quot;path&quot;: &quot;status&quot;,
                &quot;expression&quot;: {
                    &quot;language&quot;: &quot;text/cql&quot;,

                  &quot;expression&quot;: &quot;draft&quot;
                }
            },
          {
                &quot;path&quot;: &quot;doNotPerform&quot;,
                &quot;expression&quot;: {
                    &quot;language&quot;: &quot;text/cql&quot;,

                  &quot;expression&quot;: &quot;\&quot;FMCNAActivityDefinition\&quot;.isAdult&quot;
                }
            },
          {
                &quot;path&quot;: &quot;priority&quot;,
                &quot;expression&quot;: {
                    &quot;language&quot;: &quot;text/cql&quot;,

                  &quot;expression&quot;: &quot;routine&quot;
                }
            }
        ]
    }
</code></pre></div>



<a name="242665073"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/242665073" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ravi.kuchi <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#242665073">(Jun 14 2021 at 22:07)</a>:</h4>
<p>Here is the Library I have defined: <br>
library FMCNAActivityDefinition version '1.0.0'</p>
<p>using FHIR version '4.0.1'</p>
<p>include "FHIRHelpers" version '4.0.1' called FHIRHelpers</p>
<p>codesystem "LOINC": '<a href="http://loinc.org">http://loinc.org</a>'<br>
code "serum creatinine":<br>
  '2160-0' from "LOINC" <br>
code "creatinine clearance":<br>
  '12195-4' from "LOINC" </p>
<p>context Patient</p>
<p>define "isAdult":<br>
  AgeInYears() &gt;= 18</p>
<p>define "isChild":<br>
  AgeInYears() &lt; 18</p>
<p>//define "Get Observation from Code Declaration":<br>
//  [Observation: "serum creatinine"]</p>
<p>define "LatestSerum":<br>
  First([Observation: code = "serum creatinine"] S <br>
    where S.effective &gt; Now() - 7 days<br>
    sort by (effective as dateTime) desc)</p>
<p>define "LatestSerum value": "LatestSerum".value.value</p>
<p>define "reference range high": "LatestSerum".referenceRange.high.value[0]</p>
<div class="codehilite"><pre><span></span><code>//RIFLE Classification
define &quot;Adult RIFLE Class&quot;: 
  case 
    when &quot;isChild&quot; then &#39;Not Applicable&#39;
    when &quot;LatestSerum value&quot; &gt; 3 * &quot;reference range high&quot; and &quot;isAdult&quot; then &#39;Failure&#39;
    when &quot;LatestSerum value&quot; &gt; 2 * &quot;reference range high&quot; and &quot;isAdult&quot; then &#39;Injury&#39; 
    when &quot;LatestSerum value&quot; &gt; 1.5 * &quot;reference range high&quot; and &quot;isAdult&quot; then &#39;Risk&#39; 
    else &#39;Not at Risk&#39;
  end

//AKIN Classification 
define &quot;Adult AKIN Class&quot;: 
  case 
    when  &quot;isChild&quot; then &#39;Not Applicable&#39;
    when &quot;LatestSerum value&quot; &gt; 3 * &quot;reference range high&quot; and &quot;isAdult&quot; then &#39;3&#39;
    when &quot;LatestSerum value&quot; &gt; 2 * &quot;reference range high&quot; and &quot;isAdult&quot; then &#39;2&#39; 
    when &quot;LatestSerum value&quot; &gt; 1.5 * &quot;reference range high&quot; and &quot;isAdult&quot; then &#39;1&#39; 
    else &#39;Not at Risk&#39;
  end
</code></pre></div>

<p>define "LatesteCCR":<br>
  First([Observation: code = "creatinine clearance"] S <br>
    where S.effective &gt; Now() - 7 days<br>
    sort by (effective as dateTime) desc)</p>
<p>define "LatestClearance value": "LatesteCCR".value.value</p>
<p>define "reference range low": "LatesteCCR".referenceRange.low.value[0]</p>
<p>//RIFLE Classification<br>
    define "Child RIFLE Class": <br>
      case <br>
        when "isAdult" then 'Not Applicable'<br>
        when "LatestClearance value" &lt; 0.25 * "reference range low" and "isChild" then 'Failure' <br>
        when "LatestClearance value" &lt; 0.50 * "reference range low" and "isChild" then 'Injury' <br>
        when "LatestClearance value" &lt; 0.75 * "reference range low" and "isChild" then 'Risk'<br>
        else 'Not at Risk'<br>
      end</p>



<a name="242665224"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/242665224" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ravi.kuchi <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#242665224">(Jun 14 2021 at 22:09)</a>:</h4>
<p>@JP, let me know if you need anything else, my goal is to create a CommunicationRequest resource upon the $apply and populate some data of CommunicationRequest from the Library and some data will be static like the 'Status' and 'Priority' which are pre-defined to 'draft' and 'routine'.</p>



<a name="242665537"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/242665537" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ravi.kuchi <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#242665537">(Jun 14 2021 at 22:12)</a>:</h4>
<p>The current output I am getting is :<br>
{<br>
    "resourceType": "CommunicationRequest",<br>
    "status": "unknown",<br>
    "doNotPerform": false,<br>
    "subject": {<br>
        "reference": "PedPatient"<br>
    }<br>
}<br>
My expectation is that the status should be set as 'draft' and the priority is missing</p>



<a name="242680122"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/242680122" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ravi.kuchi <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#242680122">(Jun 15 2021 at 02:06)</a>:</h4>
<p><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span>  One of My challenge is how do I define a static variable so I can assign the priority from enum in CQL<br>
define "MyPriority":   CommunicationRequest.CommunicationPriority('routine')  -&gt; this is not working , referred CQL guide but unable to find some guidance<br>
Tried below as well:<br>
define "MyPriority":  'Enumeration[routine]'</p>



<a name="242681787"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/242681787" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#242681787">(Jun 15 2021 at 02:41)</a>:</h4>
<p>CommunicationRequest.priority is a <code>FHIR.code</code>, which is an <code>Element</code>, and has <code>id</code>, <code>extension</code>, and <code>value</code> children. FHIRHelpers is providing implicit conversions so that when you compare to a string, you don't notice that it's a FHIR.code:</p>
<div class="codehilite"><pre><span></span><code>[CommunicationRequest] R where R.priority = &#39;routine&#39;
</code></pre></div>
<p>But if you're constructing a CommunicationRequest, you need to provide that FHIR.code value:</p>
<div class="codehilite"><pre><span></span><code>CommunicationRequest {
  id: id { value: &#39;123&#39; },
  priority: code { value: &#39;routine&#39; }
}
</code></pre></div>



<a name="242725008"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/242725008" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ravi.kuchi <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#242725008">(Jun 15 2021 at 12:32)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> , part of my problem is I think with the way cqf-ruler works:<br>
I have my Library defined as below:<br>
context Patient<br>
define "Latest":<br>
  First([MedicationRequest: code = "Colistin"] S <br>
    where S.authoredOn &lt; Now() - 7 days<br>
  )<br>
define "LatestPriority":  "Latest".priority<br>
define "MyIntent":  code { value: 'routine' }</p>
<p>The below works with ActivityDefinition<br>
{<br>
                    "path": "priority",<br>
                    "expression": {</p>
<div class="codehilite"><pre><span></span><code>                    &quot;language&quot;: &quot;text/cql&quot;,
                  &quot;expression&quot;: &quot;\&quot;FMCNAMedDefinition\&quot;.LatestPriority&quot;
                }
</code></pre></div>

<p>}</p>



<a name="242725062"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/242725062" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ravi.kuchi <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#242725062">(Jun 15 2021 at 12:33)</a>:</h4>
<p>The below does not work in cqf-ruler:<br>
{<br>
                    "path": "priority",<br>
                    "expression": {</p>
<div class="codehilite"><pre><span></span><code>                    &quot;language&quot;: &quot;text/cql&quot;,
                  &quot;expression&quot;: &quot;\&quot;FMCNAMedDefinition\&quot;.MyIntent&quot;
                }
            }
</code></pre></div>



<a name="242762526"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/242762526" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ravi.kuchi <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#242762526">(Jun 15 2021 at 16:41)</a>:</h4>
<p>Also, <span class="user-mention" data-user-id="191359">@Bryn Rhodes</span>  I am getting below error with your definition:<br>
define "comm": CommunicationRequest {<br>
  id: id { value: '123' },<br>
  priority: code { value: 'routine' }<br>
}         </p>
<blockquote>
<blockquote>
<p>Error [31:15] Expected an expression of type 'FHIR.CommunicationPriority', but found an expression of type 'code'.</p>
</blockquote>
</blockquote>



<a name="242942756"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/242942756" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#242942756">(Jun 16 2021 at 21:01)</a>:</h4>
<p>Sorry, yes, needs to use the CommunicationPriority enumerated type:</p>
<div class="codehilite"><pre><span></span><code>define &quot;Test1&quot;:
  CommunicationRequest {
    id: id { value: &#39;123&#39; },
    priority: CommunicationPriority { value: &#39;routine&#39; }
  }
</code></pre></div>



<a name="242942788"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/242942788" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#242942788">(Jun 16 2021 at 21:01)</a>:</h4>
<p>Regarding it not working in the ruler, what error are you getting?</p>



<a name="243060516"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/243060516" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ravi.kuchi <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#243060516">(Jun 17 2021 at 18:15)</a>:</h4>
<p><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> The above is working well, Thanks! Can you also help me set some content in the Payload, I tried few things but not getting it right<br>
define "comm": CommunicationRequest {<br>
  id: id { value: '123' },<br>
  priority: CommunicationPriority { value: 'routine' },<br>
  payload : Payload [{content : content as string{value: 'some sample text'} ]<br>
}</p>



<a name="243064140"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/243064140" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#243064140">(Jun 17 2021 at 18:39)</a>:</h4>
<p>For backbone elements, the model uses generated structure types, just like the Java and C# reference implementations do, so in this case it would be:</p>
<div class="codehilite"><pre><span></span><code>define &quot;comm&quot;: CommunicationRequest {
  id: id { value: &#39;123&#39; },
  priority: CommunicationPriority { value: &#39;routine&#39; },
  payload : {
    FHIR.CommunicationRequest.Payload {
      content : string { value: &#39;some sample text&#39; }
    }
  }
}
</code></pre></div>



<a name="243064270"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/243064270" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#243064270">(Jun 17 2021 at 18:40)</a>:</h4>
<p>Note that payload is multi-cardinality, so it takes a List, which uses curly-braces in CQL.</p>



<a name="243072027"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/243072027" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ravi.kuchi <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#243072027">(Jun 17 2021 at 19:34)</a>:</h4>
<p><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> , getting below error <br>
Could not resolve type CommunicationRequest.Payload. Primary package for this resolver is org.hl7.fhir.r4.model<br>
Do I need to include any packages? </p>
<p>I have the below as of now :<br>
using FHIR version '4.0.1'<br>
include "FHIRHelpers" version '4.0.1' called FHIRHelpers</p>



<a name="243086420"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/243086420" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#243086420">(Jun 17 2021 at 21:19)</a>:</h4>
<p>Hmmm, that seems like a bug in the engine's type resolver, the translator is fine with it. Would you mind submitting a github issue on the engine for that? (<a href="https://github.com/dbcg/cql_engine/issues">https://github.com/dbcg/cql_engine/issues</a>)</p>



<a name="243095653"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cqf-ruler%20ActivityDefinition%20%24apply%20help/near/243095653" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ravi.kuchi <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cqf-ruler.20ActivityDefinition.20.24apply.20help.html#243095653">(Jun 17 2021 at 22:52)</a>:</h4>
<p>Sure, submitted an issue <a href="https://github.com/DBCG/cql_engine/issues/488">https://github.com/DBCG/cql_engine/issues/488</a>, thanks for the help!</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
