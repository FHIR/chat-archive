---
layout: page
title: "FHIR Chat  · Maintaining State During Iteration · cql"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/index.html">cql</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Maintaining.20State.20During.20Iteration.html">Maintaining State During Iteration</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="234543296"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Maintaining%20State%20During%20Iteration/near/234543296" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pascal Brandt <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Maintaining.20State.20During.20Iteration.html#234543296">(Apr 14 2021 at 17:44)</a>:</h4>
<p><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span>, or anyone, is there any good way to maintain state during iteration? In my case, I'm trying to calculate a running total over a list of non-unique values. So, I want to turn something that looks kind of like:</p>
<div class="codehilite"><pre><span></span><code>L = { 1, 2, 2, 3, 4, 5 }
</code></pre></div>
<p>Into something that looks like:</p>
<div class="codehilite"><pre><span></span><code>T = { 1, 3, 5, 8, 12, 17 }
</code></pre></div>
<p>My elements are actually <code>Tuple</code>s with a date and a value, but the above example illustrates the problem.</p>
<p>At first I tried recursion, but it seems like that isn't supported. Then I thought I could use <code>IndexOf</code>, <code>Take</code>, and <code>Sum</code>, but my elements are not unique. Is there a way to do this that I'm not thinking of? I'm using <code>cql-to-elm</code> to generate my ELM, and <code>cql-execution</code> to run it.</p>



<a name="234546128"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Maintaining%20State%20During%20Iteration/near/234546128" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Maintaining.20State.20During.20Iteration.html#234546128">(Apr 14 2021 at 18:00)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="193402">@Pascal Brandt</span>!  Are you able to use the soon-to-be-published CQL 1.5 version?  If so, you might want to take a look at <a href="http://build.fhir.org/ig/HL7/cql/03-developersguide.html#aggregate-queries">Aggregate Queries</a>.  If I understand what you're trying to do correctly, I think this would provide a pretty straight-forward approach.</p>
<p>The CQL-to-ELM 1.5.2 translator supports it already and we've also added support in <code>cql-execution</code> (thanks to <span class="user-mention" data-user-id="214452">@Rob Dingwell</span>) -- but note that it is not yet <em>released</em> in <code>cql-execution</code>.  We can probably cut a new release of <code>cql-execution</code> soon if you think this will be helpful.</p>



<a name="234547190"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Maintaining%20State%20During%20Iteration/near/234547190" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pascal Brandt <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Maintaining.20State.20During.20Iteration.html#234547190">(Apr 14 2021 at 18:07)</a>:</h4>
<p>I'm using all kinds of custom builds, so I don't think pulling in new features is going to be a problem. I'm already on <code>1.5.2</code> of <code>cql-to-elm</code>. I'm using the CQL Testing Framework for execution, but I'm on a custom build of that as well, so let me update <code>cql-execution</code> there. Any gitsha you can recommend?</p>
<p>Thanks <span class="user-mention" data-user-id="191469">@Chris Moesel</span>!</p>



<a name="234553176"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Maintaining%20State%20During%20Iteration/near/234553176" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Maintaining.20State.20During.20Iteration.html#234553176">(Apr 14 2021 at 18:47)</a>:</h4>
<p>I haven't tried loading the <code>cql-execution</code> package using a reference to it on GH.  Hopefully that works OK.  You can use the HEAD of master right now, which is sha <code>160b69e29a2d88e0891276986a551661772df4b5</code>.</p>



<a name="234565836"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Maintaining%20State%20During%20Iteration/near/234565836" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pascal Brandt <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Maintaining.20State.20During.20Iteration.html#234565836">(Apr 14 2021 at 20:04)</a>:</h4>
<p>Just as a follow-up, everything seems to be working as expected. Here are the steps I followed in case anyone wants to do the same.</p>
<p>First I added a <a href="https://classic.yarnpkg.com/en/docs/selective-version-resolutions/">resolution</a> in my <code>package.json</code> to grab the gitsha I wanted:</p>
<div class="codehilite"><pre><span></span><code>&quot;resolutions&quot;: {
  &quot;cql-execution&quot;: &quot;cqframework/cql-execution#160b69e&quot;
}
</code></pre></div>
<p>Then, I had to add a <code>postinstall</code> script to build the (required) <code>lib</code> directory:</p>
<div class="codehilite"><pre><span></span><code>&quot;scripts&quot;: {
  &quot;postinstall&quot;: &quot;yarn --cwd ./node_modules/cql-execution install&quot;
}
</code></pre></div>



<a name="234567534"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Maintaining%20State%20During%20Iteration/near/234567534" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Maintaining.20State.20During.20Iteration.html#234567534">(Apr 14 2021 at 20:16)</a>:</h4>
<p>Ah, yes.  It was that <code>postinstall</code> step that had me concerned.  Thanks for sharing.  And... let us know how the aggregate query approach works for you!</p>



<a name="234583770"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Maintaining%20State%20During%20Iteration/near/234583770" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pascal Brandt <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Maintaining.20State.20During.20Iteration.html#234583770">(Apr 14 2021 at 22:02)</a>:</h4>
<p>It worked perfectly! Here's my expression:</p>
<div class="codehilite"><pre><span></span><code>define &quot;Sorted Dates With Totals&quot;:
    (Tail(&quot;Sorted Dates With Counts&quot;)) DC
        aggregate all DT starting ({
            Tuple {
                date: First(&quot;Sorted Dates With Counts&quot;).date,
                total: First(&quot;Sorted Dates With Counts&quot;).count
            }
        }): flatten {
            DT,
            Tuple {
                date: DC.date,
                total: Last(DT).total + DC.count
            }
        }
</code></pre></div>
<p><code>"Sorted Dates With Totals"</code> is of type <code>List&lt;Tuple { date System.DateTime, count Integer }&gt;</code>. The only thing that tripped me up initially is the default to set semantics. Adding <code>all</code> made sure duplicates weren't ignored.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
