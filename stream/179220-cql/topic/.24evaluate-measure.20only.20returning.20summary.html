---
layout: page
title: "FHIR Chat  · $evaluate-measure only returning summary · cql"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/index.html">cql</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/.24evaluate-measure.20only.20returning.20summary.html">$evaluate-measure only returning summary</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="240230098"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/%24evaluate-measure%20only%20returning%20summary/near/240230098" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Stanley <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/.24evaluate-measure.20only.20returning.20summary.html#240230098">(May 25 2021 at 18:26)</a>:</h4>
<p>Hi folks. I've got a simple $evaluate-measure operation that appears to be working on a Measure in the sense that it is processed (using HAPI v5.3). But, it's missing the calculations, e.g. proportion, or counts. How can I troubleshoot why I'm not seeing the calculations? Here's an output...</p>
<div class="codehilite"><pre><span></span><code>{
  &quot;resourceType&quot;: &quot;MeasureReport&quot;,
  &quot;status&quot;: &quot;complete&quot;,
  &quot;type&quot;: &quot;summary&quot;,
  &quot;measure&quot;: &quot;Measure/HIVSimpleGender2&quot;,
  &quot;period&quot;: {
    &quot;start&quot;: &quot;1970-01-01T00:00:00-05:00&quot;,
    &quot;end&quot;: &quot;2021-01-01T00:00:00-05:00&quot;
  }
}
</code></pre></div>



<a name="240232867"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/%24evaluate-measure%20only%20returning%20summary/near/240232867" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/.24evaluate-measure.20only.20returning.20summary.html#240232867">(May 25 2021 at 18:48)</a>:</h4>
<p>Hi Richard,</p>
<p>Are you able to post the parameters you're using for $evaluate-measure and the Measure resource you're using?</p>



<a name="240232997"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/%24evaluate-measure%20only%20returning%20summary/near/240232997" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian Bacher <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/.24evaluate-measure.20only.20returning.20summary.html#240232997">(May 25 2021 at 18:49)</a>:</h4>
<p>Since, I've seen the measure definition... you've defined three groups where you should have one group with three populations (the measure-population code goes with the population instance rather than with the group), e.g., something like:</p>
<div class="codehilite"><pre><span></span><code>  &quot;group&quot;: [
    {
      &quot;code&quot;: {
         &quot;text&quot;: &quot;cohort&quot;
      },
      &quot;description&quot;: &quot;HIVSimpleGender2 Cohort&quot;,
      &quot;population&quot;: [
        {
          &quot;description&quot;: &quot;HIVSimpleGender2 Initial Population&quot;,
          &quot;code&quot;: {
            &quot;coding&quot;: [
              {
                &quot;system&quot;: &quot;http://terminology.hl7.org/CodeSystem/measure-population&quot;,
                &quot;code&quot;: &quot;initial-population&quot;
              }
            ]
          },
          &quot;criteria&quot;: {
            &quot;language&quot;: &quot;text/cql&quot;,
            &quot;expression&quot;: &quot;Initial Population&quot;
          }
        },
        {
          &quot;description&quot;: &quot;HIVSimpleGender2 Numerator&quot;,
          &quot;code&quot;: {
            &quot;system&quot;: &quot;http://terminology.hl7.org/CodeSystem/measure-population&quot;,
            &quot;code&quot;: &quot;numerator&quot;
          },
          &quot;criteria&quot;: {
            &quot;language&quot;: &quot;text/cql&quot;,
            &quot;expression&quot;: &quot;Numerator&quot;
          }
        },
        {
          &quot;description&quot;: &quot;HIVSimpleGender2 Denominator&quot;,
          &quot;code&quot;: {
            &quot;system&quot;: &quot;http://terminology.hl7.org/CodeSystem/measure-population&quot;,
            &quot;code&quot;: &quot;denominator&quot;
          },
          &quot;criteria&quot;: {
            &quot;language&quot;: &quot;text/cql&quot;,
            &quot;expression&quot;: &quot;Denominator&quot;
          }
        }
      ]
    }
  ]
</code></pre></div>
<p>Is probably closer to correct.  See <a href="https://www.hl7.org/fhir/clinicalreasoning-quality-reporting.html">this page</a> on the relationship between groups, populations and measures.</p>



<a name="240234200"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/%24evaluate-measure%20only%20returning%20summary/near/240234200" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Stanley <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/.24evaluate-measure.20only.20returning.20summary.html#240234200">(May 25 2021 at 18:59)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="259065">@Ian Bacher</span> I'll have a go at it with that correction!</p>



<a name="240242313"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/%24evaluate-measure%20only%20returning%20summary/near/240242313" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Stanley <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/.24evaluate-measure.20only.20returning.20summary.html#240242313">(May 25 2021 at 20:01)</a>:</h4>
<p>Solved. Thanks <span class="user-mention" data-user-id="194178">@JP</span> <span class="user-mention" data-user-id="259065">@Ian Bacher</span> for sharing your boss-level FHIR expertise.</p>



<a name="240674517"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/%24evaluate-measure%20only%20returning%20summary/near/240674517" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Stanley <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/.24evaluate-measure.20only.20returning.20summary.html#240674517">(May 29 2021 at 00:40)</a>:</h4>
<p>I'll add a quick follow-up. I've been trying different types of measure scoring. What I would like is an output per patient similar to 'Execute CQL' in the Atom plugin. Is there a way to do that using a FHIR measure? Or, does this just have to be done on each patient in a loop? A use case would be outputing patient-level evaluations for an epidemiology dataset.</p>



<a name="240677150"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/%24evaluate-measure%20only%20returning%20summary/near/240677150" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/.24evaluate-measure.20only.20returning.20summary.html#240677150">(May 29 2021 at 01:48)</a>:</h4>
<p>That's the <code>patient-list</code> (DSTU3) and <code>subject-list</code> (R4) Measure types, though the current implementation doesn't include a report-per-patient.</p>



<a name="240680857"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/%24evaluate-measure%20only%20returning%20summary/near/240680857" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Stanley <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/.24evaluate-measure.20only.20returning.20summary.html#240680857">(May 29 2021 at 03:42)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="194178">@JP</span> I'll have a go at it. Thanks for the helpful answer on the weekend :)</p>



<a name="240987883"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/%24evaluate-measure%20only%20returning%20summary/near/240987883" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/.24evaluate-measure.20only.20returning.20summary.html#240987883">(Jun 01 2021 at 18:56)</a>:</h4>
<p>Hi Richard!</p>
<p>The supplemental data is supposed to be included as an Observation with a value:</p>
<p><a href="https://www.hl7.org/fhir/clinicalreasoning-quality-reporting.html#stratification-and-supplemental-data">https://www.hl7.org/fhir/clinicalreasoning-quality-reporting.html#stratification-and-supplemental-data</a></p>
<p>In your example is does include a placeholder Observation, but not the "Hello, world" value. Looking at the implementation it currently only supported "Code" types, and not String, Integers, Quantities, etc. You could try having the "Hello, world" definition return a Code just to verify that it does work. I'll have to follow-up with <span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> to see if the limitation around codes was intended or not.</p>



<a name="240989603"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/%24evaluate-measure%20only%20returning%20summary/near/240989603" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Stanley <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/.24evaluate-measure.20only.20returning.20summary.html#240989603">(Jun 01 2021 at 19:11)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="194178">@JP</span> Thanks, that was a silly test to confirm it and I'll try what you suggest. Related, is there a working fhirpath example that returns a value? Returning a value is the use case, e.g. the Location for the most recent Encounter.</p>
<p>If you don't mind one other clarification: I see the Observation but it's an inline resources but doesn't exist at Observation/id.</p>
<p>Update: Tried, so coded expressions are not returning codes. <br>
Here's the CQL:</p>
<div class="codehilite"><pre><span></span><code>define &quot;Female&quot;:
  Patient.gender = &#39;female&#39;
</code></pre></div>
<p>Here's the Measure part:</p>
<div class="codehilite"><pre><span></span><code>  &quot;supplementalData&quot;: [
    {
      &quot;code&quot;: {
        &quot;text&quot;: &quot;supplemental-data-example-define&quot;
      },
      &quot;criteria&quot;: {
        &quot;language&quot;: &quot;text/cql&quot;,
        &quot;expression&quot;: &quot;Female&quot;
      }
    }
  ]
</code></pre></div>
<p>The response for an individual-level run (with patient=89) is here: <a href="https://pastebin.com/7U2epmpW">https://pastebin.com/7U2epmpW</a></p>
<p>Update: The searchset doesn't contain the string 'Hello, World!'. So, no string is returned in the inline contained resource either.</p>
<p>Another update: Ok, so very simple stratifiers do not seem to enumerate either and are not contained in the inlined obs resource. Try:</p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code><span class="nt">"stratifier"</span><span class="p">:</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="nt">"code"</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">"text"</span><span class="p">:</span> <span class="s2">"stratifier-gender"</span>
    <span class="p">},</span>
    <span class="nt">"criteria"</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">"language"</span><span class="p">:</span> <span class="s2">"text/fhirpath"</span><span class="p">,</span>
      <span class="nt">"expression"</span><span class="p">:</span> <span class="s2">"Patient.gender"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">]</span>
</code></pre></div>
<p><span class="user-mention" data-user-id="194178">@JP</span> <span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> I would be super happy to know here if I'm making a mistake. :)</p>



<a name="241178188"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/%24evaluate-measure%20only%20returning%20summary/near/241178188" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/.24evaluate-measure.20only.20returning.20summary.html#241178188">(Jun 02 2021 at 17:01)</a>:</h4>
<div class="codehilite" data-code-language="cql"><pre><span></span><code>define "Female":
  Patient.gender = 'female'
</code></pre></div>
<p>actually returns a Boolean. Try:</p>
<div class="codehilite" data-code-language="cql"><pre><span></span><code>define "SDE Sex":
  case
    when Patient.gender = 'male' then Code { code: 'M', system: 'http://hl7.org/fhir/v3/AdministrativeGender', display: 'Male' }
    when Patient.gender = 'female' then Code { code: 'F', system: 'http://hl7.org/fhir/v3/AdministrativeGender', display: 'Female' }
    else null
  end
</code></pre></div>
<p>with the corresponding Measure updates.</p>



<a name="241178481"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/%24evaluate-measure%20only%20returning%20summary/near/241178481" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/.24evaluate-measure.20only.20returning.20summary.html#241178481">(Jun 02 2021 at 17:03)</a>:</h4>
<blockquote>
<p>it's an inline resources but doesn't exist at Observation/id.</p>
</blockquote>
<p>I don't quite follow this. Are you expecting the resource to be persisted to the FHIR server? I do see the Observation resource included in the <code>MeasureReport</code> as a contained resource in your example at <a href="https://pastebin.com/7U2epmpW">https://pastebin.com/7U2epmpW</a></p>



<a name="241179127"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/%24evaluate-measure%20only%20returning%20summary/near/241179127" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Stanley <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/.24evaluate-measure.20only.20returning.20summary.html#241179127">(Jun 02 2021 at 17:08)</a>:</h4>
<p>Thanks, indeed the observation is created inline and can be obtained (I wasn't including the #). However, in that searchset there is nothing for the supplemental data.</p>
<p>For the stratifier test, I get a warning in qa: "The expression language text/fhirpath is not supported, so can't be validated". This is from this example: <a href="https://www.hl7.org/fhir/measure-cms146-example.json.html">https://www.hl7.org/fhir/measure-cms146-example.json.html</a></p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code><span class="nt">"stratifier"</span><span class="p">:</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="nt">"code"</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">"text"</span><span class="p">:</span> <span class="s2">"stratifier-gender"</span>
    <span class="p">},</span>
    <span class="nt">"criteria"</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">"language"</span><span class="p">:</span> <span class="s2">"text/fhirpath"</span><span class="p">,</span>
      <span class="nt">"expression"</span><span class="p">:</span> <span class="s2">"Patient.gender"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">]</span>
</code></pre></div>
<p>Is that syntax different now?</p>



<a name="241180297"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/%24evaluate-measure%20only%20returning%20summary/near/241180297" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/.24evaluate-measure.20only.20returning.20summary.html#241180297">(Jun 02 2021 at 17:17)</a>:</h4>
<p>The current Measure evaluation doesn't support stratifiers or fhirPath, though support for both is one of my main projects over the past couple weeks.</p>



<a name="241292200"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/%24evaluate-measure%20only%20returning%20summary/near/241292200" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Stanley <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/.24evaluate-measure.20only.20returning.20summary.html#241292200">(Jun 02 2021 at 17:35)</a>:</h4>
<p>Ok, I'll happily be a tester :) Also, yes declaring the code works in that F is displayed in the MeasureReport directly.</p>



<a name="241292373"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/%24evaluate-measure%20only%20returning%20summary/near/241292373" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Stanley <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/.24evaluate-measure.20only.20returning.20summary.html#241292373">(Jun 02 2021 at 17:36)</a>:</h4>
<p>My use case is to either output a per-patient MeasureReport with the Location of their last Encounter, or to aggregate patients by Location of Encounter. Is there a way to do that without stratifiers? If supplemental data, does that mean a ValueSet/CodeSystem of all Locations?</p>



<a name="241310232"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/%24evaluate-measure%20only%20returning%20summary/near/241310232" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/.24evaluate-measure.20only.20returning.20summary.html#241310232">(Jun 02 2021 at 19:49)</a>:</h4>
<p>Stratification allows aggregation by location (or by pretty much any other criteria) so once it's done (I anticipate it'll be a week or so) it ought to work for your use case. You could do it with supplemental data and a code. You wouldn't necessarily have to define a ValueSet, just define a Location-based code inline. Working with references is a bit tricky currently, but it looks something like:</p>
<div class="codehilite" data-code-language="cql"><pre><span></span><code>define function "GetId"(uri String):
    Last(Split(uri, '/'))

define function "GetLocation"(reference Reference):
  singleton from (
    [Location] Location where Location.id.value = GetId(reference.reference)
  )

define "Location":
    First([Encounter] E return "GetLocation"(First(E.location).location))

define "SDE Location":
    Code { code: "Location".name, system: 'http://location-name-code-system' }
</code></pre></div>



<a name="241310275"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/%24evaluate-measure%20only%20returning%20summary/near/241310275" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/.24evaluate-measure.20only.20returning.20summary.html#241310275">(Jun 02 2021 at 19:49)</a>:</h4>
<p>I cribbed heavily from <a href="https://github.com/DBCG/connectathon/blob/28d976d5e2ecf8ffa9badb82964395877323b63f/fhir3/2019/input/pagecontent/cql/MATGlobalCommonFunctions_FHIR3-2.0.000.cql">https://github.com/DBCG/connectathon/blob/28d976d5e2ecf8ffa9badb82964395877323b63f/fhir3/2019/input/pagecontent/cql/MATGlobalCommonFunctions_FHIR3-2.0.000.cql</a></p>



<a name="241310943"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/%24evaluate-measure%20only%20returning%20summary/near/241310943" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Stanley <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/.24evaluate-measure.20only.20returning.20summary.html#241310943">(Jun 02 2021 at 19:54)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="194178">@JP</span> I'll give it a go!</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
