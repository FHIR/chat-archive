---
layout: page
title: "FHIR Chat  · cql and library-evaluate operations · cql"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/index.html">cql</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20and.20library-evaluate.20operations.html">cql and library-evaluate operations</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="242123162"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20and%20library-evaluate%20operations/near/242123162" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Corey Sanders <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20and.20library-evaluate.20operations.html#242123162">(Jun 09 2021 at 20:12)</a>:</h4>
<p>I'm trying to implement the <a href="http://build.fhir.org/ig/HL7/cqf-recommendations/OperationDefinition-cpg-cql.html">$cql</a> and <a href="http://build.fhir.org/ig/HL7/cqf-recommendations/OperationDefinition-cpg-library-evaluate.html">$library-evaluate</a> operations per the CPG recommendations. The $library-evaluate operation always returns a Parameters resource and, for an expression where the result that is a list, the <code>return</code> Parameters resource should include multiple parameters with the same name corresponding to the expression for which the list that is returned. That works fine for all datatypes include lists of resources and lists of primitives. For the $cql operation, there will be a single result. In the <code>return</code> doc, it says that a list of resources should be returned as a bundle and other types should be returned as a Parameters resource.  I'm struggling with that Parameters resource recommendation. The exact wording is as follows...</p>
<blockquote>
<p>If the result is a List of resources, the result will be a Bundle. If the result is a CQL system-defined or FHIR-defined type, the result is returned as a Parameters resource</p>
</blockquote>
<p>What would I do with a list of primitives as in the following expression?</p>
<div class="codehilite"><pre><span></span><code> [Encounter: &quot;Inpatient&quot;] E
  return all E.lengthOfStay
</code></pre></div>
<p>I'm also curious why do the two operations behave differently for lists of resources? One creates duplicate parameter names and the other constructs a bundle.</p>



<a name="242124653"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20and%20library-evaluate%20operations/near/242124653" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20and.20library-evaluate.20operations.html#242124653">(Jun 09 2021 at 20:24)</a>:</h4>
<p>The difference in output is mainly due to the fact that <code>$cql</code> started life as an ad-hoc operation on the cqf-ruler to provide an execution service for CQL and thus was subject to fewer constraints than <code>$evaluate</code>. It was convenient to get a Bundle with a few resources when you were evaluating a single expression. On the other hand <code>$evaluate</code> evolved alongside the rest of the clinical reasoning and Parameters resource guidance. It'd be worth discussing whether or not to reconcile that difference.</p>



<a name="242125802"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20and%20library-evaluate%20operations/near/242125802" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20and.20library-evaluate.20operations.html#242125802">(Jun 09 2021 at 20:33)</a>:</h4>
<p>FHIR Parameters support primitives using the <code>value[x]</code>. For example:</p>
<div class="codehilite"><pre><span></span><code>{
  &quot;resourceType&quot;: &quot;Parameters&quot;,
  &quot;parameter&quot;: [
    {
      &quot;name&quot;: &quot;DefinitionName&quot;,
      &quot;part&quot;: [
        {
          &quot;name&quot;: &quot;value&quot;,
          &quot;valueBoolean&quot;: true
        }
      ]
    }
  ]
}
</code></pre></div>
<p>So you'd return a Parameters resource with multiple parameters each named "DefinitionName" with a value part that had "valueDuration" and whatever the duration is.</p>



<a name="242126471"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20and%20library-evaluate%20operations/near/242126471" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Corey Sanders <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20and.20library-evaluate.20operations.html#242126471">(Jun 09 2021 at 20:38)</a>:</h4>
<p>Thanks, @JP. Is "DefinitionName" just assumed as a constant at that point? Same question for the inner parts. Are each of those just named "value"?</p>



<a name="242127075"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20and%20library-evaluate%20operations/near/242127075" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20and.20library-evaluate.20operations.html#242127075">(Jun 09 2021 at 20:43)</a>:</h4>
<p>"DefinitionName" = Whatever the original definition name was in the CQL library</p>
<p>Sorry, the example I gave wasn't correct (was copy-pasting quicky...):</p>
<div class="codehilite"><pre><span></span><code>{
  &quot;resourceType&quot;: &quot;Parameters&quot;,
  &quot;parameter&quot;: [
    {
      &quot;name&quot;: &quot;DefinitionName&quot;,
       &quot;valueBoolean&quot;: true
    }
  ]
}
</code></pre></div>



<a name="242127204"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20and%20library-evaluate%20operations/near/242127204" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Corey Sanders <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20and.20library-evaluate.20operations.html#242127204">(Jun 09 2021 at 20:44)</a>:</h4>
<p>I'm was specifically asking for the ad-hoc $cql case where there isn't really a well-defined DefinitionName.</p>



<a name="242127752"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20and%20library-evaluate%20operations/near/242127752" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20and.20library-evaluate.20operations.html#242127752">(Jun 09 2021 at 20:48)</a>:</h4>
<p>Hmm... That seems like a gap in the spec. I've only implemented the Bundle side of that. I'd suggest "result" or similar. <span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> ?</p>



<a name="242129170"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20and%20library-evaluate%20operations/near/242129170" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Corey Sanders <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20and.20library-evaluate.20operations.html#242129170">(Jun 09 2021 at 20:59)</a>:</h4>
<p>Where do I find the HAPI implementation for these operations? It would help me to review the decisions that were made there.</p>



<a name="242130431"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20and%20library-evaluate%20operations/near/242130431" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20and.20library-evaluate.20operations.html#242130431">(Jun 09 2021 at 21:08)</a>:</h4>
<p>There’s no complete implementation of either for HAPI as far as I’m aware. The cqf-ruler (which is based on HAPI) has partial implementations based on an older, in-progress version of the cpg spec. Those implementations are here:</p>
<p><a href="https://github.com/DBCG/cqf-ruler/blob/9f1a748cb1342bc4421404502eb53d6fa3383a85/r4/src/main/java/org/opencds/cqf/r4/providers/CqlExecutionProvider.java#L233">https://github.com/DBCG/cqf-ruler/blob/9f1a748cb1342bc4421404502eb53d6fa3383a85/r4/src/main/java/org/opencds/cqf/r4/providers/CqlExecutionProvider.java#L233</a></p>
<p><a href="https://github.com/DBCG/cqf-ruler/blob/master/r4/src/main/java/org/opencds/cqf/r4/providers/LibraryOperationsProvider.java#L181">https://github.com/DBCG/cqf-ruler/blob/master/r4/src/main/java/org/opencds/cqf/r4/providers/LibraryOperationsProvider.java#L181</a></p>
<p>Both of those are being reworked to bring them up-to-date with the spec, but that effort is still a couple weeks out.</p>



<a name="242271381"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20and%20library-evaluate%20operations/near/242271381" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20and.20library-evaluate.20operations.html#242271381">(Jun 10 2021 at 21:08)</a>:</h4>
<p>Yes, we should align the $cql and $evaluate operations there, I would think they should behave the same way. I would actually suggest "return" as the name of the expression though in the $cql case, aligning with the FHIR operation name: <a href="http://hl7.org/fhir/operations.html#response">http://hl7.org/fhir/operations.html#response</a></p>



<a name="242271771"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20and%20library-evaluate%20operations/near/242271771" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20and.20library-evaluate.20operations.html#242271771">(Jun 10 2021 at 21:11)</a>:</h4>
<p>I will say that one motivation for returning a list of resources as a Bundle rather than a Parameters, is that it provides a way to support paging.</p>



<a name="242606360"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20and%20library-evaluate%20operations/near/242606360" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20and.20library-evaluate.20operations.html#242606360">(Jun 14 2021 at 14:36)</a>:</h4>
<p>Another consideration is that you can't represent primitive data types with a Bundle.</p>



<a name="243381122"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20and%20library-evaluate%20operations/near/243381122" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Corey Sanders <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20and.20library-evaluate.20operations.html#243381122">(Jun 21 2021 at 13:25)</a>:</h4>
<p>I hit a couple things in my implementation of the Library/$evaluate response that I think could be made clearer / improved in the spec. The first was handling of null values and the second was empty lists. For both, I was simply leaving them out of the parameters response, but that was unsatisfying to the end user as it wasn't clear why they were missing. The cqf-ruler converts these to string representations "null" and "[]" and now I'm doing the same thing. This is necessary because the Parameter <a href="https://www.hl7.org/fhir/parameters.html#invs">constraints</a> require at least one of part, resource, or value. I'm not sure there is a better answer, but it rubs me the wrong way to convert an empty list into a string. Regardless, a note in the spec on how to deal with the situations would be useful.</p>



<a name="243423579"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20and%20library-evaluate%20operations/near/243423579" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20and.20library-evaluate.20operations.html#243423579">(Jun 21 2021 at 18:29)</a>:</h4>
<p>Because there's no collection/list type for the parameters we ended up needing to define an extension as a marker for something that should be an empty list. It's not yet in the cpg spec but should be arriving soon. Here's an example (this is on the input, but in principle you could do it for output as well):</p>
<p><a href="https://github.com/DBCG/cql-evaluator/blob/master/evaluator.expression/src/test/java/org/opencds/cqf/cql/evaluator/expression/ExpressionEvaluatorTest.java#L264">https://github.com/DBCG/cql-evaluator/blob/master/evaluator.expression/src/test/java/org/opencds/cqf/cql/evaluator/expression/ExpressionEvaluatorTest.java#L264</a></p>



<a name="243532615"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20and%20library-evaluate%20operations/near/243532615" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20and.20library-evaluate.20operations.html#243532615">(Jun 22 2021 at 15:21)</a>:</h4>
<p>Tracker for the CPG issue: <a href="https://jira.hl7.org/browse/FHIR-32962">https://jira.hl7.org/browse/FHIR-32962</a></p>



<a name="243533164"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20and%20library-evaluate%20operations/near/243533164" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20and.20library-evaluate.20operations.html#243533164">(Jun 22 2021 at 15:23)</a>:</h4>
<p>Equivalent tracker on the FHIR R5 spec: <a href="https://jira.hl7.org/browse/FHIR-32963">https://jira.hl7.org/browse/FHIR-32963</a></p>



<a name="243533192"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20and%20library-evaluate%20operations/near/243533192" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20and.20library-evaluate.20operations.html#243533192">(Jun 22 2021 at 15:23)</a>:</h4>
<p>As far as the results, I think a dataAbsentReason extension would be more appropriate there.</p>



<a name="243533661"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20and%20library-evaluate%20operations/near/243533661" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20and.20library-evaluate.20operations.html#243533661">(Jun 22 2021 at 15:26)</a>:</h4>
<p>A tracker for that on CPG: <a href="https://jira.hl7.org/browse/FHIR-32964">https://jira.hl7.org/browse/FHIR-32964</a></p>



<a name="243533876"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/cql%20and%20library-evaluate%20operations/near/243533876" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/cql.20and.20library-evaluate.20operations.html#243533876">(Jun 22 2021 at 15:28)</a>:</h4>
<p>And the equivalent tracker for R5: <a href="https://jira.hl7.org/browse/FHIR-32965">https://jira.hl7.org/browse/FHIR-32965</a></p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
