---
layout: page
title: "FHIR Chat  · How does CQL &#x27;data model&#x27; match perform context matching? · cql"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/index.html">cql</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html">How does CQL &#x27;data model&#x27; match perform context matching?</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="237405528"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/237405528" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Silva <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#237405528">(May 04 2021 at 21:45)</a>:</h4>
<p>I've run into problems trying to execute a CQL rule in Atom with cql-language plugin.  One case in particular is for Coverage; here's this simple rule but in the plugin it is always returning 'null'.    I have this specific problem but this brings up the more general question, how does a CQL rule developer know how a particular resource does context matching?     If the CQL is in the Patient context Coverage has 2 possible ways to match patient, the beneficiary reference property (most likely/sensible) and the subscriber reference property.     I imagine there are other resources too that have multiple possible context matching properties, e.g. for Practitioner context many FHIR resources have multiple references to Practitioners.</p>



<a name="237529114"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/237529114" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Riley <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#237529114">(May 05 2021 at 16:54)</a>:</h4>
<p>I'm not the developer, but the cql-fhir-engine defines a "context" (Patient context) and a "contextPath", which is where to find the patient. It then transforms that contextPath into a fhirpath definition using a crawl of hapi-fhir's built in models of the fhir resources. This all happens in some pretty gnarly hapi fhir reflection-like code in "getContextPath" here. <a href="https://github.com/DBCG/cql_engine/blob/48c95b816724f2558ef7516cd6fb6494787e7aa6/engine.fhir/src/main/java/org/opencds/cqf/cql/engine/fhir/model/FhirModelResolver.java#L72">https://github.com/DBCG/cql_engine/blob/48c95b816724f2558ef7516cd6fb6494787e7aa6/engine.fhir/src/main/java/org/opencds/cqf/cql/engine/fhir/model/FhirModelResolver.java#L72</a><br>
So in the case of multiple hits, where multiple search parameters can forfill the "Patient" search parameter type, I believe it's just down to which reference is resolved first (undefined behavior essentially). You can override the behavior to force a specific path for the Coverage resource to use if you have access to source, you can update the child class's getContextPath similar to what the STU3 version did here. at line 270 <a href="https://github.com/DBCG/cql_engine/blob/48c95b816724f2558ef7516cd6fb6494787e7aa6/engine.fhir/src/main/java/org/opencds/cqf/cql/engine/fhir/model/Dstu3FhirModelResolver.java">https://github.com/DBCG/cql_engine/blob/48c95b816724f2558ef7516cd6fb6494787e7aa6/engine.fhir/src/main/java/org/opencds/cqf/cql/engine/fhir/model/Dstu3FhirModelResolver.java</a></p>



<a name="237542484"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/237542484" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Silva <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#237542484">(May 05 2021 at 18:21)</a>:</h4>
<p><span class="user-mention" data-user-id="194612">@Michael Riley</span>  - thanks for the info -- but this seems to be unreliable and fragile.   It seems like this should be defined in CQL language.    Also for CQL rule authors, they don't have the 'luxury' of changing source code in the CQL execution engine.   Maybe I'm missing something in the CQL language (I'm new to it) but it seems like there should be a declarative way to define this context relationship.</p>



<a name="237547747"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/237547747" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#237547747">(May 05 2021 at 18:57)</a>:</h4>
<p>Michael has accurately portrayed the current state of things, but that's not the intended future state. CQL is not FHIR-specific meaning that it can be used with other clinical data models such as QDM. The CQL translator uses something called a "modelinfo" to understand the properties of the data model. At the time that code was written the "modelinfo" did not include information about context relationships. The latest versions of the FHIR modelinfo have the specific properties used for context relationships.</p>
<p><a href="https://raw.githubusercontent.com/cqframework/clinical_quality_language/68e6861b38603e6d87d822b938cc1a5ed354d7a7/Src/java/quick/src/main/resources/org/hl7/fhir/fhir-modelinfo-4.0.1.xml">https://raw.githubusercontent.com/cqframework/clinical_quality_language/68e6861b38603e6d87d822b938cc1a5ed354d7a7/Src/java/quick/src/main/resources/org/hl7/fhir/fhir-modelinfo-4.0.1.xml</a></p>



<a name="237547892"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/237547892" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#237547892">(May 05 2021 at 18:58)</a>:</h4>
<p>In the future the expectation is that the CQL engine would use the properties listed in the modelinfo.</p>



<a name="237559524"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/237559524" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Silva <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#237559524">(May 05 2021 at 20:24)</a>:</h4>
<p><span class="user-mention" data-user-id="194178">@JP</span>  Thanks again!   OK, CQL is not FHIR specific but for its use with FHIR is the data model specified (or balloted)?   It seems like it would be hard to know (as a CQL author) if this model isn't explicit.   </p>
<p>I did query the modelinfo and found Coverage has 4 reference prop's -- is the order of matching these specified or does it return all where the referenced value matched the context value, e.g. Patient?</p>
<p><code>      &lt;contextRelationship context="Patient" relatedKeyElement="policyHolder"/&gt;
      &lt;contextRelationship context="Patient" relatedKeyElement="subscriber"/&gt;
      &lt;contextRelationship context="Patient" relatedKeyElement="beneficiary"/&gt;
      &lt;contextRelationship context="Patient" relatedKeyElement="payor"/&gt;
</code></p>



<a name="237567451"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/237567451" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#237567451">(May 05 2021 at 21:10)</a>:</h4>
<p>The modelinfo is currently explicitly NOT part of the normative spec:<br>
<a href="https://cql.hl7.org/elm.html">https://cql.hl7.org/elm.html</a></p>
<p>That said, the tooling that is used to generate modelinfos for FHIR is open-source:<br>
<a href="https://github.com/cqframework/cqf-tooling/blob/master/src/main/java/org/opencds/cqf/tooling/modelinfo/StructureDefinitionToModelInfo.java">https://github.com/cqframework/cqf-tooling/blob/master/src/main/java/org/opencds/cqf/tooling/modelinfo/StructureDefinitionToModelInfo.java</a></p>
<p>I recognize none of that answers the question "how does a CQL author look up the context relationship" and that's because there's no answer for that right now. Most of the Resource types that are patient compartment only relate to patient one way, so it's been something of an edge case thus far to handle things like Coverage. <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>
<p>As far as how the multiple context relationships will be handled: It's not specified and there's no existing implementation so that's a TBD. Eventually it'll show up when you Right Click -&gt; CQL -&gt; View ELM in Atom. That shows you the Retrieve that's being generated for some given CQL.</p>



<a name="237582596"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/237582596" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Silva <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#237582596">(May 05 2021 at 23:23)</a>:</h4>
<p>Thanks for all this good info.   I suspected it wasn't part of any normative spec -- is there an intention for it to be part of some informative spec to at least help guide CQL authors.  (informative of course means that a CQL tool implementer doesn't have to implement it but it leads to at least some consistency in implementation I would hope.)</p>
<p>True, most of the simple Patient context ones are 'mostly obvious' and typically only one relationship.   However, I believe the Practitioner compartment might have resources with many reference relationships.    Also, the CQL spec pages only seem to have these 'simple examples' so it's hard to figure out these more non-obvious situations.    (BTW, the use case for patient's Coverage is that for things like DaVinci CRD/DTR/PAS you'd need to know the relationship to get the rules to figure out the patient's coverage for prior authorization and more.    I guess the Connectathon next week might uncover some of this ...)</p>



<a name="237693590"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/237693590" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#237693590">(May 06 2021 at 17:01)</a>:</h4>
<p>Well, there are a several areas of activity related to that question. One is the hope that the tooling I referenced will allow the use of profiles that are more constrained (or extended) than the current base FHIR spec. Meaning you could eventually do:</p>
<div class="codehilite"><pre><span></span><code>library Demo
using QICore version &#39;3.0.2&#39;
</code></pre></div>
<p>That machinery was built to support QICore and USCore in a first-class way in CQL, but it could in theory support any arbitrary FHIR profile. Then'd it'd be up to the profile maintainers to decide those relationships.</p>
<p>Another is the CQL language server (which powers the Atom plugin). It uses the VSCode language server API and has stubs in place to allow for tips, snippets, warnings, auto-completion, etc. that may help out the author. IOW, once the modelinfo is wired up to the language server correctly, that type of information would be available to the CQL author inline in the authoring environment for any given model.</p>
<p>Another is the "Cooking with CQL" training series which has quite a bit of info about the practical use of CQL:<br>
<a href="https://github.com/cqframework/CQL-Formatting-and-Usage-Wiki/wiki/Cooking-with-CQL-Examples">https://github.com/cqframework/CQL-Formatting-and-Usage-Wiki/wiki/Cooking-with-CQL-Examples</a></p>
<p>I don't know that we've had an explicit conversation about making the FHIR model to CQL modelinfo mapping (and in particular the context relationships) part of the spec in any fashion but happy to raise that with <span class="user-mention" data-user-id="191359">@Bryn Rhodes</span>  and see where it goes. <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="237752831"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/237752831" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Silva <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#237752831">(May 07 2021 at 01:00)</a>:</h4>
<p>This is more great info; thank you.<br>
On the context question again; yes, it is based on the specific model "in play" but doesn't it seem like the CQL language should expose a mechanism to allow an author to make these decisions declaratively.   In the SQL db world the data model is up to the schema developer but the SQL language allows a query writer to 'peek into' a specific schema in order to create well-formed and executable queries.   (I guess is just feels kind of 'unnatural' to be left to the variances of the model as to how context elements are matched.)</p>



<a name="237862927"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/237862927" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#237862927">(May 07 2021 at 17:43)</a>:</h4>
<p>That's true for SQL, but SQL doesn't have the quite same concept of data models that CQL does. The model as far as SQL is concerned is the schema you've defined for your database and most relationships are represented by foreign keys, and you generally have to be explicit about the relationship between two tables (i.e. X join Y on <a href="http://X.id">X.id</a> = Y.x_id). There's no higher-level representation of something like "Patient" or "Encounter" context. CQL is purposefully trying to make it so that the author doesn't need to worry about those concerns. It's targeted towards clinicians who may not even understand the concept of a join rather than database administrators .</p>



<a name="237863551"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/237863551" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#237863551">(May 07 2021 at 17:47)</a>:</h4>
<p>That said, it's not the case that we're trying to hide how things relate either. You should be able to see how those things relate while authoring CQL. It's just an area that hasn't been fully developed yet. <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="237885807"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/237885807" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Silva <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#237885807">(May 07 2021 at 20:30)</a>:</h4>
<p><span class="user-mention" data-user-id="194178">@JP</span>   OK, makes sense.   I was thinking of some kind of operator where the author can explicitly say:<br>
     [Coverage: Patient -&gt; beneficiary]</p>
<p>For example, if I'm only looking for linking to the actual patient not the subscriber (e.g. the parent)</p>



<a name="238210400"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/238210400" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Reynolds <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#238210400">(May 10 2021 at 20:55)</a>:</h4>
<p>You do have that in:</p>
<div class="codehilite"><pre><span></span><code>//context Patient
[Coverage]  C
   with [Patient] P
      such that P.id ~ C.beneficiary
</code></pre></div>



<a name="238212483"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/238212483" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Reynolds <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#238212483">(May 10 2021 at 21:09)</a>:</h4>
<p>context Patient is syntactic sugar.  If it's not doing what you want, don't use it and be explicit about what you want.  <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span> </p>
<p>You can even then add context Patient afterward and go back to the sugar.</p>
<p>Personally, I don't think the exceptional case warrants a new operator.  Others might disagree.</p>



<a name="238215640"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/238215640" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Reynolds <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#238215640">(May 10 2021 at 21:33)</a>:</h4>
<p>It would definitely be nice if the tooling provided insight into the magic of the sugar.  But that's an editor/tooling issue, not CQL.</p>



<a name="238219621"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/238219621" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Silva <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#238219621">(May 10 2021 at 22:09)</a>:</h4>
<p>Ah, that's the answer I was looking for -- an explicit way to define this reference linkage.   Yes, syntactic sugar can be problematic when it hides what's really going on.</p>
<p>Can I still use that even if within the Patient content or do I need to be in the Unfiltered context or is the syntax you show the Unfiltered context?</p>



<a name="238321745"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/238321745" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Silva <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#238321745">(May 11 2021 at 14:57)</a>:</h4>
<p>I just got around to trying this syntax in Atom with cql-language plugin and it doesn't like it:<br>
<a href="/user_uploads/10155/e7ES11UFvUV3swIXGrWkhBbs/Screen-Shot-2021-05-11-at-10.56.46-AM.png">Screen-Shot-2021-05-11-at-10.56.46-AM.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/10155/e7ES11UFvUV3swIXGrWkhBbs/Screen-Shot-2021-05-11-at-10.56.46-AM.png" title="Screen-Shot-2021-05-11-at-10.56.46-AM.png"><img src="/user_uploads/10155/e7ES11UFvUV3swIXGrWkhBbs/Screen-Shot-2021-05-11-at-10.56.46-AM.png"></a></div>



<a name="238331434"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/238331434" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Reynolds <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#238331434">(May 11 2021 at 15:48)</a>:</h4>
<p>It needs to be in unfiltered context, which is just not having context patient set, which is why I commented that line in my example.</p>



<a name="238332990"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/238332990" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Silva <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#238332990">(May 11 2021 at 15:57)</a>:</h4>
<p>OK, can I mixed Unfiltered directive within a CQL rule file that also has Patient context directive?</p>



<a name="238333595"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/238333595" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Reynolds <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#238333595">(May 11 2021 at 16:00)</a>:</h4>
<p>Sorry, I kinda pseudo coded that based on the [Coverage: Patient -&gt; beneficiary].  I should have looked at the types more closely.</p>
<p>You need some kind of helper to compare a reference to an id.</p>
<p>I've seen things like this used:</p>
<div class="codehilite"><pre><span></span><code>define function GetId(uri String):
   Last(Split(uri, &#39;/&#39;))
</code></pre></div>
<p>And then the example becomes:</p>
<div class="codehilite"><pre><span></span><code>//context Patient
[Coverage]  C
   with [Patient] P
      such that P.id ~ GetId(C.beneficiary.reference.value)
</code></pre></div>



<a name="238334032"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/238334032" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Reynolds <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#238334032">(May 11 2021 at 16:02)</a>:</h4>
<p>You can put things you don't want in patient context above the context Patient statement and then things you want in patient context below it.</p>
<div class="codehilite"><pre><span></span><code>define PatientCoverage ...

context Patient

define MedicationsInLastSixMonths...
</code></pre></div>



<a name="238347601"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/238347601" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#238347601">(May 11 2021 at 17:05)</a>:</h4>
<p>To add to this, around contexts and context-related joins, this test case illustrates where we are headed:</p>
<div class="codehilite"><pre><span></span><code>define TestMedicationRequest1C:
  [MedicationRequest] MR
    let M: singleton from ([MR.medication -&gt; Medication])
    where M.code ~ &quot;aspirin 325 MG / oxycodone hydrochloride 4.84 MG Oral Tablet&quot;
</code></pre></div>



<a name="238347750"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/238347750" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#238347750">(May 11 2021 at 17:06)</a>:</h4>
<p>Not there yet, but the idea is that the context relationships declared in the model can be used to enable reference following.</p>



<a name="238348056"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/238348056" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Reynolds <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#238348056">(May 11 2021 at 17:08)</a>:</h4>
<p>Well, I guess Bryn disagreed re the "warrants a new operator".  <span aria-label="rolling on the floor laughing" class="emoji emoji-1f923" role="img" title="rolling on the floor laughing">:rolling_on_the_floor_laughing:</span> </p>
<p>And the syntax is shockingly close to what John suggested.  :)</p>



<a name="238348065"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/238348065" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#238348065">(May 11 2021 at 17:08)</a>:</h4>
<p>And a significant step towards that has just been added to the 1.5.4-SNAPSHOT, the ability to detect and optimize joins as includes, like this, for example:</p>
<div class="codehilite"><pre><span></span><code>define MedicationRequestWithAspirinInFrom:
  from
      [MedicationRequest] R,
      [Medication] M
    where M.id = Last(Split(R.medication.reference, &#39;/&#39;))
      and M.code in &quot;Aspirin&quot;
</code></pre></div>



<a name="238348281"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/238348281" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#238348281">(May 11 2021 at 17:09)</a>:</h4>
<p>Yeah, the syntax is related-context retrieves, a language feature that's still trial-use because we're still working out support for it in the engines.</p>



<a name="238350367"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/238350367" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Reynolds <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#238350367">(May 11 2021 at 17:24)</a>:</h4>
<p>By "includes" there you're referring to the parameters of the from?  <br>
Like:<br>
from <br>
   include, <br>
   include, <br>
   ...</p>
<p>?</p>



<a name="238350893"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/238350893" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Reynolds <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#238350893">(May 11 2021 at 17:27)</a>:</h4>
<p>And it's always been valid CQL, right?  But with 1.5.4-SNAPSHOT it recognizes it as a join and optimizes accordingly?</p>



<a name="238351483"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/238351483" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#238351483">(May 11 2021 at 17:30)</a>:</h4>
<p>So that particular example would result in a FHIR query like: <code>[base]/MedicationRequest?patient=123&amp;_include=MedicationRequest:medication</code></p>



<a name="238351545"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/238351545" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#238351545">(May 11 2021 at 17:31)</a>:</h4>
<p>And yes, that's always been valid CQL, there's just an additional optimization step available now that detects that pattern and optimizes it as an include.</p>



<a name="238351639"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/238351639" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#238351639">(May 11 2021 at 17:31)</a>:</h4>
<p>It's not part of the core translator, it's an additional step, since optimization strategies will vary based on target environment.</p>



<a name="238351775"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/238351775" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#238351775">(May 11 2021 at 17:32)</a>:</h4>
<p>There's a new elm-fhir package in the 1.5.4-SNAPSHOT that does it, and we're incorporating that capability into the engine and evaluator now.</p>



<a name="238351805"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/238351805" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Reynolds <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#238351805">(May 11 2021 at 17:32)</a>:</h4>
<p>Oh <em>that</em> include.  Gotcha.</p>
<p>Very cool.</p>



<a name="238356471"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/238356471" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Silva <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#238356471">(May 11 2021 at 18:03)</a>:</h4>
<p>Hmm, it starts to look like SQL ;-)</p>



<a name="238365024"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/238365024" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rob Hausam <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#238365024">(May 11 2021 at 19:03)</a>:</h4>
<p>Yes, quite a lot - which probably isn't a bad thing. :)</p>



<a name="238374046"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/238374046" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#238374046">(May 11 2021 at 20:07)</a>:</h4>
<p>It's not an accident either :)</p>



<a name="238824793"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/238824793" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Riley <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#238824793">(May 14 2021 at 20:27)</a>:</h4>
<p>Bryn, how new is the includes definition? This would be very helpful for me.</p>



<a name="239098476"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/239098476" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#239098476">(May 17 2021 at 14:27)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="194612">@Michael Riley</span> , the capability was added as part of the 1.5 ballot, I've just pushed a branch that supports adding applying include optimizations to a compiled ELM tree (<a href="https://github.com/cqframework/clinical_quality_language/tree/feature-requirements-visitor">https://github.com/cqframework/clinical_quality_language/tree/feature-requirements-visitor</a>) and I'm currently working on incorporating that functionality in to the engine, targeting the next week or so to have support for that in the engine and evaluator components.</p>



<a name="266281378"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/266281378" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Kaney <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#266281378">(Dec 28 2021 at 18:38)</a>:</h4>
<p>Just found this thread. So to be clear using <code>AllergyIntolerance</code> example, I see this in the modelinfo for R4.0.1:</p>
<div class="codehilite"><pre><span></span><code>      &lt;contextRelationship context=&quot;Patient&quot; relatedKeyElement=&quot;patient&quot;/&gt;
      &lt;contextRelationship context=&quot;Patient&quot; relatedKeyElement=&quot;recorder&quot;/&gt;
      &lt;contextRelationship context=&quot;Patient&quot; relatedKeyElement=&quot;asserter&quot;/&gt;
</code></pre></div>
<p>Given</p>
<div class="codehilite"><pre><span></span><code>context Patient

define Allergies: [AllergyIntolerance]
</code></pre></div>
<p>How does it know to use the "patient" relationship (and not "recorder" or "asserter")?</p>



<a name="266283616"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/266283616" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#266283616">(Dec 28 2021 at 19:07)</a>:</h4>
<p>Currently the attribute for the context relationship is not specified in the ELM for the Retrieve generated by the CQL translator. IOW, that specific bit of the ModelInfo is not used. It's left up the runtime. The Java cql-engine works it out by looking at the properties of AllgeryIntolerance and using a simple (but currently undocumented) heuristic to figure out which key element it should use.</p>



<a name="266292906"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/266292906" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Kaney <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#266292906">(Dec 28 2021 at 21:11)</a>:</h4>
<p>Thanks @JP - would it make sense to propose an attribute added to contextRelationship (e.g. primary=boolean) to identify which relationship ought to be used in the implied case?</p>



<a name="266293126"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/266293126" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Kaney <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#266293126">(Dec 28 2021 at 21:14)</a>:</h4>
<p>(And <span class="user-mention" data-user-id="191469">@Chris Moesel</span>  - how does the cql-execution behave?)</p>



<a name="266294820"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/266294820" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#266294820">(Dec 28 2021 at 21:40)</a>:</h4>
<p>As I recall, something along those lines is on Bryn's todo list. <span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> ?</p>



<a name="266715310"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/266715310" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#266715310">(Jan 03 2022 at 17:47)</a>:</h4>
<p>Given that the intent of the retrieve is to provide all the resources associated with the context, the default behavior would be to return all AllergyIntolerance resources that have any relationship to the Patient (i.e. the union of the results here). The current engine doesn't behave that way (as JP noted), but in thinking through this, I think it probably should, because there's no way to know ahead of time which one is the "primary" one, without knowing the intent of the CQL. Related-context retrieves would allow authors to be more specific if they wanted to.</p>



<a name="266719344"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/266719344" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#266719344">(Jan 03 2022 at 18:19)</a>:</h4>
<p>I feel like this thread has gone in a few different directions.  So I'll just throw out some different statements / thoughts:</p>
<ul>
<li><span class="user-mention" data-user-id="191782">@Brian Kaney</span> - If the question is "how does cql-execution know which property to use to scope a query to the patient in context?" then the answer is: <em>it doesn't</em>.  In fact, as currently designed, the engine isn't responsible for that at all, because it does not execute FHIR queries.  Instead, the person invoking the engine passes in a FHIR <code>Bundle</code> containing all of the patient's data (<em>already</em> scoped to only the patient's information).  So the FHIR queries and patient scoping happens prior to cql-execution doing anything. (And to be clear, it's actually the <code>PatientSource</code> implementation in cql-exec-fhir that takes in the bundles since cql-execution is completely unaware of specific data models like FHIR).</li>
<li>BUT... in the open source CQL Services framework and the Pain Management Summary SMART app (both of which use cql-execution), we <em>hard-coded</em> a map containing the properties to use for scoping queries to a specific patient.  That way those apps can perform the right queries to build the bundle that gets passed along to cql-exection.</li>
<li>There was also some talk of the <a href="https://cql.hl7.org/03-developersguide.html#related-context-retrieves">related context retrieves</a> feature of CQL.  Just to be clear, cql-execution (the javascript engine) does not support that at all.  We'd be glad to take a PR though. ;-)</li>
<li><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> -- I feel like using all of the contextRelationships to do a query could be problematic because it is not what authors would expect.  If you are in <code>Patient</code> context, then that seems to me like enough expressed intent in the CQL to justify using whatever property represents the patient.  We already support a <code>primaryCodePath</code> in ELM to indicate the default property to use for code/VS matching in a retrieve; so it seems to me that introducing a <code>primaryPatientPath</code> (or something like it) would be consistent with that. Or am I misunderstanding something in this conversation?</li>
</ul>



<a name="266722223"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/266722223" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#266722223">(Jan 03 2022 at 18:48)</a>:</h4>
<p>The CQL spec says that Models may define their own contexts. Is there any existing guidance that ties the available contexts in FHIR to the compartment definitions?  If so, it does seem like we should be retrieving all the resources in the compartment. The ModelInfo code-generation works that way:</p>
<p><a href="https://github.com/cqframework/cqf-tooling/blob/beccb1e5069fd812ad2d6fc272b0197a2ff8e8ad/src/main/java/org/opencds/cqf/tooling/modelinfo/ContextInfoBuilder.java#L35">https://github.com/cqframework/cqf-tooling/blob/beccb1e5069fd812ad2d6fc272b0197a2ff8e8ad/src/main/java/org/opencds/cqf/tooling/modelinfo/ContextInfoBuilder.java#L35</a></p>



<a name="266724876"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/266724876" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#266724876">(Jan 03 2022 at 19:09)</a>:</h4>
<p>I think it's smart to use the <a href="http://hl7.org/fhir/R4/compartmentdefinition-patient.html">Patient compartment</a> from FHIR, but I guess I don't fully understand <em>why</em> the patient compartment indicates additional properties like <code>recorder</code>, <code>asserter</code>, and <code>performer</code>.</p>
<p>The description says:</p>
<blockquote>
<p>The patient compartment includes any resources where the subject of the resource is the patient, and some other resources that are directly linked to resources in the patient compartment</p>
</blockquote>
<p>But if we look at something like <code>AllergyIntolerance</code>, it says <code>patient or recorder or asserter</code>.  If we are truly interested in "resources where the <em>subject</em> of the resource is the patient", then <code>patient</code> is the right answer.  At first I thought maybe <code>recorder</code> and <code>asserter</code> were there as fallbacks if <code>patient</code> is blank, but <code>patient</code> is 1..1, so... I am stumped.  Why would anyone want a <em>different</em> patient's AllergyIntolerance in the compartment just because the primary patient asserted the allergy?  It means that clients need to verify that the resulting records actually reference the primary patient in the <code>patient</code> field -- which I doubt most clients do.</p>
<p>I know this is not the fault of anyone working on CQL, but... I'm not sure that we should just embrace it as-is.  To me, it still makes sense to have a more specific qualifier to say "this is the field that really means the patient is the <em>subject</em>."  And that field may need to be maintained by hand, just like <code>primaryCodePath</code>.</p>



<a name="266728164"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/266728164" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Kaney <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#266728164">(Jan 03 2022 at 19:37)</a>:</h4>
<p>There are also some inconsistencies  to consider -- for example in the Patient compartment, why is <code>recorder</code> missing from Condition?  Also, I wonder if the compartment is too restrictive -- e.g. Patient compartment explicitly restricts  practitioner. (But <a href="https://www.hl7.org/fhir/patient-operation-everything.html">patient $everything</a> operation explicitly mentions linked records, including practitioners). I've thus far been leaning toward $everything operation as a way to build the patient bundle for context.</p>



<a name="266730062"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/266730062" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#266730062">(Jan 03 2022 at 19:57)</a>:</h4>
<p><span class="user-mention" data-user-id="191469">@Chris Moesel</span> , we could definitely take that approach, and it would make sense, I was basing my answer on the intended alignment of a "context" in CQL with the concept of a "compartment" in FHIR, though even that notion is still under some development in FHIR. The Retrieve in 1.5 has <code>context</code>, <code>contextProperty</code> and <code>contextSearch</code>, so we could definitely implement a <code>primaryContextPath</code> in the ModelInfo to support this. I'll add a feature request for it.</p>



<a name="266730653"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/266730653" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Stanley <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#266730653">(Jan 03 2022 at 20:02)</a>:</h4>
<p>I hope folks don't mind a slight detour to earlier messages, but I'm stepping through this thread and I see an error (inline) with the above example. Is this correct? Edit: Here's the pastebin of the full error: <a href="https://pastebin.com/SvBMGu2G">https://pastebin.com/SvBMGu2G</a></p>
<div class="codehilite"><pre><span></span><code>library Unfiltered version &#39;0.1.0&#39;

using FHIR version &#39;4.0.1&#39;

include FHIRHelpers version &#39;4.0.1&#39;
include FHIRCommon version &#39;4.0.1&#39; called FC

context Unfiltered

// per fhir chat: this helper is for converting a reference to an id
define function &quot;GetId&quot;(uri String):
    Last(Split(uri, &#39;/&#39;))

// this expression results in org.opencds.cqf.cql.engine.fhir.exception.UnknownType: Could not resolve type Unfiltered.
define &quot;some test&quot;:
[Coverage] C
    with [Patient] P
        such that P.id ~ GetId(C.beneficiary.reference.value)

context Patient

define &quot;Meow&quot;: &quot;some test&quot;
</code></pre></div>



<a name="266731077"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/266731077" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#266731077">(Jan 03 2022 at 20:07)</a>:</h4>
<p><span class="user-mention" data-user-id="194192">@Richard Stanley</span> , that looks like a bug in the <code>Unfiltered</code> context, which the Java engine currently doesn't have great support for. Would you mind submitting that repro as an issue to the engine?</p>



<a name="266731116"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/266731116" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Stanley <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#266731116">(Jan 03 2022 at 20:07)</a>:</h4>
<p>Yep, thanks!</p>



<a name="266731224"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/266731224" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#266731224">(Jan 03 2022 at 20:08)</a>:</h4>
<p>Here's the issue to add <code>primaryContextPath</code> and <code>context</code> details explicitly to the translator: <a href="https://github.com/cqframework/clinical_quality_language/issues/710">https://github.com/cqframework/clinical_quality_language/issues/710</a></p>



<a name="266731276"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/266731276" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#266731276">(Jan 03 2022 at 20:08)</a>:</h4>
<p>Yeah, cool.  I totally dig that, <span class="user-mention" data-user-id="191359">@Bryn Rhodes</span>.</p>



<a name="266731973"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/266731973" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#266731973">(Jan 03 2022 at 20:15)</a>:</h4>
<blockquote>
<p>that looks like a bug in the <code>Unfiltered</code> context</p>
</blockquote>
<p>This is due to the fact that CQL engine expects the <code>context</code> attribute in the ELM to be absent, rather than explicitly be set to <code>Unfiltered</code>. Translator bug or it should handle that case?</p>



<a name="266733404"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/266733404" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#266733404">(Jan 03 2022 at 20:31)</a>:</h4>
<p>It is optional in the spec (<a href="https://cql.hl7.org/04-logicalspecification.html#expressiondef">https://cql.hl7.org/04-logicalspecification.html#expressiondef</a>) so the engines (I would think) should be prepared to deal with it either way.</p>



<a name="266962914"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/How%20does%20CQL%20%27data%20model%27%20match%20perform%20context%20matching%3F/near/266962914" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JP <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/How.20does.20CQL.20&#x27;data.20model&#x27;.20match.20perform.20context.20matching.3F.html#266962914">(Jan 05 2022 at 17:15)</a>:</h4>
<p>Related issue for ModelInfo code gen:<br>
<a href="https://github.com/cqframework/cqf-tooling/issues/335">https://github.com/cqframework/cqf-tooling/issues/335</a></p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
