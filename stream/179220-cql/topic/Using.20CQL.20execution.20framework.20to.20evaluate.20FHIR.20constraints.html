---
layout: page
title: "FHIR Chat  · Using CQL execution framework to evaluate FHIR constraints · cql"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/index.html">cql</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html">Using CQL execution framework to evaluate FHIR constraints</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="153929832"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153929832" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Olbrich <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153929832">(Jan 21 2018 at 01:44)</a>:</h4>
<p>In <em>theory</em> it should be possible to generate code that reflects the constraints on resources as defined in the FHIR definition files.  According to the documentation, the expressions are defined in FHIRPath, which is itself a subset of CQL.  What I would like to do is use the CQL-to-ELM translator to generate an ELM tree for each of the constraints and then use that tree to generate code in a target language.  By doing this we can automate code generation and make sure that it actually matches the definitions as much as possible.  Has anyone tried this?  Is this possible?  Am I wasting my time?</p>



<a name="153929836"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153929836" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153929836">(Jan 21 2018 at 03:08)</a>:</h4>
<p>The build tool parses them all to an ast, and evaluates them, but doesn’t do any code generation. I don’t know of anyone who has done that. Btw, you can use the java ast if you want (if you’re using java)</p>



<a name="153929857"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153929857" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Olbrich <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153929857">(Jan 21 2018 at 08:26)</a>:</h4>
<p><span class="user-mention" data-user-id="191316">@Grahame Grieve</span> can you point me at the code the build tool uses to parse the constraints?</p>



<a name="153929858"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153929858" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153929858">(Jan 21 2018 at 08:50)</a>:</h4>
<p>org.hl7.fhir.r4.model.ExpressionNode and org.hl7.fhir.r4.utils.FHIRPathEngine</p>



<a name="153929874"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153929874" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Olbrich <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153929874">(Jan 21 2018 at 22:37)</a>:</h4>
<p>Weird... there are constraints that look like this <code>hasValue() | (children().count() &gt; id.count())</code> all over the place, but I can't find a definition of <code>hasValue()</code> in the FHIRPath specification (<a href="http://hl7.org/fhirpath/" target="_blank" title="http://hl7.org/fhirpath/">http://hl7.org/fhirpath/</a>).</p>



<a name="153929875"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153929875" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153929875">(Jan 21 2018 at 22:53)</a>:</h4>
<p>hmm. that's something we haven't quite figured out; it's technically a feature of the primitive types in FHIR</p>



<a name="153929876"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153929876" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Olbrich <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153929876">(Jan 21 2018 at 22:55)</a>:</h4>
<p>So is <code>hasValue()</code> really just checking to see if the Element is a primitive?</p>



<a name="153929877"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153929877" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153929877">(Jan 21 2018 at 22:57)</a>:</h4>
<p>no. better to explain it in terms of an element</p>



<a name="153929878"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153929878" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153929878">(Jan 21 2018 at 22:57)</a>:</h4>
<p>&lt;status value="active"/&gt;</p>



<a name="153929879"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153929879" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153929879">(Jan 21 2018 at 22:57)</a>:</h4>
<p>hasValue() == true</p>



<a name="153929880"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153929880" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153929880">(Jan 21 2018 at 22:57)</a>:</h4>
<p>&lt;status&gt;&lt;extension url="balh"&gt;&lt;valueCode value="blah"/&gt;&lt;/extension/&gt;&lt;/status&gt;</p>



<a name="153929881"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153929881" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153929881">(Jan 21 2018 at 22:58)</a>:</h4>
<p>hasValue() == false</p>



<a name="153929886"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153929886" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Olbrich <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153929886">(Jan 21 2018 at 23:34)</a>:</h4>
<p>I see, there are a few things that aren't primitives, but do have a <code>value</code>.</p>



<a name="153929887"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153929887" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Olbrich <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153929887">(Jan 21 2018 at 23:39)</a>:</h4>
<p>What would <code>hasValue()</code> evaluate to for <code>&lt;extension url="foo"&gt;&lt;valueCode="bar"/&gt;&lt;/extension&gt;</code>?</p>



<a name="153929888"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153929888" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Olbrich <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153929888">(Jan 21 2018 at 23:58)</a>:</h4>
<p>Shouldn't that constraint be something like <code>hasValue() or (children().count() &gt; 0)</code>?  What does the <code>id.count()</code> have to do with it?</p>



<a name="153929895"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153929895" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153929895">(Jan 22 2018 at 01:35)</a>:</h4>
<p>hasValue() returns null on Extension because it's not a primitive</p>



<a name="153929896"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153929896" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153929896">(Jan 22 2018 at 01:35)</a>:</h4>
<p>what's the context of this constraint?</p>



<a name="153929898"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153929898" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Olbrich <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153929898">(Jan 22 2018 at 04:53)</a>:</h4>
<p>I'm talking about the <code>ele-1</code> constraint from <code>Element</code> (<code>hasValue() | (children().count() &gt; id.count())</code>).  It's not clear to me why <code>children().count() &gt; id.count()</code> is used instead of <code>children().count() &gt; 0</code>.</p>



<a name="153929899"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153929899" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153929899">(Jan 22 2018 at 04:55)</a>:</h4>
<p>oh because it can have an id but that doesn't as content. So there must be at least one more child than the the count of id (which will be 0 or 1)</p>



<a name="153929939"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153929939" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Olbrich <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153929939">(Jan 22 2018 at 15:06)</a>:</h4>
<p><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> so if I wanted to use the <code>cql-to-elm</code> translator to generate an <code>ELM</code> tree for the <code>ele-1</code> constraint, how would I go about doing it?       --- (BTW... it took longer than I care to admit for me to realize that the <code>ELM</code> here is not the <code>elm</code> programming language)</p>



<a name="153930120"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153930120" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153930120">(Jan 22 2018 at 20:28)</a>:</h4>
<p>Simplest way would be to take the ele-1 constraint and put it in a .cql file and call the command-line translator on it. There's context though, so you would need to set up a library to express the definition, something like this:</p>



<a name="153930121"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153930121" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153930121">(Jan 22 2018 at 20:29)</a>:</h4>
<p><code>library "ele-1"
using FHIR version '3.0.0'
parameter Context Patient
define Constraint: &lt;content of the ele-1 constraint&gt;</code></p>



<a name="153930124"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153930124" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Olbrich <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153930124">(Jan 22 2018 at 20:53)</a>:</h4>
<p>I'll give that a try, thanks!</p>



<a name="153930129"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153930129" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Olbrich <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153930129">(Jan 22 2018 at 21:03)</a>:</h4>
<p>if I send this... </p>
<div class="codehilite"><pre><span></span>library &quot;ele-1&quot;

using FHIR version &#39;3.0.0&#39;
parameter Context Patient
define Constraint:
    hasValue() | (children().count() &gt; id.count())
</pre></div>


<p>To the cql-to-elm translator docker container I get this in response...</p>
<div class="codehilite"><pre><span></span>{
    &quot;library&quot;: {
        &quot;annotation&quot;: [
            {
                &quot;startLine&quot;: 6,
                &quot;startChar&quot;: 2,
                &quot;endLine&quot;: 6,
                &quot;endChar&quot;: 11,
                &quot;message&quot;: &quot;Could not resolve call to operator hasValue with signature ().&quot;,
                &quot;errorType&quot;: &quot;semantic&quot;,
                &quot;errorSeverity&quot;: &quot;error&quot;,
                &quot;type&quot;: &quot;CqlToElmError&quot;
            }
        ],
        &quot;identifier&quot;: {
            &quot;id&quot;: &quot;ele-1&quot;
        },
        &quot;schemaIdentifier&quot;: {
            &quot;id&quot;: &quot;urn:hl7-org:elm&quot;,
            &quot;version&quot;: &quot;r1&quot;
        },
        &quot;usings&quot;: {
            &quot;def&quot;: [
                {
                    &quot;localIdentifier&quot;: &quot;System&quot;,
                    &quot;uri&quot;: &quot;urn:hl7-org:elm-types:r1&quot;
                },
                {
                    &quot;localId&quot;: &quot;1&quot;,
                    &quot;localIdentifier&quot;: &quot;FHIR&quot;,
                    &quot;uri&quot;: &quot;http://hl7.org/fhir&quot;,
                    &quot;version&quot;: &quot;3.0.0&quot;
                }
            ]
        },
        &quot;parameters&quot;: {
            &quot;def&quot;: [
                {
                    &quot;localId&quot;: &quot;3&quot;,
                    &quot;name&quot;: &quot;Context&quot;,
                    &quot;accessLevel&quot;: &quot;Public&quot;,
                    &quot;parameterTypeSpecifier&quot;: {
                        &quot;localId&quot;: &quot;2&quot;,
                        &quot;name&quot;: &quot;{http://hl7.org/fhir}Patient&quot;,
                        &quot;type&quot;: &quot;NamedTypeSpecifier&quot;
                    }
                }
            ]
        },
        &quot;statements&quot;: {...
</pre></div>



<a name="153930325"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153930325" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Olbrich <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153930325">(Jan 23 2018 at 16:14)</a>:</h4>
<p><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span> looks like this doesn't work as expected.  Any idea how to correct this?  It seems like I'm just missing some definitions, but I have no idea where to find them.</p>



<a name="153930329"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153930329" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153930329">(Jan 23 2018 at 16:23)</a>:</h4>
<p>Since it is a constraint, it needs to be evaluated in the context of the definition, so it needs a bit more setup:</p>



<a name="153930337"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153930337" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153930337">(Jan 23 2018 at 16:28)</a>:</h4>
<p>I'll log this as an issue and get it running in the translator. hasValue() in particular it looks like is missing, I may need to add that to FHIR Helpers.</p>



<a name="153930338"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/Using%20CQL%20execution%20framework%20to%20evaluate%20FHIR%20constraints/near/153930338" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kevin Olbrich <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/Using.20CQL.20execution.20framework.20to.20evaluate.20FHIR.20constraints.html#153930338">(Jan 23 2018 at 16:28)</a>:</h4>
<p>Awesome! Thanks!</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
