---
layout: page
title: "FHIR Chat  · diagnoses algorithms to CQL · cql"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/index.html">cql</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/diagnoses.20algorithms.20to.20CQL.html">diagnoses algorithms to CQL</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="241937531"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/diagnoses%20algorithms%20to%20CQL/near/241937531" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrien Prost <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/diagnoses.20algorithms.20to.20CQL.html#241937531">(Jun 08 2021 at 15:25)</a>:</h4>
<p>Hello, I am working on translating a CDS  to CQL format: </p>
<ul>
<li>The CDS is structured as a flowchart with nodes that ask specific observations from the patients (see attached image <a href="/user_uploads/10155/bKMaeyJRYOI47O5js0wJK6V1/Screenshot-from-2021-06-08-16-41-25.png">Screenshot-from-2021-06-08-16-41-25.png</a> )<div class="message_inline_image"><a href="/user_uploads/10155/bKMaeyJRYOI47O5js0wJK6V1/Screenshot-from-2021-06-08-16-41-25.png" title="Screenshot-from-2021-06-08-16-41-25.png"><img src="/user_uploads/10155/bKMaeyJRYOI47O5js0wJK6V1/Screenshot-from-2021-06-08-16-41-25.png"></a></div></li>
</ul>
<p>Intuitively, having explored a bit CQL, the straightforward way would be to represent the nodes as retrieve statements of observations and conditions and then creating a function  which defines the logic of the flowchart and returns the results of the diagnostic. Before implementing this, I was wondering if there was some existing standard (that I overlooked) on representing these algorithms in CQL ?</p>



<a name="242269551"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/diagnoses%20algorithms%20to%20CQL/near/242269551" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/diagnoses.20algorithms.20to.20CQL.html#242269551">(Jun 10 2021 at 20:55)</a>:</h4>
<p><span class="user-mention" data-user-id="418818">@Adrien Prost</span> , you could express that as a decision tree in a PlanDefinition where the conditions on each node reference expressions in CQL. There are groups doing that, and there is even some basic tooling to convert simple decision tables to PlanDefinitions with corresponding CQL libraries. There's some manual work to do after the generation step, but it saves a lot of scaffolding. Here's a project that's using that tooling: <a href="https://github.com/who-int/anc-cds/blob/feature_updated_dataelements_with_decision_tables/input/l2/WHO-SRH-21.2-eng.xlsx">https://github.com/who-int/anc-cds/blob/feature_updated_dataelements_with_decision_tables/input/l2/WHO-SRH-21.2-eng.xlsx</a></p>



<a name="242756215"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/diagnoses%20algorithms%20to%20CQL/near/242756215" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrien Prost <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/diagnoses.20algorithms.20to.20CQL.html#242756215">(Jun 15 2021 at 16:00)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="191359">@Bryn Rhodes</span>  ! I am not aware of what are PlanDefinitions, googling around I landed on this:  <a href="http://www.hl7.org/fhir/clinicalreasoning-module.html">http://www.hl7.org/fhir/clinicalreasoning-module.html</a>, if you have any links on more docs related to this it would be great :)</p>



<a name="242864131"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/diagnoses%20algorithms%20to%20CQL/near/242864131" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrien Prost <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/diagnoses.20algorithms.20to.20CQL.html#242864131">(Jun 16 2021 at 10:58)</a>:</h4>
<p>I have looked at some PlanDefinition examples from <a href="http://hl7.org/fhir/R4/plandefinition.html">http://hl7.org/fhir/R4/plandefinition.html</a>. In these examples I can clearly see the CQL references however I do not see the decision tree logic encoded in the resource, is there any example of a PlanDefinition resource in which a decision tree logic is encoded ?</p>



<a name="242948561"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/diagnoses%20algorithms%20to%20CQL/near/242948561" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/diagnoses.20algorithms.20to.20CQL.html#242948561">(Jun 16 2021 at 21:57)</a>:</h4>
<p><span class="user-mention" data-user-id="418818">@Adrien Prost</span> , here's an example of one of those decision tables represented in a PlanDefinition:</p>



<a name="242948563"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/diagnoses%20algorithms%20to%20CQL/near/242948563" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/diagnoses.20algorithms.20to.20CQL.html#242948563">(Jun 16 2021 at 21:57)</a>:</h4>
<p><a href="https://github.com/who-int/anc-cds/blob/master/input/resources/plandefinition/plandefinition-ANCDT03.json">https://github.com/who-int/anc-cds/blob/master/input/resources/plandefinition/plandefinition-ANCDT03.json</a></p>



<a name="242948620"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/diagnoses%20algorithms%20to%20CQL/near/242948620" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/diagnoses.20algorithms.20to.20CQL.html#242948620">(Jun 16 2021 at 21:58)</a>:</h4>
<p>And the associated CQL for it: <a href="https://github.com/who-int/anc-cds/blob/master/input/cql/ANCDT03.cql">https://github.com/who-int/anc-cds/blob/master/input/cql/ANCDT03.cql</a></p>



<a name="242948728"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/diagnoses%20algorithms%20to%20CQL/near/242948728" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/diagnoses.20algorithms.20to.20CQL.html#242948728">(Jun 16 2021 at 21:59)</a>:</h4>
<p>Most of the structure there is generated from the data dictionary and the decision tables. Only the final CQL is "engineered", and even that has pseudo-code coming from the decision tables (see the comments on the expressions in the CQL).</p>



<a name="242993208"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/diagnoses%20algorithms%20to%20CQL/near/242993208" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrien Prost <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/diagnoses.20algorithms.20to.20CQL.html#242993208">(Jun 17 2021 at 09:33)</a>:</h4>
<p><span class="user-mention" data-user-id="191359">@Bryn Rhodes</span>  thanks for the pointers, my guess is that in my case the algorithms are more complex than decision tables and therefore I think it is best to encode them using CQL, then have a PlanDefinition Resource with a single action refering to the CQL algorithm</p>



<a name="243063431"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/diagnoses%20algorithms%20to%20CQL/near/243063431" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/diagnoses.20algorithms.20to.20CQL.html#243063431">(Jun 17 2021 at 18:35)</a>:</h4>
<p>Yes, that makes sense, and here's an example of that type of usage: <a href="https://github.com/cqframework/opioid-cds-r4/blob/master/input/resources/plandefinition/plandefinition-opioidcds-05.xml">https://github.com/cqframework/opioid-cds-r4/blob/master/input/resources/plandefinition/plandefinition-opioidcds-05.xml</a>, and the CQL that it references: <a href="https://github.com/cqframework/opioid-cds-r4/blob/master/input/pagecontent/cql/OpioidCDSREC05.cql">https://github.com/cqframework/opioid-cds-r4/blob/master/input/pagecontent/cql/OpioidCDSREC05.cql</a></p>



<a name="245329500"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/diagnoses%20algorithms%20to%20CQL/near/245329500" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrien Prost <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/diagnoses.20algorithms.20to.20CQL.html#245329500">(Jul 08 2021 at 15:24)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="191359">@Bryn Rhodes</span>  I am coming back on this again after continuing my research on how to convert our medical algorithms to CQL code. In our case, we are working with complex consultation medical algorithms for patient consultations for which the order in which the questions and observations on patients is done is of great importance. To be more specific, our CDS algorithms are complex decision trees where nodes may have multiple outgoing edges / descendant nodes and we wish to use CQL to guide patient consultation. My initial guess was to proceed in the following way:</p>
<ul>
<li>We represent the algorithm using a CQL function <code>define algorithm()</code> which returns a List of strings where each string is either a possible diagnose, or a string indicating that a specific measurement/questions should be asked (example "question X") to the patient as the algorithm cannot output more possible diagnoses as there are missing measurements on the patient. </li>
<li>We then create clauses for each questions that <em>could</em> be asked to a patient: for example: </li>
</ul>
<div class="codehilite" data-code-language="JavaScript"><pre><span></span><code><span class="nx">define</span> <span class="s2">"should ask question X"</span> <span class="o">:</span>
    <span class="nx">algorithm</span><span class="p">()</span> <span class="nx">contains</span> <span class="s2">"question X"</span>
</code></pre></div>
<ul>
<li>For each possible question, a <em>PlanDefinition</em> Resource is created which activates under the condition that the "should ask question X" clause evaluates to true.</li>
<li>The consultation would work as follows: the patient would answer basic mandatory questions and Observation/Condition resources will be uploaded to the FHIR server. Depending, on the observations, the clinical reasoning module will activate and return PlanDefinition resources to the consultation that indicate what are the next questions to be asked to the patient. </li>
</ul>
<p>I was wondering if this workflow makes sense or if I am overlooking at some FHIR resources that could be more useful in this context. The problem with this approach is that the <code>algorithm()</code> CQL function (which will be pretty complex) would be evaluated many times for each possible question at each iteration.</p>



<a name="245337236"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/diagnoses%20algorithms%20to%20CQL/near/245337236" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/diagnoses.20algorithms.20to.20CQL.html#245337236">(Jul 08 2021 at 16:25)</a>:</h4>
<p>Would it make sense to collapse the questions into a single PlanDefinition with multiple actions? Each action can have an applicability condition, so you could potentially model the whole process in a single PlanDefinition (or potentially a set of PlanDefinitions appropriately modularized).</p>



<a name="245337394"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/diagnoses%20algorithms%20to%20CQL/near/245337394" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/diagnoses.20algorithms.20to.20CQL.html#245337394">(Jul 08 2021 at 16:27)</a>:</h4>
<p>As far as evaluation, the simplest case would evaluate all the expressions on every iteration, but it would be potentially straightforward to implement some optimization there so that the evaluation only asked for evaluation of expressions relevant in the decision tree.</p>



<a name="245337616"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/diagnoses%20algorithms%20to%20CQL/near/245337616" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/diagnoses.20algorithms.20to.20CQL.html#245337616">(Jul 08 2021 at 16:28)</a>:</h4>
<p>In addition, the Java-engine at least can do caching of expression evaluation, but it only does it on Expressions currently. Is there a reason to define <code>algorithms()</code> as a function without parameters, as opposed to an expression definition?</p>



<a name="245409558"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/diagnoses%20algorithms%20to%20CQL/near/245409558" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrien Prost <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/diagnoses.20algorithms.20to.20CQL.html#245409558">(Jul 09 2021 at 07:25)</a>:</h4>
<p>No, indeed I have wrongly assumed that expressions only returned boolean values, but apparently this is not the case. I would then ask what is the difference between both ?</p>



<a name="246005726"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179220-cql/topic/diagnoses%20algorithms%20to%20CQL/near/246005726" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bryn Rhodes <a href="https://fhir.github.io/chat-archive/stream/179220-cql/topic/diagnoses.20algorithms.20to.20CQL.html#246005726">(Jul 14 2021 at 19:12)</a>:</h4>
<p>The difference is syntactic from an invocation perspective, but from a definition perspective, a function is allowed to be external.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
