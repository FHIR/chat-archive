---
layout: page
title: "FHIR Chat  · ✔ Java JWS / rawDeflate problems · smart/health-cards"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/284830-smart/health-cards/index.html">smart/health-cards</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/284830-smart/health-cards/topic/.E2.9C.94.20Java.20JWS.20.2F.20rawDeflate.20problems.html">✔ Java JWS / rawDeflate problems</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="252600404"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/284830-smart/health-cards/topic/%E2%9C%94%20Java%20JWS%20/%20rawDeflate%20problems/near/252600404" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Deftdawg <a href="https://fhir.github.io/chat-archive/stream/284830-smart/health-cards/topic/.E2.9C.94.20Java.20JWS.20.2F.20rawDeflate.20problems.html#252600404">(Sep 09 2021 at 10:03)</a>:</h4>
<p>I'm struggling to encode a usable FHIR in a Java JWS.   I have the same payload as the dev portal, however there is extra stuff being added to the Java payload that breaks compatibility with the FHIR validators - see below for data and java code.  If anyone has feedback or knows of a working implentation in java, please chime in...  <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>
<p>The JWS Payload I generate has a single bit off* in the first two bytes and has a certain amount of extra data appended to it.</p>
<p>What I generate (note [ is common stuff ]) : </p>
<div class="codehilite"><pre><span></span><code> 7A 46* [52 4E 62 39 73 77 44 50 30 72 41 33 65 4E 48 54 76 4E 6C 73 62 48 64 6F 66 32 4D 47 44 41 73 75 30 51 39 4B 42 49 74 4B 31 42 48 77
 59 6C 65 30 30 44 5F 5F 64 52 54 6C 49 67 47 33 4C 50 55 65 54 6A 34 2D 4F 6A 70 41 4F 34 58 51 31 56 4D 51 4D 64 41 6C 54 51 78 74 69 46
 61 6A 36 33 49 6B 53 6B 58 4E 32 74 71 4C 35 5F 43 30 73 39 4C 50 2D 38 35 73 4A 32 52 74 64 37 30 58 57 35 39 42 5A 6D 4D 45 69 6F 44 69
 41 4A 46 62 71 6F 68 66 6E 65 37 33 36 6A 6A 43 6C 59 74 35 70 2D 49 67 58 74 48 66 4D 75 38 79 49 76 75 53 42 46 48 33 71 6E 44 43 59 4D
 46 39 45 65 71 75 30 42 43 49 50 76 53 55 37 52 42 70 31 43 34 69 49 72 47 44 59 44 4A 79 78 4F 6F 45 59 50 79 47 52 62 65 4F 70 33 53 4A
 46 54 44 30 5A 6F 6C 7A 42 50 49 67 51 30 72 61 39 72 65 4F 45 75 77 6D 72 44 78 50 44 4C 6D 78 71 44 62 41 30 32 61 48 67 69 37 56 72 52
 42 33 52 63 33 69 41 70 54 34 77 66 75 57 43 6E 4B 62 5A 66 52 4F 51 2D 55 4B 37 4C 56 56 5A 38 79 68 5A 72 35 6A 33 72 32 75 79 37 6C 50
 73 6D 6F 6D 62 52 4D 48 4B 50 33 70 67 66 5A 44 68 34 78 6C 51 46 78 79 39 48 36 5A 42 71 54 7A 5A 4E 77 5F 71 46 6A 4A 35 53 57 4F 6E 51
 47 5A 45 45 66 6E 33 65 66 48 67 30 32 6D 6B 4A 59 78 4C 53 6E 52 70 55 69 61 64 47 51 70 65 49 4C 6C 75 41 6C 37 4B 6E 4B 5A 55 6B 62 33
 53 79 42 78 62 46 6F 73 79 4B 5A 56 62 63 70 37 30 49 4B 64 6D 59 52 36 38 6D 47 64 49 72 37 5A 70 4A 51 39 69 7A 44 66 61 30 61 56 35 30
 61 31 61 35 70 32 61 65 46 6A 4D 50 57 73 33 6C 38 4D 6F 45 63 71 70 6B 30 68 58 37 4D 5F 37 6E 77 37 4F 31 76 64 4E 76 4C 4A 61 33 4F 34
 4D 51 52 65 7A 54 39 65 46 62 30 52 6D 4D 71 4B 34 34 56 4E 36 45 51 36 73 62 64 6D 68 78 45 77 35 39 76 6D 47 48 37 71 59 58 47 34 38 6B
 30 68 76 44 48 38 36 52 34 70 38 47 70 33 39 6D 48 4D 5F 6F 37 66 76 33 46 71 7A 67 42 34 5F 43 78 44 61 58 67 6C 54 34 65 44 78 6B 36 63
 42 4D 31 33 48 36 55 76 56 31 6F 50 53 44 56 75 55 61 58 73 62 78 4C 77] 41 41 41 50 5F 5F 0A
</code></pre></div>
<p>Here's what the same payload creates with the developer portal (<a href="https://demo-portals.smarthealth.cards/DevPortal.html">https://demo-portals.smarthealth.cards/DevPortal.html</a>): </p>
<div class="codehilite"><pre><span></span><code>7A 56* [52 4E 62 39 73 77 44 50 30 72 41 33 65 4E 48 54 76 4E 6C 73 62 48 64 6F 66 32 4D 47 44 41 73 75 30 51 39 4B 42 49 74 4B 31 42 48 77
 59 6C 65 30 30 44 5F 5F 64 52 54 6C 49 67 47 33 4C 50 55 65 54 6A 34 2D 4F 6A 70 41 4F 34 58 51 31 56 4D 51 4D 64 41 6C 54 51 78 74 69 46
 61 6A 36 33 49 6B 53 6B 58 4E 32 74 71 4C 35 5F 43 30 73 39 4C 50 2D 38 35 73 4A 32 52 74 64 37 30 58 57 35 39 42 5A 6D 4D 45 69 6F 44 69
 41 4A 46 62 71 6F 68 66 6E 65 37 33 36 6A 6A 43 6C 59 74 35 70 2D 49 67 58 74 48 66 4D 75 38 79 49 76 75 53 42 46 48 33 71 6E 44 43 59 4D
 46 39 45 65 71 75 30 42 43 49 50 76 53 55 37 52 42 70 31 43 34 69 49 72 47 44 59 44 4A 79 78 4F 6F 45 59 50 79 47 52 62 65 4F 70 33 53 4A
 46 54 44 30 5A 6F 6C 7A 42 50 49 67 51 30 72 61 39 72 65 4F 45 75 77 6D 72 44 78 50 44 4C 6D 78 71 44 62 41 30 32 61 48 67 69 37 56 72 52
 42 33 52 63 33 69 41 70 54 34 77 66 75 57 43 6E 4B 62 5A 66 52 4F 51 2D 55 4B 37 4C 56 56 5A 38 79 68 5A 72 35 6A 33 72 32 75 79 37 6C 50
 73 6D 6F 6D 62 52 4D 48 4B 50 33 70 67 66 5A 44 68 34 78 6C 51 46 78 79 39 48 36 5A 42 71 54 7A 5A 4E 77 5F 71 46 6A 4A 35 53 57 4F 6E 51
 47 5A 45 45 66 6E 33 65 66 48 67 30 32 6D 6B 4A 59 78 4C 53 6E 52 70 55 69 61 64 47 51 70 65 49 4C 6C 75 41 6C 37 4B 6E 4B 5A 55 6B 62 33
 53 79 42 78 62 46 6F 73 79 4B 5A 56 62 63 70 37 30 49 4B 64 6D 59 52 36 38 6D 47 64 49 72 37 5A 70 4A 51 39 69 7A 44 66 61 30 61 56 35 30
 61 31 61 35 70 32 61 65 46 6A 4D 50 57 73 33 6C 38 4D 6F 45 63 71 70 6B 30 68 58 37 4D 5F 37 6E 77 37 4F 31 76 64 4E 76 4C 4A 61 33 4F 34
 4D 51 52 65 7A 54 39 65 46 62 30 52 6D 4D 71 4B 34 34 56 4E 36 45 51 36 73 62 64 6D 68 78 45 77 35 39 76 6D 47 48 37 71 59 58 47 34 38 6B
 30 68 76 44 48 38 36 52 34 70 38 47 70 33 39 6D 48 4D 5F 6F 37 66 76 33 46 71 7A 67 42 34 5F 43 78 44 61 58 67 6C 54 34 65 44 78 6B 36 63
 42 4D 31 33 48 36 55 76 56 31 6F 50 53 44 56 75 55 61 58 73 62 78 4C 77]
</code></pre></div>
<p>Here's the that's preparing the payload (it's using io.jsonwebtoken.jwt lib):</p>
<div class="codehilite"><pre><span></span><code>        JwtBuilder jwtBuilder = Jwts.builder()
            .setHeaderParam(&quot;kid&quot;, jwk.getKeyID())
            .setPayload(jo.toString())
            .compressWith( // CompressionCodecs.DEFLATE
                // We must roll our own because stock deflate adds zlib headers
                new CompressionCodec() {

                    private static final String DEFLATE = &quot;DEF&quot;;

                    @Override
                    public String getAlgorithmName() {
                        return DEFLATE;
                    }

                    @Override
                    public byte[] compress(byte[] payload) throws CompressionException {

                        Deflater deflater = new Deflater(Deflater.DEFLATED, true); // true for rawDeflate

                        ByteArrayOutputStream outputStream = null;
                        DeflaterOutputStream deflaterOutputStream = null;
                        try {
                            outputStream = new ByteArrayOutputStream();
                            deflaterOutputStream = new DeflaterOutputStream(outputStream, deflater, true);
                            deflaterOutputStream.write(payload, 0, payload.length);

                            // deflaterOutputStream.
                            deflaterOutputStream.flush();
                            byte[] output = outputStream.toByteArray();
                            // FIXME: There is some amount of extra stuff that is appended to the array, the amount varies
                            byte[] result = Arrays.copyOf(output, output.length); 
                            return result;                     
                        } catch (IOException e) {
                            // TODO Auto-generated catch block
                            e.printStackTrace();
                            throw new CompressionException(e.getMessage());
                        } finally {
                            Objects.nullSafeClose(outputStream, deflaterOutputStream);
                        }
                    }

                    @Override
                    public byte[] decompress(byte[] compressed) {
                        // TODO: not implemented
                        return compressed;
                    }
                }
            )
            .signWith(
                SignatureAlgorithm.ES256,
                privateKey
            );

        String jws = jwtBuilder.compact();
</code></pre></div>



<a name="252619752"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/284830-smart/health-cards/topic/%E2%9C%94%20Java%20JWS%20/%20rawDeflate%20problems/near/252619752" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/284830-smart/health-cards/topic/.E2.9C.94.20Java.20JWS.20.2F.20rawDeflate.20problems.html#252619752">(Sep 09 2021 at 12:53)</a>:</h4>
<p>what library are you using here to prepare the jws payload? <span class="user-mention" data-user-id="365368">@James Kizer</span> I think has recommendations (but I don't see them at <a href="https://github.com/smart-on-fhir/health-cards/wiki/Libraries-for-SMART-Health-Cards">https://github.com/smart-on-fhir/health-cards/wiki/Libraries-for-SMART-Health-Cards</a>)</p>



<a name="252647012"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/284830-smart/health-cards/topic/%E2%9C%94%20Java%20JWS%20/%20rawDeflate%20problems/near/252647012" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Deftdawg <a href="https://fhir.github.io/chat-archive/stream/284830-smart/health-cards/topic/.E2.9C.94.20Java.20JWS.20.2F.20rawDeflate.20problems.html#252647012">(Sep 09 2021 at 15:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="191315">Josh Mandel</span> <a href="#narrow/stream/284830-smart.2Fhealth-cards/topic/Java.20JWS.20.2F.20rawDeflate.20problems/near/252619752">said</a>:</p>
<blockquote>
<p>what library are you using here to prepare the jws payload? <span class="user-mention silent" data-user-id="365368">James Kizer</span> I think has recommendations (but I don't see them at <a href="https://github.com/smart-on-fhir/health-cards/wiki/Libraries-for-SMART-Health-Cards">https://github.com/smart-on-fhir/health-cards/wiki/Libraries-for-SMART-Health-Cards</a>)</p>
</blockquote>
<p>The list only has JS and ruby for recommended libraries for handling JWS. (<a href="https://github.com/smart-on-fhir/health-cards/wiki/Libraries-for-SMART-Health-Cards#what-are-good-libraries-for-jws">https://github.com/smart-on-fhir/health-cards/wiki/Libraries-for-SMART-Health-Cards#what-are-good-libraries-for-jws</a>)</p>
<p>Being on Java, I'm using io.jsonwebtoken.jjwt ( <a href="https://github.com/jwtk/jjwt#compression">https://github.com/jwtk/jjwt#compression</a> ) because it indicated it supported DEFLATE on JWS when I was researching (where Java jose says it only does so for JWE), sadly I only realized jjwt was adding zlib content wrapping quite a bit later which is why I had to roll my own compression codec to turn on nowrap to true.</p>
<p>It should be possible to fix the outputStream data before the "compress()" returns it's result (the reason I dumped it into the array), but I'm stumped as to what Java is adding to the stream at the tail end (so don't know how many bytes to truncate off) and also don't know how to set the first 2 bytes to make it match the expected.</p>
<p>I will also look at the java Jose lib again to see if there is something I missed.</p>



<a name="252654296"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/284830-smart/health-cards/topic/%E2%9C%94%20Java%20JWS%20/%20rawDeflate%20problems/near/252654296" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/284830-smart/health-cards/topic/.E2.9C.94.20Java.20JWS.20.2F.20rawDeflate.20problems.html#252654296">(Sep 09 2021 at 16:24)</a>:</h4>
<p>I'm not familiar with the Java libraries but we've had successful implementations and it looks like we'll want to capture "known good" libraries on that page. I think <span class="user-mention" data-user-id="365368">@James Kizer</span> will have good ideas when he has a chance to weigh in here.</p>



<a name="252657011"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/284830-smart/health-cards/topic/%E2%9C%94%20Java%20JWS%20/%20rawDeflate%20problems/near/252657011" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Kizer <a href="https://fhir.github.io/chat-archive/stream/284830-smart/health-cards/topic/.E2.9C.94.20Java.20JWS.20.2F.20rawDeflate.20problems.html#252657011">(Sep 09 2021 at 16:43)</a>:</h4>
<p><span class="user-mention" data-user-id="437951">@Deftdawg</span> happy to help. Keep in mind that we're that we're only using Java libs to decode SHCs, so your experience will likely mirror of what we're doing. </p>
<p>We're using the <a href="https://connect2id.com/products/nimbus-jose-jwt">Nimbus JOSE + JWT library</a> for consuming the JWS objects. We use the <a href="https://www.javadoc.io/static/com.nimbusds/nimbus-jose-jwt/9.13/src-html/com/nimbusds/jose/JWSObject.html#line.440">JWSObject.parse</a> to parse the JWS string into a JWS object. The JWS object provides a <code>getPayload</code> method that provides access to <code>Payload</code> object, which has a <code>toBytes</code> method to get access to the raw bytes in the payload.</p>
<p>Once we have the raw bytes, we use the standard Java <a href="https://docs.oracle.com/javase/8/docs/api/java/util/zip/Inflater.html"><code>Inflater</code></a> to decompress the payload. When instantiating the <code>Inflater</code> object, we needed to include a <code>true</code> value for <code>nowrap</code>. Other than that, it's pretty similar to the sample code included in the Java docs.</p>
<p>Once we've decompressed the payload bytes, we convert it to a string with UTF-8 encoding and deserialize the string into the SHC payload (e.g., <a href="https://spec.smarthealth.cards/examples/example-00-c-jws-payload-minified.json">https://spec.smarthealth.cards/examples/example-00-c-jws-payload-minified.json</a>)</p>



<a name="252657354"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/284830-smart/health-cards/topic/%E2%9C%94%20Java%20JWS%20/%20rawDeflate%20problems/near/252657354" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Kizer <a href="https://fhir.github.io/chat-archive/stream/284830-smart/health-cards/topic/.E2.9C.94.20Java.20JWS.20.2F.20rawDeflate.20problems.html#252657354">(Sep 09 2021 at 16:45)</a>:</h4>
<p>What you're doing seems to make sense, but I wonder if instead of using <code>DeflaterOutputStream</code>, you might want to try more closely following the sample <a href="https://docs.oracle.com/javase/8/docs/api/java/util/zip/Deflater.html">here</a>. I'd be interested to see if DeflaterOutputStream is reporting a different output length than what <code>compresser.deflate(output)</code> would report</p>



<a name="252658094"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/284830-smart/health-cards/topic/%E2%9C%94%20Java%20JWS%20/%20rawDeflate%20problems/near/252658094" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Kizer <a href="https://fhir.github.io/chat-archive/stream/284830-smart/health-cards/topic/.E2.9C.94.20Java.20JWS.20.2F.20rawDeflate.20problems.html#252658094">(Sep 09 2021 at 16:50)</a>:</h4>
<p>I'd try something like this:</p>
<div class="codehilite"><pre><span></span><code>@Override
public byte[] compress(byte[] payload) throws CompressionException {
    try {
        // Compress the bytes
        byte[] output = new byte[payload.length];
        Deflater compresser = new Deflater();
        compresser.setInput(payload);
        compresser.finish();
        int compressedDataLength = compresser.deflate(output);
        byte[] result = Arrays.copyOf(output, compressedDataLength);
        return result;
    } catch (IOException e) {
        // TODO Auto-generated catch block
        e.printStackTrace();
        throw new CompressionException(e.getMessage());
    } finally {
        compresser.end();
    }
}
</code></pre></div>



<a name="252658219"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/284830-smart/health-cards/topic/%E2%9C%94%20Java%20JWS%20/%20rawDeflate%20problems/near/252658219" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Deftdawg <a href="https://fhir.github.io/chat-archive/stream/284830-smart/health-cards/topic/.E2.9C.94.20Java.20JWS.20.2F.20rawDeflate.20problems.html#252658219">(Sep 09 2021 at 16:51)</a>:</h4>
<p><span class="user-mention" data-user-id="365368">@James Kizer</span> thanks, I confirmed with another team and the also pointed me back to Nimbus JOSE and it looks like what I missed is they have a Utility class that can do proper rawDeflate compression, here is my alternative implementation using that, so far the results are promising:</p>
<div class="codehilite"><pre><span></span><code>                jwk = JWK.parse(jwkS);
                // ecKey = com.nimbusds.jose.jwk.ECKey.parse(jwkS);
                ecKey = jwk.toECKey();
                privateKeyS = Base64.encodeBase64String(ecKey.toECPrivateKey().getEncoded());

                KeyFactory kf = KeyFactory.getInstance(&quot;EC&quot;);
                AlgorithmParameters parameters = AlgorithmParameters.getInstance(&quot;EC&quot;);

                parameters.init(new ECGenParameterSpec(&quot;secp256r1&quot;)); // P-256
                ECParameterSpec ecParameters = parameters.getParameterSpec(ECParameterSpec.class);
                ECPrivateKeySpec privateSpec = new ECPrivateKeySpec(new BigInteger(1, ecKey.toECPrivateKey().getEncoded()), ecParameters);
                privateKey = (ECPrivateKey) kf.generatePrivate(privateSpec);

                JWSObject jwsObject = new JWSObject(
                    new JWSHeader.Builder(JWSAlgorithm.ES256).keyID(jwk.getKeyID()).customParam(&quot;zip&quot;,&quot;DEF&quot;).build(),
                    new Payload(DeflateUtils.compress(jo.toString().getBytes())));

                JWSSigner signer = new ECDSASigner(jwk.toECKey());

                // Compute the EC signature
                jwsObject.sign(signer);

                // Serialize the JWS to compact form
                joseSignedData = jwsObject.serialize();
</code></pre></div>



<a name="252663855"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/284830-smart/health-cards/topic/%E2%9C%94%20Java%20JWS%20/%20rawDeflate%20problems/near/252663855" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://fhir.github.io/chat-archive/stream/284830-smart/health-cards/topic/.E2.9C.94.20Java.20JWS.20.2F.20rawDeflate.20problems.html#252663855">(Sep 09 2021 at 17:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="437951">Deftdawg</span> has marked this topic as resolved.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
