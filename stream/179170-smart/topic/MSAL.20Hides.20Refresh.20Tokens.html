---
layout: page
title: "FHIR Chat  · MSAL Hides Refresh Tokens · smart"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179170-smart/index.html">smart</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179170-smart/topic/MSAL.20Hides.20Refresh.20Tokens.html">MSAL Hides Refresh Tokens</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="225226193"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179170-smart/topic/MSAL%20Hides%20Refresh%20Tokens/near/225226193" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Torin Shepard <a href="https://fhir.github.io/chat-archive/stream/179170-smart/topic/MSAL.20Hides.20Refresh.20Tokens.html#225226193">(Feb 04 2021 at 21:34)</a>:</h4>
<p>Need help using MSAL which does not issue refresh tokens.</p>
<p>SMART App Launch Framework documentation describes explicit use of refresh tokens.</p>
<p>SMART retrieval and refresh sequence<br>
<a href="https://www.hl7.org/fhir/smart-app-launch/#smart-retrieval-and-refresh-sequence">https://www.hl7.org/fhir/smart-app-launch/#smart-retrieval-and-refresh-sequence</a></p>
<p>App uses a refresh token to obtain a new access token<br>
<a href="https://www.hl7.org/fhir/smart-app-launch/#step-5-later-app-uses-a-refresh-token-to-obtain-a-new-access-token">https://www.hl7.org/fhir/smart-app-launch/#step-5-later-app-uses-a-refresh-token-to-obtain-a-new-access-token</a></p>
<p>Client apps request refresh token via offline_access scope.  EHR FHIR Server supplies refresh_token in response back to the client.  Client uses refresh token to request new access tokens when the old access tokens expire.</p>
<p>FHIR Servers that use with Azure Active Directory (AAD) authentication through Mircosoft Authentication Library (MSAL) cannot follow this flow because MSAL does not return refresh tokens anymore.  Although Azure Active Directory Library (ADAL) returned refresh tokens, MSAL does not.</p>
<p>Stack Overflow posting - Get refresh token with MSAL<br>
<a href="https://stackoverflow.com/questions/48952087/get-refresh-token-with-azure-ad-v2-0-msal-and-asp-net-core-2-0/58482043#58482043">https://stackoverflow.com/questions/48952087/get-refresh-token-with-azure-ad-v2-0-msal-and-asp-net-core-2-0/58482043#58482043</a></p>
<p>MSAL does not expose the refresh token, but rather keeps it internal and handles all token refresh and caching logic on the app's behalf.</p>
<p>With reference to the OAuth2 protocol, MSAL completes steps related to refresh tokens on your behalf. It goes to the /token endpoint with an authorization code (after the end user signs in), and is issued an Access and Refresh token. The Access Token is valid for 1 hour, and when it's expired, MSAL AcquireTokenSilent will automatically use the refresh token against the /token endpoint to get a new access token.</p>
<p>Although ADAL returned refresh tokens, the MSAL library does not.  Although a FHIR Server gets  <em>access tokens</em> from MSAL, it cannot get <em>refresh tokens</em> from MSAL.  Can the SMART on FHIR protocol specification be interpreted or implemented differently from the information last published in November 2018?</p>
<p>SoF IG version published 2018-Nov-13 based on FHIR version 3.0.1 does not give any consideration to the possibility that EHR Authz will use an authentication provider that does not expose refresh tokens.</p>
<p>"7.1.6 Step 5: (Later…) App uses a refresh token to obtain a new access token" assumes all EHRs will be capable of supplying a refresh_token in the token response.  Any EHR Authz server that uses MSAL <em>cannot</em> issue refresh tokens from Microsoft because MSAL no longer gives them.  This means it will not be possible to follow 7.1.4 SMART retrieval and refresh sequence <a href="https://www.hl7.org/fhir/smart-app-launch/#smart-retrieval-and-refresh-sequence">https://www.hl7.org/fhir/smart-app-launch/#smart-retrieval-and-refresh-sequence</a> because the refresh tokens are handled completely internally to MSAL used by the EHR Authz Server.</p>
<p>Can anyone give opinions/guidance on whether silent, implicit handling of refresh tokens is still compliant with SMART on FHIR?  Will SOF documentation ever be updated to describe authorization flows where refresh token lifecycle is handled by only the FHIR server but not the client?</p>
<p>Would the following alternative flow be acceptable when client will have only access tokens but will never have refresh tokens?</p>
<ul>
<li>Only the FHIR server will have refresh tokens.</li>
<li>When an access token expires, FHIR server will return not authorized response to the client app.</li>
<li>How can/should client request a new access token when client will never have a refresh token?</li>
<li>Can client POST to FHIR server token endpoint with grant_type=refresh_token&amp;refresh_token={expired access token} ? </li>
<li>FHIR server can validate the expired access token, confirm the internal refresh token life cycle time has not expired, use MSAL to get new access token, and return this new access token back to the client.</li>
</ul>



<a name="225735883"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179170-smart/topic/MSAL%20Hides%20Refresh%20Tokens/near/225735883" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Torin Shepard <a href="https://fhir.github.io/chat-archive/stream/179170-smart/topic/MSAL.20Hides.20Refresh.20Tokens.html#225735883">(Feb 09 2021 at 18:35)</a>:</h4>
<p><a href="https://github.com/AzureAD/microsoft-authentication-library-for-java/issues/228">https://github.com/AzureAD/microsoft-authentication-library-for-java/issues/228</a><br>
This posting suggests Microsoft made an intentional design decision to hide refresh tokens even though this decision contradicts the SoF protocol.</p>



<a name="225737190"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179170-smart/topic/MSAL%20Hides%20Refresh%20Tokens/near/225737190" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179170-smart/topic/MSAL.20Hides.20Refresh.20Tokens.html#225737190">(Feb 09 2021 at 18:43)</a>:</h4>
<p>I think this library wants to handle refresh tokens internally, rather than exposing them to the caller. That's not actually a SMART on FHIR protocol issue, so much as a library-internal design decision. But this library may not be a good choice for your needs.</p>



<a name="227354886"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179170-smart/topic/MSAL%20Hides%20Refresh%20Tokens/near/227354886" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Torin Shepard <a href="https://fhir.github.io/chat-archive/stream/179170-smart/topic/MSAL.20Hides.20Refresh.20Tokens.html#227354886">(Feb 22 2021 at 23:08)</a>:</h4>
<p>Thank you Josh!  After more investigation, we learned "ADAL to MSAL migration" at <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/migrate-adal-msal-java">https://docs.microsoft.com/en-us/azure/active-directory/develop/migrate-adal-msal-java</a> explains MSAL for Java has an API that allows migrating refresh tokens acquired with ADAL4J.  We also learned more about MSAL token cache and how it stores refresh tokens.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
