---
layout: page
title: "FHIR Chat  · Using SMART JS Client in express-based CDS Hooks Service · javascript"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179169-javascript/index.html">javascript</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179169-javascript/topic/Using.20SMART.20JS.20Client.20in.20express-based.20CDS.20Hooks.20Service.html">Using SMART JS Client in express-based CDS Hooks Service</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="237725938"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179169-javascript/topic/Using%20SMART%20JS%20Client%20in%20express-based%20CDS%20Hooks%20Service/near/237725938" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179169-javascript/topic/Using.20SMART.20JS.20Client.20in.20express-based.20CDS.20Hooks.20Service.html#237725938">(May 06 2021 at 20:48)</a>:</h4>
<p>I fear that this is a silly question and the answer is obvious, but... I have a Node.js Express based application that acts as a CDS Hooks service.  I'd like to use the <a href="https://docs.smarthealthit.org/client-js">SMART JS Client Library</a> to query the FHIR server using the <code>fhirServer</code> and <code>fhirAuthorization</code> details (particularly the <code>access_token</code>) passed in the CDS Hooks service call.  But it seems that the SMART library wants either no auth at all or the full SMART auth workflow.  I don't see a way to say "just use this token".  Am I missing something?  Or am I misguided in what I am trying to do?</p>



<a name="237727016"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179169-javascript/topic/Using%20SMART%20JS%20Client%20in%20express-based%20CDS%20Hooks%20Service/near/237727016" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179169-javascript/topic/Using.20SMART.20JS.20Client.20in.20express-based.20CDS.20Hooks.20Service.html#237727016">(May 06 2021 at 20:56)</a>:</h4>
<p><span class="user-mention" data-user-id="193731">@Vladimir Ignatov</span> is there a mechanism to just provide an access token to a client instance?</p>



<a name="237734707"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179169-javascript/topic/Using%20SMART%20JS%20Client%20in%20express-based%20CDS%20Hooks%20Service/near/237734707" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Ignatov <a href="https://fhir.github.io/chat-archive/stream/179169-javascript/topic/Using.20SMART.20JS.20Client.20in.20express-based.20CDS.20Hooks.20Service.html#237734707">(May 06 2021 at 21:37)</a>:</h4>
<p>There is no official mechanism for that but it might be possible (I have not tried it). Don't use the SMART API (authorize, ready or init). Just create a client instance directly and pass it's desired state. This is a complete example but may want to delete most of these properties (only <code>serverUrl</code> is  required). </p>
<div class="codehilite" data-code-language="JavaScript"><pre><span></span><code><span class="kd">const</span> <span class="nx">fhirclient</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"fhirclient"</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"/whatever, (req, res) =&gt; {</span>
<span class="s2">    const client = fhirclient(req, res).client({</span>
<span class="s2">        "</span><span class="nx">clientId</span><span class="s2">": "</span><span class="mf">3</span><span class="nx">ab1d54f</span><span class="o">-</span><span class="nx">b004</span><span class="o">-</span><span class="mf">48</span><span class="nx">fd</span><span class="o">-</span><span class="nx">a1b6</span><span class="o">-</span><span class="nx">eeae73d8858e</span><span class="s2">",</span>
<span class="s2">        "</span><span class="nx">scope</span><span class="s2">": "</span><span class="nx">launch</span> <span class="nx">openid</span> <span class="nx">fhirUser</span> <span class="nx">patient</span><span class="o">/*</span><span class="p">.</span><span class="nx">read</span> <span class="nx">offline_access</span><span class="s2">",</span>
<span class="s2">        "</span><span class="nx">redirectUri</span><span class="s2">": "</span><span class="nx">https</span><span class="o">:</span><span class="c1">//35u09.codesandbox.io/browser/ehr_launch/index.html",</span>
        <span class="s2">"serverUrl"</span><span class="o">:</span> <span class="s2">"https://launch.smarthealthit.org/v/r3/fhir"</span><span class="p">,</span>
        <span class="s2">"tokenResponse"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"need_patient_banner"</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="s2">"smart_style_url"</span><span class="o">:</span> <span class="s2">"https://launch.smarthealthit.org/smart-style.json"</span><span class="p">,</span>
            <span class="s2">"patient"</span><span class="o">:</span> <span class="s2">"67eba314-7595-431c-9d62-8d30e0bd76ac"</span><span class="p">,</span>
            <span class="s2">"encounter"</span><span class="o">:</span> <span class="s2">"e13a28cc-17ca-46ca-834e-917e4cd0a411"</span><span class="p">,</span>
            <span class="s2">"refresh_token"</span><span class="o">:</span> <span class="s2">"eyJ0eXAiOi..."</span><span class="p">,</span>
            <span class="s2">"token_type"</span><span class="o">:</span> <span class="s2">"bearer"</span><span class="p">,</span>
            <span class="s2">"scope"</span><span class="o">:</span> <span class="s2">"launch openid fhirUser patient/*.read offline_access"</span><span class="p">,</span>
            <span class="s2">"client_id"</span><span class="o">:</span> <span class="s2">"3ab1d54f-b004-48fd-a1b6-eeae73d8858e"</span><span class="p">,</span>
            <span class="s2">"expires_in"</span><span class="o">:</span> <span class="mf">3600</span><span class="p">,</span>
            <span class="s2">"id_token"</span><span class="o">:</span> <span class="s2">"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9..."</span><span class="p">,</span>
            <span class="s2">"access_token"</span><span class="o">:</span> <span class="s2">"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."</span>
        <span class="p">},</span>
        <span class="s2">"key"</span><span class="o">:</span> <span class="s2">"46xzy8p3niNqtAwl"</span><span class="p">,</span>
        <span class="s2">"registrationUri"</span><span class="o">:</span> <span class="s2">""</span><span class="p">,</span>
        <span class="s2">"authorizeUri"</span><span class="o">:</span> <span class="s2">"https://launch.smarthealthit.org/v/r3/auth/authorize"</span><span class="p">,</span>
        <span class="s2">"tokenUri"</span><span class="o">:</span> <span class="s2">"https://launch.smarthealthit.org/v/r3/auth/token"</span><span class="p">,</span>
        <span class="s2">"expiresAt"</span><span class="o">:</span> <span class="mf">1620338304</span>
    <span class="p">});</span>
    <span class="c1">// use client as you wish...</span>
<span class="p">})</span><span class="sb">```</span>
</code></pre></div>



<a name="237735295"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179169-javascript/topic/Using%20SMART%20JS%20Client%20in%20express-based%20CDS%20Hooks%20Service/near/237735295" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179169-javascript/topic/Using.20SMART.20JS.20Client.20in.20express-based.20CDS.20Hooks.20Service.html#237735295">(May 06 2021 at 21:43)</a>:</h4>
<p>I haven't used this in Node -- How are <code>(req, res)</code> used in the <code>fhirclient(req, res)</code> creation function?</p>



<a name="237741309"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179169-javascript/topic/Using%20SMART%20JS%20Client%20in%20express-based%20CDS%20Hooks%20Service/near/237741309" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Ignatov <a href="https://fhir.github.io/chat-archive/stream/179169-javascript/topic/Using.20SMART.20JS.20Client.20in.20express-based.20CDS.20Hooks.20Service.html#237741309">(May 06 2021 at 22:37)</a>:</h4>
<p>They provide some context (<a href="https://github.com/smart-on-fhir/client-js/blob/master/src/entry/node.ts">https://github.com/smart-on-fhir/client-js/blob/master/src/entry/node.ts</a>). An adapter for the current environment needs to be created first. In that case <a href="https://github.com/smart-on-fhir/client-js/blob/master/src/adapters/NodeAdapter.ts">https://github.com/smart-on-fhir/client-js/blob/master/src/adapters/NodeAdapter.ts</a>.</p>
<p>In browsers we have  things like <code>location</code>, <code>sessionStorage</code>, <code>btoa</code>, redirects... In node most of these are available through the current request and response objects. </p>
<p>Finally, adapters are mostly just collections of environment-specific methods implementing the interface at <a href="https://github.com/smart-on-fhir/client-js/blob/master/src/types.d.ts#L119-L175">https://github.com/smart-on-fhir/client-js/blob/master/src/types.d.ts#L119-L175</a>.</p>



<a name="237813960"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179169-javascript/topic/Using%20SMART%20JS%20Client%20in%20express-based%20CDS%20Hooks%20Service/near/237813960" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179169-javascript/topic/Using.20SMART.20JS.20Client.20in.20express-based.20CDS.20Hooks.20Service.html#237813960">(May 07 2021 at 12:28)</a>:</h4>
<p>Thank you <span class="user-mention" data-user-id="191315">@Josh Mandel</span> and <span class="user-mention" data-user-id="193731">@Vladimir Ignatov</span>.  I've now tested this out with my CDS Service and the Logica Sandbox -- and it works!  Here's the relevant code snippet, trimmed down to just those properties that a CDS Hooks client provides.  In this cas <code>req</code> is the incoming CDS Hooks call from the CDS Hooks client:</p>
<div class="codehilite" data-code-language="JavaScript"><pre><span></span><code><span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">fhirServer</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">serverUrl</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">fhirServer</span><span class="p">,</span>
  <span class="p">};</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">fhirAuthorization</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">auth</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">fhirAuthorization</span><span class="p">;</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">clientId</span><span class="o">:</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">subject</span><span class="p">,</span>
      <span class="nx">scope</span><span class="o">:</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">scope</span><span class="p">,</span>
      <span class="nx">tokenResponse</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">token_type</span><span class="o">:</span> <span class="s1">'bearer'</span><span class="p">,</span>
        <span class="nx">scope</span><span class="o">:</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">scope</span><span class="p">,</span>
        <span class="nx">client_id</span><span class="o">:</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">subject</span><span class="p">,</span>
        <span class="nx">expires_in</span><span class="o">:</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">expires_in</span><span class="p">,</span>
        <span class="nx">access_token</span><span class="o">:</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">access_token</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="kd">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">fhirclient</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">).</span><span class="nx">client</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
  <span class="c1">// do stuff with the client</span>
<span class="p">}</span>
</code></pre></div>
<p>I also had the same question as Josh, so thank you, Valdimir, for the explanation regarding why <code>(req, res)</code> is needed.  That makes sense!</p>



<a name="237815256"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179169-javascript/topic/Using%20SMART%20JS%20Client%20in%20express-based%20CDS%20Hooks%20Service/near/237815256" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179169-javascript/topic/Using.20SMART.20JS.20Client.20in.20express-based.20CDS.20Hooks.20Service.html#237815256">(May 07 2021 at 12:38)</a>:</h4>
<p>I'll say that API-contract-wise, it's surprising to have to give a FHIR client access to an incoming API request and response. Does this imply that I couldn't use the client library from a "plain old" node CLI app that wasn't itself an http server?</p>



<a name="239426059"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179169-javascript/topic/Using%20SMART%20JS%20Client%20in%20express-based%20CDS%20Hooks%20Service/near/239426059" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Ignatov <a href="https://fhir.github.io/chat-archive/stream/179169-javascript/topic/Using.20SMART.20JS.20Client.20in.20express-based.20CDS.20Hooks.20Service.html#239426059">(May 19 2021 at 13:43)</a>:</h4>
<p>Yes, it is a little weird, but so would be trying to do oAuth in CLI. That said, it is possible to use it as a FHIR client only. I'm doing that a lot for testing but I don't consider it  a viable use case otherwise, thus it is not that user friendly.  Under the hood <code>fhirclient(req, res).client(options)</code> does something like: <code>new Client(new NodeAdapter(req, res), options)</code> so the customized version may look like:</p>
<div class="codehilite" data-code-language="TypeScript"><pre><span></span><code><span class="k">import</span> <span class="nx">Client</span> <span class="k">from</span> <span class="s2">"fhirclient/lib/client"</span>
<span class="k">import</span> <span class="nx">CLIAdapter</span> <span class="k">from</span> <span class="s2">"./somewhere/MyAdapter"</span>

<span class="kd">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">(</span><span class="k">new</span> <span class="nx">CLIAdapter</span><span class="p">(),</span> <span class="nx">options</span><span class="p">)</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="s2">"Patient"</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">,</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span>
</code></pre></div>
<p><span class="user-mention" data-user-id="191315">@Josh Mandel</span> Do you think that now (thanks to bulk data) FHIR servers are going to support backend services auth for SMART on FHIR. If that is the case it would be worth considering further updates like backend services support, out of the box CLI adapter and probably better API for non-server node environments.</p>



<a name="239426873"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179169-javascript/topic/Using%20SMART%20JS%20Client%20in%20express-based%20CDS%20Hooks%20Service/near/239426873" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Moesel <a href="https://fhir.github.io/chat-archive/stream/179169-javascript/topic/Using.20SMART.20JS.20Client.20in.20express-based.20CDS.20Hooks.20Service.html#239426873">(May 19 2021 at 13:48)</a>:</h4>
<p>FWIW, I find the features like auto-paging, flattening, etc, useful -- which is why I wanted to use it in a non-SMART app.  I just didn't want to roll my own page aggregation, etc, when someone else has already implemented it well.  Would you recommend some other library for that purpose?</p>



<a name="239426986"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179169-javascript/topic/Using%20SMART%20JS%20Client%20in%20express-based%20CDS%20Hooks%20Service/near/239426986" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179169-javascript/topic/Using.20SMART.20JS.20Client.20in.20express-based.20CDS.20Hooks.20Service.html#239426986">(May 19 2021 at 13:48)</a>:</h4>
<p>Thanks for this snippet! In general yes I think we will see more use of backend Services which will be associated with command line applications; I think we will also see continued interest in flexibility here, so being able to simply pass in an access token and an fhir endpoint it is a pretty nice pattern. We might also want to think about something like a "header generation callback", so you could instantiate a client that sends out requests but before each request the registered header generation function has a chance to inspect the request and generate additional headers; this is the useful for other authorizations scenarios (e.g., experiments with DPOP).</p>



<a name="239427223"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179169-javascript/topic/Using%20SMART%20JS%20Client%20in%20express-based%20CDS%20Hooks%20Service/near/239427223" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179169-javascript/topic/Using.20SMART.20JS.20Client.20in.20express-based.20CDS.20Hooks.20Service.html#239427223">(May 19 2021 at 13:50)</a>:</h4>
<p>To Chris's point: indeed, I would think about making this library as useful as possible for developers connecting to any FHIR servers (SMART and otherwise).</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
