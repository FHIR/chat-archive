---
layout: page
title: "FHIR Chat  · Apache Drill · analytics on FHIR"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179219-analytics-on-FHIR/index.html">analytics on FHIR</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179219-analytics-on-FHIR/topic/Apache.20Drill.html">Apache Drill</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="153886445"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179219-analytics%20on%20FHIR/topic/Apache%20Drill/near/153886445" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fahim Shariar <a href="https://fhir.github.io/chat-archive/stream/179219-analytics-on-FHIR/topic/Apache.20Drill.html#153886445">(Apr 28 2017 at 22:12)</a>:</h4>
<p>Apache Drill – Direct Clinical BI on FHIR , seems like an interesting project . <br>
At the end of this page http:/amia.analystseim.com/ <br>
There is a query for Patient's family name, gender, birth date: <br>
<code>SELECT P.'name'[0].family AS family_name, P.gender, P.birthDate FROM dfs.'/synthea/json/patient' P LIMIT 10</code><br>
So will it be used just to implement FHIR search parameter ? Confused about the Analytics part on that ...</p>



<a name="153886483"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179219-analytics%20on%20FHIR/topic/Apache%20Drill/near/153886483" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> natus <a href="https://fhir.github.io/chat-archive/stream/179219-analytics-on-FHIR/topic/Apache.20Drill.html#153886483">(Apr 30 2017 at 07:08)</a>:</h4>
<p>Use case with SQL tools such apache drill are:<br>
- search in the dataset, say build a cohort<br>
- BI, allow explore the data aggregate result, tables, plots<br>
- apply any FHIR tool over the ressources, data visualization...</p>
<p>all would benefit from a common data model</p>



<a name="153886484"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179219-analytics%20on%20FHIR/topic/Apache%20Drill/near/153886484" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> natus <a href="https://fhir.github.io/chat-archive/stream/179219-analytics-on-FHIR/topic/Apache.20Drill.html#153886484">(Apr 30 2017 at 07:18)</a>:</h4>
<p>The project you pointed (<a href="http://amia.analystseim.com/guide.html" target="_blank" title="http://amia.analystseim.com/guide.html">http://amia.analystseim.com/guide.html</a>) does not satisfy FHIR specification:</p>
<blockquote>
<p>References and JOIN<br>
FHIR reference are formatted as ResourceType/id, e.g. Patient/1234. This means that &gt;to link an Encounter to the associated patient, one must join:<br>
Encounter.patient.reference to 'Patient/' || <a href="http://Patient.id" target="_blank" title="http://Patient.id">Patient.id</a><br>
Possible, but slow. To speed things, in the parquet files we've added:<br>
Patient.patient_reference<br>
Encounter.encounter_reference</p>
</blockquote>
<p>Then, they added encounter_reference element in the Encounter resource and so on<br>
To me, this is a problem. Any better idea "FHIR compatible" to deal with that ?</p>



<a name="153886502"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179219-analytics%20on%20FHIR/topic/Apache%20Drill/near/153886502" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179219-analytics-on-FHIR/topic/Apache.20Drill.html#153886502">(May 01 2017 at 01:19)</a>:</h4>
<p><span class="user-mention" data-user-id="191351">@Chris Grenz</span> is best to comment about this</p>



<a name="153886506"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179219-analytics%20on%20FHIR/topic/Apache%20Drill/near/153886506" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Grenz <a href="https://fhir.github.io/chat-archive/stream/179219-analytics-on-FHIR/topic/Apache.20Drill.html#153886506">(May 01 2017 at 03:18)</a>:</h4>
<p>There's no requirement to optimize the references - as I mentioned one could add the concatenation in the query's join condition directly. </p>



<a name="153886507"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179219-analytics%20on%20FHIR/topic/Apache%20Drill/near/153886507" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Grenz <a href="https://fhir.github.io/chat-archive/stream/179219-analytics-on-FHIR/topic/Apache.20Drill.html#153886507">(May 01 2017 at 03:21)</a>:</h4>
<p>In practice, we generally use Drill to create optimized intermediate sets from the native FHIR datasets. If that's not acceptable in your use case, additional processing power could be brought to bear.</p>



<a name="153886508"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179219-analytics%20on%20FHIR/topic/Apache%20Drill/near/153886508" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Grenz <a href="https://fhir.github.io/chat-archive/stream/179219-analytics-on-FHIR/topic/Apache.20Drill.html#153886508">(May 01 2017 at 03:22)</a>:</h4>
<p><span class="user-mention" data-user-id="193690">@Fahim Shariar</span> - "analytics" comes with significantly more complex queries. Baby steps! </p>



<a name="153886544"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179219-analytics%20on%20FHIR/topic/Apache%20Drill/near/153886544" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> natus <a href="https://fhir.github.io/chat-archive/stream/179219-analytics-on-FHIR/topic/Apache.20Drill.html#153886544">(May 01 2017 at 09:21)</a>:</h4>
<blockquote>
<p>There's no requirement to optimize the references - as I mentioned one could add the concatenation in the query's join condition directly.</p>
</blockquote>
<p>Our requirement is to help drill users to join tables. Concatenation leads to errors when the reference is subject (Patient or Group) such encounter. Moreover this leads to overhead of scripting, and hardware consumption. <br>
The workaround of using new elements such "patient.patient_refereence" is great but sadly resources are not FHIR compatible anymore.<br>
What about adding extension for this purpose? eg :</p>
<blockquote>
<p>"extension": [<br>
   {<br>
    "url": "<a href="http://example/patient_id/" target="_blank" title="http://example/patient_id/">http://example/patient_id/</a>",<br>
    "valueid": 16624 <br>
   }<br>
   ]</p>
</blockquote>



<a name="153886553"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179219-analytics%20on%20FHIR/topic/Apache%20Drill/near/153886553" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Grenz <a href="https://fhir.github.io/chat-archive/stream/179219-analytics-on-FHIR/topic/Apache.20Drill.html#153886553">(May 01 2017 at 12:58)</a>:</h4>
<p>Unfortunately that just moves the complexity around.  Most resources won't include that extension, so you'd have to pre-process the data to ensure consistent inclusion, a much more complex (though very possible) process on a large set.<br>
Concatenation can work without error - the concatenation happens on the "target" side, not the "referencing" side:<br>
<code>X.ResourceName || '/' || X.id AS ResourceRelativeURI</code><br>
If multiple resources are possible in the reference, either you must make two (or more) outer joins, or you access all resources in the same scope.</p>



<a name="153886556"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179219-analytics%20on%20FHIR/topic/Apache%20Drill/near/153886556" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> natus <a href="https://fhir.github.io/chat-archive/stream/179219-analytics-on-FHIR/topic/Apache.20Drill.html#153886556">(May 01 2017 at 14:31)</a>:</h4>
<p>You are right, using the concatenation just works.  But it decreases DRILL performances (I am talking about FHIR datasets with multiple billion of observations ) a lot comparing to both methods:<br>
1) adding a new element as you(?) have made and described there <a href="http://amia.analystseim.com/guide.html" target="_blank" title="http://amia.analystseim.com/guide.html">http://amia.analystseim.com/guide.html</a> . But this is not FHIR compatible.<br>
2) adding an extension as I described in this thread. This is FHIR compatible.</p>
<blockquote></blockquote>
<p>By FHIR compatible I mean resources can be pushed in any FHIR tool, such vizualisation, validation and more. Both methods need a pre-processing step. At least moving json files into parquet is  a pre-processing step. So while transforming into parquet format one can add those extensions. And the dataset is still FHIR compatible. Does this  make sense ? </p>



<a name="153886592"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179219-analytics%20on%20FHIR/topic/Apache%20Drill/near/153886592" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fahim Shariar <a href="https://fhir.github.io/chat-archive/stream/179219-analytics-on-FHIR/topic/Apache.20Drill.html#153886592">(May 01 2017 at 21:03)</a>:</h4>
<p><code>SELECT COUNT(*) FROM dfs.pq.'Condition' WHERE 'Condition'.'code'.coding[0].'code' = '44054006'</code> that just caught my attention . Are you assuming there will only be just one Code in the whole CodableConcept array . There could be multiple , right ? what about that ? <br>
<span class="user-mention" data-user-id="193729">@natus</span>  does Drill SQL query supports quering JSON arrays ?</p>



<a name="153886593"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179219-analytics%20on%20FHIR/topic/Apache%20Drill/near/153886593" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grahame Grieve <a href="https://fhir.github.io/chat-archive/stream/179219-analytics-on-FHIR/topic/Apache.20Drill.html#153886593">(May 01 2017 at 21:03)</a>:</h4>
<p>in RDF, there's a special relationship for this purpose </p>



<a name="153886622"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179219-analytics%20on%20FHIR/topic/Apache%20Drill/near/153886622" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> natus <a href="https://fhir.github.io/chat-archive/stream/179219-analytics-on-FHIR/topic/Apache.20Drill.html#153886622">(May 01 2017 at 22:05)</a>:</h4>
<p><span class="user-mention" data-user-id="193690">@Fahim Shariar</span>  I guess so :  the drill function flatten does the job in case of array (<a href="https://drill.apache.org/docs/flatten/" target="_blank" title="https://drill.apache.org/docs/flatten/">https://drill.apache.org/docs/flatten/</a>)</p>
<blockquote>
<p>SELECT <a href="http://d.id" target="_blank" title="http://d.id">d.id</a> FROM (SELECT *, flatten(C.<code>code</code>.<code>coding</code>) f FROM <code>condition.json</code> C) d WHERE d.<code>f</code>.<code>code</code> = '44054006';</p>
</blockquote>
<p>would match a condition that would have many code (tested and approved)</p>



<a name="153887452"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179219-analytics%20on%20FHIR/topic/Apache%20Drill/near/153887452" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Grenz <a href="https://fhir.github.io/chat-archive/stream/179219-analytics-on-FHIR/topic/Apache.20Drill.html#153887452">(May 06 2017 at 08:29)</a>:</h4>
<p>Anyone interested in playing with Drill can use the demo environment for the FHIR Connectathon for the next 48 hours.  Setup instructions here:  <a href="http://amia.analystseim.com/setup.html" target="_blank" title="http://amia.analystseim.com/setup.html">http://amia.analystseim.com/setup.html</a></p>



<a name="153887703"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179219-analytics%20on%20FHIR/topic/Apache%20Drill/near/153887703" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> natus <a href="https://fhir.github.io/chat-archive/stream/179219-analytics-on-FHIR/topic/Apache.20Drill.html#153887703">(May 06 2017 at 18:47)</a>:</h4>
<p>Hi Chris,<br>
THis works out of the box. What is your drillbit platform configuration ?  5 nodes cluster ?<br>
Thanks</p>



<a name="153888023"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179219-analytics%20on%20FHIR/topic/Apache%20Drill/near/153888023" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Grenz <a href="https://fhir.github.io/chat-archive/stream/179219-analytics-on-FHIR/topic/Apache.20Drill.html#153888023">(May 07 2017 at 11:46)</a>:</h4>
<p>6 nodes, m4.4xlarge on AWS EC2.</p>



<a name="153888047"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179219-analytics%20on%20FHIR/topic/Apache%20Drill/near/153888047" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> natus <a href="https://fhir.github.io/chat-archive/stream/179219-analytics-on-FHIR/topic/Apache.20Drill.html#153888047">(May 07 2017 at 14:22)</a>:</h4>
<p>I have made some tests about the references.</p>
<blockquote>
<p>SELECT count(1)<br>
FROM dfs.pq.<code>Patient</code> P<br>
JOIN dfs.pq.<code>Encounter</code> E ON (P.resourceType || '/' || <a href="http://P.id" target="_blank" title="http://P.id">P.id</a> = E.patient.reference);</p>
</blockquote>
<p>First of all, there is no performance impact when using the <code>P.patient_reference = E.patient.reference</code> or <code>ON (P.resourceType || '/' || P.ide = E.patient.reference)</code> .  Result is between 16 and 20 seconds in each way.</p>
<p>Then the only advantage to add the patient_reference = 'Patient/0001' element is a syntactic sugar. </p>
<blockquote></blockquote>
<p>BTW, sadly the id regex definition is [A-Za-z0-9\-\.]{1,64} (from  <a href="https://www.hl7.org/fhir/datatypes.html#id" target="_blank" title="https://www.hl7.org/fhir/datatypes.html#id">https://www.hl7.org/fhir/datatypes.html#id</a>) . It does not allows assigning <a href="http://Patient.id" target="_blank" title="http://Patient.id">Patient.id</a> = 'Patient/001' . This would be great to extend id definition to  [A-Za-z0-9\-\.<strong>\/</strong>]{1,64}<br>
Allowing slash in id regex  would allow native easy join writing :  <code>P.id = E.patient.reference</code></p>



<a name="153888053"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179219-analytics%20on%20FHIR/topic/Apache%20Drill/near/153888053" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nicola (RIO/SS) <a href="https://fhir.github.io/chat-archive/stream/179219-analytics-on-FHIR/topic/Apache.20Drill.html#153888053">(May 07 2017 at 15:06)</a>:</h4>
<p>No performance penalty for Drill until it will get some indexes functionality  :)</p>



<a name="153888061"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179219-analytics%20on%20FHIR/topic/Apache%20Drill/near/153888061" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> natus <a href="https://fhir.github.io/chat-archive/stream/179219-analytics-on-FHIR/topic/Apache.20Drill.html#153888061">(May 07 2017 at 17:31)</a>:</h4>
<p>This is sadly true</p>
<blockquote></blockquote>
<p>In the meantime, if one want to join resources in any system, integers (1999) is the most effective way. (compared to string version "Patient/1999"). So your FHIR not friendly method is better (I mean adding to Encounter a patient element such `P.id = <a href="http://E.patient.id" target="_blank" title="http://E.patient.id">E.patient.id</a> ̀ is the join method).</p>



<a name="153889821"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179219-analytics%20on%20FHIR/topic/Apache%20Drill/near/153889821" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fahim Shariar <a href="https://fhir.github.io/chat-archive/stream/179219-analytics-on-FHIR/topic/Apache.20Drill.html#153889821">(May 13 2017 at 12:50)</a>:</h4>
<p><span class="user-mention" data-user-email="niparisco@gmail.com" data-user-id="2424">@natus</span> Can you write in sentence what are you trying to achieve that you wrote via Query . I can guess something like , Count number of encounter that every patient has ? and you said that "Result is between 16 and 20 seconds in each way." is it the query runtime ? and what the total number of records that you are joining and searching ? <br>
It will be helpful if you provide some information about the dataset and your progress :)</p>



<a name="153889831"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179219-analytics%20on%20FHIR/topic/Apache%20Drill/near/153889831" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> natus <a href="https://fhir.github.io/chat-archive/stream/179219-analytics-on-FHIR/topic/Apache.20Drill.html#153889831">(May 13 2017 at 20:53)</a>:</h4>
<p>I was testing the dataset provided by the fhir hackaton analytics. The query was a simple test of join performances. I cannot remember exactly the resulting number of rows, but more than 10 milions. Conclusion was performances are definitively good with FHIR native model.</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
