---
layout: page
title: "FHIR Chat  · .NET JSON Serialization Performance · dotnet"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/index.html">dotnet</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html">.NET JSON Serialization Performance</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="204100708"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/204100708" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis Gordon <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#204100708">(Jul 16 2020 at 15:34)</a>:</h4>
<p>I noticed it takes a second the first time I serialize a bundle to JSON, no matter the method via FhirJsonSerializer.  Wondered if anybody has seen this prior and ways to help avoid that first time cost. Haven't profiled yet to see what's going on.</p>



<a name="204104118"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/204104118" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis Gordon <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#204104118">(Jul 16 2020 at 15:57)</a>:</h4>
<p>ex: <br>
        [TestMethod()]<br>
        public void JsonSerialization_TestEmptyBundle()<br>
        {<br>
            //arrange<br>
            var bundle = new Bundle();<br>
            var jsonSerializer = new Hl7.Fhir.Serialization.FhirJsonSerializer();</p>
<div class="codehilite"><pre><span></span><code>        //act
        var watch = Stopwatch.StartNew();
        var resourceStr = jsonSerializer.SerializeToString(bundle);
        watch.Stop();

        //assert
        Assert.IsTrue(true, $&quot;{watch.ElapsedMilliseconds}&quot;);
    }
</code></pre></div>



<a name="204107619"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/204107619" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michele Mottini <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#204107619">(Jul 16 2020 at 16:23)</a>:</h4>
<p>The first time it has to generate a whole lot of data - basically a complete description of all the classes - and that takes time</p>



<a name="204404942"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/204404942" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#204404942">(Jul 20 2020 at 10:04)</a>:</h4>
<p>That's right - I am working on speeding things up, but there's a lot of reflection going on initially before you can serialize.  More or less that same thing going on when using .NET's BinarySerializer.</p>



<a name="208476150"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/208476150" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#208476150">(Aug 30 2020 at 09:13)</a>:</h4>
<p>I'm wondering if the latest versions on the xml serializer are performing as well?<br>
I've started experimenting in a pre-generated serializer that has none of these drawbacks (but is version specific) and the speed and simplicity is far better.</p>



<a name="208476158"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/208476158" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#208476158">(Aug 30 2020 at 09:13)</a>:</h4>
<p>Once it's a little more accurate will start measuring them apples to apples.</p>



<a name="208476162"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/208476162" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#208476162">(Aug 30 2020 at 09:13)</a>:</h4>
<p>Anyone else tried this, or even thought about it?</p>



<a name="208476203"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/208476203" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#208476203">(Aug 30 2020 at 09:14)</a>:</h4>
<p>Oh size of the serialization assembly is about 260kb</p>



<a name="208547847"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/208547847" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michele Mottini <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#208547847">(Aug 31 2020 at 12:04)</a>:</h4>
<p>Yes, we implemented a pre-generated serializer (both JSON and XML) in our fork. It is &gt; 10 times faster than the current one and it does not require all that initial reflection time</p>



<a name="208620025"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/208620025" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#208620025">(Aug 31 2020 at 21:53)</a>:</h4>
<p>Thanks, can you point me to your fork?<br>
That's about the same factor that I'm seeing too.</p>



<a name="208624895"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/208624895" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michele Mottini <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#208624895">(Aug 31 2020 at 22:46)</a>:</h4>
<p><a href="https://github.com/CareEvolution/fhir-net-api/commit/bdb76e6388920e0f6b0a988140f8c582a65fbb7c">https://github.com/CareEvolution/fhir-net-api/commit/bdb76e6388920e0f6b0a988140f8c582a65fbb7c</a></p>



<a name="208663095"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/208663095" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#208663095">(Sep 01 2020 at 09:21)</a>:</h4>
<p>Thanks</p>



<a name="209285155"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/209285155" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#209285155">(Sep 07 2020 at 11:29)</a>:</h4>
<p>We actually had generated C# serializers back in the days when we generated the C# library using Java.  That was painful, writing and debugging java, then running it, taking the C#, hoping it would compile.  If it did, parse and serialize and then debugging. And that over and over again.  At some point I figured I could make it work with 1 single reusable component hahaha.</p>
<p>But sure, certainly with <span class="user-mention" data-user-id="222054">@Gino Canessa</span> 's generator framework, we'd also have a nice basis to re-introduce this.  For the 2.0 version of the API, we switched to code generation based on that framework (<a href="https://github.com/microsoft/fhir-codegen">https://github.com/microsoft/fhir-codegen</a>), so it would be possible to integrate everything into the API build process....</p>



<a name="210362850"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210362850" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210362850">(Sep 17 2020 at 08:46)</a>:</h4>
<p><span class="user-mention" data-user-id="191912">@Michele Mottini</span> , did you do a streaming parser too, or just the serializer?</p>



<a name="210384669"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210384669" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michele Mottini <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210384669">(Sep 17 2020 at 12:56)</a>:</h4>
<p>Just the serializer. Parser is considerably more difficult (we had a stab at it nut dropped for the moment being)</p>



<a name="210411293"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210411293" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210411293">(Sep 17 2020 at 16:03)</a>:</h4>
<p>Just for awareness, I'm tinkering with this when I need a break from meetings/documentation too.<br>
Edit: nothing to post yet, will update if/when it gets that far.</p>



<a name="210456040"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210456040" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210456040">(Sep 17 2020 at 21:50)</a>:</h4>
<p>I've now got the xml side done. And up to testing stage.</p>



<a name="210456413"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210456413" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210456413">(Sep 17 2020 at 21:54)</a>:</h4>
<p>Nice!  I'm working on testing System.Text.Json for the json side right now (almost have parsing working so that I can test performance).</p>



<a name="210457984"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210457984" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210457984">(Sep 17 2020 at 22:12)</a>:</h4>
<p>Will be interested to compare...<br>
<a href="https://github.com/brianpos/fhir-net-web-api/commit/edef9d2097336da71af687aeb9098747ead7a253">https://github.com/brianpos/fhir-net-web-api/commit/edef9d2097336da71af687aeb9098747ead7a253</a></p>



<a name="210458062"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210458062" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210458062">(Sep 17 2020 at 22:13)</a>:</h4>
<p><a href="/user_uploads/10155/p_axSYxog77n00kc8MHnDAtU/image.png">image.png</a> <br>
10,000 resources parsed/serialized</p>
<div class="message_inline_image"><a href="/user_uploads/10155/p_axSYxog77n00kc8MHnDAtU/image.png" title="image.png"><img src="/user_uploads/10155/p_axSYxog77n00kc8MHnDAtU/image.png"></a></div>



<a name="210458137"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210458137" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210458137">(Sep 17 2020 at 22:14)</a>:</h4>
<p>Gino, is that code you are pushing to github?<br>
I'd love to get that into the same tree.</p>



<a name="210458360"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210458360" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210458360">(Sep 17 2020 at 22:17)</a>:</h4>
<p>Right now I'm just testing locally.  I'm figuring out the shape of what I need to put in the codegen so that it gets added to the generated content automatically.</p>



<a name="210458399"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210458399" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210458399">(Sep 17 2020 at 22:18)</a>:</h4>
<p>If you've got the shape, I can push it into this code gen and you'll have both <span aria-label="wink" class="emoji emoji-1f609" role="img" title="wink">:wink:</span></p>



<a name="210458465"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210458465" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210458465">(Sep 17 2020 at 22:18)</a>:</h4>
<p>It's a bit slow going since I haven't done all the custom stuff with System.Text.Json before, but it's <em>supposedly</em> faster and the future... I should (hopefully) have a comparison to newtonsoft in not too long</p>



<a name="210458562"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210458562" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210458562">(Sep 17 2020 at 22:19)</a>:</h4>
<p>It'll all be pushed when it's working, but I'm using <a href="https://github.com/microsoft/fhir-codegen">fhir-codegen</a> instead of the TT templates.</p>



<a name="210458634"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210458634" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210458634">(Sep 17 2020 at 22:20)</a>:</h4>
<p>No dramas.</p>



<a name="210459010"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210459010" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210459010">(Sep 17 2020 at 22:25)</a>:</h4>
<p>For curiosity, what are you using for the performance testing?</p>



<a name="210459197"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210459197" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210459197">(Sep 17 2020 at 22:28)</a>:</h4>
<p>Nothing special yet, just the unit tests in a loop.<br>
<a href="https://github.com/brianpos/fhir-net-web-api/blob/edef9d2097336da71af687aeb9098747ead7a253/src/Test.WebApi.AspNetCore/CustomSerializers.cs#L75">https://github.com/brianpos/fhir-net-web-api/blob/edef9d2097336da71af687aeb9098747ead7a253/src/Test.WebApi.AspNetCore/CustomSerializers.cs#L75</a><br>
Next step is to grab the all examples unit test from the core spec and use those in direct comparison and also for accuracy to compare them to eachother.</p>



<a name="210459262"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210459262" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210459262">(Sep 17 2020 at 22:29)</a>:</h4>
<p>doing scale of 10k means that even the startup time for the parsing of the reflection etc blends away</p>



<a name="210459332"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210459332" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210459332">(Sep 17 2020 at 22:30)</a>:</h4>
<p>Also, the memory overhead between the parsers is 30MB vs 70MB (just looking at the unit test debugger memory usage results)</p>



<a name="210459589"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210459589" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210459589">(Sep 17 2020 at 22:33)</a>:</h4>
<p>Thanks.  I have a little playground app (doing the same type of thing) but was thinking of trying to make my tests consistent with yours while I'm tinkering (for frame of reference)</p>



<a name="210462001"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210462001" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210462001">(Sep 17 2020 at 23:04)</a>:</h4>
<p>Will update you when I get the all examples test in there too.<br>
As you can use it to cross reference against the core one for accuracy.</p>



<a name="210465958"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210465958" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210465958">(Sep 18 2020 at 00:03)</a>:</h4>
<p>Got the parser working in a test environment (custom Pocos, not the standard ones yet), but results look promising (10,000 loops of parsing Patient-example.json from memory):</p>
<div class="codehilite"><pre><span></span><code>Results of file: Patient-example.json, 3909 bytes
FHIR Net API, R4: 1.9.0.0:
       Setup: 0s
 First Parse: 1.138s
Looped Parse: 7.57s (avg: 0.000757)

Results of file: Patient-example.json, 3909 bytes
CSharpBasic-Newtonsoft:
       Setup: 0s
 First Parse: 0.171s
Looped Parse: 1.18s (avg: 0.000118)

Results of file: Patient-example.json, 3909 bytes
CSharpBasic-SystemTextJson:
       Setup: 0s
 First Parse: 0.039s
Looped Parse: 0.367s (avg: 3.67E-05)
</code></pre></div>


<p>I'll note that neither 'Setup' nor 'First Parse' times are included in the loops (I list them for reference, but don't want to throw off the averages).</p>
<p>I'm going to figure out the serialization piece next, then port them from the 'basic' pocos over to the Firely models.</p>



<a name="210468119"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210468119" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210468119">(Sep 18 2020 at 00:40)</a>:</h4>
<p>So that's looking pretty good then!</p>



<a name="210468233"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210468233" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210468233">(Sep 18 2020 at 00:42)</a>:</h4>
<p>I think I'll definitely be doing that SystemTextJson thing, can't wait to see your generated code...</p>



<a name="210472397"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210472397" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210472397">(Sep 18 2020 at 02:07)</a>:</h4>
<p>Yeah, there will be a penalty for creating the more complex objects, but I'm excited to see where it ends up.</p>



<a name="210790898"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210790898" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210790898">(Sep 21 2020 at 19:51)</a>:</h4>
<p>Would be cool to integrate it in such a way into the existing parser framework that we can run the generated stuff for known resources, and reflection-based code for custom resources.</p>



<a name="210790922"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210790922" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210790922">(Sep 21 2020 at 19:51)</a>:</h4>
<p>Maybe the generated parsers can register themselves in some way?</p>



<a name="210791715"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/210791715" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#210791715">(Sep 21 2020 at 19:59)</a>:</h4>
<p>Yeah, I'm still playing with the shape based on the Basic language Poco's right now(different annotation styles, etc.)... trying to get everything both correct and 'nice'.  Once I'm confident I have something that works well, I'll look at how to mirror in the Firely classes and post something as a starting point to review/play with on GH.</p>



<a name="211555052"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/211555052" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#211555052">(Sep 28 2020 at 21:51)</a>:</h4>
<p>Ok, have a pass of everything working with basic Poco's for testing.  The exported R4 files are on <a href="https://github.com/microsoft/fhir-codegen/tree/dev/test/perfTestCS/Test">GitHub</a>.  I tested round-tripping various files from the R4 examples and everything appears to work fine.</p>
<p>These are bare-bones objects, which obviously do not do the validation that the standard library does, so the performance delta won't be quite as high.</p>
<p>That said, the parser runs about 7x (Bundle-resources.json) to 21x (Patient-example.json) faster.  Initial parse time is slightly penalized (loading memory), but tends to range from 10ms to 100ms on my box.</p>
<p>So.. questions/notes:</p>
<ul>
<li>The best performance came from complete custom serializers / parsers on each object, but this adds a fair bit of code and compile time.  There's still a good gain from adding annotations directly to each field and letting the serializer/parser figure it out, but the difference was pretty significant..  I am inclined to add in the additional code, but would like other people's opinions.</li>
<li>I haven't gone through the reflection code (or indeed anything around custom resources) - would the preferred outcome be to enable reflection, or to enable export of the same files?  (e.g., loading the custom resource exports identical files as the core resources)</li>
<li>Should I be testing in <code>CSharpFirely2</code>, or does this need to be applied to version 1 as well?</li>
</ul>
<p>Thanks!</p>



<a name="211559197"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/211559197" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michele Mottini <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#211559197">(Sep 28 2020 at 22:35)</a>:</h4>
<p>Why are the reader and writer <code>ref</code> ?</p>



<a name="211559228"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/211559228" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michele Mottini <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#211559228">(Sep 28 2020 at 22:35)</a>:</h4>
<p>We'll try to use this in our fork, thanks!</p>



<a name="211562580"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/211562580" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#211562580">(Sep 28 2020 at 23:15)</a>:</h4>
<p>Those Serializer routines, is there actually a need for them to be inside the class, or even have the attributes?<br>
It's really just the Converter registration that needs to be done isn't it, along with the class?<br>
Won't be able to look into it today, but will try get to it later in the week.<br>
Great stuff!</p>



<a name="211566401"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/211566401" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vassil Peytchev <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#211566401">(Sep 29 2020 at 00:04)</a>:</h4>
<p>A bit tangential, but RC1 of .NET 5 apparently has some improvements to JSON handling, and a new <code>record</code> datatype. Has anyone looked at how that may impact the .NET reference implementation (if at all)?</p>



<a name="211570078"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/211570078" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#211570078">(Sep 29 2020 at 01:03)</a>:</h4>
<p>I don't remember when I started tagging them <code>ref</code>, I'll see if they need to be.</p>



<a name="211570155"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/211570155" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#211570155">(Sep 29 2020 at 01:04)</a>:</h4>
<p>I'm planning generating output compatible with the FHIR Net APIs directly - these are using some primitive POCO's so that I could make sure everything actually works as advertised.</p>



<a name="211570509"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/211570509" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#211570509">(Sep 29 2020 at 01:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="191367">Brian Postlethwaite</span> <a href="#narrow/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance/near/211562580">said</a>:</p>
<blockquote>
<p>Those Serializer routines, is there actually a need for them to be inside the class, or even have the attributes?<br>
It's really just the Converter registration that needs to be done isn't it, along with the class?<br>
Won't be able to look into it today, but will try get to it later in the week.<br>
Great stuff!</p>
</blockquote>
<p>The <code>JsonConverter</code> decoration allows use of the standard System.Text.Json routines on any resource or component.  The only downside is that you want a couple of options for expected behavior, and the current version does not allow for defaults (hence the <code>Serialization.FhirSerializerOptions</code> class).</p>
<p>You don't need the decorations if you manually apply the converters to the options, but then anyone who <em>doesn't</em> apply those converters get incorrect behavior.</p>
<p>There's no need for them to be in the classes, it just lined up with the models.  I had static functions on each class at one point, but the traversal code was (IMHO) ugly.</p>



<a name="211570823"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/211570823" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#211570823">(Sep 29 2020 at 01:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="192685">Vassil Peytchev</span> <a href="#narrow/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance/near/211566401">said</a>:</p>
<blockquote>
<p>A bit tangential, but RC1 of .NET 5 apparently has some improvements to JSON handling, and a new <code>record</code> datatype. Has anyone looked at how that may impact the .NET reference implementation (if at all)?</p>
</blockquote>
<p>Yes.  I was read through <a href="https://github.com/dotnet/runtime/issues/41313">this tracker</a> for core changes, and <a href="https://trampster.blogspot.com/2020/09/jsonsrcgen-corert-pure-magic-in-my.html">this article</a> about using the .Net 5 source generators.  It looks exciting, but I figure that using System.Text.Json is a good step for now and we can revisit once .Net 5 is out in the wild.</p>



<a name="211571021"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/211571021" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#211571021">(Sep 29 2020 at 01:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="222054">Gino Canessa</span> <a href="#narrow/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance/near/211570078">said</a>:</p>
<blockquote>
<p>I don't remember when I started tagging them <code>ref</code>, I'll see if they need to be.</p>
</blockquote>
<p>Ah, the <code>JsonConverter.Read</code> function is <code>ref</code> and since the <code>IFhirJsonSerializable</code> goes back and forth with that function, it needs to be tagged <code>ref</code> as well.</p>



<a name="211571099"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/211571099" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#211571099">(Sep 29 2020 at 01:20)</a>:</h4>
<p>The writer doesn't need to be, so I'll change that.</p>



<a name="211573915"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/211573915" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#211573915">(Sep 29 2020 at 02:16)</a>:</h4>
<p>If the mark up can make them work, then awesome. Wasn't expecting that due to the way extensions work, and how things are a little wacky due to having to do xml and json on the same model.</p>



<a name="211573984"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/211573984" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#211573984">(Sep 29 2020 at 02:18)</a>:</h4>
<p>Resource.contains and parameters.parameter.resource are 2 fields that if take a close look at in the mapping.<br>
Looking forward to doing the detailed review <span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span></p>



<a name="211622368"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/211622368" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#211622368">(Sep 29 2020 at 13:45)</a>:</h4>
<p>Yeah, the markup style can work as long as you write custom converters to handle all the polymorphic stuff (e.g., a common resource converter, etc.).</p>



<a name="211769562"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/211769562" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#211769562">(Sep 30 2020 at 14:38)</a>:</h4>
<p>As an implementation note working through the actual fhir-net-api stuff now, the annotation style looks to be more trouble than it's worth.. particularly around converting enums to/from strings (on required-binding fields), you end up doing much of the same code-generation anyway.</p>



<a name="211797355"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/211797355" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#211797355">(Sep 30 2020 at 17:54)</a>:</h4>
<p>Blah.  Extended testing edge cases - really should have forced <code>resourceType</code> to be the first property in JSON.  Sorting out, but if you're looking through the code note that it currently fails when <code>resourceType</code> is <em>not</em> the first property.</p>



<a name="211858245"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/211858245" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#211858245">(Oct 01 2020 at 00:54)</a>:</h4>
<p>I agree with you there whole heartedly.</p>



<a name="211920259"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/211920259" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#211920259">(Oct 01 2020 at 14:38)</a>:</h4>
<p>Brian: jumping back in time a bit (tinkering brought it back to mind).. putting the functions on the models (and non-static) means I can use an interface to signal compatibility and work with the standard serialize/deserialize functions (e.g., with the generic JsonComponentConverter).</p>
<p>Should be able to do the same with extensions or partial classes, but joining them means that logic can be inspected alongside the class (e.g., how is it converting strings to enums).</p>



<a name="211951802"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/211951802" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Mandel <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#211951802">(Oct 01 2020 at 18:17)</a>:</h4>
<blockquote>
<p>really should have forced resourceType to be the first property in JSON.</p>
</blockquote>
<p>at that point, why not require that all properties be present in-order, just like XML? (I don't like this idea, to be clear -- I think FHIR does the right thing by not attaching semantics or requirements to the order of JSON properties.)</p>



<a name="211952784"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/211952784" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#211952784">(Oct 01 2020 at 18:23)</a>:</h4>
<p>Because without the type hint first, you cannot* implement stream-based parsing.  Since the type information is needed from the models, there's no way to parse a resource until you have the type.</p>
<p>*Right now I'm dithering between implementing my own cache-based reader (e.g., when the type doesn't come first, queue every token read until we find one, then empty the queue) or disabling the standard parsers, since they are based on forward-only streams.</p>
<p>Edit: there are other patterns possible, but it comes down to either an extra copy of the values or looping over the data twice (or at least looping over once, building a map, and then parsing it after - either way, the data has to all be read before parsing can actually happen).</p>



<a name="211953493"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/211953493" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#211953493">(Oct 01 2020 at 18:28)</a>:</h4>
<p>I'll note that a common pattern to avoid this is to nest everything an extra level with the type-hint outside it:</p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code><span class="p">{</span> <span class="nt">"resourceType"</span><span class="p">:</span><span class="s2">"Patient"</span><span class="p">,</span> <span class="nt">"id"</span><span class="p">:</span><span class="s2">"123"</span><span class="p">,</span> <span class="err">...</span> <span class="p">}</span>
</code></pre></div>

<p>becomes</p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code><span class="p">{</span> <span class="nt">"resourceType"</span><span class="p">:</span><span class="s2">"Patient"</span><span class="p">,</span> <span class="nt">"contents"</span><span class="p">:</span> <span class="p">{</span> <span class="nt">"id"</span><span class="p">:</span><span class="s2">"123"</span><span class="p">,</span> <span class="err">...</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></div>



<a name="212750869"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/212750869" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#212750869">(Oct 08 2020 at 21:21)</a>:</h4>
<p>So, getting back to the fun stuff  :-).  I have a pass on the basic version round-tripping with examples, so I've started going through the fhir-net-api specifics to change.</p>
<p>Unfortunately, I forgot that the FHIR-Net-API exposes parts of the NewtonSoft libraries (e.g., JObject, JsonReader, JsonWriter).  So, while System.Text.Json has better performance, there is no way to keep the API compatible switching to it.</p>
<p>Generating code to support both likely wouldn't be <em>terrible</em>, but would be 2x the code for each class plus the additional overhead of sorting out which to use at runtime.  My gut is that it isn't worth it.</p>
<p>So, unless there's something I missed I'm going to work on static functions for NewtonSoft next.  Thoughts?</p>



<a name="213971616"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/213971616" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#213971616">(Oct 20 2020 at 19:57)</a>:</h4>
<p>Question - working through some serialization edge cases (yes, still) and am trying to figure out the 'correct' behavior for the <code>Text</code> and <code>Count</code> summary types.</p>
<p>Specifically, the MaskingNode settings for those types flag to include all mandatory elements (which makes sense).  However, in playing with <code>Observation-2minute-apgar-score.json</code> from the R4 examples I see two different behaviors:</p>
<ul>
<li>if <code>Observation.code.text</code> is present, then the output includes <code>Observation.code</code>.</li>
<li>if <code>Observation.code.text</code> is removed, then the required element <code>Observation.code</code> is not present.</li>
</ul>
<p>Is that the expected / desired behavior?</p>



<a name="213992127"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/213992127" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#213992127">(Oct 20 2020 at 23:32)</a>:</h4>
<p>That really is an edge case. I'd suggest asking that  in the implementers stream, as that's not specific to us. And test what HAPI does there too.</p>



<a name="214094522"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/214094522" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#214094522">(Oct 21 2020 at 18:34)</a>:</h4>
<p>Looking through a bunch of implementations (HAPI, Grahame's server, IBM, etc..), it looks like a <code>fhir-net-api</code> specific issue.  HAPI has some unique behavior (asking on the right stream), but the general implementation is to include all of the element if it's a top-level mandatory element (in any form of summary).</p>
<p>I'm going to implement that way for now, and it can be reviewed once a full pass is complete.</p>



<a name="224835220"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/224835220" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#224835220">(Feb 02 2021 at 07:04)</a>:</h4>
<p><a href="/user_uploads/10155/Y1ByIeWt2Xwez3ixGvpY1F39/image_2021_02_02T06_53_14_902Z-1.png">image_2021_02_02T06_53_14_902Z-1.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/10155/Y1ByIeWt2Xwez3ixGvpY1F39/image_2021_02_02T06_53_14_902Z-1.png" title="image_2021_02_02T06_53_14_902Z-1.png"><img src="/user_uploads/10155/Y1ByIeWt2Xwez3ixGvpY1F39/image_2021_02_02T06_53_14_902Z-1.png"></a></div>



<a name="224835266"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/224835266" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#224835266">(Feb 02 2021 at 07:05)</a>:</h4>
<p>Not the json serialization, but have made some great progress with the Xml parser. My XmlDocument code generated one yields around twice as quick as the default, and the XmlReader version is looking a little over 10x faster, though still has a few issues yet.</p>



<a name="224894327"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/224894327" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gino Canessa <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#224894327">(Feb 02 2021 at 16:18)</a>:</h4>
<p>Nice!</p>



<a name="227148550"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/.NET%20JSON%20Serialization%20Performance/near/227148550" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/.2ENET.20JSON.20Serialization.20Performance.html#227148550">(Feb 21 2021 at 07:03)</a>:</h4>
<p><span class="user-mention" data-user-id="222054">@Gino Canessa</span> The custom XmlReader based XML Parser is now more or less complete, and have a branch on github, with the parsing error messaging now included, so this resource<br>
<a href="https://github.com/brianpos/fhir-net-web-api/blob/feature/r4-xml-performance/src/Test.WebApi.AspNetCore/TestPatientWithErrors.xml">https://github.com/brianpos/fhir-net-web-api/blob/feature/r4-xml-performance/src/Test.WebApi.AspNetCore/TestPatientWithErrors.xml</a><br>
will produce this OperationOutcome when trying to parse it<br>
<a href="https://sqlonfhir-r4.azurewebsites.net/fhir/OperationOutcome/validation-test?_format=json">https://sqlonfhir-r4.azurewebsites.net/fhir/OperationOutcome/validation-test?_format=json</a></p>
<p>Interestingly, when the resource is clean, the validation essentially costs nothing, however when there are errors, the routine is slowed down heaps.<br>
<a href="/user_uploads/10155/1qE4JYQ40vt35t-UnloEaQNv/image.png">image.png</a> <br>
Where the regular Fhir Parser is fast (as it bails on first issue, at the cost of not reporting all the issues)</p>
<div class="message_inline_image"><a href="/user_uploads/10155/1qE4JYQ40vt35t-UnloEaQNv/image.png" title="image.png"><img src="/user_uploads/10155/1qE4JYQ40vt35t-UnloEaQNv/image.png"></a></div>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
