---
layout: page
title: "FHIR Chat  · Profile validation with CachedResolver · dotnet"
---

{% raw %}<h2>Stream: <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/index.html">dotnet</a></h2>
<h3>Topic: <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/Profile.20validation.20with.20CachedResolver.html">Profile validation with CachedResolver</a></h3>

<hr>

<base href="https://chat.fhir.org">

<head><link href="https://fhir.github.io/chat-archive/style.css" rel="stylesheet"></head>

<a name="256574128"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/Profile%20validation%20with%20CachedResolver/near/256574128" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Barbro Vessman <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/Profile.20validation.20with.20CachedResolver.html#256574128">(Oct 07 2021 at 13:09)</a>:</h4>
<p>Hello<br>
I’m using the code below to validate resources. It works. <br>
The IG is in a zip-file that is added to the solution. The R4 specification.zip is added to the solution via the Hl7.Fhir.Specification.R4 NuGet package.<br>
Both zip files are extracted by the MultiResolver/CachedResolver to a temp folder in this location: C:\Users\&lt;username&gt;\AppData\Local\Temp\FhirArtifactCache-2.0.3-Hl7.Fhir.R4.Specification</p>
<p>However, sometimes the temp folders above are emptied. I’m not sure how or why since it happens irregularly. It might happen after having switched between branches, but not always. When folders are empty the profile validation fails with the error “Unable to resolve reference to profile”. Workaround is to remove folders or populating them manually. </p>
<p>Any tips on how to fix this are appreciated.</p>
<div class="codehilite"><pre><span></span><code>        // Get the Full IG from zip file
        string currentDir = System.IO.Path.GetFullPath(Path.Combine(AppContext.BaseDirectory, &quot;..\\..\\..\\&quot;));
        string fulligzip = Path.Combine(currentDir, &quot;ProfilesForTest\\ITB\\manual_full-ig.zip&quot;);

        // Create a resolver for both Full IG and specification.zip
        var specificationsource = ZipSource.CreateValidationSource();
        var zipsource = new ZipSource(fulligzip);

        MultiResolver = new CachedResolver(new MultiResolver(specificationsource, zipsource));

        // Create provider from resolver
        Provider = new StructureDefinitionSummaryProvider(MultiResolver);

        // Create validator with settings and resolver
        var settings = ValidationSettings.CreateDefault();
        settings.ResourceResolver = MultiResolver;
        Validator = new Validator(settings);

    }

    public string JsonProfileCheck(string json, string profileUrl)
    {

        // Validate the resouce
        var mySourceNode = FhirJsonNode.Parse(json);
        var myTypedElement = mySourceNode.ToTypedElement(Provider);
        Hl7.Fhir.Model.OperationOutcome outcome = Validator.Validate(myTypedElement, profileUrl);

        //Debug result
        var result = outcome.ToJson(new FhirJsonSerializationSettings() { Pretty = true });
        var outcomestring = result.ToString();

        return outcomestring;
    }
</code></pre></div>



<a name="256660103"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/Profile%20validation%20with%20CachedResolver/near/256660103" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/Profile.20validation.20with.20CachedResolver.html#256660103">(Oct 07 2021 at 22:31)</a>:</h4>
<p>Yes this occurs occasionally, I think it may be occurring on occasion when disk space runs low and windows gets a little aggressive - but I can't be sure.<br>
I haven't been able to work that out either.</p>



<a name="256691948"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/Profile%20validation%20with%20CachedResolver/near/256691948" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Barbro Vessman <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/Profile.20validation.20with.20CachedResolver.html#256691948">(Oct 08 2021 at 05:49)</a>:</h4>
<p>OK, thanks for your answer <span class="user-mention" data-user-id="191367">@Brian Postlethwaite</span></p>



<a name="256699973"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/Profile%20validation%20with%20CachedResolver/near/256699973" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/Profile.20validation.20with.20CachedResolver.html#256699973">(Oct 08 2021 at 07:32)</a>:</h4>
<p>The repair step I do is delete the temp folder and retry.</p>



<a name="257024774"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/Profile%20validation%20with%20CachedResolver/near/257024774" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ewout Kramer <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/Profile.20validation.20with.20CachedResolver.html#257024774">(Oct 11 2021 at 07:36)</a>:</h4>
<p>Yes it happens to me too now and then. It's happens so irregularly that I have never bothered to hunt it down - it won't happen in production anyway. I think it has something to do with switching  branches, yes, and then maybe two processes trying to unzip the directory at the same time.</p>
<p>Since we're looking at switching to the NPM packages instead of the spec.zip, we hope this problem will disappear all by itself.</p>



<a name="257119625"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/Profile%20validation%20with%20CachedResolver/near/257119625" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/Profile.20validation.20with.20CachedResolver.html#257119625">(Oct 11 2021 at 21:37)</a>:</h4>
<p>I've done a Sqlite resolver too.</p>



<a name="257665507"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/Profile%20validation%20with%20CachedResolver/near/257665507" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Barbro Vessman <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/Profile.20validation.20with.20CachedResolver.html#257665507">(Oct 15 2021 at 08:51)</a>:</h4>
<p>Thanks both of you <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span> <br>
NPM packages might be something to looking into also for us then</p>



<a name="271384966"></a>
<h4><a href="https://chat.fhir.org#narrow/stream/179171-dotnet/topic/Profile%20validation%20with%20CachedResolver/near/271384966" class="zl"><img src="https://fhir.github.io/chat-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Postlethwaite <a href="https://fhir.github.io/chat-archive/stream/179171-dotnet/topic/Profile.20validation.20with.20CachedResolver.html#271384966">(Feb 10 2022 at 04:27)</a>:</h4>
<p>This is a dirty hack that I've now put into the start of the app startup to try cleaning things up if there are problems.</p>
<div class="codehilite"><pre><span></span><code>        public static void VerifyTempSpecificationFolder()
        {
            try
            {
                // locate the temp folder
                Assembly assembly = typeof(ZipSource).GetTypeInfo().Assembly;
                var versionInfo = assembly.GetCustomAttribute&lt;AssemblyInformationalVersionAttribute&gt;();
                var productInfo = assembly.GetCustomAttribute&lt;AssemblyProductAttribute&gt;();
                string specificationArtifactKey = $&quot;FhirArtifactCache-{versionInfo.InformationalVersion}-{productInfo.Product}&quot;;
                string cachePath = Path.Combine(Path.GetTempPath(), specificationArtifactKey);
                if (Directory.Exists(cachePath))
                {
                    // ensure that the files are all in there from the zip file
                    var artifacts = new DirectoryInfo(cachePath).EnumerateFiles(&quot;*.xml&quot;, SearchOption.AllDirectories);
                    if (artifacts.Count() &lt; 11)
                    {
                        // Delete the folder (the next step will re-create it)
                        Directory.Delete(cachePath, true);
                    }
                }
            }
            catch(Exception ex)
            {
                // the sorts of issue that MIGHT come up here are related to permissions/concurrency
                //  - however this is OUR temp folder, so shouldn&#39;t happen anyway.
                Console.Error.WriteLine(&quot;Unexpected Error resetting suspected corrupt Specification Artifact temp folder&quot;);
            }
        }
</code></pre></div>
<p>I'm aware that this is pretty crude, but so is quietly failing.<br>
I'd love if there was a function on the ZipCacher to delete the folder that it creates too so that I don't have to have this gross code outside (this is the internals of the function that calculates the name, as thats private too)</p>


{% endraw %}
<hr><p>Last updated: Apr 12 2022 at 19:14 UTC</p>
