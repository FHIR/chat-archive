[
    {
        "content": "<p>Hei,</p>\n<p>En ymärrä, miten sandbox2:n auktorisointi toimii. Saisinko apua?<br>\nRekisteröin uuden käyttäjän osoitteessa <a href=\"https://fhirsandbox2-auth.kanta.fi/phr-authserver-sandbox/registeruser\" target=\"_blank\" title=\"https://fhirsandbox2-auth.kanta.fi/phr-authserver-sandbox/registeruser\">https://fhirsandbox2-auth.kanta.fi/phr-authserver-sandbox/registeruser</a>. <a href=\"http://www.kanta.fi/documents/12105/4106842/Authorization+guide+for+the+sandbox+environment/045fd8e5-19ca-41af-9827-ebb130654cd2\" target=\"_blank\" title=\"http://www.kanta.fi/documents/12105/4106842/Authorization+guide+for+the+sandbox+environment/045fd8e5-19ca-41af-9827-ebb130654cd2\">Oppaan</a> mukaan auktorisointi tehdään GET pyynnöllä (jonka jälkeen palvelu kysyy sotua ja nimeä),  joten yritin selaimella mennä esimerkin <a href=\"https://fhirsandbox2.kanta.fi/openid-connect-kela/authorize?response_type=code&amp;client_id=Client123&amp;scope=openid+patient/Observation.read+offline_access&amp;redirect_uri=https://app/after-auth&amp;state=b5de575e-ac1b-4c00-b1f1-844d1b9bdb03\" target=\"_blank\" title=\"https://fhirsandbox2.kanta.fi/openid-connect-kela/authorize?response_type=code&amp;client_id=Client123&amp;scope=openid+patient/Observation.read+offline_access&amp;redirect_uri=https://app/after-auth&amp;state=b5de575e-ac1b-4c00-b1f1-844d1b9bdb03\">https://fhirsandbox2.kanta.fi/openid-connect-kela/authorize?response_type=code&amp;client_id=Client123&amp;scope=openid+patient/Observation.read+offline_access&amp;redirect_uri=https://app/after-auth&amp;state=b5de575e-ac1b-4c00-b1f1-844d1b9bdb03</a> mukaiseen osoitteeseen, missä Client123 on korvattu saamallani client id:llä, redirect_uri omalla urlilla ja state-parametria hieman muutettu. Selaimen mukaan kuitenkin \"Suojatun yhteyden muodostaminen epäonnistui\".  Rekisteröimäni clientin scope sisältää mm. openid:n patient/Observation.read:n ja offline_access:n.</p>",
        "id": 153932749,
        "sender_full_name": "Esko Niinimäki",
        "timestamp": 1517223954
    },
    {
        "content": "<p>Oppaassa on vanha osoite, oikea osoite on sandboxin sivulla: \"Authorization service in sandbox is located at <a href=\"https://fhirsandbox2-auth.kanta.fi/phr-authserver-sandbox/\" target=\"_blank\" title=\"https://fhirsandbox2-auth.kanta.fi/phr-authserver-sandbox/\">https://fhirsandbox2-auth.kanta.fi/phr-authserver-sandbox/</a>\" eli palvelimen osoite on oikea, mutta sovelluksen nimi on muuttunut,  (<a href=\"http://www.kanta.fi/en/web/ammattilaisille/tarkeaa-tietoa-kehittajille\" target=\"_blank\" title=\"http://www.kanta.fi/en/web/ammattilaisille/tarkeaa-tietoa-kehittajille\">http://www.kanta.fi/en/web/ammattilaisille/tarkeaa-tietoa-kehittajille</a>).</p>",
        "id": 153932786,
        "sender_full_name": "Eeva Turkka",
        "timestamp": 1517233442
    },
    {
        "content": "<p>Kiitos Eeva! Oikealla urlillahan tuo toimi. Nyt minulla on kuitenkin ongelma tokenin saamisessa auktorisoinnin jälkeen. Palvelin palauttaa:<br>\n&lt;Response [401]&gt;</p>\n<p>headers:<br>\n{'Access-Control-Allow-Origin': '*',<br>\n 'Cache-Control': 'no-cache, no-store, max-age=0, must-revalidate, no-store',<br>\n 'Content-Language': 'en-US',<br>\n 'Content-Type': 'application/json;charset=UTF-8',<br>\n 'Date': 'Wed, 31 Jan 2018 11:48:37 GMT',<br>\n 'Expires': '0',<br>\n 'Pragma': 'no-cache, no-cache',<br>\n 'Set-Cookie': 'BIGipServerfhirsandbox2-auth.kanta.fi_pool=521553162.30755.0000; '<br>\n               'path=/; Httponly; Secure',<br>\n 'Strict-Transport-Security': 'max-age=31536000 ; includeSubDomains',<br>\n 'Transfer-Encoding': 'chunked',<br>\n 'WWW-Authenticate': 'Bearer realm=\"openidconnect\", error=\"unauthorized\", '<br>\n                     'error_description=\"Full authentication is required\"',<br>\n 'X-Content-Type-Options': 'nosniff',<br>\n 'X-FRAME-OPTIONS': 'DENY',<br>\n 'X-Powered-By': 'Servlet/3.0',<br>\n 'X-XSS-Protection': '1; mode=block'}</p>\n<p>text:<br>\n{\"error\":\"unauthorized\",\"error_description\":\"Full authentication is required\"}</p>\n<p>Olen asettanut post-pyyntöön<br>\nurliksi <a href=\"https://fhirsandbox2-auth.kanta.fi/phr-authserver-sandbox/token\" target=\"_blank\" title=\"https://fhirsandbox2-auth.kanta.fi/phr-authserver-sandbox/token\">https://fhirsandbox2-auth.kanta.fi/phr-authserver-sandbox/token</a><br>\nheaderiksi 'Accept': 'application/json'<br>\nHTTP Basic Authenticationiksi clientid:ClientSecret,  ja*<br>\ndataksi<br>\n        {'grant_type':'authorization_code”',<br>\n    'code':'auktorisointipalvelim antama koodi,<br>\n    'redirect_uri':'clientin url'}<br>\n*Opas oli hieman epäselvä, yritin myös muotoa \"Authorizarion clientid:ClientSecret\"</p>\n<p>Pystyttekö tuon perusteella kertomaan, mikä voisi olla vikana? Kuinka kauan auktorisointipalvelimen antama koodi on muuten voimassa? Kokeilin myös uudestaan auktorisointia ja sain uuden koodin, vanhensiko se aiemman?</p>",
        "id": 153934114,
        "sender_full_name": "Esko Niinimäki",
        "timestamp": 1517400646
    },
    {
        "content": "<p>Koodi tosiaan vanhenee aika nopeasti (riippuu clientin asetuksista, mutta olikohan oletus suunnilleen 30 sekuntia) ja uuden koodin pyyntö vanhentaa edellisen.</p>",
        "id": 153934474,
        "sender_full_name": "Eeva Turkka",
        "timestamp": 1517473247
    },
    {
        "content": "<p>Jos tarkoitat Default Max Agea Clientin asetuksissa, on se oletuksena 60000, joten olisiko se sitten millisekunneissa ja tarkoittaa 60 sekuntia?</p>\n<p>Joka tapauksessa, käsipelin tuota yritin, joten 30 sekuntia kyllä silloin ylittyi. En sitä kuitenkaan vieläkään saa toimiaan, vaan serveri lähettää edelleen saman virheilmoituksen.</p>",
        "id": 153935249,
        "sender_full_name": "Esko Niinimäki",
        "timestamp": 1517824659
    },
    {
        "content": "<p>Tuon Authorization-headerin pitäisi mennä muodossa:<br>\nAuthorization: Basic Y2xpZW50OnNlY3JldA==</p>\n<p>Eli siinä on client:secret  B64 enkoodattuna. Datana olevat parametrit kannattaa lähettää querystring-muodossa, sen pitäisi toimia.</p>",
        "id": 153935773,
        "sender_full_name": "Eeva Turkka",
        "timestamp": 1518015758
    },
    {
        "content": "<p>Lähettämäni pyyntö on nyt muodossa:</p>\n<p>{<br>\n  \"args\": {}, <br>\n  \"data\": \"code=0PinZc&amp;redirect_uri=https%3A%2F%2Fwww.jyu.fi%2Ffi&amp;grant_type=authorization_code\", <br>\n  \"files\": {}, <br>\n  \"form\": {}, <br>\n  \"headers\": {<br>\n    \"Accept\": \"application/json\", <br>\n    \"Accept-Encoding\": \"gzip, deflate\", <br>\n    \"Authorization\": \"Basic NWQ4YjY5YjctYmM3Ni00NjM4LTgzMDctNDcwMGMyZmUzNDFmOkVKc...[katkaistu tähän viestiin]\", <br>\n    \"Connection\": \"close\", <br>\n    \"Content-Length\": \"84\", <br>\n    \"Host\": \"<a href=\"http://httpbin.org\" target=\"_blank\" title=\"http://httpbin.org\">httpbin.org</a>\", <br>\n    \"User-Agent\": \"python-requests/2.9.1\"<br>\n  }, <br>\n  \"json\": null<br>\n}<br>\nSandbox2 palauttaa kuitenkin edelleen saman virheilmoituksen (mm. datan vaihto formista ei vaikuttanut). Tietysti jos tuo code vanheneekin alle kymmenessä sekunnissa, niin tapani on liian hidas.</p>\n<p>\"args\": {}, <br>\n  \"data\": \"\", <br>\n  \"files\": {}, <br>\n  \"form\": {<br>\n    \"code\": \"2nTPU9\", <br>\n    \"grant_type\": \"authorization_code\", <br>\n    \"redirect_uri\": \"<a href=\"https://www.jyu.fi/fi\" target=\"_blank\" title=\"https://www.jyu.fi/fi\">https://www.jyu.fi/fi</a>\"<br>\n  }</p>\n<p>Varmuuden vuoksi kertauksena siis palvelimen vastaus:<br>\n<a href=\"https://fhirsandbox2-auth.kanta.fi/phr-authserver-sandbox/token\" target=\"_blank\" title=\"https://fhirsandbox2-auth.kanta.fi/phr-authserver-sandbox/token\">https://fhirsandbox2-auth.kanta.fi/phr-authserver-sandbox/token</a><br>\n&lt;Response [401]&gt;</p>\n<p>{'Access-Control-Allow-Origin': '*',<br>\n 'Cache-Control': 'no-cache, no-store, max-age=0, must-revalidate, no-store',<br>\n 'Content-Language': 'en-US',<br>\n 'Content-Type': 'application/json;charset=UTF-8',<br>\n 'Date': 'Wed, 14 Feb 2018 10:08:33 GMT',<br>\n 'Expires': '0',<br>\n 'Pragma': 'no-cache, no-cache',<br>\n 'Set-Cookie': 'BIGipServerfhirsandbox2-auth.kanta.fi_pool=538330378.30755.0000; '<br>\n               'path=/; Httponly; Secure',<br>\n 'Strict-Transport-Security': 'max-age=31536000 ; includeSubDomains',<br>\n 'Transfer-Encoding': 'chunked',<br>\n 'WWW-Authenticate': 'Bearer realm=\"openidconnect\", error=\"unauthorized\", '<br>\n                     'error_description=\"Full authentication is required\"',<br>\n 'X-Content-Type-Options': 'nosniff',<br>\n 'X-FRAME-OPTIONS': 'DENY',<br>\n 'X-Powered-By': 'Servlet/3.0',<br>\n 'X-XSS-Protection': '1; mode=block'}</p>\n<p>{\"error\":\"unauthorized\",\"error_description\":\"Full authentication is required\"}</p>",
        "id": 153937328,
        "sender_full_name": "Esko Niinimäki",
        "timestamp": 1518605900
    },
    {
        "content": "<blockquote>\n<p>Lähettämäni pyyntö on nyt muodossa:</p>\n<p>{<br>\n  \"args\": {}, <br>\n  \"data\": \"code=0PinZc&amp;redirect_uri=https%3A%2F%2Fwww.jyu.fi%2Ffi&amp;grant_type=authorization_code\", <br>\n  \"files\": {}, <br>\n  \"form\": {}, <br>\n  \"headers\": {<br>\n    \"Accept\": \"application/json\", <br>\n    \"Accept-Encoding\": \"gzip, deflate\", <br>\n    \"Authorization\": \"Basic NWQ4YjY5YjctYmM3Ni00NjM4LTgzMDctNDcwMGMyZmUzNDFmOkVKc...[katkaistu tähän viestiin]\", <br>\n    \"Connection\": \"close\", <br>\n    \"Content-Length\": \"84\", <br>\n    \"Host\": \"<a href=\"http://httpbin.org\" target=\"_blank\" title=\"http://httpbin.org\">httpbin.org</a>\", <br>\n    \"User-Agent\": \"python-requests/2.9.1\"<br>\n  }, <br>\n  \"json\": null<br>\n}</p>\n</blockquote>\n<p>Voisitko kokeilla lisätä pyyntöön vielä client_id parametrin? Auktorisointioppaan mukaan se on pakollinen jos ei ole annettu client_assertion parametria.</p>",
        "id": 153937729,
        "sender_full_name": "Matti Uusitalo",
        "timestamp": 1518701991
    },
    {
        "content": "<p>Tarkoitatko siis näin:<br>\n{<br>\n  \"args\": {}, <br>\n  \"data\": \"client_id=5d8b69b7-bc76-4638-8307-4700c2fe341f&amp;redirect_uri=https%3A%2F%2Fwww.jyu.fi%2Ffi&amp;grant_type=authorization_code&amp;code=nej8YX\", <br>\n  \"files\": {}, <br>\n  \"form\": {}, <br>\n  \"headers\": {<br>\n    \"Accept\": \"application/json\", <br>\n    \"Accept-Encoding\": \"gzip, deflate\", <br>\n    \"Authorization\": \"Basic NWQ4YjY5YjctYmM3Ni00NjM4LTgzMDctNDcwMGMyZmUzNDFmOkVKcWU3cmVZY2xIRXF6SllwWHR3TExPQV9oU0VCZEFCcFdGSUdXbWdCNFQtVWM3b1ZKZEswcXh4TXdmSEJvdnRSejFKczM0QmgwaVNPQTFlbV81VmRn\", <br>\n    \"Connection\": \"close\", <br>\n    \"Content-Length\": \"131\", <br>\n    \"Host\": \"<a href=\"http://httpbin.org\" target=\"_blank\" title=\"http://httpbin.org\">httpbin.org</a>\", <br>\n    \"User-Agent\": \"python-requests/2.9.1\"<br>\n  }, <br>\n  \"json\": null<br>\n}</p>\n<p>Yllä oleva ei toimi myöskään, vaan serveri palauttaa saman 401-vastauksen. Kanta-sivulta <a href=\"http://www.kanta.fi/en/web/ammattilaisille/tarkeaa-tietoa-kehittajille\" target=\"_blank\" title=\"http://www.kanta.fi/en/web/ammattilaisille/tarkeaa-tietoa-kehittajille\">http://www.kanta.fi/en/web/ammattilaisille/tarkeaa-tietoa-kehittajille</a> löytyvä <a href=\"http://www.kanta.fi/documents/12105/4106842/Authorization+guide+for+the+sandbox+environment/045fd8e5-19ca-41af-9827-ebb130654cd2\" target=\"_blank\" title=\"http://www.kanta.fi/documents/12105/4106842/Authorization+guide+for+the+sandbox+environment/045fd8e5-19ca-41af-9827-ebb130654cd2\">auktorisointiopas</a> ei mainitse client_id-, eikä client_assertion-parametrejä.</p>",
        "id": 153937840,
        "sender_full_name": "Esko Niinimäki",
        "timestamp": 1518715870
    }
]