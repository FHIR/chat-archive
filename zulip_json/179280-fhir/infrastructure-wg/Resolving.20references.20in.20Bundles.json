[
    {
        "content": "<p>I've finally completed writing up what I <em>think</em> is the appropriate algorithm for references inside Bundles - in a comment at the end of <a href=\"http://jira.hl7.org/browse/FHIR-29271\">FHIR#29271</a>.  Please review and provide feedback.</p>",
        "id": 226617507,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1613542192
    },
    {
        "content": "<p>is the draft under review your most recent edited comment?</p>",
        "id": 226685075,
        "sender_full_name": "ryan moehrke",
        "timestamp": 1613579781
    },
    {
        "content": "<p>Yes</p>",
        "id": 226723101,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1613594967
    },
    {
        "content": "<p>The writeup includes language like \"the server MAY look \" -- I think \"server\" refers to \"entity processing the Bundle\"?</p>",
        "id": 226730236,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1613598072
    },
    {
        "content": "<p>The branch including \"Look for an entry with a fullUrl that matches the versionless reference and a resource.meta.versionId that matches the reference's version id.\" seems to end without covering all cases.</p>",
        "id": 226730407,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1613598157
    },
    {
        "content": "<p>The language about \"f (sic) there are entries in the Bundle with no fullUrl entries, the system MAY choose to parse the absolute reference to extract the 'id' and check for a match on the presumption that the base URL for the missing fullUrl would be the same as the absolute URL in the reference\"... this feels kind of open-ended. Is it strictly necessary?</p>",
        "id": 226730500,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1613598214
    },
    {
        "content": "<blockquote>\n<p>Resolving relative references against a UUID base. <br>\nThis feels like unnecessary complexity to me, and seems to introduce new requirements.</p>\n</blockquote>",
        "id": 226730781,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1613598347
    },
    {
        "content": "<p>Overall -- WOW, this is a complex process! I worry about implementability / consistency of implementations.</p>",
        "id": 226731334,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1613598610
    },
    {
        "content": "<p>I was going to comment on jira but this might be easier to discuss here. This proposal confuses me even more than the existing text - some of these sections have multiple layers of \"MAY\" and parenthetical statements. The tree of conditional possibilities is even deeper than before. Resolving relative references against a UUID base seems to be an entirely new idea and I don't see a use case for it.</p>",
        "id": 226732984,
        "sender_full_name": "Paul Church",
        "timestamp": 1613599276
    },
    {
        "content": "<p>I see two basic use cases for references in bundles:</p>",
        "id": 226733103,
        "sender_full_name": "Paul Church",
        "timestamp": 1613599301
    },
    {
        "content": "<ol>\n<li>The most common case that I see in my world, and what I recommend for applications constructing bundles for operational purposes, is that a reference to Patient/123 simply means Patient/123 on the server the bundle is being sent to, and if you want internal bundle references put a urn:uuid in the target resource's fullUrl and use urn:uuid to refer to it.</li>\n</ol>",
        "id": 226733293,
        "sender_full_name": "Paul Church",
        "timestamp": 1613599333
    },
    {
        "content": "<ol start=\"2\">\n<li>The other case is a pure data exchange where <a href=\"https://example.com/fhir\">https://example.com/fhir</a> produces a bundle in which every resource has a fullUrl prefixed with <a href=\"https://example.com/fhir\">https://example.com/fhir</a> and every reference is a relative reference that has to be interpreted against that restful base.</li>\n</ol>",
        "id": 226733340,
        "sender_full_name": "Paul Church",
        "timestamp": 1613599345
    },
    {
        "content": "<p>There are additional considerations for versioned references, conditional references, references by identifier, and references to some random fullUrl that we're not going to try to resolve. But the basic cases are referring to things on the server trying to process the bundle, and referring to things in the bundle.</p>",
        "id": 226733917,
        "sender_full_name": "Paul Church",
        "timestamp": 1613599511
    },
    {
        "content": "<p>Also to reiterate an earlier comment I am in favour of not putting any details in this section about resolving references by identifier, other than the first point \"The server is not required to perform any resolution whatsoever.\" It seems like a contradiction to say it's server-specific behaviour and then give a set of rules in the specification for doing it!</p>",
        "id": 226736385,
        "sender_full_name": "Paul Church",
        "timestamp": 1613600187
    },
    {
        "content": "<p>Maybe there are different rules for different types of Bundles? I think the rules for Transaction/batch, search-set, and messages/documents might be different (as in certain things are allowed or not allowed for each group)</p>",
        "id": 226742053,
        "sender_full_name": "Vassil Peytchev",
        "timestamp": 1613603387
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span></p>\n<ul>\n<li>will fix reference to server.  </li>\n<li>will finish second branch</li>\n<li>we need to cover situations where fullUrl is left unspecified.  It's unfortunate we allowed fullUrl to be omitted, but given we did, we need to handle it</li>\n<li>agree this is complex.  I'd love to mandate fullUrl and prohibit in-bundle identifier resolution and conditional reference resolution.  However, that ship appears to have sailed.  We could possibly split it into two sections - good practice resolution (complex enough) and \"special cases\" for where systems do things that are allowed but unnecessary and which we encourage you to not support so senders will stop creating unnecessary work...</li>\n</ul>\n<p><span class=\"user-mention\" data-user-id=\"197072\">@Paul Church</span> </p>\n<ul>\n<li>Relative references with urn:uuid: is something that's been supported by the tools for a while and I know is in use in some production systems (necessary or not).  Given it was never explicitly discussed, we'd have grounds for prohibiting it, but it would create implementer pain.  (Especially because they're using the Java validator in production.)</li>\n<li>We already have short descriptions of how to handle resolution of identifiers and the change request was to be more explicit. </li>\n</ul>\n<p><span class=\"user-mention\" data-user-id=\"192685\">@Vassil Peytchev</span> <br>\nI'm not aware of any rules that say that conditional references or identifier references are prohibited except in certain cases?  (Happy to reflect if there's a rule though - the more we can push them to the edges, the better.)</p>",
        "id": 226748519,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1613607447
    },
    {
        "content": "<p>Re: \"create implementer pain,\" endorsing extra/complex behaviors may be net more pain than proscribing them, even if a small number of current systems behave in ways outside of the spec (they can continue to work and just be non-conformant in this one small regard; no need to spread the complexity everywhere)</p>",
        "id": 226757713,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1613615818
    },
    {
        "content": "<p>Well, only if the Java validator continues to support the behavior...</p>",
        "id": 226758636,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1613616864
    },
    {
        "content": "<p>I didn't mean conditional references or logical references specifically. My first reaction was about relative references possibly referencing resources on a server (outside of the bundle):</p>\n<ul>\n<li>in Transaction/Batch, it makes sense that they are referencing resources on the server where the transaction/batch is posted</li>\n<li>in search results, it makes sense the they are referencing resources on the server that performed the search</li>\n<li>In a message or document it makes sense that they would only be relative to the fullUrl base of the resource, if the fullURL is a proper URL and not a URN.</li>\n</ul>\n<p>If we are looking at all the possible ways references could be written and then resolved, it seems that in some cases some variants may be prohibited, while in other they may be useful.</p>\n<p>On fullUrl in the form urn:uuid or urn:oid - I can't see any reasonable argument to have \"paths\" following the UUID or OID, and that should be disallowed.</p>",
        "id": 226838020,
        "sender_full_name": "Vassil Peytchev",
        "timestamp": 1613665620
    },
    {
        "content": "<p>You definitely can't have paths following the uuid or OID</p>",
        "id": 226839701,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1613666168
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191320\">Lloyd McKenzie</span> <a href=\"#narrow/stream/179280-fhir.2Finfrastructure-wg/topic/Resolving.20references.20in.20Bundles/near/226839701\">said</a>:</p>\n<blockquote>\n<p>You definitely can't have paths following the uuid or OID</p>\n</blockquote>\n<p>What about a link to the initial version of a newly created resource?</p>",
        "id": 226844847,
        "sender_full_name": "Elliot Silver",
        "timestamp": 1613668092
    },
    {
        "content": "<p>You still wouldn't have anything following the uuid or OID...</p>",
        "id": 226869907,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1613677983
    },
    {
        "content": "<p>What about \"uurn:uuid:9d1714da-b7e6-455b-bfd2-69ce0ff5fb12/_history/a\"?</p>",
        "id": 226870229,
        "sender_full_name": "Elliot Silver",
        "timestamp": 1613678141
    },
    {
        "content": "<p>How is that meaningful/possible?  How can there be history on something that doesn't have any existence outside the Bundle?</p>",
        "id": 226870376,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1613678197
    },
    {
        "content": "<p>Do you have a specific use-case?</p>",
        "id": 226870401,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1613678207
    },
    {
        "content": "<p>I want my provenance to link to the original version of the resource I'm creating, not to later updates.</p>",
        "id": 226870448,
        "sender_full_name": "Elliot Silver",
        "timestamp": 1613678230
    },
    {
        "content": "<p>See <a href=\"http://jira.hl7.org/browse/FHIR-14138\">J#14138</a></p>",
        "id": 226871081,
        "sender_full_name": "Elliot Silver",
        "timestamp": 1613678499
    },
    {
        "content": "<p>So you're not wanting to point to a version so much as to say \"when this transaction gets executed, the link should be version-specific\"?</p>",
        "id": 226872885,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1613679219
    },
    {
        "content": "<p>Right, and I think that's what the current existing text intended to convey -- you can tag a version on the urn, but don't expect that version number to actually be used, the server will use whatever it picks. Although the current text implies a server will never pay attention to the specific number, which is incorrect when you are referring to an existing (versioned) resource. (Hmm, gets even weirder when you start talking about conditional creates).</p>",
        "id": 226873441,
        "sender_full_name": "Elliot Silver",
        "timestamp": 1613679469
    },
    {
        "content": "<p>This sounds like what the X-Provenance header is trying to accomplish, making the Provenance resource refer to the specific version created by the operation it's attached to.</p>",
        "id": 226873912,
        "sender_full_name": "Paul Church",
        "timestamp": 1613679667
    },
    {
        "content": "<p>so will you only need that concept in transaction bundles?<br>\nor is there some other interaction you're thinking of?</p>",
        "id": 226874007,
        "sender_full_name": "ryan moehrke",
        "timestamp": 1613679721
    },
    {
        "content": "<p><a href=\"http://hl7.org/fhir/provenance.html#header\">http://hl7.org/fhir/provenance.html#header</a> - but it's unclear how this works with a bundle</p>",
        "id": 226874040,
        "sender_full_name": "Paul Church",
        "timestamp": 1613679724
    },
    {
        "content": "<p>That works for Provenance.  But if you're wanting to create an Encounter and a Condition and say \"this Encounter needs to point to this specific version of the Condition\", you can't use the X-Provenance mechanism to accomplish that</p>",
        "id": 226874620,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1613679975
    },
    {
        "content": "<p>Yep, I've looked at that in the past and there really isn't any way. It's not trivial to actually implement such a thing either, as the referring resource should be updated in the same transaction but the version of the referent may not be known until after the transaction commits - if it's based on a commit timestamp, for example.</p>",
        "id": 226874854,
        "sender_full_name": "Paul Church",
        "timestamp": 1613680083
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"237342\">ryan moehrke</span> <a href=\"#narrow/stream/179280-fhir.2Finfrastructure-wg/topic/Resolving.20references.20in.20Bundles/near/226874007\">said</a>:</p>\n<blockquote>\n<p>so will you only need that concept in transaction bundles?<br>\nor is there some other interaction you're thinking of?</p>\n</blockquote>\n<p>I don't know of other places where we expect urns to \"resolve.\" (Identifiers? Identifier or code systems?)</p>",
        "id": 226875093,
        "sender_full_name": "Elliot Silver",
        "timestamp": 1613680181
    },
    {
        "content": "<p>I'd forgotten X-Provenance. It seems like a straightforward change to describe how it would work on a transaction bundle. I'd also add in language that the transaction can either contain a Provenance resource or the X-Provenance header. Although as Lloyd points out, there are like other cases beyond Provenance that would still need to be addressed.</p>",
        "id": 226875614,
        "sender_full_name": "Elliot Silver",
        "timestamp": 1613680368
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"197072\">@Paul Church</span> , <a href=\"http://jira.hl7.org/browse/FHIR-31345\">J#31345</a>.</p>",
        "id": 226876938,
        "sender_full_name": "Elliot Silver",
        "timestamp": 1613680922
    },
    {
        "content": "<p>I am missing how we get from</p>\n<blockquote>\n<p>What about \"uurn:uuid:9d1714da-b7e6-455b-bfd2-69ce0ff5fb12/_history/a\"?</p>\n</blockquote>\n<p>to</p>\n<blockquote>\n<p>I want my provenance to link to the original version of the resource I'm creating, not to later updates.</p>\n</blockquote>\n<p>I think the following applies from <a href=\"https://tools.ietf.org/html/rfc8141#section-4.1\">section 4.1 of RFC 8141</a>:</p>\n<blockquote>\n<p>Because a URN is, syntactically, a URI under the \"urn\" scheme, in    theory a URN can be placed in any protocol slot that allows for a URI [...]</p>\n<p>However, this does not imply that, semantically, it always makes  sense in practice to place a URN in a given URI protocol slot; in particular, because a URN might not specify the location of a resource or even point indirectly to one, it might not be appropriate  to place a URN in a URI protocol slot that points to a resource</p>\n</blockquote>",
        "id": 226885921,
        "sender_full_name": "Vassil Peytchev",
        "timestamp": 1613684650
    },
    {
        "content": "<p>We get to it by:</p>\n<ul>\n<li>in a transaction bundle, uuids stand in for the id of a to-be-created resource.</li>\n<li>resource ids can be appended with ./_history/X to refer to a specific version of that resource.</li>\n<li>I want to refer to a specific version (in this case, the initial version) of a to-be-created resource.</li>\n<li>Based on that set of rules, uuid/_history/X should be able to refer to version of the newly created resource.</li>\n</ul>",
        "id": 226886975,
        "sender_full_name": "Elliot Silver",
        "timestamp": 1613685161
    },
    {
        "content": "<p>My understanding is quite different:</p>\n<p>In a transaction bundle, fullUrl can contain a urn:uuid or urn:oid value, solely for the purpose of enabling references within the bundle to this particular resource. </p>\n<p>Assuming that these fullUrl values will be used in any way outside of the bundle seems to be a stretch (IMO, all the way to non-conformance), and as far as I know is not documented anywhere. </p>\n<p>Assuming that the uuid in from a urn:uuid fullUrl \"stands in for the id of a to-be-created resource\"  is also quite a stretch.</p>\n<p>There is likely a much more sensible way to refer to the initial version of the to-be-created resource.</p>",
        "id": 226890715,
        "sender_full_name": "Vassil Peytchev",
        "timestamp": 1613686245
    },
    {
        "content": "<p>The intention isn't that the urn:uuid can be used outside the Bundle.  It's being used as a temporary id in the transaction to support linking.  The question is how you indicate that you want the linking to be version-specific when you're using that temporary id mechanism.</p>",
        "id": 226899505,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1613690848
    },
    {
        "content": "<p>In other words the Provenance resource is in the bundle as well?</p>",
        "id": 226902203,
        "sender_full_name": "Vassil Peytchev",
        "timestamp": 1613692757
    },
    {
        "content": "<p>Yes.  Or in my example, both Encounter and Condition are in the bundle.</p>",
        "id": 226902771,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1613693076
    },
    {
        "content": "<p>the other question I would have is: is there any use-case where you need to specify <em>which</em> version of a resource you want to point to (vs that you want to point to whichever version of the resource the current transaction creates) <br>\nbecause in my mind, if we can specify that there is no reason why you would need this paradigm outside of a transaction bundle, and no reason why you would need to point to more than 'current' version (but explicitly) then we could have more of a flag or something indicating 'this temporary reference is version specific and should be replaced as such' - whatever that version may actually be - instead of having to figure out how to apply /_history to a uuid etc.</p>",
        "id": 226904026,
        "sender_full_name": "ryan moehrke",
        "timestamp": 1613693956
    },
    {
        "content": "<p>I can't see such a use case (pointing to a version other than what the transaction creates) because if you don't know the identity of the resource, you wouldn't know the version ID that you want to point to.</p>",
        "id": 226905054,
        "sender_full_name": "Paul Church",
        "timestamp": 1613694762
    },
    {
        "content": "<p>I can't think of a reason to point to anything but the latest/only version of a created resource, although I can think of uses that might point to a specific version of an existing resource. </p>\n<p>Don't forget about conditional create though--there may be historical versions of a \"new\" resource. Again though, I can't think of a use for pointing at a previous version of a resource you are conditionally creating.</p>",
        "id": 226906174,
        "sender_full_name": "Elliot Silver",
        "timestamp": 1613695600
    },
    {
        "content": "<p>You <em>would</em> be pointing to the version created by the transaction.  The thing is that you're wanting the refence to be locked to that version, rather than floating and just pointing to the object in general - such that as the referenced thing changes, you'll always end up with the most recent version when traversing the link.</p>",
        "id": 226906980,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1613696296
    },
    {
        "content": "<p>In the Encounter/Condition example, I want the Encounter to point to the specific version of the Condition I'm creating <em>now</em> - with this transaction, such that even if the Condition changes in the future, the Encounter always refers to this specific version.</p>",
        "id": 226907029,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1613696339
    },
    {
        "content": "<p>But if you want to point to an existing version of an existing resource you can just call it out by the RESTful url right?<br>\nso I'm not sure how exactly our final version will look like, but theoretically something like versioned:9d1714da-b7e6-455b-bfd2-69ce0ff5fb12 may be better than uurn:uuid:9d1714da-b7e6-455b-bfd2-69ce0ff5fb12/_history/a that would only mean anything in a transaction bundle</p>",
        "id": 226907059,
        "sender_full_name": "ryan moehrke",
        "timestamp": 1613696366
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"237342\">@ryan moehrke</span> , except that we have a mechanism for version references defined in the current spec, and we don't have anything defined for \"version:\". Going with anything other than saying \"a uuid followed by /_history followed by anything will point to the created version\" is a breaking change.</p>",
        "id": 226907301,
        "sender_full_name": "Elliot Silver",
        "timestamp": 1613696532
    },
    {
        "content": "<p>Sure.  If you're wanting to point to a version that exists outside the Bundle, then you'd use a proper reference.  The sole requirement here is \"please establish a link to this other thing in the Bundle and, by the way, please ensure the link is version-specific\".  We don't have a good way (that I know of) to do that.  Which is what <span class=\"user-mention\" data-user-id=\"191380\">@Elliot Silver</span> is asking for.</p>",
        "id": 226907309,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1613696537
    },
    {
        "content": "<p>Where do we write that /_history is the only way that urls can reference a version specific resource? the only mention here <a href=\"https://www.hl7.org/fhir/references.html\">https://www.hl7.org/fhir/references.html</a> is in an 'eg.' example that just implies vRead format can be used. Is that really enough to call adding a specific keyword to call out this niche case a breaking change? nothing I can find anywhere else uses stronger language and sometimes doesn't even call out /_history at all.</p>\n<p>And yes, Lloyd I know that referencing resources that exist outside of the bundle is not the scope of the question,, I was responding to \" although I can think of uses that might point to a specific version of an existing resource. \" as the only given case where my use-case restrictions may not cover. But as you mentioned that is not in scope for the question anyways.</p>\n<p>Also to be clear I'm not saying that version: is our best bet. I'm just trying to pose that we shouldn't be twisting around existing formatting <em>if we don't need to.</em> If uuid/_history/blah is still better than sure go for it, but since as far as we can think this formatting will only be used in 1) a transaction bundle and 2) to point to whatever version <em>will be created by another interaction in said transaction bundle</em> <br>\nI'd think something explicit would be better than overloading /_history</p>",
        "id": 226909766,
        "sender_full_name": "ryan moehrke",
        "timestamp": 1613698529
    },
    {
        "content": "<p>I'm not arguing for throwing /_history on the end of a urn:uuid:....  In fact, I'm pretty sure that's <em>not</em> an option.  Whatever the reference is, it must be a valid URI.  If the URI starts with \"urn:uuid:\", then it has to follow the rules for that URN syntax - and throwing \"/_history\" on the end isn't it.  It may be that the solution is to put an extension on the reference.</p>\n<p>Certainly if you're going to refer to a specific version of an existing resource, using the full history URL is the <em>only</em> way to do this - and is the completely REST-appropriate way to do so.</p>",
        "id": 226918231,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1613707804
    },
    {
        "content": "<p>Or we can <del>cheat</del> get creative:</p>\n<ol>\n<li>reference.reference=\"urn:uuid:aaa-ss-fsdg\" in a transaction means always create a reference to the initial version of the resource created (if the server supports history)</li>\n<li>reference.identifier=\"urn:uuid:aaa-ss-fsdg\" in a transaction means always create a non-versioned reference to resource created.</li>\n</ol>",
        "id": 226920339,
        "sender_full_name": "Vassil Peytchev",
        "timestamp": 1613710214
    },
    {
        "content": "<p>We can't use a single special id.  There could be many (even hundreds) of distinct resources that each need version-specific links.  Plus hard-coding GUIDs is a recipe for disaster.  If GUIDs are the same across instances they're <em>supposed</em> to refer to the same resource.  I'd much prefer an extension.  At least that's clean and explicit.</p>",
        "id": 226920984,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1613710956
    },
    {
        "content": "<p>I think I didn't explain properly my (originally tongue-in-cheek) proposal.</p>\n<ol>\n<li>The purpose of having a fullUrl of the format urn:uuid or urn:oid is to provide Identity to resources that don't have one. In particular, in transactions/batch Bundles, such fullUrls can be used as a reference pointer to resources that are yet to be created.</li>\n<li>References can be literal (URL) or logical (identifier).</li>\n<li>UUIDs and OIDs are by definition identifiers.</li>\n<li>Based on the above, and the quote from RFC 8141, it seem to me that the proper way to reference resources within a Bundle where the fullUrl is in the format urn:uuid: or urn:oid, is to use reference.identifier.value</li>\n<li>With a couple of well thought-out new values for reference.identifier.use and reference.identifier.type we can get a clear and deterministic solution to the original problem (and add clarity to the general issue of resolving references on s bundle).</li>\n</ol>",
        "id": 226929132,
        "sender_full_name": "Vassil Peytchev",
        "timestamp": 1613720501
    },
    {
        "content": "<p>If a Reference.identifier is specified, there's no expectation the server will resolve it.  It's certainly not treated like a Reference.reference</p>",
        "id": 226968339,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1613744195
    },
    {
        "content": "<p>There is current language that sets such an expectation for internal references in a bundle</p>\n<blockquote>\n<p>Note, in addition, that a reference may be by identifier, and if it is, and there is no URL, it may be resolved by scanning the ids in the bundle.</p>\n</blockquote>",
        "id": 226970811,
        "sender_full_name": "Vassil Peytchev",
        "timestamp": 1613745178
    },
    {
        "content": "<p>Not that <em>requires</em> resolution</p>",
        "id": 226972696,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1613745990
    },
    {
        "content": "<p>And even if it did, there's no expectation they'll get turned into references</p>",
        "id": 226972724,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1613746005
    },
    {
        "content": "<p>Given that FHIR servers aren't required to even <em>support</em> versioned resources, wouldn't it be better to make an extension (e.g., <code>&lt;base&gt;/treat-as-version-specific-reference</code>)?  This could be placed either on the reference itself, or on the bundle (for allowed bundle types).</p>",
        "id": 226987109,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1613751459
    },
    {
        "content": "<p>I'd put it as an extension on the Reference.  Typically this would be something that would vary from reference to reference.</p>",
        "id": 226994315,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1613754166
    },
    {
        "content": "<p>Makes sense to me - I wasn't sure if the use cases were more along the lines of 'everything in this transaction should be <del>reference</del> version locked'.</p>",
        "id": 226995608,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1613754630
    },
    {
        "content": "<p>Not generally.  References to Patient or Practitioner would rarely be appropriate to be version-locked.  On the other hand, references to Condition or Questionnaire commonly would be.</p>",
        "id": 226996408,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1613754961
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"222054\">Gino Canessa</span> <a href=\"#narrow/stream/179280-fhir.2Finfrastructure-wg/topic/Resolving.20references.20in.20Bundles/near/226987109\">said</a>:</p>\n<blockquote>\n<p>Given that FHIR servers aren't required to even <em>support</em> versioned resources, wouldn't it be better to make an extension</p>\n</blockquote>\n<p>I don't buy this as motivation. What is the behaviour for existing resources if a client includes a version reference and the server doesn't support versions? We already have mechanisms to deal with this.</p>\n<p>If we are going to create an extension, I'd suggest something like \"reference current version\", and allow it to be used for any resource, existing or newly created.</p>\n<p>However, I stand by my position that the resolution previously agreed to was to support _history on uuids, and that any change to that is a breaking change.</p>",
        "id": 226996899,
        "sender_full_name": "Elliot Silver",
        "timestamp": 1613755160
    },
    {
        "content": "<p>It's only a breaking change if it was documented in the spec somewhere.  And given that the solution would automatically have been broken (because it would have resulted in an invalid URI, breaking a different rule), correcting it would qualify as a technical correction</p>",
        "id": 226997273,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1613755308
    },
    {
        "content": "<p>You <em>can't</em> allow <code>/_history</code> on a UUID - it is not a valid <a href=\"https://tools.ietf.org/html/rfc4122\">URN</a>.</p>\n<p>With that requirement, I much prefer an extension over building in more conditional processing complexity.</p>\n<p>Edit: my note about server support relates to the conditional nature of the processing - I think any major intention in <code>Bundle</code> would need to handle both situations.</p>",
        "id": 226997492,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1613755400
    },
    {
        "content": "<blockquote>\n<p>You can't allow /_history on a UUID - it is not a valid <a href=\"https://tools.ietf.org/html/rfc4122\">URN</a>.</p>\n</blockquote>\n<p>More precisely, it is an invalid URN in the UUID namespace.</p>",
        "id": 226999306,
        "sender_full_name": "Vassil Peytchev",
        "timestamp": 1613756224
    },
    {
        "content": "<p>Well, the response to <a href=\"http://jira.hl7.org/browse/FHIR-14138\">J#14138</a> makes it pretty clear that we intended it to work the way I've described. And I'm not arguing whether it is a valid URN or not, I'm pointing out that I believe it to be a breaking change.</p>\n<p>Also, <span class=\"user-mention silent\" data-user-id=\"191320\">Lloyd McKenzie</span> previously <a href=\"#narrow/stream/179166-implementers/topic/version.20specific.20references.20in.20transactions/near/153917905\">said</a>:</p>\n<blockquote>\n<p>It would be &lt;guid&gt;/_version/xyz, but otherwise yes.</p>\n</blockquote>\n<p>I'd really like <span class=\"user-mention\" data-user-id=\"191328\">@Ewout Kramer</span>, <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> or someone else involved in the original discussion to chime in.</p>",
        "id": 227000125,
        "sender_full_name": "Elliot Silver",
        "timestamp": 1613756590
    },
    {
        "content": "<p>I don't think <a href=\"http://jira.hl7.org/browse/FHIR-14138\">FHIR#14138</a> says anything about UUIDs at all.  I do agree the intention is to ensure that version-specific references in allowed in transactions, but disagree that it discussed UUIDs.</p>\n<p>The referenced ticket (<a href=\"http://jira.hl7.org/browse/FHIR-14005\">FHIR#14005</a>) specifically asks about it, and the resolution is:</p>\n<blockquote>\n<p>Question answered in #14138. You don't need to use urn:uuid, you can have a \"symbolic\" FHIR reference with a version indication to make this work.</p>\n</blockquote>\n<p>Which (to me) reads that you <em>cannot</em> use a UUID for a versioned reference, but can use a symbolic one.</p>",
        "id": 227001852,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1613757280
    },
    {
        "content": "<p>Yeah, I reread <a href=\"http://jira.hl7.org/browse/FHIR-14005\">J#14005</a> too. I don't recall what a \"symbolic\" reference is.</p>",
        "id": 227002253,
        "sender_full_name": "Elliot Silver",
        "timestamp": 1613757444
    },
    {
        "content": "<p>I think Lloyd could be more authoritative, but I assume it is just referring to assigning a local URI with a version (e.g., <code>Patient/123/_history/3</code>) within the bundle - knowing that the ID and version will be replaced during processing.</p>",
        "id": 227002850,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1613757675
    },
    {
        "content": "<p>I've updated the proposed language based on our discussions today.  Look at the last comment:<br>\n<a href=\"https://jira.hl7.org/browse/FHIR-29271\">https://jira.hl7.org/browse/FHIR-29271</a></p>",
        "id": 227378118,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1614051229
    },
    {
        "content": "<p>I like it, but I think this is a typo:<br>\n\"Note that the rules for resolving references in contained resources are the same as those for resolving <strong>resources</strong> in the resource that contains the contained resource.  I.e. the fullUrl of the containing resource is used when determining the base for relative references, etc.\"<br>\nbold is my emphasis: that should be \"same as those for resolving references in the resource\" right?<br>\nthat whole 'contained' blurb feels a bit wordy, but I don't have a better proposal so I'm not kicking and screaming for it to change.</p>",
        "id": 227453101,
        "sender_full_name": "ryan moehrke",
        "timestamp": 1614095843
    },
    {
        "content": "<p>Fixed</p>",
        "id": 227457269,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1614096946
    },
    {
        "content": "<p>Well, after accepting the resolution today, I finally remembered what I meant by resolving the references on the server for Batch and Transaction Bundles.</p>\n<p>Scenario: A transaction that contains an Entry of an observation, that points to a patient. In the entry for the observation, the request method is POST, and therefore, the fullUrl is either missing, or it is a URN. The referenced patient is not part of the Bundle, since there are no changes to that resource.</p>\n<p>I think it is appropriate in this case to require an attempt to resolve the relative reference <code>Patient/123</code> against the FHIR server where the transaction/Batch is posted.</p>",
        "id": 229394452,
        "sender_full_name": "Vassil Peytchev",
        "timestamp": 1615245639
    },
    {
        "content": "<p>And it needs to be a relative reference rather than absolute why?</p>",
        "id": 229402105,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1615249995
    },
    {
        "content": "<p>Because that is how it would look if it wasn't a part of a transaction. Requiring that it has to be an absolute reference would make things harder in cases of a multi-step preparation of transactions/batches.</p>",
        "id": 229403009,
        "sender_full_name": "Vassil Peytchev",
        "timestamp": 1615250687
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191506\">@Yunwei Wang</span> Can you put this on our agenda to evaluate again next week?</p>",
        "id": 229410732,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1615256201
    },
    {
        "content": "<p>I think this is the key point - if I POST an Observation containing a relative reference \"Patient/123\", the POST has no fullUrl for the Observation. There is an expectation (although perhaps I'm expecting too much and it's not spelled out anywhere?) that the server will interpret that reference relative to the server's base.</p>\n<p>But if I then wrap that same POST in a transaction bundle, that expectation disappears?</p>",
        "id": 229562158,
        "sender_full_name": "Paul Church",
        "timestamp": 1615327294
    },
    {
        "content": "<p>Based on the final language in <a href=\"https://jira.hl7.org/browse/FHIR-29271\">https://jira.hl7.org/browse/FHIR-29271</a>, any references using reference.identifier fail to resolve. What does it mean to fail in this context? I thought the intent was that servers may choose to resolve identifiers but are not required to.</p>",
        "id": 235752124,
        "sender_full_name": "Joe Lamy",
        "timestamp": 1619127312
    },
    {
        "content": "<p>We don't dictate what failure to resolve means.  Servers are allowed to treat it as an error, warning or ignore.  Or to fail to even try to resolve in the first place.</p>",
        "id": 235752337,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1619127425
    },
    {
        "content": "<p>Reviving this old thread... did an extension ever get created to specify a reference should be version-specific?</p>",
        "id": 261807838,
        "sender_full_name": "Elliot Silver",
        "timestamp": 1637165954
    },
    {
        "content": "<p>Is it allowed for me to update Provenance definition with an 'informative' guidance that would 'guide' data recipients (e.g. servers) to upgrade <a href=\"http://Provenance.target\">Provenance.target</a> references to a version specific reference WHEN that recipient is a versioning service, and when the request was to create/update with provenance (e.g. use of X-Provenance header, bundle transaction/batch with create/update and a Provenance)? This would be consistent with the current recommendation for <a href=\"http://Provenance.target\">Provenance.target</a> to be a version specific id, but is indeed new guidance to upgrade non-version links to version specific links.</p>",
        "id": 261810507,
        "sender_full_name": "John Moehrke",
        "timestamp": 1637166997
    },
    {
        "content": "<p>This referring to <a href=\"http://jira.hl7.org/browse/FHIR-31345\">FHIR-31345</a> that is asking for <a href=\"http://Provenance.target\">Provenance.target</a> handling</p>",
        "id": 261824557,
        "sender_full_name": "John Moehrke",
        "timestamp": 1637172612
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191380\">@Elliot Silver</span> did a tracker item ever get created?</p>",
        "id": 261855949,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1637186253
    },
    {
        "content": "<p>I don't recall creating one, and searching Jira for \"version\" is useless. I can create one if needed.</p>",
        "id": 261859748,
        "sender_full_name": "Elliot Silver",
        "timestamp": 1637187899
    },
    {
        "content": "<p>If you can't find one, creating one is the first step I guess</p>",
        "id": 261866495,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1637192210
    },
    {
        "content": "<p>OK. Rereading the thread, is there a need for a second to clarify not appending _history to urns?</p>",
        "id": 261867453,
        "sender_full_name": "Elliot Silver",
        "timestamp": 1637192911
    },
    {
        "content": "<p>Sounds like a good idea</p>",
        "id": 261869665,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1637194411
    },
    {
        "content": "<p><a href=\"http://jira.hl7.org/browse/FHIR-34342\">J#34342</a>, <a href=\"http://jira.hl7.org/browse/FHIR-34344\">J#34344</a>, and for fun <a href=\"http://jira.hl7.org/browse/FHIR-34345\">J#34345</a>.</p>",
        "id": 262009913,
        "sender_full_name": "Elliot Silver",
        "timestamp": 1637280036
    },
    {
        "content": "<p>I'm trying to implement the new proposed algorithm in the context of resolving a resource within a FHIR document. One question regarding the following section: </p>\n<div class=\"codehilite\"><pre><span></span><code>Extract the [root] from the Bundle entry&#39;s fullUrl and append the relative reference to it (e.g., &quot;https://fhir.example.org/&quot; + &quot;Patient/123&quot; --&gt; &quot;https://fhir.example.org/Patient/123&quot;)\n</code></pre></div>\n<p>Does this imply that all bundle fullUrls, if they are absolute urls, need to have the same root? Otherwise how am I supposed to pick the correct root? Or would I need to try out all potential combinations?</p>",
        "id": 271267708,
        "sender_full_name": "Alexander Zautke",
        "timestamp": 1644408930
    },
    {
        "content": "<p>The snippet you quoted above is how you turn a relative reference (within a <code>Bundle.entry.resource....reference</code>) into an absolute one. Having constructed this value, you can look for a sibling <code>Bundle.entry</code> whose <code>Bundle.entry.fullUrl</code> equals your constructed value. I'm not sure what \"potential combinations\" you're referring to. An example might help here.</p>",
        "id": 271286185,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1644417149
    },
    {
        "content": "<p>I was talking about the situation where you have a bundle containing fullUrls with multiple roots. When resolving the relative reference, I missed the part that you would extract the root of the fullUrl of the entry containing the relative reference. You should not assume that all roots are the same within the bundle and therefore extract the root from any fullUrl.</p>",
        "id": 271297072,
        "sender_full_name": "Alexander Zautke",
        "timestamp": 1644421438
    },
    {
        "content": "<p>Makes definitely more sense :) Thanks!</p>",
        "id": 271297331,
        "sender_full_name": "Alexander Zautke",
        "timestamp": 1644421538
    },
    {
        "content": "<p>Quite so. If there are clarifications you think would have been helpful here, please do suggest updated language! We've been trying to make this more approachable.</p>",
        "id": 271298319,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1644421877
    }
]