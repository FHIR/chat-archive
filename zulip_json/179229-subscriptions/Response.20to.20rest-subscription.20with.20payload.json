[
    {
        "content": "<p>When a system POST’s a resource (the payload) to a subscriber (the channel.endpoint):<br>\nDo we have any guidelines in respect to the response given by the subscriber?<br>\n- Should the subscriber only be allowed to validate the format (given by the Structuredefintion) of the resource? <br>\n- Or is it perfectly accepted and expected if the subscriber also chooses to perform its own business validation – corresponding to the description of the response to $process-message <a href=\"https://www.hl7.org/fhir/messaging.html#process\" target=\"_blank\" title=\"https://www.hl7.org/fhir/messaging.html#process\">https://www.hl7.org/fhir/messaging.html#process</a></p>",
        "id": 153919499,
        "sender_full_name": "Allan Bro Hansen",
        "timestamp": 1510674636
    },
    {
        "content": "<p>well, the real question is, what happens if it returns an error. Off the top of my head, I don't know what my system would do</p>",
        "id": 153919506,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1510674801
    },
    {
        "content": "<p>I guess my system would log this at an error, and hence notify Helpdesk. This could e.g. be the case if the auth-header had a invalid bearer-token which could be fixed by updating the subscription.</p>",
        "id": 153919511,
        "sender_full_name": "Allan Bro Hansen",
        "timestamp": 1510675252
    },
    {
        "content": "<p>So the question is if the notifying system is expected to handle more than just configuration and set-up errors? (I would also handle an invalid url and its resulting time-out)</p>",
        "id": 153919513,
        "sender_full_name": "Allan Bro Hansen",
        "timestamp": 1510675467
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192120\">@Allan Bro Hansen</span> we deal with this at Redox a lot - even to our own internal FHIR server (<span class=\"user-mention\" data-user-id=\"193933\">@Benjamin Flessner</span>  I'm looking at you), but we also send to hundreds of applications that have totally different expectations for errors, response codes, and validation. </p>\n<p>A few good principles: <br>\n# Don't trust that the receiver will ever do anything you want them to. It would be great if we could force people to send a <code>Retry-After</code> header if they know they are down and coming back up, but it's not realistic.<br>\n# If you bake in way to do retries, bake in a circuit break too <a href=\"https://martinfowler.com/bliki/CircuitBreaker.html\" target=\"_blank\" title=\"https://martinfowler.com/bliki/CircuitBreaker.html\">https://martinfowler.com/bliki/CircuitBreaker.html</a> - the reason the subscriber is sending 500s might be because you are breaking them. <br>\n# What you do with 400-ish response really should be up to you and your organization. It's much more of a cultural and value-oriented decision than a technical one. If someone can't get a subscription push at 4am, are you going to page someone? </p>\n<p>We've sort of had to build a lot of this infrastructure through trial and error and trying to scale a subscription model. That's why I think the value part of it is huge in how you design your system. Our applications are paying us to make sure they keep getting push messages, so we wake people up in the middle of the night, even if it's something we can't fix.</p>",
        "id": 153919544,
        "sender_full_name": "Nick Hatt",
        "timestamp": 1510678488
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"194031\">@Nick Hatt</span>:  Thank for the inputs, and your response.<br>\nMy question was however not how I should handle errors but rather if it would be expected FHIR-Subscription behavior that the subscriber performs business validations. I understand that I cannot force any behavior upon the subscribers but I can certainly choose to expect that they behave as agreed.</p>\n<p>My starting point was a rest-subscription without POSTing any payload making it a pure notification about “your subscriber-event/topic has happened” – the subscriber could then perform a query getting details about what did happen, and choose to act upon this. Without the payload, the subscriber would not be able to perform business validations as part of the GET and say that they did not like/accept what did happen. This would call for some different kind of “complain” interaction, if any.</p>\n<p>I now have chosen to include the payload and hence giving the subscriber the possibility to validate the “what has happen”-part. This seems a bit asymmetrically compared to the no-payload scenario but it could make sense . A use case could be “we want your system to monitor the complete subscriber notification and transaction at the subscriber part” (and call people at 4 am if it fails). <br>\nI find very little of expected subscriber-response at <a href=\"https://www.hl7.org/fhir/subscription.html\" target=\"_blank\" title=\"https://www.hl7.org/fhir/subscription.html\">https://www.hl7.org/fhir/subscription.html</a>. Hence my question.</p>",
        "id": 153919570,
        "sender_full_name": "Allan Bro Hansen",
        "timestamp": 1510687426
    },
    {
        "content": "<p>Isn't a <code>rest-hook</code> just a FHIR update interaction <a href=\"https://www.hl7.org/fhir/http.html#update\" target=\"_blank\" title=\"https://www.hl7.org/fhir/http.html#update\">https://www.hl7.org/fhir/http.html#update</a>?, so an OperationOutcome <a href=\"https://www.hl7.org/fhir/operationoutcome.html\" target=\"_blank\" title=\"https://www.hl7.org/fhir/operationoutcome.html\">https://www.hl7.org/fhir/operationoutcome.html</a> would be appropriate.</p>",
        "id": 153919574,
        "sender_full_name": "Nick Hatt",
        "timestamp": 1510691295
    },
    {
        "content": "<p>yes - I guess you are right. It says: \"This requests that a server forward a copy of any matching resource in JSON format to the nominated server as an Update operation using the nominated URL as the service base. \".<br>\nSo in fact I guess  it is a PUT with the normal validation handling  via operationOutcome.<br>\n(although I am really not asking the subscriber to update anything)</p>",
        "id": 153919576,
        "sender_full_name": "Allan Bro Hansen",
        "timestamp": 1510692437
    },
    {
        "content": "<p>Thanks :-)</p>",
        "id": 153919577,
        "sender_full_name": "Allan Bro Hansen",
        "timestamp": 1510692463
    },
    {
        "content": "<p>I recently did a 'field-study' on the FHIR validators out there and they do not all entirely agree upon everything - which means that there is no such thing as 'normal validation' - that is at least not my experience. If you are at DevDays <span class=\"user-mention\" data-user-id=\"192120\">@Allan Bro Hansen</span> come and join the discussion we are gonna have on the subscription resource. I'm currently authoring a gist with some <strong>findings</strong> I would like to talk about.</p>",
        "id": 153919590,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1510701052
    },
    {
        "content": "<p>of course we want convergence from the validators</p>",
        "id": 153919606,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1510720134
    },
    {
        "content": "<p>maybe we should document use of the Retry-after header in the subscription rest-hook doco - I didn't know about it</p>",
        "id": 153919607,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1510720189
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191427\">@Jens Villadsen</span> : Sadly I am not in Amsterdam. I am a bit surprised by the implications of returning a payload in stead of omitting it. Naively I would have expected just to add the payload as body (still doing a POST to the channel.endpoint)</p>",
        "id": 153919614,
        "sender_full_name": "Allan Bro Hansen",
        "timestamp": 1510732745
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192120\">@Allan Bro Hansen</span> - if you any stuff you would like me to bring up besides <a href=\"https://gist.github.com/jkiddo/e773d033c245c2c4fdef6d35cbe1a75b\" target=\"_blank\" title=\"https://gist.github.com/jkiddo/e773d033c245c2c4fdef6d35cbe1a75b\">https://gist.github.com/jkiddo/e773d033c245c2c4fdef6d35cbe1a75b</a> let me know</p>",
        "id": 153919615,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1510732787
    },
    {
        "content": "<p>But yeah - it takes some balls to use payload. It also comes with a huge performance gain ... and a lot of complexity pain</p>",
        "id": 153919616,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1510732922
    },
    {
        "content": "<p>y</p>",
        "id": 153919624,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1510735910
    },
    {
        "content": "<p>but yes. just add the payload as a body</p>",
        "id": 153919625,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1510735918
    },
    {
        "content": "<p>My point was that it is not \"just add the payload as a body\" - it is to perform a PUT a different url (channel.endpoint/&lt;ressourceName&gt;/&lt;ressourceId&gt;) - and maybe also implicitly to allow be the subscriber to perform business rules.</p>",
        "id": 153920949,
        "sender_full_name": "Allan Bro Hansen",
        "timestamp": 1511337211
    },
    {
        "content": "<p>And now the tricky part comes into play: What if the business logic of the 3. party rejects your update? I guess you should run a retry if it is in the 5xx range, but what if you hit a 4xx. Should you retry? How often should you retry? Should you retry at all?</p>",
        "id": 153920952,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1511337459
    },
    {
        "content": "<p>Some of these questions are taken up in the W3C subscriptions spec. <span class=\"user-mention\" data-user-id=\"194805\">@Kevin Marks</span> is going catalogue the differences and we'll copy anything we can</p>",
        "id": 153920953,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1511337841
    },
    {
        "content": "<p>Should I wait for <span class=\"user-mention\" data-user-id=\"194805\">@Kevin Marks</span>  to return with some findings before I start making change requests on gforge from <a href=\"https://gist.github.com/jkiddo/e773d033c245c2c4fdef6d35cbe1a75b\" target=\"_blank\" title=\"https://gist.github.com/jkiddo/e773d033c245c2c4fdef6d35cbe1a75b\">https://gist.github.com/jkiddo/e773d033c245c2c4fdef6d35cbe1a75b</a> ?</p>",
        "id": 153920957,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1511338638
    }
]