[
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"222054\">@Gino Canessa</span> , I've been thinking about the tagging scenarios we spoke about yesterday and had some ideas. Overall these are the scenarios we're trying to cover:</p>\n<ol>\n<li>Batching - where you send multiple events as a single notification</li>\n<li>Including - where you conduct _include directives for every notification and add to the notification</li>\n<li>Including and Batching at the same time!</li>\n</ol>\n<p>We're starting with the assumption that you cannot list a given resource more than once in a bundle, and so needing to reference a resource more than once in a bundle means you need to tag that resource somehow (I'm going with an <code>id-only</code> perspective for now, but unclear how more/less complex 'Full Resource' is).</p>\n<p>I have some ideas/examples in this <a href=\"https://gist.github.com/madaster97/0bdfd92c0ed336700c3db48aa84bf24c\">gist</a> based on your focus/grouping examples. Let me know what you think.</p>",
        "id": 247618930,
        "sender_full_name": "adam strickland",
        "timestamp": 1627581464
    },
    {
        "content": "<p>Hi Adam, thanks!  Though one of us has the logic backwards   =).  My understanding is:</p>\n<ul>\n<li>\n<p>The <code>focus</code> is needed if there are included resources.  E.g., if the focus is an Encounter, but additional Encounter instances are included, a receiver has no way of knowing which one triggered the notification.  Because this is a very lightweight addition, I am leaning towards making this 'always' instead of 'sometimes', in order to simplify usage.</p>\n</li>\n<li>\n<p>Tagging <code>Bundle.entry</code> with an event number is only needed if you are batching multiple events together (so that a receiver can tell which resource / resources belong to which event).  Since this is an 'advanced' scenario (e.g., a server that wants to batch requires additional logic anyway), I am leaning towards leaving this extension as 'optional'.</p>\n</li>\n</ul>\n<p>Does that sound correct?</p>",
        "id": 247621041,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1627582444
    },
    {
        "content": "<p>Yeah I accidentally flipped the logic compared to what you initially wrote, for 2 reasons:</p>\n<ol>\n<li>We need the <code>focus</code> for batched notifications, in the case where a single resource needs to be included more than once (IE, the focus of multiple events in the bundle). The resource would show up multiple times in the <code>focus</code>, but only once in the entry. Unclear how <code>focus</code> would handle versioning for <code>full resource</code> payload types though.</li>\n<li>If we insist on focus being present for batched notifications, we no longer need to tag focus entries with an event. We can know immediately that a resource was the topic for a specific event. We could then just use a tag when a resource was included, and for which event.</li>\n</ol>\n<p>I'm not sure if my re-structuring is any better <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span> . To clarify, in your scheme how do we indicate in a batch that a resource was the focus of more than 1 event?</p>",
        "id": 247638719,
        "sender_full_name": "adam strickland",
        "timestamp": 1627591474
    },
    {
        "content": "<p>I think there's a third option as well. Instead of <code>focus</code> and entry-tagging as 2 separate handles, we could introduce 2 different entry tags:</p>\n<ol>\n<li>A <code>foucs-for-event</code> tag that tells you this was the focus of a given event, and could be repeated multiple times if  a resource was the focus of multiple</li>\n<li>An <code>included-for-event</code> tag that tells you this was included for a given event, and similarly could be repeated multiple times.</li>\n</ol>\n<p>I feel like having these 2 tags is generic enough for both the <code>id-only</code> and <code>full resource</code> use cases, since we don't have to figure out how to include versioning in the <code>focus</code> header.</p>",
        "id": 247722040,
        "sender_full_name": "adam strickland",
        "timestamp": 1627658391
    },
    {
        "content": "<p>Yes, I think I like the two extensions better too.  To be clear, I <em>don't</em> like two extensions, just that it gives the best usability.  Also, if we get enough experience with them in R4, we may be able to propose adding them to R5 as STU elements on bundle instead of extensions (particularly if we make them generic enough).</p>\n<p>To that end, how do you feel about something like <code>focus-of-group</code> and <code>in-group</code>?</p>\n<p>edit: with the group being the event number in this case</p>",
        "id": 247741264,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1627667739
    },
    {
        "content": "<p>I think something like <code>subscription-notification-focus-for-event</code> and <code>subscription-notification-included-for-event</code> (or... something that adds words like \"notification\" or \"event\" that align with the concepts we define in our docs) would be good. (e.g., we have a property called <code>SubscriptionStauts.eventsInNotification</code>, and we should ideally re-use some of these words)</p>",
        "id": 247743068,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1627668590
    },
    {
        "content": "<p>Fair</p>",
        "id": 247743266,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1627668687
    },
    {
        "content": "<p>(To be clear, I'm not suggesting these super-long names directly; they're a bit of a mouthful ;))</p>",
        "id": 247744193,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1627669200
    },
    {
        "content": "<p>Yep - I was thinking about trying to name them in generic ways as a favor to 'future me', when I want to propose making them either standard extensions or trying to add a set to Bundle.  But in reality, that's irrelevant to the current use case so would be better to deal with in the future.</p>",
        "id": 247745344,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1627669794
    },
    {
        "content": "<p>FWIW, I feel like some of the awkwardness here stems from the fact that the Bundle is trying to represent a collection of \"events\" along with related resources, but there isn't actually a great representation of the event itself.  For my implementation, we are internally using the AuditEvent resource type to model the actual event itself, which provides a natural grouping structure since it can include a list of references to the \"focus\" resource as well as any related resources.  This also allows us to capture additional metadata about the event itself (rather than the focus resource) such as timestamp, event id, etc.  Admittedly, AuditEvent is a bit heavy, has too many required fields, and is not really optimized for this use case, but just wanted to put that out there as food for thought.  I feel like the lack of a structure to separate the \"event\" from the \"resource\" is part of the challenge here.</p>",
        "id": 247767164,
        "sender_full_name": "Steve Atwood",
        "timestamp": 1627682251
    },
    {
        "content": "<p>That's interesting. Do you have examples (or could you sketch one) of how you use AuditEvent to represent a focus + related other resources?</p>",
        "id": 247772504,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1627686978
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> sorry for the slow response - was on vacation last week.  I mocked up a fake example of a subscription bundle with AuditEvent payload here:  <a href=\"https://pastebin.com/15SqXM1V\">https://pastebin.com/15SqXM1V</a> .  The \"entity\" array provides a way to group multiple resource references for the single event and the \"entity.role\" allows us to identify the role played by each resource.  I also like that the FHIR reference data type used in \"entity.what\" offers flexibility to use a \"logical identifier\" (e.g. patient SSN in my fake example) for scenarios where we don't have a literal reference to a resolvable FHIR resource but still want to convey some useful information for the recipient to look up that entity by some other means (FHIR or non-FHIR).</p>",
        "id": 248915219,
        "sender_full_name": "Steve Atwood",
        "timestamp": 1628546952
    }
]