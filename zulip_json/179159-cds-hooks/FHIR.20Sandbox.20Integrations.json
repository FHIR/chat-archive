[
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"191355\">@Kevin Shekleton</span> <span class=\"user-mention\" data-user-id=\"192599\">@Zach Plata</span> <span class=\"user-mention\" data-user-id=\"196023\">@Amy Ballard</span> <span class=\"user-mention\" data-user-id=\"192232\">@Rick Freeman</span> <br>\nIs the CDS-Hooks Sandbox as a SMART App deployed to an environment where we can try launching it?</p>",
        "id": 153904656,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1504712400
    },
    {
        "content": "<p>Also, would you like the CDS-Hooks Sandbox to use a static client-id, or would you like the HSPC Sandbox to create a registration and provide you with a client-id for our system?</p>",
        "id": 153904657,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1504712565
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192233\">@Travis Cummings</span> - Here's the PR in review: <a href=\"https://github.com/cerner/cds-hooks-sandbox/pull/24\" target=\"_blank\" title=\"https://github.com/cerner/cds-hooks-sandbox/pull/24\">https://github.com/cerner/cds-hooks-sandbox/pull/24</a></p>",
        "id": 153904658,
        "sender_full_name": "Kevin Shekleton",
        "timestamp": 1504714031
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192599\">@Zach Plata</span> I'm launching CDS-Hooks against your Heroku deployment. It launches using the SMART of FHIR auth flow. After it gets the token, I see, in Developer Tools, that it queries the SMART open endpoint, <a href=\"https://sb-fhir-dstu2.smarthealthit.org/api/smartdstu2/open/Patient/SMART-1288992\" target=\"_blank\" title=\"https://sb-fhir-dstu2.smarthealthit.org/api/smartdstu2/open/Patient/SMART-1288992\">https://sb-fhir-dstu2.smarthealthit.org/api/smartdstu2/open/Patient/SMART-1288992</a>, and then it queries the patient I launched with and my FHIR server <a href=\"http://localhost:8071/dstu2/data/Patient/SMART-665677\" target=\"_blank\" title=\"http://localhost:8071/dstu2/data/Patient/SMART-665677\">http://localhost:8071/dstu2/data/Patient/SMART-665677</a>. Is this expected behavior?</p>",
        "id": 153904804,
        "sender_full_name": "Amy Ballard",
        "timestamp": 1504794209
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"196023\">@Amy Ballard</span> Yes, the Sandbox executes queries to a default patient and calls the services (these have been executed via commands that were triggered globally on a few JS files, so they execute on page load). You can ignore the first calls for now to 1288992. Soon we will work on re-factoring the Sandbox in it's entirety and the issue should be resolved.</p>",
        "id": 153905088,
        "sender_full_name": "Zach Plata",
        "timestamp": 1504932978
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191355\">@Kevin Shekleton</span> <span class=\"user-mention\" data-user-id=\"192599\">@Zach Plata</span> I'm here at the FHIR connectathon.  Is this something we can work on today?</p>",
        "id": 153905148,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1504968826
    },
    {
        "content": "<p>Here's the client ID for the Sandbox: 48163c5e-88b5-4cb3-92d3-23b800caa927</p>",
        "id": 153905154,
        "sender_full_name": "Zach Plata",
        "timestamp": 1504972307
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192599\">@Zach Plata</span> Would you like to keep using the client ID above, or move to a well-known id like \"cds-hooks-sandbox\"?</p>",
        "id": 153909395,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1505932183
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192233\">@Travis Cummings</span> Sorry for the delay! I think the well-known ID you mentioned would be good. We'll have to make this change in the launch endpoint, and can coordinate changing it in the default HSPC app about the same time. Is this default app already available to everyone?</p>",
        "id": 153911004,
        "sender_full_name": "Zach Plata",
        "timestamp": 1506522940
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192599\">@Zach Plata</span> Yes the default app is already available.  We can change the client_id associated with it when you are ready with the sandbox integration.</p>",
        "id": 153911280,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1506618497
    },
    {
        "content": "<p>Great, thanks <span class=\"user-mention\" data-user-id=\"192233\">@Travis Cummings</span> ! We'll let you know when the PR is out to change that client_id and we can coordinate the switch.</p>",
        "id": 153911477,
        "sender_full_name": "Zach Plata",
        "timestamp": 1506691790
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192599\">@Zach Plata</span> I've been seeing inconsistent launches of the CDS Hooks Sandbox from the HSPC sandbox.  It seems to sometimes load the proper patient (ex: Baby Bili) then very quickly flashes over to Daniel Adams.</p>",
        "id": 153912203,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1507084293
    },
    {
        "content": "<p><a href=\"/user_uploads/10155/dtQCbCFdmsbptiYA7s-2t7fP/CDSHooksLaunch.png\" target=\"_blank\" title=\"CDSHooksLaunch.png\">CDSHooksLaunch.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/dtQCbCFdmsbptiYA7s-2t7fP/CDSHooksLaunch.png\" target=\"_blank\" title=\"CDSHooksLaunch.png\"><img src=\"/user_uploads/10155/dtQCbCFdmsbptiYA7s-2t7fP/CDSHooksLaunch.png\"></a></div>",
        "id": 153912204,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1507084395
    },
    {
        "content": "<p>Other timers it shows Daniel Adams then quickly flashes to the launched patient, Baby Bili.</p>",
        "id": 153912205,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1507084429
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192233\">@Travis Cummings</span> Thanks for bringing this up. I'll take a look today</p>",
        "id": 153912266,
        "sender_full_name": "Zach Plata",
        "timestamp": 1507126110
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192599\">@Zach Plata</span> Have you detected any issue with the patient that is displayed when the CDS Hooks sandbox is launched from the HSPC Sandbox?</p>",
        "id": 153913369,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1507663448
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192599\">@Zach Plata</span> Can you let me know, when the CDS Hooks sandbox is launched from the HSPC sandbox, does the CDS Hooks sandbox send the access token to the subsequent CDS Hooks services?  Do they all share the same token or how do the services get access to the HSPC sandbox instance?</p>",
        "id": 153913377,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1507667799
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192233\">@Travis Cummings</span> I haven't noticed any issues launching the CDS Hooks Sandbox from the HSPC Sandbox on my end. What are you seeing? The inconsistent launch of that Baby Bili issue?</p>\n<p>And yes, the CDS Hooks Sandbox sends the access token to services via the fhirAuthorization parameter in the request. All services hooked up will receive the same token (the token the CDS Hooks Sandbox receives, and just passes along, for now).</p>",
        "id": 153913379,
        "sender_full_name": "Zach Plata",
        "timestamp": 1507669162
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192599\">@Zach Plata</span> I haven't seen the inconsistent patient display today in 5 or 6 launches.  If it happens again, I'll try to use the \"change patient\" menu and see if I can get bilibaby to show properly.</p>",
        "id": 153913380,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1507669790
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192599\">@Zach Plata</span> Do you think the CDS Hooks-HSPC Sandbox integration is something we can demo at the next Argonaut CDS Hooks Team Meeting?  If so, need to do a little work on the HSPC side to make sure the bilirubin cds service and bilirubin app are working together.</p>",
        "id": 153913398,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1507674375
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192233\">@Travis Cummings</span> I'm not on the email chain that gets sent the meeting invites, but you are more than welcome to demo that at the next Argonaut meeting. Please let me know if you encounter any patient/service patient name mismatch leading up to it.</p>",
        "id": 153914769,
        "sender_full_name": "Zach Plata",
        "timestamp": 1508360953
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192599\">@Zach Plata</span> <span class=\"user-mention\" data-user-id=\"191355\">@Kevin Shekleton</span> <span class=\"user-mention\" data-user-id=\"192600\">@Matt Henkes</span> It seems like the next easiest integration would be for the HSPC sandbox to pass a custom launch parameter that contains context info for the CDS-Hooks sandbox.  I think the first context item would be the a CDS-Hooks service discovery endpoint the CDS-Hooks sandbox can add to the \"Select a Service:\" box.  This could either be in the form of an action/command or a declaration, singular or plural:</p>\n<p>\"add_cds_service_discovery_endpoint\": \"<a href=\"https://example.com/cds-services\" target=\"_blank\" title=\"https://example.com/cds-services\">https://example.com/cds-services</a>\"</p>\n<p>\"cds_service_discovery_endpoint\": \"<a href=\"https://example.com/cds-services\" target=\"_blank\" title=\"https://example.com/cds-services\">https://example.com/cds-services</a>\"</p>\n<p>\"cds_service_discovery_endpoints\": [{\"https://example.com/cds-services\"}]</p>\n<p>Or, what would you like to see?</p>",
        "id": 153914782,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1508372019
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192233\">@Travis Cummings</span>  Is there any update on the HSPC end for implementing the API for SMART app launches registered from an HSPC sandbox for the CDS Hooks Sandbox? Curious on your thoughts for that specific proposal, as I'm hoping to figure out what this might look like for working on next.</p>",
        "id": 153915470,
        "sender_full_name": "Zach Plata",
        "timestamp": 1508779152
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192599\">@Zach Plata</span> Here is a rough draft on how I think the app launch could work.  Basically the CDS-hook service would return an app link card that contained the URL of the target app.  The CDS-Hooks sandbox would receive that link card and show a button.  When the user clicked the button, the cds-hooks sandbox would send a smart launch request (not a formal smart-on-fhir launch) to the HSPC Sandbox's smart launch invocation endpoint (a new endpoint) with the fhir_url, the open_id token, and the launch url of the app.  The HSPC sandbox would then figure out if a registered app matched the launch url, and perform a persona-launch (launching for a persona user).</p>",
        "id": 153917275,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1509604186
    },
    {
        "content": "<p><a href=\"/user_uploads/10155/EN6Y7UZ9qDKe0sXzDbKBdxwj/CDS-Hooks-Components.png\" target=\"_blank\" title=\"CDS-Hooks-Components.png\">CDS-Hooks-Components.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/EN6Y7UZ9qDKe0sXzDbKBdxwj/CDS-Hooks-Components.png\" target=\"_blank\" title=\"CDS-Hooks-Components.png\"><img src=\"/user_uploads/10155/EN6Y7UZ9qDKe0sXzDbKBdxwj/CDS-Hooks-Components.png\"></a></div>",
        "id": 153917276,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1509604197
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192233\">@Travis Cummings</span> Thanks for that flow chart! To clarify, when the Sandbox calls the new HSPC launch endpoint, will the Sandbox get the launch code back, so it can trigger the app launch itself? It looks like HSPC is doing the coordination of the app launch on that bottom half of the picture. Also, is there an estimated time on when this new endpoint from HSPC would be available?</p>",
        "id": 153917330,
        "sender_full_name": "Zach Plata",
        "timestamp": 1509638393
    },
    {
        "content": "<p>I had thought that the CDS Hooks sandbox would ask the HSPC sandbox to launch the app.  Are you proposing the CDS Hooks sandbox registers a launch context with the HSPC sandbox (receiving back a launch code), then just opens the app by passing along the launch code?</p>",
        "id": 153917496,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1509662095
    },
    {
        "content": "<p>If the cds hooks sandbox wants to create the launch context and perform the smart launch, then the cds hooks sandbox would be acting basically like the HSPC's \"Sandbox Manager\" tool.  </p>\n<p>In this case, the process is:<br>\n1) the Sandbox Manager creates a launch context (app to launch, params, issuer, launch details, etc)<br>\n2) the Sandbox Manager creates a launch code (\"key\") <br>\n3) the Sandbox Manager registers the launch context with the issuer (fhir server) at the endpoint iss + '/_services/smart/Launch' using a POST<br>\n4) the Sandbox Manager receives the context back from the registration call and adds it to the windows local storage indexed by the launch code (\"key\") so the opening window (for the app) can find it (opened with a param ?key=...}</p>",
        "id": 153917497,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1509663754
    },
    {
        "content": "<p>You can see this all in action here:</p>\n<p><a href=\"https://bitbucket.org/hspconsortium/sandbox-manager/raw/ade67887c41d42d0a8d8645ca8057a8443c87371/src/static/js/services.js\" target=\"_blank\" title=\"https://bitbucket.org/hspconsortium/sandbox-manager/raw/ade67887c41d42d0a8d8645ca8057a8443c87371/src/static/js/services.js\">https://bitbucket.org/hspconsortium/sandbox-manager/raw/ade67887c41d42d0a8d8645ca8057a8443c87371/src/static/js/services.js</a></p>\n<p>In the \"factory('launchApp'...\" starting at 1925.</p>",
        "id": 153917498,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1509663884
    },
    {
        "content": "<p>Note the call to registerContext().  registerContext is defined on line 621 and looks like this:</p>\n<div class=\"codehilite\"><pre><span></span>    registerContext: function (app, params, issuer) {\n        var deferred = $.Deferred();\n\n        var reqLaunch = fhirClient.authenticated({\n            url: issuer + &#39;/_services/smart/Launch&#39;,\n            type: &#39;POST&#39;,\n            contentType: &quot;application/json&quot;,\n            data: JSON.stringify({\n                client_id: app.authClient.clientId,\n                parameters: params\n            })\n        });\n\n        $.ajax(reqLaunch)\n            .done(deferred.resolve)\n            .fail(deferred.reject);\n        return deferred;\n    }\n</pre></div>",
        "id": 153917499,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1509663958
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192233\">@Travis Cummings</span> Ah, I should've looked more closely at the first message, that this would not be a formal smart-on-fhir launch. I originally thought the new API would return the opaque launch context for the launch parameter, and the sandbox would append the FHIR server on the iss parameter to launch the app, from the control of the Sandbox.</p>",
        "id": 153917500,
        "sender_full_name": "Zach Plata",
        "timestamp": 1509664433
    },
    {
        "content": "<p>I assume the cds hooks sandbox needs to be able to smart-launch apps when not being launched from the hspc sandbox?</p>",
        "id": 153917501,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1509664769
    },
    {
        "content": "<p>Right, and as of right now, if the cds hooks sandbox is launched securely, like through HSPC sandbox, I'm not aware if the secure SMART app launch has been nailed down yet, beyond this case.</p>",
        "id": 153917502,
        "sender_full_name": "Zach Plata",
        "timestamp": 1509665318
    },
    {
        "content": "<p>To launch an app, the HSPC Sandbox Manager creates a launch context and key (launch code), and then posts it to the iss.  The iss then posts it to the auth server.  The Sandbox Manager then gets back the launch context and opens the app.  It looks like this:</p>",
        "id": 153917505,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1509666597
    },
    {
        "content": "<p><a href=\"/user_uploads/10155/KliMJ8Me53SBKLYJhaTdbr6x/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/KliMJ8Me53SBKLYJhaTdbr6x/pasted_image.png\" target=\"_blank\" title=\"pasted image\"><img src=\"/user_uploads/10155/KliMJ8Me53SBKLYJhaTdbr6x/pasted_image.png\"></a></div>",
        "id": 153917506,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1509666617
    },
    {
        "content": "<p>I think the cds-hooks sandbox has two options.</p>\n<p>1) act like the HSPC Sandbox Manager and create and register the launch context, then open the app</p>\n<p>2) delegate launching the app to the HSPC Sandbox Manager (just tell the HSPC Sandbox Manager to launch the app)</p>",
        "id": 153917507,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1509666868
    },
    {
        "content": "<p>For #2, we would probably pass into the CDS Hooks sandbox a extra launch parameter like \"smart_launch_delegate=http://...\".  Then when a smart app link is clicked, the CDS Hooks sandbox would post to the delegate everything it knew (the app link, the iss, the access token, the user token).</p>",
        "id": 153917509,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1509667358
    },
    {
        "content": "<p>Is there a different option you are think of?  The first option is available right now, the second option would take some work on our side to build the delegate launch stuff.  I could help you with the first option by a pull request if that helped out.</p>",
        "id": 153917510,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1509667460
    },
    {
        "content": "<p>Ah, that smart_launch_delegate part was what I was looking for. So when the CDS Hooks Sandbox is launched from HSPC, along with the access token and such, it should retrieve this smart_launch_delegate url, to which the CDS Hooks Sandbox would post to with relevant data.</p>",
        "id": 153917511,
        "sender_full_name": "Zach Plata",
        "timestamp": 1509667768
    },
    {
        "content": "<p>I think #2 would be a good option, whenever that is ready. <span class=\"user-mention\" data-user-id=\"191355\">@Kevin Shekleton</span> thoughts on this?</p>",
        "id": 153917512,
        "sender_full_name": "Zach Plata",
        "timestamp": 1509667914
    },
    {
        "content": "<p>I think the key requirements are:<br>\n1. Ensure that the CDS Hooks Sandbox can launch apps (via \"App Link\") in a way that looks, to the app, exactly like a norma SMART Launch.<br>\n2. Ensure that the CDS Hooks Sandbox connects to an underlying clinical data sandbox (like the HSPC or SMART sandbox) through a well-specified protocol, so that anyone can implement another clinical data sandbox and it stays compatible.</p>",
        "id": 153917669,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1509821046
    },
    {
        "content": "<p>I think a non-goal is: making the CDS Hooks sandbox work in front of production EHRs to protect real data.</p>",
        "id": 153917670,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1509821077
    },
    {
        "content": "<p>Given these requirements: my preferred solution is to continue defining a \"sandbox launch API\" like Travis suggests in #1, and making sure the inputs/outputs are clearly specified. (We did this back when we created the initial SMART auth server; I think that work may have persisted to this day, but it'd be good to double-check. <span class=\"user-mention\" data-user-id=\"192233\">@Travis Cummings</span>  is the protocol in your diagram documented?)</p>",
        "id": 153917671,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1509821206
    },
    {
        "content": "<p>(I prefer #1 because:</p>\n<ul>\n<li>it leverages an existing protocol and</li>\n<li>it gives components like the CDS Hooks sandbox more control -- e.g. you can generate a few launch ids in parallel to anticipate different user choices and speed up the process.</li>\n<li>it's very easy for a client to simulate the behavior of #2 if it has access to the API for #1 — but the other direction is not possible.<br>\n)</li>\n</ul>",
        "id": 153917672,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1509821375
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> : <span class=\"user-mention\" data-user-id=\"192599\">@Zach Plata</span> and I met on Friday and talked through some options.  We thought first that the system launching the CDS Hooks sandbox should pass in a \"launch registration endpoint\" as a launch parameter.  Otherwise the CDS Hooks sandbox would either have to use the issuer or the launch requestor address.</p>",
        "id": 153917880,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1510001206
    },
    {
        "content": "<p>I'm having some doubts.  I'm thinking the endpoint should actually be in the iss server now.  This is for a couple reasons, but mostly because the CDS Hooks sandbox already has an access token to that server.  In that case, there is no \"launch registration endpoint\" value passed to the CDS Hooks sandbox because it is a well-known endpoint on the iss.  For example, smart/launch-registration or something like that.</p>",
        "id": 153917884,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1510001800
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 153917888,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1510004919
    },
    {
        "content": "<p><a href=\"/user_uploads/10155/KRCuQDgBkugqy9IfuoG3tl4w/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/KRCuQDgBkugqy9IfuoG3tl4w/pasted_image.png\" target=\"_blank\" title=\"pasted image\"><img src=\"/user_uploads/10155/KRCuQDgBkugqy9IfuoG3tl4w/pasted_image.png\"></a></div>",
        "id": 153917889,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1510004985
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> <span class=\"user-mention\" data-user-id=\"192599\">@Zach Plata</span> Here is a confluence page we can collaborate on:</p>",
        "id": 153917890,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1510008255
    },
    {
        "content": "<p><a href=\"https://healthservices.atlassian.net/wiki/spaces/HSPC/pages/119734296/Registering+a+Launch+Context\" target=\"_blank\" title=\"https://healthservices.atlassian.net/wiki/spaces/HSPC/pages/119734296/Registering+a+Launch+Context\">https://healthservices.atlassian.net/wiki/spaces/HSPC/pages/119734296/Registering+a+Launch+Context</a></p>",
        "id": 153917891,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1510008261
    },
    {
        "content": "<p>We are exited to announce that SMART app links in your cards now can be launched from the CDS Hooks sandbox to your HSPC Sandbox instance (as the issuer)!  Thanks <span class=\"user-mention\" data-user-id=\"192599\">@Zach Plata</span>  for making this happen!</p>",
        "id": 153930526,
        "sender_full_name": "Travis Cummings",
        "timestamp": 1516823520
    }
]