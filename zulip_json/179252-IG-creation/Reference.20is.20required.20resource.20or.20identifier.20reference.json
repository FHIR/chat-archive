[
    {
        "content": "<p>Wondering about the best way to enforce this?</p>\n<p>What I'm doing is adding a constraint expression on Reference like:</p>\n<div class=\"codehilite\"><pre><span></span><code>(reference.exists() or (identifier.exists() and display.exists()))\n</code></pre></div>\n<p>That works and ensures resources vaidate ok. <br>\nIt also works for rest and message exchanges. However for some messages I want to force one option. At present what I doing is using MessageDefinition.focus e.g. for prescriptionorder's</p>\n<div class=\"codehilite\" data-code-language=\"XML\"><pre><span></span><code> <span class=\"nt\">&lt;focus&gt;</span>\n        <span class=\"nt\">&lt;code</span> <span class=\"na\">value=</span><span class=\"s\">\"MedicationRequest\"</span> <span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;profile</span> <span class=\"na\">value=</span><span class=\"s\">\"https://fhir.nhs.uk/StructureDefinition/NHSDigital-MedicationRequest\"</span> <span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;min</span> <span class=\"na\">value=</span><span class=\"s\">\"1\"</span> <span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;max</span> <span class=\"na\">value=</span><span class=\"s\">\"4\"</span> <span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;/focus&gt;</span>\n    <span class=\"nt\">&lt;focus&gt;</span>\n        <span class=\"nt\">&lt;code</span> <span class=\"na\">value=</span><span class=\"s\">\"Patient\"</span> <span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;profile</span> <span class=\"na\">value=</span><span class=\"s\">\"https://fhir.nhs.uk/StructureDefinition/NHSDigital-Patient\"</span> <span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;min</span> <span class=\"na\">value=</span><span class=\"s\">\"1\"</span> <span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;max</span> <span class=\"na\">value=</span><span class=\"s\">\"1\"</span> <span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;/focus&gt;</span>\n</code></pre></div>\n<p>I don't think focus is the right way of doing this, the focus is really just the MedicationRequest but its clear what the payload requirements are and we as we use MessageDefinitions in our FHIR Validation it can be tested.<br>\nIt also means we can use the same MedicationRequest profile for both restful and message.</p>",
        "id": 246552457,
        "sender_full_name": "Kevin Mayfield",
        "timestamp": 1626765412
    },
    {
        "content": "<p>The focus <em>must</em> be pointed to by Reference.reference as the reference must be resolvable and must be in the Bundle</p>",
        "id": 246604854,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1626793990
    },
    {
        "content": "<p>Yes but I'm not convinced thats the easiest way of telling a developer what should be in the Message Bundle. (I am biased and coming from a v2 background - I'm used to seeing messages broken down by segments and MessageDefinition can be used the same way)  <br>\nPlus its not a lot of code to alter HAPI Validation to take into account the MessageDefinition.</p>",
        "id": 246650673,
        "sender_full_name": "Kevin Mayfield",
        "timestamp": 1626815254
    },
    {
        "content": "<p>MessageDefinition focus only points to the focus of the message, <strong>NOT</strong> all of the resources in the Bundle.  If you want to specify all the resources, you either put a profile on focus that cascades through profiles on other resources to define what's in the Bundle vs. not or you use the .graph element.</p>",
        "id": 246651629,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1626815608
    },
    {
        "content": "<p>For example, if you're doing a message where the event is a patient discharge, the only resource that can be a focus is a single Encounter.  Focus can't be anything else - because Encounter is the status change trigger.</p>",
        "id": 246651769,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1626815673
    }
]