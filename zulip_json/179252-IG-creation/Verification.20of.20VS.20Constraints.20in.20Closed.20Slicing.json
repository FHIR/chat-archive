[
    {
        "content": "<p>I think we've hit upon an IG Publisher error involving the verification of VS constraints in closed slicing.   The error is the failure to emit an error message.   A high level explanation is:</p>\n<p>- the base element that is sliced is bound to a VS <br>\n  - slicing is closed<br>\n  - one of the child slices requires a code that is outside of the base element's bound VS</p>\n<p>Here is the actual example, from the carin-bb IG (the CI build illustrates the problem, I'll excerpt it here).<br>\nThe example is from the ProfessionalEOB profile. <a href=\"https://build.fhir.org/ig/HL7/carin-bb/StructureDefinition-C4BB-ExplanationOfBenefit-Professional-NonClinician.html\">https://build.fhir.org/ig/HL7/carin-bb/StructureDefinition-C4BB-ExplanationOfBenefit-Professional-NonClinician.html</a><br>\nLet's look at the slicing of item.adjudication</p>\n<div class=\"codehilite\" data-code-language=\"ruleset\"><pre><span></span><code>* item.adjudication ^slicing.rules = #closed\n* item.adjudication ^slicing.ordered = false   // can be omitted, since false is the default\n* item.adjudication ^slicing.description = \"Slice based on value pattern\"\n* item.adjudication ^slicing.discriminator.type = #pattern\n* item.adjudication ^slicing.discriminator.path = \"category\"\n* item.adjudication.category from C4BBAdjudicationCategoryDiscriminator (required)\n</code></pre></div>\n<div class=\"codehilite\"><pre><span></span><code>* item.adjudication MS\n* item.adjudication contains\n   adjudicationamounttype 1..* MS and\n   denialreason 0..1 MS and\n   inoutnetwork 1..1 MS and\n   allowedunits 0..1 MS\n* item.adjudication[allowedunits] ^short = &quot;The quantity of units, times, days, visits, services, or treatments for the service described by the HCPCS code, revenue code or procedure code, submitted by the provider.  (149)&quot;\n* item.adjudication[allowedunits].category = C4BBAdjudicationDiscriminator#allowedunits\n* item.adjudication[allowedunits].value only decimal\n* item.adjudication[denialreason].category  = C4BBAdjudicationDiscriminator#denialreason\n* item.adjudication[denialreason].reason from X12ClaimAdjustmentReasonCodesCMSRemittanceAdviceRemarkCodes\n* item.adjudication[denialreason].reason 1..1 MS\n* item.adjudication[denialreason] ^short = &quot;Reason codes used to interpret the Non-Covered Amount (92)&quot;\n* item.adjudication[adjudicationamounttype].category from C4BBAdjudication\n* item.adjudication[adjudicationamounttype] ^short = &quot;Amounts&quot;\n* item.adjudication[adjudicationamounttype].amount  MS\n* item.adjudication[adjudicationamounttype].amount 1..1\n* item.adjudication[inoutnetwork] ^short = &quot;Indicates the in network or out of network payment status of the claim. (142)&quot;\n* item.adjudication[inoutnetwork].category from C4BBPayerBenefitPaymentStatus (required)\n</code></pre></div>\n<p>Note:</p>\n<ul>\n<li>slicing is closed, and is on item.adjuidcation.category</li>\n<li>item.adjudication.category is bound to C4BBAdjudicationCategoryDiscriminator</li>\n<li>\n<p>There are four slices:<br>\n** allowedUnits -- category is C4BBAdjudicationDiscriminator#allowedunits<br>\n** denialReason -- category is C4BBAdjudicationDiscriminator#denialreason<br>\n** adjudicationamounttype - category is from VS C4BBAdjudication<br>\n** inoutnetwork - category is from VS C4BBPayerBenefitPaymentStatus</p>\n</li>\n<li>\n<p>C4BBAdjudicationCategoryDiscriminator is comprised of:<br>\n** adjudicationAmountType covered by -- codes from C4BBAdjudication<br>\n** denialRerason and allowedUnits covered by  -- codes from C4BBAdjudicationDiscriminator<br>\n** inoutnetwork isn't covered  --- it's codes are in C4BBPayerBenefitPaymentStatus<br>\nSo, we have a closed slicing.   One of the slices requires codes that are outside of the range of the VS of the discriminator.   Should be an error.<br>\nSushi doesn't check this, and neither does IG publisher.</p>\n</li>\n</ul>",
        "id": 224522275,
        "sender_full_name": "Saul Kravitz",
        "timestamp": 1611948916
    },
    {
        "content": "<p>I think the main issue here is that we have the base w/ an element that is bound to a valueset w/ <code>required</code> strength:</p>\n<div class=\"codehilite\"><pre><span></span><code>* item.adjudication.category from C4BBAdjudicationCategoryDiscriminator (required)\n</code></pre></div>\n<p>And then we have a slice that binds that same element path to a <em>different</em> valueset that is <em>not</em> a subset of the originally required value set:</p>\n<div class=\"codehilite\"><pre><span></span><code>* item.adjudication[inoutnetwork].category from C4BBPayerBenefitPaymentStatus (required)\n</code></pre></div>\n<p>Those bindings are technically incompatible since the slice VS does not <em>constrain</em> the base VS; it all out <em>replaces</em> it.</p>\n<p>SUSHI doesn't catch this because SUSHI does not do terminology-based validation.  Since it is possible to override a required binding in a valid way (if the new VS is a subset of the original VS), SUSHI doesn't complain.  But since the IG Publisher <em>does</em> do terminology-based validation, I would expect it to catch things like this.</p>",
        "id": 224525732,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1611950567
    },
    {
        "content": "<p>If you have a binding on a repeating element, it applies to <em>all</em> repetitions.  We have a number of places (particularly category) where there's a binding for a repeating element that isn't obviously intended to apply to all repetitions, but more likely \"at least one of the repetitions\".  The only way to enforce such a binding in a resource definition is an invariant.  I've actually raised a change request for us to try to address this issue (and clean up the places where we're doing it wrong).</p>",
        "id": 224538876,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1611957225
    },
    {
        "content": "<p>With the current definition (that the IG Publisher is happy with) it is <em>impossible</em> to create an instance of the profiled resource that includes the defined slice, since it violates the binding constraint.   The VS binding for the discriminating element is NOT a superset of the VS for the slice, but rather they are disjoint.</p>",
        "id": 224540138,
        "sender_full_name": "Saul Kravitz",
        "timestamp": 1611957720
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191320\">Lloyd McKenzie</span> <a href=\"#narrow/stream/179252-IG-creation/topic/Verification.20of.20VS.20Constraints.20in.20Closed.20Slicing/near/224538876\">said</a>:</p>\n<blockquote>\n<p>We have a number of places (particularly category) where there's a binding for a repeating element that isn't obviously intended to apply to all repetitions, but more likely \"at least one of the repetitions\".  The only way to enforce such a binding in a resource definition is an invariant.</p>\n</blockquote>\n<p>I don't want to go on too much of a side tangent, but can't you also say that via slicing?  E.g., do an open slicing on <code>category</code>, discriminating by <code>pattern</code> on <code>this()</code>, and apply the VS binding in a <code>1..*</code> slice?  Wouldn't that effectively say at least one category must be a member of this VS, but other categories are allowed?</p>",
        "id": 224543027,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1611958513
    },
    {
        "content": "<p>Oh... I missed the <strong>in a <em>resource</em> definition</strong> part.  I guess we don't use slicing in resources, do we?</p>",
        "id": 224543277,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1611958589
    },
    {
        "content": "<p>Bingo.</p>",
        "id": 224588212,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1612017725
    },
    {
        "content": "<p>so I agree that the IG publisher doesn't validate slice fixed codes against against general bindings. I've not been motivated to prioritize this because as you say, there can be no valid instances against a profile like this</p>",
        "id": 224789083,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1612212826
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191316\">Grahame Grieve</span> <a href=\"#narrow/stream/179252-IG-creation/topic/Verification.20of.20VS.20Constraints.20in.20Closed.20Slicing/near/224789083\">said</a>:</p>\n<blockquote>\n<p>so I agree that the IG publisher doesn't validate slice fixed codes against against general bindings. I've not been motivated to prioritize this because as you say, there can be no valid instances against a profile like this</p>\n</blockquote>\n<p>I would think that  detecting a profile that cannot have any valid instances would be something we <em>would</em> want to do, as the whole profile is useless at that point.  Or are you thinking that if the author includes examples (as is best case), then the examples would prove out the validity or invalidity of the profile?</p>\n<p>That said, not to be too contrarian, but if a <code>CodeableConcept</code> is fixed in a slice using <code>pattern[x]</code>, then I think it still is possible to have a valid instance -- since a <code>patternCodeableConcept</code> does not <em>prohibit</em> you from having a coding that matches the general binding (e.g., an instance could have a CodeableConcept with <code>coding[0]</code> meeting the <code>pattern[x]</code> requirement and <code>coding[1]</code> meeting the <code>binding</code> requirement).</p>",
        "id": 224892826,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1612282140
    },
    {
        "content": "<p>But much of that is beside the point here, because we're not talking about fixed codes.  In the specific case Saul mentioned, the sliced element has a required binding to one value set and one of the slices overrides that binding with a required binding to a different (and disjoint) value set.  So it's a matter of required value sets clashing.</p>",
        "id": 224893194,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1612282279
    },
    {
        "content": "<p>I agree it would be nice, but yes, the example validation should manifest the problem, which is why I have not prioritised it against all the other things I get asked to do</p>",
        "id": 224932604,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1612298097
    },
    {
        "content": "<p>Example validation will only manifest it if the element in question appears in the example - which isn't guaranteed if it's not mandatory</p>",
        "id": 224932689,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1612298151
    }
]