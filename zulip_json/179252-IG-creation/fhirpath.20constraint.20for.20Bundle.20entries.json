[
    {
        "content": "<p>Hi all,<br>\nI am trying to create a Bundle profile for the requirement, that for every non-provenance resource in the bundle there must be a provenance that references the resource as a target. <br>\nI tried to implement this profile with a constraint that iterates over all entries and if the entry is not a provenance it selects the first target reference from all provenances in the bundle and checks if the id of the resource is in this collection. <br>\nFor the constraint I used the following expression</p>\n<div class=\"codehilite\"><pre><span></span><code>entry.all((resource is Provenance) or (resource.resourceType.toString() &amp; &#39;/&#39; &amp; resource.id)\n.subsetOf(entry.select((resource as Provenance).target.first().reference)))\n</code></pre></div>\n<p>However, the expression always fails if the bundle contains a non-provenance resource even if a correct provenance is part of the bundle. <br>\nDoes anyone know how to change the expression to fulfil the requirement or if there is a better way to enforce the requirement in the bundle?</p>",
        "id": 274117176,
        "sender_full_name": "Niklas Haldorn",
        "timestamp": 1646394528
    },
    {
        "content": "<p>The issue is that your <code>entry.select...</code> bit is executing in the context of <code>entry.all...</code>.  Try <code>%resource.entry.select...</code></p>\n<p>Note that your expression presumes that all entries in the Bundle will be referenced using relative references and, in general, that's not a safe assumption.</p>",
        "id": 274138331,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1646405145
    }
]