[
    {
        "content": "<p>Something went bonkers on my machine with build times back north of 30 mins -- curious if others are running faster so maybe i can use it as an excuse to buy a new computer.</p>",
        "id": 217198311,
        "sender_full_name": "Brett Marquard",
        "timestamp": 1605734494
    },
    {
        "content": "<p><a href=\"/user_uploads/10155/-ErUbUDny37seP1KRG8FJqcR/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/-ErUbUDny37seP1KRG8FJqcR/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/-ErUbUDny37seP1KRG8FJqcR/image.png\"></a></div>",
        "id": 217198317,
        "sender_full_name": "Brett Marquard",
        "timestamp": 1605734497
    },
    {
        "content": "<p>Finished. Times: loading: 00:06.0862, generate: 32:48.0837, narrative generation: 02:00.0639, realm-rules: 03:30.0472, previous-version: 07:56.0152, jekyll: 01:56.0840, validation: 02:04.0937 (#151), template: 00:07.0255 (#3) (34:15.0830)</p>",
        "id": 217207112,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1605739436
    },
    {
        "content": "<p>Finished. Times: loading: 00:06.0080, generate: 14:28.0645, narrative generation: 00:34.0660, realm-rules: 02:27.0772, previous-version: 05:40.0346, jekyll: 00:20.0364, validation: 01:36.0571 (#151), template: 00:08.0992 (#3) (15:53.0880)</p>",
        "id": 217208844,
        "sender_full_name": "Adam Stevenson",
        "timestamp": 1605740582
    },
    {
        "content": "<p>are these first or second build times?</p>",
        "id": 217208957,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1605740647
    },
    {
        "content": "<p>Good point. Second here.</p>",
        "id": 217209003,
        "sender_full_name": "Adam Stevenson",
        "timestamp": 1605740695
    },
    {
        "content": "<p>That was a first build, but here's the second build:<br>\nFinished. Times: loading: 00:10.0346, generate: 30:01.0685, narrative generation: 03:06.0551, realm-rules: 00:24.0906, previous-version: 00:50.0318, jekyll: 02:01.0409, validation: 01:14.0109 (#151), template: 00:08.0438 (#3) (32:14.0371)</p>",
        "id": 217213741,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1605744106
    },
    {
        "content": "<p>My last build (on ToF) was 9:58.<br>\nI say - buy the new computer! Having said that, I got a new one in July and it really hasn't made much of a difference to local build times (and it still slows my PC down so much that it's annoying to use), so I just don't ever build locally.</p>",
        "id": 217219519,
        "sender_full_name": "Sarah Gaunt",
        "timestamp": 1605749247
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> mentioned in another thread that the IG Publisher is single-threaded... Probably won't see much improved build times unless one or both of the following:</p>\n<ol>\n<li>code is performance-tuned</li>\n<li>code is refined to be multi-threaded</li>\n</ol>\n<p>Maybe some progress has already been made on #1... <em>shrug</em> dunno.</p>",
        "id": 217220199,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1605750080
    },
    {
        "content": "<p>I spend some time working on performance issues.</p>",
        "id": 217220209,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1605750099
    },
    {
        "content": "<p>but making it multithreaded isn't going to happen, and would make things worse anyway, when the primary complaint is being unresponsive. As a single threaded application, that shouldn't happen</p>",
        "id": 217220266,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1605750140
    },
    {
        "content": "<p>Making it multi-threaded for things like generating snapshots might be a great way to see some quick improvements</p>",
        "id": 217220267,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1605750141
    },
    {
        "content": "<p>well... scratch that</p>",
        "id": 217220269,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1605750148
    },
    {
        "content": "<p>lol</p>",
        "id": 217220270,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1605750149
    },
    {
        "content": "<p>it could reduce overall build times, at the price of (a) much more complexity and (b) hammering the local machine</p>",
        "id": 217220290,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1605750191
    },
    {
        "content": "<p>In other Java projects we've been able to implement multi-threading pretty easily using parallel streams...</p>",
        "id": 217220338,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1605750244
    },
    {
        "content": "<p>not sure if parallel streams could be used as easily in the ig publisher</p>",
        "id": 217220373,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1605750261
    },
    {
        "content": "<p>but, maybe worth checking out...</p>",
        "id": 217220378,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1605750266
    },
    {
        "content": "<p>(if you haven't already)</p>",
        "id": 217220383,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1605750273
    },
    {
        "content": "<p>you can even use throttled parallel streams, and tell it to only use a single thread for debugging purposes, but multiple threads by default</p>",
        "id": 217220415,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1605750306
    },
    {
        "content": "<p>pretty cool stuff</p>",
        "id": 217220422,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1605750310
    },
    {
        "content": "<p>(imo)</p>",
        "id": 217220430,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1605750313
    },
    {
        "content": "<p>the question isn't how to use parallel streams, it's all the nested dependencies.</p>",
        "id": 217220435,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1605750319
    },
    {
        "content": "<p>Here are my US Core build times from today (modern Mac with a single-core <a href=\"https://browser.geekbench.com/v5/cpu/\">Geekbench</a> score of ≈1100):</p>\n<ul>\n<li><strong>First build:</strong> Times: loading: 00:02.0960, generate: 10:49.0754, narrative generation: 00:49.0960, realm-rules: 00:02.0121, previous-version: 06:11.0127, jekyll: 00:07.0948, validation: 01:27.0814 (#230), template: 00:01.0990 (#3) (<strong>11:02.0285</strong>, including ≈9:00 waiting for <a href=\"http://tx.fhir.org\">tx.fhir.org</a> <a href=\"#narrow/stream/179297-committers.2Fnotification/topic/ig-build.20speed/near/217338827\">explained here</a>)</li>\n<li><strong>Second build:</strong> Times: loading: 00:03.0042, generate: 03:26.0758, narrative generation: 00:52.0438, realm-rules: 00:01.0165, previous-version: 00:03.0495, jekyll: 00:09.0633, validation: 00:43.0393 (#230), template: 00:02.0020 (#3) (<strong>03:39.0894</strong>, including ≈1:20 waiting for <a href=\"http://tx.fhir.org\">tx.fhir.org</a>)</li>\n<li><strong>Third build + local cache of <a href=\"http://tx.fhir.org\">tx.fhir.org</a> (<a href=\"#narrow/stream/179297-committers.2Fnotification/topic/ig-build.20speed/near/217338827\">explained here</a>)</strong>: Times: loading: 00:02.0952, generate: 01:18.0222, narrative generation: 00:07.0571, realm-rules: 00:01.0227, previous-version: 00:02.0892, jekyll: 00:08.0305, validation: 00:02.0645 (#230), template: 00:02.0792 (#3) (<strong>01:30.0681</strong>, ≈2 minutes saved by local cache)</li>\n</ul>\n<p>I do see both the <code>java</code> and <code>Publisher</code> processes using &gt;&gt;100% CPU during builds, so not sure what is going since these are not multi-threaded.</p>",
        "id": 217348182,
        "sender_full_name": "Max Masnick",
        "timestamp": 1605831182
    },
    {
        "content": "<p>For US Core we removed the dependency to vsac because it was causing out of memory issues locally.  My build is around 10 minutes... and get build failure when turn off tx server.  the autobuild also around ten minutes.  so I don't know why you times are so much faster?</p>",
        "id": 217352703,
        "sender_full_name": "Eric Haas",
        "timestamp": 1605836066
    },
    {
        "content": "<p>For another point of reference here's build times for a 2018 MacBook Air (1.6 GHz dual core i5; <a href=\"https://browser.geekbench.com/macs/macbook-air-late-2018\">735 single core/1468 multi-core on Geekbench</a>):</p>\n<ul>\n<li><strong>First build:</strong> Times: loading: 00:09.0370, generate: 15:59.0893, narrative generation: 01:16.0830, realm-rules: 00:08.0872, previous-version: 07:52.0633, jekyll: 00:15.0848, validation: 01:35.0705 (#229), template: 00:14.0535 (#3) (<strong>16:45.0519</strong>)</li>\n<li><strong>Second build:</strong> Times: loading: 00:07.0764, generate: 05:34.0797, narrative generation: 01:03.0777, realm-rules: 00:03.0792, previous-version: 00:10.0190, jekyll: 00:17.0461, validation: 00:50.0034 (#229), template: 00:05.0385 (#3) (<strong>06:07.0965</strong>)</li>\n<li><strong>Third build, + local cache:</strong> Times: loading: 00:09.0357, generate: 04:19.0890, narrative generation: 00:31.0255, realm-rules: 00:05.0667, previous-version: 00:12.0385, jekyll: 00:19.0188, validation: 00:17.0205 (#229), template: 00:05.0508 (#3) (<strong>05:02.0358</strong> + 2 minutes saved by local cache)</li>\n</ul>\n<p>So it looks like you can reduce build time by ≈30-40% by upgrading to a faster multi-core machine if you're on a 2 core, low clock speed laptop. Speeding up <a href=\"http://tx.fhir.org\">tx.fhir.org</a> could save another 2 minutes per warm build.</p>\n<p><span class=\"user-mention\" data-user-id=\"191401\">@Eric Haas</span> <span class=\"user-mention\" data-user-id=\"191918\">@Sarah Gaunt</span> if you're seeing significantly worse build times than my MacBook Air, it seems like something may be wrong with your system. You can compare your computer on Geekbench with mine to get a sense of what it should look like if there's nothing artificially slowing down your machine.</p>",
        "id": 217386351,
        "sender_full_name": "Max Masnick",
        "timestamp": 1605869706
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191401\">Eric Haas</span> <a href=\"#narrow/stream/179252-IG-creation/topic/Post.20your.20build.20time/near/217352703\">said</a>:</p>\n<blockquote>\n<p>For US Core we removed the dependency to vsac because it was causing out of memory issues locally.  My build is around 10 minutes... and get build failure when turn off tx server.  the autobuild also around ten minutes.  so I don't know why you times are so much faster?</p>\n</blockquote>\n<p>I don't think the IG will build without <a href=\"http://tx.fhir.org\">tx.fhir.org</a>. The point of my experimentation with an additional caching layer (running locally) in front of <a href=\"http://tx.fhir.org\">tx.fhir.org</a> was to see what an \"offline mode\" _could_ look like...but it's not truly offline because each IG build generates at least a few novel requests to <a href=\"http://tx.fhir.org\">tx.fhir.org</a> that have to be proxied through.</p>",
        "id": 217387650,
        "sender_full_name": "Max Masnick",
        "timestamp": 1605870499
    },
    {
        "content": "<p>the issue with <a href=\"http://tx.fhir.org\">tx.fhir.org</a> is latency, not server performance.</p>",
        "id": 217401233,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1605879463
    },
    {
        "content": "<p>For another data point (first build):</p>\n<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"go\">Finished. Times: loading: 00:06.0887, generate: 14:00.0562, narrative generation: 00:54.0778, realm-rules: 00:05.0427, previous-version: 06:11.0677, jekyll: 01:32.0707, validation: 01:51.0282 (#229), template: 00:07.0190 (#3) (14:19.0185)</span>\n</code></pre></div>\n<p>Second:</p>\n<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"go\">Finished. Times: loading: 00:06.0363, generate: 05:25.0548, narrative generation: 00:51.0962, realm-rules: 00:01.0985, previous-version: 00:05.0313, jekyll: 01:32.0432, validation: 00:43.0770 (#229), template: 00:03.0635 (#3) (05:49.0751)</span>\n</code></pre></div>",
        "id": 217401266,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1605879479
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> I see some requests to <a href=\"http://tx.fhir.org\">tx.fhir.org</a> waiting 30+ seconds for a response...that seems much to long to attribute to network latency.</p>",
        "id": 217430506,
        "sender_full_name": "Max Masnick",
        "timestamp": 1605892189
    },
    {
        "content": "<p>indeed. probably snomed expansions</p>",
        "id": 217430731,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1605892293
    },
    {
        "content": "<p>This is for eCR (not US Core) (2020 MacBook Pro Intel Core i7-1068NG7 @ 2.30 GHz 1 processor, 4 cores, 8 threads, 31.81 GB): just tested on Geekbench: <strong>Single-core: 1065/Multi-core: 4104</strong></p>\n<ul>\n<li>First build: Times: loading: 00:12.0874, generate: 12:50.0376, narrative generation: 00:39.0349, realm-rules: 01:41.0674, previous-version: 03:36.0062, jekyll: 01:27.0820, validation: 02:21.0332 (#154), template: 00:11.0274 (#3) (<strong>14:37.0987</strong>)</li>\n<li>Second build: Times: loading: 00:09.0631, generate: 05:51.0712, narrative generation: 00:28.0184, realm-rules: 00:05.0012, previous-version: 00:09.0966, jekyll: 01:33.0473, validation: 00:34.0548 (#154), template: 00:05.0146 (#3) (<strong>07:11.0854</strong>)</li>\n</ul>\n<p><strong>Conclusion</strong>: <span class=\"user-mention\" data-user-id=\"191410\">@Brett Marquard</span> gets a new computer!</p>\n<p>Having said that - my problem with running locally isn't is necessarily how long the build takes (though it's an issue), it's the fact that running the above (no matter whether it's first or later build) I see this (it's around 80%-100% CPU  and 90%-100% Memory): </p>\n<p><a href=\"/user_uploads/10155/fUsmGi9ccQZHnqt9yc2d25A1/image.png\">image.png</a> </p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/fUsmGi9ccQZHnqt9yc2d25A1/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/fUsmGi9ccQZHnqt9yc2d25A1/image.png\"></a></div><p>which means my pc is close to unusable for those 7-15 mins.</p>\n<p>BUT, I get around this by never running locally...</p>",
        "id": 217461999,
        "sender_full_name": "Sarah Gaunt",
        "timestamp": 1605908192
    },
    {
        "content": "<p>Okay building US Core (fresh checkout):<br>\nFirst Run:<br>\nFinished. Times: loading: 00:03.0497, generate: 13:30.0864, narrative generation: 01:03.0939, realm-rules: 00:04.0355, previous-version: 07:42.0919, jekyll: 00:05.0861, validation: 01:39.0138 (#229), template: 00:05.0071 (#3) (13:48.0197)<br>\nreal    13m50.052s<br>\nuser    4m15.016s<br>\nSecond Run: <br>\nFinished. Times: loading: 00:03.0749, generate: 03:14.0447, narrative generation: 00:46.0934, realm-rules: 00:01.0531, previous-version: 00:03.0339, jekyll: 00:05.0260, validation: 00:40.0525 (#229), template: 00:01.0831 (#3) (03:26.0472)<br>\nreal    3m29.327s<br>\nuser    5m17.078s</p>",
        "id": 217504603,
        "sender_full_name": "David Pyke",
        "timestamp": 1605970024
    },
    {
        "content": "<p>the current autopublisher: 12:53.0302</p>",
        "id": 217530454,
        "sender_full_name": "Eric Haas",
        "timestamp": 1606012835
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191918\">Sarah Gaunt</span> <a href=\"#narrow/stream/179252-IG-creation/topic/Post.20your.20build.20time/near/217461999\">said</a>:</p>\n<blockquote>\n<p>Having said that - my problem with running locally isn't is necessarily how long the build takes (though it's an issue), it's the fact that running the above (no matter whether it's first or later build) I see this (it's around 80%-100% CPU  and 90%-100% Memory): </p>\n<p><a href=\"/user_uploads/10155/fUsmGi9ccQZHnqt9yc2d25A1/image.png\">image.png</a> </p>\n</blockquote>\n<p>This seems strange...my MacBook Air is still more or less usable while doing an IG build, and it's <em>way</em> less powerful than your machine. Based on your screenshot it seems like you're running Windows on Mac hardware? Are you virtualizing Windows or using Boot Camp?</p>",
        "id": 217614173,
        "sender_full_name": "Max Masnick",
        "timestamp": 1606129235
    },
    {
        "content": "<p>Oh yeah, forgot to mention - runnning BootCamp. It was the same problem with my Dell though (which wasn't all that much less specced out than the Mac).</p>",
        "id": 217675957,
        "sender_full_name": "Sarah Gaunt",
        "timestamp": 1606161650
    },
    {
        "content": "<p>Finished. Times: loading: 00:03.0771, generate: 06:43.0486, narrative generation: 00:59.0644, realm-rules: 00:02.0931, previous-version: 00:04.0632, jekyll: 00:32.0090, validation: 00:51.0635 (#229), template: 00:06.0390 (#3) (07:19.0834)</p>",
        "id": 217681167,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1606164624
    },
    {
        "content": "<p>there's some problem with NDC. I'm investigating</p>",
        "id": 217681188,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1606164636
    },
    {
        "content": "<blockquote>\n<p>.Having said that - my problem with running locally isn't is necessarily how long the build takes (though it's an issue), it's the fact that running the above (no matter whether it's first or later build) I see this (it's around 80%-100% CPU and 90%-100% Memory):</p>\n</blockquote>\n<p>my macbook air is unusable during the build too.. I don't use bootcamp or virtual machines.  Sarah's machine is more powerful than mine but having said that having the latest and greatest hardware should not be a prerequisite for publishing.</p>",
        "id": 217709079,
        "sender_full_name": "Eric Haas",
        "timestamp": 1606186034
    },
    {
        "content": "<p>there's something weird going on here. I hardly notice when I have the publisher running in the background. It's almost exclusively a single threaded application. What it does do is hammer the IO subsystem. but that shouldn't be a problem. I wonder whether you have something else going on - anti-virus?</p>",
        "id": 217709702,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1606186847
    },
    {
        "content": "<p>Maybe - will look into it. Looking at my screen shot I notice there is only 21% used by of whatever that top process is (I presume that was the publisher)... Hmmmm.... Will check it out at end of week.</p>",
        "id": 217713994,
        "sender_full_name": "Sarah Gaunt",
        "timestamp": 1606192573
    },
    {
        "content": "<p>same here - my MacBook Pro is about 10-20% at worst.  When Jekyll runs, there is a slight hiccup every now and then, but that's it.</p>",
        "id": 217811848,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1606251148
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191918\">@Sarah Gaunt</span> are you running antivirus in Windows? Or are you building the IG inside a cloud sync folder (like Dropbox or OneDrive)? It sounds like your IG builds are triggering something else that is swamping your CPU.</p>",
        "id": 217919334,
        "sender_full_name": "Max Masnick",
        "timestamp": 1606327430
    },
    {
        "content": "<p>Yeah, I'm thinking Dropbox might be the culprit actually, just haven't had a chance to look at it properly again... I did turn Dropbox off yesterday to try to test but my IG just crashed so I had other fish to fry and didn't get back to testing locally... Maybe next week when I don't have so many ballot commitments.</p>",
        "id": 217929501,
        "sender_full_name": "Sarah Gaunt",
        "timestamp": 1606333011
    }
]