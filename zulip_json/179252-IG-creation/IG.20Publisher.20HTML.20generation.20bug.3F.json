[
    {
        "content": "<p>I'm hitting a strange issue where an IG page contents gets \"trapped\" in a dropdown menu. <a href=\"http://build.fhir.org/ig/dvci/vaccine-credential-ig/branches/dev/StructureDefinition-vaccination-credential-immunization-dm-definitions.html\">Here's a live example</a> and a screenshot: <a href=\"/user_uploads/10155/9F022JkOUQB8pAmqmjl-DHwJ/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/9F022JkOUQB8pAmqmjl-DHwJ/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/9F022JkOUQB8pAmqmjl-DHwJ/image.png\"></a></div>",
        "id": 242997396,
        "sender_full_name": "Max Masnick",
        "timestamp": 1623925132
    },
    {
        "content": "<p>This happens reprodubily when I have a broken link in the page that causes a QA error. (It may happen for other reasons too...I don't think there's a broken link in the page above.)</p>",
        "id": 242997475,
        "sender_full_name": "Max Masnick",
        "timestamp": 1623925195
    },
    {
        "content": "<p>Looking at the source for the <strong>generated</strong> HTML page, I see closing tags missing on lines 181-187: <a href=\"/user_uploads/10155/9JdxL1TjS7fVvd6trEWRsj7e/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/9JdxL1TjS7fVvd6trEWRsj7e/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/9JdxL1TjS7fVvd6trEWRsj7e/image.png\"></a></div>",
        "id": 242997586,
        "sender_full_name": "Max Masnick",
        "timestamp": 1623925261
    },
    {
        "content": "<p>But if I look at <code>fragment-pagebegin.html</code> in the custom template used for this IG, the closing tags <em>are</em> there: <a href=\"/user_uploads/10155/o1TUzA1j-FfWfPJO2kBqhDZa/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/o1TUzA1j-FfWfPJO2kBqhDZa/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/o1TUzA1j-FfWfPJO2kBqhDZa/image.png\"></a></div>",
        "id": 242997652,
        "sender_full_name": "Max Masnick",
        "timestamp": 1623925316
    },
    {
        "content": "<p>And again, I can usually resolve this by fixing  a broken link that appears somewhere on the page. And no matter where the broken link appears on the page, I observe the same  behavior.</p>",
        "id": 242997953,
        "sender_full_name": "Max Masnick",
        "timestamp": 1623925534
    },
    {
        "content": "<p>This is reproducible locally for me, as well as on the <a href=\"http://build.fhir.org\">build.fhir.org</a> CI build. The repo for the IG is <a href=\"https://github.com/dvci/vaccine-credential-ig\">https://github.com/dvci/vaccine-credential-ig</a>, and if you check out <code>864bf3008a714447c18d1d1245d076ba7fa3d840</code> and build locally you should see the same thing on <code>StructureDefinition-vaccination-credential-immunization-dm-definitions.html</code></p>",
        "id": 242998092,
        "sender_full_name": "Max Masnick",
        "timestamp": 1623925631
    },
    {
        "content": "<p>Does anyone have a sense of whether this is an IG Publisher bug, or if there's somthing I could be doing within the IG that could cause this behavior?</p>",
        "id": 242998346,
        "sender_full_name": "Max Masnick",
        "timestamp": 1623925802
    },
    {
        "content": "<p>I switched to the nominated commit but couldn't reproduce</p>",
        "id": 243087500,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1623965350
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> I reproduced again, both locally and on <a href=\"http://build.fhir.org\">build.fhir.org</a></p>\n<div class=\"codehilite\"><pre><span></span><code>$ git clone git@github.com:dvci/vaccine-credential-ig.git vci-test2\nCloning into &#39;vci-test2&#39;...\nremote: Enumerating objects: 2247, done.\nremote: Counting objects: 100% (1205/1205), done.\nremote: Compressing objects: 100% (458/458), done.\nremote: Total 2247 (delta 718), reused 1021 (delta 633), pack-reused 1042\nReceiving objects: 100% (2247/2247), 441.68 KiB | 6.05 MiB/s, done.\nResolving deltas: 100% (1439/1439), done.\n$ cd vci-test2\n$ git checkout 864bf3008a714447c18d1d1245d076ba7fa3d840\n$ ./_genonce.sh\nChecking internet connection...\nOnline\n\nFHIR IG Publisher Version 1.1.75 (Git# 3a2ca820510e). Built 2021-06-17T23:27:51.9Z (13 hours old)\nDetected Java version: 14.0.2 from /Library/Java/JavaVirtualMachines/jdk-14.0.2.jdk/Contents/Home on Mac OS X/x86_64 (64bit). 12288MB available\n...\n</code></pre></div>\n<p>For <a href=\"http://build.fhir.org\">build.fhir.org</a>, I created a branch where HEAD is <code>864bf3008a</code>: <a href=\"http://build.fhir.org/ig/dvci/vaccine-credential-ig/branches/2021-06-18-bug-reproduction/StructureDefinition-vaccination-credential-immunization-dm-definitions.html\">http://build.fhir.org/ig/dvci/vaccine-credential-ig/branches/2021-06-18-bug-reproduction/StructureDefinition-vaccination-credential-immunization-dm-definitions.html</a> <a href=\"/user_uploads/10155/Z2BhKtZDHR8u_kKfD7lSxqem/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/Z2BhKtZDHR8u_kKfD7lSxqem/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/Z2BhKtZDHR8u_kKfD7lSxqem/image.png\"></a></div>",
        "id": 243155060,
        "sender_full_name": "Max Masnick",
        "timestamp": 1624020482
    },
    {
        "content": "<p>ok. thanks. I could reproduce that. So I can explain what is happening here.</p>",
        "id": 243268803,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1624136314
    },
    {
        "content": "<p>the pages contain invalid html. The tags on lines 166 to 171 are not closed</p>",
        "id": 243268813,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1624136343
    },
    {
        "content": "<p>I use a dom based parser to parse the html, and it's guessing where the tags end, and inserting matching ending tags on line 1705. Any page with a broken link has an anchor tag inserted, and is saved, whereas pages without a broken link are not saved.</p>",
        "id": 243268903,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1624136489
    },
    {
        "content": "<p>the problem is in your menu.xml, which is not valid xml</p>",
        "id": 243268976,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1624136613
    },
    {
        "content": "<p>That fixed it, thanks! I should have caught the missing closing tags in menu.xml -- I didn't inspect that closely because I was so thrown by the closing tags stripped from the template, but garbage in garbage out <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span></p>",
        "id": 243329601,
        "sender_full_name": "Max Masnick",
        "timestamp": 1624236008
    }
]