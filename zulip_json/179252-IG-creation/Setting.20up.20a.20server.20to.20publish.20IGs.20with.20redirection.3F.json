[
    {
        "content": "<p>We're developing a couple of organizational IGs (non-HL7) that we want to host. If possible, I'd like to do this using the same tooling and methods as HL7 uses. For example, we'd like to have a CI/CD environment. Travis? Jenkins? does it matter? Also, I'd like to use the same tooling that HL7 uses for redirection of structuredefinition urls (e.g., <code>http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient</code> gets redirected to <code>http://hl7.org/fhir/us/core/STU3.1/StructureDefinition-us-core-patient.html</code>). From reading <a href=\"#narrow/stream/179252-IG-creation/topic/IG.20releases\">this thread</a>, I see a comment from <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span>  saying there's a <code>publish.ini</code> file that is used to generate code to do this depending on whether the server parameter is set to Apache or ASP. Does this need to exist before running the igpublisher? or is it something read by other tooling? And where exactly does it go? I've seen someone mention<code>input/pages/publish.ini</code> I can't seem to find any clear documentation around it. I've seen the <a href=\"https://confluence.hl7.org/display/FHIR/Process+for+Publishing+a+FHIR+IG\">Process for Publishing a FHIR IG</a> and  <a href=\"https://wiki.hl7.org/FHIR_Guide_to_Authoring_Types\">FHIR Guide to Authoring Types</a>, but it doesn't have much of a documentation around <code>publish.ini</code> (just a bit around <code>[pages]</code> and talks about \"shared types\" which I admit I don't understand. Any clarification will be greatly appreciated.</p>",
        "id": 199802229,
        "sender_full_name": " Bob Milius",
        "timestamp": 1591301253
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191916\">@ Bob Milius</span> I recently went through the process of manually publishing an IG - i did it manually and may have cut some corners, but it turns out to be not so complicated in the essence</p>",
        "id": 199803397,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1591301956
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191832\">@Jose Costa Teixeira</span> I've been able to manually upload an IG to an S3 bucket. I'm looking more toward the redirection bit, and adding a CI/CD environment, as well as having a process for current builds, and milestone releases for our organization. Have you been able to do that?</p>",
        "id": 199803635,
        "sender_full_name": " Bob Milius",
        "timestamp": 1591302088
    },
    {
        "content": "<p>I'm not sure but I think the redirects are a result of the packages</p>",
        "id": 199803643,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1591302093
    },
    {
        "content": "<p>CI- CD - interesting, I'm on to it as well. Your idea to use Jenkins may just help me a lot</p>",
        "id": 199803748,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1591302134
    },
    {
        "content": "<p>my first step was to get the publisher to do this (notice the publish box):<br>\n<a href=\"https://hl7belgium.org/fhir/2020May\">https://hl7belgium.org/fhir/2020May</a></p>",
        "id": 199803812,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1591302179
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191832\">@Jose Costa Teixeira</span> the IG looks nice! But I'm not seeing the redirection. e.g., I think the url <code>https://www.ehealth.fgov.be/standards/fhir/StructureDefinition/be-patient</code> should redirect to <code>https://hl7belgium.org/fhir/2020May/StructureDefinition-be-patient.html</code>, shouldn't it?</p>",
        "id": 199804455,
        "sender_full_name": " Bob Milius",
        "timestamp": 1591302559
    },
    {
        "content": "<p>or <code>[igname]/StructureDefinition/[profile]</code> should redirect to <code>[igname]/StructureDefinition-[profile]</code></p>",
        "id": 199804697,
        "sender_full_name": " Bob Milius",
        "timestamp": 1591302690
    },
    {
        "content": "<p>i  did not setup the redirects. Perhaps we can do that soon?</p>",
        "id": 199805217,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1591302973
    },
    {
        "content": "<p>and indeed I have to clean up the urls - this IG actually uses resources that are from another IG, and I am not sure how best to handle it</p>",
        "id": 199805298,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1591303019
    },
    {
        "content": "<p>I'll check my notes about getting the publisher to move through the release cycle (ci-build, qa-preview, final...) and I will share them</p>",
        "id": 199805456,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1591303086
    },
    {
        "content": "<p>(I took those notes sometime before my computer got attacked, so i don't have them here). But I started with a simple vanilla process, and now I hope to enrich with all these details - that is the process that works for me: remove parts until I see how it works, then add those parts again</p>",
        "id": 199805670,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1591303221
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191916\">@ Bob Milius</span>:</p>\n<ul>\n<li>the publishing thing is a separate mode that you run the IG publisher in at a different time in the process.</li>\n<li>it's true that this is very poorly documented</li>\n<li>the redirects aren't going to work on an S3 bucket. They need active logic on the server, and there's no way I've found to do that on an S3 bucket</li>\n<li>Setting up a CI build if you can't use the public one is a much bigger piece of work - that's real infrastructure...</li>\n</ul>",
        "id": 199807294,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1591304110
    },
    {
        "content": "<p>so, what is required? I am trying to get IHE publication site and need to give system requirements.</p>",
        "id": 199811743,
        "sender_full_name": "John Moehrke",
        "timestamp": 1591306736
    },
    {
        "content": "<p>you need a web server. Currently, we support Apache, Nginx, Lightspeed, and IIS</p>",
        "id": 199813154,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1591307511
    },
    {
        "content": "<p>and technically, the sub-directory that hosts the FHIR content needs to be able to run ASP or PHP scripts. I can provide more specific requirements by web server</p>",
        "id": 199813297,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1591307576
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191316\">Grahame Grieve</span> <a href=\"#narrow/stream/179252-IG-creation/topic/Setting.20up.20a.20server.20to.20publish.20IGs.20with.20redirection.3F/near/199807294\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"191916\"> Bob Milius</span>:</p>\n<ul>\n<li>the redirects aren't going to work on an S3 bucket. They need active logic on the server, and there's no way I've found to do that on an S3 bucket</li>\n</ul>\n</blockquote>\n<p>The S3 thing was just to quickly share. We are planning on deploying a dockerized Apache server. Any advice on this would be welcome</p>\n<blockquote>\n<ul>\n<li>Setting up a CI build if you can't use the public one is a much bigger piece of work - that's real infrastructure...</li>\n</ul>\n</blockquote>\n<p>I'm assuming we can't use the public one for a non-HL7 IG. Is that true?<br>\nWe have devops guys who can set up the infrastructure. I was just wondering if there are preferred public tools/workflows we can reuse. They are talking Atlassian Bamboo for CI/CD. Maybe that would be easiest for us.</p>",
        "id": 199816078,
        "sender_full_name": " Bob Milius",
        "timestamp": 1591309384
    },
    {
        "content": "<p>According to <a href=\"https://docs.aws.amazon.com/AmazonS3/latest/dev/how-to-page-redirect.html\">this S3 documentation</a>, you can setup redirects with Amazon S3.  I've never tried it before though.</p>\n<p>I just experimented with a poor man's approach that <em>seems</em> to work, assuming you're hosting your IG at a URL matching its canonical root.  It takes advantage of two things:</p>\n<ol>\n<li>Most web servers are setup such that if you request a path matching a folder, it will serve the <code>index.html</code> from that folder</li>\n<li>The <code>META</code> refresh directive</li>\n</ol>\n<p>Basically, if my IG has canonical URL: <code>http://example.org/fhir/myIG/</code> and is also hosted at <code>http://example.org/fhir/myIG/</code>, then <code>MyProfile</code> documentation will be at: <code>http://example.org/fhir/myIG/StructureDefinition-MyProfile.html</code>.  The canonical for <code>MyProfile</code> will be <code>http://example.org/fhir/myIG/StructureDefinition/MyProfile</code>.  So here is what I do:</p>\n<ol>\n<li>Create a <code>StructureDefinition</code> folder at the root of where my IG is served.  Now <code>http://example.org/fhir/myIG/StructureDefinition</code> would go there.</li>\n<li>Create a <code>MyProfile</code> folder under <code>StructureDefinition</code>.  Now <code>http://example.org/fhir/myIG/StructureDefinition/MyProfile</code> would go there -- but there's nothing there to serve yet.</li>\n<li>Create a simple <code>index.html</code> file in the <code>MyProfile</code> folder.  Now <code>http://example.org/fhir/myIG/StructureDefinition/MyProfile</code> will serve that <code>index.html</code> file.</li>\n<li>Put a <code>META</code> directive in that index.html to redirect to MyProfile's documentation page.  E.g.,:</li>\n</ol>\n<div class=\"codehilite\"><pre><span></span><code>&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;META http-equiv=&quot;refresh&quot; content=&quot;0;URL=http://example.org/fhir/myIG/StructureDefinition-MyProfile.html&quot;&gt;\n&lt;body&gt;\nRedirecting to &lt;a href=&quot;http://example.org/fhir/myIG/StructureDefinition-MyProfile.html&quot;&gt;http://example.org/fhir/myIG/StructureDefinition-MyProfile.html&lt;/a&gt;...\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre></div>\n\n\n<p>So... I don't know if that's helpful.  But it was kind of fun figuring out.  And a script could be written to basically setup all that structure so the redirects work on any standard HTTP server.</p>",
        "id": 199816095,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1591309396
    },
    {
        "content": "<p>What are PHP or ASP for?</p>",
        "id": 199817269,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1591310281
    },
    {
        "content": "<p>well, the scripts look at the request on the canonical URL, and decide whether the client wants HTML, JSON, or XML based on the Accept header, and redirects to the appropriate file</p>",
        "id": 199817998,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1591310786
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191469\">@Chris Moesel</span> that's new but typical of Amazon. I have no idea how I would set that in bulk because the only way I can see how to make it work says</p>\n<blockquote>\n<p>Amazon S3 has a limitation of 50 routing rules per website configuration</p>\n</blockquote>\n<p>50? I routinely have 1000s. And I still don't see how to do different redirects based on the Accept header. So I'll still call this unsupported for now</p>",
        "id": 199818233,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1591310943
    },
    {
        "content": "<p>It is easy to mistake generated IG content as plain html that could be served by S3.  The solution may be a requirements document that indicates the need for redirects by scripting language, required mime types and any other background processes.</p>",
        "id": 199818640,
        "sender_full_name": "David Johnson",
        "timestamp": 1591311239
    },
    {
        "content": "<p>We used S3 just as a proof-of-concept to share with others to evaluate the IG during development. When we finally deploy it'll be in a dockerized Apache server. Any advice on using the <code>publish.ini</code> file and steps to run the scripts to generate the proper PHP would be nice so we don't have to reinvent it.</p>",
        "id": 199819340,
        "sender_full_name": " Bob Milius",
        "timestamp": 1591311714
    },
    {
        "content": "<p>dockerised Apache will work fine.</p>",
        "id": 199819544,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1591311849
    },
    {
        "content": "<p>you certainly don't want to re-invent it</p>",
        "id": 199819553,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1591311862
    },
    {
        "content": "<p>I wrote it up for <span class=\"user-mention\" data-user-id=\"191832\">@Jose Costa Teixeira</span> - do you know where that was?</p>",
        "id": 199819563,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1591311877
    },
    {
        "content": "<p>I think you mean the instructions in the thread that Bob mentions on the top of this thread?</p>",
        "id": 199819708,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1591311993
    },
    {
        "content": "<p><a href=\"#narrow/stream/179252-IG-creation/topic/IG.20releases/near/196823326\">https://chat.fhir.org/#narrow/stream/179252-IG-creation/topic/IG.20releases/near/196823326</a></p>",
        "id": 199819947,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1591312178
    },
    {
        "content": "<p>yes that one thanks</p>",
        "id": 199823412,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1591315145
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> -- I missed that bit about the S3 limit of 50 rules per website.  That's just silly.  Sorry for the red herring.  And yeah, doing different redirects for accepted content type makes it even trickier.  My hack solution doesn't cover that either.</p>",
        "id": 199872293,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1591362179
    },
    {
        "content": "<p>Jumping back to CI/CD, I'm working on GitHub action definitions to run SUSHI and IG-Publisher.  With those pieces, you can do quite a bit directly in GitHub (e.g., build and publish to GH-Pages on check-in, etc.).</p>",
        "id": 199892992,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1591370895
    },
    {
        "content": "<p>I'd like to look at that.</p>",
        "id": 199894290,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1591371418
    },
    {
        "content": "<blockquote>\n<p>I'm working on GitHub action definitions to run SUSHI and IG-Publisher</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"255031\">@Julia Afeltra</span> also did some work on something like this.  She didn't have a chance to take it as far as she wanted, but she might have something to share.  Julia, is there anything worth sharing from that effort?</p>",
        "id": 199897968,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1591372957
    },
    {
        "content": "<p>Hoping to get back to it later today - once a pass is working I'll put a link to the repo here.  That said, once it's working I hope to move it under the HL7 GH org so that it's not locked on me.</p>",
        "id": 199906236,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1591376612
    },
    {
        "content": "<p>I don't think I have much to share based off of where I got to in the work. I was trying to do similar things (run SUSHI and the IG publisher and then publish to GitHub Pages), and I was able to get an IG onto GitHub pages. Hopefully things have been going smoothly for you as well.</p>",
        "id": 199920838,
        "sender_full_name": "Julia Afeltra",
        "timestamp": 1591383863
    },
    {
        "content": "<p>I understand the desire for this, but it would be great, from my pov, if the builds doing that would continue to update <a href=\"https://fhir.github.io/auto-ig-builder/builds.html\">https://fhir.github.io/auto-ig-builder/builds.html</a> and the <a class=\"stream\" data-stream-id=\"179297\" href=\"/#narrow/stream/179297-committers.2Fnotification\">#committers/notification</a> thread (unless not a public github repo)</p>",
        "id": 199931954,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1591389961
    },
    {
        "content": "<p>also, you shouldn't need a github action to run sushi if you can run the ig publisher</p>",
        "id": 199932040,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1591389997
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191316\">Grahame Grieve</span> <a href=\"#narrow/stream/179252-IG-creation/topic/Setting.20up.20a.20server.20to.20publish.20IGs.20with.20redirection.3F/near/199932040\">said</a>:</p>\n<blockquote>\n<p>also, you shouldn't need a github action to run sushi if you can run the ig publisher</p>\n</blockquote>\n<p>Yep, figured that out earlier today  :-)</p>",
        "id": 199932583,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1591390262
    },
    {
        "content": "<p>For updating the builds.html file.. I think it's possible, but I need to tinker a bit.<br>\nFirst thought is something like a different webhook for <code>auto-ig-builder</code> that collects the information but doesn't trigger a build.  Will add to my list for it.</p>",
        "id": 199933442,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1591390744
    },
    {
        "content": "<p>I've done the same for S3/CloudFront redirects on projects, though I would think an apache vhost with mod_rewrite rules (or w/nginx) would be cleaner so nothing needs to be generated</p>",
        "id": 200299408,
        "sender_full_name": "Preston Lee",
        "timestamp": 1591741824
    },
    {
        "content": "<p>I still generate the rules for servers that support the rules with enough precision, since there's a lot of them. But right now, I'm still doing redirects using PHP for Apache, because last time I couldn't see how to do rewrite rules based on Accept header for Apache</p>",
        "id": 200299753,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1591742066
    }
]