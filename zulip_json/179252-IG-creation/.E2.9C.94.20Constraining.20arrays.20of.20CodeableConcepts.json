[
    {
        "content": "<p>Formally, does <a href=\"http://hl7.org/fhir/us/cancer-reporting/2021Sep/StructureDefinition-us-pathology-next-of-kin.html\">http://hl7.org/fhir/us/cancer-reporting/2021Sep/StructureDefinition-us-pathology-next-of-kin.html</a> prevent the addition of a 2nd relationship to the <code>relationship[]</code> -- e.g., is the following invalid?</p>\n<div class=\"codehilite\" data-code-language=\"JavaScript\"><pre><span></span><code><span class=\"s2\">\"relationship\"</span><span class=\"o\">:</span> <span class=\"p\">[</span>\n  <span class=\"p\">{</span>\n    <span class=\"s2\">\"coding\"</span><span class=\"o\">:</span> <span class=\"p\">[{</span>\n      <span class=\"s2\">\"system\"</span><span class=\"o\">:</span> <span class=\"s2\">\"http://terminology.hl7.org/CodeSystem/v2-0131\"</span><span class=\"p\">,</span>\n      <span class=\"s2\">\"code\"</span><span class=\"o\">:</span> <span class=\"s2\">\"N\"</span><span class=\"p\">,</span>\n      <span class=\"s2\">\"display\"</span><span class=\"o\">:</span> <span class=\"s2\">\"Next-of-Kin\"</span><span class=\"p\">}]},</span>\n  <span class=\"p\">{</span>\n    <span class=\"s2\">\"text\"</span><span class=\"o\">:</span> <span class=\"s2\">\"Fraternal grand-whatsit\"</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">]</span>\n</code></pre></div>\n<p>-- I <em>think</em> this would be invalid because <code>relationship[1]</code> doesn't meet the profile's requirement for:</p>\n<div class=\"codehilite\" data-code-language=\"JavaScript\"><pre><span></span><code>        <span class=\"s2\">\"id\"</span> <span class=\"o\">:</span> <span class=\"s2\">\"RelatedPerson.relationship\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"path\"</span> <span class=\"o\">:</span> <span class=\"s2\">\"RelatedPerson.relationship\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"min\"</span> <span class=\"o\">:</span> <span class=\"mf\">1</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"max\"</span> <span class=\"o\">:</span> <span class=\"s2\">\"*\"</span><span class=\"p\">,</span>\n        <span class=\"c1\">// snipped for brevity</span>\n        <span class=\"s2\">\"patternCodeableConcept\"</span> <span class=\"o\">:</span> <span class=\"p\">{</span>\n          <span class=\"s2\">\"coding\"</span> <span class=\"o\">:</span> <span class=\"p\">[</span>\n            <span class=\"p\">{</span>\n              <span class=\"s2\">\"system\"</span> <span class=\"o\">:</span> <span class=\"s2\">\"http://terminology.hl7.org/CodeSystem/v2-0131\"</span><span class=\"p\">,</span>\n              <span class=\"s2\">\"code\"</span> <span class=\"o\">:</span> <span class=\"s2\">\"N\"</span><span class=\"p\">,</span>\n              <span class=\"s2\">\"display\"</span> <span class=\"o\">:</span> <span class=\"s2\">\"Next-of-Kin\"</span>\n            <span class=\"p\">}</span>\n          <span class=\"p\">]</span>\n        <span class=\"p\">},</span>\n</code></pre></div>\n<p>... but I'm not sure I'm interpreting the inheritance correctly.</p>",
        "id": 251484347,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1630457888
    },
    {
        "content": "<p>Correct.  A pattern on a repeating element applies to <em>all</em> repetitions.  So does a binding.  If you want the constraints to apply on only one of the repetitions, you need to define a slice.</p>",
        "id": 251485278,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1630458547
    },
    {
        "content": "<p>looks like it does to me. The pattern means that whatever else relationship contains, it must contain a next-of-kin</p>",
        "id": 251485279,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1630458547
    },
    {
        "content": "<p>Don't agree <span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> because the pattern is not on a repeating element</p>",
        "id": 251485312,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1630458585
    },
    {
        "content": "<blockquote>\n<p>Grahame Grieve: Don't agree @Lloyd McKenzie because the pattern is not on a repeating element</p>\n</blockquote>\n<p>The pattern is not on a repeating element, but the <em>only</em> way to have a <code>RelatedPerson.relationship</code> in a valid instance here is to match the supplied \"patternCodeableConcept\". </p>\n<p>I'm trying to figure out whether to file a bug against:</p>\n<ol>\n<li>\n<p>The core spec for being ambiguous (if Lloyd and I have one reading, and Grahame has another -- but I'm having trouble seeing it Grahame's way, even when I try)</p>\n</li>\n<li>\n<p>This IG for unnecessarily constraining the relationship array (it <em>might</em> be the authors' intention, which would be OK -- but I'd guess it's because saying the correct thing here is... awkward, requiring slicing).</p>\n</li>\n</ol>",
        "id": 251487079,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1630460198
    },
    {
        "content": "<blockquote>\n<p>When pattern[x] is used to constrain an array, it means that each element provided in the pattern[x] array must (recursively) match at least one element from the instance array.</p>\n</blockquote>",
        "id": 251487369,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1630460475
    },
    {
        "content": "<p>seems clear to me</p>",
        "id": 251487373,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1630460479
    },
    {
        "content": "<blockquote>\n<p>each element provided in the pattern[x] array</p>\n</blockquote>\n<p>^^ in my example, what does \"the pattern[x] array\" refer to?</p>",
        "id": 251487460,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1630460560
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"nt\">\"patternCodeableConcept\"</span> <span class=\"p\">:</span> <span class=\"p\">{</span>\n          <span class=\"nt\">\"coding\"</span> <span class=\"p\">:</span> <span class=\"p\">[</span>\n            <span class=\"p\">{</span>\n              <span class=\"nt\">\"system\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"http://terminology.hl7.org/CodeSystem/v2-0131\"</span><span class=\"p\">,</span>\n              <span class=\"nt\">\"code\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"N\"</span><span class=\"p\">,</span>\n              <span class=\"nt\">\"display\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"Next-of-Kin\"</span>\n            <span class=\"p\">}</span>\n          <span class=\"p\">]</span>\n        <span class=\"p\">},</span>\n</code></pre></div>\n<p>So the CodeableConcept must match the pattern. And the pattern has one coding, so at least one of the codings must match the coding supplied in the pattern. So your example</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"nt\">\"relationship\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n  <span class=\"p\">{</span>\n    <span class=\"nt\">\"coding\"</span><span class=\"p\">:</span> <span class=\"p\">[{</span>\n      <span class=\"nt\">\"system\"</span><span class=\"p\">:</span> <span class=\"s2\">\"http://terminology.hl7.org/CodeSystem/v2-0131\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"code\"</span><span class=\"p\">:</span> <span class=\"s2\">\"N\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"display\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Next-of-Kin\"</span><span class=\"p\">}]},</span>\n  <span class=\"p\">{</span>\n    <span class=\"nt\">\"text\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Fraternal grand-whatsit\"</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">]</span>\n</code></pre></div>\n<p>That's valid because each element provided in the pattern[x] array (one Coding) does (recursively) match at least one element from the instance array (the Coding)</p>",
        "id": 251487639,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1630460707
    },
    {
        "content": "<p>The question wasn't about the coding.  It was about the separate repetition that was just \"text\"</p>",
        "id": 251487723,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1630460776
    },
    {
        "content": "<p>I definitely understood that within a CodeableConcept only one coding didn't match.  I didn't realize that meant that when a pattern was asserted on an array, only one element in the array needed to match.</p>",
        "id": 251487768,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1630460829
    },
    {
        "content": "<p>oh. ok. I agree with Lloyd. I missed that, and thought that text was in the same relationship. Bad indenting...</p>",
        "id": 251487789,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1630460856
    },
    {
        "content": "<p>Thanks! So should:</p>\n<blockquote>\n<p>When pattern[x] is used to constrain an array, it means that each element provided in the pattern[x] <strong>array</strong></p>\n</blockquote>\n<p>Instead say one of</p>\n<blockquote>\n<p>When pattern[x] is used to constrain an array, it means that each element provided in the pattern[x] <del><strong>array</strong></del><br>\nWhen pattern[x] is used to constrain an array, it means that each element provided in the pattern[x] <strong>element</strong></p>\n</blockquote>\n<p>?</p>",
        "id": 251487972,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1630461006
    },
    {
        "content": "<p>I don't think so</p>",
        "id": 251488052,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1630461106
    },
    {
        "content": "<p>When is <code>pattern[x]</code> itself an <em>array</em>? I understand the instances can have arrays, but what does \"the pattern[x] array\" refer to? <a href=\"http://build.fhir.org/elementdefinition-definitions.html#ElementDefinition.pattern_x_\"><code>ElementDefinition.pattern[x]</code></a> is <code>0..1</code></p>",
        "id": 251488126,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1630461166
    },
    {
        "content": "<p>well, arrays inside of it</p>",
        "id": 251488162,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1630461224
    },
    {
        "content": "<p>that's covered by the recursion rule:</p>\n<blockquote>\n<p>If an array: it must match (recursively) the pattern value.</p>\n</blockquote>\n<p>(Which seems clear to me.)</p>",
        "id": 251488210,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1630461249
    },
    {
        "content": "<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>checking this for myself -- it works as advertised</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$ wget https://github.com/hapifhir/org.hl7.fhir.core/releases/latest/download/validator_cli.jar\n$ wget http://hl7.org/fhir/us/cancer-reporting/2021Sep/full-ig.zip\n$ unzip full-ig.zip\n$ cat rp.json\n<span class=\"o\">{</span>\n  <span class=\"s2\">\"resourceType\"</span>: <span class=\"s2\">\"RelatedPerson\"</span>,\n  <span class=\"s2\">\"patient\"</span>: <span class=\"o\">{</span>\n    <span class=\"s2\">\"display\"</span>: <span class=\"s2\">\"Bob\"</span>\n  <span class=\"o\">}</span>,\n  <span class=\"s2\">\"relationship\"</span>: <span class=\"o\">[</span>\n    <span class=\"o\">{</span>\n      <span class=\"s2\">\"coding\"</span>: <span class=\"o\">[</span>\n        <span class=\"o\">{</span>\n          <span class=\"s2\">\"system\"</span>: <span class=\"s2\">\"http://terminology.hl7.org/CodeSystem/v2-0131\"</span>,\n          <span class=\"s2\">\"code\"</span>: <span class=\"s2\">\"N\"</span>,\n          <span class=\"s2\">\"display\"</span>: <span class=\"s2\">\"Next-of-Kin\"</span>\n        <span class=\"o\">}</span>\n      <span class=\"o\">]</span>\n    <span class=\"o\">}</span>,\n    <span class=\"o\">{</span>\n      <span class=\"s2\">\"text\"</span>: <span class=\"s2\">\"Fraternal grand-whatsit\"</span>,\n      <span class=\"s2\">\"coding\"</span>: <span class=\"o\">[</span>\n        <span class=\"o\">{</span>\n          <span class=\"s2\">\"display\"</span>: <span class=\"s2\">\"Fraternal grand-whatsit\"</span>\n        <span class=\"o\">}</span>\n      <span class=\"o\">]</span>\n    <span class=\"o\">}</span>\n  <span class=\"o\">]</span>\n<span class=\"o\">}</span>\n\n$ java -jar validator_cli.jar  -ig site  -profile http://hl7.org/fhir/us/cancer-reporting/StructureDefinition/us-pathology-next-of-kin rp.json\nFHIR Validation tool Version <span class=\"m\">5</span>.4.11 <span class=\"o\">(</span>Git# 1b4c675c19f6<span class=\"o\">)</span>. Built <span class=\"m\">2021</span>-08-25T23:38:40.103Z <span class=\"o\">(</span><span class=\"m\">6</span> days old<span class=\"o\">)</span>\n  Java:   <span class=\"m\">16</span>.0.2 from /usr/lib/jvm/java-16-openjdk on amd64 <span class=\"o\">(</span>64bit<span class=\"o\">)</span>. 16064MB available\n  Paths:  <span class=\"nv\">Current</span> <span class=\"o\">=</span> /tmp/tt, Package <span class=\"nv\">Cache</span> <span class=\"o\">=</span> /home/jmandel/.fhir/packages\n  Params: -ig site -profile http://hl7.org/fhir/us/cancer-reporting/StructureDefinition/us-pathology-next-of-kin rp.json\nScanning <span class=\"k\">for</span> versions <span class=\"o\">(</span>no -version parameter<span class=\"o\">)</span>:\n  Package site: <span class=\"m\">4</span>.0\n-&gt; use version <span class=\"m\">4</span>.0\nLoading\n  Load FHIR v4.0 from hl7.fhir.r4.core#4.0.1 - <span class=\"m\">4575</span> resources <span class=\"o\">(</span><span class=\"m\">00</span>:02.0460<span class=\"o\">)</span>\n  Load hl7.terminology#2.1.0 - <span class=\"m\">3767</span> resources <span class=\"o\">(</span><span class=\"m\">00</span>:00.0471<span class=\"o\">)</span>\n  Terminology server http://tx.fhir.org - Version <span class=\"m\">1</span>.9.382 <span class=\"o\">(</span><span class=\"m\">00</span>:01.0228<span class=\"o\">)</span>\n  Load site+  .. load IG from hl7.fhir.us.core#4.0.0\n+  .. load IG from hl7.fhir.uv.bulkdata#1.0.1\n+  .. load IG from us.nlm.vsac#0.3.0\n+  .. load IG from hl7.fhir.us.medmorph#0.1.0\n+  .. load IG from hl7.fhir.us.core#3.1.0\n - <span class=\"m\">9118</span> resources <span class=\"o\">(</span><span class=\"m\">00</span>:12.0863<span class=\"o\">)</span>\n  Get set...  go <span class=\"o\">(</span><span class=\"m\">00</span>:00.0012<span class=\"o\">)</span>\nValidating\n  Profiles: <span class=\"o\">[</span>http://hl7.org/fhir/us/cancer-reporting/StructureDefinition/us-pathology-next-of-kin<span class=\"o\">]</span>\n  Validate rp.json <span class=\"m\">00</span>:00.0731\nDone. Times: Loading: <span class=\"m\">00</span>:17.0361, validation: <span class=\"m\">00</span>:00.0731. <span class=\"nv\">Memory</span> <span class=\"o\">=</span> 3Gb\n\n*FAILURE*: <span class=\"m\">1</span> errors, <span class=\"m\">0</span> warnings, <span class=\"m\">0</span> notes\n  Error @ RelatedPerson.relationship<span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span> <span class=\"o\">(</span>line <span class=\"m\">16</span>, col6<span class=\"o\">)</span> : The pattern <span class=\"o\">[</span>system http://terminology.hl7.org/CodeSystem/v2-0131, code N, and display <span class=\"s1\">'Next-of-Kin'</span><span class=\"o\">]</span> defined <span class=\"k\">in</span> the profile http://hl7.org/fhir/us/cancer-reporting/StructureDefinition/us-pathology-next-of-kin not found. Issues: <span class=\"o\">[</span>ValidationMessage<span class=\"o\">[</span><span class=\"nv\">level</span><span class=\"o\">=</span>ERROR,type<span class=\"o\">=</span>VALUE,location<span class=\"o\">=</span>RelatedPerson.relationship<span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span>.coding.system,message<span class=\"o\">=</span>Missing element <span class=\"s1\">'system'</span> - required by fixed value assigned <span class=\"k\">in</span> profile http://hl7.org/fhir/us/cancer-reporting/StructureDefinition/us-pathology-next-of-kin<span class=\"o\">]</span>, ValidationMessage<span class=\"o\">[</span><span class=\"nv\">level</span><span class=\"o\">=</span>ERROR,type<span class=\"o\">=</span>VALUE,location<span class=\"o\">=</span>RelatedPerson.relationship<span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span>.coding.code,message<span class=\"o\">=</span>Missing element <span class=\"s1\">'code'</span> - required by fixed value assigned <span class=\"k\">in</span> profile http://hl7.org/fhir/us/cancer-reporting/StructureDefinition/us-pathology-next-of-kin<span class=\"o\">]</span>, ValidationMessage<span class=\"o\">[</span><span class=\"nv\">level</span><span class=\"o\">=</span>ERROR,type<span class=\"o\">=</span>VALUE,location<span class=\"o\">=</span>RelatedPerson.relationship<span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span>.coding.display,message<span class=\"o\">=</span>Value is <span class=\"s1\">'Fraternal grand-whatsit'</span> but must be <span class=\"s1\">'Next-of-Kin'</span><span class=\"o\">]]</span>\n</code></pre></div>\n</div></div>",
        "id": 251488464,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1630461547
    },
    {
        "content": "<blockquote>\n<p>it works as advertised</p>\n</blockquote>\n<p>well, good</p>",
        "id": 251488490,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1630461581
    },
    {
        "content": "<p>Submitted <a href=\"http://jira.hl7.org/browse/FHIR-33316\">FHIR-33316</a> for this tweak</p>",
        "id": 251488763,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1630461765
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191315\">Josh Mandel</span> has marked this topic as resolved.</p>",
        "id": 251488936,
        "sender_full_name": "Notification Bot",
        "timestamp": 1630461914
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191315\">Josh Mandel</span> has marked this topic as unresolved.</p>",
        "id": 251489198,
        "sender_full_name": "Notification Bot",
        "timestamp": 1630462130
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191315\">Josh Mandel</span> has marked this topic as resolved.</p>",
        "id": 251489212,
        "sender_full_name": "Notification Bot",
        "timestamp": 1630462140
    }
]