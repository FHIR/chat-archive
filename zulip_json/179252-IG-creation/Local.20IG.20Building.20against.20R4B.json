[
    {
        "content": "<p>Hi all, I'm trying to sort out how to build an IG locally against an R4B build.  I've been moving files around in <code>.fhir/packages</code> but haven't found any magic way of getting it to go through.  Any help / direction would be appreciated, thanks!</p>",
        "id": 247754211,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1627674958
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"248736\">@Mark Iantorno</span> What's the version id to use to build against the R4B CI-build?</p>",
        "id": 247759069,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1627677635
    },
    {
        "content": "<p>Are you talking release number?</p>",
        "id": 247759129,
        "sender_full_name": "Mark Iantorno",
        "timestamp": 1627677669
    },
    {
        "content": "<p>On github?</p>",
        "id": 247759135,
        "sender_full_name": "Mark Iantorno",
        "timestamp": 1627677672
    },
    {
        "content": "<p>FHIR release version number</p>",
        "id": 247759330,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1627677777
    },
    {
        "content": "<p>I do not know that, sorry.</p>",
        "id": 247759686,
        "sender_full_name": "Mark Iantorno",
        "timestamp": 1627677984
    },
    {
        "content": "<p>Post-weekend bump - if anyone knows how to build an IG against R4B, I'd appreciate it.  Thanks!</p>",
        "id": 247932681,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1627917975
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191415\">@Giorgio Cangioli</span> ?</p>",
        "id": 247935396,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1627919525
    },
    {
        "content": "<p>I've not rebuilt recently the guide, but last time I did I had to copy the hl7.fhir.r4b.core#4.1.0 package into hl7.fhir.r5.core#4.1.0 to make sushi  happy ..... but maybe this was not the question</p>",
        "id": 247937338,
        "sender_full_name": "Giorgio Cangioli",
        "timestamp": 1627920721
    },
    {
        "content": "<p>..and I had a lot of broken links errors...</p>",
        "id": 247937497,
        "sender_full_name": "Giorgio Cangioli",
        "timestamp": 1627920834
    },
    {
        "content": "<p>Thanks Giorgio, that's similar to what I'm tinkering with now - manually putting the package into <code>.fhir/packages</code> and adding dev dependencies.  If I manage a working setup I'll be sure to comment here.</p>",
        "id": 247937792,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1627921043
    },
    {
        "content": "<p>We've updated support in SUSHI (in the SUSHI 2.0.0 betas) to support FHIR R4B Ballot #1 edition.  To use that, you set <code>fhirVersion: 4.1.0</code> in <code>sushi-config.yaml</code>.  IIRC, that works out to <code>hl7.fhir.r4b.core#4.1.0</code>.  If you want a <em>more current</em> build than ballot #1, however, I'm not sure that's possible without a lot of hacking.</p>",
        "id": 247937900,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1627921109
    },
    {
        "content": "<p>Thanks Chris, but that's exactly what I need.  I have a branch of R4B that hasn't been merged in yet, and I need to build the IG against it (modelling changes from ballot reconciliation of R4B and the IG - yuck).  I am hesitantly hopeful that this process works:</p>\n<ul>\n<li>Locally build R4B</li>\n<li>Expand the R4B package into <code>~/.fhir/packages</code> as <code>hl7.fhir.r4b.code#dev</code></li>\n<li>Add the <code>hl7.fhir.r4b.core: dev</code> dependency to <code>sushi-config.yaml</code></li>\n</ul>\n<p>There were a <em>lot</em> of changes to the IG to support this change, so I am working through all of the errors right now, but it <em>looks</em> like it may work.</p>",
        "id": 247939048,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1627921784
    },
    {
        "content": "<p>Hmmm... Yeah, I don't know for sure if that will work.  It might?  The problem is that SUSHI does not treat FHIR Core exactly the same as a dependency.  You will still need to declare a <code>fhirVersion</code> in your <code>sushi-config.yaml</code> -- and whatever your declare there (4.0.1, 4.1.0, etc) will be available <em>in addition to</em> whatever gets pulled in via the dependencies.</p>\n<p>I think that the approach that is more likely to work (with SUSHI, anyway) would be to expand your local build package into <code>~/.fhir/packages/hl7.fhir.r4b.core#4.1.0</code> (replacing the real 4.1.0).  Then SUSHI is not loading multiple builds of FHIR Core.  BUT... I don't know how the IG Publisher would deal with that (might be fine?).  And, of course, you're setting yourself up for all kinds of trouble if you forget that you did this and leave it like that in your package cache.  AND (while I'm at it), this will of course fail pretty miserably in the Auto Build CI.</p>",
        "id": 247940004,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1627922424
    },
    {
        "content": "<p>Thanks Chris, testing through that now.  Yes, this is frustrating, and hopefully not common...  For the subscriptions backport IG, there are two new resources we added in R4B, so it has a dependency on that.  But, I can't build the IG so we can't evaluate the changes.</p>\n<p>Even when the resources are merged into R4B (soon), it will only be on the CI build so that's another issue.  But I'm not worrying about that today  =).</p>",
        "id": 247947871,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1627926282
    },
    {
        "content": "<p>Ok, for posterity I'll document the steps here:</p>\n<ul>\n<li>Build local R4B</li>\n<li>Extract <code>.../publish/hl7.fhir.r4b.core.tgz</code> to <code>~/.fhir/packages/hl7.fhir.r4b.core#4.1.0</code></li>\n<li>Extract <code>.../publish/hl7.fhir.r4b.expansions.tgz</code> to <code>~/.fhir/packages/hl7.fhir.r4b.expansions#4.1.0</code></li>\n<li>Set the <code>fhirVersion</code> in <code>sushi-config.yaml</code> to <code>4.1.0</code></li>\n<li>Set the <code>version</code> in <code>ig.ini</code> to <code>hl7.fhir.r4b.core#4.1.0</code></li>\n</ul>\n<p>As a note, the branch I have had an error in an example (<code>Questionnaire-qs1.json</code>) that prevented the build from working.  I deleted that file and removed it from <code>~/.fhir/packages/hl7.fhir.r4b.core#4.1.0/package/.index.json</code>.  I'd assume nothing like that <em>should</em> be needed, but since I'm not working on Questionnaire at all, I assume anyone doing a local build will run into the same error.</p>\n<p>Thanks everyone for all the assistance!</p>",
        "id": 247954869,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1627930028
    },
    {
        "content": "<p>Thanks a lot Gino and Chris, very useful information for my next steps :-)</p>",
        "id": 247960727,
        "sender_full_name": "Giorgio Cangioli",
        "timestamp": 1627932758
    },
    {
        "content": "<p><del>Blah.  As a note, this no longer works for sushi (e.g., some earlier step worked, then manually running the ig builder worked), so I don't have a single config that works for both..</del></p>\n<p>edit: it does, I'm just doing too many things at once  <span aria-label=\"face palm\" class=\"emoji emoji-1f926\" role=\"img\" title=\"face palm\">:face_palm:</span></p>",
        "id": 247962912,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1627933818
    },
    {
        "content": "<p>So ... I also got it working locally ... - but what voodoo is needed for R4B to be supported in the CI build pipeline? Log can be seen here: <a href=\"https://build.fhir.org/ig/hl7-eu/gravitate-health/branches/master/failure/build.log\">https://build.fhir.org/ig/hl7-eu/gravitate-health/branches/master/failure/build.log</a></p>\n<p>The essential part is this: <code>Sushi: error Failed to load hl7.fhir.r4b.core#4.1.0: connect ETIMEDOUT 35.184.92.126:80 (02:11.0167)</code></p>",
        "id": 249557240,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1629098861
    },
    {
        "content": "<p>Is it <span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> I need to send some flowers and chocolates to?</p>",
        "id": 249557312,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1629098910
    },
    {
        "content": "<p>No, I don't really know how this works. From your log, looks like sushi is trying to connect to a server called 35.184.92.126 which is a (non-tls-protected?!) connection to the VM running a service called packages2-fhir-org in our GCP console. And neither <a href=\"http://packages2.fhir.org/\">http://packages2.fhir.org/</a> and <a href=\"https://packages2.fhir.org/\">https://packages2.fhir.org/</a> seems to be working.</p>",
        "id": 249595441,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1629123983
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191427\">@Jens Villadsen</span> FWIW, I'm grabbing the output folder and putting it on a <a href=\"http://github.io\">github.io</a> (edit: GitHub Pages) for the near term.  Not as good as CI, but it gives a public endpoint for review for now.</p>",
        "id": 249602278,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1629126984
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> Im 'just' using the CI stuff here. <span class=\"user-mention\" data-user-id=\"191469\">@Chris Moesel</span> who's sushi trying to dial up here?</p>",
        "id": 249614663,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1629132755
    },
    {
        "content": "<p>Makes sense; in turn, the CI infrastructure is \"just\" executing the same tools you run locally (sushi + IG publisher), albeit from a \"blank slate\" (no saved prior build state, empty FHIR cache, etc).</p>",
        "id": 249621629,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1629135667
    },
    {
        "content": "<p>The issue seems to be that <a href=\"http://packages2.fhir.org\">packages2.fhir.org</a> is down.</p>",
        "id": 249621655,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1629135681
    },
    {
        "content": "<p>Right  - ephemeral containers all the way. - and I could have done the reverse IP lookup myself <span aria-label=\"face palm\" class=\"emoji emoji-1f926\" role=\"img\" title=\"face palm\">:face_palm:</span></p>",
        "id": 249624839,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1629137069
    },
    {
        "content": "<p>I don't think that the IG publisher supports building against your local dev branch of a FHIR base specification. At least, it's <em>never</em> been on my roadmap for it to do so</p>",
        "id": 249678537,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1629176037
    },
    {
        "content": "<p>It does, in a way.  Since it checks the local cache, you can set your version (e.g., 4.1.0) and manually put your local build there.  It complains because various URLs don’t resolve, but the build works.</p>",
        "id": 249709270,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1629202486
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191427\">@Jens Villadsen</span> -- R4B and R5 ballot editions are only available on <a href=\"http://packages2.fhir.org\">packages2.fhir.org</a> (as opposed to official R4 that is available on <a href=\"http://packages.fhir.org\">packages.fhir.org</a>).  So SUSHI is trying to dial up <a href=\"http://packages2.fhir.org\">packages2.fhir.org</a>.</p>",
        "id": 249741360,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1629216686
    },
    {
        "content": "<p>Hmmm ... <span class=\"user-mention\" data-user-id=\"222054\">@Gino Canessa</span> I tried to follow your steps but it doesn't seem to work. I've added the R4B to the locale package registry and it looks like it resolves ok, but Sushi chokes on the example resource I have present with the message:</p>\n<div class=\"codehilite\"><pre><span></span><code>warn  SUSHI support for pre-release versions of FHIR is experimental. Use at your own risk!\ninfo  Checking local cache for hl7.fhir.uv.ips#current...\ninfo  Found hl7.fhir.uv.ips#current in local cache.\ninfo  Checking local cache for hl7.fhir.r4b.core#4.1.0...\ninfo  Found hl7.fhir.r4b.core#4.1.0 in local cache.\ninfo  Loaded package hl7.fhir.r4b.core#4.1.0\n...\nUnknown resource type: MedicinalProductDefinition\n</code></pre></div>",
        "id": 249757640,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1629224341
    },
    {
        "content": "<p>That might be more down <span class=\"user-mention\" data-user-id=\"191469\">@Chris Moesel</span> 's alley.  - and <span class=\"user-mention\" data-user-id=\"222054\">@Gino Canessa</span> the following is also logged</p>\n<div class=\"codehilite\"><pre><span></span><code>warn  Your gravitate-health/ig.ini file contains the following unsupported properties: version. These are no longer supported in ig.ini and should be removed.  See the following link for details: https://github.com/HL7/ig-template-base/releases/tag/0.0.2\n</code></pre></div>",
        "id": 249758082,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1629224564
    },
    {
        "content": "<p>Meaning that setting the version in ig.ini probably don't do much</p>",
        "id": 249758148,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1629224600
    },
    {
        "content": "<p>Yes, it needs to be set as <code>fhirVersion</code> in <code>sushi-config.yaml</code> now.  I assume yours is correct since it looks like it is finding the package.</p>\n<p>If you look in your <code>~/.fhir/pacakges/hl7.fhir.r4b.core#4.1.0/package</code> folder, is the <code>StructureDefinition-MedicinalProductDefinition.json</code> file there?</p>",
        "id": 249758375,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1629224685
    },
    {
        "content": "<p>yep</p>",
        "id": 249758493,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1629224731
    },
    {
        "content": "<p>Is there a repo I can pull to see if I can build it here?  Those steps have worked for me to access <code>SubscriptionTopic</code> and <code>SubscriptionStatus</code>, so I assume they should work for <code>MedicinalProductDefinition</code> as well.</p>",
        "id": 249758786,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1629224860
    },
    {
        "content": "<p>That would be <a href=\"https://github.com/hl7-eu/gravitate-health\">https://github.com/hl7-eu/gravitate-health</a></p>",
        "id": 249758952,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1629224930
    },
    {
        "content": "<p>Ohhhhhhh...  I think I know what is happening here.  Your example is an XML file (not FSH) -- <code>medicinalproductdefinition-example.xml</code>.  SUSHI tries to read in all of the other files in <code>input</code> -- but since it uses JSON internally, it attempts to translate the XML into JSON using the <a href=\"https://github.com/lantanagroup/FHIR.js\">FHIR.js</a> library.  BUT... by default, that library only supports FHIR 4.0.  There are instructions in its README for supporting other FHIR versions (which requires loading the fhir-definitions package) -- but SUSHI is not doing that.  So... in order to make this error go away, either (a) you need to store that example in your project as JSON instead of XML (or even better, as FSH) or (b) we need to update SUSHI to load up FHIR.js w/ other versions of FHIR.  If you're trying to get this done soon, then <em>(a)</em> would be your better option.</p>",
        "id": 249762353,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1629226384
    },
    {
        "content": "<p>Yep, was just typing that up.  I didn't port the complete example, but making it a FSH instance gets past that hurdle of the build:</p>\n<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"go\">Instance:     GravitateHealthMedicinalProductDefinitionAuthorized</span>\n<span class=\"go\">InstanceOf:   MedicinalProductDefinition</span>\n<span class=\"go\">Usage:        #example</span>\n<span class=\"go\">Title:        \"Authorized\"</span>\n<span class=\"go\">Description:  \"Example of an Authorized Medicinal Product Definition\"</span>\n<span class=\"go\">* id        = \"medicinalproductdefinition-authorized\"</span>\n</code></pre></div>\n<p>So, the above works (though is obviously not equivalent).  Once that was fixed, it came across another error:</p>\n<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"go\">Sushi couldn't be run. Complete output from running Sushi : warn  The name \"Example-sections-PL\" may not be suitable for machine processing applications such as code generation. Valid names start with an upper-case ASCII letter ('A'..'Z') followed by any combination of upper- or lower-case ASCII letters ('A'..'Z',  (01:17.0104)</span>\n<span class=\"go\">Note: Check that Sushi is installed correctly (\"npm install -g fsh-sushi\". On windows, get npm from https://www.npmjs.com/get-npm) (01:17.0107)</span>\n<span class=\"go\">Exception: Process exited with an error: 1 (Exit value: 1)                       (01:17.0109)</span>\n<span class=\"go\">Publishing Content Failed: Process exited with an error: 1 (Exit value: 1)       (01:17.0110)</span>\n</code></pre></div>\n<p>Which I believe <em>shouldn't</em> actually exit, but having seen things like this in the past I assume correcting the warnings will get everything through.</p>",
        "id": 249762901,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1629226644
    },
    {
        "content": "<p>I had a suspicion about that ... Thanks for clarifying - both of you :)</p>",
        "id": 249764412,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1629227343
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"222054\">@Gino Canessa</span> FWIW - I've thrown a docker image up on <a href=\"https://hub.docker.com/r/trifork/ig-publisher-base/tags?page=1&amp;ordering=last_updated\">https://hub.docker.com/r/trifork/ig-publisher-base/tags?page=1&amp;ordering=last_updated</a></p>",
        "id": 249772807,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1629231240
    },
    {
        "content": "<p>the source is at <a href=\"https://github.com/hl7-eu/gravitate-health/tree/master/docker\">https://github.com/hl7-eu/gravitate-health/tree/master/docker</a></p>",
        "id": 249772916,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1629231272
    },
    {
        "content": "<p>and I've added the workflow (<a href=\"https://github.com/hl7-eu/gravitate-health/blob/master/.github/workflows/main.yml\">https://github.com/hl7-eu/gravitate-health/blob/master/.github/workflows/main.yml</a>) so that it renders on (<a href=\"https://hl7-eu.github.io/gravitate-health/\">https://hl7-eu.github.io/gravitate-health/</a>)</p>",
        "id": 249773034,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1629231324
    },
    {
        "content": "<p>Ooops ... looks like I forgot to push the changes ... that will be done later today</p>",
        "id": 249823098,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1629277113
    },
    {
        "content": "<p><span aria-label=\"face palm\" class=\"emoji emoji-1f926\" role=\"img\" title=\"face palm\">:face_palm:</span></p>",
        "id": 249823154,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1629277161
    }
]