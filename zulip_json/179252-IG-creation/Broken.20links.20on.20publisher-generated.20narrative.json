[
    {
        "content": "<p>I'm getting a set of broken links on the publisher-generated narrative.  It's adding boilerplate narrative which includes a faulty link in the modifierExtension element.  \"This promotes interoperability by eliminating the need for implementers to prohibit the presence of extensions. For further information, see the definition of modifier extensions.\"  The \"definition of modifier extensions\" is a relative link to extensibility.html when it should be an absolute link back to the FHIR specification.</p>\n<p><a href=\"http://build.fhir.org/ig/HL7/davinci-pas/branches/master/qa.html\">http://build.fhir.org/ig/HL7/davinci-pas/branches/master/qa.html</a></p>",
        "id": 245512459,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1625869192
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> Here is the repository: <a href=\"https://github.com/HL7/davinci-pas/\">https://github.com/HL7/davinci-pas/</a>. I @d both of you in case this is a template or a publisher bug.  In either case, I need a fix or a confirmation that this is a tooling issue.</p>",
        "id": 250678792,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1629923779
    },
    {
        "content": "<p>I'm also getting the following error: </p>\n<div class=\"codehilite\"><pre><span></span><code>The generated snapshot has a different number of elements 271 than the originally provided snapshot 273\n</code></pre></div>\n<p>This is on my Claim profile json.  The weird thing is that the input and the output look exactly the same, except for the generated narrative.</p>",
        "id": 250679817,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1629924279
    },
    {
        "content": "<p>Why do you have a snapshot on your input at all?</p>",
        "id": 250680195,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1629924501
    },
    {
        "content": "<p>tl;dr - i took the output profile and made it my input<br>\nThere is a bug either in SUSHI or in the publisher such that my FSH file can't be used to generate the profile.  The generated differential causes a NPE in the IG publisher code.  I had to use the generated profile that includes the snapshot.</p>",
        "id": 250680817,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1629924801
    },
    {
        "content": "<p><a href=\"#narrow/stream/179252-IG-creation/topic/Slice.20Criteria.20Validation.20failing\">https://chat.fhir.org/#narrow/stream/179252-IG-creation/topic/Slice.20Criteria.20Validation.20failing</a></p>",
        "id": 250681208,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1629924969
    },
    {
        "content": "<p>for SUSHI, I can't have a profile that doesn't include a snapshot.</p>",
        "id": 250681854,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1629925222
    },
    {
        "content": "<p>this I totally don't understand:</p>\n<blockquote>\n<p>for SUSHI, I can't have a profile that doesn't include a snapshot.</p>\n</blockquote>",
        "id": 250682568,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1629925532
    },
    {
        "content": "<p>which source file are we talking about?</p>",
        "id": 250682610,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1629925548
    },
    {
        "content": "<p><a href=\"https://github.com/HL7/davinci-pas/blob/master/input/resources/StructureDefinition-profile-claim.json\">https://github.com/HL7/davinci-pas/blob/master/input/resources/StructureDefinition-profile-claim.json</a></p>",
        "id": 250683380,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1629925847
    },
    {
        "content": "<p>Because I'm deriving profiles off of that Claim profile, SUSHI needs a snapshot.</p>",
        "id": 250683415,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1629925865
    },
    {
        "content": "<p>I can't reproduce this:</p>\n<blockquote>\n<p>The generated snapshot has a different number of elements 271 than the originally provided snapshot 273</p>\n</blockquote>",
        "id": 250688173,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1629928339
    },
    {
        "content": "<p>is it in a branch?</p>",
        "id": 250688182,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1629928344
    },
    {
        "content": "<p>but the broken links are because the snpashot was generated improperly. I don't know where you get it from</p>",
        "id": 250689597,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1629929186
    },
    {
        "content": "<p>i reverted the master branch to have the JSON structure definitions so you can reproduce it.  To get the snapshots, I took one that had a differential, removed my links to that profile, and then took the output of the publisher and used that as my input</p>",
        "id": 250689860,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1629929363
    },
    {
        "content": "<p>when the snapshot is generated. relative references must be updated to absolute references. That hasn't been done in that snapshot.</p>",
        "id": 250689950,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1629929411
    },
    {
        "content": "<p>so the master branch has the profiles as structure definitions and the claim-json branch has the profiles as FSH files (and that gets the NPE I've reported elsewhere)</p>",
        "id": 250689954,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1629929413
    },
    {
        "content": "<p>This is the corrected profile: <a href=\"/user_uploads/10155/oPHM3UtL8BwC1e7ynQcTJCAS/StructureDefinition-profile-claim.json\">StructureDefinition-profile-claim.json</a></p>",
        "id": 250689975,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1629929435
    },
    {
        "content": "<p>hmm, my claim-inquiry had the absolute references.</p>",
        "id": 250690202,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1629929563
    },
    {
        "content": "<p>thanks</p>",
        "id": 250690208,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1629929564
    },
    {
        "content": "<p>so, I can build master right now. I should be able to ?</p>",
        "id": 250690310,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1629929635
    },
    {
        "content": "<p>master should build but have the error and broken links</p>",
        "id": 250690381,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1629929659
    },
    {
        "content": "<p>when I build it with the profile you gave me, the broken links go away but the \"The generated snapshot has a different number of elements 271 than the originally provided snapshot 273\" error is still there.</p>",
        "id": 250691280,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1629930156
    },
    {
        "content": "<blockquote>\n<p>why don't you just use the output from the published specification?</p>\n</blockquote>\n<p>I tried to do that.  I tried to get a published version of the profiles with my changes in them.</p>",
        "id": 250691979,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1629930553
    },
    {
        "content": "<p>... and?</p>",
        "id": 250692014,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1629930577
    },
    {
        "content": "<p>I ended up with what you saw :)</p>",
        "id": 250692040,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1629930595
    },
    {
        "content": "<p>well, try again, grab it from /output</p>",
        "id": 250692097,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1629930608
    },
    {
        "content": "<p>I did that.  I grab the /output and put it in input/resources and I still get that error.  If I diff what I have in input/resources against output, it's the same except for the narrative.</p>",
        "id": 250692150,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1629930653
    },
    {
        "content": "<p>(my input resources don't have the narrative)</p>",
        "id": 250692161,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1629930661
    },
    {
        "content": "<p>ah</p>",
        "id": 250695875,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1629933037
    },
    {
        "content": "<p>I see what's happening</p>",
        "id": 250695881,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1629933043
    },
    {
        "content": "<p>you have to fix it up</p>",
        "id": 250696117,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1629933220
    },
    {
        "content": "<p>but of course, you don't know how to</p>",
        "id": 250696387,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1629933402
    },
    {
        "content": "<p>no, you can't fix it. Something weird here. Please explain why you have this profile. It's part of the IG but it's not?</p>",
        "id": 250698439,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1629934893
    },
    {
        "content": "<p>in the future, if you really need to do this, generate the snapshot using the validator</p>",
        "id": 250707704,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1629941771
    },
    {
        "content": "<p>It is part of the IG.  Why do you say that it isn’t?  How do you generate the snapshot with the validation?  And what is happening that I can’t fix?</p>",
        "id": 250707802,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1629941844
    },
    {
        "content": "<p>the error gives you no information about how to fix the profile, but you should just regenerate it. The validator can do this:</p>\n<p><code>-version 4.0 -snapshot StructureDefinition-profile-claim.json -output StructureDefinition-profile-claim-snapshot.json</code></p>\n<p>I think that in general, you shouldn't freeze snapshots like that, and something seems wrong to me here. FSH can't make profiles on profiles?</p>",
        "id": 250708262,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1629942248
    },
    {
        "content": "<p>it can make profiles on profiles (which is what I'm doing) but it needs the snapshot to be able to do that <span class=\"user-mention\" data-user-id=\"191469\">@Chris Moesel</span> maybe you want to chime in here on why SUSHI requires imported profiles (i.e. non-FSH profiles) to have the snapshot?</p>",
        "id": 250716865,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1629950188
    },
    {
        "content": "<p>why does it need to be imported? Just author it the same way as everything else?</p>",
        "id": 250717643,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1629950805
    },
    {
        "content": "<p>well, that's the rub.  when I created the profile using FSH, I got an error (<a href=\"#narrow/stream/179252-IG-creation/topic/Slice.20Criteria.20Validation.20failing\">https://chat.fhir.org/#narrow/stream/179252-IG-creation/topic/Slice.20Criteria.20Validation.20failing</a>).</p>\n<p>Strangely enough, after creating the snapshot using the validator, I'm now getting the exact same error.</p>",
        "id": 250717776,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1629950964
    },
    {
        "content": "<p>that means there's a problem in the generated snapshot somewhere, but you won't get that after the next release</p>",
        "id": 250717846,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1629951013
    },
    {
        "content": "<p>to be clearer, by \"exact same error\", I meant that I'm getting the NPE that I was seeing when I was creating the profile in FSH.</p>",
        "id": 250717953,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1629951055
    },
    {
        "content": "<p>you didn't talk about an NPE, you showed an index out of bounds error</p>",
        "id": 250718480,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1629951397
    },
    {
        "content": "<p>oops, you're right.  I don't know why I wrote NPE there. too late in the day for me</p>",
        "id": 250719162,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1629951875
    },
    {
        "content": "<p>good. fixed next release</p>",
        "id": 250720245,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1629952594
    },
    {
        "content": "<p>Thx</p>",
        "id": 250721049,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1629953106
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"192166\">Jean Duteau</span> <a href=\"#narrow/stream/179252-IG-creation/topic/Broken.20links.20on.20publisher-generated.20narrative/near/250716865\">said</a>:</p>\n<blockquote>\n<p>it can make profiles on profiles (which is what I'm doing) but it needs the snapshot to be able to do that <span class=\"user-mention silent\" data-user-id=\"191469\">Chris Moesel</span> maybe you want to chime in here on why SUSHI requires imported profiles (i.e. non-FSH profiles) to have the snapshot?</p>\n</blockquote>\n<p>It sounds like you all worked out the issue.  That's good!</p>\n<p>Regarding SUSHI and snapshots... When SUSHI builds a profile from FSH, it starts from the baseDefinition (parent).  If the parent is another FSH definition, SUSHI can do it's thing just fine (because it maintains its own \"shadow\" snapshots for FSH definitions) -- but if the parent is not a FSH definition (i.e., it's JSON), then SUSHI needs access to the parent's snapshot in order to build out the diff correctly.  Since SUSHI does not have its own snapshot generator, the snapshot just needs to be there in the first place.</p>",
        "id": 250765554,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1629982001
    }
]