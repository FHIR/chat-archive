[
    {
        "content": "<p>I have explained a slicing problem I am having over on the sushi stream<br>\n<a href=\"#narrow/stream/215610-shorthand/topic/slicing.20an.20extension.20on.20a.20slice\">https://chat.fhir.org/#narrow/stream/215610-shorthand/topic/slicing.20an.20extension.20on.20a.20slice</a><br>\nI started on the sushi stream because I initially was worried I was not using sushi right. <br>\nI am not having trouble with sushi, but rather the validation in the IG build.  <br>\nSpecifically my examples are failing validation, but I have checked the error message and looked at the JSON created by sushi. I can't figure out what I have done wrong.</p>\n<div class=\"codehilite\"><pre><span></span><code>Slicing cannot be evaluated: Could not match discriminator ([url]) for slice AuditEvent.agent:user.extension:otherId/subject-id in profile http://profiles.ihe.net/ITI/BasicAudit/StructureDefinition/ITI.BasicAudit.SAMLaccessTokenUse.Comprehensive.Norway - the discriminator [url] does not have fixed value, binding or existence assertions\n</code></pre></div>\n<p>my github repo - <a href=\"https://github.com/IHE/ITI.BasicAudit\">https://github.com/IHE/ITI.BasicAudit</a></p>",
        "id": 263848712,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638797067
    },
    {
        "content": "<p>the specifics of the error</p>\n<div class=\"codehilite\"><pre><span></span><code>- the discriminator [url] does not have fixed value, binding or existence assertions\n</code></pre></div>\n<p>Yet, I definitely have a fixed code in my example</p>\n<div class=\"codehilite\"><pre><span></span><code>        {\n          &quot;url&quot; : &quot;http://profiles.ihe.net/ITI/BasicAudit/StructureDefinition/ihe-otherId&quot;,\n          &quot;valueReference&quot; : {\n            &quot;identifier&quot; : {\n              &quot;type&quot; : {\n                &quot;coding&quot; : [\n                  {\n                    &quot;system&quot; : &quot;http://profiles.ihe.net/ITI/BasicAudit/CodeSystem/OtherIdentifierTypes&quot;,\n                    &quot;code&quot; : &quot;SAML-subject-id&quot;\n                  }\n                ]\n              },\n              &quot;value&quot; : &quot;JohnDoe&quot;\n            }\n          }\n</code></pre></div>",
        "id": 263849021,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638797188
    },
    {
        "content": "<p>It's not complaining about the example, it's complaining about the profile.</p>",
        "id": 263856772,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1638800763
    },
    {
        "content": "<p>I seek only to make IG builder happy... so, what ever it takes</p>",
        "id": 263859803,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638802023
    },
    {
        "content": "<p>Check the profile for fixed values for the URL.</p>",
        "id": 263865641,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1638804249
    },
    {
        "content": "<p>im not sure which URL is in question. Here is the fragment from the JSON created by sushi</p>\n<div class=\"codehilite\"><pre><span></span><code>      {\n        &quot;id&quot; : &quot;AuditEvent.agent:user.extension:otherId/subject-id&quot;,\n        &quot;path&quot; : &quot;AuditEvent.agent.extension&quot;,\n        &quot;sliceName&quot; : &quot;otherId/subject-id&quot;,\n        &quot;short&quot; : &quot;Extension&quot;,\n</code></pre></div>\n<p>is that \"id\" what is being refered to as a URL?</p>",
        "id": 263901937,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638818470
    },
    {
        "content": "<p>Here is the Profile that this error is coming from <br>\n<a href=\"http://build.fhir.org/ig/IHE/ITI.BasicAudit/branches/main/StructureDefinition-ITI.BasicAudit.SAMLaccessTokenUse.Comprehensive.html\">http://build.fhir.org/ig/IHE/ITI.BasicAudit/branches/main/StructureDefinition-ITI.BasicAudit.SAMLaccessTokenUse.Comprehensive.html</a></p>",
        "id": 263902391,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638818628
    },
    {
        "content": "<p>Im getting lots of similar errors. so I fully expect I am not doing something right.  but others are indicating that my sushi seems to be written rigtht... so I thus want to dig deeper into the json that sushi creates to see if it is not doing something right.</p>",
        "id": 263904049,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638818996
    },
    {
        "content": "<p>I'll take a look at it as well to see if anything jumps out at me.</p>",
        "id": 263915578,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1638821365
    },
    {
        "content": "<p>It looks to me like it might be an issue with the snapshot generator.  Here's what we have in the differential for the otherId extension element and its subject-id reslice:</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code>      <span class=\"p\">{</span>\n        <span class=\"nt\">\"id\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"AuditEvent.agent:user.extension:otherId\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"path\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"AuditEvent.agent.extension\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"sliceName\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"otherId\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"slicing\"</span> <span class=\"p\">:</span> <span class=\"p\">{</span>\n          <span class=\"nt\">\"discriminator\"</span> <span class=\"p\">:</span> <span class=\"p\">[</span>\n            <span class=\"p\">{</span>\n              <span class=\"nt\">\"type\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"pattern\"</span><span class=\"p\">,</span>\n              <span class=\"nt\">\"path\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"valueReference.identifier.type\"</span>\n            <span class=\"p\">}</span>\n          <span class=\"p\">],</span>\n          <span class=\"nt\">\"rules\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"open\"</span>\n        <span class=\"p\">},</span>\n        <span class=\"nt\">\"min\"</span> <span class=\"p\">:</span> <span class=\"mi\">0</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"max\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"*\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"type\"</span> <span class=\"p\">:</span> <span class=\"p\">[</span>\n          <span class=\"p\">{</span>\n            <span class=\"nt\">\"code\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"Extension\"</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"profile\"</span> <span class=\"p\">:</span> <span class=\"p\">[</span>\n              <span class=\"s2\">\"http://profiles.ihe.net/ITI/BasicAudit/StructureDefinition/ihe-otherId\"</span>\n            <span class=\"p\">]</span>\n          <span class=\"p\">}</span>\n        <span class=\"p\">],</span>\n        <span class=\"nt\">\"mustSupport\"</span> <span class=\"p\">:</span> <span class=\"kc\">true</span>\n      <span class=\"p\">},</span>\n      <span class=\"p\">{</span>\n        <span class=\"nt\">\"id\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"AuditEvent.agent:user.extension:otherId/subject-id\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"path\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"AuditEvent.agent.extension\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"sliceName\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"otherId/subject-id\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"min\"</span> <span class=\"p\">:</span> <span class=\"mi\">0</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"max\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"1\"</span>\n      <span class=\"p\">}</span>\n</code></pre></div>\n<p><em>(Note that for brevity I've left out the elements that set the value reference)</em></p>",
        "id": 263917650,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1638821782
    },
    {
        "content": "<p>But when the snapshot gets generated, the <code>subject-id</code> reslice gets the plain <code>Extension</code> type instead of the <code>http://profiles.ihe.net/ITI/BasicAudit/StructureDefinition/ihe-otherId</code> extension type it should be inheriting from the slice base:</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code>    <span class=\"p\">{</span>\n        <span class=\"nt\">\"id\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"AuditEvent.agent:user.extension:otherId/subject-id\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"path\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"AuditEvent.agent.extension\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"sliceName\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"otherId/subject-id\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"short\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"Extension\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"definition\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"An Extension\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"min\"</span> <span class=\"p\">:</span> <span class=\"mi\">0</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"max\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"1\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"base\"</span> <span class=\"p\">:</span> <span class=\"p\">{</span>\n          <span class=\"nt\">\"path\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"Element.extension\"</span><span class=\"p\">,</span>\n          <span class=\"nt\">\"min\"</span> <span class=\"p\">:</span> <span class=\"mi\">0</span><span class=\"p\">,</span>\n          <span class=\"nt\">\"max\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"*\"</span>\n        <span class=\"p\">},</span>\n        <span class=\"nt\">\"type\"</span> <span class=\"p\">:</span> <span class=\"p\">[</span>\n          <span class=\"p\">{</span>\n            <span class=\"nt\">\"code\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"Extension\"</span>\n          <span class=\"p\">}</span>\n        <span class=\"p\">],</span>\n        <span class=\"nt\">\"constraint\"</span> <span class=\"p\">:</span> <span class=\"p\">[</span>\n          <span class=\"p\">{</span>\n            <span class=\"nt\">\"key\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"ele-1\"</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"severity\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"error\"</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"human\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"All FHIR elements must have a @value or children\"</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"expression\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"hasValue() or (children().count() &gt; id.count())\"</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"xpath\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"@value|f:*|h:div\"</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"source\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"http://hl7.org/fhir/StructureDefinition/Element\"</span>\n          <span class=\"p\">},</span>\n          <span class=\"p\">{</span>\n            <span class=\"nt\">\"key\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"ext-1\"</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"severity\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"error\"</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"human\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"Must have either extensions or value[x], not both\"</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"expression\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"extension.exists() != value.exists()\"</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"xpath\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"exists(f:extension)!=exists(f:*[starts-with(local-name(.), \\\"value\\\")])\"</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"source\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"http://hl7.org/fhir/StructureDefinition/Extension\"</span>\n          <span class=\"p\">}</span>\n        <span class=\"p\">],</span>\n        <span class=\"nt\">\"isModifier\"</span> <span class=\"p\">:</span> <span class=\"kc\">false</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"isSummary\"</span> <span class=\"p\">:</span> <span class=\"kc\">false</span>\n      <span class=\"p\">}</span>\n</code></pre></div>\n<p>Furthermore, when the snapshot drills into the <code>subject-id</code> reslice, it doesn't fix the <code>uri</code> in the <code>AuditEvent.agent:user.extension:otherId/subject-id.url</code> element, presumably because it is creating those elements based off <code>Extension</code> when it <em>should</em> be creating them based off the elements in the <code>http://profiles.ihe.net/ITI/BasicAudit/StructureDefinition/ihe-otherId</code> extension.</p>\n<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> - is this a known limitation of the snapshot generator?</p>",
        "id": 263919204,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1638822112
    },
    {
        "content": "<p>BTW -- I also agree w/ what <span class=\"user-mention\" data-user-id=\"192166\">@Jean Duteau</span> noted in the corresponding thread in the <a class=\"stream\" data-stream-id=\"215610\" href=\"/#narrow/stream/215610-shorthand\">#shorthand</a> channel, which is that the discriminator also needs to be updated to <code>value.identifier.type</code> or <code>(value as Reference).identifier.type</code> since <code>valueReference</code> is not a valid path in FHIRPath.</p>",
        "id": 263919760,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1638822273
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191469\">Chris Moesel</span> <a href=\"#narrow/stream/179252-IG-creation/topic/slicing.20sliced.20extension/near/263919760\">said</a>:</p>\n<blockquote>\n<p>BTW -- I also agree w/ what <span class=\"user-mention silent\" data-user-id=\"192166\">Jean Duteau</span> noted in the corresponding thread in the <a class=\"stream\" data-stream-id=\"215610\" href=\"/#narrow/stream/215610-shorthand\">#shorthand</a> channel, which is that the discriminator also needs to be updated to <code>value.identifier.type</code> or <code>(value as Reference).identifier.type</code> since <code>valueReference</code> is not a valid path in FHIRPath.</p>\n</blockquote>\n<p>I can try,  sushi does not like either of those suggestions.</p>",
        "id": 263920572,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638822727
    },
    {
        "content": "<p>this is what I have</p>\n<div class=\"codehilite\"><pre><span></span><code>* agent[user].extension[otherId][subject-id].valueReference.identifier.type = OtherIdentifierTypes#SAML-subject-id\n</code></pre></div>\n<p>what do you recommend I try?</p>",
        "id": 263920791,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638822861
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191404\">@John Moehrke</span> -- I'm talking about the discriminator path only.  E.g., you probably have some FSH something like this:</p>\n<div class=\"codehilite\"><pre><span></span><code>* agent[user].extension[otherId] ^slicing.discriminator.path = &quot;valueReference.identifier.type&quot;\n</code></pre></div>\n<p>But that needs to be this:</p>\n<div class=\"codehilite\"><pre><span></span><code>* agent[user].extension[otherId] ^slicing.discriminator.path = &quot;value.identifier.type&quot;\n</code></pre></div>\n<p>or this:</p>\n<div class=\"codehilite\"><pre><span></span><code>* agent[user].extension[otherId] ^slicing.discriminator.path = &quot;(value as Reference).identifier.type&quot;\n</code></pre></div>",
        "id": 263921273,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1638823091
    },
    {
        "content": "<p>ah, I tried the second, and sushi passed. Ill run that thru</p>",
        "id": 263921603,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638823289
    },
    {
        "content": "<p>that built, but did not change the result</p>",
        "id": 263922379,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638823721
    },
    {
        "content": "<p>I do have a more simple one that is equally failing. This one is not doing anything with an extension. it is just slicing a slice. The first slice defines .entity[consent]; this second slice within that first one.. This is also just a #value slice on a less deep .type element.</p>\n<div class=\"codehilite\"><pre><span></span><code>* entity[consent].detail ^slicing.discriminator.type = #value\n* entity[consent].detail ^slicing.discriminator.path = &quot;type&quot;\n* entity[consent].detail ^slicing.rules = #open\n* entity[consent].detail contains\n    acp 0..1 and\n    patient-id 0..1\n* entity[consent].detail[acp].type = &quot;urn:ihe:iti:xua:2012:acp&quot;\n* entity[consent].detail[acp].valueString 1..1 MS\n* entity[consent].detail[acp].valueString ^short = &quot;Home Community ID where the Consent is.&quot;\n* entity[consent].detail[patient-id].type = &quot;urn:oasis:names:tc:xacml:2.0:resource:resource-id&quot;\n* entity[consent].detail[patient-id].valueString 1..1 MS\n* entity[consent].detail[patient-id].valueString ^short = &quot;The Patient Identity where the Consent is.&quot;\n</code></pre></div>",
        "id": 263922899,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638824003
    },
    {
        "content": "<p>Ah... that last one <em>might</em> be due to a mismatch between the discriminator type and the type of fixed value (pattern vs fixed).  If the discriminator type is <code>#value</code>, then you should put <code>(exactly)</code> at the end of the assignment rule for the path being discriminated on.  E.g.:</p>\n<div class=\"codehilite\"><pre><span></span><code>* entity[consent].detail[acp].type = &quot;urn:ihe:iti:xua:2012:acp&quot; (exactly)\n// ...\n* entity[consent].detail[patient-id].type = &quot;urn:oasis:names:tc:xacml:2.0:resource:resource-id&quot; (exactly)\n</code></pre></div>\n<p>Or you can leave those as-is and change the discriminator type to <code>#pattern</code>.</p>",
        "id": 263923653,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1638824366
    },
    {
        "content": "<p>note that in this case .type is a datatype string</p>",
        "id": 263925076,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638825018
    },
    {
        "content": "<p>Yep. String datatypes can use pattern too since string also allows for <code>id</code> and <code>extension</code> sub-elements.</p>",
        "id": 263926104,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1638825574
    },
    {
        "content": "<p>well, that didn't change any results.</p>",
        "id": 263926801,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638825947
    },
    {
        "content": "<p>so, clarification.. the slicing I have on .entity is not throwing the same errors... sorry. (different problem, will bring that up later)</p>",
        "id": 263927200,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638826161
    },
    {
        "content": "<p>all of my errors (42) are around slicing of my extension</p>",
        "id": 263927319,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638826210
    },
    {
        "content": "<p>I might have stumbled on an issue... In my case I had a base profile that setup the initial conditions for the .agent[user] slice. I derived a second profile off of that and further elaborated what you see. When I explicitly copy that first profile in to the second; The problems are less noisy, but not sure they are better</p>\n<div class=\"codehilite\"><pre><span></span><code>AuditEvent.agent[0].extension[0] (l32/c10)  error   Slicing cannot be evaluated: illegal expression syntax in discriminator (group) (@char 3)\nAuditEvent.agent[0].extension[1] (l43/c10)  error   Slicing cannot be evaluated: illegal expression syntax in discriminator (group) (@char 3)\nAuditEvent.agent[0].extension[2] (l59/c10)  error   Slicing cannot be evaluated: illegal expression syntax in discriminator (group) (@char 3)\nAuditEvent.agent[0].extension[3] (l75/c10)  error   Slicing cannot be evaluated: illegal expression syntax in discriminator (group) (@char 3)\n</code></pre></div>",
        "id": 263931143,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638828182
    },
    {
        "content": "<p>Those errors seem very different.  I don't know what's going on there.</p>",
        "id": 263932352,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1638828779
    },
    {
        "content": "<p>I cloned your repo and built it -- then <em>manually</em> edited the JSON StructureDefinition profile so that the slices declared the correct type (for the ihe-otherId extension).  When I did that, the errors changed to errors like this:</p>\n<blockquote>\n<p>AuditEvent.agent[0].extension[1] (l43/c10)   error   Profile <a href=\"http://profiles.ihe.net/ITI/BasicAudit/StructureDefinition/ITI.BasicAudit.SAMLaccessTokenUse.Comprehensive.Norway\">http://profiles.ihe.net/ITI/BasicAudit/StructureDefinition/ITI.BasicAudit.SAMLaccessTokenUse.Comprehensive.Norway</a>, Element matches more than one slice - otherId, otherId/subject-id</p>\n</blockquote>\n<p>I don't understand this error because <code>otherId/subject-id</code> is a <em>reslice</em> of <code>otherId</code> -- so of course the element matches against both.  It can't match on <code>otherId/subect-id</code> without also matching on <code>otherId</code>.  <span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span>, am I missing something?  Wouldn't you <em>expect</em> an element that matches a reslice to also match the top-level slice?  Shouldn't the validator know to prefer the more specific re-slice?</p>",
        "id": 263933225,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1638829173
    },
    {
        "content": "<p>Yeah, that seems a little odd as a message.  <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span>?</p>",
        "id": 263940409,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1638833939
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> here is my github repo with this IG <a href=\"https://github.com/IHE/ITI.BasicAudit\">https://github.com/IHE/ITI.BasicAudit</a></p>",
        "id": 264008943,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638887392
    },
    {
        "content": "<p>I created a mini IG that has the minimum needed to show the problem I have <a href=\"https://github.com/JohnMoehrke/SlicingSlicedExtension\">https://github.com/JohnMoehrke/SlicingSlicedExtension</a></p>",
        "id": 264014548,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638890029
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>Extension: OtherId\nTitle: &quot;AuditEvent.agent other identifiers&quot;\nDescription: &quot;Carries other identifiers that are known for an agent.&quot;\n* value[x] only Reference\n\n\nProfile:        SecondSliceProfile\nParent:         AuditEvent\nTitle:          &quot;Profile with slices of extension in a slice&quot;\nDescription:    &quot;&quot;&quot;\n- slices .agent[user]\n- slices .agent extension otherId\n&quot;&quot;&quot;\n* agent.extension contains OtherId named otherId 0..* MS\n* agent ^slicing.discriminator.type = #pattern\n* agent ^slicing.discriminator.path = &quot;type&quot;\n* agent ^slicing.rules = #open\n* agent contains\n    user 1..\n* agent[user].type = http://terminology.hl7.org/CodeSystem/v3-ParticipationType#IRCP &quot;information recipient&quot;\n* agent[user].who 1..1\n* agent[user].extension[otherId] ^slicing.discriminator.type = #pattern\n* agent[user].extension[otherId] ^slicing.discriminator.path = &quot;(value as Reference).identifier.type&quot;\n* agent[user].extension[otherId] ^slicing.rules = #open\n* agent[user].extension[otherId] contains\n    npi 0..1 and\n    provider-id 0..1\n* agent[user].extension[otherId][npi].valueReference.identifier.type = http://terminology.hl7.org/CodeSystem/v2-0203#NPI\n* agent[user].extension[otherId][provider-id].valueReference.identifier.type = http://terminology.hl7.org/CodeSystem/v2-0203#PRN\n</code></pre></div>",
        "id": 264014626,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638890054
    },
    {
        "content": "<p>the problem is here:</p>\n<blockquote>\n<p>Slice: Unordered, Open by pattern:(value as Reference).identifier.type</p>\n</blockquote>\n<p>because the rule is <a href=\"https://hl7.org/fhir/fhirpath.html#simple\">https://hl7.org/fhir/fhirpath.html#simple</a>:</p>\n<blockquote>\n<ul>\n<li>All statements SHALL start with the name of the context element (e.g. on a Patient resource, <a href=\"http://Patient.contact.name\">Patient.contact.name</a>.), or SHALL be simply \"$this\" to refer to the element that has focus</li>\n<li>Operators SHALL NOT be used</li>\n<li>Only the following functions may be used:<ul>\n<li>.resolve()</li>\n<li>.extension(\"url\")</li>\n<li>.ofType(type)</li>\n</ul>\n</li>\n</ul>\n</blockquote>",
        "id": 264114245,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1638941665
    },
    {
        "content": "<p>so the descriminator needs to be</p>",
        "id": 264114260,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1638941696
    },
    {
        "content": "<p><code>$this.value.ofType(Reference).identifier.type</code></p>",
        "id": 264114269,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1638941716
    },
    {
        "content": "<p>I knew it was my fault. Thankyou <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> <br>\nNote, I now get an error <code> illegal use of ofType() </code></p>",
        "id": 264144925,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638964814
    },
    {
        "content": "<p>did you commit that?</p>",
        "id": 264193620,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1638986067
    },
    {
        "content": "<p>yes</p>",
        "id": 264197622,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638987578
    },
    {
        "content": "<p>any other recommendations for solving this? My sample IG has the last recommendation, and qa shows the new failure.<br>\n<a href=\"https://github.com/JohnMoehrke/SlicingSlicedExtension/\">https://github.com/JohnMoehrke/SlicingSlicedExtension/</a></p>",
        "id": 264303685,
        "sender_full_name": "John Moehrke",
        "timestamp": 1639057963
    },
    {
        "content": "<p>it's on my todo list</p>",
        "id": 264352517,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1639077521
    },
    {
        "content": "<p>so I had a go at this but I think there's something wrong with your definitions. Have a look at the test case I've just added to the validator tests - which seems to work, and compare it with yours. I don't think you've got the slicing set up quite right</p>",
        "id": 265793413,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1640172433
    },
    {
        "content": "<p>The difference I detect is that you don't use the '/' character in the sliceName and the id of that slice. I see that id datatype doesn't allow '/' character. (I did see it in other id elements in that example. Seems like a sushi problem?</p>",
        "id": 265810614,
        "sender_full_name": "John Moehrke",
        "timestamp": 1640183215
    },
    {
        "content": "<p>I have not had the time to look at Grahame's example, but the <code>/</code> character is used when you are re-slicing.  In other words, if there is an existing slice defined and you need to create sub-slices within that slice, this is called re-slicing.  And in re-slicing, the sliceName is <code>${parentSliceName}/{subSliceName}</code>.  See <a href=\"http://hl7.org/fhir/R4/profiling.html#reslicinghttp://hl7.org/fhir/R4/profiling.html#reslicing\">Re-profiling and Re-slicing</a> (particularly the last paragraph).</p>",
        "id": 265812179,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1640184187
    },
    {
        "content": "<p>sorry for the distraction, I tried fixing the '/'.. not the problem.</p>",
        "id": 265813300,
        "sender_full_name": "John Moehrke",
        "timestamp": 1640184797
    },
    {
        "content": "<p>latest build still fails on this.  Deeper discussion of the problem <a href=\"#narrow/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this\">https://chat.fhir.org/#narrow/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this</a><br>\nThe problem is identified, the solution is not so clear. Is this sushi or validator issue to resolve?</p>",
        "id": 265915133,
        "sender_full_name": "John Moehrke",
        "timestamp": 1640265227
    },
    {
        "content": "<p>well, it passes my test. did you compare the two?</p>",
        "id": 265915673,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1640265644
    },
    {
        "content": "<p>yes, that is what is in the other stream</p>",
        "id": 265915844,
        "sender_full_name": "John Moehrke",
        "timestamp": 1640265808
    },
    {
        "content": "<p>I didn't want to duplicate, and the issue is related to sushi handling</p>",
        "id": 265915946,
        "sender_full_name": "John Moehrke",
        "timestamp": 1640265868
    },
    {
        "content": "<p>I'm not so sure it is related to SUSHI handling.  John's solution was to remove the <code>sliceName</code> property from the element with id: <code>AuditEvent.agent:user.extension:otherId</code>.  Since that element clearly <em>is</em> a slice, then I think it's completely appropriate for SUSHI to include the <code>sliceName</code> in the differential.  In fact, based on previous conversations, I was under the impression that we <em>must</em> always put <code>sliceName</code> in the differential for a slice element.</p>\n<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> -- I also found some things in your test example that didn't seem right to me based on my understanding of slicing, re-slicing, and the relationship between <code>sliceName</code> and <code>id</code>.</p>",
        "id": 265944826,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1640287005
    },
    {
        "content": "<p>Details are in the <a href=\"#narrow/stream/215610-shorthand/topic/slicing.20with.20complex.20.24this/near/265819221\">other thread</a>.</p>",
        "id": 265944845,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1640287022
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> poke</p>",
        "id": 266504929,
        "sender_full_name": "John Moehrke",
        "timestamp": 1640959199
    },
    {
        "content": "<p>I have created a test IG that focuses only on the situation I have. I am slicing an extension that is within a slice.. and am struggling. -- <a href=\"http://build.fhir.org/ig/JohnMoehrke/SlicingSlicedExtension/branches/main/index.html\">http://build.fhir.org/ig/JohnMoehrke/SlicingSlicedExtension/branches/main/index.html</a></p>",
        "id": 275395462,
        "sender_full_name": "John Moehrke",
        "timestamp": 1647360840
    },
    {
        "content": "<p>I keep getting errors, so I presume I am defining my slicing discriminator</p>\n<div class=\"codehilite\"><pre><span></span><code>* agent[user].extension[extOtherId] ^slicing.discriminator.type = #value\n* agent[user].extension[extOtherId] ^slicing.discriminator.path = &quot;$this.value.ofType(Reference).identifier.type&quot;\n* agent[user].extension[extOtherId] ^slicing.rules = #open\n* agent[user].extension[extOtherId] contains\n</code></pre></div>",
        "id": 275395649,
        "sender_full_name": "John Moehrke",
        "timestamp": 1647360897
    },
    {
        "content": "<p>tried #value and #pattern.. same result</p>",
        "id": 275395685,
        "sender_full_name": "John Moehrke",
        "timestamp": 1647360910
    },
    {
        "content": "<p>so on my examples in that IG I get validation error</p>\n<div class=\"codehilite\"><pre><span></span><code>Slicing cannot be evaluated: Could not match discriminator ([$this.value.ofType(Reference).identifier.type]) for slice AuditEvent.agent:user.extension:extOtherId in profile http://johnmoehrke.github.io/SlicingSlicedExtension/StructureDefinition/ThirdSliceProfile - the discriminator [$this.value.ofType(Reference).identifier.type] does not have fixed value, binding or existence assertions\n</code></pre></div>",
        "id": 275395780,
        "sender_full_name": "John Moehrke",
        "timestamp": 1647360958
    },
    {
        "content": "<p>OK. I have been looking into this and experimenting w/ it.  I think it comes down to quirks (bugs?) in snapshot generation.</p>\n<p>Here is the basic slicing structure of John's example profile:</p>\n<ul>\n<li><code>AuditEvent.agent</code> is sliced by <code>pattern</code> on <code>type</code><ul>\n<li>Slices: <code>user</code>, <code>userorg</code></li>\n</ul>\n</li>\n<li><code>AuditEvent.agent.extension</code> is sliced by <code>value</code> on <code>url</code> (typical extension slicing)<ul>\n<li>Slices: <code>extOtherId</code></li>\n</ul>\n</li>\n<li><code>AuditEvent.agent:user.extension:extOtherId</code> is <em>resliced</em> by <code>pattern</code> on <code>$this.value.ofType(Reference).identifier.type</code><ul>\n<li>Slices: <code>extOtherId/npi</code>, <code>extOtherId/provider-id</code></li>\n</ul>\n</li>\n</ul>\n<p>The first problem I noticed is that the snapshot generator was putting the re-slicing information on the <em>wrong</em> element. John's example had this in the differential:</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"id\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent:user\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"path\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"sliceName\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"user\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"min\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"max\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"w\"></span>\n<span class=\"p\">},</span><span class=\"w\"></span>\n<span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"id\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent:user.extension:extOtherId\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"path\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent.extension\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"sliceName\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"extOtherId\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"slicing\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nt\">\"discriminator\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[{</span><span class=\"w\"> </span><span class=\"nt\">\"type\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"pattern\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nt\">\"path\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"$this.value.ofType(Reference).identifier.type\"</span><span class=\"w\"> </span><span class=\"p\">}],</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nt\">\"rules\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"open\"</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">},</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"min\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"max\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"type\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"nt\">\"code\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Extension\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"nt\">\"profile\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"s2\">\"http://johnmoehrke.github.io/SlicingSlicedExtension/StructureDefinition/OtherId\"</span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">],</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"mustSupport\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Note that the re-slicing info is on <code>AuditEvent.agent:user.extension:extOtherId</code>.</p>\n<p>But the snapshot was coming out like this (I've omitted properties for brevity):</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"id\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent:user\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"path\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"sliceName\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"user\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"...\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"w\"></span>\n<span class=\"p\">},</span><span class=\"w\"></span>\n<span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"id\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent:user.id\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"path\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent.id\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"...\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"w\"></span>\n<span class=\"p\">},</span><span class=\"w\"></span>\n<span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"id\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent:user.extension\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"path\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent.extension\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"slicing\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nt\">\"discriminator\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[{</span><span class=\"w\"> </span><span class=\"nt\">\"type\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"pattern\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nt\">\"path\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"$this.value.ofType(Reference).identifier.type\"</span><span class=\"w\"> </span><span class=\"p\">}],</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nt\">\"rules\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"open\"</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">},</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"...\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"w\"></span>\n<span class=\"p\">},</span><span class=\"w\"></span>\n<span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"id\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent:user.extension:extOtherId\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"path\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent.extension\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"sliceName\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"extOtherId\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"...\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"type\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"nt\">\"code\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Extension\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"nt\">\"profile\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"s2\">\"http://johnmoehrke.github.io/SlicingSlicedExtension/StructureDefinition/OtherId\"</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">],</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"...\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Note that the re-slicing information (by pattern on the identifier type) is now on the <em>wrong</em> element.  It's on <code>AuditEvent.agent:user.extension</code> instead of <code>AuditEvent.agent:user.extension:extOtherId</code>.</p>\n<p>I wondered if maybe the snapshot generator needed the <code>AuditEvent.agent:user.extension</code> to redeclare its slicing in the differential (even though the slicing was already declared in the sliced element).  So I added that element to the differential as below:</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"id\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent:user\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"path\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"sliceName\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"user\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"min\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"max\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"w\"></span>\n<span class=\"p\">},</span><span class=\"w\"></span>\n<span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"id\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent:user.extension\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"path\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent.extension\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"slicing\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nt\">\"discriminator\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[{</span><span class=\"w\"> </span><span class=\"nt\">\"type\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"value\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nt\">\"path\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"url\"</span><span class=\"w\"> </span><span class=\"p\">}],</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nt\">\"ordered\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nt\">\"rules\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"open\"</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">},</span><span class=\"w\"></span>\n<span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"id\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent:user.extension:extOtherId\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"path\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent.extension\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"sliceName\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"extOtherId\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"slicing\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nt\">\"discriminator\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[{</span><span class=\"w\"> </span><span class=\"nt\">\"type\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"pattern\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nt\">\"path\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"$this.value.ofType(Reference).identifier.type\"</span><span class=\"w\"> </span><span class=\"p\">}],</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nt\">\"rules\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"open\"</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">},</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"min\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"max\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"type\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"nt\">\"code\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Extension\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"nt\">\"profile\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"s2\">\"http://johnmoehrke.github.io/SlicingSlicedExtension/StructureDefinition/OtherId\"</span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">],</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"mustSupport\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>(The 2nd element above is what I added to the differential in John's example).</p>\n<p>But now the snapshot generator had the <em>correct</em> slicing on <code>AuditEvent.agent:user.extension</code>, but completely <em>omitted</em> the reslicing on <code>AuditEvent.agent:user.extension:extOtherId</code>:</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"id\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent:user\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"path\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"sliceName\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"user\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"...\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"w\"></span>\n<span class=\"p\">},</span><span class=\"w\"></span>\n<span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"id\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent:user.id\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"path\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent.id\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"...\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"w\"></span>\n<span class=\"p\">},</span><span class=\"w\"></span>\n<span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"id\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent:user.extension\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"path\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent.extension\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"slicing\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nt\">\"discriminator\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[{</span><span class=\"w\"> </span><span class=\"nt\">\"type\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"value\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nt\">\"path\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"url\"</span><span class=\"w\"> </span><span class=\"p\">}],</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nt\">\"ordered\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nt\">\"rules\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"open\"</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">},</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"...\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"w\"></span>\n<span class=\"p\">},</span><span class=\"w\"></span>\n<span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"id\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent:user.extension:extOtherId\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"path\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"AuditEvent.agent.extension\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"sliceName\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"extOtherId\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"_NOTE: We should see a slicing here with the re-slicing information\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"...\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"type\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"nt\">\"code\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Extension\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"nt\">\"profile\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"s2\">\"http://johnmoehrke.github.io/SlicingSlicedExtension/StructureDefinition/OtherId\"</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">],</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">\"...\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Note that the <code>slicing</code> is <em>gone</em> from <code>AuditEvent.agent:user.extension:extOtherId</code>. Without that reslicing info, the <code>extOtherId/npi</code> and <code>extOtherId/provider-id</code> slices aren't valid slices (since they're no longer unique according to the discriminator). So that just caused <em>different</em> errors in validation.</p>\n<p>I'd prefer that we do not need to redeclare slicings that have already been defined on a sliced element (approach 1 above), but I know the IG Publisher is limited in its ability to see and carry over constraints from the sliced element.</p>\n<p>But I'm pretty sure approach 2 above <em>should work</em>.  I'm not sure why the snapshot generator is <em>dropping</em> the reslicing information on <code>AuditEvent.agent:user.extension:extOtherId</code>. <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span>?</p>",
        "id": 275577171,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1647464754
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> can you help with how this should look?</p>",
        "id": 276077644,
        "sender_full_name": "John Moehrke",
        "timestamp": 1647880016
    },
    {
        "content": "<p>given some discussion today in security, that leads my use-case to be simplified to just adding extensions that are Identifiers, rather that References that I only use as Identifiers. So I simplified my test IG, and even the more simple version fails.  Note that this doesn't even slice the extension within a slice, I defined the fine grain slice in a way independent of the gross slice... so I am very conflused as to why this one is not working.</p>",
        "id": 276102402,
        "sender_full_name": "John Moehrke",
        "timestamp": 1647891062
    },
    {
        "content": "<p>in this version I am defining the otherId slice independent of the user slice, and using the more simple Identifier. Thus my discriminator is much easier too. but still no love at the example validation.</p>",
        "id": 276103590,
        "sender_full_name": "John Moehrke",
        "timestamp": 1647891717
    },
    {
        "content": "<p>I am still stuck. Might this be similar to the nested sections slicing problem? Seems similar.</p>",
        "id": 276869911,
        "sender_full_name": "John Moehrke",
        "timestamp": 1648472742
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191404\">John Moehrke</span> <a href=\"#narrow/stream/179252-IG-creation/topic/slicing.20sliced.20extension/near/276869911\">said</a>:</p>\n<blockquote>\n<p>I am still stuck. Might this be similar to the nested sections slicing problem? Seems similar.</p>\n</blockquote>\n<p>sushi works with your example or only the IG Publisher?<br>\nThe nested section only fails on the IGPub</p>",
        "id": 276870301,
        "sender_full_name": "João Almeida",
        "timestamp": 1648472897
    },
    {
        "content": "<p>yes, for me it really only fails on validating my examples.</p>",
        "id": 276870357,
        "sender_full_name": "John Moehrke",
        "timestamp": 1648472924
    },
    {
        "content": "<p>see above for the long discussion.</p>",
        "id": 276870405,
        "sender_full_name": "John Moehrke",
        "timestamp": 1648472950
    },
    {
        "content": "<p>it seems that the validator is expecting something in the profile that I am not smart enough to put in there.</p>",
        "id": 276870511,
        "sender_full_name": "John Moehrke",
        "timestamp": 1648472998
    },
    {
        "content": "<p>yes indeed, the \"symptoms\" seem similar to the nested section</p>",
        "id": 276870934,
        "sender_full_name": "João Almeida",
        "timestamp": 1648473224
    },
    {
        "content": "<p>well, I think that the snapshot is correct, and what is trying to be done is the problem</p>",
        "id": 277081117,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1648599893
    },
    {
        "content": "<p>the problem is that the all slices definition of agent defines a slice OtherId, and then so does the user slice on it. So that overrides the slice</p>",
        "id": 277081338,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1648600192
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> -- my understanding was that the validator cannot (or does not) look back to the all slices definition during validation.  In the past, we've had to repeat constraints (such as extension declarations) in each slice for this very reason.  So without the <code>OtherId</code> slice definition on the agent slice (which I view as redundant, rather than an override), the validator wouldn't know the <code>OtherId</code> slice exists.  Is my understanding incorrect?  Does the validator consider the all-slice constraints now when processing each individual slice?</p>",
        "id": 277146624,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1648647973
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191316\">Grahame Grieve</span> <a href=\"#narrow/stream/179252-IG-creation/topic/slicing.20sliced.20extension/near/277081338\">said</a>:</p>\n<blockquote>\n<p>the problem is that the all slices definition of agent defines a slice OtherId, and then so does the user slice on it. So that overrides the slice</p>\n</blockquote>\n<p>I would far prefer this, but it gives the same problem.</p>",
        "id": 277149945,
        "sender_full_name": "John Moehrke",
        "timestamp": 1648649281
    },
    {
        "content": "<p>well,  I think that <span class=\"user-mention\" data-user-id=\"191469\">@Chris Moesel</span> is right, but the slice doesn't pick up anything from the all slices slice, and so the validator doesn't know how to resolve the slices</p>",
        "id": 277227151,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1648695207
    },
    {
        "content": "<p>so, what should the json look like?</p>",
        "id": 277274173,
        "sender_full_name": "John Moehrke",
        "timestamp": 1648730604
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> - John and I have experimented w/ many different formations of the SD and haven't been able to find a successful representation that passes instance validation without error.  If you can provide a differential that works, I suspect we can learn from it and then apply it to future situations.  But like John, I am stumped -- and I don't know if everything we've tried is truly wrong or if we're just hitting validator or publisher bugs/limitations.</p>",
        "id": 277279097,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1648732814
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191469\">@Chris Moesel</span> <span class=\"user-mention\" data-user-id=\"191404\">@John Moehrke</span> I have spent a few days looking at this. I do not believe that what you are doing with the slices makes sense or is documented.</p>",
        "id": 277823210,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1649128985
    },
    {
        "content": "<p>the relevant documentation is</p>",
        "id": 277823214,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1649128993
    },
    {
        "content": "<blockquote>\n<p>In addition to the above, there are times when Profile C will need to further slice a slice defined in B. In this case, there's a need to reference both the ElementDefinition.sliceName of the original slice from Profile B as well as to define an ElementDefinition.sliceName for the slice defined within Profile C. This is done by separating the names using \"/\". For example, if Profile B defines the slice \"example\", and profile C defines the slice \"example/example1\", then this is deemed to be \"example1\" slice of the example slice. This process can continue indefinitely by separating each layer of slicing names with the \"/\" character. This pattern applies to @default too: @default/@default.</p>\n</blockquote>",
        "id": 277823219,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1649129011
    },
    {
        "content": "<p>The documentation talks about doing this from one profile to another. There's nowhere that says you can just go right ahead and do this in the same profile</p>",
        "id": 277823276,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1649129056
    },
    {
        "content": "<p>which is what's happening here.</p>",
        "id": 277823283,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1649129065
    },
    {
        "content": "<p>but I went ahead and implemented the snapshot generation to do that anyway. But then validation gives you:</p>",
        "id": 277823292,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1649129090
    },
    {
        "content": "<p>RROR: AuditEvent.agent[0].extension[0]: Profile <a href=\"http://hl7.org/fhir/test/StructureDefinition/Slice23\">http://hl7.org/fhir/test/StructureDefinition/Slice23</a>, Element matches more than one slice - extOtherId, extOtherId/npi</p>",
        "id": 277823325,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1649129145
    },
    {
        "content": "<p>and indeed it does, and must.</p>",
        "id": 277823329,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1649129150
    },
    {
        "content": "<p>I don't see how what you're doing can work</p>",
        "id": 277823344,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1649129161
    },
    {
        "content": "<p>so what are you actually trying to achieve?</p>",
        "id": 277823516,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1649129365
    },
    {
        "content": "<p>Here is what I am trying to do, I would be happy for someone to express how to do this in json/xml.</p>\n<ol>\n<li>I need to slice the AuditEvent.agent as there are multiple kinds of agent the profile is defining, so want to identify a slice for the (user) agent.</li>\n<li>In that slice for describing the user, I have more identifiers to record than the AuditEvent.agent supports. so I add an extension (extOtherIds)</li>\n<li>In that extension that allows me to record more identifiers, I have a some flavors of identifier that I also want to define (npi, and prn)</li>\n</ol>\n<p>Note: For 2, I have tried to define this in the first (user) slice, and have tried it at the root. </p>\n<p>Here is my github - <a href=\"https://github.com/JohnMoehrke/SlicingSlicedExtension\">https://github.com/JohnMoehrke/SlicingSlicedExtension</a></p>",
        "id": 277867014,
        "sender_full_name": "John Moehrke",
        "timestamp": 1649160488
    },
    {
        "content": "<p>This github is very focused only on this problem/need.</p>",
        "id": 277867374,
        "sender_full_name": "John Moehrke",
        "timestamp": 1649160675
    }
]