[
    {
        "content": "<p>I'm continuing to work through the issues the snapshot generator has with the Dutch profiles. </p>\n<p>I've run into something I'm not sure we've discussed, around slicing on elements that have a choice of types.</p>\n<p>In (B) the base spec, an element that has a choice of types is sliced by type on $this, and closed.<br>\nIn (C) a derived profile, the profile constrains one of the types, but says that the slicing is open <br>\nIn (D) a derived profile on profile (C), it profiles one of the types (a different one) but says that the slicing is open<br>\nIn (E) a derived profile on profile (C), it profiles one of the types (the same one) but says that the slicing is open</p>\n<p>.. the java snapshot generator just refuses to process this.</p>\n<p>I think that it remains closed, irrespective of what C|D|E claim... but they just don't close off the other slices if they claim it's open. Is that right?</p>\n<p>I'm hoping someone from firely (<span class=\"user-mention\" data-user-id=\"191336\">@Michel Rutten</span>, <span class=\"user-mention\" data-user-id=\"191335\">@Martijn Harthoorn</span>, <span class=\"user-mention\" data-user-id=\"191757\">@Christiaan Knaap</span> ?) can clarify how the C# snapshot generator works on this</p>",
        "id": 182253089,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1575144206
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"193551\">@Marco Visser</span> for the C# snapshot generator</p>",
        "id": 182344603,
        "sender_full_name": "Christiaan Knaap",
        "timestamp": 1575293386
    },
    {
        "content": "<p>I added some tests around this. I strongly encourage <span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> and <span class=\"user-mention\" data-user-id=\"193551\">@Marco Visser</span> to review this commit:</p>",
        "id": 182407333,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1575335983
    },
    {
        "content": "<p><a href=\"https://github.com/FHIR/fhir-test-cases/commit/81ae5978bc2b8562e5aff0da066a0d80d453bea8\" target=\"_blank\" title=\"https://github.com/FHIR/fhir-test-cases/commit/81ae5978bc2b8562e5aff0da066a0d80d453bea8\">https://github.com/FHIR/fhir-test-cases/commit/81ae5978bc2b8562e5aff0da066a0d80d453bea8</a></p>",
        "id": 182407403,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1575336026
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span>  I will incorporate those tests in our fhir-net-api unittests in the coming week. But first I am all focused on the technical correction (4.0.1), so that our fhir-net-api is working again.</p>",
        "id": 182429839,
        "sender_full_name": "Marco Visser",
        "timestamp": 1575365986
    },
    {
        "content": "<p>ok thanks</p>",
        "id": 182430083,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1575366153
    },
    {
        "content": "<p>Hi Grahame, I'm looking into this now. Got them loaded into our unit tests. First issue I encountered was that obs 1-0  obs1-1 and obs 1-2 all have  to same canonical URL. And that obs1-1 and obs 1-2 have a baseDefinition that is the same as their canonical URLs.</p>\n<p>And obs1_2, obs2_3, and obs3_0, don't have an -expected file. Is that on purpose?</p>",
        "id": 182754793,
        "sender_full_name": "Marten Smits",
        "timestamp": 1575634949
    },
    {
        "content": "<p>generating a snapshot fails for 1-2, 2-3 and 3 all are illegal so there's no snapshot</p>",
        "id": 182788366,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1575656421
    },
    {
        "content": "<p>I'll fix the URLs</p>",
        "id": 182788610,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1575656593
    },
    {
        "content": "<p>Alright, I'll compare our results, and will get back to you</p>",
        "id": 182937445,
        "sender_full_name": "Marten Smits",
        "timestamp": 1575883938
    },
    {
        "content": "<p>Compared results and have two major differences:<br>\n- In obs-1 you leave out the discriminator in the diff, and implicitly assume a slice on <code>value[x]</code> is a type slice, with discriminator <code>$this</code>. Is it best practice to leave it out of the diff? I'd expect an editor tool to handle implicit type slices and give the snapshot generator explicit instructions. The .NET snapshot generator in this case only \"copies\" over <code>slicing.rules</code> from the diff to the snapshot, and doesn't do the magic you do.<br>\nAnd Ã­f you leave out the discriminator, you should add a slicing.description according to eld-1.</p>\n<p>- In obs-2 the diff says:</p>\n<div class=\"codehilite\"><pre><span></span> &lt;element&gt;\n      &lt;path value=&quot;Observation.value[x]&quot;/&gt;\n      &lt;slicing&gt;\n        &lt;rules value=&quot;open&quot;/&gt;\n      &lt;/slicing&gt;\n      &lt;type&gt;\n        &lt;code value=&quot;CodeableConcept&quot;/&gt;\n      &lt;/type&gt;\n    &lt;/element&gt;\n    &lt;element&gt;\n      &lt;path value=&quot;Observation.value[x]&quot;/&gt;\n      &lt;sliceName value=&quot;valueCodeableConcept&quot;/&gt;\n      &lt;type&gt;\n        &lt;code value=&quot;CodeableConcept&quot;/&gt;\n      &lt;/type&gt;\n      &lt;binding&gt;\n        &lt;strength value=&quot;required&quot;/&gt;\n        &lt;valueSet value=&quot;http://somewhere/something&quot;/&gt;\n      &lt;/binding&gt;\n    &lt;/element&gt;\n  &lt;/differential&gt;\n</pre></div>\n\n\n<p>And in the snapshot <code>slice.rules</code>  is suddenly closed, and all original types are repeated again in the type array. I think that this indeed means the same thing, but it is not behavior I'd expect at all. I always thought that if you edit the type array in the diff, the whole list becomes the new truth, and that this is also the appropriate way to constrain types out for example. Otherwise you can only do that by introducing a type slice and close it explicitly? <br>\nI thought type slices are always closed and you explicitly specify which types are allowed in the type array in the diff. And if you want to include all the allowed types, you leave out the type array entirely in the diff.</p>",
        "id": 182965439,
        "sender_full_name": "Marten Smits",
        "timestamp": 1575905048
    },
    {
        "content": "<blockquote>\n<p>Is it best practice to leave it out of the diff?</p>\n</blockquote>\n<p>no. but it's allowed</p>",
        "id": 183030333,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1575955400
    },
    {
        "content": "<p>with regard to 2... I asked... but if the list of slices is closed, and you constrain one and leave the others open... then it's still closed when you're done, you just left the others untouched</p>",
        "id": 183030391,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1575955473
    },
    {
        "content": "<p>so that's what the test is testing</p>",
        "id": 183030393,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1575955478
    },
    {
        "content": "<blockquote>\n<blockquote>\n<p>Is it best practice to leave it out of the diff?</p>\n</blockquote>\n<p>no. but it's allowed</p>\n</blockquote>\n<p>Ok, I'll file an issue here to handle that in the .NET snapshotgenerator</p>",
        "id": 183046338,
        "sender_full_name": "Marten Smits",
        "timestamp": 1575973263
    },
    {
        "content": "<blockquote>\n<p>with regard to 2... I asked... but if the list of slices is closed, and you constrain one and leave the others open... then it's still closed when you're done, you just left the others untouched</p>\n</blockquote>\n<p>Agree.</p>",
        "id": 183048734,
        "sender_full_name": "Marten Smits",
        "timestamp": 1575975258
    },
    {
        "content": "<p>But then you should still mention all possible types in the diff of the slice intro. Otherwise how will you specify this that you type slice (open), only allow codeableconcept and quantity, and put a binding on codeableconcept. I think that should look like this:</p>\n<div class=\"codehilite\"><pre><span></span>&lt;differential&gt;\n   &lt;element&gt;\n    &lt;path value=&quot;Observation.value[x]&quot;/&gt;\n    &lt;slicing&gt;\n      &lt;rules value=&quot;open&quot;/&gt;\n    &lt;/slicing&gt;\n    &lt;type&gt;\n      &lt;code value=&quot;CodeableConcept&quot;/&gt;\n    &lt;/type&gt;\n    &lt;type&gt;\n      &lt;code value=&quot;Quantity&quot;/&gt;\n    &lt;/type&gt;\n  &lt;/element&gt;\n  &lt;element&gt;\n    &lt;path value=&quot;Observation.value[x]&quot;/&gt;\n    &lt;sliceName value=&quot;valueCodeableConcept&quot;/&gt;\n    &lt;type&gt;\n      &lt;code value=&quot;CodeableConcept&quot;/&gt;\n    &lt;/type&gt;\n    &lt;binding&gt;\n      &lt;strength value=&quot;required&quot;/&gt;\n      &lt;valueSet value=&quot;http://somewhere/something&quot;/&gt;\n    &lt;/binding&gt;\n  &lt;/element&gt;\n&lt;/differential&gt;\n</pre></div>\n\n\n<p>And if that's true, obs-2 actually describes only codeableconcept is allowed, right?</p>",
        "id": 183049303,
        "sender_full_name": "Marten Smits",
        "timestamp": 1575975737
    },
    {
        "content": "<p>actually, you're right. I updated the tests and added some more</p>",
        "id": 183116652,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1576023777
    },
    {
        "content": "<p>Nice, I'll make time tomorrow to have a look</p>",
        "id": 183136691,
        "sender_full_name": "Marten Smits",
        "timestamp": 1576053423
    },
    {
        "content": "<p>Didn't have time to test this last week and now my holiday has started, so I postponed this to the new year. Will get back to you then.</p>",
        "id": 183564971,
        "sender_full_name": "Marten Smits",
        "timestamp": 1576513478
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> <br>\nI  have picked this up again.</p>\n<p>Loaded the new tests. I still have doubts about type slices automatically closing:</p>\n<p>In obs-2 the differential states in the slice intro that the slice is open, and after that a binding is set to <code>valueCodeableConcept</code> <br>\nCan you explain why this slice would be closed after snapshot generation? This means I can't introduce a new slice in a derived profile, if I for example want to put a binding on <code>valueQuantity</code>, right?</p>",
        "id": 185200262,
        "sender_full_name": "Marten Smits",
        "timestamp": 1578566382
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> is this still on something you are looking into/ thinking about?</p>",
        "id": 185816584,
        "sender_full_name": "Marten Smits",
        "timestamp": 1579183130
    },
    {
        "content": "<p>sorry. finally getting to this <span class=\"user-mention\" data-user-id=\"191334\">@Marten Smits</span></p>",
        "id": 187027184,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1580416085
    },
    {
        "content": "<ul>\n<li>In the base Observation, the type slicing is closed</li>\n</ul>",
        "id": 187027404,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1580416243
    },
    {
        "content": "<ul>\n<li>In obs-2-input, the profile slices it, and says that it's open. That is, it is making rules about one of the slices, and not saying anything about the others</li>\n</ul>",
        "id": 187027468,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1580416299
    },
    {
        "content": "<ul>\n<li>so the generated snapshot notes those rules, but still has the same closed slicing as the base Observation</li>\n</ul>",
        "id": 187027542,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1580416335
    },
    {
        "content": "<ul>\n<li>you can profile a different slice in a derived profile</li>\n</ul>",
        "id": 187027582,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1580416366
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> Can you explain why type slicing is closed in the base Observation in obs-2? Is that the default for type slicing? Obs-2 is a profile on the core Observation.</p>",
        "id": 187553469,
        "sender_full_name": "Marten Smits",
        "timestamp": 1581000268
    },
    {
        "content": "<p>type slices re always closed, because you can't add any more slices than exist to start wit h</p>",
        "id": 187578005,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1581015956
    },
    {
        "content": "<p>Ah yeah fair enough</p>",
        "id": 187802799,
        "sender_full_name": "Marten Smits",
        "timestamp": 1581329558
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span>, we were having an internal discussion whether you see the use of <code>&lt;rules value=\"open\"/&gt;</code> in <a href=\"https://github.com/FHIR/fhir-test-cases/blob/81ae5978bc2b8562e5aff0da066a0d80d453bea8/r5/snapshot-generation/obs-2-input.xml\" target=\"_blank\" title=\"https://github.com/FHIR/fhir-test-cases/blob/81ae5978bc2b8562e5aff0da066a0d80d453bea8/r5/snapshot-generation/obs-2-input.xml\">obs-2-input.xml</a> as a user error that you're ignoring or correct way of saying \"it is making rules about one of the slices, and not saying anything about the others\".</p>",
        "id": 188911145,
        "sender_full_name": "Ward Weistra",
        "timestamp": 1582536879
    },
    {
        "content": "<p>this:</p>\n<blockquote>\n<p>a correct way of saying \"it is making rules about one of the slices, and not saying anything about the others</p>\n</blockquote>",
        "id": 188919390,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1582545601
    },
    {
        "content": "<p>OK, so instead of slicing rules saying something about the value (open/closed) you want to have in the resulting snapshot, it says something about how the diff content should be interpreted.</p>\n<p>Is the following description then correct?<br>\nAssuming we have a <strong>closed</strong> base slice with four allowed slices and I'm describing constraints for only two of them in my profile:</p>\n<ul>\n<li>If I set slicing rules value to <strong>open</strong>: The resulting snapshot will still allow the four slices, of which two with additional constraints</li>\n<li>If I set slicing rules value to <strong>closed</strong>: The resulting snapshot will only allow the two described slices with the additional constraints</li>\n</ul>\n<p>Assuming we have an <strong>open</strong> base slice with four allowed slices and I'm describing constraints for only two of them in my profile:</p>\n<ul>\n<li>If I set slicing rules value to <strong>open</strong>: The resulting snapshot will still allow the four slices, of which two with additional constraints, plus additional slices</li>\n<li>If I set slicing rules value to <strong>closed</strong>: The resulting snapshot will only allow the two described slices with the additional constraints</li>\n</ul>",
        "id": 188924523,
        "sender_full_name": "Ward Weistra",
        "timestamp": 1582550293
    },
    {
        "content": "<p>yes I think so</p>",
        "id": 188957834,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1582572704
    },
    {
        "content": "<p>Mmmm....the thing that's a bit weird here is that the slice open/close indication turns from an aspect of the slice to an interpretation hint for the snapshot generator.   I.e. logically, you could never turn a closed slice in the base into an open one, but we now still allow it here because it has morphed into an indication of how the differential is to be interpreted.  That might be nit-picking, and in any case I believe this train has probably left the station ;-)</p>",
        "id": 189009054,
        "sender_full_name": "Ewout Kramer",
        "timestamp": 1582628161
    },
    {
        "content": "<p>Maybe, for completeness, we should then add the final open/closed state of the slice after executing this interpretation.  I think this is meant to be:</p>\n<ul>\n<li>When the base was closed - the slice remains closed (even if though have \"open\" in the differential)</li>\n<li>When the base was open - with diff=open =&gt; the slice remains open.   with diff=closed =&gt; the slice becomes closed.</li>\n</ul>",
        "id": 189009249,
        "sender_full_name": "Ewout Kramer",
        "timestamp": 1582628320
    },
    {
        "content": "<p>yes.</p>",
        "id": 189010505,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1582629398
    },
    {
        "content": "<p>I don't see how it can be any other way</p>",
        "id": 189010510,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1582629405
    },
    {
        "content": "<p>(and welcome back)</p>",
        "id": 189010513,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1582629409
    },
    {
        "content": "<p>Seems a bizarre interpretation to me...if the base is closed, the differential can't be anything but closed. If the differential intends to limit the list to a smaller set of slices, it should max:0 the disallowed slices, not provide a new list.  IMO, a diff of <code>open</code> over a base of <code>closed</code> is an error.</p>",
        "id": 190231350,
        "sender_full_name": "Chris Grenz",
        "timestamp": 1583877984
    },
    {
        "content": "<p>And yes, welcome back <span class=\"user-mention\" data-user-id=\"191328\">@Ewout Kramer</span> !</p>",
        "id": 190231378,
        "sender_full_name": "Chris Grenz",
        "timestamp": 1583878013
    }
]