[
    {
        "content": "<p>Hi,<br>\nis there a way to select a slice for validation based on a criteria which lies outside the slice?<br>\nE.g. a FHIRPath expression that has to evaluate as \"true\" to select a slice.<br>\nExample: Patient has 3 different slices for name, the correct one is selected based on citizenship, so each slice would need a FHIRPath-expression of kind \"citizenship=XX\" for selection of the correct slice to validate the instance...</p>",
        "id": 154012340,
        "sender_full_name": "Simone Heckmann",
        "timestamp": 1540548833
    },
    {
        "content": "<p>If there is a slice discriminator, you may add 3 FHIRPath expressions that say \"citizenship=DE and name.xyz=(your value for xyz in a German name)\"., with the value of the xyz element being the discriminator etc.<br>\nIf you don't have a discriminator, maybe add an extension that represents one (\"name-style\" =&gt; DE, FR, ES, ...)</p>",
        "id": 154012342,
        "sender_full_name": "Stefan Lang",
        "timestamp": 1540550001
    },
    {
        "content": "<p>Well, we figured this usecase would come up some time ;-)   See <a href=\"https://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_id=677&amp;tracker_item_id=12641\" target=\"_blank\" title=\"https://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_id=677&amp;tracker_item_id=12641\">https://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_id=677&amp;tracker_item_id=12641</a>.  But I don't think Grahame nor me bothered to implement it....</p>",
        "id": 154012343,
        "sender_full_name": "Ewout Kramer",
        "timestamp": 1540550227
    },
    {
        "content": "<p>That would be this extension: <a href=\"http://build.fhir.org/extension-elementdefinition-selector.html\" target=\"_blank\" title=\"http://build.fhir.org/extension-elementdefinition-selector.html\">http://build.fhir.org/extension-elementdefinition-selector.html</a><br>\nright?</p>",
        "id": 154012346,
        "sender_full_name": "Stefan Lang",
        "timestamp": 1540551588
    },
    {
        "content": "<p>If I understand this correct, the extension would be added to the relevant elements in each slice.<br>\nBut what is the root of the FHIRPath expression then? If it is the sliced element, you would not be able to refer to an element elsewhere in the resource?</p>",
        "id": 154012349,
        "sender_full_name": "Stefan Lang",
        "timestamp": 1540551796
    },
    {
        "content": "<p>Wouldn't %resource work to get you back to the root of the resource?</p>",
        "id": 154012350,
        "sender_full_name": "Ewout Kramer",
        "timestamp": 1540551859
    },
    {
        "content": "<p>Argh, right</p>",
        "id": 154012351,
        "sender_full_name": "Stefan Lang",
        "timestamp": 1540551899
    },
    {
        "content": "<p>This sounds exactly like what we are looking for. However I am not sure I understand the usage correctly. If each slice has a FHIR-Path expression that must evaluate to \"true\" to select the slice, then what is the discriminator?</p>\n<p>Or rather, if the discriminator was a FHIRPath, would the Expression in the extension then only be the value matching the expression...?</p>",
        "id": 154012352,
        "sender_full_name": "Simone Heckmann",
        "timestamp": 1540553312
    },
    {
        "content": "<p>There is essentially no discriminator (which is a fixed code somewhere in the definitions), but rather an entrance criteria for each slice, represented in FHIRPath.  So, each slice would have its own FHIRPath expression, that - if it evaluates to true on the instance - triggers the constraints for that slice.</p>\n<p>So, you could slice on -say- Observation.referenceRange like so:<br>\nslice A1: low &lt;= 100y<br>\nslice A2: low &gt; 100y</p>",
        "id": 154012353,
        "sender_full_name": "Ewout Kramer",
        "timestamp": 1540553642
    },
    {
        "content": "<p>Thanks, awesome!!</p>",
        "id": 154012355,
        "sender_full_name": "Simone Heckmann",
        "timestamp": 1540554355
    },
    {
        "content": "<p>Now, we just need to build it into our validators ;-)  But your lucky, I am reviewing the.NET  validator over the coming period. Who knows ;-)</p>",
        "id": 154012356,
        "sender_full_name": "Ewout Kramer",
        "timestamp": 1540554410
    },
    {
        "content": "<p>Becomes interesting  when multiple selectors match simultaneously...</p>",
        "id": 154012357,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1540554518
    },
    {
        "content": "<p>Is the Gforge item puts it:</p>\n<blockquote>\n<p>This would also allow for instances to fit in multiple slices (note: this is unlike the behaviour of the familiar switch statement), deeply changing the semantics of slices. The consequences of this might be far-reaching at this moment in the publication cycle so we suggest to add this \"selector\" as an extension, allowing toolsmiths to experiment with it and get feedback on it.\"</p>\n</blockquote>",
        "id": 154012358,
        "sender_full_name": "Ewout Kramer",
        "timestamp": 1540554925
    },
    {
        "content": "<p>I have not implemented this</p>",
        "id": 154012400,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1540560008
    },
    {
        "content": "<p>Would this be a correct usage of the extension in a differential to express that a Patient's name must validate against the Profile \"humanname-de-basis\" if the citizenship is \"DE\"?</p>\n<div class=\"codehilite\"><pre><span></span> <span class=\"nt\">&lt;StructureDefinition</span> <span class=\"na\">xmlns=</span><span class=\"s\">&quot;http://hl7.org/fhir&quot;</span><span class=\"nt\">&gt;</span>\n    <span class=\"nt\">&lt;url</span> <span class=\"na\">value=</span><span class=\"s\">&quot;http://example.org/fhir/StructureDefinition/MyPatient&quot;</span><span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;name</span> <span class=\"na\">value=</span><span class=\"s\">&quot;MyPatient&quot;</span><span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;status</span> <span class=\"na\">value=</span><span class=\"s\">&quot;draft&quot;</span><span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;fhirVersion</span> <span class=\"na\">value=</span><span class=\"s\">&quot;3.0.1&quot;</span><span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;kind</span> <span class=\"na\">value=</span><span class=\"s\">&quot;resource&quot;</span><span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;abstract</span> <span class=\"na\">value=</span><span class=\"s\">&quot;false&quot;</span><span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;type</span> <span class=\"na\">value=</span><span class=\"s\">&quot;Patient&quot;</span><span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;baseDefinition</span> <span class=\"na\">value=</span><span class=\"s\">&quot;http://hl7.org/fhir/StructureDefinition/Patient&quot;</span><span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;derivation</span> <span class=\"na\">value=</span><span class=\"s\">&quot;constraint&quot;</span><span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;differential&gt;</span>\n        <span class=\"nt\">&lt;element</span> <span class=\"na\">id=</span><span class=\"s\">&quot;Patient.name&quot;</span><span class=\"nt\">&gt;</span>\n            <span class=\"nt\">&lt;path</span> <span class=\"na\">value=</span><span class=\"s\">&quot;Patient.name&quot;</span><span class=\"nt\">/&gt;</span>\n            <span class=\"nt\">&lt;slicing&gt;</span>\n                <span class=\"nt\">&lt;rules</span> <span class=\"na\">value=</span><span class=\"s\">&quot;open&quot;</span><span class=\"nt\">/&gt;</span>\n            <span class=\"nt\">&lt;/slicing&gt;</span>\n        <span class=\"nt\">&lt;/element&gt;</span>\n        <span class=\"nt\">&lt;element</span> <span class=\"na\">id=</span><span class=\"s\">&quot;Patient.name:Name-DE&quot;</span><span class=\"nt\">&gt;</span>\n            <span class=\"nt\">&lt;extension</span> <span class=\"na\">url=</span><span class=\"s\">&quot;http://hl7.org/fhir/StructureDefinition/elementdefinition-selector&quot;</span><span class=\"nt\">&gt;</span>\n                <span class=\"nt\">&lt;valueString</span> <span class=\"na\">value=</span><span class=\"s\">&quot;$this.extension(&#39;http://hl7.org/fhir/StructureDefinition/patient-citizenship&#39;).valueString=&#39;DE&#39;&quot;</span><span class=\"nt\">/&gt;</span>\n            <span class=\"nt\">&lt;/extension&gt;</span>\n            <span class=\"nt\">&lt;path</span> <span class=\"na\">value=</span><span class=\"s\">&quot;Patient.name&quot;</span><span class=\"nt\">/&gt;</span>\n            <span class=\"nt\">&lt;sliceName</span> <span class=\"na\">value=</span><span class=\"s\">&quot;Name-DE&quot;</span><span class=\"nt\">/&gt;</span>\n            <span class=\"nt\">&lt;type&gt;</span>\n                <span class=\"nt\">&lt;code</span> <span class=\"na\">value=</span><span class=\"s\">&quot;HumanName&quot;</span><span class=\"nt\">/&gt;</span>\n                <span class=\"nt\">&lt;profile</span> <span class=\"na\">value=</span><span class=\"s\">&quot;http://fhir.de/StructureDefinition/humanname-de-basis&quot;</span><span class=\"nt\">/&gt;</span>\n            <span class=\"nt\">&lt;/type&gt;</span>\n        <span class=\"nt\">&lt;/element&gt;</span>\n    <span class=\"nt\">&lt;/differential&gt;</span>\n<span class=\"nt\">&lt;/StructureDefinition&gt;</span>\n</pre></div>",
        "id": 154013562,
        "sender_full_name": "Simone Heckmann",
        "timestamp": 1540885891
    },
    {
        "content": "<p>No, since it would look for an extension under <a href=\"http://Patient.name\" target=\"_blank\" title=\"http://Patient.name\">Patient.name</a> (and you could already do that with normal discriminators), I think you mean:</p>\n<p><code>%resource.extension(.....).value = 'DE'</code></p>\n<p>Note that in FHIRPath, the type suffixes do not exist, so it is not <code>extension(....).valueString</code>, but just <code>.value</code>.</p>",
        "id": 154013580,
        "sender_full_name": "Ewout Kramer",
        "timestamp": 1540896630
    },
    {
        "content": "<p>Oh, ok! So it would be the structure as above but with  the FHIRPath expression<br>\n<code>%resource.extension('http://hl7.org/fhir/StructureDefinition/patient-citizenship').value='DE'</code></p>",
        "id": 154013591,
        "sender_full_name": "Simone Heckmann",
        "timestamp": 1540899961
    },
    {
        "content": "<p>Should there be anything in particular (like a keyword) in slicing.description<br>\nor would validators know how this works based on the existence of the extensions?<br>\n(eld-1 says there needs to be a description if there's no discriminator....)</p>",
        "id": 154013592,
        "sender_full_name": "Simone Heckmann",
        "timestamp": 1540900335
    }
]