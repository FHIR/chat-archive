[
    {
        "content": "<p>Moved <a href=\"#narrow/stream/179166-implementers/topic/Extension.20content.20in.20Snapshot.3F\">this thread</a> from the implementer's stream. This question originates from wanting to show an overview of mappings of a profile based on its snapshot. As a rule of thumb, we place our mapping 'as close as possible' to the elements that actually represent the data. We also add them within extensions to avoid duplication of mappings if the extensions is reused in more profiles.</p>\n<p>It seems that the snapshot generators of JAVA and .NET include the root concept details of the referenced extension/datatype into the host profile's snapshot. It leaves out all children, like the <code>.value[x]</code>, which in our case contains mappings. I will add an example below.</p>\n<p>I understand that you need to stop somewhere as you might not want to include everything in the snapshot considering performance reasons ect. Would that actually be the main reason?  </p>\n<p>Moreover, if this is desired, I might be a good idea to be a bit more explicit about this behaviour in the spec? I also think <a href=\"https://hl7.org/FHIR/profiling.html#snapshot\">this part of the spec</a> is incorrect:  \"a StructureDefinition can also carry a \"snapshot\" - a fully calculated form of the structure that is <strong>not dependent on any other structure.</strong>\"</p>",
        "id": 264160342,
        "sender_full_name": "Ardon Toonstra",
        "timestamp": 1638972826
    },
    {
        "content": "<p>Example: <a href=\"https://www.hl7.org/fhir/us/core/StructureDefinition-us-core-patient.profile.xml.html\">us-core-patient profile</a> includes the <a href=\"https://www.hl7.org/fhir/us/core/StructureDefinition-us-core-birthsex.profile.xml.html\">us-core-birthsex extension</a> like this in the diff:</p>\n<div class=\"codehilite\" data-code-language=\"XML\"><pre><span></span><code>    <span class=\"nt\">&lt;element</span> <span class=\"na\">id=</span><span class=\"s\">\"Patient.extension:birthsex\"</span><span class=\"nt\">&gt;</span>\n      <span class=\"nt\">&lt;path</span> <span class=\"na\">value=</span><span class=\"s\">\"Patient.extension\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;sliceName</span> <span class=\"na\">value=</span><span class=\"s\">\"birthsex\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;min</span> <span class=\"na\">value=</span><span class=\"s\">\"0\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;max</span> <span class=\"na\">value=</span><span class=\"s\">\"1\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;type&gt;</span>\n        <span class=\"nt\">&lt;code</span> <span class=\"na\">value=</span><span class=\"s\">\"Extension\"</span><span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;profile</span> <span class=\"na\">value=</span><span class=\"s\">\"http://hl7.org/fhir/us/core/StructureDefinition/us-core-birthsex\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;/type&gt;</span>\n      <span class=\"nt\">&lt;mustSupport</span> <span class=\"na\">value=</span><span class=\"s\">\"false\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;mapping&gt;</span>\n        <span class=\"nt\">&lt;identity</span> <span class=\"na\">value=</span><span class=\"s\">\"argonaut-dq-dstu2\"</span><span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;map</span> <span class=\"na\">value=</span><span class=\"s\">\"Patient.extension\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;/mapping&gt;</span>\n    <span class=\"nt\">&lt;/element&gt;</span>\n</code></pre></div>\n<p>Resulting in this snapshot:</p>\n<div class=\"codehilite\" data-code-language=\"XML\"><pre><span></span><code> <span class=\"nt\">&lt;element</span> <span class=\"na\">id=</span><span class=\"s\">\"Patient.extension:birthsex\"</span><span class=\"nt\">&gt;</span>\n      <span class=\"nt\">&lt;path</span> <span class=\"na\">value=</span><span class=\"s\">\"Patient.extension\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;sliceName</span> <span class=\"na\">value=</span><span class=\"s\">\"birthsex\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;short</span> <span class=\"na\">value=</span><span class=\"s\">\"Extension\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;definition</span> <span class=\"na\">value=</span><span class=\"s\">\"A code classifying the person&amp;#39;s sex assigned at birth  as specified by the [Office of the National Coordinator for Health IT (ONC)](https://www.healthit.gov/newsroom/about-onc).\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;comment</span> <span class=\"na\">value=</span><span class=\"s\">\"The codes required are intended to present birth sex (i.e., the sex recorded on the patient&amp;#x2019;s birth certificate) and not gender identity or reassigned sex.\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;min</span> <span class=\"na\">value=</span><span class=\"s\">\"0\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;max</span> <span class=\"na\">value=</span><span class=\"s\">\"1\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;base&gt;</span>\n        <span class=\"nt\">&lt;path</span> <span class=\"na\">value=</span><span class=\"s\">\"DomainResource.extension\"</span><span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;min</span> <span class=\"na\">value=</span><span class=\"s\">\"0\"</span><span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;max</span> <span class=\"na\">value=</span><span class=\"s\">\"*\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;/base&gt;</span>\n      <span class=\"nt\">&lt;type&gt;</span>\n        <span class=\"nt\">&lt;code</span> <span class=\"na\">value=</span><span class=\"s\">\"Extension\"</span><span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;profile</span> <span class=\"na\">value=</span><span class=\"s\">\"http://hl7.org/fhir/us/core/StructureDefinition/us-core-birthsex\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;/type&gt;</span>\n      <span class=\"nt\">&lt;condition</span> <span class=\"na\">value=</span><span class=\"s\">\"ele-1\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;constraint&gt;</span>\n        <span class=\"nt\">&lt;key</span> <span class=\"na\">value=</span><span class=\"s\">\"ele-1\"</span><span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;severity</span> <span class=\"na\">value=</span><span class=\"s\">\"error\"</span><span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;human</span> <span class=\"na\">value=</span><span class=\"s\">\"All FHIR elements must have a @value or children\"</span><span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;expression</span> <span class=\"na\">value=</span><span class=\"s\">\"hasValue() or (children().count() &amp;gt; id.count())\"</span><span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;xpath</span> <span class=\"na\">value=</span><span class=\"s\">\"@value|f:*|h:div\"</span><span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;source</span> <span class=\"na\">value=</span><span class=\"s\">\"http://hl7.org/fhir/StructureDefinition/Element\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;/constraint&gt;</span>\n      <span class=\"nt\">&lt;constraint&gt;</span>\n        <span class=\"nt\">&lt;key</span> <span class=\"na\">value=</span><span class=\"s\">\"ext-1\"</span><span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;severity</span> <span class=\"na\">value=</span><span class=\"s\">\"error\"</span><span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;human</span> <span class=\"na\">value=</span><span class=\"s\">\"Must have either extensions or value[x], not both\"</span><span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;expression</span> <span class=\"na\">value=</span><span class=\"s\">\"extension.exists() != value.exists()\"</span><span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;xpath</span> <span class=\"na\">value=</span><span class=\"s\">\"exists(f:extension)!=exists(f:*[starts-with(local-name(.), &amp;#39;value&amp;#39;)])\"</span><span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;source</span> <span class=\"na\">value=</span><span class=\"s\">\"http://hl7.org/fhir/StructureDefinition/Extension\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;/constraint&gt;</span>\n      <span class=\"nt\">&lt;mustSupport</span> <span class=\"na\">value=</span><span class=\"s\">\"false\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;isModifier</span> <span class=\"na\">value=</span><span class=\"s\">\"false\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;mapping&gt;</span>\n        <span class=\"nt\">&lt;identity</span> <span class=\"na\">value=</span><span class=\"s\">\"rim\"</span><span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;map</span> <span class=\"na\">value=</span><span class=\"s\">\"player[classCode=PSN|ANM and determinerCode=INSTANCE]/administrativeGender\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;/mapping&gt;</span>\n      <span class=\"nt\">&lt;mapping&gt;</span>\n        <span class=\"nt\">&lt;identity</span> <span class=\"na\">value=</span><span class=\"s\">\"iso11179\"</span><span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;map</span> <span class=\"na\">value=</span><span class=\"s\">\".patient.administrativeGenderCode\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;/mapping&gt;</span>\n      <span class=\"nt\">&lt;mapping&gt;</span>\n        <span class=\"nt\">&lt;identity</span> <span class=\"na\">value=</span><span class=\"s\">\"argonaut-dq-dstu2\"</span><span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;map</span> <span class=\"na\">value=</span><span class=\"s\">\"Patient.extension\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;/mapping&gt;</span>\n    <span class=\"nt\">&lt;/element&gt;</span>\n</code></pre></div>\n<p>I expected that also the following would be included in the snapshot:</p>\n<div class=\"codehilite\" data-code-language=\"XML\"><pre><span></span><code>   <span class=\"nt\">&lt;element</span> <span class=\"na\">id=</span><span class=\"s\">\"Extension.url\"</span><span class=\"nt\">&gt;</span>\n      <span class=\"nt\">&lt;path</span> <span class=\"na\">value=</span><span class=\"s\">\"Extension.url\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;fixedUri</span> <span class=\"na\">value=</span><span class=\"s\">\"http://hl7.org/fhir/us/core/StructureDefinition/us-core-birthsex\"</span><span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;/element&gt;</span>\n    <span class=\"nt\">&lt;element</span> <span class=\"na\">id=</span><span class=\"s\">\"Extension.valueCode\"</span><span class=\"nt\">&gt;</span>\n      <span class=\"nt\">&lt;path</span> <span class=\"na\">value=</span><span class=\"s\">\"Extension.valueCode\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;min</span> <span class=\"na\">value=</span><span class=\"s\">\"1\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;max</span> <span class=\"na\">value=</span><span class=\"s\">\"1\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;type&gt;</span>\n        <span class=\"nt\">&lt;code</span> <span class=\"na\">value=</span><span class=\"s\">\"code\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;/type&gt;</span>\n      <span class=\"nt\">&lt;binding&gt;</span>\n        <span class=\"nt\">&lt;strength</span> <span class=\"na\">value=</span><span class=\"s\">\"required\"</span><span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;description</span> <span class=\"na\">value=</span><span class=\"s\">\"Code for sex assigned at birth\"</span><span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;valueSet</span> <span class=\"na\">value=</span><span class=\"s\">\"http://hl7.org/fhir/us/core/ValueSet/birthsex\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;/binding&gt;</span>\n    <span class=\"nt\">&lt;/element&gt;</span>\n</code></pre></div>",
        "id": 264160767,
        "sender_full_name": "Ardon Toonstra",
        "timestamp": 1638973000
    },
    {
        "content": "<p>The simple algorithm for snapshot is that the depth equals that in the differential.  If the differential includes foo.extension.value[x], then you should expect the snapshot to include foo.extension.value[x] and all siblings - but not children of those siblings.  (I believe there's an exception for backbone elements - if you include a backbone element, you always have to include its children because there's no datatype you can reference.)</p>",
        "id": 264161646,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1638973403
    },
    {
        "content": "<p>That is indeed how it is implemented in the two main snapshot generators.  Performance will be the reason behind it?</p>\n<p>This results in either moving our mappings from e.g. extension.value[x] to the extension root or asking for better tooling support in generating a mapping overview. It cannot use the current snapshots then. </p>\n<p>Shall I create a ticket to align the text in the profiling section of the spec with the definition of <code>StructureDefinition.snapshot</code>: \" <br>\n<em>A snapshot view is expressed in a standalone form that can be used and interpreted without considering the base StructureDefinition</em>.\"?</p>",
        "id": 264439359,
        "sender_full_name": "Ardon Toonstra",
        "timestamp": 1639139147
    },
    {
        "content": "<p>I think the basic gist is - \"Can I validate this child element using the profile of the specified type alone?\"  If the answer to that question is no, then you have to blow out that whole type into the snapshot.  You keep asking that question on the way down until the answer becomes 'yes'.</p>",
        "id": 264452571,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1639145645
    }
]