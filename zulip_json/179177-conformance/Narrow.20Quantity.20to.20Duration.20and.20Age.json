[
    {
        "content": "<p>If I want to say that <code>Observation.value[x]</code> can only be a <code>Duration</code> or an <code>Age</code>, how do I do that?  The <code>value[x]</code> choice does not contain <code>Duration</code> or <code>Age</code> specifically, but it does contain <code>Quantity</code> -- and <code>Duration</code>/<code>Age</code> are specializations of <code>Quantity</code>.</p>\n<p>In the past, I thought that this worked:</p>\n<div class=\"codehilite\"><pre><span></span><code>      <span class=\"p\">{</span>\n        <span class=\"nt\">&quot;id&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;Observation.value[x]&quot;</span><span class=\"p\">,</span>\n        <span class=\"nt\">&quot;path&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;Observation.value[x]&quot;</span><span class=\"p\">,</span>\n        <span class=\"nt\">&quot;type&quot;</span><span class=\"p\">:</span> <span class=\"p\">[</span> <span class=\"p\">{</span> <span class=\"nt\">&quot;code&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;Duration&quot;</span> <span class=\"p\">},</span> <span class=\"p\">{</span> <span class=\"nt\">&quot;code&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;Age&quot;</span> <span class=\"p\">}</span> <span class=\"p\">]</span>\n      <span class=\"p\">}</span>\n</code></pre></div>\n\n\n<p>but now the Publisher barks at that:</p>\n<blockquote>\n<p>illegal constrained type Duration from Quantity, CodeableConcept, string, boolean, integer, Range, Ratio, SampledData, time, dateTime, Period in <a href=\"http://hl7.org/fhir/StructureDefinition/Observation\">http://hl7.org/fhir/StructureDefinition/Observation</a></p>\n</blockquote>\n<p>Is what I've done above legal or is this something you need to drop into FHIRPath to express?</p>",
        "id": 197991933,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1589834006
    },
    {
        "content": "<p>it's not legal. Choice types are final, in effect; you'll have to use FHIRPath</p>",
        "id": 198006440,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1589843302
    },
    {
        "content": "<p>You should be able to specify a targetProfile for the type</p>",
        "id": 198014351,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1589851742
    },
    {
        "content": "<p>You mean profile not targetProfile but Age and Duration are not profiles</p>",
        "id": 198023399,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1589865963
    },
    {
        "content": "<p>Right.  At first I thought profile too, but they are <em>specializations</em>, not <em>constraints</em>, so we can't use profile.  So... FHIRPath it is.</p>",
        "id": 198060481,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1589892829
    },
    {
        "content": "<p>Why are they specializations - they don't add any new elements...</p>",
        "id": 198081969,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1589901567
    },
    {
        "content": "<p>I'm pretty sure I've referenced them with profile and it's worked...</p>",
        "id": 198082012,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1589901589
    },
    {
        "content": "<blockquote>\n<p>Why are they specializations</p>\n</blockquote>\n<p>We just had this same exact question/conversation during our team meeting.  We couldn't figure out why they are <em>specializations</em> either.  Best we could come up w/ is that in cases where they are used as choices in core spec, it allows <code>valueAge</code> and <code>valueDuration</code> to be used instead of <code>valueQuantity</code> -- which is probably a bit more explicit from a user perspective.  But still... I'd be interested to hear the story behind it.  It looks like they were <em>constraint</em>s in DSTU2.</p>",
        "id": 198083880,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1589902392
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span></p>",
        "id": 198084398,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1589902597
    },
    {
        "content": "<p>they were constraints, but that meant that when you used them, you didn't really use them. People got confused by this - for instance, a value that was a choice of Age and Duration was actually a choice of Quantity. So we changed them to specializations instead of constraints. We discussed that this meant that you couldn't do what Chris wants to do, but we felt that it wouldn't happen very often (and we were right - it was such a long time till someone tried to do it that Lloyd didn't remember the discussion)</p>",
        "id": 198112883,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1589915420
    },
    {
        "content": "<p>And I'll admit that this didn't come up in a real world use case for us either.  It came up in a fairly contrived unit test in SUSHI.</p>",
        "id": 198118021,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1589918049
    },
    {
        "content": "<p>Followup question.  We've established that the following is an illegal constraint because <code>Duration</code> and <code>Age</code> are not in the original type list (even though their parent, <code>Quantity</code>, is in the type list):</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"p\">{</span>\n  <span class=\"nt\">&quot;id&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;Observation.value[x]&quot;</span><span class=\"p\">,</span>\n  <span class=\"nt\">&quot;path&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;Observation.value[x]&quot;</span><span class=\"p\">,</span>\n  <span class=\"nt\">&quot;type&quot;</span><span class=\"p\">:</span> <span class=\"p\">[</span> <span class=\"p\">{</span> <span class=\"nt\">&quot;code&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;Duration&quot;</span> <span class=\"p\">},</span> <span class=\"p\">{</span> <span class=\"nt\">&quot;code&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;Age&quot;</span> <span class=\"p\">}</span> <span class=\"p\">]</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n\n\n<p>It appears that if I try to do a similar thing, but with <code>Bundle.entry.resource</code> instead, the IG Publisher is happy with it.  For example, even though <code>Bundle.entry.resource</code> only has <code>Resource</code> in its type list, I can apparently constrain it to sub-types like this:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"p\">{</span>\n  <span class=\"nt\">&quot;id&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;Bundle.entry.resource&quot;</span><span class=\"p\">,</span>\n  <span class=\"nt\">&quot;path&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;Bundle.entry.resource&quot;</span><span class=\"p\">,</span>\n  <span class=\"nt\">&quot;type&quot;</span><span class=\"p\">:</span> <span class=\"p\">[</span> <span class=\"p\">{</span> <span class=\"nt\">&quot;code&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;Patient&quot;</span> <span class=\"p\">},</span> <span class=\"p\">{</span> <span class=\"nt\">&quot;code&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;Condition&quot;</span> <span class=\"p\">}]</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 199657666,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1591208846
    },
    {
        "content": "<ol>\n<li>Is that second example (w/ Bundle.entry.resource) indeed valid?</li>\n<li>If so, what makes the first invalid? Is it because it is a choice (e.g., the <code>[x]</code> makes the type list final)?  I think this is what Graham implied, but I want to confirm before I code up SUSHI this way.</li>\n</ol>",
        "id": 199657909,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1591208953
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span></p>",
        "id": 199659605,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1591209799
    },
    {
        "content": "<p>Upon further investigation, the following ALSO does not work:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"p\">{</span>\n  <span class=\"nt\">&quot;id&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;DeviceDefinition.quantity&quot;</span><span class=\"p\">,</span>\n  <span class=\"nt\">&quot;path&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;DeviceDefinition.quantity&quot;</span><span class=\"p\">,</span>\n  <span class=\"nt\">&quot;type&quot;</span><span class=\"p\">:</span> <span class=\"p\">[</span> <span class=\"p\">{</span> <span class=\"nt\">&quot;code&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;Duration&quot;</span> <span class=\"p\">},</span> <span class=\"p\">{</span> <span class=\"nt\">&quot;code&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;Age&quot;</span> <span class=\"p\">}</span> <span class=\"p\">]</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 199661056,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1591210554
    },
    {
        "content": "<p>because Observation.value has a set of concrete types, but Bundle.entry.resource has a single abstract type</p>",
        "id": 199661242,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1591210651
    },
    {
        "content": "<p>Ooooohhh... is that the key?  We can do it on something that is type <code>Resource</code> because <code>Resource</code> is abstract, but we can't do it on something like <code>Quantity</code> because it is concrete?  Because it can't just be due to the choice since <code>DeviceDefinition.quantity</code> also does not work.</p>",
        "id": 199661543,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1591210806
    },
    {
        "content": "<p>Unless the type is abstract, the type is <code>final</code></p>",
        "id": 199661705,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1591210901
    },
    {
        "content": "<p>And by <code>final</code>, you mean it cannot be replaced by specializations in the type list.  If you want to constrain it to a specialization you have to fall back to FHIRPath invariants.</p>",
        "id": 199661848,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1591210974
    },
    {
        "content": "<p>I think I understand now.  Thank you, <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span>!</p>",
        "id": 199661921,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1591211023
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> , we were under the impression that if we wanted to use FHIRPath to express on a profile that a Quantity element should be a Duration, we would place the following in the <code>constraint</code> array on the Quantity type element in question:</p>\n<div class=\"codehilite\"><pre><span></span><code> {\n            &quot;key&quot;: &quot;dur-1&quot;,\n            &quot;severity&quot;: &quot;error&quot;,\n            &quot;human&quot;: &quot;Type is a duration&quot;,\n            &quot;expression&quot;: &quot;is(FHIR.Duration)&quot;,\n}\n</code></pre></div>\n\n\n<p>However, this leads to an error in validation of any instance of that profile, and the error seems to be caused by the fact that the element is of type Quantity, but the FHIRPath constraint indicates it should be of type Duration. We thought this would be allowed since Duration is a child type of Quantity. We have also tried using the <code>conformsTo</code> operator instead of <code>is</code>, and that also leads to validation errors. Was the above not what you meant when you said we would have to use FHIRPath to constrain a Quantity to a Duration?</p>",
        "id": 200689318,
        "sender_full_name": "Nick Freiter",
        "timestamp": 1591977926
    },
    {
        "content": "<p>it wasn't what I meant. </p>\n<blockquote>\n<p>\"expression\": \"is(FHIR.Duration)\"</p>\n</blockquote>\n<p>No, because that's just saying again that the type is a Duration, but it can't be since the binding is final.</p>",
        "id": 200715091,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1591990513
    },
    {
        "content": "<p>conformsTo - maybe that should work if you provide a canonical URL? but that would really be a bug on my part since it can't conform to the definition, since the definition says it's a type</p>",
        "id": 200715155,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1591990555
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code> {\n            &quot;key&quot;: &quot;dur-1&quot;,\n            &quot;severity&quot;: &quot;error&quot;,\n            &quot;human&quot;: &quot;Type is a duration&quot;,\n            &quot;expression&quot;: &quot;$this.memberOf(&#39;http://hl7.org/fhir/ValueSet/all-time-units)&quot;,\n}\n</code></pre></div>",
        "id": 200715450,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1591990710
    },
    {
        "content": "<p>So are you saying there is no uniform way for a profile author to succinctly say that an element of TypeA should be a specific <em>specialization</em> of that type?  Is that intentional because a specialization can introduce new elements -- and it's really only rather unfortunate here because these specific specializations (Duration and Age) <em>don't</em> introduce new units (e.g., they act much more like constraints)?</p>",
        "id": 200727989,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1591998335
    },
    {
        "content": "<p>if a specialization is allowed then you can say that it must be done - exactly how you did it. But since it's not allowed, you can't satisfy that constraint</p>",
        "id": 200728258,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1591998591
    },
    {
        "content": "<p>OK.  I think we just got confused because Duration and Age act more like constraints, so it <em>feels</em> like they should be allowed, even if they're not.  We'll update SUSHI to yell when an author tries to constrain a type to a specialization (if that specialization hasn't already been explicitly allowed via a choice).</p>",
        "id": 200728679,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1591998889
    },
    {
        "content": "<p>it's unfortunate, I agree, because they do feel a lot like constraints. they used to be. But people were confused by that since they couldn't listed as types in resource definitions/profiles, and didn't appear in choices.</p>",
        "id": 200728868,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1591999013
    }
]