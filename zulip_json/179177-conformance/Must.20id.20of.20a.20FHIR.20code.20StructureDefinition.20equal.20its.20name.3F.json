[
    {
        "content": "<p>In the Java reference implementation, ParserBase.java contains the following:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"k\">if</span> <span class=\"o\">(</span><span class=\"n\">name</span><span class=\"o\">.</span><span class=\"na\">equals</span><span class=\"o\">(</span><span class=\"n\">sd</span><span class=\"o\">.</span><span class=\"na\">getIdElement</span><span class=\"o\">().</span><span class=\"na\">getIdPart</span><span class=\"o\">()))</span> <span class=\"o\">{</span>\n</pre></div>\n\n\n<p>in the method <code>getDefinition</code></p>\n<p>This means that, for example, the <code>StructureDefinition</code> for <code>StructureDefinition</code>itself <em>MUST</em> have the <code>id</code> of <code>StructureDefinition</code> which violates the principle that servers get to choose <code>id</code> values.</p>\n<p>Are there rules / assumptions elsewhere in the spec that require this constraint?</p>",
        "id": 153978178,
        "sender_full_name": "Michael Lawley",
        "timestamp": 1532580683
    },
    {
        "content": "<p>I'm not finding this method</p>",
        "id": 153978179,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1532580772
    },
    {
        "content": "<p>oh that ParserBase.</p>",
        "id": 153978181,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1532580978
    },
    {
        "content": "<p>well... no, there is no rules in the spec. But this particular code is expected to run straight off the hl7.fhir.core package</p>",
        "id": 153978182,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1532581021
    },
    {
        "content": "<p>It gets called via the validation module and breaks when the SD's are pulled from our server</p>",
        "id": 153978184,
        "sender_full_name": "Michael Lawley",
        "timestamp": 1532581104
    },
    {
        "content": "<p>hmm why? that's odd.... what's it actually broken on?</p>",
        "id": 153978185,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1532581200
    },
    {
        "content": "<p>We supply an implementation of <code>IValidationSupport</code> which has the method  <code>fetchStructureDefinition</code>.  This gets called for the URI <code>http://hl7.org/fhir/StructureDefinition/StructureDefinition</code> and we return our instance but with an <code>id</code> != <code>\"StructureDefinition\"</code>.  It looks like this gets serialised as XML and then parsed back as elements as some kind of STU3 -&gt; R4 transformation ?</p>",
        "id": 153978186,
        "sender_full_name": "Michael Lawley",
        "timestamp": 1532581431
    },
    {
        "content": "<p>yeah but so? the code should be depending on the canonical URL - which is immediately before hand. there's a few special circumstances where it falls through to the ode you've asked about, but they should not apply for you</p>",
        "id": 153978187,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1532581487
    },
    {
        "content": "<p>This is the code I'm seeing in <code>implementations/java/org.hl7.fhir.dstu3/src/org/hl7/fhir/dstu3/elementmodel/ParserBase.java</code>:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"kd\">protected</span> <span class=\"n\">StructureDefinition</span> <span class=\"nf\">getDefinition</span><span class=\"o\">(</span><span class=\"kt\">int</span> <span class=\"n\">line</span><span class=\"o\">,</span> <span class=\"kt\">int</span> <span class=\"n\">col</span><span class=\"o\">,</span> <span class=\"n\">String</span> <span class=\"n\">ns</span><span class=\"o\">,</span> <span class=\"n\">String</span> <span class=\"n\">name</span><span class=\"o\">)</span> <span class=\"kd\">throws</span> <span class=\"n\">FHIRFormatError</span> <span class=\"o\">{</span>\n    <span class=\"k\">if</span> <span class=\"o\">(</span><span class=\"n\">ns</span> <span class=\"o\">==</span> <span class=\"kc\">null</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n      <span class=\"n\">logError</span><span class=\"o\">(</span><span class=\"n\">line</span><span class=\"o\">,</span> <span class=\"n\">col</span><span class=\"o\">,</span> <span class=\"n\">name</span><span class=\"o\">,</span> <span class=\"n\">IssueType</span><span class=\"o\">.</span><span class=\"na\">STRUCTURE</span><span class=\"o\">,</span> <span class=\"s\">&quot;This cannot be parsed as a FHIR object (no namespace)&quot;</span><span class=\"o\">,</span> <span class=\"n\">IssueSeverity</span><span class=\"o\">.</span><span class=\"na\">FATAL</span><span class=\"o\">);</span>\n      <span class=\"k\">return</span> <span class=\"kc\">null</span><span class=\"o\">;</span>\n    <span class=\"o\">}</span>\n    <span class=\"k\">if</span> <span class=\"o\">(</span><span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"kc\">null</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n      <span class=\"n\">logError</span><span class=\"o\">(</span><span class=\"n\">line</span><span class=\"o\">,</span> <span class=\"n\">col</span><span class=\"o\">,</span> <span class=\"n\">name</span><span class=\"o\">,</span> <span class=\"n\">IssueType</span><span class=\"o\">.</span><span class=\"na\">STRUCTURE</span><span class=\"o\">,</span> <span class=\"s\">&quot;This cannot be parsed as a FHIR object (no name)&quot;</span><span class=\"o\">,</span> <span class=\"n\">IssueSeverity</span><span class=\"o\">.</span><span class=\"na\">FATAL</span><span class=\"o\">);</span>\n      <span class=\"k\">return</span> <span class=\"kc\">null</span><span class=\"o\">;</span>\n    <span class=\"o\">}</span>\n    <span class=\"k\">for</span> <span class=\"o\">(</span><span class=\"n\">StructureDefinition</span> <span class=\"n\">sd</span> <span class=\"o\">:</span> <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"na\">allStructures</span><span class=\"o\">())</span> <span class=\"o\">{</span>\n      <span class=\"k\">if</span> <span class=\"o\">(</span><span class=\"n\">name</span><span class=\"o\">.</span><span class=\"na\">equals</span><span class=\"o\">(</span><span class=\"n\">sd</span><span class=\"o\">.</span><span class=\"na\">getIdElement</span><span class=\"o\">().</span><span class=\"na\">getIdPart</span><span class=\"o\">()))</span> <span class=\"o\">{</span>\n       <span class=\"c1\">// ...</span>\n</pre></div>\n\n\n<p>The only paths that will avoid this are if <code>ns</code> or <code>name</code> are null</p>",
        "id": 153978188,
        "sender_full_name": "Michael Lawley",
        "timestamp": 1532581647
    },
    {
        "content": "<p>3? you can't run the R3 version of that code. I should really delete it... only the R4 validator is supported</p>",
        "id": 153978190,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1532581696
    },
    {
        "content": "<p>I'm not calling it directly, but the r4 is similar:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"kd\">protected</span> <span class=\"n\">StructureDefinition</span> <span class=\"nf\">getDefinition</span><span class=\"o\">(</span><span class=\"kt\">int</span> <span class=\"n\">line</span><span class=\"o\">,</span> <span class=\"kt\">int</span> <span class=\"n\">col</span><span class=\"o\">,</span> <span class=\"n\">String</span> <span class=\"n\">ns</span><span class=\"o\">,</span> <span class=\"n\">String</span> <span class=\"n\">name</span><span class=\"o\">)</span> <span class=\"kd\">throws</span> <span class=\"n\">FHIRFormatError</span> <span class=\"o\">{</span>\n    <span class=\"k\">if</span> <span class=\"o\">(</span><span class=\"n\">ns</span> <span class=\"o\">==</span> <span class=\"kc\">null</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n      <span class=\"n\">logError</span><span class=\"o\">(</span><span class=\"n\">line</span><span class=\"o\">,</span> <span class=\"n\">col</span><span class=\"o\">,</span> <span class=\"n\">name</span><span class=\"o\">,</span> <span class=\"n\">IssueType</span><span class=\"o\">.</span><span class=\"na\">STRUCTURE</span><span class=\"o\">,</span> <span class=\"s\">&quot;This cannot be parsed as a FHIR object (no namespace)&quot;</span><span class=\"o\">,</span> <span class=\"n\">IssueSeverity</span><span class=\"o\">.</span><span class=\"na\">FATAL</span><span class=\"o\">);</span>\n      <span class=\"k\">return</span> <span class=\"kc\">null</span><span class=\"o\">;</span>\n    <span class=\"o\">}</span>\n    <span class=\"k\">if</span> <span class=\"o\">(</span><span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"kc\">null</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n      <span class=\"n\">logError</span><span class=\"o\">(</span><span class=\"n\">line</span><span class=\"o\">,</span> <span class=\"n\">col</span><span class=\"o\">,</span> <span class=\"n\">name</span><span class=\"o\">,</span> <span class=\"n\">IssueType</span><span class=\"o\">.</span><span class=\"na\">STRUCTURE</span><span class=\"o\">,</span> <span class=\"s\">&quot;This cannot be parsed as a FHIR object (no name)&quot;</span><span class=\"o\">,</span> <span class=\"n\">IssueSeverity</span><span class=\"o\">.</span><span class=\"na\">FATAL</span><span class=\"o\">);</span>\n      <span class=\"k\">return</span> <span class=\"kc\">null</span><span class=\"o\">;</span>\n    <span class=\"o\">}</span>\n    <span class=\"k\">for</span> <span class=\"o\">(</span><span class=\"n\">StructureDefinition</span> <span class=\"n\">sd</span> <span class=\"o\">:</span> <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"na\">allStructures</span><span class=\"o\">())</span> <span class=\"o\">{</span>\n            <span class=\"k\">if</span> <span class=\"o\">(</span><span class=\"n\">name</span><span class=\"o\">.</span><span class=\"na\">equals</span><span class=\"o\">(</span><span class=\"n\">sd</span><span class=\"o\">.</span><span class=\"na\">getIdElement</span><span class=\"o\">().</span><span class=\"na\">getIdPart</span><span class=\"o\">())</span> <span class=\"o\">&amp;&amp;</span> <span class=\"o\">!</span><span class=\"n\">sd</span><span class=\"o\">.</span><span class=\"na\">getUrl</span><span class=\"o\">().</span><span class=\"na\">startsWith</span><span class=\"o\">(</span><span class=\"s\">&quot;http://hl7.org/fhir/StructureDefinition/de-&quot;</span><span class=\"o\">))</span> <span class=\"o\">{</span>\n</pre></div>",
        "id": 153978198,
        "sender_full_name": "Michael Lawley",
        "timestamp": 1532581909
    },
    {
        "content": "<p>my copy:</p>\n<div class=\"codehilite\"><pre><span></span>    <span class=\"kd\">protected</span> <span class=\"n\">StructureDefinition</span> <span class=\"nf\">getDefinition</span><span class=\"o\">(</span><span class=\"kt\">int</span> <span class=\"n\">line</span><span class=\"o\">,</span> <span class=\"kt\">int</span> <span class=\"n\">col</span><span class=\"o\">,</span> <span class=\"n\">String</span> <span class=\"n\">name</span><span class=\"o\">)</span> <span class=\"kd\">throws</span> <span class=\"n\">FHIRFormatError</span> <span class=\"o\">{</span>\n    <span class=\"k\">if</span> <span class=\"o\">(</span><span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"kc\">null</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n      <span class=\"n\">logError</span><span class=\"o\">(</span><span class=\"n\">line</span><span class=\"o\">,</span> <span class=\"n\">col</span><span class=\"o\">,</span> <span class=\"n\">name</span><span class=\"o\">,</span> <span class=\"n\">IssueType</span><span class=\"o\">.</span><span class=\"na\">STRUCTURE</span><span class=\"o\">,</span> <span class=\"s\">&quot;This cannot be parsed as a FHIR object (no name)&quot;</span><span class=\"o\">,</span> <span class=\"n\">IssueSeverity</span><span class=\"o\">.</span><span class=\"na\">FATAL</span><span class=\"o\">);</span>\n      <span class=\"k\">return</span> <span class=\"kc\">null</span><span class=\"o\">;</span>\n    <span class=\"o\">}</span>\n    <span class=\"c1\">// first pass: only look at base definitions</span>\n      <span class=\"k\">for</span> <span class=\"o\">(</span><span class=\"n\">StructureDefinition</span> <span class=\"n\">sd</span> <span class=\"o\">:</span> <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"na\">allStructures</span><span class=\"o\">())</span> <span class=\"o\">{</span>\n        <span class=\"k\">if</span> <span class=\"o\">(</span><span class=\"n\">sd</span><span class=\"o\">.</span><span class=\"na\">getUrl</span><span class=\"o\">().</span><span class=\"na\">equals</span><span class=\"o\">(</span><span class=\"s\">&quot;http://hl7.org/fhir/StructureDefinition/&quot;</span><span class=\"o\">+</span><span class=\"n\">name</span><span class=\"o\">))</span> <span class=\"o\">{</span>\n          <span class=\"k\">return</span> <span class=\"n\">sd</span><span class=\"o\">;</span>\n        <span class=\"o\">}</span>\n      <span class=\"o\">}</span>\n    <span class=\"k\">for</span> <span class=\"o\">(</span><span class=\"n\">StructureDefinition</span> <span class=\"n\">sd</span> <span class=\"o\">:</span> <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"na\">allStructures</span><span class=\"o\">())</span> <span class=\"o\">{</span>\n      <span class=\"k\">if</span> <span class=\"o\">(</span><span class=\"n\">name</span><span class=\"o\">.</span><span class=\"na\">equals</span><span class=\"o\">(</span><span class=\"n\">sd</span><span class=\"o\">.</span><span class=\"na\">getIdElement</span><span class=\"o\">().</span><span class=\"na\">getIdPart</span><span class=\"o\">()))</span> <span class=\"o\">{</span>\n        <span class=\"k\">return</span> <span class=\"n\">sd</span><span class=\"o\">;</span>\n      <span class=\"o\">}</span>\n    <span class=\"o\">}</span>\n      <span class=\"n\">logError</span><span class=\"o\">(</span><span class=\"n\">line</span><span class=\"o\">,</span> <span class=\"n\">col</span><span class=\"o\">,</span> <span class=\"n\">name</span><span class=\"o\">,</span> <span class=\"n\">IssueType</span><span class=\"o\">.</span><span class=\"na\">STRUCTURE</span><span class=\"o\">,</span> <span class=\"s\">&quot;This does not appear to be a FHIR resource (unknown name &#39;&quot;</span><span class=\"o\">+</span><span class=\"n\">name</span><span class=\"o\">+</span><span class=\"s\">&quot;&#39;)&quot;</span><span class=\"o\">,</span> <span class=\"n\">IssueSeverity</span><span class=\"o\">.</span><span class=\"na\">FATAL</span><span class=\"o\">);</span>\n      <span class=\"k\">return</span> <span class=\"kc\">null</span><span class=\"o\">;</span>\n  <span class=\"o\">}</span>\n</pre></div>",
        "id": 153978200,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1532581964
    },
    {
        "content": "<p>I made that change a long time ago. what version are you running?</p>",
        "id": 153978201,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1532581990
    },
    {
        "content": "<p>It would be the \"copy\" that is in HAPI 3.4.0</p>",
        "id": 153978204,
        "sender_full_name": "Michael Lawley",
        "timestamp": 1532582105
    },
    {
        "content": "<p>hmm. you should chat to James about how old that is</p>",
        "id": 153978205,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1532582141
    },
    {
        "content": "<p>But I've just done a git pull and see no difference - wait, that's a different method</p>",
        "id": 153978206,
        "sender_full_name": "Michael Lawley",
        "timestamp": 1532582239
    },
    {
        "content": "<p>Your version has no <code>ns</code> parameter</p>",
        "id": 153978207,
        "sender_full_name": "Michael Lawley",
        "timestamp": 1532582258
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>XmlParser(ParserBase).getDefinition(int, int, String, String) line: 88\nXmlParser.parse(Element) line: 150\nXmlParser.parse(Document) line: 142\n</pre></div>",
        "id": 153978208,
        "sender_full_name": "Michael Lawley",
        "timestamp": 1532582453
    },
    {
        "content": "<p>ok, well, I just committed a fix that seems to work....</p>",
        "id": 153978209,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1532582820
    },
    {
        "content": "<p>or not... thought of one more test to do</p>",
        "id": 153978211,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1532582871
    },
    {
        "content": "<p>Many thanks!</p>",
        "id": 153978212,
        "sender_full_name": "Michael Lawley",
        "timestamp": 1532582871
    }
]