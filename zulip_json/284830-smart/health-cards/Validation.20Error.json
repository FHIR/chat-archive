[
    {
        "content": "<p>When I validate this card at <a href=\"https://demo-portals.smarthealth.cards/VerifierPortal.html\">https://demo-portals.smarthealth.cards/VerifierPortal.html</a> it says: </p>\n<blockquote>\n<p>JWS.payload.vc.type SHOULD NOT contain 'https://smarthealth.cards#covid19', no covid immunization or observation found (Warning)</p>\n</blockquote>\n<div class=\"codehilite\"><pre><span></span><code>shc:/56762959532654603460292540772804336028702865676754222809286237253760287028647167452228092862676756640775452733594526440840395570532363315424440541063307566255713324083245655533382608634305290341261266314211605736011041313153717074243574414406734174043054283344715444266067755228640373587408675242057467406359383271752050040838666624540959452569742507075608745565522669762271593666520810666877750445637503527645655944110969272131360074334075550433423738060856666458402520123669720621254031123331090850522571620459326604644022721044570862665231671064342405523655532700280352055352506339063938523358632829596803620960567269060603640728226228577652052041352130637164593854330454555604076622597064526558417158507525714423443872522536624044673975614424652023002577303112075063096753097464032842654265693608372809737565750454730535322531533463225968044024773311446263236227224020006467100573442135217212337372675357612810684569636157695535635341684032281029254165250605411257727167207152590905040366340340343668082338602404313675555636376767530926315674450072666537085574617255396365397109587111382025055675665958771006271167043329341105745657035727086220053728533008683775690676223440673407003940230939034431592545100358244543200870737774123242757105443621547161677056602465356010123376583433242304357756236541700808363162706000606729763234070761616260605407456409636945393432570568252311053556702575706371373600615506043632690636350712623572037335505736357445750411017706236169621207522310593128677677003259244526565704043072692271296668055233503768717076633411536135593465634411264329687541696306661145570728305020587211437233071024380420\n</code></pre></div>\n<p>I think that this is wrong; it is a covid immunization</p>",
        "id": 254005730,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1632121364
    },
    {
        "content": "<p>The dev tool (and the related portal) currently only recognizes the CVX codes for the <a href=\"https://www.cdc.gov/vaccines/covid-19/info-by-product/index.html\">CDC-approved</a> vaccines. I opened <a href=\"https://github.com/smart-on-fhir/health-cards-dev-tools/issues/155\">issue 155</a> to track.</p>",
        "id": 254051350,
        "sender_full_name": "Christian Paquin",
        "timestamp": 1632145184
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"385047\">@Christian Paquin</span> I get this error:</p>",
        "id": 254082744,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1632157251
    },
    {
        "content": "<p>key[Jizn1dsadf9Q7ll9KpF6WsxzGm4NLfwMHne_btToh-o]: 'kid' does not match thumbprint in issuer key. expected: P0dT_um48eUyAcuwnquYNyhkF6yFeSqD0MwarDEX-RY, actual: Jizn1dsadf9Q7ll9KpF6WsxzGm4NLfwMHne_btToh-o (Error)</p>",
        "id": 254082749,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1632157252
    },
    {
        "content": "<p>for the key</p>",
        "id": 254082763,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1632157257
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"p\">{</span>\n  <span class=\"nt\">\"keys\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n    <span class=\"p\">{</span>\n      <span class=\"nt\">\"kty\"</span><span class=\"p\">:</span> <span class=\"s2\">\"EC\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"use\"</span><span class=\"p\">:</span> <span class=\"s2\">\"sig\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"crv\"</span><span class=\"p\">:</span> <span class=\"s2\">\"P-256\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"kid\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Jizn1dsadf9Q7ll9KpF6WsxzGm4NLfwMHne_btToh-o\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"x\"</span><span class=\"p\">:</span> <span class=\"s2\">\"6BCsFU2b4brCIu84tLirgRklxqnjo4qFrkz6vAD1WGY\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"y\"</span><span class=\"p\">:</span> <span class=\"s2\">\"-EocuDdDkTQkUJTyyUbUQuF3Gaa1fG8NLhFFkDXWMSs\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"alg\"</span><span class=\"p\">:</span> <span class=\"s2\">\"ES256\"</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">]</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 254082804,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1632157270
    },
    {
        "content": "<p>but I calculate a different thumbprint for that key, <code>VLJ4BhnFrN0aSnQ5RKUPH7vXjzFPkh4zCe_-Ma0duIU</code></p>",
        "id": 254082898,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1632157315
    },
    {
        "content": "<p>I'm hashing <code>{\"crv\":\"P-256\",\"kty\":\"EC\",\"x\":\"6BCsFU2b4brCIu84tLirgRklxqnjo4qFrkz6vAD1WGY\",\"y\";\"-EocuDdDkTQkUJTyyUbUQuF3Gaa1fG8NLhFFkDXWMSs\"}</code> - how does the portal come up with the thumbprint?</p>",
        "id": 254083011,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1632157348
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"390125\">@Larry Joy</span></p>",
        "id": 254083541,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1632157567
    },
    {
        "content": "<p>The validation tool uses the <code>npm</code>  <code>jose</code> package to calculate the <code>kid</code>. Are you using SHA-256 for the kid calculation? Are you placing the properties in alphabetical order, per <a href=\"https://datatracker.ietf.org/doc/html/rfc7638#section-3\">section 3</a> of RFC 7638?</p>",
        "id": 254090253,
        "sender_full_name": "Christian Paquin",
        "timestamp": 1632160306
    },
    {
        "content": "<p>yes, SHA-256 from openSSL, and it calculated this example OK: <a href=\"https://connect2id.com/products/nimbus-jose-jwt/examples/jwk-thumbprints\">https://connect2id.com/products/nimbus-jose-jwt/examples/jwk-thumbprints</a></p>\n<p>And yes, alphabetic - I showed that abvove</p>",
        "id": 254091585,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1632160810
    },
    {
        "content": "<p>Here is code to compute the KID on a browser client that agrees with the jose implementation:<br>\nThe key is to sort the properties in alphabetical order and only include the required properties</p>\n<p>//<br>\n// Computes the 'kid' of a JWK key using SHA-256<br>\n//<br>\nasync function computeKid(keyJwk) {</p>\n<div class=\"codehilite\"><pre><span></span><code>// Kid computation requires properties in alphabetical order\nkeyJwk = { &quot;crv&quot;: &quot;P-256&quot;, &quot;kty&quot;: &quot;EC&quot;, &quot;x&quot;: keyJwk.x, &quot;y&quot;: keyJwk.y, };\n\nconst keyBytes = new Uint8Array(JSON.stringify(keyJwk).split(&#39;&#39;).map(c =&gt; c.charCodeAt(0)));\n\nreturn window.crypto.subtle.digest({ name: &quot;SHA-256&quot;, }, keyBytes)\n    .then(function (hash) {\n        return arrayBufferToBase64url(hash);\n    })\n    .catch(function (err) {\n        console.error(err);\n    });\n</code></pre></div>\n\n<p>}</p>",
        "id": 254092133,
        "sender_full_name": "Larry Joy",
        "timestamp": 1632161007
    },
    {
        "content": "<p>thanks for the help. I made a typo, which is why I was getting it wrong</p>",
        "id": 254094152,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1632161819
    },
    {
        "content": "<p>anyway, I'm happy, I can get my cards into Apple Health ;-)</p>",
        "id": 254103776,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1632165759
    }
]