[
    {
        "content": "<p>As mentioned in the scenario in the Confluence page: <a href=\"https://confluence.hl7.org/display/CAR/Track+Page+for+the+SMART+Health+Card\">https://confluence.hl7.org/display/CAR/Track+Page+for+the+SMART+Health+Card</a>, I tried the following against this reference server <a href=\"https://fhir-myrecord.stagingcerner.com/beta/ec2458f2-1e24-41c8-b71b-0e701af7583d\">https://fhir-myrecord.stagingcerner.com/beta/ec2458f2-1e24-41c8-b71b-0e701af7583d</a>:</p>\n<ol>\n<li>Registered a holder application with sand box server</li>\n<li>Got an access token from the authorization end point: <a href=\"https://authorization.cerner.com/tenants/ec2458f2-1e24-41c8-b71b-0e701af7583d/protocols/oauth2/profiles/smart-v1/token\">https://authorization.cerner.com/tenants/ec2458f2-1e24-41c8-b71b-0e701af7583d/protocols/oauth2/profiles/smart-v1/token</a></li>\n<li>Got the patient id from Patient info : 12724067 (GET <a href=\"https://fhir-myrecord.stagingcerner.com/beta/ec2458f2-1e24-41c8-b71b-0e701af7583d/Patient?given=JOE&amp;family=SMART&amp;birthdate=1976-04-29&amp;gender=male\">https://fhir-myrecord.stagingcerner.com/beta/ec2458f2-1e24-41c8-b71b-0e701af7583d/Patient?given=JOE&amp;family=SMART&amp;birthdate=1976-04-29&amp;gender=male</a>)</li>\n<li>Now on trying the $health-cards-issue operation with the access token, it is giving 404 response<br>\nHere are the API request / response, please review:</li>\n</ol>\n<div class=\"codehilite\"><pre><span></span><code>POST https://fhir-myrecord.stagingcerner.com/beta/ec2458f2-1e24-41c8-b71b-0e701af7583d/Patient/12724067/$health-cards-issue\nContent-Type: application/fhir+json\nAccept: application/fhir+json\nAuthorization: Bearer eyJraWQiOiIyMDIxLTA0LTEyVDAzOjIxOjU5LjgyNS5lYyIsInR5cCI6IkpXVCIsImFsZyI6IkVTMjU2In0.eyJpc3MiOiJodHRwczpcL1wvYXV0aG9yaXphdGlvbi5jZXJuZXIuY29tXC8iLCJleHAiOjE2MTgyNjQwNTEsImlhdCI6MTYxODI2MzQ1MSwianRpIjoiNGZkOTdjYTItZTgxNS00MTc0LWE3OWEtNTIzMDExOGNkMjg1IiwidXJuOmNlcm5lcjphdXRob3JpemF0aW9uOmNsYWltczp2ZXJzaW9uOjEiOnsidmVyIjoiMS4wIiwicHJvZmlsZXMiOnsic21hcnQtdjEiOnsiYXpzIjoic3lzdGVtXC9BbGxlcmd5SW50b2xlcmFuY2UucmVhZCBzeXN0ZW1cL0NvbmRpdGlvbi5yZWFkIHN5c3RlbVwvQ29uc2VudC5yZWFkIHN5c3RlbVwvQ292ZXJhZ2UucmVhZCBzeXN0ZW1cL0RvY3VtZW50UmVmZXJlbmNlLnJlYWQgc3lzdGVtXC9FbmNvdW50ZXIucmVhZCBzeXN0ZW1cL0dvYWwucmVhZCBzeXN0ZW1cL0ltbXVuaXphdGlvbi5yZWFkIHN5c3RlbVwvTG9jYXRpb24ucmVhZCBzeXN0ZW1cL01lZGljYXRpb25SZXF1ZXN0LnJlYWQgc3lzdGVtXC9OdXRyaXRpb25PcmRlci5yZWFkIHN5c3RlbVwvT2JzZXJ2YXRpb24ucmVhZCBzeXN0ZW1cL09yZ2FuaXphdGlvbi5yZWFkIHN5c3RlbVwvUGF0aWVudC5yZWFkIHN5c3RlbVwvUHJhY3RpdGlvbmVyLnJlYWQgc3lzdGVtXC9Qcm9jZWR1cmUucmVhZCBzeXN0ZW1cL0FsbGVyZ3lJbnRvbGVyYW5jZS53cml0ZSBzeXN0ZW1cL0Jhc2ljLndyaXRlIHN5c3RlbVwvQ29uZGl0aW9uLndyaXRlIHN5c3RlbVwvQ292ZXJhZ2Uud3JpdGUgc3lzdGVtXC9Eb2N1bWVudFJlZmVyZW5jZS53cml0ZSBzeXN0ZW1cL0VuY291bnRlci53cml0ZSBzeXN0ZW1cL0ltbXVuaXphdGlvbi53cml0ZSBzeXN0ZW1cL01lZGljYXRpb25SZXF1ZXN0LndyaXRlIHN5c3RlbVwvT2JzZXJ2YXRpb24ud3JpdGUgc3lzdGVtXC9Pcmdhbml6YXRpb24ud3JpdGUgc3lzdGVtXC9QYXRpZW50LndyaXRlIHN5c3RlbVwvUHJhY3RpdGlvbmVyLndyaXRlIHN5c3RlbVwvUHJvY2VkdXJlLndyaXRlIHN5c3RlbVwvRmluYW5jaWFsVHJhbnNhY3Rpb24ud3JpdGUifX0sImNsaWVudCI6eyJuYW1lIjoiU2FmZUhlYWx0aCIsImlkIjoiYjE5YmJlYTItNmQ3Yi00YjQ4LWJlOTItMjM0MjE4YjhhMGU5In0sInRlbmFudCI6ImVjMjQ1OGYyLTFlMjQtNDFjOC1iNzFiLTBlNzAxYWY3NTgzZCJ9fQ.Kzp_TtDEiqLresNjnUUz6Dw6lPYA-XdHcTE9cKTazKFn0WU3heb1krvimFe6etE-UrCX0DijtnrhX173OZ_A_Q\nUser-Agent: PostmanRuntime/7.26.10\nCache-Control: no-cache\nPostman-Token: 97a3c6ad-ef66-4f68-ac95-7a6ddf15adc9\nHost: fhir-myrecord.stagingcerner.com\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\nContent-Length: 188\n{\n&quot;resourceType&quot;: &quot;Parameters&quot;,\n&quot;parameter&quot;: [\n{\n&quot;name&quot;: &quot;credentialType&quot;,\n&quot;valueUri&quot;: &quot;https://smarthealth.cards#covid19&quot;\n}\n]\n}\n\n\nHTTP/1.1 404 Not Found\nContent-Type: application/fhir+json; charset=utf-8\nContent-Length: 120\nConnection: keep-alive\nCache-Control: no-cache\nDate: Mon, 12 Apr 2021 21:38:43 GMT\nServer-Response-Time: 11.043107\nStatus: 404 Not Found\nVary: Origin\nX-Request-Id: 091e2d6f-8348-4e13-9bb1-8f75789fd820\nX-Runtime: 0.010245\nX-Cache: Error from cloudfront\nVia: 1.1 e840fad61f5e0035145abd6ba7445b2a.cloudfront.net (CloudFront)\nX-Amz-Cf-Pop: BOM50-C1\nX-Amz-Cf-Id: gD05hmKKl3uWZU-I-Wwd95DmmyssA3s-oqv3QSPz3_QR4ekU-fgeZw==\n{&quot;resourceType&quot;:&quot;OperationOutcome&quot;,&quot;issue&quot;:[{&quot;severity&quot;:&quot;error&quot;,&quot;code&quot;:&quot;not-supported&quot;,&quot;details&quot;:{&quot;text&quot;:&quot;Not Found&quot;}}]}\n</code></pre></div>\n<p>Am I missing something here? What is the cause of the 404 error?<br>\ncc: <span class=\"user-mention\" data-user-id=\"353749\">@Michael Turman</span> <span class=\"user-mention\" data-user-id=\"191809\">@Joe Rattazzi</span> <span class=\"user-mention\" data-user-id=\"341228\">@Suprakash Maity</span> <span class=\"user-mention\" data-user-id=\"321627\">@Cibi Siddharth</span></p>",
        "id": 234236078,
        "sender_full_name": "Santosh Jami",
        "timestamp": 1618263975
    },
    {
        "content": "<p>Thanks for trying it out. Looks like we have some documentation to provide.</p>\n<p>The Health Cards workflow doesn't support a System/B2B authorization, as it's meant to be a patient directly requesting their own data.</p>\n<p>edit: I'm assuming you're making a system/B2B call, given your provided token is using <code>system/</code> scopes.</p>",
        "id": 234236654,
        "sender_full_name": "Joe Rattazzi",
        "timestamp": 1618264356
    },
    {
        "content": "<p>If you try removing your authorization header, and call <code>fhir-open</code> instead of <code>fhir-myrecord</code>,  you should get a successful call</p>",
        "id": 234236702,
        "sender_full_name": "Joe Rattazzi",
        "timestamp": 1618264396
    },
    {
        "content": "<p>(or if you want to try with authorization, presumably you can initiate a smart standalone launch with patient context.)</p>",
        "id": 234236764,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618264443
    },
    {
        "content": "<p>Agreed with Josh. </p>\n<p>If you do register a Patient app with Cerner's Code Portal (<a href=\"https://code.cerner.com/developer/smart-on-fhir/apps\">https://code.cerner.com/developer/smart-on-fhir/apps</a>), you'll need to make sure you are using the following Scopes: <code>patient/Patient.read\npatient/Immunization.read</code> <del>user/Location.read</del> </p>\n<p>Edit: <code>user/Location.read</code> is no longer required</p>",
        "id": 234237058,
        "sender_full_name": "Joe Rattazzi",
        "timestamp": 1618264600
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> and <span class=\"user-mention\" data-user-id=\"191809\">@Joe Rattazzi</span> for your inputs.</p>\n<p>To begin with, I tried the fhir-open, and I got the \"verifiableCredential\"<br>\nAnother follow up query, how do I decode the JWS valueString ?</p>",
        "id": 234238971,
        "sender_full_name": "Santosh Jami",
        "timestamp": 1618265798
    },
    {
        "content": "<p>There are open source libraries for decoding a JWT (<a href=\"https://jwt.io/\">https://jwt.io/</a>). Keep in mind, the payload is also compressed using DEFLATE compression.</p>\n<p>We have an open endpoint you can use to decode and decompress the VC as part of our test reference implementation (not intended for production use):</p>\n<p>Additional Utility Endpoints</p>\n<p>Decode/Decompress and verify JWS signature<br>\nUses the iss in the jws payload to retrieve the public jwks for the issuer to use while validating the signature.</p>\n<p>Endpoint: POST <a href=\"https://fhir-open.stagingcerner.com/beta/admin/health-cards/decode\">https://fhir-open.stagingcerner.com/beta/admin/health-cards/decode</a></p>\n<p>Request Parameters:<br>\n•   jws: The JWS token to decode<br>\n•   verify_signature: Whether public jwks retrieval and signature verification should be performed</p>",
        "id": 234241348,
        "sender_full_name": "Michael Turman",
        "timestamp": 1618267364
    },
    {
        "content": "<p>Obligatory reference to relevant section of the SHC spec: <a href=\"https://smarthealth.cards/#health-cards-are-encoded-as-compact-serialization-json-web-signatures-jws\">https://smarthealth.cards/#health-cards-are-encoded-as-compact-serialization-json-web-signatures-jws</a></p>",
        "id": 234241690,
        "sender_full_name": "Michael Turman",
        "timestamp": 1618267625
    },
    {
        "content": "<p>As a follow-up here, we've got a guide for integrating with Cerner's  reference implementation: <a href=\"https://github.com/joeratt/connectathon_notes/blob/april_2021-health_cards/health_cards/Cerner%20SMART%20Health%20Cards%20-%20Proof%20of%20Concept%20-%20Integration%20Notes.md\">https://github.com/joeratt/connectathon_notes/blob/april_2021-health_cards/health_cards/Cerner%20SMART%20Health%20Cards%20-%20Proof%20of%20Concept%20-%20Integration%20Notes.md</a></p>",
        "id": 234412863,
        "sender_full_name": "Joe Rattazzi",
        "timestamp": 1618353599
    },
    {
        "content": "<p>For the SmartOnFhir configuration using the <code>fhirclient</code> node client, does <a href=\"https://fhir-open.stagingcerner.com/beta/ec2458f2-1e24-41c8-b71b-0e701af7583d/\">https://fhir-open.stagingcerner.com/beta/ec2458f2-1e24-41c8-b71b-0e701af7583d/</a> go in both <code>iss</code> and <code>fhirServiceUrl</code> parameters?</p>",
        "id": 234518553,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618413521
    },
    {
        "content": "<p>yep</p>",
        "id": 234519944,
        "sender_full_name": "Joe Rattazzi",
        "timestamp": 1618413907
    },
    {
        "content": "<p>I was expecting the <a href=\"https://github.com/joeratt/connectathon_notes/blob/april_2021-health_cards/health_cards/Cerner%20SMART%20Health%20Cards%20-%20Proof%20of%20Concept%20-%20Integration%20Notes.md#example-response\">example</a> to have \"shc:/...\" for valueString</p>",
        "id": 234523690,
        "sender_full_name": "Paul Denning",
        "timestamp": 1618415215
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"194174\">@Paul Denning</span> \"shc:/\" prefix is only for the numerically encoded version of the data.</p>",
        "id": 234524085,
        "sender_full_name": "Matt Printz",
        "timestamp": 1618415341
    },
    {
        "content": "<p>That's right.</p>\n<p>The FHIR issuance API returns JWSs directly. These can be then: 1) packaged into <code>.smart-health-card</code> JSON files, or 2) encoded into QRs (Where the prefix comes into play.)</p>",
        "id": 234524155,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618415370
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191678\">@Abigail Watson</span> - i just re-read your message and realized that you're hitting the open endpoint. I'm trying it out myself now, but I'm curious if you got the launch to work with the open endpoint</p>",
        "id": 234527203,
        "sender_full_name": "Joe Rattazzi",
        "timestamp": 1618416399
    },
    {
        "content": "<p>most examples use the closed endpoints to test patient launches (where the iss comes into play)</p>",
        "id": 234527316,
        "sender_full_name": "Joe Rattazzi",
        "timestamp": 1618416437
    },
    {
        "content": "<p>It's been a year or more since I've looked at a SmartOnFhir launch context, but as I recall the <code>fhirServiceUrl</code> field is there as a bootstrap/helper field to shortcut what would normally be returned in the <code>iss</code> after patient auth negotiations.    <code>fhirServiceUrl</code> isn't the same as <code>fhirBase</code> or <code>baseUrl</code>.  It's a thing specific to the <code>fhirclient</code> library and the SMART protocol, not the FHIR protocol.</p>",
        "id": 234528970,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618417062
    },
    {
        "content": "<p>Put another way, if you're going to try to launch from an open endpoint, you have to use the <code>fhirServiceUrl</code>.  As I recall.  Will be testing if that assumption still holds in just a few.  ;)</p>",
        "id": 234529244,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618417156
    },
    {
        "content": "<p>Jinkies!  Got it to redirect back to the PatientDashboard.  Dashboard is broken, but the redirect... worked.  How about that....</p>",
        "id": 234533489,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618418787
    },
    {
        "content": "<p>sweet!</p>",
        "id": 234534151,
        "sender_full_name": "Joe Rattazzi",
        "timestamp": 1618419011
    },
    {
        "content": "<p>I think we're going to need a <code>patientId</code> for the open endpoint.  I have pretty much everything else ready and set up to do a POST.  </p>\n<p>Will also get started on the authenticated flow, and see if we can get a <code>patientId</code> that way.  </p>\n<p>Found the <code>patientId</code> in the Google Doc.  Thanks.</p>",
        "id": 234538452,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618420579
    },
    {
        "content": "<p>Got a <code>200</code> response for Nancy Smart on the open endpoint!  </p>\n<p><a href=\"/user_uploads/10155/O7xmhOEzQzg0BNF0WYNUlXXv/Screen-Shot-2021-04-14-at-12.53.45-PM.png\">Screen-Shot-2021-04-14-at-12.53.45-PM.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/O7xmhOEzQzg0BNF0WYNUlXXv/Screen-Shot-2021-04-14-at-12.53.45-PM.png\" title=\"Screen-Shot-2021-04-14-at-12.53.45-PM.png\"><img src=\"/user_uploads/10155/O7xmhOEzQzg0BNF0WYNUlXXv/Screen-Shot-2021-04-14-at-12.53.45-PM.png\"></a></div>",
        "id": 234544993,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618422876
    },
    {
        "content": "<p>Oh sorry about that - I didn't realize you were indicating you needed the patient id <span aria-label=\"face palm\" class=\"emoji emoji-1f926\" role=\"img\" title=\"face palm\">:face_palm:</span>  Glad you found it and got it working!</p>",
        "id": 234545638,
        "sender_full_name": "Joe Rattazzi",
        "timestamp": 1618423106
    },
    {
        "content": "<p>So, I'm trying to inflate the decoded token payload, and getting an <code>invalid code lengths set</code> error.  <br>\n<a href=\"/user_uploads/10155/8Z4J1tGtISlQyuHLL8HBVnLY/Screen-Shot-2021-04-14-at-3.59.18-PM.png\">Screen-Shot-2021-04-14-at-3.59.18-PM.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/8Z4J1tGtISlQyuHLL8HBVnLY/Screen-Shot-2021-04-14-at-3.59.18-PM.png\" title=\"Screen-Shot-2021-04-14-at-3.59.18-PM.png\"><img src=\"/user_uploads/10155/8Z4J1tGtISlQyuHLL8HBVnLY/Screen-Shot-2021-04-14-at-3.59.18-PM.png\"></a></div>",
        "id": 234575154,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618434250
    },
    {
        "content": "<p>It looks like you're trying to inflate <code>undefined</code> instead of inflating a JWS payload. Is Cerner giving you a missing payload?</p>",
        "id": 234576854,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618434675
    },
    {
        "content": "<p>Maybe.  Could be that <code>base64</code> encoding issue, or maybe they're not using the raw DEFLATE algorithm.  Something.  I'm using the same libraries and calls as for the QR code.  Nothing new or different on my side.  The variable change here is different issuer and payload generator.</p>",
        "id": 234577642,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618434858
    },
    {
        "content": "<p>we are using DEFLATE, for what it's worth</p>",
        "id": 234577977,
        "sender_full_name": "Joe Rattazzi",
        "timestamp": 1618434960
    },
    {
        "content": "<p>I can confirm that the Cerner QRs do generally work, from the demo <span class=\"user-mention\" data-user-id=\"328301\">@JP Pollak</span> gave on today's VCI big-group call, I used <a href=\"https://joshuamandel.com/health-card-scanner-demo/\">https://joshuamandel.com/health-card-scanner-demo/</a> to successfully scan the QR from his CommonHealth demo ;-)</p>",
        "id": 234578099,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618435008
    },
    {
        "content": "<p>Swapping out the native Node zlib library for the <code>pako</code> implementation.  Should have it all sorted out in short order.</p>\n<p>I suppose I could have looked closer at the SDK utility, and saved myself a lot of troubleshooting.  :sigh:</p>",
        "id": 234583108,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618437436
    },
    {
        "content": "<p>Well, especially in a connectathon there's value in independent implementations!</p>",
        "id": 234583799,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618437756
    },
    {
        "content": "<p>Success, sort of.  Hello Carlos HWMockOne.</p>\n<div class=\"codehilite\"><pre><span></span><code>{&quot;iss&quot;:&quot;https://fhir-open.stagingcerner.com/beta/ec2458f2-1e24-41c8-b71b-0e701af7583d&quot;,&quot;nbf&quot;:1618440157,&quot;vc&quot;:{&quot;@context&quot;:[&quot;https://www.w3.org/2018/credentials/v1&quot;],&quot;type&quot;:[&quot;VerifiableCredential&quot;,&quot;https://smarthealth.cards#health-card&quot;,&quot;https://smarthealth.cards#covid19&quot;,&quot;https://smarthealth.cards#immunization&quot;],&quot;credentialSubject&quot;:{&quot;fhirVersion&quot;:&quot;4.0.0&quot;,&quot;fhirBundle&quot;:{&quot;resourceType&quot;:&quot;Bundle&quot;,&quot;type&quot;:&quot;collection&quot;,&quot;entry&quot;:[{&quot;fullUrl&quot;:&quot;resource:0&quot;,&quot;resource&quot;:{&quot;resourceType&quot;:&quot;Patient&quot;,&quot;name&quot;:[{&quot;family&quot;:&quot;HWMockOne&quot;,&quot;given&quot;:[&quot;Carlos&quot;,&quot;Shyann&quot;]}],&quot;birthDate&quot;:&quot;1970-01-02&quot;}},{&quot;fullUrl&quot;:&quot;resource:1&quot;,&quot;resource&quot;:{&quot;resourceType&quot;:&quot;Immunization&quot;,&quot;status&quot;:&quot;completed&quot;,&quot;vaccineCode&quot;:{&quot;coding&quot;:[{&quot;system&quot;:&quot;http://hl7.org/fhir/sid/cvx&quot;,&quot;code&quot;:&quot;207&quot;}]},&quot;patient&quot;:{&quot;reference&quot;:&quot;resource:0&quot;},&quot;occurrenceDateTime&quot;:&quot;2021-02-18&quot;,&quot;lotNumber&quot;:&quot;000002&quot;,&quot;performer&quot;:[{&quot;actor&quot;:{&quot;display&quot;:&quot;Model Hospital&quot;}}]}},{&quot;fullUrl&quot;:&quot;resource:2&quot;,&quot;resource&quot;:{&quot;resourceType&quot;:&quot;Immunization&quot;,&quot;status&quot;:&quot;completed&quot;,&quot;vaccineCode&quot;:{&quot;coding&quot;:[{&quot;system&quot;:&quot;http://hl7.org/fhir/sid/cvx&quot;,&quot;code&quot;:&quot;207&quot;}]},&quot;patient&quot;:{&quot;reference&quot;:&quot;resource:0&quot;},&quot;occurrenceDateTime&quot;:&quot;2021-01-28&quot;,&quot;lotNumber&quot;:&quot;0000001&quot;,&quot;performer&quot;:[{&quot;actor&quot;:{&quot;display&quot;:&quot;Model Hospital&quot;}}]}}]}}}}\n</code></pre></div>\n<p>Small problem:  was querying for Nancy Smart's healthcards.</p>",
        "id": 234588464,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618440442
    },
    {
        "content": "<p>All roads lead to Carlos HWMockOne, currently.</p>",
        "id": 234588744,
        "sender_full_name": "Michael Turman",
        "timestamp": 1618440625
    },
    {
        "content": "<p>When we get a 'real' sandbox deployment (this summer), the Smart family should have a full battery of SHC test scenarios.</p>",
        "id": 234588817,
        "sender_full_name": "Michael Turman",
        "timestamp": 1618440678
    },
    {
        "content": "<p>Then I'm declaring victory for the connectathon.  <span aria-label=\"sunglasses\" class=\"emoji emoji-1f60e\" role=\"img\" title=\"sunglasses\">:sunglasses:</span></p>",
        "id": 234589390,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618441032
    }
]