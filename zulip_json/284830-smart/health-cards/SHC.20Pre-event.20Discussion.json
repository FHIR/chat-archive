[
    {
        "content": "<p><a href=\"https://confluence.hl7.org/display/CAR/Track+Page+for+the+SMART+Health+Card\">https://confluence.hl7.org/display/CAR/Track+Page+for+the+SMART+Health+Card</a></p>",
        "id": 233865673,
        "sender_full_name": "Michael Turman",
        "timestamp": 1617991274
    },
    {
        "content": "<p>Hello SmartHealthCards!</p>",
        "id": 233904005,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618009285
    },
    {
        "content": "<p>So.... I managed to generate a QR code with a FHIR Immunization record on it for Candace Salinas.  Thought it might be a nice way to to get people conversing on this upcoming track, and to kick things off.  Can anybody verify with a smartphone camera that they can get the FHIR resource?  Thanks in advance!</p>\n<p><a href=\"/user_uploads/10155/nUQUqgi9A8-9hgMRI_g5T34p/Symptomatic-VaccineWallet-QrCode-CandaceSalinas.png\">Symptomatic-VaccineWallet-QrCode-CandaceSalinas.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/nUQUqgi9A8-9hgMRI_g5T34p/Symptomatic-VaccineWallet-QrCode-CandaceSalinas.png\" title=\"Symptomatic-VaccineWallet-QrCode-CandaceSalinas.png\"><img src=\"/user_uploads/10155/nUQUqgi9A8-9hgMRI_g5T34p/Symptomatic-VaccineWallet-QrCode-CandaceSalinas.png\"></a></div>",
        "id": 233920499,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618024176
    },
    {
        "content": "<p>Excellent!!</p>\n<p><a href=\"https://smarthealth.cards/#what-testing-tools-are-available-to-validate-smart-health-cards-implementations\">https://smarthealth.cards/#what-testing-tools-are-available-to-validate-smart-health-cards-implementations</a> includes a link to the validation SDK (nodejs CLI, will take QRs as input and run them through their paces) and a few other helpful resources.</p>\n<p>I also have a rough web based QR scanner + card validator at <a href=\"https://joshuamandel.com/health-card-scanner-demo\">https://joshuamandel.com/health-card-scanner-demo</a> (source at <a href=\"https://github.com/jmandel/health-card-scanner-demo\">https://github.com/jmandel/health-card-scanner-demo</a>) that folks are welcome to try if anyone wants to give this a shot from their own device. (If doesn't give useful feedback about any problems, but it'll print a fhir bundle to the screen if things work. In the case of the QR above, it doesn't work; see notes below for why.)</p>",
        "id": 233936922,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618041914
    },
    {
        "content": "<p>Validator gives you a good start on issues to address:</p>\n<div class=\"codehilite\"><pre><span></span><code>$ node . -p ~/Downloads/Symptomatic-VaccineWallet-QrCode-CandaceSalinas.png  -t qr -l debug\nSMART Health Card Validation SDK v0.4.3\nQR image\n     |\n     ├─ Debug :\n     |    Symptomatic-VaccineWallet-QrCode-CandaceSalinas.png = {&quot;status&quot;:&quot;completed&quot;,&quot;wasNotGiven&quot;:false,&quot;patient&quot;:{&quot;display&quot;:&quot;Candace Salinas&quot;,&quot;reference&quot;:&quot;Patient/100&quot;},&quot;id&quot;:&quot;3&quot;,&quot;encounter&quot;:{&quot;reference&quot;:&quot;Encounter/129837645&quot;},&quot;date&quot;:&quot;2017-10-18&quot;,&quot;requester&quot;:{&quot;display&quot;:&quot;Altick Kelly&quot;,&quot;reference&quot;:&quot;Practitioner/8&quot;},&quot;reported&quot;:false,&quot;vaccineCode&quot;:{&quot;text&quot;:&quot;Influenza&quot;,&quot;coding&quot;:[{&quot;system&quot;:&quot;CVX&quot;,&quot;code&quot;:&quot;135&quot;}]},&quot;resourceType&quot;:&quot;Immunization&quot;,&quot;_id&quot;:&quot;J4TjYWRYL5yqWqfor&quot;,&quot;_document&quot;:{&quot;status&quot;:&quot;completed&quot;,&quot;wasNotGiven&quot;:false,&quot;patient&quot;:{&quot;display&quot;:&quot;Candace Salinas&quot;,&quot;reference&quot;:&quot;Patient/100&quot;},&quot;id&quot;:&quot;3&quot;,&quot;encounter&quot;:{&quot;reference&quot;:&quot;Encounter/129837645&quot;},&quot;date&quot;:&quot;2017-10-18&quot;,&quot;requester&quot;:{&quot;display&quot;:&quot;Altick Kelly&quot;,&quot;reference&quot;:&quot;Practitioner/8&quot;},&quot;reported&quot;:false,&quot;vaccineCode&quot;:{&quot;text&quot;:&quot;Influenza&quot;,&quot;coding&quot;:[{&quot;system&quot;:&quot;CVX&quot;,&quot;code&quot;:&quot;135&quot;}]},&quot;resourceType&quot;:&quot;Immunization&quot;,&quot;_id&quot;:&quot;J4TjYWRYL5yqWqfor&quot;}}\n     |\n     ├─ Info :\n     |    Symptomatic-VaccineWallet-QrCode-CandaceSalinas.png decoded\n     |\n    QR numeric\n         |\n         └─ Error :\n              Invalid numeric QR header: expected shc:/[0-9]/[0-9]/[0-9]+\n</code></pre></div>\n<p>... but briefly this bundle needs to be:</p>\n<ul>\n<li>updated with resources that match the <a href=\"http://build.fhir.org/ig/dvci/vaccine-credential-ig/branches/main/StructureDefinition-vaccination-credential-bundle-dm.html#tab-ms\">Vaccination data profiles</a>, </li>\n<li>packaged to follow <a href=\"https://smarthealth.cards/#health-cards-are-small\">https://smarthealth.cards/#health-cards-are-small</a>, and </li>\n<li>encoded to follow <a href=\"https://smarthealth.cards/#creating-a-qr-code-or-a-set-of-qr-codes-from-a-health-card-jws\">https://smarthealth.cards/#creating-a-qr-code-or-a-set-of-qr-codes-from-a-health-card-jws</a></li>\n</ul>",
        "id": 233937295,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618042315
    },
    {
        "content": "<p>(While you've got fresh eyes <span class=\"user-mention\" data-user-id=\"191678\">@Abigail Watson</span> , would love feedback or ideas on how to highlight all of this better for new developers.)</p>",
        "id": 233937427,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618042448
    },
    {
        "content": "<p>Well, as far as feedback and ideas, there are three immediate things that come to mind:</p>\n<p>First, I think there's going to be unsigned FHIR resources in the ecosystem.  That's just going to be a pragmatic reality.  So, I think we need discussion around what implementors should do in the unencrypted usecase... which is precisely why I started with a FHIR Immunization resource rather than starting with the FHIR Bundle structure defined in the SMART HealthCard spec.  Validator is good.  But as a developer, I need to know how to handle this exception case (which could be very common).  </p>\n<p>(And frankly... I have to ask the devil's advocate question:  do we really know/believe that man-in-the-middle and forgery attacks are going to be all that common?  Or that the harm of such would materially impact users?  Or would alter the course of this or any other pandemic?  Security is good.  But from a functionality perspective, sharing raw FHIR Immunization resources is... sufficient.  It streamlines a touchpoint where users would want a human readable format anyhow.  It gets the job done.  So, I'm sitting here with a proof-of-concept of a working screening app that could be used in any number of spaces in the real world.  And I've got this pragmatics question of 'what does the extra cryptography infrastructure really get me'?)</p>\n<p>Devil's advocate discussion aside, all of the above leads to my second item, which is I think we need a value set to define validation status/result.  Something that can trigger a badge or icon or something in the user interface after the QR code is scanned.  I'm thinking something along the lines of:</p>\n<div class=\"codehilite\"><pre><span></span><code>- No known immunization/vaccination\n- Vaccinated\n- Multiple vaccinations\n- Known prior COVID hospitalization\n- Known prior convalescent plasma transfusion\n- Known prior positive COVID test\n</code></pre></div>\n<p>Getting the validation status right is going to be both important, and possibly thorny.  I think if people were to do a survey of Immunization Systems, they'd find the majority of them are state/government sponsored, and are focused on receiving jabs in the arm, rather than modeling human physiology and whether a person has immunity to a disease.    And from a civil liberties perspective, the spec could reduce freedom of travel and prevent people from getting healthcare or jobs or seeing family if it's a binary vaccinated/not-vaccinated result.   </p>\n<p>The catch, however, is I'm not sure my proposed language covers non-COVID use-cases or is scalable for immunizations in general.  It's language needs some massaging; possibly from vocab and modeling facilitators.</p>\n<p>Third, for the spec to succeed, I think it needs to be able to hand out a temporary 3day pass after a negative PCR test, a 3mo+ pass after a blood transfusion or COVID hospitalization, and a 1yr pass after a vaccination.  Or whatever lengths of time research studies suggest.  But to have that expansive multi-modal approach, we have to also dig into lab results and Observation resource.  Happily, the Bundle approach is already set up to support that.  But we may want to think about a supplemental COVID addendum of some sort, with SNOMED/LOINC codes that qualify for or confer immunity.</p>",
        "id": 233959339,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618064867
    },
    {
        "content": "<blockquote>\n<p>I think there's going to be unsigned FHIR resources in the ecosystem. That's just going to be a pragmatic reality. </p>\n</blockquote>\n<p>For sure: there's lots of data out there in the world; most of it isn't FHIR but some is; among FHIR data most of it isn't signed. SMART Health Cards is specifically about sharing verifiable clinical data bound to an individual's identity.  We've left unsigned data out of scope here. That said, <em>anyone</em> can sign a Health Card, so you can always create signed data; it's up to a verifier to decide if they want to trust your signature.</p>",
        "id": 233974644,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618077701
    },
    {
        "content": "<blockquote>\n<p>I think we need a value set to define validation status/result. Something that can trigger a badge or icon or something in the user interface after the QR code is scanned.</p>\n</blockquote>\n<p>We have a couple of FAQs that address this:</p>\n<ul>\n<li><a href=\"https://smarthealth.cards/#how-can-we-share-conclusions-like-a-safe-to-fly-pass-instead-of-sharing-clinical-results\">https://smarthealth.cards/#how-can-we-share-conclusions-like-a-safe-to-fly-pass-instead-of-sharing-clinical-results</a></li>\n<li><a href=\"https://smarthealth.cards/#which-clinical-data-should-be-considered-in-decision-making\">https://smarthealth.cards/#which-clinical-data-should-be-considered-in-decision-making</a></li>\n</ul>\n<p>The short answer is that the SMART Health Cards spec isn't trying to frame policy, or describe how you act on data. It's focused on the verifiable clinical data. There are a number of efforts focused on \"Pass generation\" which might be a better fit for this discussion.</p>",
        "id": 233974788,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618077835
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191678\">@Abigail Watson</span>  I was able to get the FHIR resource after downloading a QR scanning app. My native camera app (Android v11 - Pixel 4) was not able to parse the code.</p>",
        "id": 233978480,
        "sender_full_name": "Michael Turman",
        "timestamp": 1618081165
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191315\">Josh Mandel</span> <a href=\"#narrow/stream/284830-CARIN-April.20'21.20Connectathon.20-.20SHC.20-.20.20Track/topic/SHC.20Pre-event.20Discussion/near/233974644\">said</a>:</p>\n<blockquote>\n<p>That said, <em>anyone</em> can sign a Health Card, so you can always create signed data; it's up to a verifier to decide if they want to trust your signature.</p>\n</blockquote>\n<p>This right here is important and would suffice for the discussion, as people are going to have questions about this.  I came to the same conclusion, that our app/business would probably need to act as a signing authority and notary of sorts.  Doable.  But worth spelling out, maybe giving some resources, and considerations of what that entails.</p>",
        "id": 233979414,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618081916
    },
    {
        "content": "<p><a href=\"https://confluence.hl7.org/x/SwVxBg\">https://confluence.hl7.org/x/SwVxBg</a> PHWG page for SHC VCI IG, FYI</p>",
        "id": 234083891,
        "sender_full_name": "Paul Denning",
        "timestamp": 1618182913
    },
    {
        "content": "<p><em>Public Health Workgroup page for \"SMART Health Cards: Vaccination Credential Implementation Guide\", for your information</em></p>\n<p>(de-acronymed, save for SMART. If you want to be pedantic: Substitutable Medical Applications, Reusable Technologies ;-)</p>",
        "id": 234086535,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618185675
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 234089494,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618188955
    },
    {
        "content": "<p>Second step... put the FHIR Immunization into a SMART Healthcard Bundle.  Still working on signing it, but I think the data shaping is done.</p>\n<p><a href=\"/user_uploads/10155/eaX24RTQZNE3GHONBarxkkeG/Symptomatic-VaccinePassport-SmartBundle-Influenza-NotSigned.png\">Symptomatic-VaccinePassport-SmartBundle-Influenza-NotSigned.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/eaX24RTQZNE3GHONBarxkkeG/Symptomatic-VaccinePassport-SmartBundle-Influenza-NotSigned.png\" title=\"Symptomatic-VaccinePassport-SmartBundle-Influenza-NotSigned.png\"><img src=\"/user_uploads/10155/eaX24RTQZNE3GHONBarxkkeG/Symptomatic-VaccinePassport-SmartBundle-Influenza-NotSigned.png\"></a></div>",
        "id": 234092167,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618191773
    },
    {
        "content": "<p>Okay, so I'm a little confused.  I managed to generate the public/private keys, created the <code>.well-known/jwks.json</code> file, created the JWT response with the <code>fhirBundle</code>, created a payload, signed it with the private key, and generated a token.  </p>\n<p>But what am I suppose to do with the token now?  I'm missing something....</p>",
        "id": 234107853,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618207684
    },
    {
        "content": "<p>Ehhh.... this doesn't seem right.</p>\n<p><a href=\"/user_uploads/10155/EdZ0oK4ZrHzLBx0MP-11G0Wo/Screen-Shot-2021-04-12-at-1.12.39-AM.png\">Screen-Shot-2021-04-12-at-1.12.39-AM.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/EdZ0oK4ZrHzLBx0MP-11G0Wo/Screen-Shot-2021-04-12-at-1.12.39-AM.png\" title=\"Screen-Shot-2021-04-12-at-1.12.39-AM.png\"><img src=\"/user_uploads/10155/EdZ0oK4ZrHzLBx0MP-11G0Wo/Screen-Shot-2021-04-12-at-1.12.39-AM.png\"></a></div>",
        "id": 234108180,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618207982
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191678\">@Abigail Watson</span> have you looked into the numeric encoding of the bundle yet? <a href=\"https://smarthealth.cards/#every-health-card-can-be-embedded-in-a-qr-code\">https://smarthealth.cards/#every-health-card-can-be-embedded-in-a-qr-code</a></p>",
        "id": 234158072,
        "sender_full_name": "Steve Hall",
        "timestamp": 1618234383
    },
    {
        "content": "<p>Honestly, trying to avoid it if possible, as the component APIs that I tend to work with are much higher level.  The SMART spec is sort of lost in the weeds of technical implementation, compared to where the open-source Javascript community APIs are at.  <br>\n<a href=\"https://www.npmjs.com/package/qrcode.react\">https://www.npmjs.com/package/qrcode.react</a></p>",
        "id": 234159925,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618235003
    },
    {
        "content": "<p>Once you have a JWS there are a few things you can do:</p>\n<ul>\n<li>For debugging, feed the JWS directly into the validator sdk, which accepts inputs of this type in a plain text file</li>\n<li>For printing or displaying a QR, encode the JWS following guidance that Steve links to above</li>\n<li>For file-based sharing, package the JWS (and optionally additional Health Card JWSs) in a <code>.smart-healtg-card</code> JSON file (for example, to make this available for a patient to download into a wallet of their choice)</li>\n</ul>",
        "id": 234160035,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618235037
    },
    {
        "content": "<p>Our specification is describing the low level details to ensure interoperability, and specific libraries are going to offer higher level wrappers around this functionality. You will need to understand enough of the underlying details in order to use your libraries correctly. If you want guidance for using that specific JavaScript library, you are in luck because it is the same one we use in our own example generator :-)</p>",
        "id": 234160362,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618235121
    },
    {
        "content": "<p>Mmmm... right now the focus is getting QR code’s working.  Seems like there’s a lack of context in the QR workflow, where users might not even know which app they’re communicating with.  Seems like the issuer’s <code>iss</code> field should be passed around with the signed token, so they know how to look up the .well-known/jswk.json file, no?</p>",
        "id": 234160580,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618235184
    },
    {
        "content": "<p><a href=\"https://smarthealth.cards/#what-testing-tools-are-available-to-validate-smart-health-cards-implementations\">https://smarthealth.cards/#what-testing-tools-are-available-to-validate-smart-health-cards-implementations</a> includes links to our example code and also to a Jupiter notebook showing how this library can be used. The <a href=\"https://github.com/dvci/health-cards-walkthrough/blob/main/SMART%20Health%20Cards.ipynb\">notebook</a> is probably a good starting point.</p>",
        "id": 234160675,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618235219
    },
    {
        "content": "<p>I’ll publish the signing workflow in just a bit and provide a workflow audit.  Have a couple of early morning meetings, should have it by lunchtime.</p>",
        "id": 234160922,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618235289
    },
    {
        "content": "<p>The relevant context for applications processing these QR values is in the prefix -- this <code>shc:/</code> URI scheme (together with index values  like <code>shc:/1/2/</code> for a JWS that's too large for a single QR) tells you how to route these things to the appropriate app</p>",
        "id": 234160958,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618235299
    },
    {
        "content": "<p>Okay, have the SMART Health Cards Validation SDK running.  <span aria-label=\"sunglasses\" class=\"emoji emoji-1f60e\" role=\"img\" title=\"sunglasses\">:sunglasses:</span></p>",
        "id": 234183398,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618242605
    },
    {
        "content": "<p>Okay, just to confirm (because the documentation is pretty technical), I go to <a href=\"https://mkjwk.org/\">https://mkjwk.org/</a> and generate the keys like so:</p>\n<p><a href=\"/user_uploads/10155/wx6WcTzGeAqQlYXbYUJFBA-7/Screen-Shot-2021-04-12-at-1.01.09-PM.png\">Screen-Shot-2021-04-12-at-1.01.09-PM.png</a> </p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/wx6WcTzGeAqQlYXbYUJFBA-7/Screen-Shot-2021-04-12-at-1.01.09-PM.png\" title=\"Screen-Shot-2021-04-12-at-1.01.09-PM.png\"><img src=\"/user_uploads/10155/wx6WcTzGeAqQlYXbYUJFBA-7/Screen-Shot-2021-04-12-at-1.01.09-PM.png\"></a></div><p>And I want the center-right \"Public and Private Keypair Set\" to be hosted publicly on <code>{$baseUrl}/.well-known/jwsk.json</code>, and the Private Key (X.509 PEM Format) held privately on the server for when we do the signing and token generation.</p>",
        "id": 234203787,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618250669
    },
    {
        "content": "<p>(I'm going to walk through this publicly, and re-generate keys later.)</p>",
        "id": 234203852,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618250703
    },
    {
        "content": "<p>The <code>d</code> portion is the private key, ah.  Got it, so it gets removed in the <code>.well-known/jwsk.json</code></p>",
        "id": 234204128,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618250810
    },
    {
        "content": "<p>I haven't used this tool before and don't know that I'd recommend it as a best practice vs using a <a href=\"https://github.com/smart-on-fhir/health-cards-tests/blob/master/src/setup/create-keys.ts\">dedicated script like this one</a> -- but that said, it looks like you've chosen the right key setup options.</p>\n<ul>\n<li>Obviously you'd only host the <em>public key</em> (center-<em>right</em> box, not center-<em>top</em>) at <code>/.well-known/jwks.json</code> (I'm sure that was a typo on your part and now I see you corrected it in your follow-up, but have to call it out ;-))</li>\n<li>Re: private key, yes you'd keep it on your server. Up to you if you'd want to save it in PEM format vs just keeping it in a JWKS</li>\n</ul>",
        "id": 234204783,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618251055
    },
    {
        "content": "<p>Okay, I think I may have figured it out.  Elliptic cryptography is elliptic, with multiple keys.  So the JWT token can be decoded (not verified) without the signing pair's public key.  I think.  </p>\n<p>Can anybody verify that the following works for them?  I'm working on getting validator tool results next.  </p>\n<p><a href=\"/user_uploads/10155/QuTzcpg7tQctl4x3NBORtP4b/Symptomatic-VaccinePassport-SmartBundle-Coronavirus-Signed.png\">Symptomatic-VaccinePassport-SmartBundle-Coronavirus-Signed.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/QuTzcpg7tQctl4x3NBORtP4b/Symptomatic-VaccinePassport-SmartBundle-Coronavirus-Signed.png\" title=\"Symptomatic-VaccinePassport-SmartBundle-Coronavirus-Signed.png\"><img src=\"/user_uploads/10155/QuTzcpg7tQctl4x3NBORtP4b/Symptomatic-VaccinePassport-SmartBundle-Coronavirus-Signed.png\"></a></div>",
        "id": 234327272,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618321486
    },
    {
        "content": "<p>This is true of all JWSs, irrespective of the signature algorithm: you can read the data payload without a key; you only need a key when you want to verify the signature over the payload.</p>",
        "id": 234328245,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618321806
    },
    {
        "content": "<p>At a glance, the QR in your screenshot is too dense; the specification says that any JWS that's too long to fit in a V22 symbol (roughly: JWS longer than 1200 characters) needs to be split up across multiple QRs. But basic vaccination records with data minimization practices in place aren't generally that big...</p>",
        "id": 234328508,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618321907
    },
    {
        "content": "<p>Are there existing patients in the open reference server that we can use for basic testing, or do we need to register for the Patient Access server?</p>",
        "id": 234334716,
        "sender_full_name": "Matt Printz",
        "timestamp": 1618324002
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"404889\">@Matt Printz</span> If you are referring to the Cerner reference server, the health card is mocked (hard coded) to return the same patient regardless of patientId passed in the request. Once we move beyond our reference implementation, I would expect our sandbox server to have more robust patient scenarios.</p>",
        "id": 234339177,
        "sender_full_name": "Michael Turman",
        "timestamp": 1618325398
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"353749\">@Michael Turman</span> I was, and got it.  Sounds good. Thanks!</p>",
        "id": 234339389,
        "sender_full_name": "Matt Printz",
        "timestamp": 1618325466
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191678\">@Abigail Watson</span> The payload of the QR code requires the 'shc:/' prefix, and as <span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> mentioned, your data is too large for the QR format (this QR has 1,972 characters). The other thing you'll want to look into is the numeric encoding of the data in order to meet the SMART HealthCard implementation guidelines.</p>",
        "id": 234353386,
        "sender_full_name": "Steve Hall",
        "timestamp": 1618329552
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191678\">Abigail Watson</span> <a href=\"#narrow/stream/284830-CARIN-April.20'21.20Connectathon.20-.20SHC.20-.20.20Track/topic/SHC.20Pre-event.20Discussion/near/234327272\">said</a>:</p>\n<blockquote>\n<p>Can anybody verify that the following works for them?  I'm working on getting validator tool results next.  </p>\n</blockquote>\n<p>Manually scanning that QR I see the contents are:</p>\n<div class=\"codehilite\"><pre><span></span><code>eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJodHRwczovL3ZhY2NpbmUtcGFzc3BvcnQuc3ltcHRvbWF0aWMuaW8iLCJuYmYiOjEwLCJ2YyI6eyJAY29udGV4dCI6WyJodHRwczovL3d3dy53My5vcmcvMjAxOC9jcmVkZW50aWFscy92MSJdLCJ0eXBlIjpbIlZlcmlmaWFibGVDcmVkZW50aWFsIiwiaHR0cHM6Ly9zbWFydGhlYWx0aC5jYXJkcyNoZWFsdGgtY2FyZCJdLCJjcmVkZW50aWFsU3ViamVjdCI6eyJmaGlyVmVyc2lvbiI6IjQuMC4xIiwiZmhpckJ1bmRsZSI6eyJyZXNvdXJjZVR5cGUiOiJCdW5kbGUiLCJ0eXBlIjoiY29sbGVjdGlvbiIsImVudHJ5IjpbeyJmdWxsVXJsIjoiSW1tdW5pemF0aW9uL2Nvcm9udmlydXMiLCJyZXNvdXJjZSI6eyJzdGF0dXMiOiJjb21wbGV0ZWQiLCJ3YXNOb3RHaXZlbiI6ZmFsc2UsInBhdGllbnQiOnsiZGlzcGxheSI6IkNhbmRhY2UgU2FsaW5hcyIsInJlZmVyZW5jZSI6IlBhdGllbnQvMTAwIn0sImlkIjoiaW1tdW5pemF0aW9uLW1tciIsImVuY291bnRlciI6eyJyZWZlcmVuY2UiOiJFbmNvdW50ZXIvMTI5ODM3NjQ1In0sImRhdGUiOiIyMDIxLTAzLTA1IiwicmVxdWVzdGVyIjp7ImRpc3BsYXkiOiJBbHRpY2sgS2VsbHkiLCJyZWZlcmVuY2UiOiJQcmFjdGl0aW9uZXIvOCJ9LCJyZXBvcnRlZCI6ZmFsc2UsInZhY2NpbmVDb2RlIjp7InRleHQiOiJTQVJTLUNPVi0yIChDT1ZJRC0xOSkgdmFjY2luZSwgbVJOQSwgc3Bpa2UgcHJvdGVpbiwgTE5QLCBwcmVzZXJ2YXRpdmUgZnJlZSwgMzAgbWNnLzAuM21MIGRvc2UiLCJjb2RpbmciOlt7InN5c3RlbSI6IkNWWCIsImNvZGUiOiIyMDgifV19LCJyZXNvdXJjZVR5cGUiOiJJbW11bml6YXRpb24iLCJfaWQiOiJUd3c5a20yWVo0bURTbmVCVyIsIl9kb2N1bWVudCI6eyJzdGF0dXMiOiJjb21wbGV0ZWQiLCJ3YXNOb3RHaXZlbiI6ZmFsc2UsInBhdGllbnQiOnsiZGlzcGxheSI6IkNhbmRhY2UgU2FsaW5hcyIsInJlZmVyZW5jZSI6IlBhdGllbnQvMTAwIn0sImlkIjoiaW1tdW5pemF0aW9uLW1tciIsImVuY291bnRlciI6eyJyZWZlcmVuY2UiOiJFbmNvdW50ZXIvMTI5ODM3NjQ1In0sImRhdGUiOiIyMDIxLTAzLTA1IiwicmVxdWVzdGVyIjp7ImRpc3BsYXkiOiJBbHRpY2sgS2VsbHkiLCJyZWZlcmVuY2UiOiJQcmFjdGl0aW9uZXIvOCJ9LCJyZXBvcnRlZCI6ZmFsc2UsInZhY2NpbmVDb2RlIjp7InRleHQiOiJTQVJTLUNPVi0yIChDT1ZJRC0xOSkgdmFjY2luZSwgbVJOQSwgc3Bpa2UgcHJvdGVpbiwgTE5QLCBwcmVzZXJ2YXRpdmUgZnJlZSwgMzAgbWNnLzAuM21MIGRvc2UiLCJjb2RpbmciOlt7InN5c3RlbSI6IkNWWCIsImNvZGUiOiIyMDgifV19LCJyZXNvdXJjZVR5cGUiOiJJbW11bml6YXRpb24iLCJfaWQiOiJUd3c5a20yWVo0bURTbmVCVyJ9fX1dfX19LCJpYXQiOjE2MTgyOTAxODl9.xxNfq0CTDji5icgGE9dhuY4_LVRJcwIb4hWvdkvewiJqicj2N39DiVpBiIaR_ClEYJJ77BRxADMOSWopsF0U7A\n</code></pre></div>\n\n<p>There are a few items to address here:</p>\n<ul>\n<li>\n<p>This needs to be encoded according to the rules at <a href=\"https://smarthealth.cards/#creating-a-qr-code-or-a-set-of-qr-codes-from-a-health-card-jws\">https://smarthealth.cards/#creating-a-qr-code-or-a-set-of-qr-codes-from-a-health-card-jws</a> rather than represented as a \"raw\" JWS. So the QR contents should look like <a href=\"https://smarthealth.cards/examples/example-00-f-qr-code-numeric-value-0.txt\">https://smarthealth.cards/examples/example-00-f-qr-code-numeric-value-0.txt</a> rather than like <a href=\"https://smarthealth.cards/examples/example-00-d-jws.txt\">https://smarthealth.cards/examples/example-00-d-jws.txt</a> (see <a href=\"https://smarthealth.cards/examples/\">https://smarthealth.cards/examples/</a> for context)</p>\n</li>\n<li>\n<p><code>nbf</code> claim should be an epoch time in seconds, not <code>10</code> (the value you have for <code>iat</code> can be re-used, or better yet you can just rename <code>iat</code> so you only have <code>nbf</code>)</p>\n</li>\n<li><code>type</code> array should include relevant subtypes from <a href=\"https://smarthealth.cards/vocabulary/\">https://smarthealth.cards/vocabulary/</a> (<code>#covid19</code> and <code>#immunization</code>)</li>\n<li>Bundle.entry.fullUrls (and Reference.values) should follow the guidance at <a href=\"https://smarthealth.cards/#health-cards-are-small\">https://smarthealth.cards/#health-cards-are-small</a> (e.g., <code>resource:0</code> instead of <code>Immunization/coronvirus</code>).</li>\n<li>Data profiles should match the DM (data minimization) guidance from <a href=\"http://build.fhir.org/ig/dvci/vaccine-credential-ig/branches/main/\">http://build.fhir.org/ig/dvci/vaccine-credential-ig/branches/main/</a> (e.g., remove _id, _document, wasNotGiven, patient.display, encounter, requester, reporter, vaccineCode.text; use a correct CVX system URL; </li>\n<li>Looks like there are two copies of the same Immunization, one of which has properties in <code>_document</code>, which isn't a valid FHIR JSON resource</li>\n<li>You need a Patient resource (linked from Immunization) to convey name and DOB</li>\n</ul>",
        "id": 234354908,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618330066
    },
    {
        "content": "<p>Yeah, I've been tooling around with zlib's inflate/deflate this morning, removed the internal <code>_document</code> field, and have it down to around ~1068 characters now. And I think I've figured out how to put in the <code>shc</code>prefix in.</p>",
        "id": 234355422,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618330236
    },
    {
        "content": "<p>Although if I'm having these questions, other people are going to have them also.   I get the desire to compress and optimize and all, but it all begs the questions 'why not just use a larger QR code?' and 'what are we gaining from all this extra engineering?'.</p>",
        "id": 234356089,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618330491
    },
    {
        "content": "<p>Scanning large QR codes requires higher quality cameras and a steady hand; if anything, I'm worried that V22 codes already a bit too high for  practical in real-world use, but we're basing the current recommendations on our initial round of testing. This is a place where the UX will fall down if it's not easy to scan codes, and it's worth doing some extra work to support this.</p>",
        "id": 234357091,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618330838
    },
    {
        "content": "<p>(That said, it's a big spectrum, and our design choices are still weighted heavily towards \"make it easy for developers by re-using FHIR structures\"; alternatives define custom schemas for this purpose, or use techniques like CBOR-LD or Protobuf encoding, which come with their own stack of dependencies.)</p>",
        "id": 234357313,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618330921
    },
    {
        "content": "<p>(e.g., <a href=\"https://github.com/Path-Check/paper-cred\">https://github.com/Path-Check/paper-cred</a> uses a set of custom data models and a set of narrow-purpose QR codes; it represents a very different point in the design space.)</p>",
        "id": 234357541,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618331003
    },
    {
        "content": "<p>I'd maybe add language to that effect at the beginning of the spec.  </p>\n<p>Where the current recommendations have landed seems a bit arbitrary.  On the one hand, equity to access and running on lower model phones is great.  On the other hand, any sort of screening activity has already implicitly conceded a certain amount of inequality... be it circumstantial, economic, or otherwise.    So, I get all the reasoning that led to where it currently is; but I got to wonder about premature optimization and all that, and whether those assumptions all hold for implementors looking at the spec.  </p>\n<p>Ex:  Removing reference <code>display</code> fields, but requiring the Patient resource for example.  Okay, fine.  Seems a bit overengineered.  The display field was originally intended for compactness so the resource references wouldn't need to be resolved for a single display field.   And why the need for the birthdate in the QR code?  </p>\n<p>I suppose I came into the connectathon hoping to be able to stamp/encode non-Bundle resource singletons.   Just the FHIR Immunization record, as it were.  Not the end of the world, but different than what I was expecting.</p>",
        "id": 234360312,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618332004
    },
    {
        "content": "<blockquote>\n<p>The display field was originally intended for compactness so the resource references wouldn't need to be resolved for a single display field</p>\n</blockquote>\n<p>This flows from requirements though: name alone doesn't provide enough context for identity binding, and you can't cram a birthdate into a display :-)</p>",
        "id": 234363077,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618333055
    },
    {
        "content": "<blockquote>\n<p>I suppose I came into the connectathon hoping to be able to stamp/encode non-Bundle resource singletons. Just the FHIR Immunization record, as it were. Not the end of the world, but different than what I was expecting.</p>\n</blockquote>\n<p>Yeah, that's fair!</p>",
        "id": 234363169,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618333084
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191315\">Josh Mandel</span> <a href=\"#narrow/stream/284830-CARIN-April.20'21.20Connectathon.20-.20SHC.20-.20.20Track/topic/SHC.20Pre-event.20Discussion/near/234363077\">said</a>:</p>\n<blockquote>\n<p>This flows from requirements though: name alone doesn't provide enough context for identity binding, and you can't cram a birthdate into a display :-)</p>\n</blockquote>\n<p>Putting on my Patient Empowerment Co-Chair hat for a moment - who exactly defined the requirements?  Microsoft|Harvard|HL7 Public Health?  And were patient advocates participating?  </p>\n<p>The identity binding requirement seems like it would certainly be needed if we were only discussing state/government sanctioned Immunization Registries and international borders.  But was any consideration given to the travel ecosystem?  Event planning coordination?  Campus security?    Right to association?  </p>\n<p>I don't need to show ID or proof of age to submit receipts.  When I park my car in a garage and am issued a parking claim, my right to travel is temporarily encumbered by my obligation to show receipt and proof of payment before I'm allowed to remove my vehicle and begin traveling again.  It's a common form of travel restriction used in parking garages across the country, and no ID proofing is required.</p>\n<p>Who decided that identity proofing is a requirement for the SMART HealthCard, and not an optional addition/upgrade?    <br>\n:takes hat off:</p>",
        "id": 234368207,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618334915
    },
    {
        "content": "<p>The requirement for <em>offering identity binding</em> is core to the concept of verifiable data here; records need to represent data <em>about someone</em>. More formally, the details about what level of identity binding, and what's optional vs required vs prohibited... those decisions don't live in the SMART Health Cards Framework IG, but rather in use case-specific profiles, the first of which is <a href=\"http://build.fhir.org/ig/dvci/vaccine-credential-ig/branches/main/\">http://build.fhir.org/ig/dvci/vaccine-credential-ig/branches/main/</a> ; this is just beginning to move through the HL7 process, sponsored by the Public Health Workgroup, and I'd certainly suggest that the Patient Empowerment WG might want to register as an interested party.</p>",
        "id": 234371771,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618336291
    },
    {
        "content": "<p>(Structurally though, knowing that use-case-specific profiles will set these kinds of rules is what tells us we need to support referencing a Patient in the core framework. I don't mean to over-emphasize the specific rules, but rather just to highlight the requirements that emerge <em>simply by</em> factoring the rules into use-case-specific profiles.)</p>",
        "id": 234372066,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618336410
    },
    {
        "content": "<p>Okay, I'm making some progress here, but want to verify that I have the algorithm correct.  Am I missing a base64 conversion in there?  </p>\n<div class=\"codehilite\"><pre><span></span><code>// step 0 - build our verifiable credential with bundle\nVerifiableCredential{Bundle{Immunization}}\n\n// step 1 - delete unnecessary fields\ndelete_fields()\n\n//step 2 - stringify\nstringify()\n\n// step 3 - trim\ntrim()\n\n// step 4 - deflate\ndeflate()\n\nstep 5 - sign\nsign()\n\nstep 6 - convert to numeric mode\nnumeric(signature)\n\nstep 7 - write to QR component\n&quot;shc:/&quot; + numeric_signature\n</code></pre></div>",
        "id": 234391398,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618344114
    },
    {
        "content": "<p>Here is my preview.  I'll be working on the BlueButton CARIN activity too.  <a href=\"/user_uploads/10155/-eWTmtY-6KencabscMz8xiXD/Screen-Shot-2021-04-13-at-4.06.39-PM.png\">Screen-Shot-2021-04-13-at-4.06.39-PM.png</a> ads well but wanted to throw this out as test implementation.</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/-eWTmtY-6KencabscMz8xiXD/Screen-Shot-2021-04-13-at-4.06.39-PM.png\" title=\"Screen-Shot-2021-04-13-at-4.06.39-PM.png\"><img src=\"/user_uploads/10155/-eWTmtY-6KencabscMz8xiXD/Screen-Shot-2021-04-13-at-4.06.39-PM.png\"></a></div>",
        "id": 234393066,
        "sender_full_name": "Alan Viars",
        "timestamp": 1618344819
    },
    {
        "content": "<p>This looks right! It'd be good to add some pseudo-code to highlight inputs to each step, just to be sure -- so take this as a friendly amendment :)</p>\n<div class=\"codehilite\"><pre><span></span><code>// step 0 - build our verifiable credential with bundle\nlet fhirData = VerifiableCredential{Bundle{Immunization}}\n\n// step 1 - delete unnecessary fields\nlet fhirDataMinimized = delete_fields()\n\n// step 2\nlet vcPayloadJson = insert_fhir_data_into_vc_scaffold(fhirDataMinimized)\n\n// step 3\nlet vcPayloadString = trim(stringify(vcPayloadJson))\n\n// step 4 - deflate\nlet vcPayload = deflate(vcPayloadString)\n\n// step 5 - sign -- note that this step will result in a JWS where the header and payload are both b64urlencoded\nlet jws = jwsSign(vcPayload)\n\n// step 6 - convert to numeric mode\nlet qrJwsContents =  numeric(jws)\n\n// step 7 - create QR Symbol\nlet qrSymbol = generateQrFromSegments([{\n  mode: bytes,\n  value: `shc:/`\n}, {\n  mode: numeric,\n  value: qrJwsContents\n}])\n</code></pre></div>\n<p>.... though <a href=\"https://github.com/dvci/health-cards-walkthrough/blob/main/SMART%20Health%20Cards.ipynb\">https://github.com/dvci/health-cards-walkthrough/blob/main/SMART%20Health%20Cards.ipynb</a> provides a better overview IMO!</p>",
        "id": 234393537,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618345032
    },
    {
        "content": "<p>At this early stage I'll still need to create your SHC manually in the admin.  A user account will be needed.  I am creating an Org called CARIN Connect-a-thon for this purpose.  Create a member account there and I'll approve your account and then create your SHC.  This is still a work in progress.  The URL for the account creation is here: <a href=\"https://id.verifymyidentity.com/accounts/create-member-account/CARIN-Connect-A-thon/\">https://id.verifymyidentity.com/accounts/create-member-account/CARIN-Connect-A-thon/</a></p>",
        "id": 234393619,
        "sender_full_name": "Alan Viars",
        "timestamp": 1618345080
    },
    {
        "content": "<blockquote>\n<p>Here is my preview. I'll be working on the BlueButton CARIN activity too. Screen-Shot-2021-04-13-at-4.06.39-PM.png ads well but wanted to throw this out as test implementation.</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"391350\">@Alan Viars</span> it looks like you called stringify one too many times! Your inflated b64urldecoded payload is a stringified stringified JSON object rather than a stringified JSON object :)</p>",
        "id": 234394174,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618345310
    },
    {
        "content": "<p>I submitted <a href=\"https://github.com/microsoft/health-cards-validation-SDK/issues/50\">https://github.com/microsoft/health-cards-validation-SDK/issues/50</a> to capture this. (FYI <span class=\"user-mention\" data-user-id=\"385047\">@Christian Paquin</span>)</p>",
        "id": 234394585,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618345483
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191315\">Josh Mandel</span> <a href=\"#narrow/stream/284830-CARIN-April.20'21.20Connectathon.20-.20SHC.20-.20.20Track/topic/SHC.20Pre-event.20Discussion/near/234394174\">said</a>:</p>\n<blockquote>\n<blockquote>\n<p>Here is my preview. I'll be working on the BlueButton CARIN activity too. Screen-Shot-2021-04-13-at-4.06.39-PM.png ads well but wanted to throw this out as test implementation.</p>\n</blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"391350\">Alan Viars</span> it looks like you called stringify one too many times! Your inflated b64urldecoded payload is a stringified stringified JSON object rather than a stringified JSON object :)</p>\n</blockquote>\n<p>Oh thanks for spotting that.  I hadn't yet fully verified it.  Will try to fix today.  Trying to rush to get it ready for tomorrow.  Actually I was pretty confused at that one point.  I din't try to stringify it 2x...</p>",
        "id": 234398396,
        "sender_full_name": "Alan Viars",
        "timestamp": 1618347068
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191315\">Josh Mandel</span> <a href=\"#narrow/stream/284830-CARIN-April.20'21.20Connectathon.20-.20SHC.20-.20.20Track/topic/SHC.20Pre-event.20Discussion/near/234371771\">said</a>:</p>\n<blockquote>\n<p>...and I'd certainly suggest that the Patient Empowerment WG might want to register as an interested party.</p>\n</blockquote>\n<p><a href=\"https://confluence.hl7.org/pages/viewpage.action?pageId=108070762\">PEWG is a co-sponsor </a></p>",
        "id": 234400578,
        "sender_full_name": "Paul Denning",
        "timestamp": 1618347779
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"391350\">Alan Viars</span> <a href=\"#narrow/stream/284830-CARIN-April.20'21.20Connectathon.20-.20SHC.20-.20.20Track/topic/SHC.20Pre-event.20Discussion/near/234398396\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"191315\">Josh Mandel</span> <a href=\"#narrow/stream/284830-CARIN-April.20'21.20Connectathon.20-.20SHC.20-.20.20Track/topic/SHC.20Pre-event.20Discussion/near/234394174\">said</a>:</p>\n<blockquote>\n<blockquote>\n<p>Here is my preview. I'll be working on the BlueButton CARIN activity too. Screen-Shot-2021-04-13-at-4.06.39-PM.png ads well but wanted to throw this out as test implementation.</p>\n</blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"391350\">Alan Viars</span> it looks like you called stringify one too many times! Your inflated b64urldecoded payload is a stringified stringified JSON object rather than a stringified JSON object :)</p>\n</blockquote>\n<p>Oh thanks for spotting that.  I hadn't yet fully verified it.  Will try to fix today.  Trying to rush to get it ready for tomorrow.  Actually I was pretty confused at that one point.  I din't try to stringify it 2x...</p>\n</blockquote>\n<p>Does this fix it <span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> ? <a href=\"/user_uploads/10155/zIKDyMJtv1npqu1O3Eaz6QpK/shc-1-194642695512372_H0SM4Dg.png\">shc-1-194642695512372_H0SM4Dg.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/zIKDyMJtv1npqu1O3Eaz6QpK/shc-1-194642695512372_H0SM4Dg.png\" title=\"shc-1-194642695512372_H0SM4Dg.png\"><img src=\"/user_uploads/10155/zIKDyMJtv1npqu1O3Eaz6QpK/shc-1-194642695512372_H0SM4Dg.png\"></a></div><p>...maybe i can just build a validator directly into my implementation....only so much i can do in 2 days :-)</p>",
        "id": 234400805,
        "sender_full_name": "Alan Viars",
        "timestamp": 1618347834
    },
    {
        "content": "<p>Well, I seem to have gotten numeric mode working using zlib's <code>deflateRaw</code> function, and have also gotten some of the correct headers on the jwt.  </p>\n<p><a href=\"/user_uploads/10155/tiG20Mkzs0_pUqQGlm6quuqL/Screen-Shot-2021-04-13-at-4.23.22-PM.png\">Screen-Shot-2021-04-13-at-4.23.22-PM.png</a> </p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/tiG20Mkzs0_pUqQGlm6quuqL/Screen-Shot-2021-04-13-at-4.23.22-PM.png\" title=\"Screen-Shot-2021-04-13-at-4.23.22-PM.png\"><img src=\"/user_uploads/10155/tiG20Mkzs0_pUqQGlm6quuqL/Screen-Shot-2021-04-13-at-4.23.22-PM.png\"></a></div><p>But when I try to inflating the payload, I'm running into a <code>invalid block type</code> error.  Can anybody else replicate the invalid block type error?  </p>\n<p>The documention for 'zlib.deflateRaw()' recommends using  <code>result.toString('base64')</code> in the callback, which could be the source of invalid block types.  Is that suppose to be a buffer or a string that's in the payload after deflating?</p>\n<p>meh, buffer doesn't seem to do it either.  Why would there be a block type error</p>",
        "id": 234405155,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618349370
    },
    {
        "content": "<p>Anyone around able to validate my QR code?<br>\n<a href=\"/user_uploads/10155/Ui4mTQt5jLRF4S5WIhSNN7IK/qr.png\">qr.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/Ui4mTQt5jLRF4S5WIhSNN7IK/qr.png\" title=\"qr.png\"><img src=\"/user_uploads/10155/Ui4mTQt5jLRF4S5WIhSNN7IK/qr.png\"></a></div>",
        "id": 234406781,
        "sender_full_name": "Matt Printz",
        "timestamp": 1618350111
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"404889\">Matt Printz</span> <a href=\"#narrow/stream/284830-CARIN-April.20'21.20Connectathon.20-.20SHC.20-.20.20Track/topic/SHC.20Pre-event.20Discussion/near/234406781\">said</a>:</p>\n<blockquote>\n<p>Anyone around able to validate my QR code?</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"404889\">@Matt Printz</span>  It looks like your numeric encoding (or the JWS you encoded) has some issues:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$ node . -l debug   -t qrnumeric -p ./matt\nSMART Health Card Validation SDK v0.4sh\nQR numeric\n     <span class=\"p\">|</span>\n     ├─ Debug :\n     <span class=\"p\">|</span>    shc:/... <span class=\"o\">=</span> eyJhbGciOiJFUzIXQ//eyxWCIkRFRiIsImtpZCIP::vQexwY3Mdo&lt;cFCelYSYLVdKdO<span class=\"p\">;</span>ckxBWnQN:vdFdvNEcaeG2vjm9PVDHWXbrjLj9w<span class=\"sb\">`</span><span class=\"p\">;</span><span class=\"se\">\\[</span>ZWH4lwIHpQZbXsUCWPJKcNHT8jGOktJDyYEjHl0evvfPF<span class=\"sb\">`</span><span class=\"nv\">EbGt1</span><span class=\"o\">=</span>AhNHXadr<span class=\"se\">\\p</span><span class=\"m\">1</span>&lt;BJPu&lt;N2ME4AyxeFMCCeXxcO<span class=\"p\">;</span>duuva0<span class=\"o\">=</span>44qbkTZxBmXHRlVfVqmURMQHavm@tiXeZFxHaSYZ43No<span class=\"se\">\\W</span>XP~FxoeFzLDf<span class=\"o\">=</span><span class=\"se\">\\M\\H</span>FaZ7xKpUOWjBBCelwFyEQuHEajjKzjVKdFoaRdXPEfk2/F<span class=\"p\">|</span>EDnQ2HLJ0Fz0Meb:j1fLXw<span class=\"se\">\\Z</span>F3<span class=\"o\">[</span>mRknDjUH<span class=\"o\">[</span>U_MDZCB_FB3~CwEaeDZGE9voY<span class=\"p\">;</span>WOXzfOzkJdz3epubGmsxBAxHOAOaBcad0WAcjDOOfDC8SfUSrbbW1<span class=\"se\">\\k</span>YlAa2e<span class=\"p\">;</span>txsrfpyNHerdmAoomwee3PYHYdDkjDYbhTm8FuYUbrMypuwFV3XYQvuV-sXfuWDWl<span class=\"se\">\\c</span><span class=\"o\">[</span><span class=\"se\">\\S</span>geRgM@JlboGyOWldP/xCf&lt;f<span class=\"o\">[</span>Fj:bf/&gt;ZlZ8pFRjGvpQOPNyDPNEfmFL-eIjacgFjkdODCk7XmOCLJSTmIrNnG&lt;OQghXSahs0DCMQ.&gt;inIsjuAwYqokAhgm0pY7W0QC<span class=\"se\">\\_</span>tWVFDD4D0zKvpLdPl_GBb<span class=\"sb\">`</span>&gt;do&gt;n321enx0b<span class=\"sb\">`</span>9jOtHp3nM<span class=\"p\">;</span>O<span class=\"o\">[</span>npF6abX3vGj2Qnl3<span class=\"sb\">`</span>0fpvbmkgIknDYDDREG&gt;N0t/<span class=\"o\">[</span>xV8Tuwbpps9MDBSQ9dR9sIw\n     <span class=\"p\">|</span>    <span class=\"nv\">JWS</span> <span class=\"o\">=</span> eyJhbGciOiJFUzIXQ//eyxWCIkRFRiIsImtpZCIP::vQexwY3Mdo&lt;cFCelYSYLVdKdO<span class=\"p\">;</span>ckxBWnQN:vdFdvNEcaeG2vjm9PVDHWXbrjLj9w<span class=\"sb\">`</span><span class=\"p\">;</span><span class=\"se\">\\[</span>ZWH4lwIHpQZbXsUCWPJKcNHT8jGOktJDyYEjHl0evvfPF<span class=\"sb\">`</span><span class=\"nv\">EbGt1</span><span class=\"o\">=</span>AhNHXadr<span class=\"se\">\\p</span><span class=\"m\">1</span>&lt;BJPu&lt;N2ME4AyxeFMCCeXxcO<span class=\"p\">;</span>duuva0<span class=\"o\">=</span>44qbkTZxBmXHRlVfVqmURMQHavm@tiXeZFxHaSYZ43No<span class=\"se\">\\W</span>XP~FxoeFzLDf<span class=\"o\">=</span><span class=\"se\">\\M\\H</span>FaZ7xKpUOWjBBCelwFyEQuHEajjKzjVKdFoaRdXPEfk2/F<span class=\"p\">|</span>EDnQ2HLJ0Fz0Meb:j1fLXw<span class=\"se\">\\Z</span>F3<span class=\"o\">[</span>mRknDjUH<span class=\"o\">[</span>U_MDZCB_FB3~CwEaeDZGE9voY<span class=\"p\">;</span>WOXzfOzkJdz3epubGmsxBAxHOAOaBcad0WAcjDOOfDC8SfUSrbbW1<span class=\"se\">\\k</span>YlAa2e<span class=\"p\">;</span>txsrfpyNHerdmAoomwee3PYHYdDkjDYbhTm8FuYUbrMypuwFV3XYQvuV-sXfuWDWl<span class=\"se\">\\c</span><span class=\"o\">[</span><span class=\"se\">\\S</span>geRgM@JlboGyOWldP/xCf&lt;f<span class=\"o\">[</span>Fj:bf/&gt;ZlZ8pFRjGvpQOPNyDPNEfmFL-eIjacgFjkdODCk7XmOCLJSTmIrNnG&lt;OQghXSahs0DCMQ.&gt;inIsjuAwYqokAhgm0pY7W0QC<span class=\"se\">\\_</span>tWVFDD4D0zKvpLdPl_GBb<span class=\"sb\">`</span>&gt;do&gt;n321enx0b<span class=\"sb\">`</span>9jOtHp3nM<span class=\"p\">;</span>O<span class=\"o\">[</span>npF6abX3vGj2Qnl3<span class=\"sb\">`</span>0fpvbmkgIknDYDDREG&gt;N0t/<span class=\"o\">[</span>xV8Tuwbpps9MDBSQ9dR9sIw\n     <span class=\"p\">|</span>\n     ├─ Info :\n     <span class=\"p\">|</span>    shc:/... decoded\n     <span class=\"p\">|</span>\n     ├─ Warning :\n     <span class=\"p\">|</span>    Numeric QR has leading or trailing spaces\n     <span class=\"p\">|</span>\n    JWS-compact\n         <span class=\"p\">|</span>\n         └─ Fatal :\n              Failed to parse JWS-compact data as <span class=\"s1\">'base64url.base64url.base64url'</span> string.\n</code></pre></div>",
        "id": 234409392,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618351437
    },
    {
        "content": "<blockquote>\n<p>But when I try to inflating the payload, I'm running into a invalid block type error. Can anybody else replicate the invalid block type error?</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"191678\">@Abigail Watson</span>  hmm, your result is looking a lot like Matt's (see above). Can you share a raw JWS + numeric encoded value so we can sanity-check that?</p>",
        "id": 234410186,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618351903
    },
    {
        "content": "<p>Here is the JWT </p>\n<div class=\"codehilite\"><pre><span></span><code>eyJhbGciOiJFUzI1NiIsInppcCI6IkRFRiJ9.N1pMYmJ0cEFFSVpmeGRyZXRKTFBEZ2x3VlVwUFVSR05Rb3NxVlZHMXJNZXd6UjdjM1RVdWlYajN6dG9RVUM3NkFpMDNhRDMvZlBQUDRaRndhOG1ZYkp5cjdUaEp0cFF4cmlDcXFiVzFOaTYyTzFrN0xhbmpMT2FhaEVTdEtqTE9Mck5oTWNpTFVScVNMU1BqUi9LYWFlWGd0eVBqNzArd3RtM2p0b2kxV1NkNW1nMFRacUFFNVRnVk50bG01QzRrYmxlRHoxaUM0UlduS3dIVEp3M1dPb0tzcE1adGdBcTNpUmsxcFgzUlB5TC8rS3VPUzlrby9vRDJ0ZklGVHhZV3plb25NT2U5Vnh0dTBJSDFtakc1aU5NNFE2ai8rcVpScFFDdk1XQjFZeGg4NlJ5VFErRFlBV0ZhQ0tSNVFraXdnTmxoVzBodWhQaHFCQXF1ejR3a0tZcU9RQSszanJyR2RoaFpDM0RnbTJxcG5XdjNnVzhCWFZVNE13aEpqZmxJOXprbHQ3V2dXSVpNcVNvcGcyQkJCVmZVZHV3S0RDZ1BKemQ5U3BLbEtkbUhoSmY0N1h3cWtaU204OHgwZ3hzMGZiT24vSGZIUUpMbG8yRnhkWGt4OEp5U09oL04wenlMMGlKS0IxM1pYdzNZQStQa2J5THdlTzZEVHlERTdyazVRM0ZvM2dieWg1NXJ3SjhkRHVEWTh1RWlwN3JzUnRYZkdGbE1iaGZSOVBNeXlvT1grSGY5TnNwR3I0S0ROZ3prN1h3U0JyYm05eERVUmp2Z0tneG04NXNRWDJEQmJMSDFMUVNWQVJRWGFTRFpPa25qUXM2Q1VsdS9WcVpMcnRiZER1ME9XNUorenN0dmZhUnZITzNlN2NQbmgzRytaMVQvNk9ZOW1GVlhyVklmZCsvdFFySHB3OHhIU3MwYWVWam0vd1A0MXc1Z3Y4ZGsvUDBC.VoUOOvL_ybatf1fTJsS5v8WL3If7kPfILSNzZxQmvFd0M_zpw3boKc-KC1visi7-vJ--_d2knqI1VayPRRFSwA\n</code></pre></div>\n<p>And the numeric encoded version:</p>\n<div class=\"codehilite\"><pre><span></span><code>shc:/567629595326546034602925407728433602870286567675422289286237253760291213346732446429354242525384167645626377645433730392521244557564163417440254138373837536337541634527324329334543559406155613243741554263445261339552612374140326336225673223335937233273456321364023375237655559342644544626785461554052246735425257546463235443256041772534523944763977256933375595364673239525595224413955247168392412325462866394233673925413854413332404216840601231444225634226553564121683377206955637713256735356275414336233424653225375254402525334137654162835326343677376944647563372766755240323406355723865528412467632455355337177542445255265521543933674064707554255877406321839221169386413540776369537612733723293456263264127594541667635358333954084165593553921293823257152625445240833332524552601169544167385425252355624433661254556265873363298412524693725632141345593637138334125695243556539647566417721665542593652272522364325456613765237145544012373638707752652976375376652256723323376553392975542684355613365417759224225454133244652246768456475293443676953273664155543384167335441337354265476366229224164454145274163833723454213056643684062131532471625340596638644433345965442715240537342758744565977322645603957733826452840406732532611763765596242267173424678403126631377456656332322663303832875324674455773345363871365252983927556339774524412763243739557652774137323457332555605642584334329638615962372741244239594374263743362977406537444562552653244605226453834412133564363733945869382644839653374376283383373445667693345964032976446438562437414064675453716556263733433337422329243664293238232532404133423641293742262539372567355258684043325364417055381242544167325465376045243743224124333406669566533355644559406545283977336333533365364587737767152324136733362124534424264163597641626364452270735525257638272163427592840632744442414252643735542033243544456447452670734023212214166403434733150765352715745739297038873114231628571062355728313833774575366473255533250776774653663054030224736070601007329005055562656828441527635373725387420\n</code></pre></div>\n<p>The validator says <code>Invalid numeric QR header: expected shc:/[0-9]/[0-9]/[0-9]+</code></p>\n<p>But the SMART HealthCard website says <code>a single chunk might produce a QR code like shc:/56762909524320603460292437404460&lt;snipped for brevity&gt;</code></p>\n<p>So, there seems to be a discrepancy between the validator, the documentation, and the compiler.  <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 234411078,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618352489
    },
    {
        "content": "<p>You're using the validator? It should definitely accept single-chunk QRs without a <code>/[0-9]/[0-9]</code> prefix, because it accepts the examples in the spec (e.g., <a href=\"https://smarthealth.cards/examples/example-00-f-qr-code-numeric-value-0.txt\">this one</a>). And if you look at the output I pasted above, it's not saying \"Invalid numeric QR header: expected shc:/[0-9]/[0-9]/[0-9]+\". Can you share a full invocation example together with inputs?</p>",
        "id": 234411277,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618352592
    },
    {
        "content": "<p>Well, I only just started using the validator.  My usage of the validator maybe hasn't been validated yet...</p>",
        "id": 234411384,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618352664
    },
    {
        "content": "<p>haha</p>",
        "id": 234411395,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618352677
    },
    {
        "content": "<p>One quick note, in your JWS example the header lacks a <code>kid</code> claim.</p>",
        "id": 234411536,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618352779
    },
    {
        "content": "<p>Mmmm.... cropped the image, and the single-chunk QR is still producing the <code>Invalid numeric QR header</code> in the validator.  Using v0.4.3</p>",
        "id": 234411739,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618352937
    },
    {
        "content": "<p>Had me eye on the <code>kid</code> claim next.  Putting it in now.</p>",
        "id": 234411759,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618352956
    },
    {
        "content": "<p>So your numeric encoding should start like (a) but actually starts like (b):</p>\n<div class=\"codehilite\"><pre><span></span><code>(a) 56762959532654603460292540772804\n(b) 56762959532654603460292540772843\n</code></pre></div>",
        "id": 234412005,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618353107
    },
    {
        "content": "<p>It looks like any character that gets encoded as <code>0\\d</code> (e.g., <code>04</code> in this case) is having its <code>0</code> stripped before you join it into the numeric encoding.</p>",
        "id": 234412092,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618353147
    },
    {
        "content": "<p>Each character of the input JWS should produce <em>exactly two</em> characters in the numeric encoding.</p>",
        "id": 234412117,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618353170
    },
    {
        "content": "<p>Huh.</p>",
        "id": 234412237,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618353239
    },
    {
        "content": "<p>Well, that's not good.</p>",
        "id": 234412330,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618353258
    },
    {
        "content": "<p>Lemme see about correcting that....</p>",
        "id": 234412370,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618353298
    },
    {
        "content": "<p>I captured <a href=\"https://github.com/microsoft/health-cards-validation-SDK/issues/52\">https://github.com/microsoft/health-cards-validation-SDK/issues/52</a> as a suggestion for the validator</p>",
        "id": 234412466,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618353356
    },
    {
        "content": "<p>My slightly <a href=\"https://github.com/smart-on-fhir/health-cards/blob/main/generate-examples/src/index.ts#L173-L184\">code-golf-ey implementation</a> is:</p>\n<div class=\"codehilite\" data-code-language=\"JavaScript\"><pre><span></span><code><span class=\"kd\">const</span> <span class=\"nx\">SMALLEST_B64_CHAR_CODE</span> <span class=\"o\">=</span> <span class=\"mf\">45</span><span class=\"p\">;</span> <span class=\"sr\">/ /</span> <span class=\"s2\">\"-\"</span><span class=\"p\">.</span><span class=\"nx\">charCodeAt</span><span class=\"p\">(</span><span class=\"mf\">0</span><span class=\"p\">)</span> <span class=\"o\">===</span> <span class=\"mf\">45</span>\n<span class=\"nx\">jws</span>\n  <span class=\"p\">.</span><span class=\"nx\">split</span><span class=\"p\">(</span><span class=\"s1\">''</span><span class=\"p\">)</span>\n  <span class=\"p\">.</span><span class=\"nx\">map</span><span class=\"p\">((</span><span class=\"nx\">c</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"nx\">c</span><span class=\"p\">.</span><span class=\"nx\">charCodeAt</span><span class=\"p\">(</span><span class=\"mf\">0</span><span class=\"p\">)</span> <span class=\"o\">-</span> <span class=\"nx\">SMALLEST_B64_CHAR_CODE</span><span class=\"p\">)</span>\n  <span class=\"p\">.</span><span class=\"nx\">flatMap</span><span class=\"p\">((</span><span class=\"nx\">c</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">[</span><span class=\"nb\">Math</span><span class=\"p\">.</span><span class=\"nx\">floor</span><span class=\"p\">(</span><span class=\"nx\">c</span> <span class=\"o\">/</span> <span class=\"mf\">10</span><span class=\"p\">),</span> <span class=\"nx\">c</span> <span class=\"o\">%</span> <span class=\"mf\">10</span><span class=\"p\">])</span>\n  <span class=\"p\">.</span><span class=\"nx\">join</span><span class=\"p\">(</span><span class=\"s1\">''</span><span class=\"p\">),</span>\n</code></pre></div>",
        "id": 234412675,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618353471
    },
    {
        "content": "<p>Well, I zero padded each number, and created the following string <code>shc:/</code> string.  </p>\n<div class=\"codehilite\"><pre><span></span><code>shc:/5676295953265460346029254077280433602870286471674522280928627005412767725626043836033366376163724264126140404128546445413839332853634141372337754003667138635930404028034304406031222909524320603460292437404460573601330467304526280853065526384228734006414045262926383871234124373132413368452725715440634253045566412545333240556344034105396521074264670452255561416011773203412336644542524244763726672252640872402632083343660744066603440525373942377044415404542759263963554139414404364141263864673954414503444029744263556741062004400667695243456752045535452671723643634041413776530658074024413056634168332329645642555953623306542404703322700755653334324341263077553941401270396125295541374144042474426245224241377341036605530424073003043732626760524004264105636344775573410304283204294538772168564041675439553844421277396541374141667642620708322667613838707333652967414145613760127332772542554063295362320355272473406212454526360656627562456412063726673453412140372412255504240554614163416471415343552752772127376345743665330541030440520341685223213754261238364204674023372236434573366537033605336742244126563925374403593453406729542529623641240555407528414145754462450837627121366437644142677454394177552640073664083941613607566225305641597138396277532567345641416553406352394325423763296653233723564320034041407739276769376236034540376954647104386471684505046333381206372474694525370841042541546441635342257455055406542728085425367334252967384271033303453138232073330324074403660540255538422737073927557252400829450359604526756437636765372336694065452955622803382728774024632541276676542763713903373853622473520567073441596556645403382633275661416138624540532629435261457133620432360528775239292233654106542344775327440755395569380571735523327752035976453812303004210537396341310367283424417555247536372432083264290939065808456363253725587638261234422724033665594353653339446425303326672341620408344137075439294254416306422603774440597454035543542467055661457154045805406521285543540833761173416459723977595232413669336441393006453032066276456208755205747353254408444207043342633142636374413959324025207336424507546228063726454556627469310555213536012628441167770377501259312530380377500836402454546268527434250369385733706864500367662925603764650671674404366257440956644275695628565024565953684139727732666056537375076236\n</code></pre></div>\n<p>Still getting an <code>invalid block type</code> on inflateRaw() and <code>Invalid numeric QR header</code> with the validator.</p>",
        "id": 234414125,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618354397
    },
    {
        "content": "<p>Just tried <code>shc:/1/1/56762959....</code> with the SDK validator, and no dice...</p>",
        "id": 234414897,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618354873
    },
    {
        "content": "<p>Well, got a much better error code with the SDK validator by using a <code>.jpg</code> image instead of <code>.png</code>.  Definitely add a bit of file type detection and error message as a ticket item.</p>\n<div class=\"codehilite\"><pre><span></span><code>QR image\n     |\n     ├─ Debug :\n     |    d.jpg = shc:/1/1/5676295953265460346029254077280433602870286471674522280928627005412767725626043836033366376163724264126140404128546445413839332853634141372337754003667138635930404028034304406031222909524320603460292437404460573601330467324464290354242525384167645626377645433730380421273842672441633371542725684041293941401231380575424065375955035876370425363306400644427525443959633264370336033365422645453704552733043363456154063339407336620404392545694062086039044544444141303639257052623304384071715427377442392932330445524104376955652535384340043864632640646308414167524403127756402563372645265240417437034569344041094540030532263273382467693441207437653703532732035277216344395534380541715325553039435921360533745624717156633352390425663862540444645561300463653003453241265961360367673426257638254121410441713963550639414560522321094442717633062172552440735562454438256763564145055577327655264531376567074442043441037538326237354539246955434141374058755343372754242869536433454263247331044524546341733663597140242405552612065540540745267077320554743640456641055567520541413862637738403752424275033843297342233759450425313926706939406723534071245203253655233605336129764241634340427506332467054441412455634406522408053640447455263343424125694506290952054004566333713327293744624133534145224163416544622968364325045440547742633309360555363865676145266370386475754264712656246763332729644127254140633371552563093227674255392128412408285562037338265530386125685406440754620866456071213340674441387076520636064104674053414140542612083177457755054003426328773442676544054509376245083662413455635804450667265304596944656323342358753324247339065909364212634223633841394074326362055443410937436327343812345306337239632135530345603103590534266332380667033424456332612145564075055424122156273307426159655440630732655526414163443739630540393308366229623964540555772125400655335306670339622577532555395627297134243769542736734165255239272970444337405539214332655930300567724027447741042976536254743077552139255907310354054261413831052535452362694024457030036707322544734404587341035876330421673423593038253377324325044160127131065536332325063342550334240869310420743658010739347004240300677175352204236208580469000361771075433326343556446833565277625440363923085812393461717176586936285940525571697259292708671121103261112459527571046754215658\n     |\n     ├─ Info :\n     |    d.jpg decoded\n     |\n    QR numeric\n         |\n         ├─ Debug :\n         |    shc:/1/1/... = eyJhbGciOiJFUzI1NiIsImtpZCI6Iks2VHpueG1SQ0NoRjluWm9jUUVIcmZVSTNIblVVRDRxU0otSlhKUUI0X1UiLCJ6aXAiOiJERUYifQ.N1pMYmJ0cEFFSVpmeGRyZXRKS1BHSWpEVlNtcHFqUVJTVU9LS2xWUnRhd0gyR1FQN3U3YWxFYThlMmR0Q0NnWGZZR1dHN1NlZjc3NTUvQk11TFZrUk5iT1ZYYVVKQTFsakN1SUttcHRwWTJMN1ZaV1RrdnFPSXU1SmlGUml5VVpaY09zeUFlRGZGaUVwR0ZrOUV6ZU02MGMvSEprOVAwRnR0bHM0azBlYTdOS2VtbFdKTXhBQ2NweEttelNaT1FoSkc1YmdjK1lnK0ZMVGhjQ0ppOGFySFVBV1VtTld3TVZiaDB6YWtyN3BudEUvdkZYSFpleVZ2dzMydGZLRnp4YW1OV0xSMkRPZTErdXVVRUgxbXRHcEIrbmNZWlEvL1ZEclVvQlhtUEE2dG93dUc4ZGszM2cwQUZoV2dpa2VVSklzSURaWWx0SXJvWDRhZ1FLTGsrTUpDbUtEa0FQdDQ2NjJyWVlXUWx3NEp2YVVEdlY3aE52QUYwdGNXWVFrZ3J6a2U1elNtNHJRYkVNbVZCVlVnYkJqQXF1cUczWlN6Q2dQSnpjZGlsSmxxWmtGeEplNHJmVHFVUlNtdFl6MHpWdTBIVE5Idk0vSGdKSjFqc3Y4ck5oZitBNUpYVSsya3Q3V1pUbVVUcG95LzZzd2U0WlIzOWpnY2Z6RkZ5QkVOdlg1Z3pGb1hrYnlDODgxNEEvT3h6QW9lWDlSVTUwMlk2cXV6RXlHOS9Ob3NuTlBPb0ZiL0h2OGlMS3p0OEZlMjBZeUx2cE9BeHN4WjhncUl4MndGVVlYRTl2UTN5QkJkTmc2dzBFU3dNb3p0TkFzbFdTeHJtOERrcHQvVnFaTHJsYXRUdTBXMnhKK2puUHYzV1JybkcwKzdBTFh4L0c2WjVSL2FPZDkrUEZsK0p4MFYvY1gvV0gyN1BpODhKSFNzMXF1Vi9tL3dQNDF3NWd0OE5rL1AwQg.4TOs1E0-ptxPC1Dk5g1r-0jz7xXNGOPeYqNeazkcUQTD5g9TOjttygrQIhUadtruhJH5p8B7Mj8Ehaxt1pcBeg\n         |    JWS = eyJhbGciOiJFUzI1NiIsImtpZCI6Iks2VHpueG1SQ0NoRjluWm9jUUVIcmZVSTNIblVVRDRxU0otSlhKUUI0X1UiLCJ6aXAiOiJERUYifQ.N1pMYmJ0cEFFSVpmeGRyZXRKS1BHSWpEVlNtcHFqUVJTVU9LS2xWUnRhd0gyR1FQN3U3YWxFYThlMmR0Q0NnWGZZR1dHN1NlZjc3NTUvQk11TFZrUk5iT1ZYYVVKQTFsakN1SUttcHRwWTJMN1ZaV1RrdnFPSXU1SmlGUml5VVpaY09zeUFlRGZGaUVwR0ZrOUV6ZU02MGMvSEprOVAwRnR0bHM0azBlYTdOS2VtbFdKTXhBQ2NweEttelNaT1FoSkc1YmdjK1lnK0ZMVGhjQ0ppOGFySFVBV1VtTld3TVZiaDB6YWtyN3BudEUvdkZYSFpleVZ2dzMydGZLRnp4YW1OV0xSMkRPZTErdXVVRUgxbXRHcEIrbmNZWlEvL1ZEclVvQlhtUEE2dG93dUc4ZGszM2cwQUZoV2dpa2VVSklzSURaWWx0SXJvWDRhZ1FLTGsrTUpDbUtEa0FQdDQ2NjJyWVlXUWx3NEp2YVVEdlY3aE52QUYwdGNXWVFrZ3J6a2U1elNtNHJRYkVNbVZCVlVnYkJqQXF1cUczWlN6Q2dQSnpjZGlsSmxxWmtGeEplNHJmVHFVUlNtdFl6MHpWdTBIVE5Idk0vSGdKSjFqc3Y4ck5oZitBNUpYVSsya3Q3V1pUbVVUcG95LzZzd2U0WlIzOWpnY2Z6RkZ5QkVOdlg1Z3pGb1hrYnlDODgxNEEvT3h6QW9lWDlSVTUwMlk2cXV6RXlHOS9Ob3NuTlBPb0ZiL0h2OGlMS3p0OEZlMjBZeUx2cE9BeHN4WjhncUl4MndGVVlYRTl2UTN5QkJkTmc2dzBFU3dNb3p0TkFzbFdTeHJtOERrcHQvVnFaTHJsYXRUdTBXMnhKK2puUHYzV1JybkcwKzdBTFh4L0c2WjVSL2FPZDkrUEZsK0p4MFYvY1gvV0gyN1BpODhKSFNzMXF1Vi9tL3dQNDF3NWd0OE5rL1AwQg.4TOs1E0-ptxPC1Dk5g1r-0jz7xXNGOPeYqNeazkcUQTD5g9TOjttygrQIhUadtruhJH5p8B7Mj8Ehaxt1pcBeg\n         |\n         ├─ Info :\n         |    shc:/1/1/... decoded\n         |\n         ├─ Warning :\n         |    Single-chunk numeric QR code should have a header shc:/, not shc:/1/1/\n         |\n        JWS-compact\n             |\n             ├─ Debug :\n             |    JWS.header = {&quot;alg&quot;:&quot;ES256&quot;,&quot;kid&quot;:&quot;K6TznxmRCChF9nZocQEHrfUI3HnUUD4qSJ-JXJQB4_U&quot;,&quot;zip&quot;:&quot;DEF&quot;}\n             |    JWS.signature = e133acd44d3ea6dc4f0b50e4e60d6bfb48f3ef15cd18e3de62a35e6b391c5104c3e60f533a3b6dca0ad022151a76daee8491f9a7c07b323f0485ac6dd697017a\n             |\n             ├─ Error :\n             |    Error inflating JWS payload. Did you use raw DEFLATE compression?\n             |    incorrect header check\n             |\n            JWS.payload\n                 |\n                 └─ Fatal :\n                      Failed to parse JWS.payload data as JSON.\n</code></pre></div>",
        "id": 234416303,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618355690
    },
    {
        "content": "<p>That's progress!</p>",
        "id": 234418140,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618356802
    },
    {
        "content": "<p>Can you share a code example for how you're applying DEFLATE compression?</p>",
        "id": 234418394,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618356935
    },
    {
        "content": "<p>I've seen similar errors before when (accidentally lossily) converting a JS buffer to a string before encoding.</p>",
        "id": 234420081,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618357965
    },
    {
        "content": "<p>Yeah, this is where I was having questions about <code>base64</code> encoding.  I've tried <code>utf-8</code>, <code>binary</code>, and without any value.  None of them seem to work.   <code>base64</code> gives legible tokens, whereas the others blow up the console with buffer noise.</p>\n<div class=\"codehilite\" data-code-language=\"JavaScript\"><pre><span></span><code>        <span class=\"kd\">let</span> <span class=\"nx\">promiseToCompressRecord</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nb\">Promise</span><span class=\"p\">(</span><span class=\"kd\">function</span><span class=\"p\">(</span><span class=\"nx\">resolve</span><span class=\"p\">,</span> <span class=\"nx\">reject</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n            <span class=\"nx\">zlib</span><span class=\"p\">.</span><span class=\"nx\">deflateRaw</span><span class=\"p\">(</span><span class=\"nx\">stringifiedRecordToSign</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">,</span> <span class=\"nx\">buffer</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n                <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">){</span>\n                    <span class=\"nx\">reject</span><span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">);</span>\n                <span class=\"p\">}</span>\n                <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">buffer</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n                    <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">'Compressed buffer:'</span><span class=\"p\">)</span>\n                    <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">buffer</span><span class=\"p\">.</span><span class=\"nx\">toString</span><span class=\"p\">(</span><span class=\"s1\">'base64'</span><span class=\"p\">));</span>\n                    <span class=\"nx\">resolve</span><span class=\"p\">(</span><span class=\"nx\">buffer</span><span class=\"p\">.</span><span class=\"nx\">toString</span><span class=\"p\">(</span><span class=\"s1\">'base64'</span><span class=\"p\">));</span>\n              <span class=\"p\">}</span>\n                <span class=\"k\">else</span> <span class=\"p\">{</span>\n                  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">);</span>\n                <span class=\"p\">}</span>\n            <span class=\"p\">});</span>\n        <span class=\"p\">});</span>\n</code></pre></div>",
        "id": 234421089,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618358681
    },
    {
        "content": "<p>If I don't use <code>base64</code>, the raw buffer gets dumped out like this.</p>\n<div class=\"codehilite\"><pre><span></span><code>I20210413-19:29:56.709(-5)? signHealthCard.stringifiedRecordToSign {&quot;iss&quot;:&quot;https://vaccine-passport.symptomatic.io&quot;,&quot;nbf&quot;:1618360256,&quot;vc&quot;:{&quot;@context&quot;:[&quot;https://www.w3.org/2018/credentials/v1&quot;],&quot;type&quot;:[&quot;VerifiableCredential&quot;,&quot;https://smarthealth.cards#health-card&quot;,&quot;https://smarthealth.cards#immunization&quot;],&quot;credentialSubject&quot;:{&quot;fhirVersion&quot;:&quot;4.0.1&quot;,&quot;fhirBundle&quot;:{&quot;resourceType&quot;:&quot;Bundle&quot;,&quot;type&quot;:&quot;collection&quot;,&quot;entry&quot;:[{&quot;fullUrl&quot;:&quot;Immunization/0&quot;,&quot;resource&quot;:{&quot;status&quot;:&quot;completed&quot;,&quot;wasNotGiven&quot;:false,&quot;patient&quot;:{&quot;display&quot;:&quot;Candace Salinas&quot;,&quot;reference&quot;:&quot;Patient/100&quot;},&quot;id&quot;:&quot;immunization-mmr&quot;,&quot;encounter&quot;:{&quot;reference&quot;:&quot;Encounter/129837645&quot;},&quot;date&quot;:&quot;2021-03-05&quot;,&quot;requester&quot;:{&quot;display&quot;:&quot;Altick Kelly&quot;,&quot;reference&quot;:&quot;Practitioner/8&quot;},&quot;reported&quot;:false,&quot;vaccineCode&quot;:{&quot;text&quot;:&quot;SARS-COV-2 (COVID-19) vaccine, mRNA, spike protein, LNP, preservative free, 30 mcg/0.3mL dose&quot;,&quot;coding&quot;:[{&quot;system&quot;:&quot;CVX&quot;,&quot;code&quot;:&quot;208&quot;}]},&quot;resourceType&quot;:&quot;Immunization&quot;,&quot;_id&quot;:&quot;nPN82dGSF6gzDdbEu&quot;,&quot;_document&quot;:{&quot;status&quot;:&quot;completed&quot;,&quot;wasNotGiven&quot;:false,&quot;patient&quot;:{&quot;display&quot;:&quot;Candace Salinas&quot;,&quot;reference&quot;:&quot;Patient/100&quot;},&quot;id&quot;:&quot;immunization-mmr&quot;,&quot;encounter&quot;:{&quot;reference&quot;:&quot;Encounter/129837645&quot;},&quot;date&quot;:&quot;2021-03-05&quot;,&quot;requester&quot;:{&quot;display&quot;:&quot;Altick Kelly&quot;,&quot;reference&quot;:&quot;Practitioner/8&quot;},&quot;reported&quot;:false,&quot;vaccineCode&quot;:{&quot;text&quot;:&quot;SARS-COV-2 (COVID-19) vaccine, mRNA, spike protein, LNP, preservative free, 30 mcg/0.3mL dose&quot;,&quot;coding&quot;:[{&quot;system&quot;:&quot;CVX&quot;,&quot;code&quot;:&quot;208&quot;}]},&quot;resourceType&quot;:&quot;Immunization&quot;,&quot;_id&quot;:&quot;nPN82dGSF6gzDdbEu&quot;}}}]}}}}\nI20210413-19:29:56.710(-5)? signHealthCard.syncedCompressedRecord &lt;Buffer ed 92 db 6e 1a 31 10 86 5f 65 e5 de b4 d2 9e 49 28 e1 aa 94 a4 51 d4 88 a2 d0 a2 4a 55 54 19 7b 00 37 3e 6c 6d ef 12 12 f1 ee 1d ef 42 40 b9 e8 0b b4 ... 491 more bytes&gt;\nI20210413-19:29:56.711(-5)? signHealthCard.signedToken eyJhbGciOiJFUzI1NiIsImtpZCI6Iks2VHpueG1SQ0NoRjluWm9jUUVIcmZVSTNIblVVRDRxU0otSlhKUUI0X1UiLCJ6aXAiOiJERUYifQ.77-977-9bhoxEO-_vV9l77-93rTSnkko4aqU77-9UdSI77-90KJKVVQZewA3Pmxt77-9EhLvv73vv70d77-9QkDvv73vv70L77-977-9IO-_ve-_ve-_ve-_vT_vv71nIu-_vSND77-977-977-9cu-_vSxrKGNCQ1JR77-9KmN96raq77-9RlEvWCoM77-977-9XizJsO-_vRfvv71ePy_vv73vv70xaRgZPu-_vQ_vv71oD--_ve-_vQx_77-977-9Nu-_vU3vv73vv73Gru-_vTIvBhnvv73vv71Be0Hvv73Lmu-_ve-_ve-_ve-_vW8rCBlz77-9Yinvv71C77-977-9Re-_ve-_vQ4g77-977-977-9a--_vdKvU0Ytd2_vv71HEh5_77-9Ce-_vWot77-90L7Roe-_ve-_vcKsXu-_vQLvv73vv73vv71aWHTvv73vv71mSO-_ve-_vTwtEBrvv71-77-9Ne-_vRA0Fu-_ve-_vS3vv73vv73vv71j77-9Dxw6IO-_vUjvv73vv71A77-9CRbvv71bbAvJte-_vd-sRO-_vc2J77-9LEfvv70BGO-_ve-_vVNf77-9Fu-_vSoJHkJTG--_vSbvv71f77-9Bu-_ve-_vRJnBjHvv70wH--_vSHvv70LV0nvv71lyJhqThlEMyrvv73vv73vv71lL--_ve-_vQ5wMu-_vVLvv70i77-977-9Libvv73vv73TqSRK77-977-9MzM1bu-_vXbvv70e77-9Du-_ve-_vSgvBu-_ve-_ve-_ve-_ve-_ve-_ve-_vdSHaO-_ve-_vUXvv73vv73vv73vv73vv70t77-977-9Bu-_vWcc77-977-9JB7vv71D77-9Ge-_vdy-NmcpDi3vv71A77-9IHAt77-977-977-9ARxa77-9X--_ve-_ve-_vXZU3Y3vv73vv73vv71u77-977-977-9zJMyeu-_vX8377-9SXHvv70u77-9a--_vUjvv71NRnHvv70q77-9AFFl77-9B--_ve-_ve-_vXYy77-977-9BQ5s77-977-9NxAtLe-_ve-_ve-_vUfvv73vv73vv70877-977-924gbF--_ve-_vQwXeu-_ve-_ve-_vW3vv70lFe-_vTzvv73vv71F77-977-977-977-977-9Ln59GO-_vXtG77-977-9du-_vXo6Ge-_ve-_vXrvv73vv73vv71677-95IurOkTvv71h77-977-9L--_ve-_vQHvv71rB--_ve-_vWEy77-977-9AA.dhgQR7NOEdzODY2OB0ramptc8eSXsAugvmA4eCxJQe_amEqBun1iJq4ngzE-oToGYWZvSuQB-ULg7WcaJd0HkQ\nI20210413-19:29:56.712(-5)? verifyHealthCard.quickDecode {\nI20210413-19:29:56.712(-5)?   header: {\nI20210413-19:29:56.713(-5)?     alg: &#39;ES256&#39;,\nI20210413-19:29:56.713(-5)?     kid: &#39;K6TznxmRCChF9nZocQEHrfUI3HnUUD4qSJ-JXJQB4_U&#39;,\nI20210413-19:29:56.713(-5)?     zip: &#39;DEF&#39;\nI20210413-19:29:56.713(-5)?   },\nI20210413-19:29:56.713(-5)?   payload: &#39;��n\\u001a1\\u0010�_e�޴ҞI(᪔�QԈ�ТJUT\\u0019{\\u00007&gt;lm�\\u0012\\u0012��\\u001d�B@��\\u000b�� ����?�g&quot;�#C���r�,k(cBCRQ�*c}궪�FQ/X*\\f��^,ɰ�\\u0017�^?/��1i\\u0018\\u0019&gt;�\\u000f�h\\u000f��\\f��6�M��Ʈ�2/\\u0006\\u0019��A{A�˚����o+\\b\\u0019s�b)�B��E��\\u000e ���k�үSF-wo�G\\u0012\\u001e�\\t�j-�оѡ��¬^�\\u0002���ZXt��fH��&lt;-\\u0010\\u001a�~�5�\\u00104\\u0016��-���c�\\u000f\\u001c: �H��@�\\t\\u0016�[l\\u000bɵ�߬D�͉�,G�\\u0001\\u0018��S_�\\u0016�*\\t\\u001eBS\\u001b�&amp;�_�\\u0006��\\u0012g\\u00061�0\\u001f�!�\\u000bWI�eȘjN\\u0019D3*���e/��\\u000ep2�R�&quot;��.&amp;��ө$J��335n�v�\\u001e�\\u000e��(/\\u0006�������ԇh��E�����-��\\u0006�g\\u001c��$\\u001e�C�\\u0019�ܾ6g)\\u000e-�@� p-���\\u0001\\u001cZ�_���vTݍ���n���̓2z�7�Iq�.�k�H�MFq�*�\\u0000Qe�\\u0007���v2��\\u0005\\u000el��7\\u0010--���G���&lt;��ۈ\\u001b\\u0017��\\f\\u0017z���m�%\\u0015�&lt;��E�����.~}\\u0018�{F��v�z:\\u0019��z���z�䋫:D�a��/��\\u0001�k\\u0007��a2��\\u0000&#39;,\nI20210413-19:29:56.713(-5)?   signature: &#39;dhgQR7NOEdzODY2OB0ramptc8eSXsAugvmA4eCxJQe_amEqBun1iJq4ngzE-oToGYWZvSuQB-ULg7WcaJd0HkQ&#39;\nI20210413-19:29:56.713(-5)? }\nI20210413-19:29:56.714(-5)? signHealthCard.verifyCheck ��n1�_e�޴ҞI(᪔�QԈ�ТJUT{7&gt;lm����B@��\n                                                                                         �� ����?�g&quot;�#C���r�,k(cBCRQ�*c}궪�FQ/X*\n                                                                                                                                ��^,ɰ��^?/��1i&gt;��h��\n                                                                                                                                                    ��6�M��Ʈ�2/��A{A�˚����os�b)�B��E�� ���k�үSF-wo�G�   �j-�оѡ��¬^����ZXt��fH��&lt;-�~�5�4��-���c�: �H��@� �[l\n           ɵ�߬D�͉�,G���S_��*    BS��_���g1�0�!�\n                                               WI�eȘjND3*���e/��p2�R�&quot;��.&amp;��ө$J��335n�v����(/�������ԇh��E�����-���g��$�C��ܾ6g)-�@� p-���Z�_���vTݍ���n���̓2z�7�Iq�.�k�H�MFq�*�Qe����v2��l��7--���G���&lt;��ۈ��\n                                                                                                                                                                                                        ���m�%�&lt;��E�����.~}�{F��v�z:��z���z�䋫:D�a��/���k��a2��\nI20210413-19:29:56.714(-5)? signHealthCard.verifyCheck typeof string\nI20210413-19:29:56.721(-5)? verifyHealthCard.inflatedCheck.error Error: invalid block type\nI20210413-19:29:56.721(-5)?     at Zlib.zlibOnError [as onerror] (zlib.js:182:17)\nI20210413-19:29:56.721(-5)?     at processChunkSync (zlib.js:431:12)\nI20210413-19:29:56.721(-5)?     at zlibBufferSync (zlib.js:168:12)\nI20210413-19:29:56.722(-5)?     at Object.syncBufferWrapper [as inflateRawSync] (zlib.js:766:14)\nI20210413-19:29:56.722(-5)?     at /Users/abigailwatson/.meteor/packages/promise/.0.11.2.8skplc.uqog2++os+web.browser+web.browser.legacy+web.cordova/npm/node_modules/meteor-promise/fiber_pool.js:43:40 {\nI20210413-19:29:56.722(-5)?   errno: -3,\nI20210413-19:29:56.722(-5)?   code: &#39;Z_DATA_ERROR&#39;\nI20210413-19:29:56.722(-5)? }\nI20210413-19:29:56.722(-5)? signedToken eyJhbGciOiJFUzI1NiIsImtpZCI6Iks2VHpueG1SQ0NoRjluWm9jUUVIcmZVSTNIblVVRDRxU0otSlhKUUI0X1UiLCJ6aXAiOiJERUYifQ.77-977-9bhoxEO-_vV9l77-93rTSnkko4aqU77-9UdSI77-90KJKVVQZewA3Pmxt77-9EhLvv73vv70d77-9QkDvv73vv70L77-977-9IO-_ve-_ve-_ve-_vT_vv71nIu-_vSND77-977-977-9cu-_vSxrKGNCQ1JR77-9KmN96raq77-9RlEvWCoM77-977-9XizJsO-_vRfvv71ePy_vv73vv70xaRgZPu-_vQ_vv71oD--_ve-_vQx_77-977-9Nu-_vU3vv73vv73Gru-_vTIvBhnvv73vv71Be0Hvv73Lmu-_ve-_ve-_ve-_vW8rCBlz77-9Yinvv71C77-977-9Re-_ve-_vQ4g77-977-977-9a--_vdKvU0Ytd2_vv71HEh5_77-9Ce-_vWot77-90L7Roe-_ve-_vcKsXu-_vQLvv73vv73vv71aWHTvv73vv71mSO-_ve-_vTwtEBrvv71-77-9Ne-_vRA0Fu-_ve-_vS3vv73vv73vv71j77-9Dxw6IO-_vUjvv73vv71A77-9CRbvv71bbAvJte-_vd-sRO-_vc2J77-9LEfvv70BGO-_ve-_vVNf77-9Fu-_vSoJHkJTG--_vSbvv71f77-9Bu-_ve-_vRJnBjHvv70wH--_vSHvv70LV0nvv71lyJhqThlEMyrvv73vv73vv71lL--_ve-_vQ5wMu-_vVLvv70i77-977-9Libvv73vv73TqSRK77-977-9MzM1bu-_vXbvv70e77-9Du-_ve-_vSgvBu-_ve-_ve-_ve-_ve-_ve-_ve-_vdSHaO-_ve-_vUXvv73vv73vv73vv73vv70t77-977-9Bu-_vWcc77-977-9JB7vv71D77-9Ge-_vdy-NmcpDi3vv71A77-9IHAt77-977-977-9ARxa77-9X--_ve-_ve-_vXZU3Y3vv73vv73vv71u77-977-977-9zJMyeu-_vX8377-9SXHvv70u77-9a--_vUjvv71NRnHvv70q77-9AFFl77-9B--_ve-_ve-_vXYy77-977-9BQ5s77-977-9NxAtLe-_ve-_ve-_vUfvv73vv73vv70877-977-924gbF--_ve-_vQwXeu-_ve-_ve-_vW3vv70lFe-_vTzvv73vv71F77-977-977-977-977-9Ln59GO-_vXtG77-977-9du-_vXo6Ge-_ve-_vXrvv73vv73vv71677-95IurOkTvv71h77-977-9L--_ve-_vQHvv71rB--_ve-_vWEy77-977-9AA.dhgQR7NOEdzODY2OB0ramptc8eSXsAugvmA4eCxJQe_amEqBun1iJq4ngzE-oToGYWZvSuQB-ULg7WcaJd0HkQ\n</code></pre></div>",
        "id": 234423404,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618360362
    },
    {
        "content": "<p>Seems I get the invalid block type error regardless of <code>base64</code> encoding.</p>",
        "id": 234424697,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618361374
    },
    {
        "content": "<p>The validator says <code>incorrect header check</code>, so does this look right?</p>\n<div class=\"codehilite\"><pre><span></span><code>I20210413-19:29:56.712(-5)?   header: {\nI20210413-19:29:56.713(-5)?     alg: &#39;ES256&#39;,\nI20210413-19:29:56.713(-5)?     kid: &#39;K6TznxmRCChF9nZocQEHrfUI3HnUUD4qSJ-JXJQB4_U&#39;,\nI20210413-19:29:56.713(-5)?     zip: &#39;DEF&#39;\nI20210413-19:29:56.713(-5)?   },\n</code></pre></div>",
        "id": 234424880,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618361511
    },
    {
        "content": "<p>Per the documentation:  \"header includes kid equal to the base64url-encoded SHA-256 JWK Thumbprint of the key .\"</p>\n<p>I just used the <code>keys[0].kid</code> from the <code>.well-known/jwks.json</code> file.</p>",
        "id": 234426193,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618362512
    },
    {
        "content": "<p>There's some confusion in terms here. When you get an \"invalid header check\" error, this is about the <em>DEFLATE</em> header -- i.e., it's an error telling you that the compressed payload of your JWS hasn't been correctly compressed. (It's <em>not</em> about the JWS \"header\" that you included in your last post.)</p>",
        "id": 234427400,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618363527
    },
    {
        "content": "<p>I think you want your <code>promiseToCompressRecord</code> function to return a Buffer (or, say, a byte array). That way your JWS signing library can:</p>\n<ol>\n<li>Create  a signature over that raw data (rather than over a base64 representation of the data)</li>\n<li>Correctly base64url-encoded it to create the sequence of characters between the two <code>.</code>s of your JWS</li>\n</ol>",
        "id": 234427517,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618363642
    },
    {
        "content": "<p>Can anyone confirm this QR code?  I think it's fully spec compliant (or close to it).  Minimized,  iss pointer to valid keys, raw deflated, ES256 signed, with kid field in header, base64url encoded, numeric, and on a QR code.  It works with our own scanner, but I'd like to know if anybody else can get the embedded JSON object.  </p>\n<p><a href=\"/user_uploads/10155/iRwYJ2o7_X_GczDNJJvMAfsW/Symptomatic-VaccinePassport-VerrifiedCredential-Coronavirus-Deflated-Signed.png\">Symptomatic-VaccinePassport-VerrifiedCredential-Coronavirus-Deflated-Signed.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/iRwYJ2o7_X_GczDNJJvMAfsW/Symptomatic-VaccinePassport-VerrifiedCredential-Coronavirus-Deflated-Signed.png\" title=\"Symptomatic-VaccinePassport-VerrifiedCredential-Coronavirus-Deflated-Signed.png\"><img src=\"/user_uploads/10155/iRwYJ2o7_X_GczDNJJvMAfsW/Symptomatic-VaccinePassport-VerrifiedCredential-Coronavirus-Deflated-Signed.png\"></a></div>",
        "id": 235277813,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618885094
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191678\">@Abigail Watson</span> This is failing for me using the MS validation tool:<br>\nJWS = eyJhbGciOiJFUzI1NiIsInppcCI6IkRFRiIsImtpZCI6Iks2VHpueG1SQ0NoRjluWm9jUUVIcmZVSTNIblVVRDRxU0otSlhKUUI0X1UifQ.ZlpKZmI5TXdGTVcvU25SNUFTbi91NjFwbmlnRm9ZbHBUQ3RVU0dnUHJuUFRtamwyc0oyVU12VzdjNTIwNjdRSCtsSTU5L2gzei9HOVR5Q3NoUksyenJXMlRKS2VjUzRVUmkyenR0WEd4WGJmdEU0M3pBa2VDdzBocUhVTlpYYVZGY1YwVmt6ekVIb081Uk84NTFvNS9PT2cvUGtNMisxMjhXNFNhN05KOGpRckVtNndRdVVFa3picE0zZ0l3ZTFiOURkV2FFUXQyRnJpNGxsRHZVNGcyekRqdHNpazI4YWNtY3ErR1ErUlAveFhKNXFtVStJdjJkZktOenhiV0hiclg4aWQ5MTV2aFNFSDFtdEt1SWpUT0NPby8vcWhVNVZFcnpGb2RXYzRmaHNjdzdGd1NnQmNTMGswVHdpQkdwZzl4U0p5SitWM0kwbHcvY0pJa3BMb0JQUnc2NWpyN0lCcFdva09mYWdkczdmYWZSWTlrcXVhM2d4RGFPayswZjJkU3RoV01tb0RDNllxeGpGWU1pa1Vzd083Um9QS3crRnV2SkprYVFvSDc0M3JqaVpseGxCbjNhZFRJY255V1RHWlhsMWNlbjNGbksvbWFaNUY2U1JLTHdmODd3N3RrWEgyTVplMEpJL0JGNVJ5LzlxRVlmUTRQanZ4Qzg4MTZOZUxncDZpSFRkdm9hdmhTY1pkZ3VYOGZoa3R2cTZpUEhoTGY5Y2ZvMnoyTGpocXc2QzV2NTJIZ1czRkl3YXQwUTZGQ29PYjI3dVFUbWpSOUJTK3g2QTJTT0pKR2pSOGs2VHhwTGtKS20zOStMaXVoTm9NczdKN2l0VDQ5MXo5R0N0amNMTDdjQWhmTDhETGVjS0JGUFQ3Qnc9PQ.DLxOxZ7BG4vcS87qsTpdj_4Am3QXpgtEMewCz83mQkjUJpE_O1s7FhTOtcvHQsxM9281e5DskdwKn_Zv_iaDFQ<br>\n    JWS-compact<br>\n         |<br>\n         ├─ Debug : <br>\n         |    JWS.header = {\"alg\":\"ES256\",\"zip\":\"DEF\",\"kid\":\"K6TznxmRCChF9nZocQEHrfUI3HnUUD4qSJ-JXJQB4_U\"}<br>\n         |    JWS.signature = 0cbc4ec59ec11b8bdc4bceeab13a5d8ffe009b7417a60b4431ec02cfcde64248d426913f3b5b3b1614ceb5cbc742cc4cf76f357b90ec91dc0a9ff66ffe268315<br>\n         |<br>\n         ├─ Error : <br>\n         |    Error inflating JWS payload. Did you use raw DEFLATE compression?<br>\n         |    incorrect header check<br>\n         |<br>\n        JWS.payload<br>\n             |<br>\n             └─ Fatal : <br>\n                  Failed to parse JWS.payload data as JSON.</p>",
        "id": 235356836,
        "sender_full_name": "Matt Printz",
        "timestamp": 1618930522
    },
    {
        "content": "<p>Yeah, I’m thinking the validation tool is in error, and intend to bring it up at the meeting today.  The libraries that the SDK tool relies on assume TypeScript and ESM, and is inconsistent on how it handles Buffers across Node/browser environments.  But the code seems to work to produce the QR code, and I can inflate and get the embedded data afterwords.  It works, but doesn’t validate.</p>",
        "id": 235357019,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618930578
    },
    {
        "content": "<p>Ok. I'll try in my python code.</p>",
        "id": 235357552,
        "sender_full_name": "Matt Printz",
        "timestamp": 1618930785
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191678\">@Abigail Watson</span> Here's the error I got in my python code:</p>\n<p>zlib.error: Error -3 while decompressing data: invalid block type</p>",
        "id": 235360388,
        "sender_full_name": "Matt Printz",
        "timestamp": 1618931456
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191678\">@Abigail Watson</span> Looks like you're doing an extra base64 encode on the data:</p>\n<p><code>&gt;&gt;&gt; zlib.decompress(codecs.decode(payload, 'base64'), wbits=-8)</code><br>\n<code>b'{\"iss\":\"https://vaccine-passport.symptomatic.io\",\"nbf\":1618879872,\"vc\":{\"@context\":[\"https://www.w3.org/2018/credentials/v1\"],\"type\":[\"VerifiableCredential\",\"https://smarthealth.cards#health-card\",\"https://smarthealth.cards#immunization\"],\"credentialSubject\":{\"fhirVersion\":\"4.0.1\",\"fhirBundle\":{\"resourceType\":\"Bundle\",\"type\":\"collection\",\"entry\":[{\"fullUrl\":\"Immunization/0\",\"resource\":{\"status\":\"completed\",\"wasNotGiven\":false,\"patient\":{\"display\":\"Candace Salinas\",\"reference\":\"Patient/100\"},\"encounter\":{\"reference\":\"Encounter/129837645\"},\"date\":\"2021-03-05\",\"requester\":{\"display\":\"Altick Kelly\",\"reference\":\"Practitioner/8\"},\"reported\":false,\"vaccineCode\":{\"text\":\"SARS-COV-2 (COVID-19) vaccine, mRNA, spike protein, LNP, preservative free, 30 mcg/0.3mL dose\",\"coding\":[{\"system\":\"CVX\",\"code\":\"208\"}]},\"resourceType\":\"Immunization\"}}]}}}}'</code></p>\n<p>Normally, I'd just run:<br>\n<code>&gt;&gt;&gt; zlib.decompress(payload, wbits=-8)</code></p>\n<p>Where payload is the decrypted value from JWS.</p>",
        "id": 235360978,
        "sender_full_name": "Matt Printz",
        "timestamp": 1618931678
    },
    {
        "content": "<p>If I take the <code>base64</code> encoding out, I get an <code>invalid code lengths set</code> error.</p>",
        "id": 235367385,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618933825
    },
    {
        "content": "<p>Here is the encoding without the base64 encoding.</p>\n<div class=\"codehilite\"><pre><span></span><code>I20210420-10:48:12.489(-5)? ================SIGNING HEALTHCARD=============================\nI20210420-10:48:12.490(-5)?\nI20210420-10:48:12.490(-5)?\nI20210420-10:48:12.490(-5)? ---------------Verified Credential------------------------\nI20210420-10:48:12.490(-5)?\nI20210420-10:48:12.494(-5)? {\nI20210420-10:48:12.494(-5)?   iss: &#39;https://vaccine-passport.symptomatic.io&#39;,\nI20210420-10:48:12.494(-5)?   nbf: 1618933752,\nI20210420-10:48:12.494(-5)?   vc: {\nI20210420-10:48:12.495(-5)?     &#39;@context&#39;: [ &#39;https://www.w3.org/2018/credentials/v1&#39; ],\nI20210420-10:48:12.495(-5)?     type: [\nI20210420-10:48:12.495(-5)?       &#39;VerifiableCredential&#39;,\nI20210420-10:48:12.495(-5)?       &#39;https://smarthealth.cards#health-card&#39;,\nI20210420-10:48:12.495(-5)?       &#39;https://smarthealth.cards#immunization&#39;\nI20210420-10:48:12.495(-5)?     ],\nI20210420-10:48:12.496(-5)?     credentialSubject: { fhirVersion: &#39;4.0.1&#39;, fhirBundle: [Object] }\nI20210420-10:48:12.496(-5)?   }\nI20210420-10:48:12.496(-5)? }\nI20210420-10:48:12.496(-5)?\nI20210420-10:48:12.496(-5)? ---------------FHIR Bundle--------------------------------\nI20210420-10:48:12.497(-5)?\nI20210420-10:48:12.497(-5)? {\nI20210420-10:48:12.497(-5)?   resourceType: &#39;Bundle&#39;,\nI20210420-10:48:12.497(-5)?   type: &#39;collection&#39;,\nI20210420-10:48:12.497(-5)?   entry: [ { fullUrl: &#39;Immunization/0&#39;, resource: [Object] } ]\nI20210420-10:48:12.497(-5)? }\nI20210420-10:48:12.498(-5)?\nI20210420-10:48:12.498(-5)? ---------------Private Key (PEM)--------------------------\nI20210420-10:48:12.498(-5)?\nI20210420-10:48:12.502(-5)? -----BEGIN PRIVATE KEY-----\nI20210420-10:48:12.503(-5)? MEECAQAwEwYHKoZIzj0CAQYIKoZIzj0DAQcEJzAlAgEBBCBK2WhHJlI1uSa3X6+3\nI20210420-10:48:12.503(-5)? fFLXAQTzWm+ICbaJO84ROu+PjQ==\nI20210420-10:48:12.503(-5)? -----END PRIVATE KEY-----\nI20210420-10:48:12.504(-5)?\nI20210420-10:48:12.504(-5)?\nI20210420-10:48:12.504(-5)? -----------Public Key (.well-known/jwks.json)-------------\nI20210420-10:48:12.504(-5)?\nI20210420-10:48:12.504(-5)? {\nI20210420-10:48:12.505(-5)?   kty: &#39;EC&#39;,\nI20210420-10:48:12.505(-5)?   use: &#39;sig&#39;,\nI20210420-10:48:12.505(-5)?   crv: &#39;P-256&#39;,\nI20210420-10:48:12.505(-5)?   kid: &#39;K6TznxmRCChF9nZocQEHrfUI3HnUUD4qSJ-JXJQB4_U&#39;,\nI20210420-10:48:12.505(-5)?   x: &#39;MgI6HswAPwPcrnw7T4erbW1ldlzV5Wh-APaxjW6zEZg&#39;,\nI20210420-10:48:12.505(-5)?   y: &#39;I7qPPo0Z9-5_9pQ5DWGhYQp-rXDXo4GZywRKNMK4Ndo&#39;,\nI20210420-10:48:12.505(-5)?   alg: &#39;ES256&#39;\nI20210420-10:48:12.505(-5)? }\nI20210420-10:48:12.506(-5)?\nI20210420-10:48:12.506(-5)?\nI20210420-10:48:12.506(-5)? ---------------Stringified Payload------------------------\nI20210420-10:48:12.506(-5)?\nI20210420-10:48:12.506(-5)? {&quot;iss&quot;:&quot;https://vaccine-passport.symptomatic.io&quot;,&quot;nbf&quot;:1618933752,&quot;vc&quot;:{&quot;@context&quot;:[&quot;https://www.w3.org/2018/credentials/v1&quot;],&quot;type&quot;:[&quot;VerifiableCredential&quot;,&quot;https://smarthealth.cards#health-card&quot;,&quot;https://smarthealth.cards#immunization&quot;],&quot;credentialSubject&quot;:{&quot;fhirVersion&quot;:&quot;4.0.1&quot;,&quot;fhirBundle&quot;:{&quot;resourceType&quot;:&quot;Bundle&quot;,&quot;type&quot;:&quot;collection&quot;,&quot;entry&quot;:[{&quot;fullUrl&quot;:&quot;Immunization/0&quot;,&quot;resource&quot;:{&quot;status&quot;:&quot;completed&quot;,&quot;wasNotGiven&quot;:false,&quot;patient&quot;:{&quot;display&quot;:&quot;Candace Salinas&quot;,&quot;reference&quot;:&quot;Patient/100&quot;},&quot;encounter&quot;:{&quot;reference&quot;:&quot;Encounter/129837645&quot;},&quot;date&quot;:&quot;2021-03-05&quot;,&quot;requester&quot;:{&quot;display&quot;:&quot;Altick Kelly&quot;,&quot;reference&quot;:&quot;Practitioner/8&quot;},&quot;reported&quot;:false,&quot;vaccineCode&quot;:{&quot;text&quot;:&quot;SARS-COV-2 (COVID-19) vaccine, mRNA, spike protein, LNP, preservative free, 30 mcg/0.3mL dose&quot;,&quot;coding&quot;:[{&quot;system&quot;:&quot;CVX&quot;,&quot;code&quot;:&quot;208&quot;}]},&quot;resourceType&quot;:&quot;Immunization&quot;}}]}}}}\nI20210420-10:48:12.506(-5)?\nI20210420-10:48:12.507(-5)? -------------Raw Deflated Payload (Buffer)----------------\nI20210420-10:48:12.507(-5)?\nI20210420-10:48:12.507(-5)? &lt;Buffer 7d 92 5f 6f d3 30 14 c5 bf 4a 74 79 01 29 ff b3 6e 6d 9e 28 05 a1 89 69 4c 2b 54 48 68 0f ae 73 d3 9a 39 76 b0 9d 94 32 f5 bb 73 9d b4 eb b4 07 fa 52 ... 446 more bytes&gt;\nI20210420-10:48:12.507(-5)?\nI20210420-10:48:12.507(-5)? -------------Raw Deflated Payload (Uint8Array)------------\nI20210420-10:48:12.508(-5)?\nI20210420-10:48:12.508(-5)? ArrayBuffer {\nI20210420-10:48:12.508(-5)?   [Uint8Contents]: &lt;7d 92 5f 6f d3 30 14 c5 bf 4a 74 79 01 29 ff b3 6e 6d 9e 28 05 a1 89 69 4c 2b 54 48 68 0f ae 73 d3 9a 39 76 b0 9d 94 32 f5 bb 73 9d b4 eb b4 07 fa 52 39 f7 f8 77 cf f1 bd 4f 20 ac 85 12 b6 ce b5 b6 4c 92 9e 71 2e 14 46 2d b3 b6 d5 c6 c5 76 df b4 4e 37 cc 09 1e 0b 0d 21 a8 75 0d 65 76 99 4d 67 45 71 ... 16284 more bytes&gt;,\nI20210420-10:48:12.508(-5)?   byteLength: 16384\nI20210420-10:48:12.508(-5)? }\nI20210420-10:48:12.508(-5)?\nI20210420-10:48:12.508(-5)? -------------Buffer (Experimental)------------------------\nI20210420-10:48:12.508(-5)?\nI20210420-10:48:12.509(-5)? &lt;Buffer 7d 92 5f 6f d3 30 14 c5 bf 4a 74 79 01 29 ff b3 6e 6d 9e 28 05 a1 89 69 4c 2b 54 48 68 0f ae 73 d3 9a 39 76 b0 9d 94 32 f5 bb 73 9d b4 eb b4 07 fa 52 ... 446 more bytes&gt;\nI20210420-10:48:12.509(-5)?\nI20210420-10:48:12.509(-5)? ------------JSON Web Signature (JWS)----------------------\nI20210420-10:48:12.509(-5)?\nI20210420-10:48:12.509(-5)? eyJhbGciOiJFUzI1NiIsInppcCI6IkRFRiIsImtpZCI6Iks2VHpueG1SQ0NoRjluWm9jUUVIcmZVSTNIblVVRDRxU0otSlhKUUI0X1UifQ.fe-_vV9v77-9MBTFv0p0eQEp77-977-9bm3vv70oBe-_ve-_vWlMK1RIaA_vv71z05o5du-_ve-_ve-_vTLvv73vv71z77-977-977-9B--_vVI577-977-9d--_ve-_vU8g77-977-9Eu-_vc6177-9TO-_ve-_vXEuFEYt77-977-977-977-977-9dt-0Tjfvv70JHgsNIe-_vXUNZXbvv71NZ0VxNe-_vUPvv70577-9T--_vWvvv73vv73vv73vv73vv73vv70zbO-_ve-_vcW7Iu-_vWbvv73vv71pNk3vv73vv70K77-9E0zapO-_ve-_vSEE77-9b--_ve-_vVjvv70R77-9YGvvv73vv71nDe-_vTrvv71sw4zvv70i77-9bhtzZirvv71mPETvv73vv71f77-9aO-_vU7vv73vv71kXyvvv73vv71sYdmtfyF377-9e--_vRXvv70cWO-_vSnvv70iTuOMoO-_ve-_vU5VEu-_vcag1Z3vv73vv71tcAzvv73vv70pAXAtJe-_vTwhBGpg77-9FO-_vcid77-9340k77-977-9CyNJSu-_vRPvv73DrWPvv73vv70D77-9aSU677-977-9du-_ve-_vWrvv71Z77-9SO-_vWp6Mwzvv73vv73vv71E77-9dyphW8moDSzvv73vv70Y77-9YMmkUO-_vQ7vv70aDSoP77-977-977-9Su-_ve-_vSkc77-9N--_vTvvv73vv70ZQ--_vXXvv71O77-9JO-_vWfvv73vv73vv73vv71i77-977-9FXPvv73vv73vv715Fu-_vUXvv71OBu-_ve-_vQ7vv71x77-9Me-_ve-_vSTvv73vv70X77-9cu-_vdqEYe-_vTg-O--_vWvQrxcFPUU7bu-_vUJXw5Pvv73vv70E77-977-977-9Mlp8XUV577-977-977-9P0bvv73vv71dcNSGQXN_Ow8D24pHDFrvv70dChUGN--_vXch77-90KLvv70pfO-_vUFt77-977-9RRo0fO-_ve-_vXHvv73vv70E77-977-9fnxcV0Jt77-9We-_vT1Fau-_vXvvv71-77-977-9MTjvv719OO-_ve-_vRfvv73vv70877-9QArvv73vv70D.OTaX5A-Q82vHG-xELo-_jcU2cpD-vsz_VB3z5twRw3uMkvw-5fagWA_I6U0WBfj0N8KDaiJHCdvpYZHZA4PgEQ\n</code></pre></div>",
        "id": 235367499,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618933876
    },
    {
        "content": "<p>And here is the decoding:</p>\n<div class=\"codehilite\"><pre><span></span><code>I20210420-10:48:12.510(-5)? ================VERIFY SIGNATURE==========================\nI20210420-10:48:12.510(-5)? eyJhbGciOiJFUzI1NiIsInppcCI6IkRFRiIsImtpZCI6Iks2VHpueG1SQ0NoRjluWm9jUUVIcmZVSTNIblVVRDRxU0otSlhKUUI0X1UifQ.fe-_vV9v77-9MBTFv0p0eQEp77-977-9bm3vv70oBe-_ve-_vWlMK1RIaA_vv71z05o5du-_ve-_ve-_vTLvv73vv71z77-977-977-9B--_vVI577-977-9d--_ve-_vU8g77-977-9Eu-_vc6177-9TO-_ve-_vXEuFEYt77-977-977-977-977-9dt-0Tjfvv70JHgsNIe-_vXUNZXbvv71NZ0VxNe-_vUPvv70577-9T--_vWvvv73vv73vv73vv73vv73vv70zbO-_ve-_vcW7Iu-_vWbvv73vv71pNk3vv73vv70K77-9E0zapO-_ve-_vSEE77-9b--_ve-_vVjvv70R77-9YGvvv73vv71nDe-_vTrvv71sw4zvv70i77-9bhtzZirvv71mPETvv73vv71f77-9aO-_vU7vv73vv71kXyvvv73vv71sYdmtfyF377-9e--_vRXvv70cWO-_vSnvv70iTuOMoO-_ve-_vU5VEu-_vcag1Z3vv73vv71tcAzvv73vv70pAXAtJe-_vTwhBGpg77-9FO-_vcid77-9340k77-977-9CyNJSu-_vRPvv73DrWPvv73vv70D77-9aSU677-977-9du-_ve-_vWrvv71Z77-9SO-_vWp6Mwzvv73vv73vv71E77-9dyphW8moDSzvv73vv70Y77-9YMmkUO-_vQ7vv70aDSoP77-977-977-9Su-_ve-_vSkc77-9N--_vTvvv73vv70ZQ--_vXXvv71O77-9JO-_vWfvv73vv73vv73vv71i77-977-9FXPvv73vv73vv715Fu-_vUXvv71OBu-_ve-_vQ7vv71x77-9Me-_ve-_vSTvv73vv70X77-9cu-_vdqEYe-_vTg-O--_vWvQrxcFPUU7bu-_vUJXw5Pvv73vv70E77-977-977-9Mlp8XUV577-977-977-9P0bvv73vv71dcNSGQXN_Ow8D24pHDFrvv70dChUGN--_vXch77-90KLvv70pfO-_vUFt77-977-9RRo0fO-_ve-_vXHvv73vv70E77-977-9fnxcV0Jt77-9We-_vT1Fau-_vXvvv71-77-977-9MTjvv719OO-_ve-_vRfvv73vv70877-9QArvv73vv70D.OTaX5A-Q82vHG-xELo-_jcU2cpD-vsz_VB3z5twRw3uMkvw-5fagWA_I6U0WBfj0N8KDaiJHCdvpYZHZA4PgEQ\nI20210420-10:48:12.510(-5)?\nI20210420-10:48:12.511(-5)? ------------Decoded Signature-----------------------------\nI20210420-10:48:12.511(-5)?\nI20210420-10:48:12.511(-5)? {\nI20210420-10:48:12.511(-5)?   header: {\nI20210420-10:48:12.511(-5)?     alg: &#39;ES256&#39;,\nI20210420-10:48:12.512(-5)?     zip: &#39;DEF&#39;,\nI20210420-10:48:12.512(-5)?     kid: &#39;K6TznxmRCChF9nZocQEHrfUI3HnUUD4qSJ-JXJQB4_U&#39;\nI20210420-10:48:12.512(-5)?   },\nI20210420-10:48:12.512(-5)?   payload: &#39;}�_o�0\\u0014ſJty\\u0001)��nm�(\\u0005��iL+THh\\u000f�sӚ9v���2��s���\\u0007�R9��w��O ��\\u0012�ε�L��q.\\u0014F-�����vߴN7�\\t\\u001e\\u000b\\r!�u\\rev�MgEq5�C�9�O�k������3l��Ż&quot;�f��i6M��\\n&#39; +\nI20210420-10:48:12.512(-5)?     &#39;�\\u0013Lڤ��!\\u0004�o��X�\\u0011�`k��g\\r�:�lÌ�&quot;�n\\u001bsf*�f&lt;D��_�h�N��d_+��la٭!w�{�\\u0015�\\u001cX�)�&quot;N㌠��NU\\u0012�Ơ՝��mp\\f��)\\u0001p-%�&lt;!\\u0004j`�\\u0014�ȝ�ߍ$��\\u000b#IJ�\\u0013�íc��\\u0003�i%:��v��j�Y�H�jz3\\f���D�w*a[ɨ\\r,��\\u0018�`ɤP�\\u000e�\\u001a\\r*\\u000f���J��)\\u001c�7�;��\\u0019C�u�N�$�g����b��\\u0015s���y\\u0016�E�N\\u0006��\\u000e�q�1��$��\\u0017�r�ڄa�8&gt;;�kЯ\\u0017\\u0005=E;n�BWÓ��\\u0004���2Z|]Ey���?F��]pԆAs;\\u000f\\u0003ۊG\\fZ�\\u001d\\n&#39; +\nI20210420-10:48:12.512(-5)?     &#39;\\u0015\\u00067�w!�Т�)|�Am��E\\u001a4|��q��\\u0004��~|\\\\WBm�Y�=Ej�{�~��18�}8��\\u0017��&lt;�@\\n&#39; +\nI20210420-10:48:12.513(-5)?     &#39;��\\u0003&#39;,\nI20210420-10:48:12.513(-5)?   signature: &#39;OTaX5A-Q82vHG-xELo-_jcU2cpD-vsz_VB3z5twRw3uMkvw-5fagWA_I6U0WBfj0N8KDaiJHCdvpYZHZA4PgEQ&#39;\nI20210420-10:48:12.513(-5)? }\nI20210420-10:48:12.513(-5)?\nI20210420-10:48:12.513(-5)? -------------Is Verified----------------------------------\nI20210420-10:48:12.513(-5)?\nI20210420-10:48:12.843(-5)? YES\nI20210420-10:48:12.844(-5)?\nI20210420-10:48:12.844(-5)? ------------JWS Parts-------------------------------------\nI20210420-10:48:12.844(-5)?\nI20210420-10:48:12.844(-5)? [\nI20210420-10:48:12.844(-5)?   &#39;eyJhbGciOiJFUzI1NiIsInppcCI6IkRFRiIsImtpZCI6Iks2VHpueG1SQ0NoRjluWm9jUUVIcmZVSTNIblVVRDRxU0otSlhKUUI0X1UifQ&#39;,\nI20210420-10:48:12.844(-5)?   &#39;fe-_vV9v77-9MBTFv0p0eQEp77-977-9bm3vv70oBe-_ve-_vWlMK1RIaA_vv71z05o5du-_ve-_ve-_vTLvv73vv71z77-977-977-9B--_vVI577-977-9d--_ve-_vU8g77-977-9Eu-_vc6177-9TO-_ve-_vXEuFEYt77-977-977-977-977-9dt-0Tjfvv70JHgsNIe-_vXUNZXbvv71NZ0VxNe-_vUPvv70577-9T--_vWvvv73vv73vv73vv73vv73vv70zbO-_ve-_vcW7Iu-_vWbvv73vv71pNk3vv73vv70K77-9E0zapO-_ve-_vSEE77-9b--_ve-_vVjvv70R77-9YGvvv73vv71nDe-_vTrvv71sw4zvv70i77-9bhtzZirvv71mPETvv73vv71f77-9aO-_vU7vv73vv71kXyvvv73vv71sYdmtfyF377-9e--_vRXvv70cWO-_vSnvv70iTuOMoO-_ve-_vU5VEu-_vcag1Z3vv73vv71tcAzvv73vv70pAXAtJe-_vTwhBGpg77-9FO-_vcid77-9340k77-977-9CyNJSu-_vRPvv73DrWPvv73vv70D77-9aSU677-977-9du-_ve-_vWrvv71Z77-9SO-_vWp6Mwzvv73vv73vv71E77-9dyphW8moDSzvv73vv70Y77-9YMmkUO-_vQ7vv70aDSoP77-977-977-9Su-_ve-_vSkc77-9N--_vTvvv73vv70ZQ--_vXXvv71O77-9JO-_vWfvv73vv73vv73vv71i77-977-9FXPvv73vv73vv715Fu-_vUXvv71OBu-_ve-_vQ7vv71x77-9Me-_ve-_vSTvv73vv70X77-9cu-_vdqEYe-_vTg-O--_vWvQrxcFPUU7bu-_vUJXw5Pvv73vv70E77-977-977-9Mlp8XUV577-977-977-9P0bvv73vv71dcNSGQXN_Ow8D24pHDFrvv70dChUGN--_vXch77-90KLvv70pfO-_vUFt77-977-9RRo0fO-_ve-_vXHvv73vv70E77-977-9fnxcV0Jt77-9We-_vT1Fau-_vXvvv71-77-977-9MTjvv719OO-_ve-_vRfvv73vv70877-9QArvv73vv70D&#39;,\nI20210420-10:48:12.845(-5)?   &#39;OTaX5A-Q82vHG-xELo-_jcU2cpD-vsz_VB3z5twRw3uMkvw-5fagWA_I6U0WBfj0N8KDaiJHCdvpYZHZA4PgEQ&#39;\nI20210420-10:48:12.845(-5)? ]\nI20210420-10:48:12.845(-5)?\nI20210420-10:48:12.845(-5)? ------------JWS Payload-----------------------------------\nI20210420-10:48:12.846(-5)?\nI20210420-10:48:12.846(-5)? fe-_vV9v77-9MBTFv0p0eQEp77-977-9bm3vv70oBe-_ve-_vWlMK1RIaA_vv71z05o5du-_ve-_ve-_vTLvv73vv71z77-977-977-9B--_vVI577-977-9d--_ve-_vU8g77-977-9Eu-_vc6177-9TO-_ve-_vXEuFEYt77-977-977-977-977-9dt-0Tjfvv70JHgsNIe-_vXUNZXbvv71NZ0VxNe-_vUPvv70577-9T--_vWvvv73vv73vv73vv73vv73vv70zbO-_ve-_vcW7Iu-_vWbvv73vv71pNk3vv73vv70K77-9E0zapO-_ve-_vSEE77-9b--_ve-_vVjvv70R77-9YGvvv73vv71nDe-_vTrvv71sw4zvv70i77-9bhtzZirvv71mPETvv73vv71f77-9aO-_vU7vv73vv71kXyvvv73vv71sYdmtfyF377-9e--_vRXvv70cWO-_vSnvv70iTuOMoO-_ve-_vU5VEu-_vcag1Z3vv73vv71tcAzvv73vv70pAXAtJe-_vTwhBGpg77-9FO-_vcid77-9340k77-977-9CyNJSu-_vRPvv73DrWPvv73vv70D77-9aSU677-977-9du-_ve-_vWrvv71Z77-9SO-_vWp6Mwzvv73vv73vv71E77-9dyphW8moDSzvv73vv70Y77-9YMmkUO-_vQ7vv70aDSoP77-977-977-9Su-_ve-_vSkc77-9N--_vTvvv73vv70ZQ--_vXXvv71O77-9JO-_vWfvv73vv73vv73vv71i77-977-9FXPvv73vv73vv715Fu-_vUXvv71OBu-_ve-_vQ7vv71x77-9Me-_ve-_vSTvv73vv70X77-9cu-_vdqEYe-_vTg-O--_vWvQrxcFPUU7bu-_vUJXw5Pvv73vv70E77-977-977-9Mlp8XUV577-977-977-9P0bvv73vv71dcNSGQXN_Ow8D24pHDFrvv70dChUGN--_vXch77-90KLvv70pfO-_vUFt77-977-9RRo0fO-_ve-_vXHvv73vv70E77-977-9fnxcV0Jt77-9We-_vT1Fau-_vXvvv71-77-977-9MTjvv719OO-_ve-_vRfvv73vv70877-9QArvv73vv70D\nI20210420-10:48:12.846(-5)?\nI20210420-10:48:12.846(-5)? ------------JWS Payload (atob)----------------------------\nI20210420-10:48:12.846(-5)?\nI20210420-10:48:12.846(-5)? }ï¿½_oï¿½0Å¿Jty)ï¿½ï¿½nmï¿½(ï¿½ï¿½iL+THhï¿½sÓ9vï¿½ï¿½ï¿½2ï¿½ï¿½sï¿½ï¿½ï¿½ï¿½R9ï¿½ï¿½wï¿½ï¿½O ï¿½ï¿½ï¿½Îµï¿½Lï¿½ï¿½q.F-ï¿½ï¿½ï¿½ï¿½ï¿½vß´N7ï¿½\nevï¿½MgEq5ï¿½Cï¿½9ï¿½Oï¿½kï¿½ï¿½ï¿½ï¿½ï¿½ï¿½3lï¿½ï¿½Å»&quot;ï¿½fï¿½ï¿½i6Mï¿½ï¿½\nï¿½:ï¿½lÃï¿½&quot;ï¿½nf*ï¿½f&lt;Dï¿½ï¿½_ï¿½hï¿½Nï¿½ï¿½d_+ï¿½ï¿½laÙ­!wï¿½{ï¿½ï¿½Xï¿½)ï¿½&quot;Nã ï¿½ï¿½NUï¿½Æ Õï¿½ï¿½mp\n                                                                                                            ï¿½ï¿½)p-%ï¿½&lt;!j`ï¿½ï¿½Èï¿½ß$ï¿½ï¿½\n                                                                                                                                                 #IJï¿½ï¿½Ã­cï¿½ï¿½ï¿½i%:ï¿½ï¿½vï¿½ï¿½jï¿½Yï¿½Hï¿½jz3\n*ï¿½ï¿½ï¿½Jï¿½ï¿½)ï¿½7ï¿½;ï¿½ï¿½Cï¿½uï¿½Nï¿½$ï¿½gï¿½ï¿½ï¿½ï¿½bï¿½ï¿½sï¿½ï¿½ï¿½yï¿½Eï¿½Nï¿½ï¿½ï¿½qï¿½1ï¿½ï¿½$ï¿½ï¿½ï¿½rï¿½Úaï¿½8&gt;;ï¿½kÐ¯=E;nï¿½BWÃï¿½ï¿½ï¿½ï¿½ï¿½2Z|]Eyï¿½ï¿½ï¿½?Fï¿½ï¿½]pÔAs;ÛG  ï¿½ï¿½ï¿½Dï¿½w*a[É¨\n                                                                                                                                                                                                   Zï¿½\nI20210420-10:48:12.847(-5)? 7ï¿½w!ï¿½Ð¢ï¿½)|ï¿½Amï¿½ï¿½E4|ï¿½ï¿½qï¿½ï¿½ï¿½ï¿½~|\\WBmï¿½Yï¿½=Ejï¿½{ï¿½~ï¿½ï¿½18ï¿½}8ï¿½ï¿½ï¿½ï¿½&lt;ï¿½@\nI20210420-10:48:12.847(-5)? ï¿½ï¿½\nI20210420-10:48:12.847(-5)?\nI20210420-10:48:12.847(-5)? ------------Payload Buffer (atob)-----------------\nI20210420-10:48:12.849(-5)?\nI20210420-10:48:12.850(-5)? &lt;Buffer 7d c3 af c2 bf c2 bd 5f 6f c3 af c2 bf c2 bd 30 14 c3 85 c2 bf 4a 74 79 01 29 c3 af c2 bf c2 bd c3 af c2 bf c2 bd 6e 6d c3 af c2 bf c2 bd 28 05 c3 af ... 1423 more bytes&gt;\nI20210420-10:48:12.850(-5)?\nI20210420-10:48:12.850(-5)? ------------Decompressed Payload--------------------------\nI20210420-10:48:12.851(-5)?\nI20210420-10:48:12.894(-5)? Exception while invoking method &#39;signHealthCard&#39; Error: invalid code lengths set\nI20210420-10:48:12.895(-5)?     at Zlib.zlibOnError [as onerror] (zlib.js:182:17)\nI20210420-10:48:12.895(-5)?     at processChunkSync (zlib.js:431:12)\nI20210420-10:48:12.895(-5)?     at zlibBufferSync (zlib.js:168:12)\nI20210420-10:48:12.895(-5)?     at Object.syncBufferWrapper [as inflateRawSync] (zlib.js:766:14)\nI20210420-10:48:12.895(-5)?     at packages/symptomatic:vaccine-wallet/server/methods.js:326:35\nI20210420-10:48:12.896(-5)?     at /Users/abigailwatson/.meteor/packages/promise/.0.11.2.8skplc.uqog2++os+web.browser+web.browser.legacy+web.cordova/npm/node_modules/meteor-promise/fiber_pool.js:43:40\nI20210420-10:48:12.896(-5)?  =&gt; awaited here:\nI20210420-10:48:12.896(-5)?     at Promise.await (/Users/abigailwatson/.meteor/packages/promise/.0.11.2.8skplc.uqog2++os+web.browser+web.browser.legacy+web.cordova/npm/node_modules/meteor-promise/promise_server.js:60:12)\nI20210420-10:48:12.896(-5)?     at Server.apply (packages/ddp-server/livedata_server.js:1638:22)\nI20210420-10:48:12.896(-5)?     at Server.call (packages/ddp-server/livedata_server.js:1607:17)\nI20210420-10:48:12.896(-5)?     at packages/symptomatic:vaccine-wallet/server/methods.js:238:16\nI20210420-10:48:12.897(-5)?     at /Users/abigailwatson/.meteor/packages/promise/.0.11.2.8skplc.uqog2++os+web.browser+web.browser.legacy+web.cordova/npm/node_modules/meteor-promise/fiber_pool.js:43:40\n</code></pre></div>",
        "id": 235367547,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618933896
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191678\">@Abigail Watson</span> there are a couple of things to check on here.  You want to 1) pass a stringified payload into DEFLATE, 2) pass the binary result of the DEFLATE operation into your JWS signing algorithm as the payload, (e.g., as a Buffer). there's a full <a href=\"https://github.com/smart-on-fhir/health-cards/blob/main/generate-examples/src/index.ts#L63-L70\">example here</a>.</p>",
        "id": 235368214,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618934145
    },
    {
        "content": "<p>You can <strong>get into trouble</strong> in (2) if you do either of the following:</p>\n<ul>\n<li>encode the buffer (e.g. base64url encode it) before passing it into your <code>.sign()</code> step</li>\n<li>stringify the buffer before passing it into your <code>.sign()</code> step</li>\n</ul>",
        "id": 235368766,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618934339
    },
    {
        "content": "<p>Yes, thank you for the example.  It relies on ESM and Typescript, with assumptions around Node versions and how Buffers/Uint8Array work.  Regardless, here's the code going into deflate and zlib that successfully works:</p>\n<div class=\"codehilite\"><pre><span></span><code>let vcPayloadString = JSON.stringify(recordToSign);\nlet vcPayloadString_trimmed = vcPayloadString.trim();\nconsole.log(vcPayloadString_trimmed);\n\nconsole.log(&#39;&#39;);\nconsole.log(&#39;-------------Raw Deflated Payload (Buffer)----------------&#39;)\nconsole.log(&#39;&#39;);\n\nlet deflatedPayload = zlib.deflateRawSync(vcPayloadString_trimmed);\nconsole.log(deflatedPayload);\n\nconsole.log(&#39;&#39;)\nconsole.log(&#39;-------------Raw Deflated Payload (Uint8Array)------------&#39;)\nconsole.log(&#39;&#39;)\nconsole.log(deflatedPayload.buffer);\n\n\nconsole.log(&#39;&#39;)\nconsole.log(&#39;-------------Buffer (Experimental)------------------------&#39;)\nconsole.log(&#39;&#39;)\nconsole.log(Buffer.from(deflatedPayload));\n\nconsole.log(&#39;&#39;);\nconsole.log(&#39;-------------Payload Base64 String------------------------&#39;)\nconsole.log(&#39;&#39;);\n\nlet payload_base64 = deflatedPayload.toString(&#39;base64&#39;);\nconsole.log(payload_base64);\n\nlet json_web_signature = jws.sign({\n    header: { alg: &#39;ES256&#39;, zip: &#39;DEF&#39;, kid: get(keychain, &#39;keys[0].kid&#39;)},\n    secret: privatePem,\n    payload: payload_base64\n    // encoding: &#39;base64&#39;\n});\n</code></pre></div>",
        "id": 235369416,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618934538
    },
    {
        "content": "<p>For example, these would be mistakes:</p>\n<div class=\"codehilite\"><pre><span></span><code>&gt; p = require(&quot;pako&quot;)\n&gt; payloadJson = {&quot;a&quot;: 1};\n&gt; deflated = p.deflateRaw(JSON.stringify(payloadJson))\nUint8Array(10) [\n  171, 86,  74, 84, 178,\n   82, 48, 172,  5,   0\n]\n\n&gt; payload = Buffer.from(deflated)\n&lt;Buffer ab 56 4a 54 b2 52 30 ac 05 00&gt;\n\n&gt; payload_wrong_a = deflated.toString()\n&#39;171,86,74,84,178,82,48,172,5,0&#39;\n\n&gt; payload_wrong_b = payload.toString()\n&#39;�VJT�R0�\\x05\\x00&#39;\n\n&gt; payload_wrong_c = payload.toString(&#39;base64url&#39;)\n&#39;q1ZKVLJSMKwFAA&#39;\n</code></pre></div>",
        "id": 235369492,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618934563
    },
    {
        "content": "<p>You can see (a), (b), and (c) are each wrong (for different reasons).</p>",
        "id": 235369531,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618934581
    },
    {
        "content": "<p>Yes, I've been through many dozens of these alternative errors.</p>",
        "id": 235369642,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618934613
    },
    {
        "content": "<p>OK -- the 1st (<code>payload</code>) should work.</p>",
        "id": 235370675,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618934988
    },
    {
        "content": "<p>As you can see above, I am 1) passing a stringified payload into DEFLATE, and then 2) passing the binary result of the DEFLATE operation into the JWS signing algorithm as the payload, (e.g., as a Buffer).</p>",
        "id": 235370757,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618935008
    },
    {
        "content": "<p>Also, keep in mind that the <code>pako</code> library relies on the latest versions of Node and should probably be considered bleeding-edge with breaking changes.  Not everybody supports ESM or relies on the <code>Uint8Array</code> for zlib signing.</p>",
        "id": 235370846,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618935048
    },
    {
        "content": "<blockquote>\n<p>As you can see above, I am 1) passing a stringified payload into DEFLATE, and then 2) passing the binary result of the DEFLATE operation into the JWS signing algorithm as the payload, (e.g., as a Buffer).</p>\n</blockquote>\n<p>It looks like your'e passing <code>payload_base64</code> into the JWS signing algorithm (as a string, with <code>encoding</code> commented out).</p>\n<blockquote>\n<p>Also, keep in mind that the pako library relies on the latest versions of Node and should probably be considered bleeding-edge </p>\n</blockquote>\n<p>Here's an example using the node <code>zlib</code> built-in, rather than pako, and runs in versions of node back to v10 (oldest Node.js release currently under <a href=\"https://nodejs.org/en/about/releases/\">maintenance</a>) with only one dependency (<code>node-jose</code>): </p>\n<div class=\"codehilite\" data-code-language=\"JavaScript\"><pre><span></span><code><span class=\"c1\">// npm init &amp;&amp; npm install node-jose</span>\n\n<span class=\"kd\">let</span> <span class=\"nx\">zlib</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">'zlib'</span><span class=\"p\">);</span>\n<span class=\"kd\">let</span> <span class=\"nx\">jose</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">'node-jose'</span><span class=\"p\">);</span>\n\n<span class=\"kd\">let</span> <span class=\"nx\">signingKey</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n      <span class=\"s2\">\"kty\"</span><span class=\"o\">:</span> <span class=\"s2\">\"EC\"</span><span class=\"p\">,</span>\n      <span class=\"s2\">\"kid\"</span><span class=\"o\">:</span> <span class=\"s2\">\"3Kfdg-XwP-7gXyywtUfUADwBumDOPKMQx-iELL11W9s\"</span><span class=\"p\">,</span>\n      <span class=\"s2\">\"use\"</span><span class=\"o\">:</span> <span class=\"s2\">\"sig\"</span><span class=\"p\">,</span>\n      <span class=\"s2\">\"alg\"</span><span class=\"o\">:</span> <span class=\"s2\">\"ES256\"</span><span class=\"p\">,</span>\n      <span class=\"s2\">\"crv\"</span><span class=\"o\">:</span> <span class=\"s2\">\"P-256\"</span><span class=\"p\">,</span>\n      <span class=\"s2\">\"x\"</span><span class=\"o\">:</span> <span class=\"s2\">\"11XvRWy1I2S0EyJlyf_bWfw_TQ5CJJNLw78bHXNxcgw\"</span><span class=\"p\">,</span>\n      <span class=\"s2\">\"y\"</span><span class=\"o\">:</span> <span class=\"s2\">\"eZXwxvO1hvCY0KucrPfKo7yAyMT6Ajc3N7OkAB6VYy8\"</span><span class=\"p\">,</span>\n      <span class=\"s2\">\"d\"</span><span class=\"o\">:</span> <span class=\"s2\">\"FvOOk6hMixJ2o9zt4PCfan_UW7i4aOEnzj76ZaCI9Og\"</span>\n    <span class=\"p\">}</span>\n\n<span class=\"nx\">jose</span><span class=\"p\">.</span><span class=\"nx\">JWS</span>\n  <span class=\"p\">.</span><span class=\"nx\">createSign</span><span class=\"p\">({</span> <span class=\"nx\">format</span><span class=\"o\">:</span> <span class=\"s1\">'compact'</span><span class=\"p\">,</span> <span class=\"nx\">fields</span><span class=\"o\">:</span> <span class=\"p\">{</span> <span class=\"nx\">zip</span><span class=\"o\">:</span> <span class=\"s1\">'DEF'</span> <span class=\"p\">}},</span> <span class=\"nx\">signingKey</span><span class=\"p\">)</span>\n  <span class=\"p\">.</span><span class=\"nx\">update</span><span class=\"p\">(</span><span class=\"nx\">zlib</span><span class=\"p\">.</span><span class=\"nx\">deflateRawSync</span><span class=\"p\">(</span><span class=\"nx\">JSON</span><span class=\"p\">.</span><span class=\"nx\">stringify</span><span class=\"p\">({</span><span class=\"s2\">\"iss\"</span><span class=\"o\">:</span> <span class=\"s2\">\"https://example.com\"</span><span class=\"p\">,</span> <span class=\"nx\">vc</span><span class=\"o\">:</span> <span class=\"p\">{}})))</span>\n  <span class=\"p\">.</span><span class=\"kr\">final</span><span class=\"p\">()</span>\n  <span class=\"p\">.</span><span class=\"nx\">then</span><span class=\"p\">(</span><span class=\"kd\">function</span><span class=\"p\">(</span><span class=\"nx\">r</span><span class=\"p\">){</span> <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">r</span><span class=\"p\">);</span> <span class=\"p\">})</span>\n</code></pre></div>",
        "id": 235376060,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618937040
    },
    {
        "content": "<p>^ This is working for me (just tweaked the example generator to use zlib instead of pako in this demo). Let me know what happens when you try this <span class=\"user-mention\" data-user-id=\"191678\">@Abigail Watson</span> ?</p>",
        "id": 235376401,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618937156
    },
    {
        "content": "<p><code>invalid block type</code> error.</p>\n<div class=\"codehilite\"><pre><span></span><code>I20210420-12:41:34.575(-5)? ---------------Verified Credential------------------------\nI20210420-12:41:34.575(-5)?\nI20210420-12:41:34.579(-5)? {\nI20210420-12:41:34.579(-5)?   iss: &#39;http://localhost:3000&#39;,\nI20210420-12:41:34.579(-5)?   nbf: 1618940554,\nI20210420-12:41:34.579(-5)?   vc: {\nI20210420-12:41:34.579(-5)?     &#39;@context&#39;: [ &#39;https://www.w3.org/2018/credentials/v1&#39; ],\nI20210420-12:41:34.580(-5)?     type: [\nI20210420-12:41:34.580(-5)?       &#39;VerifiableCredential&#39;,\nI20210420-12:41:34.580(-5)?       &#39;https://smarthealth.cards#health-card&#39;,\nI20210420-12:41:34.580(-5)?       &#39;https://smarthealth.cards#immunization&#39;\nI20210420-12:41:34.580(-5)?     ],\nI20210420-12:41:34.580(-5)?     credentialSubject: { fhirVersion: &#39;4.0.1&#39;, fhirBundle: [Object] }\nI20210420-12:41:34.580(-5)?   }\nI20210420-12:41:34.580(-5)? }\nI20210420-12:41:34.581(-5)?\nI20210420-12:41:34.581(-5)? ---------------FHIR Bundle--------------------------------\nI20210420-12:41:34.581(-5)?\nI20210420-12:41:34.581(-5)? {\nI20210420-12:41:34.581(-5)?   resourceType: &#39;Bundle&#39;,\nI20210420-12:41:34.581(-5)?   type: &#39;collection&#39;,\nI20210420-12:41:34.582(-5)?   entry: [ { fullUrl: &#39;Immunization/0&#39;, resource: [Object] } ]\nI20210420-12:41:34.582(-5)? }\nI20210420-12:41:34.582(-5)?\nI20210420-12:41:34.582(-5)? ---------------Signing Key (PEM)--------------------------\nI20210420-12:41:34.582(-5)?\nI20210420-12:41:34.582(-5)? {\nI20210420-12:41:34.582(-5)?   kty: &#39;EC&#39;,\nI20210420-12:41:34.582(-5)?   d: &#39;hp2_IVKLNhXUZCqz38TBnp4fHqsMq-dVwxDNhnTtRYI&#39;,\nI20210420-12:41:34.582(-5)?   use: &#39;sig&#39;,\nI20210420-12:41:34.582(-5)?   crv: &#39;P-256&#39;,\nI20210420-12:41:34.583(-5)?   kid: &#39;yRwxp3sb7ldGlbGcw42zkcamMCo_9QZqUqKR6ZFQtH8&#39;,\nI20210420-12:41:34.583(-5)?   x: &#39;ivxR4CWtwm4B0D4Bqbg3YnlQO6SuzF-VFZ66D44IDLA&#39;,\nI20210420-12:41:34.583(-5)?   y: &#39;T6EdDPqAz9sIBrTXaR0KTFlbQsmdCbV4ZpObVo_80MY&#39;,\nI20210420-12:41:34.583(-5)?   alg: &#39;ES256&#39;\nI20210420-12:41:34.583(-5)? }\nI20210420-12:41:34.584(-5)?\nI20210420-12:41:34.584(-5)?\nI20210420-12:41:34.584(-5)? -----------Public Key (.well-known/jwks.json)-------------\nI20210420-12:41:34.584(-5)?\nI20210420-12:41:34.584(-5)? {\nI20210420-12:41:34.584(-5)?   kty: &#39;EC&#39;,\nI20210420-12:41:34.584(-5)?   use: &#39;sig&#39;,\nI20210420-12:41:34.584(-5)?   crv: &#39;P-256&#39;,\nI20210420-12:41:34.585(-5)?   kid: &#39;yRwxp3sb7ldGlbGcw42zkcamMCo_9QZqUqKR6ZFQtH8&#39;,\nI20210420-12:41:34.585(-5)?   x: &#39;ivxR4CWtwm4B0D4Bqbg3YnlQO6SuzF-VFZ66D44IDLA&#39;,\nI20210420-12:41:34.585(-5)?   y: &#39;T6EdDPqAz9sIBrTXaR0KTFlbQsmdCbV4ZpObVo_80MY&#39;,\nI20210420-12:41:34.585(-5)?   alg: &#39;ES256&#39;\nI20210420-12:41:34.585(-5)? }\nI20210420-12:41:34.585(-5)?\nI20210420-12:41:34.585(-5)?\nI20210420-12:41:34.585(-5)? ---------------Stringified Payload------------------------\nI20210420-12:41:34.586(-5)?\nI20210420-12:41:34.586(-5)? {&quot;iss&quot;:&quot;http://localhost:3000&quot;,&quot;nbf&quot;:1618940554,&quot;vc&quot;:{&quot;@context&quot;:[&quot;https://www.w3.org/2018/credentials/v1&quot;],&quot;type&quot;:[&quot;VerifiableCredential&quot;,&quot;https://smarthealth.cards#health-card&quot;,&quot;https://smarthealth.cards#immunization&quot;],&quot;credentialSubject&quot;:{&quot;fhirVersion&quot;:&quot;4.0.1&quot;,&quot;fhirBundle&quot;:{&quot;resourceType&quot;:&quot;Bundle&quot;,&quot;type&quot;:&quot;collection&quot;,&quot;entry&quot;:[{&quot;fullUrl&quot;:&quot;Immunization/0&quot;,&quot;resource&quot;:{&quot;status&quot;:&quot;completed&quot;,&quot;wasNotGiven&quot;:false,&quot;patient&quot;:{&quot;display&quot;:&quot;Candace Salinas&quot;,&quot;reference&quot;:&quot;Patient/100&quot;},&quot;encounter&quot;:{&quot;reference&quot;:&quot;Encounter/129837645&quot;},&quot;date&quot;:&quot;2021-03-05&quot;,&quot;requester&quot;:{&quot;display&quot;:&quot;Altick Kelly&quot;,&quot;reference&quot;:&quot;Practitioner/8&quot;},&quot;reported&quot;:false,&quot;vaccineCode&quot;:{&quot;text&quot;:&quot;SARS-COV-2 (COVID-19) vaccine, mRNA, spike protein, LNP, preservative free, 30 mcg/0.3mL dose&quot;,&quot;coding&quot;:[{&quot;system&quot;:&quot;CVX&quot;,&quot;code&quot;:&quot;208&quot;}]},&quot;resourceType&quot;:&quot;Immunization&quot;}}]}}}}\nI20210420-12:41:34.586(-5)?\nI20210420-12:41:34.586(-5)? -------------Raw Deflated Payload (Buffer)----------------\nI20210420-12:41:34.587(-5)?\nI20210420-12:41:34.587(-5)? &lt;Buffer 7d 92 5f 6f d3 30 14 c5 bf 8a 65 5e 40 ca 1f a7 69 47 9b 27 4a 41 68 62 2a d3 ca 2a 24 b4 07 d7 b9 69 cd 1c 3b d8 4e 4a 99 fa dd b9 4e da 75 da 03 79 ... 439 more bytes&gt;\nI20210420-12:41:34.593(-5)?\nI20210420-12:41:34.593(-5)? ------------JSON Web Signature (JWS)----------------------\nI20210420-12:41:34.593(-5)?\nI20210420-12:41:34.593(-5)? eyJ6aXAiOiJERUYiLCJhbGciOiJFUzI1NiIsImtpZCI6InlSd3hwM3NiN2xkR2xiR2N3NDJ6a2NhbU1Db185UVpxVXFLUjZaRlF0SDgifQ.fZJfb9MwFMW_imVeQMofp2lHmydKQWhiKtPKKiS0B9e5ac0cO9hOSpn63blO2nXaA3mJHJ_7u-fcmycqnaMF3XnfFGmqjOBqZ5wvcsYYjajeVLTIrrLpbMwmk3FEO0GLJ_pBGO3hj6fFz77UYe1-v0_2eWLsNh2xbJoKCyVoL7lyaZfRh4j6QwOhYg1WVpJvFCyeNdjrDHI1t34HXPldIrgt3ZvhEIfDf3Wyrlst_3IvjQ4NLxZW7eYXCB-8Vztp0YELmoKOE5ZkCA1fP7a6VBA0FpxprYDvvWN6ujgnoMIohbRAiCg2sAeMheRWqXurUHD9wkga5ngGBrjz3Leux9SNAg8h1J67pfFfZAfoqsKZQUQbrEd6qCmlaxTHNnTBdckFkBVXUnPXsyuwoAOc3g4laYbbOwZvwrS4KTuEuug-ny_SbDSb5u-vxpOgL7kPtyM2ymKWx2zS43-34E6Mi4-58lI8kq-g1OG1CctxOCE78qeBa6ExNgQ9R-u4EFLDwpT9SIZ_ia7md6t48W0dj8hbfF1_irPZO3LSRqS-W84j4hr5CKSxxoPUEblZ3kZ4Age2w_AdkMoCinNGarFNWZLXN6Q0LqxPmFLqbb8rd8BIdZjn-sdwMwRHuw_H6PUP8HKf9IgKfP4B.LD4pYqgHcsphE5h_-erG8ZG00W8c2U0iH_OVrpzolJ_TGkJ8N9FusTOFVY1WXR1qZsEqNVotyGjrajanffC4Fw\nI20210420-12:41:34.594(-5)?\nI20210420-12:41:34.594(-5)? ================VERIFYING SIGNATURE=======================\nI20210420-12:41:34.594(-5)?\nI20210420-12:41:34.594(-5)? eyJ6aXAiOiJERUYiLCJhbGciOiJFUzI1NiIsImtpZCI6InlSd3hwM3NiN2xkR2xiR2N3NDJ6a2NhbU1Db185UVpxVXFLUjZaRlF0SDgifQ.fZJfb9MwFMW_imVeQMofp2lHmydKQWhiKtPKKiS0B9e5ac0cO9hOSpn63blO2nXaA3mJHJ_7u-fcmycqnaMF3XnfFGmqjOBqZ5wvcsYYjajeVLTIrrLpbMwmk3FEO0GLJ_pBGO3hj6fFz77UYe1-v0_2eWLsNh2xbJoKCyVoL7lyaZfRh4j6QwOhYg1WVpJvFCyeNdjrDHI1t34HXPldIrgt3ZvhEIfDf3Wyrlst_3IvjQ4NLxZW7eYXCB-8Vztp0YELmoKOE5ZkCA1fP7a6VBA0FpxprYDvvWN6ujgnoMIohbRAiCg2sAeMheRWqXurUHD9wkga5ngGBrjz3Leux9SNAg8h1J67pfFfZAfoqsKZQUQbrEd6qCmlaxTHNnTBdckFkBVXUnPXsyuwoAOc3g4laYbbOwZvwrS4KTuEuug-ny_SbDSb5u-vxpOgL7kPtyM2ymKWx2zS43-34E6Mi4-58lI8kq-g1OG1CctxOCE78qeBa6ExNgQ9R-u4EFLDwpT9SIZ_ia7md6t48W0dj8hbfF1_irPZO3LSRqS-W84j4hr5CKSxxoPUEblZ3kZ4Age2w_AdkMoCinNGarFNWZLXN6Q0LqxPmFLqbb8rd8BIdZjn-sdwMwRHuw_H6PUP8HKf9IgKfP4B.LD4pYqgHcsphE5h_-erG8ZG00W8c2U0iH_OVrpzolJ_TGkJ8N9FusTOFVY1WXR1qZsEqNVotyGjrajanffC4Fw\nI20210420-12:41:34.595(-5)?\nI20210420-12:41:34.595(-5)? ------------Decoded Signature-----------------------------\nI20210420-12:41:34.595(-5)?\nI20210420-12:41:34.595(-5)? {\nI20210420-12:41:34.595(-5)?   header: {\nI20210420-12:41:34.595(-5)?     zip: &#39;DEF&#39;,\nI20210420-12:41:34.595(-5)?     alg: &#39;ES256&#39;,\nI20210420-12:41:34.596(-5)?     kid: &#39;yRwxp3sb7ldGlbGcw42zkcamMCo_9QZqUqKR6ZFQtH8&#39;\nI20210420-12:41:34.596(-5)?   },\nI20210420-12:41:34.596(-5)?   payload: &quot;}�_o�0\\u0014ſ�e^@�\\u001f�iG�&#39;JAhb*��*$�\\u0007׹i�\\u001c;�NJ��ݹN�u�\\u0003y�\\u001c����ܛ&#39;*��\\u0005�y�\\u0014i���jg�/r�\\u0018���T�Ȯ��l�&amp;�qD;A�&#39;�A\\u0018�Ꮷ�Ͼ�a�~�O�yb�6\\u001d�l�\\n&quot; +\nI20210420-12:41:34.596(-5)?     `\\u000b%h/�ri�ч��C\\u0003�b\\rVV�o\\u0014,�5��\\fr5�~\\u0007\\\\�]&quot;�-ݛ�\\u0010��u��[-�r/�\\u000e\\r/\\u0016V��\\u0017\\b\\u001f�W;iс\\u000b���\\u0013�d\\b\\r_?��T\\u00104\\u0016�i���cz�8&#39;��(��@�(6�\\u0007���V�{�Pp��H\\u001a�x\\u0006\\u0006��ܷ��ԍ\\u0002\\u000f!Ԟ���_d\\u0007�AD\\u001b�Gz�)�k\\u0014�6t�u�\\u0005�\\u0015WRs׳+��\\u0003��\\u000e%i��;\\u0006o´�);���&gt;�/�l4���Ɠ�/�\\u000f�#6�b��l����N�����R&lt;�����\\t�q8!;�k�16\\u0004=G�\\u0010R��H����w�x�m\\u001d��[|]���;r�F��[�#�\\u001a�\\b��ƃ�\\u0011�Y�Fx\\u0002\\u0007���\\u001d��\\u0002�sFj�MY��7�4.�O�R�m�+w�Hu����p3\\u0004G�\\u000f���\\u000f�r��\\n` +\nI20210420-12:41:34.596(-5)?     &#39;|�\\u0001&#39;,\nI20210420-12:41:34.596(-5)?   signature: &#39;LD4pYqgHcsphE5h_-erG8ZG00W8c2U0iH_OVrpzolJ_TGkJ8N9FusTOFVY1WXR1qZsEqNVotyGjrajanffC4Fw&#39;\nI20210420-12:41:34.596(-5)? }\nI20210420-12:41:34.596(-5)? [\nI20210420-12:41:34.597(-5)?   &#39;eyJ6aXAiOiJERUYiLCJhbGciOiJFUzI1NiIsImtpZCI6InlSd3hwM3NiN2xkR2xiR2N3NDJ6a2NhbU1Db185UVpxVXFLUjZaRlF0SDgifQ&#39;,\nI20210420-12:41:34.597(-5)?   &#39;fZJfb9MwFMW_imVeQMofp2lHmydKQWhiKtPKKiS0B9e5ac0cO9hOSpn63blO2nXaA3mJHJ_7u-fcmycqnaMF3XnfFGmqjOBqZ5wvcsYYjajeVLTIrrLpbMwmk3FEO0GLJ_pBGO3hj6fFz77UYe1-v0_2eWLsNh2xbJoKCyVoL7lyaZfRh4j6QwOhYg1WVpJvFCyeNdjrDHI1t34HXPldIrgt3ZvhEIfDf3Wyrlst_3IvjQ4NLxZW7eYXCB-8Vztp0YELmoKOE5ZkCA1fP7a6VBA0FpxprYDvvWN6ujgnoMIohbRAiCg2sAeMheRWqXurUHD9wkga5ngGBrjz3Leux9SNAg8h1J67pfFfZAfoqsKZQUQbrEd6qCmlaxTHNnTBdckFkBVXUnPXsyuwoAOc3g4laYbbOwZvwrS4KTuEuug-ny_SbDSb5u-vxpOgL7kPtyM2ymKWx2zS43-34E6Mi4-58lI8kq-g1OG1CctxOCE78qeBa6ExNgQ9R-u4EFLDwpT9SIZ_ia7md6t48W0dj8hbfF1_irPZO3LSRqS-W84j4hr5CKSxxoPUEblZ3kZ4Age2w_AdkMoCinNGarFNWZLXN6Q0LqxPmFLqbb8rd8BIdZjn-sdwMwRHuw_H6PUP8HKf9IgKfP4B&#39;,\nI20210420-12:41:34.597(-5)?   &#39;LD4pYqgHcsphE5h_-erG8ZG00W8c2U0iH_OVrpzolJ_TGkJ8N9FusTOFVY1WXR1qZsEqNVotyGjrajanffC4Fw&#39;\nI20210420-12:41:34.597(-5)? ]\nI20210420-12:41:34.597(-5)?\nI20210420-12:41:34.597(-5)? ------------JWS Payload-----------------------------------\nI20210420-12:41:34.597(-5)?\nI20210420-12:41:34.597(-5)? fZJfb9MwFMW_imVeQMofp2lHmydKQWhiKtPKKiS0B9e5ac0cO9hOSpn63blO2nXaA3mJHJ_7u-fcmycqnaMF3XnfFGmqjOBqZ5wvcsYYjajeVLTIrrLpbMwmk3FEO0GLJ_pBGO3hj6fFz77UYe1-v0_2eWLsNh2xbJoKCyVoL7lyaZfRh4j6QwOhYg1WVpJvFCyeNdjrDHI1t34HXPldIrgt3ZvhEIfDf3Wyrlst_3IvjQ4NLxZW7eYXCB-8Vztp0YELmoKOE5ZkCA1fP7a6VBA0FpxprYDvvWN6ujgnoMIohbRAiCg2sAeMheRWqXurUHD9wkga5ngGBrjz3Leux9SNAg8h1J67pfFfZAfoqsKZQUQbrEd6qCmlaxTHNnTBdckFkBVXUnPXsyuwoAOc3g4laYbbOwZvwrS4KTuEuug-ny_SbDSb5u-vxpOgL7kPtyM2ymKWx2zS43-34E6Mi4-58lI8kq-g1OG1CctxOCE78qeBa6ExNgQ9R-u4EFLDwpT9SIZ_ia7md6t48W0dj8hbfF1_irPZO3LSRqS-W84j4hr5CKSxxoPUEblZ3kZ4Age2w_AdkMoCinNGarFNWZLXN6Q0LqxPmFLqbb8rd8BIdZjn-sdwMwRHuw_H6PUP8HKf9IgKfP4B\nI20210420-12:41:34.597(-5)?\nI20210420-12:41:34.598(-5)? ------------Payload Buffer -------------------------------\nI20210420-12:41:34.598(-5)?\nI20210420-12:41:34.598(-5)? &lt;Buffer 66 5a 4a 66 62 39 4d 77 46 4d 57 5f 69 6d 56 65 51 4d 6f 66 70 32 6c 48 6d 79 64 4b 51 57 68 69 4b 74 50 4b 4b 69 53 30 42 39 65 35 61 63 30 63 4f 39 ... 602 more bytes&gt;\nI20210420-12:41:34.598(-5)?\nI20210420-12:41:34.598(-5)? ------------Decompressed Payload--------------------------\nI20210420-12:41:34.598(-5)?\nI20210420-12:41:34.653(-5)? Exception while invoking method &#39;signHealthCard&#39; Error: invalid block type\nI20210420-12:41:34.653(-5)?     at Zlib.zlibOnError [as onerror] (zlib.js:182:17)\n</code></pre></div>",
        "id": 235384744,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618940517
    },
    {
        "content": "<p>Using the following:</p>\n<div class=\"codehilite\" data-code-language=\"JavaScript\"><pre><span></span><code>    <span class=\"kd\">let</span> <span class=\"nx\">vcPayloadString</span> <span class=\"o\">=</span> <span class=\"nx\">JSON</span><span class=\"p\">.</span><span class=\"nx\">stringify</span><span class=\"p\">(</span><span class=\"nx\">recordToSign</span><span class=\"p\">);</span>\n    <span class=\"kd\">let</span> <span class=\"nx\">vcPayloadString_trimmed</span> <span class=\"o\">=</span> <span class=\"nx\">vcPayloadString</span><span class=\"p\">.</span><span class=\"nx\">trim</span><span class=\"p\">();</span>\n    <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">vcPayloadString_trimmed</span><span class=\"p\">);</span>\n\n    <span class=\"kd\">let</span> <span class=\"nx\">deflatedPayload</span> <span class=\"o\">=</span> <span class=\"nx\">zlib</span><span class=\"p\">.</span><span class=\"nx\">deflateRawSync</span><span class=\"p\">(</span><span class=\"nx\">vcPayloadString_trimmed</span><span class=\"p\">);</span>\n    <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">deflatedPayload</span><span class=\"p\">);</span>\n\n    <span class=\"kd\">let</span> <span class=\"nx\">json_web_signature</span> <span class=\"o\">=</span> <span class=\"k\">await</span> <span class=\"nx\">jose</span><span class=\"p\">.</span><span class=\"nx\">JWS</span>\n      <span class=\"p\">.</span><span class=\"nx\">createSign</span><span class=\"p\">({</span> <span class=\"nx\">format</span><span class=\"o\">:</span> <span class=\"s1\">'compact'</span><span class=\"p\">,</span> <span class=\"nx\">fields</span><span class=\"o\">:</span> <span class=\"p\">{</span> <span class=\"nx\">zip</span><span class=\"o\">:</span> <span class=\"s1\">'DEF'</span> <span class=\"p\">}},</span> <span class=\"nx\">signingKey</span><span class=\"p\">)</span>\n      <span class=\"p\">.</span><span class=\"nx\">update</span><span class=\"p\">(</span><span class=\"nx\">deflatedPayload</span><span class=\"p\">)</span>\n      <span class=\"p\">.</span><span class=\"kr\">final</span><span class=\"p\">()</span>\n      <span class=\"p\">.</span><span class=\"nx\">then</span><span class=\"p\">(</span><span class=\"kd\">function</span><span class=\"p\">(</span><span class=\"nx\">result</span><span class=\"p\">){</span>\n        <span class=\"k\">return</span> <span class=\"nx\">result</span><span class=\"p\">;</span>\n      <span class=\"p\">});</span>\n</code></pre></div>",
        "id": 235385097,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618940672
    },
    {
        "content": "<p>And the following on verification and decoding:</p>\n<div class=\"codehilite\" data-code-language=\"JavaScript\"><pre><span></span><code><span class=\"kd\">const</span> <span class=\"nx\">parts</span> <span class=\"o\">=</span> <span class=\"nx\">json_web_signature</span><span class=\"p\">.</span><span class=\"nx\">split</span><span class=\"p\">(</span><span class=\"s1\">'.'</span><span class=\"p\">);</span>\n\n\n<span class=\"kd\">const</span> <span class=\"nx\">rawPayload</span> <span class=\"o\">=</span> <span class=\"nx\">parts</span><span class=\"p\">[</span><span class=\"mf\">1</span><span class=\"p\">].</span><span class=\"nx\">trim</span><span class=\"p\">();</span>\n<span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">rawPayload</span><span class=\"p\">);</span>\n\n<span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">'------------Payload Buffer -------------------------------'</span><span class=\"p\">)</span>\n<span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">''</span><span class=\"p\">)</span>\n\n<span class=\"kd\">let</span> <span class=\"nx\">buffer_from_payload</span> <span class=\"o\">=</span> <span class=\"nx\">Buffer</span><span class=\"p\">.</span><span class=\"nx\">from</span><span class=\"p\">(</span><span class=\"nx\">rawPayload</span><span class=\"p\">);</span>\n<span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">buffer_from_payload</span><span class=\"p\">);</span>\n\n<span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">''</span><span class=\"p\">)</span>\n<span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">'------------Decompressed Payload--------------------------'</span><span class=\"p\">)</span>\n<span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">''</span><span class=\"p\">)</span>\n\n<span class=\"kd\">const</span> <span class=\"nx\">decompressed</span> <span class=\"o\">=</span> <span class=\"nx\">zlib</span><span class=\"p\">.</span><span class=\"nx\">inflateRawSync</span><span class=\"p\">(</span><span class=\"nx\">buffer_from_payload</span><span class=\"p\">);</span>\n<span class=\"kd\">const</span> <span class=\"nx\">decompressed_string</span> <span class=\"o\">=</span> <span class=\"nx\">decompressed</span><span class=\"p\">.</span><span class=\"nx\">toString</span><span class=\"p\">(</span><span class=\"s1\">'utf8'</span><span class=\"p\">)</span>\n<span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">decompressed_string</span><span class=\"p\">);</span>\n</code></pre></div>",
        "id": 235385355,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618940779
    },
    {
        "content": "<p>As an aside, I'd like to point out that <code>node-jose</code> has 200K weekly downloads, whereas the <code>jws</code> library has 8.8M weekly downloads.  </p>\n<p>When I say that the 'base64' encoding is used in some places, it's per the document examples and recommendations from the <code>jws</code> library itself.  base64 string encoding is what's recommended and works, not something that I just came up with.  People who are recommending 'just put the Buffer directly into the signing algorithm' are assuming and relying on the presence of newer technology and libraries; no different than assuming a particular model of high-end camera.  </p>\n<p>Why does the spec require the latest Node libraries and TypeScript/ESM and Buffer signatures, but not the stringified base64 signatures that are recommended by a library with 10x more users?  Why do we require compression using an 'old-phones' argument, but not base64 encoded strings?</p>",
        "id": 235387005,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618941492
    },
    {
        "content": "<p>Forced base64 encoding would increase the payload size and decrease the amount of data available in the QR code.</p>",
        "id": 235392565,
        "sender_full_name": "Matt Printz",
        "timestamp": 1618943581
    },
    {
        "content": "<p>Yet it's much more widely supported across environments.  Why have we decided that 20% payload size is more important than ubiquity of library use?</p>",
        "id": 235393404,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618943908
    },
    {
        "content": "<p>For those who are interested, reference implementation in pure ECMAScript available here (not Typescript):<br>\n<a href=\"https://github.com/symptomatic/smart-healthcard-payload-utility\">https://github.com/symptomatic/smart-healthcard-payload-utility</a></p>",
        "id": 235396359,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618945041
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191678\">@Abigail Watson</span> Your JWS value you're creating above: <code>eyJ6aXAiOiJERUYiLCJh...jrajanffC4Fw</code> decompresses fine for me. (Can't validate since issuer is 'localhost:3000' and I don't have the public key.</p>",
        "id": 235397098,
        "sender_full_name": "Matt Printz",
        "timestamp": 1618945320
    },
    {
        "content": "<p>What happens if you comment out this line: <code>const parts = json_web_signature.split('.');</code> and just use json_web_signature as the raw payload?</p>",
        "id": 235397326,
        "sender_full_name": "Matt Printz",
        "timestamp": 1618945398
    },
    {
        "content": "<p>Are you asking why we don't double-base-64-encode the DEFLATE-compressed data,  or are you asking why we need compression in the first place?</p>",
        "id": 235398408,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618945798
    },
    {
        "content": "<p>A little bit of both.  I'm suggesting that the compression requirement isn't as seamless and easy to implement in all environments as presented, and has cost/benefits.</p>",
        "id": 235399706,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618946331
    },
    {
        "content": "<p>Sure -- this comes down to QR scanning on commodity hardware including smartphones -- more data are hard to represent at small physical sizes, and require a steadier hand to scan, etc</p>",
        "id": 235402042,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618947264
    },
    {
        "content": "<p>BTW with the <code>node-jws</code> library you mentioned, it's popular but doesn't seem to be actively developed. There's a bugfix that landed in <code>master</code> 3 year ago for this issue (see <a href=\"https://github.com/auth0/node-jws/issues/50\">https://github.com/auth0/node-jws/issues/50</a> for details). If you really want to use this you can:</p>\n<div class=\"codehilite\" data-code-language=\"JavaScript\"><pre><span></span><code><span class=\"c1\">// install from GH master branch rather than npm repository</span>\n<span class=\"c1\">// npm install https://github.com/auth0/node-jws</span>\n\n<span class=\"kd\">let</span> <span class=\"nx\">zlib</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">'zlib'</span><span class=\"p\">);</span>\n<span class=\"kd\">let</span> <span class=\"nx\">jws</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">'jws'</span><span class=\"p\">);</span>\n<span class=\"kd\">const</span> <span class=\"p\">{</span> <span class=\"nx\">generateKeyPairSync</span> <span class=\"p\">}</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">'crypto'</span><span class=\"p\">);</span>\n\n<span class=\"kd\">let</span> <span class=\"nx\">keys</span> <span class=\"o\">=</span> <span class=\"nx\">generateKeyPairSync</span><span class=\"p\">(</span><span class=\"s2\">\"ec\"</span><span class=\"p\">,{</span><span class=\"nx\">namedCurve</span><span class=\"o\">:</span> <span class=\"s1\">'P-256'</span><span class=\"p\">})</span>\n<span class=\"kd\">let</span> <span class=\"nx\">payload</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"nx\">iss</span><span class=\"o\">:</span> <span class=\"s2\">\"https://example.com\"</span><span class=\"p\">,</span> <span class=\"nx\">vc</span><span class=\"o\">:</span> <span class=\"p\">{}}</span>\n\n<span class=\"kd\">const</span> <span class=\"nx\">signature</span> <span class=\"o\">=</span> <span class=\"nx\">jws</span><span class=\"p\">.</span><span class=\"nx\">sign</span><span class=\"p\">({</span>\n  <span class=\"nx\">header</span><span class=\"o\">:</span> <span class=\"p\">{</span> <span class=\"nx\">alg</span><span class=\"o\">:</span> <span class=\"s1\">'ES256'</span><span class=\"p\">,</span> <span class=\"nx\">zip</span><span class=\"o\">:</span> <span class=\"s1\">'DEF'</span><span class=\"p\">,</span> <span class=\"nx\">kid</span><span class=\"o\">:</span> <span class=\"s2\">\"placeholder for kid\"</span><span class=\"p\">},</span>\n  <span class=\"nx\">payload</span><span class=\"o\">:</span><span class=\"nx\">zlib</span><span class=\"p\">.</span><span class=\"nx\">deflateRawSync</span><span class=\"p\">(</span><span class=\"nx\">JSON</span><span class=\"p\">.</span><span class=\"nx\">stringify</span><span class=\"p\">(</span><span class=\"nx\">payload</span><span class=\"p\">)).</span><span class=\"nx\">toString</span><span class=\"p\">(</span><span class=\"s1\">'base64'</span><span class=\"p\">),</span>\n  <span class=\"nx\">privateKey</span><span class=\"o\">:</span> <span class=\"nx\">keys</span><span class=\"p\">.</span><span class=\"nx\">privateKey</span><span class=\"p\">,</span>\n  <span class=\"nx\">encoding</span><span class=\"o\">:</span> <span class=\"s1\">'base64'</span>\n<span class=\"p\">});</span>\n\n<span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s2\">\"jws\"</span><span class=\"p\">,</span> <span class=\"nx\">signature</span><span class=\"p\">)</span>\n</code></pre></div>",
        "id": 235402599,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618947498
    },
    {
        "content": "<p>:sigh:</p>",
        "id": 235403008,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618947669
    },
    {
        "content": "<p>(and double-sigh -- I just had to edit the example above to add <code>.toString(base64)</code> + <code>encoding:  'base64'</code>, sorry I missed this initially. the <code>node-jws</code> API is not the most intuitive!)</p>",
        "id": 235403280,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618947796
    },
    {
        "content": "<p>Well, I managed to get something working with <code>node-jose</code> and <code>zlib</code>.  Reference example here:<br>\n<a href=\"https://github.com/symptomatic/smart-healthcard-payload-utility/tree/node-jose-and-zlib\">https://github.com/symptomatic/smart-healthcard-payload-utility/tree/node-jose-and-zlib</a></p>\n<p>1359 character count on the <code>shc:/</code></p>",
        "id": 235411413,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618951278
    },
    {
        "content": "<p>Generating the QR code now.</p>",
        "id": 235412656,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618951790
    },
    {
        "content": "<p>Boom, <code>unsupported algorithm</code> error again with <code>jose.JWS.createSign()</code></p>\n<div class=\"codehilite\"><pre><span></span><code>I20210420-15:56:02.438(-5)? ---------------Verified Credential------------------------\nI20210420-15:56:02.438(-5)?\nI20210420-15:56:02.444(-5)? {\nI20210420-15:56:02.444(-5)?   iss: &#39;https://vaccine-passport.symptomatic.io&#39;,\nI20210420-15:56:02.444(-5)?   nbf: 1618952222,\nI20210420-15:56:02.444(-5)?   vc: {\nI20210420-15:56:02.445(-5)?     &#39;@context&#39;: [ &#39;https://www.w3.org/2018/credentials/v1&#39; ],\nI20210420-15:56:02.445(-5)?     type: [\nI20210420-15:56:02.445(-5)?       &#39;VerifiableCredential&#39;,\nI20210420-15:56:02.445(-5)?       &#39;https://smarthealth.cards#health-card&#39;,\nI20210420-15:56:02.445(-5)?       &#39;https://smarthealth.cards#immunization&#39;\nI20210420-15:56:02.446(-5)?     ],\nI20210420-15:56:02.446(-5)?     credentialSubject: { fhirVersion: &#39;4.0.1&#39;, fhirBundle: [Object] }\nI20210420-15:56:02.446(-5)?   }\nI20210420-15:56:02.446(-5)? }\nI20210420-15:56:02.446(-5)?\nI20210420-15:56:02.447(-5)? ---------------FHIR Bundle--------------------------------\nI20210420-15:56:02.447(-5)?\nI20210420-15:56:02.447(-5)? {\nI20210420-15:56:02.448(-5)?   resourceType: &#39;Bundle&#39;,\nI20210420-15:56:02.448(-5)?   type: &#39;collection&#39;,\nI20210420-15:56:02.448(-5)?   entry: [ { fullUrl: &#39;Immunization/0&#39;, resource: [Object] } ]\nI20210420-15:56:02.448(-5)? }\nI20210420-15:56:02.448(-5)?\nI20210420-15:56:02.449(-5)? ---------------Signing Key (PEM)--------------------------\nI20210420-15:56:02.449(-5)?\nI20210420-15:56:02.449(-5)? {\nI20210420-15:56:02.449(-5)?   kty: &#39;EC&#39;,\nI20210420-15:56:02.449(-5)?   use: &#39;sig&#39;,\nI20210420-15:56:02.449(-5)?   crv: &#39;P-256&#39;,\nI20210420-15:56:02.450(-5)?   kid: &#39;yRwxp3sb7ldGlbGcw42zkcamMCo_9QZqUqKR6ZFQtH8&#39;,\nI20210420-15:56:02.450(-5)?   x: &#39;ivxR4CWtwm4B0D4Bqbg3YnlQO6SuzF-VFZ66D44IDLA&#39;,\nI20210420-15:56:02.450(-5)?   y: &#39;T6EdDPqAz9sIBrTXaR0KTFlbQsmdCbV4ZpObVo_80MY&#39;,\nI20210420-15:56:02.450(-5)?   alg: &#39;ES256&#39;\nI20210420-15:56:02.450(-5)? }\nI20210420-15:56:02.451(-5)?\nI20210420-15:56:02.451(-5)?\nI20210420-15:56:02.451(-5)? -----------Public Key (.well-known/jwks.json)-------------\nI20210420-15:56:02.451(-5)?\nI20210420-15:56:02.451(-5)? {\nI20210420-15:56:02.451(-5)?   kty: &#39;EC&#39;,\nI20210420-15:56:02.451(-5)?   use: &#39;sig&#39;,\nI20210420-15:56:02.452(-5)?   crv: &#39;P-256&#39;,\nI20210420-15:56:02.452(-5)?   kid: &#39;yRwxp3sb7ldGlbGcw42zkcamMCo_9QZqUqKR6ZFQtH8&#39;,\nI20210420-15:56:02.453(-5)?   x: &#39;ivxR4CWtwm4B0D4Bqbg3YnlQO6SuzF-VFZ66D44IDLA&#39;,\nI20210420-15:56:02.453(-5)?   y: &#39;T6EdDPqAz9sIBrTXaR0KTFlbQsmdCbV4ZpObVo_80MY&#39;,\nI20210420-15:56:02.453(-5)?   alg: &#39;ES256&#39;\nI20210420-15:56:02.453(-5)? }\nI20210420-15:56:02.453(-5)?\nI20210420-15:56:02.453(-5)?\nI20210420-15:56:02.454(-5)? ---------------Stringified Payload------------------------\nI20210420-15:56:02.454(-5)?\nI20210420-15:56:02.455(-5)? {&quot;iss&quot;:&quot;https://vaccine-passport.symptomatic.io&quot;,&quot;nbf&quot;:1618952222,&quot;vc&quot;:{&quot;@context&quot;:[&quot;https://www.w3.org/2018/credentials/v1&quot;],&quot;type&quot;:[&quot;VerifiableCredential&quot;,&quot;https://smarthealth.cards#health-card&quot;,&quot;https://smarthealth.cards#immunization&quot;],&quot;credentialSubject&quot;:{&quot;fhirVersion&quot;:&quot;4.0.1&quot;,&quot;fhirBundle&quot;:{&quot;resourceType&quot;:&quot;Bundle&quot;,&quot;type&quot;:&quot;collection&quot;,&quot;entry&quot;:[{&quot;fullUrl&quot;:&quot;Immunization/0&quot;,&quot;resource&quot;:{&quot;status&quot;:&quot;completed&quot;,&quot;wasNotGiven&quot;:false,&quot;patient&quot;:{&quot;display&quot;:&quot;Candace Salinas&quot;,&quot;reference&quot;:&quot;Patient/100&quot;},&quot;encounter&quot;:{&quot;reference&quot;:&quot;Encounter/129837645&quot;},&quot;date&quot;:&quot;2021-03-05&quot;,&quot;requester&quot;:{&quot;display&quot;:&quot;Altick Kelly&quot;,&quot;reference&quot;:&quot;Practitioner/8&quot;},&quot;reported&quot;:false,&quot;vaccineCode&quot;:{&quot;text&quot;:&quot;SARS-COV-2 (COVID-19) vaccine, mRNA, spike protein, LNP, preservative free, 30 mcg/0.3mL dose&quot;,&quot;coding&quot;:[{&quot;system&quot;:&quot;CVX&quot;,&quot;code&quot;:&quot;208&quot;}]},&quot;resourceType&quot;:&quot;Immunization&quot;}}]}}}}\nI20210420-15:56:02.455(-5)?\nI20210420-15:56:02.455(-5)? -------------Raw Deflated Payload (Buffer)----------------\nI20210420-15:56:02.455(-5)?\nI20210420-15:56:02.456(-5)? &lt;Buffer 7d 92 cd 6e db 30 10 84 5f 45 d8 5e 5a 40 ff 8e 53 5b a7 ba 6e 51 04 0d dc 20 4e 8c 02 45 0e 34 b5 b2 d9 50 a4 4a 52 72 dc c0 ef de a5 64 c7 41 0e e5 ... 445 more bytes&gt;\nI20210420-15:56:02.465(-5)? Exception while invoking method &#39;signHealthCard&#39; Error: unsupported algorithm\nI20210420-15:56:02.470(-5)?     at JWKBaseKeyObject.value (/Volumes/FhirCode/Code/Covid19/vaccine-passport/packages/vaccine-wallet/.npm/package/node_modules/node-jose/lib/jwk/basekey.js:455:31)\nI20210420-15:56:02.470(-5)?     at /Volumes/FhirCode/Code/Covid19/vaccine-passport/packages/vaccine-wallet/.npm/package/node_modules/node-jose/lib/jws/sign.js:142:21\nI20210420-15:56:02.470(-5)?     at Array.map (&lt;anonymous&gt;)\nI20210420-15:56:02.470(-5)?     at /Volumes/FhirCode/Code/Covid19/vaccine-passport/packages/vaccine-wallet/.npm/package/node_modules/node-jose/lib/jws/sign.js:118:21\nI20210420-15:56:02.470(-5)?     at /Users/abigailwatson/.meteor/packages/promise/.0.11.2.8skplc.uqog2++os+web.browser+web.browser.legacy+web.cordova/npm/node_modules/meteor-promise/fiber_pool.js:43:40\nI20210420-15:56:02.471(-5)?  =&gt; awaited here:\nI20210420-15:56:02.471(-5)?     at Function.Promise.await (/Users/abigailwatson/.meteor/packages/promise/.0.11.2.8skplc.uqog2++os+web.browser+web.browser.legacy+web.cordova/npm/node_modules/meteor-promise/promise_server.js:56:12)\nI20210420-15:56:02.471(-5)?     at packages/symptomatic:vaccine-wallet/server/methods.js:197:31\nI20210420-15:56:02.471(-5)?     at /Users/abigailwatson/.meteor/packages/promise/.0.11.2.8skplc.uqog2++os+web.browser+web.browser.legacy+web.cordova/npm/node_modules/meteor-promise/fiber_pool.js:43:40\n</code></pre></div>",
        "id": 235413748,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618952233
    },
    {
        "content": "<p>I see this is open source? Can you share a minimal reproducible example as a GH link?</p>",
        "id": 235434300,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618963001
    },
    {
        "content": "<p>e.g. is there a script I can run to get this error? I'm happy to help debug.</p>",
        "id": 235434360,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618963048
    },
    {
        "content": "<p>Minimal reproduction is at:<br>\n<a href=\"https://github.com/symptomatic/smart-healthcard-payload-utility\">https://github.com/symptomatic/smart-healthcard-payload-utility</a></p>",
        "id": 235434706,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618963260
    },
    {
        "content": "<blockquote>\n<p>meteor npm install</p>\n</blockquote>\n<p>Is meteor available through npm, or do I need to install it separately? Do you have a docker environment that works well for this?</p>",
        "id": 235434833,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618963343
    },
    {
        "content": "<p>Or, would it be possible to add a failing test to <a href=\"https://github.com/symptomatic/smart-healthcard-payload-utility/blob/master/tests/main.js\">https://github.com/symptomatic/smart-healthcard-payload-utility/blob/master/tests/main.js</a> ?</p>",
        "id": 235434871,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618963383
    },
    {
        "content": "<p>Other way around.  Meteor is a build pipeline tool, and orchestrates different versions of npm, bower, cordova, etc.    At one point in time it was positioned as .Net for Javascript.</p>",
        "id": 235434949,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618963428
    },
    {
        "content": "<p>And you know...  I'm a bit frustrated right now, but I also need to step back and think whether this functionality goes into a package, or in the main repo.  It's occurring to me that the <code>unsupported algorithm</code> from <code>node-jose</code> is occurring from within a meteor specific package.  Which reiterates my original point, but is also a clue in how to maybe architect around it.</p>",
        "id": 235435272,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618963679
    },
    {
        "content": "<p>Hmm, I'm not sure I'm following. It'd certainly be nice for the issuance logic (signatures, etc) not to depend on Meteor.</p>",
        "id": 235435386,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618963737
    },
    {
        "content": "<p>Agreed (although the same could be said of typescript and ESM).  </p>\n<p>Well, just like you started with first assumptions (i.e. minification, typescript, etc), I've started some first-assumption... hoists into an application environment, supports plugin architecture, etc.  I'm trying to parse through those assumptions.</p>\n<p>Before you dig into the meteor repo, let me rewind to 15:49 above, and generate the QR code another way.  I want to give it a second try, without using the Meteor plugin architecture.</p>",
        "id": 235435820,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618964008
    },
    {
        "content": "<p>(I shared an example above that uses Node v10 an pure JS.)</p>",
        "id": 235435889,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618964058
    },
    {
        "content": "<blockquote>\n<p>Before you dig into the meteor repo, let me rewind </p>\n</blockquote>\n<p>OK. In the background I'm apparently (still!) compiling Mongodb as a prereq for meteor (?) ;-)</p>",
        "id": 235435919,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618964092
    },
    {
        "content": "<p>Right, but even if it's pure JS, which linker you use can result in different results.</p>",
        "id": 235435945,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618964107
    },
    {
        "content": "<p>Meteor will provide its own mongo.</p>",
        "id": 235435977,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618964130
    },
    {
        "content": "<p>What do you mean by \"linker\" here? (I was just executing <a href=\"#narrow/stream/284830-smart.2Fhealth-cards/topic/SHC.20Pre-event.20Discussion/near/235402599\">my example script</a> with <code>node test.js</code>)</p>",
        "id": 235435980,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618964132
    },
    {
        "content": "<p>Meteor is a compiler, like XCode or VisualStudio.  It handles all sorts of build pipelines.... babel, webpack, npm, bower, cordova.... and spits out a tech stack and web application framework.  Originally developed my MIT alumni.</p>",
        "id": 235436003,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618964147
    },
    {
        "content": "<p>Apparently the mongo that meteor is providing me (through <a href=\"https://aur.archlinux.org/packages/meteor/\">https://aur.archlinux.org/packages/meteor/</a>) is a the mongo I compile myself :p</p>",
        "id": 235436051,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618964166
    },
    {
        "content": "<p><a href=\"https://www.meteor.com/developers/install\">https://www.meteor.com/developers/install</a></p>",
        "id": 235436133,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618964239
    },
    {
        "content": "<p>I'm not super happy with <code>curl https://install.meteor.com/ | sh</code> ;-)</p>",
        "id": 235436169,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618964275
    },
    {
        "content": "<p>But we'll see what my package manager gives me when it finishes.</p>",
        "id": 235436244,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618964301
    },
    {
        "content": "<p>Okay, that got a belly laugh.  Yeah, that <code>curl</code> statement is an MIT affectation.  Been there since day 1.  I didn't have anything to do with it.</p>",
        "id": 235436265,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618964327
    },
    {
        "content": "<p>FWIW when I run <code>meteor run</code> and launch <a href=\"http://localhost:3000\">http://localhost:3000</a> and click the button, I get an alert with a Health Card (no errors).</p>",
        "id": 235437850,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618965491
    },
    {
        "content": "<p>Oh, maybe I'm on the wrong branch though</p>",
        "id": 235437861,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618965499
    },
    {
        "content": "<p>(This is <code>master</code>.)</p>",
        "id": 235437878,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618965520
    },
    {
        "content": "<p>Yeah, the master branch is using base64 encoding.  Er, double encoding, I suppose.</p>",
        "id": 235437908,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618965552
    },
    {
        "content": "<p>The <code>jws-and-zlib</code> branch is as close as I got to removing the extra <code>base64</code> encoding.</p>",
        "id": 235437993,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618965619
    },
    {
        "content": "<p><a href=\"https://github.com/jmandel/smart-healthcard-payload-utility/tree/jws-and-zlib\">https://github.com/jmandel/smart-healthcard-payload-utility/tree/jws-and-zlib</a> builds on that one with the fixes I needed (same technique as my jws + zlib example above). Note that I had to strip out the <code>.vc</code> claim contents because there were some issues there that I didn't want to debug at this stage.</p>",
        "id": 235439356,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618966914
    },
    {
        "content": "<p>Right.  Whether it's <code>btoa</code> or <code>.toString(\"base64\")</code>, it works when it's cast to base64 of some sort.  Pretty sure it will break the validator though.  This solution is using Buffers, not the more strict Uint8Array approach.</p>",
        "id": 235439759,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618967252
    },
    {
        "content": "<p>The example in my branch passes the validator (up to the fhirBundle steps).</p>",
        "id": 235440055,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618967520
    },
    {
        "content": "<p>!</p>",
        "id": 235440136,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618967572
    },
    {
        "content": "<p>the <code>encoding</code> has to match the <code>.toString(encoding)</code>.</p>",
        "id": 235440138,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618967573
    },
    {
        "content": "<p>Yeah???</p>",
        "id": 235440143,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618967580
    },
    {
        "content": "<p>And you need <a href=\"https://github.com/jmandel/smart-healthcard-payload-utility/commit/c89a634e7dc9caa5e494d071261d64eb5fca9f2a#diff-d3f9f1ac91aa1bf0f85894eb43eb424f26c61fd0e44eeb8c0787f48a0ba511ecR130\">node-jws from github</a>, not from npm</p>",
        "id": 235440162,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618967599
    },
    {
        "content": "<p>Ah, the one with the bugfix?</p>",
        "id": 235440192,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618967637
    },
    {
        "content": "<p><a href=\"https://github.com/jmandel/smart-healthcard-payload-utility/commit/c89a634e7dc9caa5e494d071261d64eb5fca9f2a\">https://github.com/jmandel/smart-healthcard-payload-utility/commit/c89a634e7dc9caa5e494d071261d64eb5fca9f2a</a> has the full set of changes (but there's a bit of line noise in package.json; the only important change was from <code>\"jws\": \"4.0.0\"</code> to <code>\"jws\": \"github:auth0/node-jws\",</code></p>",
        "id": 235440255,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618967665
    },
    {
        "content": "<p>Jinkies!  What's that syntax????  Is that GitHub packages?</p>",
        "id": 235440311,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618967725
    },
    {
        "content": "<p>Yeah, that means \"Get the current default branch from GH\"</p>",
        "id": 235440324,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618967742
    },
    {
        "content": "<p>And that has the bugfix merged in?  That hasn't been published to NPM?</p>",
        "id": 235440383,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618967768
    },
    {
        "content": "<p>Correct -- see my <a href=\"#narrow/stream/284830-smart.2Fhealth-cards/topic/SHC.20Pre-event.20Discussion/near/235402599\">links above</a>!</p>",
        "id": 235440418,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618967820
    },
    {
        "content": "<p>Got lucky, then; because that branch might not have been merged in.  Super cool, nonetheless.  Also, that qualifies as some serious git-fu.</p>",
        "id": 235440461,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618967867
    },
    {
        "content": "<p>(Learning something new today)</p>",
        "id": 235440471,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618967882
    },
    {
        "content": "<p>Haven't been able to replicate the successful validation test yet (<a href=\"https://github.com/microsoft/health-cards-validation-SDK/issues/67\">see issue #67</a>),  but generated the following QR code using the updated library:</p>\n<p><a href=\"/user_uploads/10155/avmjZQOswuISL8ZXxp63_Cbo/Screen-Shot-2021-04-20-at-8.33.34-PM.png\">Screen-Shot-2021-04-20-at-8.33.34-PM.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/avmjZQOswuISL8ZXxp63_Cbo/Screen-Shot-2021-04-20-at-8.33.34-PM.png\" title=\"Screen-Shot-2021-04-20-at-8.33.34-PM.png\"><img src=\"/user_uploads/10155/avmjZQOswuISL8ZXxp63_Cbo/Screen-Shot-2021-04-20-at-8.33.34-PM.png\"></a></div>",
        "id": 235441559,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618968900
    },
    {
        "content": "<p>That QR looks like &gt;V22, BTW. (The validator should pick that up when you get to it.)</p>",
        "id": 235441702,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618969034
    },
    {
        "content": "<p>1717 characters.  But I can trim some of the JSON content down.</p>",
        "id": 235441911,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618969261
    },
    {
        "content": "<p>1711 JWS chars, or numeric encoding chars?</p>",
        "id": 235442111,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618969447
    },
    {
        "content": "<p>Numeric encoding chars.</p>",
        "id": 235442307,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618969635
    },
    {
        "content": "<p>It's suppose to be &lt;1200 numeric, right?</p>",
        "id": 235442346,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618969661
    },
    {
        "content": "<p>&lt;~1200 JWS characters, which is &lt;~2400 digits</p>",
        "id": 235442410,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618969715
    },
    {
        "content": "<p>(but this only works if you use numeric encoding for this segment of your QR -- if you use binary encoding for the digits, you spend 8 bits on each.)</p>",
        "id": 235442455,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618969786
    },
    {
        "content": "<p>Okay, another QR code:<br>\n<a href=\"/user_uploads/10155/R-K0IDStKQ9HTU-Otcxz6_20/Screen-Shot-2021-04-20-at-10.10.41-PM.png\">Screen-Shot-2021-04-20-at-10.10.41-PM.png</a> </p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/R-K0IDStKQ9HTU-Otcxz6_20/Screen-Shot-2021-04-20-at-10.10.41-PM.png\" title=\"Screen-Shot-2021-04-20-at-10.10.41-PM.png\"><img src=\"/user_uploads/10155/R-K0IDStKQ9HTU-Otcxz6_20/Screen-Shot-2021-04-20-at-10.10.41-PM.png\"></a></div><p>And the JWS for it:</p>\n<div class=\"codehilite\"><pre><span></span><code>eyJhbGciOiJFUzI1NiIsInppcCI6IkRFRiIsImtpZCI6InlSd3hwM3NiN2xkR2xiR2N3NDJ6a2NhbU1Db185UVpxVXFLUjZaRlF0SDgifQ.dZFPbxMxEMW_ijVcQPJudpNS2r2VcKlUFdRAhIR6cO1JY_A_ebwRocp373iTogoJX1az8-Y3z89PYIlggG0piYbZbKe0tgGbpIhSzKWlvU8lelWsbm0ECeFhA0N_3l9cfjg77xYSdhqGJyj7hDD8-Asir3LZonJl22qVDb05Fk0tGPN_nfV-DPYPb4wB7iXojAZDscqtxoefqEtdt9navMZMVTPAWdu1PUPr349jMA6rJiPFMWv8OlmDU0OerIKOzjGtEiTwgrxn_0wenfuWHQte5oeOBS9FBVNRZaQJ4ZPDgvVCiQ0zpfaNpeQU42CpglEaxUo5GxRNnA1mDBX0esGBczxGv4xmWlLwN8NgdXW3apaf181cvOXP9aemv3wnTlop_N3tlRSU7C8UKceCNkhxc_tFcoWEeceudig2GVm86ITXj7OuXfgbYSLVMHQ0NjxON6c9FfTV9fr7sVNNzrsLONwf5L9xXr9-ptrVMRtOok7M-6ZbNN17OPAkn2c.xyphEsnZ2axUwFTd_72gdIOY8JecQdSvhM9zcs4o--HW_wC4Wns_4sIeffXcD0C-0ZDfXqaf4iP02fFbiT1L2A\n</code></pre></div>\n<p>Validator is complaining about wrong number of QR segments and the <code>kid</code> in the thumbprint.  But the entire notion of multi-segment QR codes is a bit questionable to begin with, and visual inspection of the kid from the <code>jws.decode()</code> show that it's correct.   So, I'm calling it done for the time being.  I've spent a week longer than anticipated dealing with this validator's questionable assumptions and demands, and am frustrated with it and this IG and its premises.  I've got to put this down and concentrate on other things for a bit.  </p>\n<p><a href=\"/user_uploads/10155/3SMe54UXxnbftQZxq91y4AoT/Screen-Shot-2021-04-20-at-10.12.53-PM.png\">Screen-Shot-2021-04-20-at-10.12.53-PM.png</a> </p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/3SMe54UXxnbftQZxq91y4AoT/Screen-Shot-2021-04-20-at-10.12.53-PM.png\" title=\"Screen-Shot-2021-04-20-at-10.12.53-PM.png\"><img src=\"/user_uploads/10155/3SMe54UXxnbftQZxq91y4AoT/Screen-Shot-2021-04-20-at-10.12.53-PM.png\"></a></div><p>Thank you for the help and patience, Josh.  I appreciate the help more than I'm probably able to articulate right now.</p>",
        "id": 235449040,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1618975839
    },
    {
        "content": "<p>Thsnks Abigail for the feedback and pushing through this! Keep in mind that the validator is a work in progress, and the team has built several enhancement based on connectathon feedback. It's always helpful to separate out issues of 1) \"I think the validator is giving me an incorrect result\" from 2) \"I disagree with a design decision in the spec that the validator is enforcing\".</p>\n<p>For the errors above, it looks like your <code>kid</code> may not be a properly computed JWK thumbprint, and like your QR uses one segment instead of two segments. So I think the validator is doing its job, and your comments are in category (2) -- but please correct me if that's wrong (I'm looking through these by eye only).</p>",
        "id": 235451673,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1618977370
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191315\">Josh Mandel</span> <a href=\"#narrow/stream/284830-smart.2Fhealth-cards/topic/SHC.20Pre-event.20Discussion/near/235441702\">said</a>:</p>\n<blockquote>\n<p>That QR looks like &gt;V22, BTW. (The validator should pick that up when you get to it.)</p>\n</blockquote>\n<p>The validator doesn't yet check for &gt;V22; <a href=\"https://github.com/microsoft/health-cards-validation-SDK/pull/57\">working on it</a>...</p>",
        "id": 235507231,
        "sender_full_name": "Christian Paquin",
        "timestamp": 1619010946
    },
    {
        "content": "<p>Oh gads, please make it a warning, not an error.</p>",
        "id": 235512461,
        "sender_full_name": "Abbie Watson",
        "timestamp": 1619012828
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191678\">Abbie Watson</span> <a href=\"#narrow/stream/284830-smart.2Fhealth-cards/topic/SHC.20Pre-event.20Discussion/near/235512461\">said</a>:</p>\n<blockquote>\n<p>Oh gads, please make it a warning, not an error.</p>\n</blockquote>\n<p>The feature hasn't been implemented yet, only the unit test; it indeed expects a warning in this case (since the spec doesn't use a SHALL for the QR version)</p>",
        "id": 235524712,
        "sender_full_name": "Christian Paquin",
        "timestamp": 1619017198
    }
]