[
    {
        "content": "<p>Hi,<br>\nI am getting this error in dotnet core 2.2. I know that the issue is that it doesn't know how to handle the input of when the controller maps to that resource. I have tried adding an input formatter but haven't been able to get it to work. I am wondering if anyone can help with this issue.</p>\n<div class=\"codehilite\"><pre><span></span>public IActionResult Post([FromBody] PractitionerRole pr)\n        {\n           // some code\n        }\n</pre></div>\n\n\n<p>Could not create an instance of type Hl7.Fhir.Model.Element. Type is an interface or abstract class and cannot be instantiated</p>",
        "id": 177641549,
        "sender_full_name": "Francisco Nolla",
        "timestamp": 1570557633
    },
    {
        "content": "<p>You can take a peek at how its done in the fhir-net-web-api project<br>\n<a href=\"https://github.com/brianpos/fhir-net-web-api\" target=\"_blank\" title=\"https://github.com/brianpos/fhir-net-web-api\">https://github.com/brianpos/fhir-net-web-api</a><br>\nIf you want to use it, there is a demo that uses the file system to simulate storage.</p>",
        "id": 177667985,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1570576146
    },
    {
        "content": "<p>Yeah, im not trying to implement a fhir api. I'm trying to take fhir objects in my api and use them for other purposes so a route like the one I posted has this difficulty. I implemented the formatter for input and output so that it parses fhir correctly. the only problem now that I have is nesting of types.</p>\n<p>Say I have a route that has this class below as the [FromBody] parameter in the function above. My formatters are not working because that type is not fhir. the nested type however is. So i'm having a hard time understanding how to get the formatter to understand nested properties.</p>\n<p><code>public class SomeParentInput\n    {\n        [Required]\n        public string PractitionerReference { get; set; }\n        [Required]\n        public Hl7.Fhir.Model.PractitionerRole PractitionerRole { get; set; }\n    }</code></p>\n<p>Here are my formatters. They work when the payload is just a PractitionerRole or any fhir type. But when it is nested this will fail because the canreadtype is false because it is not of type resource.<br>\n```using System;<br>\nusing System.Buffers;<br>\nusing System.Collections.Generic;<br>\nusing System.IO;<br>\nusing System.Linq;<br>\nusing System.Text;<br>\nusing System.Threading.Tasks;<br>\nusing Hl7.Fhir.Model;<br>\nusing Hl7.Fhir.Rest;<br>\nusing Hl7.Fhir.Serialization;<br>\nusing Hl7.Fhir.Utility;<br>\nusing Microsoft.AspNetCore.Http;<br>\nusing Microsoft.AspNetCore.Mvc.Formatters;<br>\nusing Microsoft.AspNetCore.Mvc.Formatters.Json.Internal;<br>\nusing Microsoft.Net.Http.Headers;<br>\nusing Newtonsoft.Json;<br>\nusing Task = System.Threading.Tasks.Task;</p>\n<p>namespace Configurations.Formatters<br>\n{<br>\n    public class CiscoFormatter : TextInputFormatter<br>\n    {<br>\n        public CiscoFormatter()<br>\n        {<br>\n            foreach (var mediaType in ContentType.JSON_CONTENT_HEADERS)<br>\n                SupportedMediaTypes.Add(new MediaTypeHeaderValue(mediaType));<br>\n            SupportedEncodings.Add(Encoding.Default);<br>\n            SupportedEncodings.Add(Encoding.UTF8);<br>\n            SupportedEncodings.Add(UTF8EncodingWithoutBOM);<br>\n        }<br>\n        protected override bool CanReadType(Type type)<br>\n        {<br>\n            bool can = typeof(Resource).IsAssignableFrom(type);<br>\n            return can;<br>\n        }</p>\n<div class=\"codehilite\"><pre><span></span>    public override async Task&lt;InputFormatterResult&gt; ReadRequestBodyAsync(InputFormatterContext context, Encoding encoding)\n    {\n        if (context == null)\n        {\n            throw new ArgumentNullException(nameof(context));\n        }\n\n        var request = context.HttpContext.Request;\n        using (var reader = new StreamReader(request.Body, encoding))\n        using (var jsonReader = new JsonTextReader(reader))\n        {\n            var parser = new FhirJsonParser()\n            {\n                Settings = { AcceptUnknownMembers = true,  }\n            };\n            var resource = parser.Parse&lt;Resource&gt;(jsonReader);\n            return await InputFormatterResult.SuccessAsync(resource);\n        }\n    }\n}\n\npublic class CiscoOutputFormatter : TextOutputFormatter\n{\n    public CiscoOutputFormatter()\n    {\n        foreach (var mediaType in ContentType.JSON_CONTENT_HEADERS)\n            SupportedMediaTypes.Add(new MediaTypeHeaderValue(mediaType));\n        SupportedEncodings.Add(Encoding.Default);\n        SupportedEncodings.Add(Encoding.UTF8);\n    }\n    protected override bool CanWriteType(Type type)\n    {\n        if (typeof(Resource).IsAssignableFrom(type) \n            || typeof(IEnumerable&lt;Resource&gt;).IsAssignableFrom(type))\n        {\n            return base.CanWriteType(type);\n        }\n        return false;\n    }\n    public override Task WriteResponseBodyAsync(OutputFormatterWriteContext context, Encoding selectedEncoding)\n    {\n        var response = context.HttpContext.Response;\n        var serializer = new FhirJsonSerializer()\n        {\n            Settings = { Pretty = true }\n        };\n        using (StreamWriter writer = new StreamWriter(context.HttpContext.Response.Body))\n        {\n            JsonTextWriter jsonwriter = (JsonTextWriter)SerializationUtil.CreateJsonTextWriter(writer); // This will use the BetterJsonWriter which handles precision correctly\n            using (jsonwriter)\n            {\n                jsonwriter.ArrayPool = new JsonArrayPool&lt;char&gt;(ArrayPool&lt;char&gt;.Shared);\n                jsonwriter.Formatting = Formatting.Indented; // lets make it pretty\n\n                SummaryType st = SummaryType.False;\n                if (context.ObjectType == typeof(OperationOutcome))\n                {\n                    // We will only honor the summary type during serialization of the outcome\n                    // if the resource wasn&#39;t a stored OpOutcome we are returning\n                    OperationOutcome resource = (OperationOutcome)context.Object;\n                    if (string.IsNullOrEmpty(resource.Id) &amp;&amp; resource.HasAnnotation&lt;SummaryType&gt;())\n                        st = resource.Annotation&lt;SummaryType&gt;();\n                    serializer.Serialize(resource, jsonwriter, st);\n                }\n                else if (typeof(Resource).IsAssignableFrom(context.ObjectType))\n                {\n                    if (context.Object != null)\n                    {\n                        Resource r = context.Object as Resource;\n                        if (r.HasAnnotation&lt;SummaryType&gt;())\n                            st = r.Annotation&lt;SummaryType&gt;();\n                        serializer.Serialize(r, jsonwriter, st);\n                    }\n                }\n                return writer.FlushAsync();\n            }\n        }\n    }\n}\n</pre></div>\n\n\n<p>}```</p>",
        "id": 177678030,
        "sender_full_name": "Francisco Nolla",
        "timestamp": 1570589686
    },
    {
        "content": "<p>I'm looking to accept R4 FHIR data in my .Net Core Web Service. Is this project still useful for me, or are there newer examples or other means of deserializing FHIR Resources in .Net Core? </p>\n<p>I'm using the latest Hl7.Fhir POCO. Up to now, I've just been defining the FHIR Resources as simple .Net \"object\" types, and parsing them after the fact.  I would ultimately like to define the resource as Hl7.Fhir.Model.Resource, and have .Net MVC deserialize it for me (via annotations or custom deserializer if necessary).<br>\nCurrent model:</p>\n<div class=\"codehilite\"><pre><span></span>    public sealed class Notification\n    {\n        [JsonProperty(PropertyName = &quot;timestamp&quot;)]\n        public DateTime Timestamp { get; set; }\n\n        [JsonProperty(PropertyName = &quot;id&quot;)]\n        public string Id { get; set; }\n\n        [JsonProperty(PropertyName = &quot;event&quot;)]\n        public NotificationEvent Event { get; set; }\n    }\n\n    public sealed class NotificationEvent : ModelBase\n    {\n        [JsonProperty(PropertyName = &quot;hub.topic&quot;)]\n        public string Topic { get; set; }\n\n        [JsonProperty(PropertyName = &quot;hub.event&quot;)]\n        public string HubEvent { get; set; }\n\n        [JsonProperty(PropertyName = &quot;context&quot;)]\n        public List&lt;Context&gt; Contexts { get; set; }\n    }\n\n    public sealed class Context\n    {\n        [JsonProperty(PropertyName = &quot;key&quot;)]\n        public string Key { get; set; }\n\n        [JsonProperty(PropertyName = &quot;resource&quot;)]\n        public object Resource { get; set; }    //&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;  FHIR resource\n    }\n}\n</pre></div>\n\n\n<p>The data my server receives is FHIRCast (<a href=\"http://fhircast.org/\" target=\"_blank\" title=\"http://fhircast.org/\">http://fhircast.org/</a>) notification messages which <em>contain</em> FHIR Resources (DiagnosticReport, ImagingStudy, Patient, etc.).  Example notification:</p>\n<div class=\"codehilite\"><pre><span></span>{\n    &quot;timestamp&quot;: &quot;2019-09-10T14:58:45.988Z&quot;,\n    &quot;id&quot;: &quot;0d4c9998&quot;,\n    &quot;event&quot;: {\n        &quot;hub.topic&quot;: &quot;joe&quot;,\n        &quot;hub.event&quot;: &quot;DiagnosticReport-open&quot;,\n        &quot;context&quot;: [\n            {\n                &quot;key&quot;: &quot;Report&quot;,\n                &quot;resource&quot;: {\n                    &quot;resourceType&quot;: &quot;DiagnosticReport&quot;,\n                    &quot;id&quot;: &quot;40012366&quot;,\n                    &quot;status&quot;: &quot;unknown&quot;\n                }\n            }\n        ]\n    }\n}\n</pre></div>\n\n\n<p>Here is the Notify Rest method:</p>\n<div class=\"codehilite\"><pre><span></span>        [HttpPost(&quot;{topic}&quot;)]\n        [Authorize]\n        public async Task&lt;IActionResult&gt; Notify(string topic, [FromBody] Notification notification)\n</pre></div>\n\n\n<p>I would appreciate any advice at all. Thanks!</p>",
        "id": 183565343,
        "sender_full_name": "George Kustas",
        "timestamp": 1576513691
    },
    {
        "content": "<p>I haven't done this specific interface usage, but imagine that you could leverage inspiration from the project.</p>",
        "id": 183674489,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1576606232
    }
]