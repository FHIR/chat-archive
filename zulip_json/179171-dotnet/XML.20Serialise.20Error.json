[
    {
        "content": "<p>I'm trying to serialise a resource to XML using the latest DSTU2 Nuget package. The code I am using is as follows </p>\n<p>var tt = FhirSerializer.SerializeResourceToXml(_resource);</p>",
        "id": 153864760,
        "sender_full_name": "Richard Kavanagh",
        "timestamp": 1482417322
    },
    {
        "content": "<p>When the resource is an \"OperationDefinition\" it works fine</p>",
        "id": 153864761,
        "sender_full_name": "Richard Kavanagh",
        "timestamp": 1482417395
    },
    {
        "content": "<p>When the resource is a \"ValueSet\" it throws an exception as below</p>",
        "id": 153864763,
        "sender_full_name": "Richard Kavanagh",
        "timestamp": 1482417448
    },
    {
        "content": "<p>[XmlException: Data at the root level is invalid. Line 1, position 1.]<br>\n   System.Xml.XmlTextReaderImpl.Throw(Exception e) +72<br>\n   System.Xml.XmlTextReaderImpl.Throw(String res, String arg) +192<br>\n   System.Xml.XmlTextReaderImpl.ParseRootLevelWhitespace() +341<br>\n   System.Xml.XmlTextReaderImpl.ParseDocumentContent() +311<br>\n   System.Xml.XmlTextReaderImpl.Read() +148<br>\n   System.Xml.XmlReader.MoveToContent() +43<br>\n   System.Xml.Linq.XElement.Load(XmlReader reader, LoadOptions options) +27<br>\n   System.Xml.Linq.XElement.Parse(String text, LoadOptions options) +90<br>\n   Hl7.Fhir.Serialization.XmlFhirWriter.WritePrimitiveContents(Object value, XmlSerializationHint xmlFormatHint) +117<br>\n   Hl7.Fhir.Serialization.PrimitiveValueWriter.Serialize(Object value, XmlSerializationHint hint) +96<br>\n   Hl7.Fhir.Serialization.DispatchingWriter.write(PropertyMapping prop, Object instance, SummaryType summary, SerializationMode mode) +74<br>\n   Hl7.Fhir.Serialization.DispatchingWriter.Serialize(PropertyMapping prop, Object instance, SummaryType summary, SerializationMode mode) +281<br>\n   Hl7.Fhir.Serialization.ComplexTypeWriter.write(ClassMapping mapping, Object instance, SummaryType summary, PropertyMapping prop, SerializationMode mode) +446<br>\n   Hl7.Fhir.Serialization.ComplexTypeWriter.writeProperty(ClassMapping mapping, Object instance, SummaryType summary, SerializationMode mode, PropertyMapping prop) +563<br>\n   Hl7.Fhir.Serialization.ComplexTypeWriter.Serialize(ClassMapping mapping, Object instance, SummaryType summary, SerializationMode mode) +426<br>\n   Hl7.Fhir.Serialization.DispatchingWriter.write(PropertyMapping prop, Object instance, SummaryType summary, SerializationMode mode) +290<br>\n   Hl7.Fhir.Serialization.DispatchingWriter.Serialize(PropertyMapping prop, Object instance, SummaryType summary, SerializationMode mode) +281<br>\n   Hl7.Fhir.Serialization.ComplexTypeWriter.write(ClassMapping mapping, Object instance, SummaryType summary, PropertyMapping prop, SerializationMode mode) +446<br>\n   Hl7.Fhir.Serialization.ComplexTypeWriter.writeProperty(ClassMapping mapping, Object instance, SummaryType summary, SerializationMode mode, PropertyMapping prop) +563<br>\n   Hl7.Fhir.Serialization.ComplexTypeWriter.Serialize(ClassMapping mapping, Object instance, SummaryType summary, SerializationMode mode) +426<br>\n   Hl7.Fhir.Serialization.ResourceWriter.Serialize(Object instance, SummaryType summary, Boolean contained, String root) +822<br>\n   Hl7.Fhir.Serialization.&lt;&gt;c__DisplayClass1_0.&lt;SerializeToXml&gt;b__0(XmlWriter xw) +128<br>\n   Hl7.Fhir.Serialization.FhirSerializer.xmlWriterToString(Action`1 serializer) +123<br>\n   Hl7.Fhir.Serialization.FhirSerializer.SerializeToXml(Base data, SummaryType summary, String root) +77<br>\n   Hl7.Fhir.Serialization.FhirSerializer.SerializeResourceToXml(Resource resource, SummaryType summary) +7</p>",
        "id": 153864764,
        "sender_full_name": "Richard Kavanagh",
        "timestamp": 1482417450
    },
    {
        "content": "<p>Any ideas what might be causing this?</p>",
        "id": 153864765,
        "sender_full_name": "Richard Kavanagh",
        "timestamp": 1482417484
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"191362\">@Richard Kavanagh</span> I cannot reproduce the error using some example ValueSets. Can you share your own ValueSet resource for debugging purposes?</p>",
        "id": 153864767,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1482418434
    },
    {
        "content": "<p>Strangely enough, it is one of the V2 valuesets from the core pack. If I serialise it as JSON it works fine.</p>",
        "id": 153864768,
        "sender_full_name": "Richard Kavanagh",
        "timestamp": 1482418652
    },
    {
        "content": "<p>The JSON serialisation is</p>",
        "id": 153864769,
        "sender_full_name": "Richard Kavanagh",
        "timestamp": 1482418855
    },
    {
        "content": "<p>{<br>\n  \"resourceType\": \"ValueSet\",<br>\n  \"id\": \"v2-0717\",<br>\n  \"meta\": {<br>\n    \"profile\": [<br>\n      \"<a href=\"http://hl7.org/fhir/StructureDefinition/valueset-shareable-definition\" target=\"_blank\" title=\"http://hl7.org/fhir/StructureDefinition/valueset-shareable-definition\">http://hl7.org/fhir/StructureDefinition/valueset-shareable-definition</a>\"<br>\n    ]<br>\n  },<br>\n  \"text\": {<br>\n    \"status\": \"additional\",<br>\n    \"div\": \"removed\"<br>\n  },<br>\n  \"url\": \"<a href=\"http://hl7.org/fhir/ValueSet/v2-0717\" target=\"_blank\" title=\"http://hl7.org/fhir/ValueSet/v2-0717\">http://hl7.org/fhir/ValueSet/v2-0717</a>\",<br>\n  \"version\": \"2.8.2\",<br>\n  \"name\": \"v2 Access Restriction Value\",<br>\n  \"status\": \"active\",<br>\n  \"experimental\": true,<br>\n  \"publisher\": \"HL7, Inc\",<br>\n  \"codeSystem\": {<br>\n    \"extension\": [<br>\n      {<br>\n        \"url\": \"<a href=\"http://hl7.org/fhir/StructureDefinition/valueset-oid\" target=\"_blank\" title=\"http://hl7.org/fhir/StructureDefinition/valueset-oid\">http://hl7.org/fhir/StructureDefinition/valueset-oid</a>\",<br>\n        \"valueUri\": \"urn:oid:2.16.840.1.133883.18.388\"<br>\n      }<br>\n    ],<br>\n    \"system\": \"<a href=\"http://hl7.org/fhir/v2/0717\" target=\"_blank\" title=\"http://hl7.org/fhir/v2/0717\">http://hl7.org/fhir/v2/0717</a>\",<br>\n    \"caseSensitive\": false,<br>\n    \"concept\": [<br>\n      {<br>\n        \"code\": \"ALL\",<br>\n        \"display\": \"All\"<br>\n      },<br>\n      {<br>\n        \"code\": \"DEM\",<br>\n        \"display\": \"All demographic data\"<br>\n      },<br>\n      {<br>\n        \"code\": \"DRG\",<br>\n        \"display\": \"Drug\"<br>\n      },<br>\n      {<br>\n        \"code\": \"HIV\",<br>\n        \"display\": \"HIV status and results\"<br>\n      },<br>\n      {<br>\n        \"code\": \"LOC\",<br>\n        \"display\": \"Patient Location\"<br>\n      },<br>\n      {<br>\n        \"code\": \"NO\",<br>\n        \"display\": \"None\"<br>\n      },<br>\n      {<br>\n        \"code\": \"OI\",<br>\n        \"display\": \"Opt in all registries (HIPAA)\"<br>\n      },<br>\n      {<br>\n        \"code\": \"OO\",<br>\n        \"display\": \"Opt out all registries (HIPAA)\"<br>\n      },<br>\n      {<br>\n        \"code\": \"PID-17\",<br>\n        \"display\": \"Religion\"<br>\n      },<br>\n      {<br>\n        \"code\": \"PID-7\",<br>\n        \"display\": \"Date of Birth\"<br>\n      },<br>\n      {<br>\n        \"code\": \"PSY\",<br>\n        \"display\": \"Psychiatric Mental health\"<br>\n      },<br>\n      {<br>\n        \"code\": \"SMD\",<br>\n        \"display\": \"Sensitive medical data\"<br>\n      },<br>\n      {<br>\n        \"code\": \"STD\",<br>\n        \"display\": \"Sexually transmitted diseases\"<br>\n      }<br>\n    ]<br>\n  }<br>\n}</p>",
        "id": 153864770,
        "sender_full_name": "Richard Kavanagh",
        "timestamp": 1482418866
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191362\">@Richard Kavanagh</span> Indeed, with this valueset I can reproduce the issue. I'll register a ticket so Ewout can investigate and solve the bug after his vacation.</p>",
        "id": 153864771,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1482419261
    },
    {
        "content": "<p>I found the issue..</p>",
        "id": 153864772,
        "sender_full_name": "Richard Kavanagh",
        "timestamp": 1482419279
    },
    {
        "content": "<p>I'll raise the issue on GitHub</p>",
        "id": 153864774,
        "sender_full_name": "Richard Kavanagh",
        "timestamp": 1482419327
    },
    {
        "content": "<p>Looks like the serializer fails on this line: \"div\": \"removed\"<br>\nThe \"removed\" element contents is not valid Xhtml...</p>",
        "id": 153864775,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1482419377
    },
    {
        "content": "<p>This should be something like \"&lt;p&gt;removed&lt;/p&gt;\"</p>",
        "id": 153864776,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1482419396
    },
    {
        "content": "<p>Yes - I found that... eventually !!</p>",
        "id": 153864777,
        "sender_full_name": "Richard Kavanagh",
        "timestamp": 1482419413
    },
    {
        "content": "<p>But it would be nice if the API would handle this gracefully.</p>",
        "id": 153864778,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1482419413
    },
    {
        "content": "<p>If you're going to register an issue on github, you can mention this as it will help to solve the issue quickly.</p>",
        "id": 153864779,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1482419529
    },
    {
        "content": "<p>I guess technically as the text is typed as XHTML then it should accept text without tags. XHTML does not require any tags</p>",
        "id": 153864780,
        "sender_full_name": "Richard Kavanagh",
        "timestamp": 1482419561
    },
    {
        "content": "<p>See the examples here</p>",
        "id": 153864781,
        "sender_full_name": "Richard Kavanagh",
        "timestamp": 1482419607
    },
    {
        "content": "<p><a href=\"http://www.hl7.org/implement/standards/fhir/narrative.html#Narrative\" target=\"_blank\" title=\"http://www.hl7.org/implement/standards/fhir/narrative.html#Narrative\">http://www.hl7.org/implement/standards/fhir/narrative.html#Narrative</a></p>",
        "id": 153864782,
        "sender_full_name": "Richard Kavanagh",
        "timestamp": 1482419609
    },
    {
        "content": "<p>I guess it depends on how strict we want to define the standard. Strictly speaking valid Xhtml should always have a root element.</p>",
        "id": 153864783,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1482419740
    },
    {
        "content": "<p>Well spec is clear, we should accept plain text.</p>",
        "id": 153864784,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1482419767
    },
    {
        "content": "<p>To be honest I suspect the code is right and the spec probably needs work. I'll leave that for Ewout to progress if required. A more graceful exception would be useful though.</p>",
        "id": 153864785,
        "sender_full_name": "Richard Kavanagh",
        "timestamp": 1482420124
    },
    {
        "content": "<p>Issue #281 raised on github </p>",
        "id": 153864786,
        "sender_full_name": "Richard Kavanagh",
        "timestamp": 1482420145
    },
    {
        "content": "<p>Agreed, and thank you!</p>",
        "id": 153864788,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1482420257
    }
]