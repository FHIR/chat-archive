[
    {
        "content": "<p>I'm implementing an API in order to accept FHIR resources to create laboratory orders. I'm trying to perform custom validations and based in some business rules I would like to require a field or not. For example patient's address. In some cases I just want to require zip code but in some cases I want to require the entire address. It is possible to achieve this with the fhir .net API and FhirValidator or do I need to perform those validations by myself?</p>",
        "id": 154011184,
        "sender_full_name": "Yassiel Oliva",
        "timestamp": 1540236654
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"196707\">@Yassiel Oliva</span>, sure you can. I suggest you look into FHIRPath constraints, they allow you to define such business rules, and are supported by both .NET and Java API's.</p>",
        "id": 154011298,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1540281091
    },
    {
        "content": "<p>FHIRPath constraints are supported by the standard validator implementations, probably no need to author any custom logic.</p>",
        "id": 154011299,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1540281188
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"196707\">@Yassiel Oliva</span> - I have created a demo project that shows how to run the validator in case you needed help there: <a href=\"https://github.com/ewoutkramer/Furore.Fhir.ValidationDemo\" target=\"_blank\" title=\"https://github.com/ewoutkramer/Furore.Fhir.ValidationDemo\">https://github.com/ewoutkramer/Furore.Fhir.ValidationDemo</a></p>",
        "id": 154011321,
        "sender_full_name": "Ewout Kramer",
        "timestamp": 1540287421
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191336\">@Michel Rutten</span> can you provide me an example of how to achieve this? I'm pretty new to Fhir and I'm having issues trying to define custom rules. My current use case is I'm receiving a <code>Bundle</code> representing a Laboratory order via API and I want to validate for example incoming <code>ServiceRequest</code> in order to see if the requested services are tagged as orderable or not.</p>",
        "id": 154011912,
        "sender_full_name": "Yassiel Oliva",
        "timestamp": 1540396519
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191328\">@Ewout Kramer</span> I'm having troubles running the validation demo offline because of a missing file:  <code>specifications.zip</code> Where do I need to place the file? <a href=\"/user_uploads/10155/3naA7ioEp5XYNV4K8miBsia_/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/3naA7ioEp5XYNV4K8miBsia_/pasted_image.png\" target=\"_blank\" title=\"pasted image\"><img src=\"/user_uploads/10155/3naA7ioEp5XYNV4K8miBsia_/pasted_image.png\"></a></div>",
        "id": 154011915,
        "sender_full_name": "Yassiel Oliva",
        "timestamp": 1540396854
    },
    {
        "content": "<p>The specification.zip archive is part of the <code>Hl7.Fhir.Specification</code> NuGet package. After installing the package, this file should be added to the root folder of your project. In Visual Studio, please ensure following settings:</p>\n<div class=\"codehilite\"><pre><span></span>Build Action = Content\nCopy to Output Directory = Copy if newer\n</pre></div>\n\n\n<p>This ensures that the compiler copies specification.zip to the output directory. The API expects this file to be located in the same folder as the assembly.</p>",
        "id": 154011917,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1540397263
    },
    {
        "content": "<p>For information about authoring constraints, see the FHIRPath specification:<br>\n<a href=\"http://hl7.org/fhirpath/\" target=\"_blank\" title=\"http://hl7.org/fhirpath/\">http://hl7.org/fhirpath/</a></p>",
        "id": 154011931,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1540398724
    },
    {
        "content": "<p>For examples, you can inspect the core resources, as many introduce their own constraints.<br>\ne.g. pat-1 on Patient:<br>\n<a href=\"http://hl7.org/fhir/patient.html#invs\" target=\"_blank\" title=\"http://hl7.org/fhir/patient.html#invs\">http://hl7.org/fhir/patient.html#invs</a></p>",
        "id": 154011932,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1540398776
    },
    {
        "content": "<p>If you are just running the exe, it should end up in the same directory as the .exe...</p>",
        "id": 154012341,
        "sender_full_name": "Ewout Kramer",
        "timestamp": 1540549674
    },
    {
        "content": "<p>Or you can put the file wherever you like - AppData, UserData etc, and use the DirectorySourceResolver with the path that you use.</p>",
        "id": 154012788,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1540598538
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191328\">@Ewout Kramer</span> we are having issues to perform the validations. We tried with <code>Fhir.Specification.STU3</code> and <code>Fhir.Specification.R4</code> but validation is failing with both validators. We have selected a sample patient info for each version:</p>\n<p><a href=\"https://www.hl7.org/fhir/patient-example-a.json.html\" target=\"_blank\" title=\"https://www.hl7.org/fhir/patient-example-a.json.html\">https://www.hl7.org/fhir/patient-example-a.json.html</a><br>\n<a href=\"http://hl7.org/fhir/2018Sep/patient-example-a.json.html\" target=\"_blank\" title=\"http://hl7.org/fhir/2018Sep/patient-example-a.json.html\">http://hl7.org/fhir/2018Sep/patient-example-a.json.html</a></p>\n<div class=\"codehilite\"><pre><span></span>            var parser = new FhirJsonParser();\n            var patient = parser.Parse&lt;Patient&gt;(File.ReadAllText(&quot;samplePatient.json&quot;));\n            var validator = new Validator();\n\n            var result = validator.Validate(patient);\n\n            Console.WriteLine(result.Success);\n            foreach (var err in result.Issue.Select(e =&gt; e.Details.Text))\n                Console.WriteLine(err);\n</pre></div>\n\n\n<p>with both versions we are getting the same validation issue:<br>\n<code>Unable to resolve reference to profile 'http://hl7.org/fhir/StructureDefinition/Patient'</code></p>\n<p>Are we missing something?</p>",
        "id": 154020943,
        "sender_full_name": "Yassiel Oliva",
        "timestamp": 1543269611
    },
    {
        "content": "<p>You need to pass some settings into the validator..</p>\n<div class=\"codehilite\"><pre><span></span>        ValidationSettings settings = ValidationSettings.Default;\n        settings.EnableXsdValidation = false;\n        settings.Trace = false;\n        settings.ResourceResolver =    ...need to add some form of resolver so the validator can find the profiles.\n        settings.TerminologyService = ... need to add some form of terminology server\n</pre></div>",
        "id": 154021184,
        "sender_full_name": "Richard Kavanagh",
        "timestamp": 1543360216
    },
    {
        "content": "<p>Yes - the Validator needs access to the definitions of the FHIR resources, these are normally shipped with the Specification library (specification.zip).  That's the first step - the other steps are:</p>\n<ul>\n<li>the Validator will need to be told how to get to that specification.zip. </li>\n<li>This is done by passing it a concrete implementation of IResourceResolver</li>\n<li>The resource resolver can be indicated in the ValidationSettings you pass to the constructor of the validator</li>\n</ul>\n<p>The .NET API ships with a few concrete implementations for IResourceResolver - one for resolving references to definitions in the specification.zip, one for resolving it from a directory.</p>\n<p>I wrote an example Windows Forms application that does all this (don't worry if you're not on Windows, the code is quite windows independent):<br>\n<a href=\"https://github.com/ewoutkramer/Furore.Fhir.ValidationDemo/blob/master/MainForm.cs\" target=\"_blank\" title=\"https://github.com/ewoutkramer/Furore.Fhir.ValidationDemo/blob/master/MainForm.cs\">https://github.com/ewoutkramer/Furore.Fhir.ValidationDemo/blob/master/MainForm.cs</a>.</p>\n<p>I spoke about this part of the API at DevDays last year: <a href=\"https://vimeo.com/album/5317523/video/243081070\" target=\"_blank\" title=\"https://vimeo.com/album/5317523/video/243081070\">https://vimeo.com/album/5317523/video/243081070</a> (video), I also have a slide deck about it here: <a href=\"https://www.slideshare.net/DevDays/validation-in-net-and-java-ewout-james\" target=\"_blank\" title=\"https://www.slideshare.net/DevDays/validation-in-net-and-java-ewout-james\">https://www.slideshare.net/DevDays/validation-in-net-and-java-ewout-james</a></p>\n<p>Hope that helps.  And yes, I guess I should add some documentation about this at our docs site (<a href=\"http://docs.simplifier.net/fhirnetapi/index.html\" target=\"_blank\" title=\"http://docs.simplifier.net/fhirnetapi/index.html\">http://docs.simplifier.net/fhirnetapi/index.html</a>)</p>",
        "id": 154021294,
        "sender_full_name": "Ewout Kramer",
        "timestamp": 1543403093
    },
    {
        "content": "<p>By the way, the R4 validator is still totally broken - We try to release the first R4-validator in the 1.1 release of the API.</p>",
        "id": 154021295,
        "sender_full_name": "Ewout Kramer",
        "timestamp": 1543403211
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191328\">@Ewout Kramer</span>  I don't know the state of the R4 validator atm, but is it correct to assume that it's an issue that the R4 validator, can't validate profiles  that doesn't have a URL starting with \"<a href=\"http://hl7.org/fhir/StructureDefinition/\" target=\"_blank\" title=\"http://hl7.org/fhir/StructureDefinition/\">http://hl7.org/fhir/StructureDefinition/</a>\". Specifically code in ProfilePreprocessor.</p>",
        "id": 160084663,
        "sender_full_name": "Martin Andersen",
        "timestamp": 1551869056
    },
    {
        "content": "<p>We are not aware of this issue. And we have some unit tests that seem to say otherwise. Is it possible to send us the profile for us to debug it?</p>",
        "id": 160093045,
        "sender_full_name": "Martijn Harthoorn",
        "timestamp": 1551877335
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191335\">@Martijn Harthoorn</span> Sure I could do that tomorrow when I'm back at work, but the \"issue\" seems to be located in <a href=\"https://github.com/FirelyTeam/fhir-net-api/blob/develop/src/Hl7.Fhir.Specification/Validation/ProfilePreprocessor.cs\" target=\"_blank\" title=\"https://github.com/FirelyTeam/fhir-net-api/blob/develop/src/Hl7.Fhir.Specification/Validation/ProfilePreprocessor.cs\">https://github.com/FirelyTeam/fhir-net-api/blob/develop/src/Hl7.Fhir.Specification/Validation/ProfilePreprocessor.cs</a><br>\nline: if (instance.InstanceType != null) _profiles.SetInstanceType(ModelInfo.CanonicalUriForFhirCoreType(instance.InstanceType));<br>\nBut maybe im using the validator wrong, but all my debugging leads to that point where it always \"thinks\" it's a Fhir Core type.</p>",
        "id": 160119596,
        "sender_full_name": "Martin Andersen",
        "timestamp": 1551895964
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191335\">@Martijn Harthoorn</span> I'm using a derived POCO class. But the more I read about Fhir profiling in net-fhir-api, the more it seems to be the wrong approach.</p>",
        "id": 160119730,
        "sender_full_name": "Martin Andersen",
        "timestamp": 1551896047
    },
    {
        "content": "<p>That namespace is where core data types live.<br>\nCreating other types in there is bad practice, and will be confusing to look at. HL7 didn't create them...<br>\nIf its your profile, usie your own namespace.</p>",
        "id": 160131758,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1551904278
    },
    {
        "content": "<p>And from memory, the instance type is always a core type.</p>",
        "id": 160131881,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1551904353
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191367\">@Brian Postlethwaite</span> What namespace are your referring to? I haven't posted the namespace for my derived POCO class anywhere?</p>",
        "id": 160136138,
        "sender_full_name": "Martin Andersen",
        "timestamp": 1551907687
    },
    {
        "content": "<p>I think Brian meant the start of the canonical url, or the canonical base as we call them on Simplifier.</p>",
        "id": 160186814,
        "sender_full_name": "Martijn Harthoorn",
        "timestamp": 1551955673
    },
    {
        "content": "<blockquote>\n<p>@Ewout Kramer I don't know the state of the R4 validator atm, but is it correct to assume that it's an issue that the R4 validator, can't validate profiles that doesn't have a URL starting with \"<a href=\"http://hl7.org/fhir/StructureDefinition/\" target=\"_blank\" title=\"http://hl7.org/fhir/StructureDefinition/\">http://hl7.org/fhir/StructureDefinition/</a>\". Specifically code in ProfilePreprocessor.</p>\n</blockquote>\n<p>That is absolutely correct at the moment, however there is a very recent PR (<a href=\"https://github.com/FirelyTeam/fhir-net-api/pull/917\" target=\"_blank\" title=\"https://github.com/FirelyTeam/fhir-net-api/pull/917\">https://github.com/FirelyTeam/fhir-net-api/pull/917</a>) that will fix this. We expect to have it ready in version 1.3 of the API!</p>",
        "id": 162233673,
        "sender_full_name": "Ewout Kramer",
        "timestamp": 1554121816
    },
    {
        "content": "<p>I am using hl7.fhir.stu3.specification nuget package for the validation of fhir resource.I have resource with extension which is giving error.<br>\nIs there any way to turn off that extension url validation?</p>",
        "id": 164984828,
        "sender_full_name": "sanjay shekhar",
        "timestamp": 1557152024
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"220895\">@sanjay shekhar</span>, what kind of error are you getting? The preferred approach would be to fix the models.</p>",
        "id": 164991044,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1557156379
    },
    {
        "content": "<blockquote>\n<p>Hi <span class=\"user-mention silent\" data-user-id=\"220895\">sanjay shekhar</span>, what kind of error are you getting? The preferred approach would be to fix the models.</p>\n</blockquote>\n<p>I have one observation resource which has extension as following <br>\n\"extension\": [<br>\n          {<br>\n            \"url\": \"http:\\/\\/hl7.org\\/fhir\\/StructureDefinition\\/T_ObservationImageExtension\",<br>\n            \"valueReference\": {<br>\n              \"reference\": \"ImagingStudy\\/test ImageStudy Extention\"<br>\n            }<br>\n          }<br>\n        ]<br>\nfirst I parse it using FhirJsonParser to resource<br>\nand then pass it to validator<br>\nlike below</p>\n<p>CachedResolver source = new CachedResolver(new MultiResolver(<br>\n                                                   new DirectorySource(Environment.CurrentDirectory),<br>\n                                                   ZipSource.CreateValidationSource()));</p>\n<div class=\"codehilite\"><pre><span></span>            // prepare the settings for the validator\n            ValidationSettings validationSettings = new ValidationSettings\n            {\n                ResourceResolver = source,\n                GenerateSnapshot = true,\n                Trace = false,\n                EnableXsdValidation = true,\n                ResolveExteralReferences = false,\n\n            };\n\n       // var sd = source.FindStructureDefinition(@&quot;https://fhir.nhs.uk/STU3/StructureDefinition/CareConnect-GPC-Patient-1&quot;)\n\n        Validator validator = new Validator(validationSettings);\n</pre></div>\n\n\n<p>I have the specification zip file copied to source directory <br>\nusing specification hl7.fhir.specification nuget 1.2.1</p>\n<p>result operation outcome has this issue</p>\n<p>\"issue\": [<br>\n        {<br>\n            \"severity\": \"error\",<br>\n            \"code\": \"incomplete\",<br>\n            \"details\": {<br>\n                \"coding\": [<br>\n                    {<br>\n                        \"system\": \"<a href=\"http://hl7.org/fhir/dotnet-api-operation-outcome\" target=\"_blank\" title=\"http://hl7.org/fhir/dotnet-api-operation-outcome\">http://hl7.org/fhir/dotnet-api-operation-outcome</a>\",<br>\n                        \"code\": \"4000\"<br>\n                    }<br>\n                ],<br>\n                \"text\": \"Unable to resolve reference to profile '<a href=\"http://hl7.org/fhir/StructureDefinition/T_ObservationImageExtension\" target=\"_blank\" title=\"http://hl7.org/fhir/StructureDefinition/T_ObservationImageExtension\">http://hl7.org/fhir/StructureDefinition/T_ObservationImageExtension</a>'\"<br>\n            },<br>\n            \"location\": [<br>\n                \"Observation.extension[0]\"<br>\n            ]<br>\n        }</p>",
        "id": 165041092,
        "sender_full_name": "sanjay shekhar",
        "timestamp": 1557202622
    },
    {
        "content": "<p>The validator needs access to all core &amp; custom profiles that the instance touches (directly or indirectly), in order to perform the validation. If one or more profiles are missing/unresolved, the validation report is incomplete.<br>\nI'd suggest to put all your custom profiles in a separate folder and make sure that the <code>DirectorySource</code> can find them.</p>",
        "id": 165072064,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1557236940
    },
    {
        "content": "<p>thanks Michel for the reply.<br>\nwe would need some more information:<br>\n1. if we don;t want to create custom profile, is there any way to inform Validation Code to skip the validation of reference? Currently it gives error only for extension having ValueReference param.<br>\n2. Please suggest on how to create the profile ? Any hints would be helpful.</p>",
        "id": 165077883,
        "sender_full_name": "Anand Jahagirdar",
        "timestamp": 1557240643
    },
    {
        "content": "<p>If I understand correctly, I think all you need to do is to put the required extension definitions in a directory, such as the ObervationImageExtension in the example above. This ensures that the validator can verify the extensions that are present in your instance. You don't have to create custom profiles if you don't need them.</p>",
        "id": 165080805,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1557242346
    },
    {
        "content": "<p>In case you want/decide to create a new/custom profile, you can use e.g. Forge, the FHIR profile editor, which you can download for free from Simplifier: <a href=\"https://simplifier.net/downloads/forge\" target=\"_blank\" title=\"https://simplifier.net/downloads/forge\">https://simplifier.net/downloads/forge</a></p>",
        "id": 165080946,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1557242429
    },
    {
        "content": "<p>To learn more about FHIR profiling, visit e.g. <a href=\"https://simplifier.net/guide/profilingacademy\" target=\"_blank\" title=\"https://simplifier.net/guide/profilingacademy\">https://simplifier.net/guide/profilingacademy</a></p>",
        "id": 165081027,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1557242509
    },
    {
        "content": "<p>(but it looks like you don't really need to create custom profiles in this case)</p>",
        "id": 165081110,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1557242570
    },
    {
        "content": "<p>thanks Michel.<br>\nWe actually dont need custom profile. But since we are using FHIR specification validation , the validation fails.<br>\nis there any other way to indicate validation that it can skip validation for ImagingStudy</p>",
        "id": 165085930,
        "sender_full_name": "Anand Jahagirdar",
        "timestamp": 1557245599
    },
    {
        "content": "<p>AFAIK, there is no easy way to skip a specific part of the validation.<br>\nPreferred way is to give the validator all the necessary information - otherwise results are not guaranteed to be complete/reliable.</p>",
        "id": 165086343,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1557245858
    },
    {
        "content": "<p>Did you try to initialize the DirectorySource with the extension definitions that you use? That shouldn't be hard.</p>",
        "id": 165086454,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1557245909
    },
    {
        "content": "<p>Core extension definitions are part of the spec. You can download them from <a href=\"http://hl7.org/fhir/downloads.html\" target=\"_blank\" title=\"http://hl7.org/fhir/downloads.html\">http://hl7.org/fhir/downloads.html</a>.<br>\nYou can also download extension definitions from the FHIR registry (<a href=\"https://registry.fhir.org/\" target=\"_blank\" title=\"https://registry.fhir.org/\">https://registry.fhir.org/</a>) or from Simplifier (<a href=\"https://simplifier.net\" target=\"_blank\" title=\"https://simplifier.net\">https://simplifier.net</a>).</p>",
        "id": 165086631,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1557246026
    },
    {
        "content": "<p>I will try to initialize with extension definition. thanks. I will update here.</p>",
        "id": 165086898,
        "sender_full_name": "Anand Jahagirdar",
        "timestamp": 1557246208
    },
    {
        "content": "<p>Note: same goes for other dependencies, e.g. if you want the validator to verify your terminology bindings, you'd have to provide the required valuesets.</p>",
        "id": 165087088,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1557246346
    },
    {
        "content": "<p>I encounter the same issues, and with mine, since I don't care on that specific rule, I just ignore/remove those incomplete errors and let it pass through.</p>",
        "id": 165093163,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1557250775
    }
]