[
    {
        "content": "<p>Hi Guys, having a tough time with implementing validation. I thought I was there based on development but as soon as I move to IIS in dev or production my issue starts.<br>\nIt comes down to the using the MultiResolver or more specifically the ZipSource as an IResourceResolver. When instantiating the ZipSource we provide a path to the ‘specification.zip’. In development I was simply doing this: <br>\n<code>MultiResolver.AddSource(new ZipSource(\"specification.zip\"));</code><br>\nThat worked just fine when running outside of IIS. It located my specification.zip file in my bin directory and all worked flawlessly. Yet as soon as I run in IIS, either IIS Express on my dev machine or on the full IIS on a production server it complains that the file cannot be found. I get the error message: <code>failed: Cannot prepare ZipArtifactSource: file 'specification.zip' was not found</code>.<br>\nLooking at the FHIR .Net API source I can see this exception in thrown in the ZipSource class in the following code:<br>\n<code>public static ZipSource CreateValidationSource()\n{\n  var path = Path.Combine(DirectorySource.SpecificationDirectory, \"specification.zip\");\n  if(File.Exists(path)) return new ZipSource(path);\n  throw new FileNotFoundException(\"Cannot create a ZipArtifactSource for the core specification: specification.zip was not found\");\n}</code><br>\nI have also looked into the method <code>DirectorySource.SpecificationDirectory</code> and can see it return the correct path.<br>\nSo as this works outside of IIS and not within, I strongly feel this is an IIS issue and not a problem with the FHIR .net API. And yet I cannot work out how to resolve it.  <br>\nI have played with IIS’s ‘Request Filtering’ with no avail, set the security permissions for my application pool’s Identity to allow access to the Bin folder, and specifically on the file   ‘'specification.zip’, still no luck.<br>\nHas anyone encountered this problem? <br>\nWhy can’t IIS allow my application to read the file located at ‘C:\\inetpub\\wwwroot\\Pyro\\bin\\specification.zip’ when I know it's there?<br>\nAny help my appreciated.</p>",
        "id": 153894314,
        "sender_full_name": "Angus Millar",
        "timestamp": 1497860154
    },
    {
        "content": "<p>Take a look at MIME type filtering which I believe is slightly different to request &amp; extension filtering.</p>",
        "id": 153894321,
        "sender_full_name": "Peter Jordan",
        "timestamp": 1497866676
    },
    {
        "content": "<p>Thanks Peter, will look into that</p>",
        "id": 153894355,
        "sender_full_name": "Angus Millar",
        "timestamp": 1497878210
    },
    {
        "content": "<p>I'll have a look at my code to see what I've done, pretty sure I've included the full path to the file.<br>\nThe working folder may not be the bin folder, hence not finding it.<br>\nLikely I have the assembly codebase location included. Will find and share the code (p.s. the unit tests in the specification project have the same issue)</p>",
        "id": 153894461,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1497917867
    },
    {
        "content": "<p>It was a dumb pathing issue of my own doing! I was not calling CreateValidationSource() I was instantiating an instance of ZipSource(\"specification.zip\"). So I focused on the wrong exception message which looked very similar. That lead me on a wild goose chase. </p>",
        "id": 153894681,
        "sender_full_name": "Angus Millar",
        "timestamp": 1498030718
    },
    {
        "content": "<p>Guys, this runtime unpacking of speciation.zip I think is actually not a great idea. I am surprised that no other users have objected against it so far.</p>\n<p>For DTSU1 I customized the API so that I would deliver the unpacked specification.zip content as part of the deployment of my server, and let the logic work on these files - within the control of my server, not somewhere in a temp directory. </p>\n<p>Is there already work underway to allow managing this in a better way?</p>",
        "id": 153894917,
        "sender_full_name": "Theo Stolker",
        "timestamp": 1498120438
    },
    {
        "content": "<p>That's why we usually wrap it in a CachedResolver. Ease of deployment of a zip, but the speed of memory-access when it is cached. See the ResourceResolverTests.TestCacheInvalidation for an example.</p>",
        "id": 153894924,
        "sender_full_name": "Christiaan Knaap",
        "timestamp": 1498127740
    },
    {
        "content": "<p>Thanks, <span class=\"user-mention\" data-user-id=\"191757\">@Christiaan Knaap</span> </p>",
        "id": 153894971,
        "sender_full_name": "Theo Stolker",
        "timestamp": 1498149811
    },
    {
        "content": "<p>@Theo - as well, you can certainly unpack all the files in an application directory yourself, and then use the DirectorySource class.  Or implement the pretty trivial IResourceResolver interface yourself (on top of -say- a database).  They can be combined with the MultiResolver and CachedResolver to fit any deployment's need!</p>",
        "id": 153895184,
        "sender_full_name": "Ewout Kramer",
        "timestamp": 1498461346
    },
    {
        "content": "<p>Thanks, <span class=\"user-mention\" data-user-id=\"191328\">@Ewout Kramer</span>, I will try that!</p>",
        "id": 153895192,
        "sender_full_name": "Theo Stolker",
        "timestamp": 1498463821
    },
    {
        "content": "<p>Would it make sense to include the file as an embedded resource on your assembly? If the validation is strictly tied to your code and the specification files don't change for a particular assembly, it would make sense to me that the resource is deployed with the code as an embedded resource. I did something similar with validating CDA documents and it works pretty good specially since I don't have to worry about deployment.<br>\nMaybe I am off but just putting this out there just in case.</p>",
        "id": 153895324,
        "sender_full_name": "Miguel Curi",
        "timestamp": 1498589974
    },
    {
        "content": "<p>No, you're completely on subject....I think many times the validation would be tied to your code, and you could deploy it as an embedded resource. I had imagined creating an implementation of IResourceResolver that does just that, say an \"EmbeddedResourceResolver\".  If you'd do that, the .NET validator would be able to locate it and use it in validation.</p>",
        "id": 153895640,
        "sender_full_name": "Ewout Kramer",
        "timestamp": 1498736980
    },
    {
        "content": "<p>That file is quite large too. So depends on usage. It you only need a few resources, lots of waste</p>",
        "id": 153895767,
        "sender_full_name": "Brian Postlethwaite (new)",
        "timestamp": 1498780824
    },
    {
        "content": "<p>Hi Everyone,<br>\nCan someone please guide me or share some C# code examples of implementation of Fhir validation (R4 version 4.0.1) against structural definitions / local profiles.</p>\n<p>For example, I want to validate a Fhir (R4) Json patient object against the Fhir structural definition (Json Schema) at <a href=\"http://build.fhir.org/ig/HL7NZ/nzbase/branches/master/StructureDefinition-NzPatient.profile.json.html\">http://build.fhir.org/ig/HL7NZ/nzbase/branches/master/StructureDefinition-NzPatient.profile.json.html</a></p>\n<p>I have found some examples online but they are all for STU3 (like <a href=\"https://github.com/FirelyTeam/Furore.Fhir.ValidationDemo\">https://github.com/FirelyTeam/Furore.Fhir.ValidationDemo</a>)</p>\n<p>Your help will be much appreciated.</p>\n<p>Thanks,<br>\nAdeel</p>",
        "id": 203795547,
        "sender_full_name": "Adeel Ahmed",
        "timestamp": 1594697261
    },
    {
        "content": "<p>That example github has a branch for R4 too.  And anyway, there is no real difference in the way you would use it.</p>",
        "id": 203891262,
        "sender_full_name": "Ewout Kramer",
        "timestamp": 1594762372
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191328\">Ewout Kramer</span> <a href=\"#narrow/stream/179171-dotnet/topic/Validation/near/203891262\">said</a>:</p>\n<blockquote>\n<p>That example github has a branch for R4 too.  And anyway, there is no real difference in the way you would use it.</p>\n</blockquote>\n<p>Hi Ewout, </p>\n<div class=\"codehilite\"><pre><span></span><code>             Thank you so much for your reply, can you please give me the link to the example that  you are referring too.?\n</code></pre></div>\n\n\n<p>Thanks,<br>\nAdeel</p>",
        "id": 203900941,
        "sender_full_name": "Adeel Ahmed",
        "timestamp": 1594769441
    },
    {
        "content": "<p>Hi Adeel, I meant the Furore.Fhir.ValidationDemo - I wrote that just to show how to invoke the validator.  There's an R4 and a STU3 branch for it - but there's not much difference since the API is the same!</p>",
        "id": 203924056,
        "sender_full_name": "Ewout Kramer",
        "timestamp": 1594798416
    },
    {
        "content": "<p>Hi Ewout, </p>\n<p>Thank you so much  for your quick response - The R4 branch  is not visible on Github for the validation example but I have managed to update an <br>\n older version of  the project to  use R4 dll and was able to get it working without any code changes. <br>\nBut there seems to be an issue - Whenever I am trying to validate a Patient Fhir Json Object it shows me the following error: </p>\n<p>Overall result: FAILURE</p>\n<p>[ERROR] Resolution of profile at '<a href=\"http://hl7.org/fhir/StructureDefinition/Patient\">http://hl7.org/fhir/StructureDefinition/Patient</a>' failed: Type checking the data: Encountered unknown element 'requirements' at location 'StructureDefinition.requirements[0]' while parsing (at Patient)</p>\n<p>I have tried to understand this error and am not able to resolve it EVEN if I am providing with a valid Patient Fhir object / instance its coming back  with the same error. Your help  in this regard will  be highly appreciated.</p>\n<p>Thanks,<br>\nAdeel</p>",
        "id": 204376872,
        "sender_full_name": "Adeel Ahmed",
        "timestamp": 1595204052
    },
    {
        "content": "<p>Hi Adeel....To validate any kind of resource (like Patient), the validator looks at the definitions of FHIR's resources, which are encoded in StructureDefinitions.  In other words, the Validator is configured with these STructureDefinitions, so it knows what Patient looks like.  The error you are getting are not so much because of an error in the Patient data, but an error in the StructureDefinitions that are used to read the metadata.  As you can see here: <a href=\"http://hl7.org/fhir/structuredefinition.html#resource\">http://hl7.org/fhir/structuredefinition.html#resource</a>, there is no \"requirements\" member on StructureDefinition - so it seems this input data (not yours) is wrong.  Do you remember where you got that data from?</p>",
        "id": 204404541,
        "sender_full_name": "Ewout Kramer",
        "timestamp": 1595239140
    },
    {
        "content": "<p>As for the repos, the \"develop\" and \"master\" hold the R4 version, whereas the \"develop-st3\" and \"master-stu3\" have the STU3 version.</p>",
        "id": 204404692,
        "sender_full_name": "Ewout Kramer",
        "timestamp": 1595239255
    },
    {
        "content": "<p>Hi Ewout, <br>\n                Well I tried the Patient output from my application  (under development). The patient output is as below. Besides this I had tried a couple of other examples online and they  came back  with the same output/ error in the validation application. Please do note that I did NOT use any local references (custom structural definitions / custom profiles) Just  the structural definations in \"specification.zip\" were used .<br>\n{<br>\n    \"resourceType\": \"Patient\",<br>\n    \"identifier\": [<br>\n        {<br>\n            \"use\": \"official\",<br>\n            \"type\": {<br>\n                \"coding\": [<br>\n                    {<br>\n                        \"system\": \"ECLR10518\"<br>\n                    }<br>\n                ],<br>\n                \"text\": \"ECLAIRSYSTEM\"<br>\n            },<br>\n            \"value\": \"ECLR10518\"<br>\n        }<br>\n    ],<br>\n    \"name\": [<br>\n        {<br>\n            \"family\": \"Nash\",<br>\n            \"given\": [<br>\n                \"Wayne\"<br>\n            ],<br>\n            \"suffix\": [<br>\n                \"\"<br>\n            ]<br>\n        }<br>\n    ],<br>\n    \"gender\": \"unknown\",<br>\n    \"birthDate\": \"1949-03-27\",<br>\n    \"deceasedBoolean\": false,<br>\n    \"address\": [<br>\n        {<br>\n            \"line\": [<br>\n                \"178 Tancreds Road\"<br>\n            ],<br>\n            \"city\": \"TAITAPU\",<br>\n            \"state\": \"\",<br>\n            \"postalCode\": \"7672\",<br>\n            \"country\": \"\"<br>\n        }<br>\n    ],<br>\n    \"maritalStatus\": {<br>\n        \"coding\": [<br>\n            {<br>\n                \"system\": \"<a href=\"http://hl7.org/fhir/ValueSet/marital-status\">http://hl7.org/fhir/ValueSet/marital-status</a>\",<br>\n                \"code\": \"D\"<br>\n            }<br>\n        ],<br>\n        \"text\": \"Marriage contract has been declared dissolved and inactive\"<br>\n    },<br>\n    \"contact\": [<br>\n        {<br>\n            \"telecom\": [<br>\n                {<br>\n                    \"system\": \"email\",<br>\n                    \"value\": \"\",<br>\n                    \"use\": \"work\"<br>\n                },<br>\n                {<br>\n                    \"system\": \"phone\",<br>\n                    \"value\": \"\",<br>\n                    \"use\": \"work\"<br>\n                },<br>\n                {<br>\n                    \"system\": \"phone\",<br>\n                    \"value\": \"329 6297\",<br>\n                    \"use\": \"home\"<br>\n                },<br>\n                {<br>\n                    \"system\": \"fax\",<br>\n                    \"use\": \"home\"<br>\n                },<br>\n                {<br>\n                    \"system\": \"phone\",<br>\n                    \"use\": \"home\"<br>\n                },<br>\n                {<br>\n                    \"system\": \"phone\",<br>\n                    \"value\": \"\",<br>\n                    \"use\": \"mobile\"<br>\n                }<br>\n            ]<br>\n        }<br>\n    ]<br>\n}</p>\n<hr>\n<p>More examples that  I tried : <br>\n<a href=\"https://www.hl7.org/fhir/patient-example.json.html\">https://www.hl7.org/fhir/patient-example.json.html</a> <br>\n<a href=\"http://fhir.hl7fundamentals.org/r4/Patient/3377/_history/1\">http://fhir.hl7fundamentals.org/r4/Patient/3377/_history/1</a></p>",
        "id": 204620457,
        "sender_full_name": "Adeel Ahmed",
        "timestamp": 1595379402
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"320090\">@Adeel Ahmed</span>  - one obvious problem with that example Patient resource is in the use of the coding data type see <a href=\"http://hl7.org/fhir/datatypes.html#Coding\">http://hl7.org/fhir/datatypes.html#Coding</a>.</p>",
        "id": 204623138,
        "sender_full_name": "Peter Jordan",
        "timestamp": 1595382701
    },
    {
        "content": "<p>Yes, thank  you for pointing that but its not working for the rest  of the examples online as well i.e. comes up  with the same error. <br>\nOther Fhir patient Json examples:</p>\n<p><a href=\"https://www.hl7.org/fhir/patient-example.json.html\">https://www.hl7.org/fhir/patient-example.json.html</a><br>\n<a href=\"http://fhir.hl7fundamentals.org/r4/Patient/3377/_history/1\">http://fhir.hl7fundamentals.org/r4/Patient/3377/_history/1</a></p>",
        "id": 204624729,
        "sender_full_name": "Adeel Ahmed",
        "timestamp": 1595384975
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"320090\">@Adeel Ahmed</span> It looks like the specification definitions are not correct. Could you try to clear your FhirArtifactCache that should be somewhere in your temp folder? If you run your program after that, it should regenerate that FhirArtifactCache with the specification.zip that is in your project.</p>",
        "id": 204636816,
        "sender_full_name": "Mirjam Baltus",
        "timestamp": 1595402563
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191347\">@Mirjam Baltus</span>  -  Deleted FhirArtifactChache folder in the temp and ran the application again - Same error as before:</p>\n<p>Overall result: FAILURE</p>\n<p>[ERROR] Resolution of profile at '<a href=\"http://hl7.org/fhir/StructureDefinition/Patient\">http://hl7.org/fhir/StructureDefinition/Patient</a>' failed: Type checking the data: Encountered unknown element 'requirements' at location 'StructureDefinition.requirements[0]' while parsing (at Patient)</p>\n<p>I tried to validate the Fhir  patient Json provided on the link: <a href=\"https://www.hl7.org/fhir/patient-example.json\">https://www.hl7.org/fhir/patient-example.json</a> <br>\nPlease see the screenshots below of the application and options that  I have selected:</p>\n<p><a href=\"/user_uploads/10155/Yw127ceIPXvAOMN83bck8exo/Validation-issue-screenshot.png\">Validation-issue-screenshot.png</a> </p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/Yw127ceIPXvAOMN83bck8exo/Validation-issue-screenshot.png\" title=\"Validation-issue-screenshot.png\"><img src=\"/user_uploads/10155/Yw127ceIPXvAOMN83bck8exo/Validation-issue-screenshot.png\"></a></div><p><a href=\"/user_uploads/10155/JQZDjEEJPSu0ObuHrVboXl2u/2020_07_23_11_11_28_.NET_Profile_Validation_Tool_1.5.2_DSTU2_.jpg\">2020_07_23_11_11_28_.NET_Profile_Validation_Tool_1.5.2_DSTU2_.jpg</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/JQZDjEEJPSu0ObuHrVboXl2u/2020_07_23_11_11_28_.NET_Profile_Validation_Tool_1.5.2_DSTU2_.jpg\" title=\"2020_07_23_11_11_28_.NET_Profile_Validation_Tool_1.5.2_DSTU2_.jpg\"><img src=\"/user_uploads/10155/JQZDjEEJPSu0ObuHrVboXl2u/2020_07_23_11_11_28_.NET_Profile_Validation_Tool_1.5.2_DSTU2_.jpg\"></a></div>",
        "id": 204733970,
        "sender_full_name": "Adeel Ahmed",
        "timestamp": 1595459724
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191328\">@Ewout Kramer</span>  and <span class=\"user-mention\" data-user-id=\"191347\">@Mirjam Baltus</span>  - This is a Structural definition issue? If so where can I find the updated structural definitions to  replace the faulty structure def in the \"specification.zip\" folder? Your help in this regard is highly appreciated.</p>",
        "id": 204759343,
        "sender_full_name": "Adeel Ahmed",
        "timestamp": 1595477904
    },
    {
        "content": "<p>StructureDefinition.requirements only existed in DSTU2 - it seems somehow you are using the DSTU2 definition zip.  Have you been working with DSTU2 too?  can unzip the specification.zip in your build directory, look for a file called <code>profile-resources.xml</code>, and check the &lt;fhirVersion&gt; element used on the StructureDefinitions inside that file?</p>",
        "id": 204774692,
        "sender_full_name": "Ewout Kramer",
        "timestamp": 1595495127
    }
]