[
    {
        "content": "<p>I have a segment of a PlanDefinition that utilizes two subpopulations that looks like this: <br>\n{<br>\n    \"title\": \"Use only if benefit outweighs risk and monitor patient ECG\",<br>\n    \"description\": \"Increased risk of prolonged QTc likely\",<br>\n    \"condition\": [{<br>\n        \"kind\": \"applicability\",<br>\n        \"expression\": {<br>\n            \"language\": \"text/cql\",<br>\n            \"expression\": \"There exists a medication statement with a code from Citaloprams whose value is greater than or equal to 60 mg/d OR There exists a medication request with a code from Citaloprams whose value is greater than or equal to 60 mg/d\"<br>\n        }<br>\n    }, {<br>\n        \"kind\": \"applicability\",<br>\n        \"expression\": {<br>\n            \"language\": \"text/cql\",<br>\n            \"expression\": \"There exists a medication statement with a code from QT Prolonging Agents OR There exists a medication request with a code from QT Prolonging Agents\"<br>\n        }<br>\n    }],<br>\n    \"dynamicValue\": [{<br>\n        \"path\": \"activity.extension\",<br>\n        \"expression\": {<br>\n            \"language\": \"text/cql\",<br>\n            \"expression\": \"Indicator\"<br>\n        }<br>\n    }],<br>\n    \"action\": [{<br>\n        \"prefix\": \"Usually Avoid Combination\"<br>\n    }]<br>\n}</p>\n<p>My problem is that when I run this rule I get a card returned when each expression is true. My understanding was that if I have multiple conditions they are combined using AND semantics  so the overall condition is only true if both conditions are true. Therefore I should only have 1 card returned instead of two identical ones.</p>",
        "id": 240380310,
        "sender_full_name": "Rich Boyce",
        "timestamp": 1622058358
    },
    {
        "content": "<p>That's my understanding as well based upon the <a href=\"https://www.hl7.org/fhir/plandefinition-definitions.html#PlanDefinition.action.condition\">comment on the condition element</a>.</p>",
        "id": 240446201,
        "sender_full_name": "David Winters",
        "timestamp": 1622111600
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"196276\">@Rich Boyce</span> I'm assuming you're using cqf-ruler?  Have you tried testing the CQL separately to ensure it's operating the way you expect it to?</p>",
        "id": 240446403,
        "sender_full_name": "David Winters",
        "timestamp": 1622111727
    },
    {
        "content": "<p>I am using the cqf-ruler. I have tested portions of the CQL and it seems to work appropriately, however when I string the entire thing together as in the section I shared, that is when I am experiencing odd behavior</p>",
        "id": 240452252,
        "sender_full_name": "Rich Boyce",
        "timestamp": 1622115428
    },
    {
        "content": "<p>That is not expected behavior, especially if youâ€™re getting duplicate cards from the same action. Is there a way we can repro?</p>",
        "id": 240461408,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1622119780
    },
    {
        "content": "<p>I can bundle the PlanDefinition, Library, CQL, ValueSets, and the patient-view request I am making if you would like. Currently I am testing this locally.</p>",
        "id": 240463908,
        "sender_full_name": "Rich Boyce",
        "timestamp": 1622120814
    },
    {
        "content": "<p>I think the issue is in <a href=\"https://github.com/DBCG/org-opencds-cqf-cds/blob/master/src/main/java/org/opencds/cqf/cds/hooks/R4HookEvaluator.java\">https://github.com/DBCG/org-opencds-cqf-cds/blob/master/src/main/java/org/opencds/cqf/cds/hooks/R4HookEvaluator.java</a>. It doesn't seem to me that the logic described in the HL7 documentation is met here. I think actionComponents should be a Set instead of a List and if conditionsMet is false then actionComponents should be cleared.</p>",
        "id": 240639133,
        "sender_full_name": "Rich Boyce",
        "timestamp": 1622224445
    },
    {
        "content": "<p>Would you mind filing an issue on that github repo?</p>",
        "id": 240645644,
        "sender_full_name": "JP",
        "timestamp": 1622227598
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"194178\">@JP</span> Will do</p>",
        "id": 240647377,
        "sender_full_name": "Rich Boyce",
        "timestamp": 1622228585
    }
]