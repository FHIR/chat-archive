[
    {
        "content": "<p>I recently came across the <code>cqf-tooling</code> repo, and was wondering if there is support for generating ModelInfo from custom  FHIR structure definitions. I have been handed some FHIR shorthand as input and generate the structure definitions from the shorthand.</p>\n<p>It seems like <code>StructureDefinitionToModelInfo</code> expects to fail when not running for one of the implemented models (<a href=\"https://github.com/cqframework/cqf-tooling/blob/f1c3ed8d9c14dc8c5af37556ff678953e1c33e32/src/main/java/org/opencds/cqf/modelinfo/StructureDefinitionToModelInfo.java#L141\">https://github.com/cqframework/cqf-tooling/blob/f1c3ed8d9c14dc8c5af37556ff678953e1c33e32/src/main/java/org/opencds/cqf/modelinfo/StructureDefinitionToModelInfo.java#L141</a>), and indeed the program has null pointer exceptions related to class/model info objects when running with a custom model name.</p>\n<p>Is the best way around this to implement the <code>ClassInfoBuilder/ModelInfoBuilder</code> classes for the custom structures I have? Alternatively, is there a way to use one of the existing models, but provide my own definitions? Or is this tool not intended for what I am trying to accomplish?</p>\n<p>If anyone  has any advice or pointers I would greatly appreciate it. Thanks!</p>",
        "id": 211784611,
        "sender_full_name": "Matt Sargent",
        "timestamp": 1601482447
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"261034\">@Matt Sargent</span> , yes this tool is definitely intended to support what you are trying to do, but it is a bit hard-coded/in-flight right now. You can extend it by imlementing a ClassInfoBuilder/ModelInfoBuilder for your set of structure definitions.</p>",
        "id": 211812912,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1601496327
    },
    {
        "content": "<p>We are working right now on that use case, driving a ModelInfo entirely from the structuredefinitions in an IG, and further, using the profile constraints and extensions to inform the classes in the ModelInfo.</p>",
        "id": 211813056,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1601496391
    },
    {
        "content": "<p>For example, take a look at this <a href=\"https://github.com/DBCG/cql-evaluator/blob/develop/evaluator.cli/src/test/resources/r4/TestFHIR.cql#L94\">FHIR-based</a> test versus the equivalent <a href=\"https://github.com/DBCG/cql-evaluator/blob/develop/evaluator.cli/src/test/resources/uscore/TestUSCore.cql#L82\">US-Core-based</a> test to see how the profiles inform the ModelInfo and simplify the resulting CQL.</p>",
        "id": 211813414,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1601496554
    },
    {
        "content": "<p>Thanks for the response! I will plan on trying to implement ClassInfo/ModelInfo for our definitions.</p>\n<p>I have to look over the code a bit more first to try to understand the differences between the available ClassInfo* and ModelInfo* classes before I know which model's patterns to use for our model, but it is useful to know that this is an intended use case for the tooling.</p>",
        "id": 211816159,
        "sender_full_name": "Matt Sargent",
        "timestamp": 1601497893
    },
    {
        "content": "<p>I had a follow up question about should be the expected input when creating a ModelInfo with this tool? Should I be using just the custom structure definitions, or should I be passing in the custom definitions + the FHIR structure definitions?</p>\n<p>Likewise, when writing a <code>ClassInfoBuilder</code> should my target be something  like the one written for USCore (which seems to list out explicitly what is in USCore) or FHIR (that seems to be looking at the structure definitions themselves so that there is not a need to list out everything).</p>\n<p>I wasn't sure if the convention is to try to generate a ModelInfo  that just captures custom definitions, or  if the goal is to try to generate an uber-ModelInfo that would have base FHIR + the custom definitions. Is the tooling you mentioned for generating ModelInfo from an IG targeting one/both of these use cases?</p>",
        "id": 211968146,
        "sender_full_name": "Matt Sargent",
        "timestamp": 1601583413
    },
    {
        "content": "<p>It covers both use cases. In the case of the base FHIR Structure Definitions (which are just the StructureDefinitions published with FHIR), it's creating a complete ModelInfo that doesn't list specifics, it just includes everything that's there.</p>",
        "id": 211980232,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1601588972
    },
    {
        "content": "<p>In the case of specific IGs, we list out the profiles there because we don't yet have the code that says \"just use the profiles defined in this implementation guide\", though that is the next step to be automated.</p>",
        "id": 211980323,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1601589016
    },
    {
        "content": "<p>Within the use case of \"build a model info for an IG\", there are two potential approaches we're considering: 1) Flatten, so that the profiles provide a complete, flattened set of all and only the structures available, or 2) Derive, preserving the profile hierarchy and still allowing access to the base FHIR structures.</p>",
        "id": 211980764,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1601589264
    },
    {
        "content": "<p>The tooling supports both approaches, because that's a question we're still trying to answer (and the answer may actually be that both use cases are needed).</p>",
        "id": 211980802,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1601589290
    },
    {
        "content": "<p>Thanks again for the context. I'm glad to know that generating the ModelInfo for an IG is a somewhat open question and that we have multiple options. I mostly wanted to make sure that I wasn't going down a path that was frowned upon/not intended.</p>",
        "id": 212086280,
        "sender_full_name": "Matt Sargent",
        "timestamp": 1601651013
    },
    {
        "content": "<p>Thanks again for answering my initial questions. I was able to work with the tooling this week and generate a ModelInfo based off our IG. Figured I would follow up here with a couple of mistakes I made along the way in case anyone else is interested using this tooling for their own IG before that type of support is added natively.</p>\n<ol>\n<li>The StructureDefinitions for our IG were initally generated with only the differential (no snapshot) included. I had to go circle back around and regenerate the definitions to also include the snapshot so that the ModelInfo had all of the correct elements included. Our definitions are written using FSH and generated with SUSHI, so this was easy enough to accomplish with <code>sushi -s path/to/our/defs</code>.</li>\n<li>It took several runs for me to realize that some errors will log a message, but not halt execution.  I was running in an IDE, so switching my logging to a file was helpful for me so errors did not accidentally page out of the internal console in my IDE and go unnoticed.</li>\n<li>I had to modify several StructureDefinitions where slicing was in use. SUSHI defaults to using <code>pattern</code> for slices rather than <code>fixed</code> and the ModelInfo generation code was failing to process some slices due to calling <code>getFixed()</code> returning <code>null</code> for the slice definition. Using the <code>(exactly)</code> syntax for SUSHI generated new definitions that got past this issue.</li>\n</ol>\n<p>Hopefully someone might stumble across this in the future and find one of these things helpful.</p>",
        "id": 212866275,
        "sender_full_name": "Matt Sargent",
        "timestamp": 1602271732
    }
]