[
    {
        "content": "<p>Hi folks. I've got a simple $evaluate-measure operation that appears to be working on a Measure in the sense that it is processed (using HAPI v5.3). But, it's missing the calculations, e.g. proportion, or counts. How can I troubleshoot why I'm not seeing the calculations? Here's an output...</p>\n<div class=\"codehilite\"><pre><span></span><code>{\n  &quot;resourceType&quot;: &quot;MeasureReport&quot;,\n  &quot;status&quot;: &quot;complete&quot;,\n  &quot;type&quot;: &quot;summary&quot;,\n  &quot;measure&quot;: &quot;Measure/HIVSimpleGender2&quot;,\n  &quot;period&quot;: {\n    &quot;start&quot;: &quot;1970-01-01T00:00:00-05:00&quot;,\n    &quot;end&quot;: &quot;2021-01-01T00:00:00-05:00&quot;\n  }\n}\n</code></pre></div>",
        "id": 240230098,
        "sender_full_name": "Richard Stanley",
        "timestamp": 1621967164
    },
    {
        "content": "<p>Hi Richard,</p>\n<p>Are you able to post the parameters you're using for $evaluate-measure and the Measure resource you're using?</p>",
        "id": 240232867,
        "sender_full_name": "JP",
        "timestamp": 1621968489
    },
    {
        "content": "<p>Since, I've seen the measure definition... you've defined three groups where you should have one group with three populations (the measure-population code goes with the population instance rather than with the group), e.g., something like:</p>\n<div class=\"codehilite\"><pre><span></span><code>  &quot;group&quot;: [\n    {\n      &quot;code&quot;: {\n         &quot;text&quot;: &quot;cohort&quot;\n      },\n      &quot;description&quot;: &quot;HIVSimpleGender2 Cohort&quot;,\n      &quot;population&quot;: [\n        {\n          &quot;description&quot;: &quot;HIVSimpleGender2 Initial Population&quot;,\n          &quot;code&quot;: {\n            &quot;coding&quot;: [\n              {\n                &quot;system&quot;: &quot;http://terminology.hl7.org/CodeSystem/measure-population&quot;,\n                &quot;code&quot;: &quot;initial-population&quot;\n              }\n            ]\n          },\n          &quot;criteria&quot;: {\n            &quot;language&quot;: &quot;text/cql&quot;,\n            &quot;expression&quot;: &quot;Initial Population&quot;\n          }\n        },\n        {\n          &quot;description&quot;: &quot;HIVSimpleGender2 Numerator&quot;,\n          &quot;code&quot;: {\n            &quot;system&quot;: &quot;http://terminology.hl7.org/CodeSystem/measure-population&quot;,\n            &quot;code&quot;: &quot;numerator&quot;\n          },\n          &quot;criteria&quot;: {\n            &quot;language&quot;: &quot;text/cql&quot;,\n            &quot;expression&quot;: &quot;Numerator&quot;\n          }\n        },\n        {\n          &quot;description&quot;: &quot;HIVSimpleGender2 Denominator&quot;,\n          &quot;code&quot;: {\n            &quot;system&quot;: &quot;http://terminology.hl7.org/CodeSystem/measure-population&quot;,\n            &quot;code&quot;: &quot;denominator&quot;\n          },\n          &quot;criteria&quot;: {\n            &quot;language&quot;: &quot;text/cql&quot;,\n            &quot;expression&quot;: &quot;Denominator&quot;\n          }\n        }\n      ]\n    }\n  ]\n</code></pre></div>\n<p>Is probably closer to correct.  See <a href=\"https://www.hl7.org/fhir/clinicalreasoning-quality-reporting.html\">this page</a> on the relationship between groups, populations and measures.</p>",
        "id": 240232997,
        "sender_full_name": "Ian Bacher",
        "timestamp": 1621968564
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"259065\">@Ian Bacher</span> I'll have a go at it with that correction!</p>",
        "id": 240234200,
        "sender_full_name": "Richard Stanley",
        "timestamp": 1621969187
    },
    {
        "content": "<p>Solved. Thanks <span class=\"user-mention\" data-user-id=\"194178\">@JP</span> <span class=\"user-mention\" data-user-id=\"259065\">@Ian Bacher</span> for sharing your boss-level FHIR expertise.</p>",
        "id": 240242313,
        "sender_full_name": "Richard Stanley",
        "timestamp": 1621972917
    },
    {
        "content": "<p>I'll add a quick follow-up. I've been trying different types of measure scoring. What I would like is an output per patient similar to 'Execute CQL' in the Atom plugin. Is there a way to do that using a FHIR measure? Or, does this just have to be done on each patient in a loop? A use case would be outputing patient-level evaluations for an epidemiology dataset.</p>",
        "id": 240674517,
        "sender_full_name": "Richard Stanley",
        "timestamp": 1622248840
    },
    {
        "content": "<p>That's the <code>patient-list</code> (DSTU3) and <code>subject-list</code> (R4) Measure types, though the current implementation doesn't include a report-per-patient.</p>",
        "id": 240677150,
        "sender_full_name": "JP",
        "timestamp": 1622252880
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"194178\">@JP</span> I'll have a go at it. Thanks for the helpful answer on the weekend :)</p>",
        "id": 240680857,
        "sender_full_name": "Richard Stanley",
        "timestamp": 1622259768
    },
    {
        "content": "<p>Hi Richard!</p>\n<p>The supplemental data is supposed to be included as an Observation with a value:</p>\n<p><a href=\"https://www.hl7.org/fhir/clinicalreasoning-quality-reporting.html#stratification-and-supplemental-data\">https://www.hl7.org/fhir/clinicalreasoning-quality-reporting.html#stratification-and-supplemental-data</a></p>\n<p>In your example is does include a placeholder Observation, but not the \"Hello, world\" value. Looking at the implementation it currently only supported \"Code\" types, and not String, Integers, Quantities, etc. You could try having the \"Hello, world\" definition return a Code just to verify that it does work. I'll have to follow-up with <span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span> to see if the limitation around codes was intended or not.</p>",
        "id": 240987883,
        "sender_full_name": "JP",
        "timestamp": 1622573808
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"194178\">@JP</span> Thanks, that was a silly test to confirm it and I'll try what you suggest. Related, is there a working fhirpath example that returns a value? Returning a value is the use case, e.g. the Location for the most recent Encounter.</p>\n<p>If you don't mind one other clarification: I see the Observation but it's an inline resources but doesn't exist at Observation/id.</p>\n<p>Update: Tried, so coded expressions are not returning codes. <br>\nHere's the CQL:</p>\n<div class=\"codehilite\"><pre><span></span><code>define &quot;Female&quot;:\n  Patient.gender = &#39;female&#39;\n</code></pre></div>\n<p>Here's the Measure part:</p>\n<div class=\"codehilite\"><pre><span></span><code>  &quot;supplementalData&quot;: [\n    {\n      &quot;code&quot;: {\n        &quot;text&quot;: &quot;supplemental-data-example-define&quot;\n      },\n      &quot;criteria&quot;: {\n        &quot;language&quot;: &quot;text/cql&quot;,\n        &quot;expression&quot;: &quot;Female&quot;\n      }\n    }\n  ]\n</code></pre></div>\n<p>The response for an individual-level run (with patient=89) is here: <a href=\"https://pastebin.com/7U2epmpW\">https://pastebin.com/7U2epmpW</a></p>\n<p>Update: The searchset doesn't contain the string 'Hello, World!'. So, no string is returned in the inline contained resource either.</p>\n<p>Another update: Ok, so very simple stratifiers do not seem to enumerate either and are not contained in the inlined obs resource. Try:</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"nt\">\"stratifier\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n  <span class=\"p\">{</span>\n    <span class=\"nt\">\"code\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n      <span class=\"nt\">\"text\"</span><span class=\"p\">:</span> <span class=\"s2\">\"stratifier-gender\"</span>\n    <span class=\"p\">},</span>\n    <span class=\"nt\">\"criteria\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n      <span class=\"nt\">\"language\"</span><span class=\"p\">:</span> <span class=\"s2\">\"text/fhirpath\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"expression\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Patient.gender\"</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">]</span>\n</code></pre></div>\n<p><span class=\"user-mention\" data-user-id=\"194178\">@JP</span> <span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span> I would be super happy to know here if I'm making a mistake. :)</p>",
        "id": 240989603,
        "sender_full_name": "Richard Stanley",
        "timestamp": 1622574699
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"cql\"><pre><span></span><code>define \"Female\":\n  Patient.gender = 'female'\n</code></pre></div>\n<p>actually returns a Boolean. Try:</p>\n<div class=\"codehilite\" data-code-language=\"cql\"><pre><span></span><code>define \"SDE Sex\":\n  case\n    when Patient.gender = 'male' then Code { code: 'M', system: 'http://hl7.org/fhir/v3/AdministrativeGender', display: 'Male' }\n    when Patient.gender = 'female' then Code { code: 'F', system: 'http://hl7.org/fhir/v3/AdministrativeGender', display: 'Female' }\n    else null\n  end\n</code></pre></div>\n<p>with the corresponding Measure updates.</p>",
        "id": 241178188,
        "sender_full_name": "JP",
        "timestamp": 1622653281
    },
    {
        "content": "<blockquote>\n<p>it's an inline resources but doesn't exist at Observation/id.</p>\n</blockquote>\n<p>I don't quite follow this. Are you expecting the resource to be persisted to the FHIR server? I do see the Observation resource included in the <code>MeasureReport</code> as a contained resource in your example at <a href=\"https://pastebin.com/7U2epmpW\">https://pastebin.com/7U2epmpW</a></p>",
        "id": 241178481,
        "sender_full_name": "JP",
        "timestamp": 1622653402
    },
    {
        "content": "<p>Thanks, indeed the observation is created inline and can be obtained (I wasn't including the #). However, in that searchset there is nothing for the supplemental data.</p>\n<p>For the stratifier test, I get a warning in qa: \"The expression language text/fhirpath is not supported, so can't be validated\". This is from this example: <a href=\"https://www.hl7.org/fhir/measure-cms146-example.json.html\">https://www.hl7.org/fhir/measure-cms146-example.json.html</a></p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"nt\">\"stratifier\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n  <span class=\"p\">{</span>\n    <span class=\"nt\">\"code\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n      <span class=\"nt\">\"text\"</span><span class=\"p\">:</span> <span class=\"s2\">\"stratifier-gender\"</span>\n    <span class=\"p\">},</span>\n    <span class=\"nt\">\"criteria\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n      <span class=\"nt\">\"language\"</span><span class=\"p\">:</span> <span class=\"s2\">\"text/fhirpath\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"expression\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Patient.gender\"</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">]</span>\n</code></pre></div>\n<p>Is that syntax different now?</p>",
        "id": 241179127,
        "sender_full_name": "Richard Stanley",
        "timestamp": 1622653700
    },
    {
        "content": "<p>The current Measure evaluation doesn't support stratifiers or fhirPath, though support for both is one of my main projects over the past couple weeks.</p>",
        "id": 241180297,
        "sender_full_name": "JP",
        "timestamp": 1622654233
    },
    {
        "content": "<p>Ok, I'll happily be a tester :) Also, yes declaring the code works in that F is displayed in the MeasureReport directly.</p>",
        "id": 241292200,
        "sender_full_name": "Richard Stanley",
        "timestamp": 1622655308
    },
    {
        "content": "<p>My use case is to either output a per-patient MeasureReport with the Location of their last Encounter, or to aggregate patients by Location of Encounter. Is there a way to do that without stratifiers? If supplemental data, does that mean a ValueSet/CodeSystem of all Locations?</p>",
        "id": 241292373,
        "sender_full_name": "Richard Stanley",
        "timestamp": 1622655385
    },
    {
        "content": "<p>Stratification allows aggregation by location (or by pretty much any other criteria) so once it's done (I anticipate it'll be a week or so) it ought to work for your use case. You could do it with supplemental data and a code. You wouldn't necessarily have to define a ValueSet, just define a Location-based code inline. Working with references is a bit tricky currently, but it looks something like:</p>\n<div class=\"codehilite\" data-code-language=\"cql\"><pre><span></span><code>define function \"GetId\"(uri String):\n    Last(Split(uri, '/'))\n\ndefine function \"GetLocation\"(reference Reference):\n  singleton from (\n    [Location] Location where Location.id.value = GetId(reference.reference)\n  )\n\ndefine \"Location\":\n    First([Encounter] E return \"GetLocation\"(First(E.location).location))\n\ndefine \"SDE Location\":\n    Code { code: \"Location\".name, system: 'http://location-name-code-system' }\n</code></pre></div>",
        "id": 241310232,
        "sender_full_name": "JP",
        "timestamp": 1622663342
    },
    {
        "content": "<p>I cribbed heavily from <a href=\"https://github.com/DBCG/connectathon/blob/28d976d5e2ecf8ffa9badb82964395877323b63f/fhir3/2019/input/pagecontent/cql/MATGlobalCommonFunctions_FHIR3-2.0.000.cql\">https://github.com/DBCG/connectathon/blob/28d976d5e2ecf8ffa9badb82964395877323b63f/fhir3/2019/input/pagecontent/cql/MATGlobalCommonFunctions_FHIR3-2.0.000.cql</a></p>",
        "id": 241310275,
        "sender_full_name": "JP",
        "timestamp": 1622663379
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"194178\">@JP</span> I'll give it a go!</p>",
        "id": 241310943,
        "sender_full_name": "Richard Stanley",
        "timestamp": 1622663675
    }
]