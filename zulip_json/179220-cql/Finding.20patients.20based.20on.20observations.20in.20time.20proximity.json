[
    {
        "content": "<p>I have a client who wanted to know how to query for data like this: \"Find me all patients who had observations with  glucose &gt; 150 mg/dL(UCUM) and  and Hemoblogin  &lt; 10 mg/dK (UCUM)  on the same day\"</p>\n<p>\"on the same day\" could be \"has the same data\" or could be \"within 24 hours\" - whichever is easier.  I'm pretty sure we <em>can't</em> do that with REST, _query or graphql.  So CQL, you're my only hope! :)</p>\n<p>Is it possible to write a query that would do that?  (<span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span> )</p>",
        "id": 185139883,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1578506883
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> -- I have to run to a meeting, but here is an example I wrote up showing one approach to using CQL to find patients that meet certain criteria.  The criteria is defined in the <code>Patient</code> context in terms of a specific patient and then the <code>Population</code> context (now <code>Unfiltered</code> context in CQL 1.4) aggregates it at a population level.  It obviously doesn't align with your specific query, but maybe it is still helpful as a start: <a href=\"https://github.com/cqframework/cql-exec-examples/blob/master/patient-finder/r4/cql/PatientFinderExample.cql\" target=\"_blank\" title=\"https://github.com/cqframework/cql-exec-examples/blob/master/patient-finder/r4/cql/PatientFinderExample.cql\">https://github.com/cqframework/cql-exec-examples/blob/master/patient-finder/r4/cql/PatientFinderExample.cql</a></p>",
        "id": 185142224,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1578508442
    },
    {
        "content": "<p>The question isn't really about how to find patients based on criteria (that I can do).  It's more about how to express a criterion that is the presence of two Observations of different types with a maximum time gap between them.  That's more advanced than I know how to do.  (And could possibly be more advanced than what CQL is capable of doing.)  Understand folks are busy today at the connectathon, but wanted to raise it before I forgot to.</p>",
        "id": 185142610,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1578508645
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 185151138,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1578513793
    },
    {
        "content": "<p>I can't test or compile this right now, but I think you basically want this?</p>\n<div class=\"codehilite\"><pre><span></span>define &quot;HasSameDayTestCriteria&quot;:\n  exists (\n    [Observation: &quot;Glucose Test&quot;] G\n    with [Observation: &quot;Hemoglobin Test&quot;] H\n    such that\n      (G.value as Quantity) &gt; 150 &#39;mg/dL&#39;\n      and (H.value as Quantity) &lt; 10 &#39;mg/dK&#39;\n      and G.issued.value same day as H.issued.value\n  )\n</pre></div>",
        "id": 185151267,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1578513872
    },
    {
        "content": "<p>That assumes you've set up value sets for the observations and that you want it based on <code>issued</code> -- but it would be trivial to do it based on <code>effectiveDateTime</code> instead (although it involves more casts since those are choices).</p>",
        "id": 185151332,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1578513930
    },
    {
        "content": "<p>OK, it does compile at least.  That one is using <code>same day as</code>, which is looking for them to be on the same calendar day.  But if you want them within 24 hours instead, then you can replace <code>same day as</code> with <code>within 24 hours of</code>.</p>",
        "id": 185151613,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1578514122
    },
    {
        "content": "<p>effectiveDateTime would be better.  But the fact that it's at least theoretically possible is great.  Thanks Chris!</p>",
        "id": 185170581,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1578527616
    },
    {
        "content": "<p>Didn't compile it, but I think you're basically looking at something like this then:</p>\n<div class=\"codehilite\"><pre><span></span>define &quot;HasSameDayTestCriteria&quot;:\n  exists (\n    [Observation: &quot;Glucose Test&quot;] G\n    with [Observation: &quot;Hemoglobin Test&quot;] H\n    such that\n      (G.value as Quantity) &gt; 150 &#39;mg/dL&#39;\n      and (H.value as Quantity) &lt; 10 &#39;mg/dK&#39;\n      and (G.effective as DateTime) same day as (H.effective as DateTime)\n  )\n</pre></div>",
        "id": 185175547,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1578532838
    }
]