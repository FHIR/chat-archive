[
    {
        "content": "<p>I have the DSTU3 version of the CQF-Ruler running locally and have posted a plan definition and library bundle, however, whenever I attempt to post an order-select command I get an error whenever the CQL logic is trying to be converted into ELM: </p>\n<div class=\"codehilite\"><pre><span></span><code>Caused by: java.lang.IllegalArgumentException: [Warfarin_NSAIDs_CDS-1.0[45:5, 48:5]Could not resolve call to operator Flatten with signature (list&lt;System.String&gt;)., Warfarin_NSAIDs_CDS-1.0[97:7, 97:38]Could not resolve membership operator for terminology target of the retrieve., Warfarin_NSAIDs_CDS-1.0[102:7, 102:45]Could not resolve membership operator for terminology target of the retrieve., Warfarin_NSAIDs_CDS-1.0[107:7, 107:39]Could not resolve membership operator for terminology target of the retrieve., Warfarin_NSAIDs_CDS-1.0[112:7, 112:40]Could not resolve membership operator for terminology target of the retrieve., Warfarin_NSAIDs_CDS-1.0[95:3, 116:3]Could not resolve call to operator Flatten with signature (list&lt;FHIR.Coding&gt;)., Warfarin_NSAIDs_CDS-1.0[92:11, 92:23]Could not validate reference to expression Warfarin Rx because its definition contains errors., Warfarin_NSAIDs_CDS-1.0[72:10, 72:34]Could not validate reference to expression Is warfarin in prefetch because its definition contains errors., Warfarin_NSAIDs_CDS-1.0[132:20, 132:32]Could not validate reference to expression Warfarin Rx because its definition contains errors., Warfarin_NSAIDs_CDS-1.0[45:5, 48:5]Could not resolve call to operator Flatten with signature (list&lt;System.String&gt;)., Warfarin_NSAIDs_CDS-1.0[45:5, 48:5]Could not resolve call to operator Flatten with signature (list&lt;System.String&gt;)., Warfarin_NSAIDs_CDS-1.0[148:5, 148:38]Could not resolve call to operator GetDrugNames with signature (list&lt;FHIR.Coding&gt;)., Warfarin_NSAIDs_CDS-1.0[45:5, 48:5]Could not resolve call to operator Flatten with signature (list&lt;System.String&gt;)., Warfarin_NSAIDs_CDS-1.0[155:5, 155:38]Could not resolve call to operator GetDrugNames with signature (list&lt;FHIR.Coding&gt;)., Warfarin_NSAIDs_CDS-1.0[190:7, 190:50]Could not resolve membership operator for terminology target of the retrieve., Warfarin_NSAIDs_CDS-1.0[195:7, 195:57]Could not resolve membership operator for terminology target of the retrieve., Warfarin_NSAIDs_CDS-1.0[200:7, 200:51]Could not resolve membership operator for terminology target of the retrieve., Warfarin_NSAIDs_CDS-1.0[205:7, 205:52]Could not resolve membership operator for terminology target of the retrieve., Warfarin_NSAIDs_CDS-1.0[188:2, 209:3]Could not resolve call to operator Flatten with signature (list&lt;FHIR.Coding&gt;)., Warfarin_NSAIDs_CDS-1.0[185:11, 185:36]Could not validate reference to expression PPIs and Misoprostols Rx because its definition contains errors., Warfarin_NSAIDs_CDS-1.0[164:6, 164:32]Could not validate reference to expression Taking PPI or misoprostol because its definition contains errors., Warfarin_NSAIDs_CDS-1.0[169:6, 169:32]Could not validate reference to expression Taking PPI or misoprostol because its definition contains errors., Warfarin_NSAIDs_CDS-1.0[179:6, 179:32]Could not validate reference to expression Taking PPI or misoprostol because its definition contains errors., Warfarin_NSAIDs_CDS-1.0[245:5, 245:39]Could not resolve membership operator for terminology target of the retrieve., Warfarin_NSAIDs_CDS-1.0[240:3, 240:32]Could not resolve call to operator Exists with signature (FHIR.Condition)., Warfarin_NSAIDs_CDS-1.0[215:6, 215:32]Could not validate reference to expression Age &gt; 65 years or Hx UGIB because its definition contains errors., Warfarin_NSAIDs_CDS-1.0[220:6, 220:32]Could not validate reference to expression Age &gt; 65 years or Hx UGIB because its definition contains errors., Warfarin_NSAIDs_CDS-1.0[232:6, 232:32]Could not validate reference to expression Taking PPI or misoprostol because its definition contains errors., Warfarin_NSAIDs_CDS-1.0[290:7, 290:53]Could not resolve membership operator for terminology target of the retrieve., Warfarin_NSAIDs_CDS-1.0[295:7, 295:60]Could not resolve membership operator for terminology target of the retrieve., Warfarin_NSAIDs_CDS-1.0[300:7, 300:54]Could not resolve membership operator for terminology target of the retrieve., Warfarin_NSAIDs_CDS-1.0[305:7, 305:55]Could not resolve membership operator for terminology target of the retrieve., Warfarin_NSAIDs_CDS-1.0[288:2, 309:3]Could not resolve call to operator Flatten with signature (list&lt;FHIR.Coding&gt;)., Warfarin_NSAIDs_CDS-1.0[285:11, 285:39]Could not validate reference to expression Systemic Corticosteroids Rx because its definition contains errors., Warfarin_NSAIDs_CDS-1.0[280:3, 280:32]Could not validate reference to expression Has Systemic Corticosteroids because its definition contains errors., Warfarin_NSAIDs_CDS-1.0[317:7, 317:52]Could not resolve membership operator for terminology target of the retrieve., Warfarin_NSAIDs_CDS-1.0[322:7, 322:59]Could not resolve membership operator for terminology target of the retrieve., Warfarin_NSAIDs_CDS-1.0[327:7, 327:53]Could not resolve membership operator for terminology target of the retrieve., Warfarin_NSAIDs_CDS-1.0[332:7, 332:54]Could not resolve membership operator for terminology target of the retrieve., Warfarin_NSAIDs_CDS-1.0[315:2, 336:3]Could not resolve call to operator Flatten with signature (list&lt;FHIR.Coding&gt;)., Warfarin_NSAIDs_CDS-1.0[312:11, 312:38]Could not validate reference to expression Aldosterone Antagonists Rx because its definition contains errors., Warfarin_NSAIDs_CDS-1.0[344:7, 344:35]Could not resolve membership operator for terminology target of the retrieve., Warfarin_NSAIDs_CDS-1.0[349:7, 349:42]Could not resolve membership operator for terminology target of the retrieve., Warfarin_NSAIDs_CDS-1.0[354:7, 354:36]Could not resolve membership operator for terminology target of the retrieve., Warfarin_NSAIDs_CDS-1.0[359:7, 359:37]Could not resolve membership operator for terminology target of the retrieve., Warfarin_NSAIDs_CDS-1.0[342:2, 363:3]Could not resolve call to operator Flatten with signature (list&lt;FHIR.Coding&gt;)., Warfarin_NSAIDs_CDS-1.0[339:11, 339:20]Could not validate reference to expression NSAID Rx because its definition contains errors., Warfarin_NSAIDs_CDS-1.0[253:6, 253:32]Could not validate reference to expression Taking CS, MCRA, or NSAID because its definition contains errors., Warfarin_NSAIDs_CDS-1.0[258:6, 258:32]Could not validate reference to expression Taking CS, MCRA, or NSAID because its definition contains errors., Warfarin_NSAIDs_CDS-1.0[272:6, 272:32]Could not validate reference to expression Taking PPI or misoprostol because its definition contains errors.]\n</code></pre></div>\n\n\n<p>I have cloned the clinical_quality_language (<a href=\"https://github.com/cqframework/clinical_quality_language\">https://github.com/cqframework/clinical_quality_language</a>) and was able to successfully convert the same CQL. I attempted this again with the 1.4.9 tag and encountered the same errors listed above. Finally, I updated the pom in the CQF-Ruler project to use 1.5.0-SNAPSHOT version for cql-engine.version but then encountered the following issue at the same step (it would appear that this was done at one point according to GitHub history):</p>\n<div class=\"codehilite\"><pre><span></span><code>java.lang.NoClassDefFoundError: org/cqframework/cql/gen/cqlParser$CodeComparatorContext\n</code></pre></div>\n\n\n<p>What would be recommended in order to move forward?</p>",
        "id": 207567351,
        "sender_full_name": "Rich Boyce",
        "timestamp": 1597953448
    },
    {
        "content": "<p>Can you open that CQL library in an Atom editor and see if you get any validation errors?</p>",
        "id": 207593878,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1597974444
    },
    {
        "content": "<p>And which branch of the ruler are you using, master or develop?</p>",
        "id": 207593969,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1597974582
    },
    {
        "content": "<p>I am working on the develop branch. I am not too familiar with atom but I did install the application as well as the \"language-cql\" package. I do not see any errors on the CQL file but get the following error when I try to execute it: </p>\n<div class=\"codehilite\"><pre><span></span><code>org.cqframework.cql.cql2elm.CqlTranslatorIncludeException: Could not load source for library warfarin, version null.\n    at org.cqframework.cql.cql2elm.LibraryManager.translateLibrary(LibraryManager.java:105)\n    at org.cqframework.cql.cql2elm.LibraryManager.resolveLibrary(LibraryManager.java:90)\n    at org.opencds.cqf.cql.evaluator.execution.loader.TranslatingLibraryLoader.load(TranslatingLibraryLoader.java:40)\n    at org.opencds.cqf.cql.evaluator.cli.Main.execute(Main.java:82)\n    at org.opencds.cqf.cql.evaluator.cli.Main.parseAndExecute(Main.java:52)\n    at org.opencds.cqf.cql.evaluator.cli.Main.main(Main.java:37)\nCaused by: java.lang.IllegalArgumentException: Could not load source for library warfarin, version null.\n    at org.cqframework.cql.cql2elm.PriorityLibrarySourceLoader.getLibrarySource(PriorityLibrarySourceLoader.java:53)\n    at org.cqframework.cql.cql2elm.LibraryManager.translateLibrary(LibraryManager.java:102)\n    ... 5 more\nThe specified path to resource files does not exist.\njava.lang.IllegalArgumentException: The specified path to resource files does not exist.\n    at org.opencds.cqf.cql.evaluator.execution.util.DirectoryBundler.bundle(DirectoryBundler.java:55)\n    at org.opencds.cqf.cql.evaluator.cli.Main.create(Main.java:130)\n    at org.opencds.cqf.cql.evaluator.cli.Main.execute(Main.java:89)\n    at org.opencds.cqf.cql.evaluator.cli.Main.parseAndExecute(Main.java:52)\n    at org.opencds.cqf.cql.evaluator.cli.Main.main(Main.java:37)\n</code></pre></div>",
        "id": 207641479,
        "sender_full_name": "Rich Boyce",
        "timestamp": 1598020639
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"196276\">@Rich Boyce</span> , is this somewhere I can reproduce it?</p>",
        "id": 207677743,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1598039903
    },
    {
        "content": "<p>Attached is the CQL file that is being attempted to convert to ELM. Currently we are using a forked version of the develop branch <a href=\"/user_uploads/10155/mN6DE4NoxNKxPwL4NdglrRXY/warfarin-nsaids-cds-select-logic.cql\">warfarin-nsaids-cds-select-logic.cql</a></p>",
        "id": 207848172,
        "sender_full_name": "Rich Boyce",
        "timestamp": 1598278598
    },
    {
        "content": "<p>We just merged a fix to develop that sounds like the same issue, can you confirm you're running the latest develop fixes?</p>",
        "id": 208019329,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1598387590
    },
    {
        "content": "<p>I just did a remote pull so I am up to date with the develop branch and the issue persists. I believe it is a problem specifically with the cql-to-elm mvn dependency. I tried converting the CQL using the 1.4.9 release of the clinical quality language (<a href=\"https://github.com/cqframework/clinical_quality_language/releases\">https://github.com/cqframework/clinical_quality_language/releases</a>) and ran into the same issues but the conversions worked using 1.5.0</p>",
        "id": 208233092,
        "sender_full_name": "Rich Boyce",
        "timestamp": 1598542112
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"196276\">@Rich Boyce</span> , I was out last week, so just getting back to this. I was able to evaluate it in Atom, but I had to rename the library file name to match the library name declaration. Once I did that, the Atom plugin successfully evaluated the content. Are you still seeing this issue, and is there maybe a content IG repository you could point me to for a repro?</p>",
        "id": 209108183,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1599233530
    },
    {
        "content": "<p>Hi Bryn, we came back to this after getting better acquainted with Atom and were able to move past that problem. We are now having an issue with a ValueSet that references other value sets. <a href=\"/user_uploads/10155/vuReqvPZTb77ELmpqYICzY_8/warfarin-nsaids-valueset-bundle.xml\">warfarin-nsaids-valueset-bundle.xml</a>. If I reference the ValueSet \"valueset-ketorolac\" then the CQL is processed correctly, however, if I try to reference \"valueset-NSAIDS\" which includes ketorolac then it fails to find any codes. Currently we are still working with DSTU3</p>",
        "id": 216246224,
        "sender_full_name": "Rich Boyce",
        "timestamp": 1605030009
    },
    {
        "content": "<p>The evaluator that's part of the Atom plugin doesn't have any terminology service capabilities, so it relies on the valueset to have an expansion element. It can compute an extensional compose, but that's it (i.e. when the compose is literally just a list of codes). So you would need to have a ValueSet resource with the expansion element populated. Does that help?</p>",
        "id": 216302763,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1605063314
    },
    {
        "content": "<p>Sorry,  I am having difficulties in the CQF Ruler, specifically the DSTU3 version</p>",
        "id": 216349885,
        "sender_full_name": "Rich Boyce",
        "timestamp": 1605103671
    },
    {
        "content": "<p>Does the valueset-ketorolac have an expansion element?</p>",
        "id": 216366336,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1605111499
    },
    {
        "content": "<p>It does not, what exactly would that entail?</p>",
        "id": 216367369,
        "sender_full_name": "Rich Boyce",
        "timestamp": 1605112009
    },
    {
        "content": "<p>Would the expansion element replace the compose element?</p>",
        "id": 216367607,
        "sender_full_name": "Rich Boyce",
        "timestamp": 1605112146
    },
    {
        "content": "<p>No, a ValueSet can contain both a compose and an expansion, but if it doesn't contain an expansion, then the implementation environment has to obtain the expansion somehow. If the compose is intensional, then the Ruler doesn't have the ability to expand it. Where did you define the value set?</p>",
        "id": 216371096,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1605113843
    },
    {
        "content": "<p>And does the compose contain the codes, or is just a grouping value set?</p>",
        "id": 216371145,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1605113867
    },
    {
        "content": "<p>Here is the file that contains all the value sets: <a href=\"/user_uploads/10155/V0NIjiugrwNi7mmUxZfi92kG/warfarin-nsaids-valueset-bundle.xml\">warfarin-nsaids-valueset-bundle.xml</a>  The \"valueset-ketorolac\" has all of the codes listed under compose, the \"valueset-nsaids\" includes the valueset-ketorolac under compose</p>",
        "id": 216373313,
        "sender_full_name": "Rich Boyce",
        "timestamp": 1605114857
    },
    {
        "content": "<p>So you manually authored these value set resources?</p>",
        "id": 216643651,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1605288227
    },
    {
        "content": "<p>Some time ago yes</p>",
        "id": 216644026,
        "sender_full_name": "Rich Boyce",
        "timestamp": 1605288366
    },
    {
        "content": "<p>So, there is code in CQF-Tooling to \"expand\" an extensional value set: <a href=\"https://github.com/cqframework/cqf-tooling/blob/develop/src/main/java/org/opencds/cqf/tooling/terminology/EnsureExecutableValueSetOperation.java\">https://github.com/cqframework/cqf-tooling/blob/develop/src/main/java/org/opencds/cqf/tooling/terminology/EnsureExecutableValueSetOperation.java</a></p>",
        "id": 216644774,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1605288698
    },
    {
        "content": "<p>In theory, given that the source value sets are all \"extensional\", it would be straightforward to extend that code to support expanding a \"grouper of extensional value sets\".</p>",
        "id": 216644895,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1605288730
    },
    {
        "content": "<p>You could also try loading all those value sets into the Ruler and asking for an $expand, to see if the HAPI machinery can already do that.</p>",
        "id": 216644980,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1605288761
    }
]