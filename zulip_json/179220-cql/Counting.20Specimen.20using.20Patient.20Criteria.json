[
    {
        "content": "<p>I need to count the number of Specimen were there subjects have a BMI &gt; 30 km/m2. The query I came up with is the following:</p>\n<div class=\"codehilite\"><pre><span></span>library Retrieve\nusing FHIR version &#39;4.0.0&#39;\ninclude FHIRHelpers version &#39;4.0.0&#39;\n\ncodesystem loinc: &#39;http://loinc.org&#39;\n\ncontext Specimen\n\ndefine Patient:\n  singleton from ([Patient])\n\ndefine InInitialPopulation:\n  exists(\n    from [Patient -&gt; Observation: Code &#39;39156-5&#39; from loinc] O\n    where (O.value as Quantity) &gt; 30 &#39;kg/m2&#39;)\n</pre></div>\n\n\n<p>I know that there is currently no official Specimen context but I have a ModelInfo in place which allows be to specify one. Both expressions, <code>Patient</code> and <code>InInitialPopulation</code> are in the Specimen context and I use $evaluate-measure with subject Specimen to count all Specimen which qualify through <code>InInitialPopulation</code>. The <code>Observation</code> retrieve expression however is in the context of the single <code>Patient</code> defined above. I took the idea from the Mother example in <a href=\"https://cql.hl7.org/03-developersguide.html#related-context-retrieves\" target=\"_blank\" title=\"https://cql.hl7.org/03-developersguide.html#related-context-retrieves\">Related Context Retrieves</a>. </p>\n<p>cql-to-elm translates the CQL without a problem. <span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span> I would just ask if that is supposed to work the way I think, before implementing it in my CQL evaluation engine?</p>",
        "id": 175822898,
        "sender_full_name": "Alexander Kiel",
        "timestamp": 1568647675
    },
    {
        "content": "<p>Apologies for the delay here. I don't think you need to use a Related Context Retrieve, since you are not reaching in to another \"specimen's\" data, you are only saying \"Give me all specimens where the patient has had a BMi observation &gt; 30 kg/m2\". So I think you can just do this:</p>",
        "id": 176672300,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1569514748
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>library Retrieve\nusing FHIR version &#39;4.0.0&#39;\ninclude FHIRHelpers version &#39;4.0.0&#39;\n\ncodesystem loinc: &#39;http://loinc.org&#39;\n\ncode bmi: &#39;39165-5&#39; from loinc\n\ncontext Specimen\n\ndefine InitialPopulation:\n  exists (\n        [Patient] P\n          with [Observation: code in bmi] O such that EndsWith(O.subject.reference, P.id)\n                and O.value &gt; 30 &#39;kg/m2&#39;\n    )\n</pre></div>",
        "id": 176672308,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1569514757
    },
    {
        "content": "<p>I can't translate that because I don't have a Specimen context defined, but if you do in your model info, that ought to work.</p>",
        "id": 176672331,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1569514784
    },
    {
        "content": "<p>Thanks for your answer. I‘ll try to translate later. I have one question: is the Observation retrieve expression supposed to run in the unspecified context? Because in the Specimen context, I have no link to Observations and if I had, that wouldn’t be the Observations of the Patient.</p>",
        "id": 176673409,
        "sender_full_name": "Alexander Kiel",
        "timestamp": 1569515567
    },
    {
        "content": "<p>In the specimen context, it would be observations for the specimen.</p>",
        "id": 176744781,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1569590427
    },
    {
        "content": "<p>Using the related context retrieve in the way that you have above is an interesting use case, and I can see other potential uses for that approach. So yes, the original use of related context retrieve should work as well, just using a different reference from the Observation to do the search.</p>",
        "id": 176745741,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1569591234
    },
    {
        "content": "<blockquote>\n<p>In the specimen context, it would be observations for the specimen.</p>\n</blockquote>\n<p>Ok that's the same I was expecting. I need the observations of the patient. So as you said already, it might be necessary to use related context here.</p>",
        "id": 176913504,
        "sender_full_name": "Alexander Kiel",
        "timestamp": 1569833434
    }
]