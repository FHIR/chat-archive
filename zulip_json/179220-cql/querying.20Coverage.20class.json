[
    {
        "content": "<p>Hello! Could you please help me?<br>\nIs there a way to filter a list of Coverage by class type?</p>\n<div class=\"codehilite\"><pre><span></span><code>define &quot;Plan&quot;:\n    [Coverage] C\n      where C.class.type ~ Code {code:&#39;plan&#39;, system:&#39;http://terminology.hl7.org/CodeSystem/coverage-class&#39;}\n</code></pre></div>",
        "id": 244928704,
        "sender_full_name": "Vasyl Herman",
        "timestamp": 1625487350
    },
    {
        "content": "<p>My goal is accessing Coverage.class[type ~ plan].value which is 'MOS':</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code>    <span class=\"p\">{</span>\n      <span class=\"nt\">\"resource\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n        <span class=\"nt\">\"resourceType\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Coverage\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"id\"</span><span class=\"p\">:</span> <span class=\"s2\">\"4bfdaffa-d11a-4e07-bbe1-521a9b44cc41\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"beneficiary\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n          <span class=\"nt\">\"reference\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Patient/95007\"</span>\n        <span class=\"p\">},</span>\n\n        <span class=\"nt\">\"payor\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n          <span class=\"p\">{</span>\n            <span class=\"nt\">\"reference\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Organization/vf-soft\"</span>\n          <span class=\"p\">}</span>\n        <span class=\"p\">],</span>\n        <span class=\"nt\">\"type\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n          <span class=\"nt\">\"coding\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n            <span class=\"p\">{</span>\n              <span class=\"nt\">\"system\"</span><span class=\"p\">:</span> <span class=\"s2\">\"http://terminology.hl7.org/ValueSet/v3-ActCoverageTypeCode\"</span><span class=\"p\">,</span>\n              <span class=\"nt\">\"code\"</span><span class=\"p\">:</span> <span class=\"s2\">\"RETIRE\"</span>\n            <span class=\"p\">}</span>\n          <span class=\"p\">]</span>\n        <span class=\"p\">},</span>\n        <span class=\"nt\">\"period\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n          <span class=\"nt\">\"start\"</span><span class=\"p\">:</span> <span class=\"s2\">\"1954-01-13T00:00:00.000+00:00\"</span><span class=\"p\">,</span>\n          <span class=\"nt\">\"end\"</span><span class=\"p\">:</span> <span class=\"s2\">\"2019-01-20T23:59:59.999+00:00\"</span>\n        <span class=\"p\">},</span>\n        <span class=\"nt\">\"class\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n          <span class=\"p\">{</span>\n            <span class=\"nt\">\"type\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n              <span class=\"nt\">\"coding\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n                <span class=\"p\">{</span>\n                  <span class=\"nt\">\"system\"</span><span class=\"p\">:</span> <span class=\"s2\">\"http://terminology.hl7.org/CodeSystem/coverage-class\"</span><span class=\"p\">,</span>\n                  <span class=\"nt\">\"code\"</span><span class=\"p\">:</span> <span class=\"s2\">\"plan\"</span>\n                <span class=\"p\">}</span>\n              <span class=\"p\">]</span>\n            <span class=\"p\">},</span>\n            <span class=\"nt\">\"value\"</span><span class=\"p\">:</span> <span class=\"s2\">\"MOS\"</span>\n          <span class=\"p\">}</span>\n        <span class=\"p\">]</span>\n      <span class=\"p\">}</span>\n    <span class=\"p\">}</span>\n</code></pre></div>\n<p>I am using the following cql code. </p>\n<p><a href=\"user_uploads/10155/1SzqriSId14hARgFZlEa8tk1/Screenshot-2021-07-05-at-18.03.39.png\">Screenshot-2021-07-05-at-18.03.39.png</a></p>\n<div class=\"message_inline_image\"><a href=\"user_uploads/10155/1SzqriSId14hARgFZlEa8tk1/Screenshot-2021-07-05-at-18.03.39.png\" title=\"Screenshot-2021-07-05-at-18.03.39.png\"><img src=\"user_uploads/10155/1SzqriSId14hARgFZlEa8tk1/Screenshot-2021-07-05-at-18.03.39.png\"></a></div><div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>define <span class=\"s2\">\"Plan\"</span>:\n    Last <span class=\"o\">([</span>Coverage<span class=\"o\">]</span> C\n      where C.class.type ~ Code <span class=\"o\">{</span>code:<span class=\"s1\">'plan'</span>, system:<span class=\"s1\">'http://terminology.hl7.org/CodeSystem/coverage-class'</span><span class=\"o\">}</span>\n      and FHIRBase.<span class=\"s2\">\"Normalize Interval\"</span><span class=\"o\">(</span> C.period <span class=\"o\">)</span> starts before end of <span class=\"s2\">\"Measurement Period\"</span>\n        <span class=\"k\">return</span> Tuple <span class=\"o\">{</span>id: C, plan: C.class<span class=\"o\">[</span><span class=\"m\">0</span><span class=\"o\">]</span>.value.value<span class=\"o\">}</span>\n        sort by end of id.period<span class=\"o\">)</span>.plan\n</code></pre></div>\n<p>It looks like an error but it's working <code>Could not resolve call to operator Equivalent with signature (list&lt;FHIR.CodeableConcept&gt;,System.Code).</code><br>\nCould you please correct a beginner if  is wrong?<br>\nThank you in advance.</p>",
        "id": 244946017,
        "sender_full_name": "Vasyl Herman",
        "timestamp": 1625497187
    },
    {
        "content": "<p>The <code>class</code> element of Coverage is itself a list so you need to do the comparion on the list elements. A sub-query something like this should do the trick:</p>\n<div class=\"codehilite\" data-code-language=\"cql\"><pre><span></span><code>  define \"Plan\":\n      Last ([Coverage] C\n        where exists (C.class Class where Class.type ~ Code {code:'plan', system:'http://terminology.hl7.org/CodeSystem/coverage-class'})\n        and FHIRBase.\"Normalize Interval\"( C.period ) starts before end of \"Measurement Period\"\n          return Tuple {id: C, plan: C.class[0].value.value}\n          sort by end of id.period).plan\n</code></pre></div>",
        "id": 245257934,
        "sender_full_name": "JP",
        "timestamp": 1625702662
    },
    {
        "content": "<p>You are Amazing!</p>\n<p>What about <code>return Tuple {id: C, plan: C.class[0].value.value}</code>, more specificaly <code>C.class.[0]</code> always returns first element, right? <br>\nWhat if we had a list of multiple items in C.class? I mean there is no guarantee that <code>plan</code> is going to be always the first one. I'd like to reach out its value which is <code>MOS</code>.<br>\nThanks!</p>",
        "id": 245287789,
        "sender_full_name": "Vasyl Herman",
        "timestamp": 1625734556
    },
    {
        "content": "<p>for instance:</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"nt\">\"class\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n          <span class=\"p\">{</span>\n            <span class=\"nt\">\"type\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n              <span class=\"nt\">\"coding\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n                <span class=\"p\">{</span>\n                  <span class=\"nt\">\"system\"</span><span class=\"p\">:</span> <span class=\"s2\">\"http://terminology.hl7.org/CodeSystem/coverage-class\"</span><span class=\"p\">,</span>\n                  <span class=\"nt\">\"code\"</span><span class=\"p\">:</span> <span class=\"s2\">\"something-else\"</span>\n                <span class=\"p\">}</span>\n              <span class=\"p\">]</span>\n            <span class=\"p\">},</span>\n            <span class=\"nt\">\"value\"</span><span class=\"p\">:</span> <span class=\"s2\">\"TEST\"</span>\n          <span class=\"p\">},</span>\n          <span class=\"p\">{</span>\n            <span class=\"nt\">\"type\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n              <span class=\"nt\">\"coding\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n                <span class=\"p\">{</span>\n                  <span class=\"nt\">\"system\"</span><span class=\"p\">:</span> <span class=\"s2\">\"http://terminology.hl7.org/CodeSystem/coverage-class\"</span><span class=\"p\">,</span>\n                  <span class=\"nt\">\"code\"</span><span class=\"p\">:</span> <span class=\"s2\">\"plan\"</span>\n                <span class=\"p\">}</span>\n              <span class=\"p\">]</span>\n            <span class=\"p\">},</span>\n            <span class=\"nt\">\"value\"</span><span class=\"p\">:</span> <span class=\"s2\">\"MOS\"</span>\n          <span class=\"p\">}</span>\n        <span class=\"p\">]</span>\n</code></pre></div>",
        "id": 245288050,
        "sender_full_name": "Vasyl Herman",
        "timestamp": 1625734758
    },
    {
        "content": "<p>How about this (I removed the normalize logic and replaced it with <code>true</code> to make the structure of the query more obvious):</p>\n<div class=\"codehilite\" data-code-language=\"cql\"><pre><span></span><code>      [Coverage] C\n        let plan : First(C.class Class where Class.type ~ Code {code:'plan', system:'http://terminology.hl7.org/CodeSystem/coverage-class'})\n        where true and plan is not null\n        return Tuple {id: C, plan: plan.value.value}\n        sort by end of id.period\n</code></pre></div>",
        "id": 245334379,
        "sender_full_name": "JP",
        "timestamp": 1625760081
    }
]