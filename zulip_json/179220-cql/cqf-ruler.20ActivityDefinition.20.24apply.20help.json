[
    {
        "content": "<p>Hi  <span class=\"user-mention\" data-user-id=\"194178\">@JP</span> , I am trying out the cqf-ruler-r4 by posting the ActivityDefinition defined at <a href=\"http://hl7.org/fhir/R4/activitydefinition-medicationorder-example.json.html\">http://hl7.org/fhir/R4/activitydefinition-medicationorder-example.json.html</a> and then executing $apply on this with a Test Patient<br>\nI am getting below error:<br>\n{<br>\n\"severity\": \"error\",<br>\n\"code\": \"processing\",<br>\n\"diagnostics\": \"Failed to call access method: org.opencds.cqf.cql.engine.fhir.exception.DataProviderException: Unable to resolve path dispenseRequest.numberOfRepeatsAllowed.\"<br>\n}<br>\nAm I missing something here, I could not find any sort of examples to understand the cql that can be executed by this tool on the link <a href=\"https://github.com/DBCG/cqf-ruler\">https://github.com/DBCG/cqf-ruler</a> and also at the link <a href=\"https://github.com/DBCG/cqf-ruler/wiki\">https://github.com/DBCG/cqf-ruler/wiki</a></p>",
        "id": 242007095,
        "sender_full_name": "ravi.kuchi",
        "timestamp": 1623201059
    },
    {
        "content": "<p>Hi Ravi!</p>\n<p>I'll take a look at the ruler and that example today and see if I can figure out what's going on with that example.</p>\n<p>The ruler supports direct CQL execution via the $cql operation. There aren't any examples of that posted in the wiki anywhere but here's a link to the operation definition in the code. I'll add a backlog item for adding documentation for that.</p>\n<p><a href=\"https://github.com/DBCG/cqf-ruler/blob/master/r4/src/main/java/org/opencds/cqf/r4/providers/CqlExecutionProvider.java#L233\">https://github.com/DBCG/cqf-ruler/blob/master/r4/src/main/java/org/opencds/cqf/r4/providers/CqlExecutionProvider.java#L233</a></p>",
        "id": 242080332,
        "sender_full_name": "JP",
        "timestamp": 1623251159
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"194178\">@JP</span> , for quick reply!<br>\nCan I get some quick samples of how to use $cql and $evaluate , below is a screenshot of what I was trying to get started on using these endpoints<br>\n<a href=\"/user_uploads/10155/5mqWgcjMJuMscTRdOZaRZfWg/Screen-Shot-2021-06-09-at-2.06.42-PM.png\">Screen-Shot-2021-06-09-at-2.06.42-PM.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/5mqWgcjMJuMscTRdOZaRZfWg/Screen-Shot-2021-06-09-at-2.06.42-PM.png\" title=\"Screen-Shot-2021-06-09-at-2.06.42-PM.png\"><img src=\"/user_uploads/10155/5mqWgcjMJuMscTRdOZaRZfWg/Screen-Shot-2021-06-09-at-2.06.42-PM.png\"></a></div>",
        "id": 242107335,
        "sender_full_name": "ravi.kuchi",
        "timestamp": 1623262322
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"194178\">@JP</span> , I am able to figure out the $evaluate part , it is really exciting !!! Thanks to this wonderful project<br>\n<a href=\"/user_uploads/10155/A1eroneEDLDFpR8wyoJH1xik/Screen-Shot-2021-06-09-at-2.52.53-PM.png\">Screen-Shot-2021-06-09-at-2.52.53-PM.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/A1eroneEDLDFpR8wyoJH1xik/Screen-Shot-2021-06-09-at-2.52.53-PM.png\" title=\"Screen-Shot-2021-06-09-at-2.52.53-PM.png\"><img src=\"/user_uploads/10155/A1eroneEDLDFpR8wyoJH1xik/Screen-Shot-2021-06-09-at-2.52.53-PM.png\"></a></div>",
        "id": 242112856,
        "sender_full_name": "ravi.kuchi",
        "timestamp": 1623264892
    },
    {
        "content": "<p>My end goal however is to write all my logic into Library and then use the evaluated library contents in the Activity and PlanDefinition Objects for creating Orders and CarePlans. Do you think my understanding is correct?</p>",
        "id": 242113196,
        "sender_full_name": "ravi.kuchi",
        "timestamp": 1623265052
    },
    {
        "content": "<p>Glad you got it figured out! Yes, you can include logic in a CQL library and then reference that logic in PlanDefinitions and so on. That can be in turn used to create CarePlans, cds-hooks services, etc.</p>",
        "id": 242114172,
        "sender_full_name": "JP",
        "timestamp": 1623265466
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"194178\">@JP</span> , one quick help, I am executing the $apply on the bundle provided in the page <br>\n<a href=\"https://github.com/DBCG/cql-evaluator/blob/master/evaluator.activitydefinition/src/test/resources/org/opencds/cqf/cql/evaluator/activitydefinition/r4/bundle-activityDefinitionTest.json\">https://github.com/DBCG/cql-evaluator/blob/master/evaluator.activitydefinition/src/test/resources/org/opencds/cqf/cql/evaluator/activitydefinition/r4/bundle-activityDefinitionTest.json</a><br>\nAs per my understanding the doNotPerform should be set as per the ActivityDefinition, but I do not see that in the response, it seems that the dynamicValue is not working, can you please let me know if I am overlooking something:<br>\n{<br>\n    \"resourceType\": \"MedicationRequest\",<br>\n    \"intent\": \"order\",<br>\n    \"medicationCodeableConcept\": {<br>\n        \"coding\": [<br>\n            {<br>\n                \"system\": \"<a href=\"http://test/fhir/System\">http://test/fhir/System</a>\",<br>\n                \"code\": \"productCode\"<br>\n            }<br>\n        ]<br>\n    },<br>\n    \"subject\": {<br>\n        \"reference\": \"patient-1\"<br>\n    }<br>\n}</p>",
        "id": 242142001,
        "sender_full_name": "ravi.kuchi",
        "timestamp": 1623279894
    },
    {
        "content": "<p>I think I made it work, changed the expression with escape characters and library prefix -&gt;<br>\n \"expression\": \"\\\"TestActivityDefinition\\\".ActiveProcedureStatus\"<br>\nI am going to try more complex examples, will let u know my progress</p>",
        "id": 242145937,
        "sender_full_name": "ravi.kuchi",
        "timestamp": 1623283424
    },
    {
        "content": "<p>hi <span class=\"user-mention\" data-user-id=\"194178\">@JP</span>, <span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span>  , As in another thread I stumbled upon the limitation that the dynamicValue seems to only work with Boolean dataType, I did try few things to make it work for code or quantity but am unsuccessful, if you could give me pointers as to the classes in which the changes would be it would be helpful.</p>",
        "id": 242214459,
        "sender_full_name": "ravi.kuchi",
        "timestamp": 1623334984
    },
    {
        "content": "<p>Hi ravi!</p>\n<p>I believe the work to update that is already done - <a href=\"https://github.com/DBCG/cqf-ruler/pull/277/files\">https://github.com/DBCG/cqf-ruler/pull/277/files</a></p>\n<p>Just waiting on a review.</p>",
        "id": 242234794,
        "sender_full_name": "JP",
        "timestamp": 1623342958
    },
    {
        "content": "<p>I went ahead and reviewed and merged it, actually.</p>",
        "id": 242235049,
        "sender_full_name": "JP",
        "timestamp": 1623343078
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"194178\">@JP</span>  for quick reply, I am trying a simple assignment as below  which does not seem to work, the resource is 'CommunicationRequest':<br>\n{<br>\n                    \"path\": \"priority\",<br>\n                    \"expression\": {<br>\n                        \"language\": \"text/cql\",</p>\n<div class=\"codehilite\"><pre><span></span><code>                  &quot;expression&quot;: &quot;routine&quot;\n                }\n            }\n</code></pre></div>",
        "id": 242644021,
        "sender_full_name": "ravi.kuchi",
        "timestamp": 1623697243
    },
    {
        "content": "<p>I am getting below message in logs: 2021-06-14 14:59:04.757 [qtp106424296-40] WARN  o.o.c.r.p.PlanDefinitionApplyProvider [ActivityDefinitionApplyProvider.java:171] WARNING: ActivityDefinition has null value for path: priority</p>",
        "id": 242644123,
        "sender_full_name": "ravi.kuchi",
        "timestamp": 1623697285
    },
    {
        "content": "<p>Hmm... Could you post your complete example? I need a bit more context to figure out what's going on?</p>",
        "id": 242658717,
        "sender_full_name": "JP",
        "timestamp": 1623704624
    },
    {
        "content": "<p>Sure <span class=\"user-mention\" data-user-id=\"194178\">@JP</span> , Here is my activity Definition:<br>\n{<br>\n            \"resourceType\": \"ActivityDefinition\",<br>\n            \"id\": \"FMCNAactivityDefinition-test\",<br>\n            \"name\": \"FMCNAactivityDefinition-test\",<br>\n            \"title\": \"CreateProcedure\",<br>\n            \"status\": \"draft\",<br>\n            \"description\": \"Create the procedure.\",<br>\n            \"library\": [ \"<a href=\"http://test/fhir/Library/FMCNAActivityDefinition|1.0.0\">http://test/fhir/Library/FMCNAActivityDefinition|1.0.0</a>\" ],<br>\n            \"kind\": \"CommunicationRequest\",<br>\n            \"productCodeableConcept\": {<br>\n                \"coding\": [{<br>\n                    \"system\": \"<a href=\"http://test/fhir/System\">http://test/fhir/System</a>\",<br>\n                    \"code\": \"fmcnaCode\"<br>\n                }]<br>\n            },<br>\n            \"dynamicValue\": [<br>\n                {<br>\n                    \"path\": \"subject\",<br>\n                    \"expression\": {<br>\n                        \"language\": \"text/cql\",</p>\n<div class=\"codehilite\"><pre><span></span><code>                  &quot;expression&quot;: &quot;\\&quot;FMCNAActivityDefinition\\&quot;.Patient&quot;\n                }\n            },\n          {\n                &quot;path&quot;: &quot;status&quot;,\n                &quot;expression&quot;: {\n                    &quot;language&quot;: &quot;text/cql&quot;,\n\n                  &quot;expression&quot;: &quot;draft&quot;\n                }\n            },\n          {\n                &quot;path&quot;: &quot;doNotPerform&quot;,\n                &quot;expression&quot;: {\n                    &quot;language&quot;: &quot;text/cql&quot;,\n\n                  &quot;expression&quot;: &quot;\\&quot;FMCNAActivityDefinition\\&quot;.isAdult&quot;\n                }\n            },\n          {\n                &quot;path&quot;: &quot;priority&quot;,\n                &quot;expression&quot;: {\n                    &quot;language&quot;: &quot;text/cql&quot;,\n\n                  &quot;expression&quot;: &quot;routine&quot;\n                }\n            }\n        ]\n    }\n</code></pre></div>",
        "id": 242664985,
        "sender_full_name": "ravi.kuchi",
        "timestamp": 1623708390
    },
    {
        "content": "<p>Here is the Library I have defined: <br>\nlibrary FMCNAActivityDefinition version '1.0.0'</p>\n<p>using FHIR version '4.0.1'</p>\n<p>include \"FHIRHelpers\" version '4.0.1' called FHIRHelpers</p>\n<p>codesystem \"LOINC\": '<a href=\"http://loinc.org\">http://loinc.org</a>'<br>\ncode \"serum creatinine\":<br>\n  '2160-0' from \"LOINC\" <br>\ncode \"creatinine clearance\":<br>\n  '12195-4' from \"LOINC\" </p>\n<p>context Patient</p>\n<p>define \"isAdult\":<br>\n  AgeInYears() &gt;= 18</p>\n<p>define \"isChild\":<br>\n  AgeInYears() &lt; 18</p>\n<p>//define \"Get Observation from Code Declaration\":<br>\n//  [Observation: \"serum creatinine\"]</p>\n<p>define \"LatestSerum\":<br>\n  First([Observation: code = \"serum creatinine\"] S <br>\n    where S.effective &gt; Now() - 7 days<br>\n    sort by (effective as dateTime) desc)</p>\n<p>define \"LatestSerum value\": \"LatestSerum\".value.value</p>\n<p>define \"reference range high\": \"LatestSerum\".referenceRange.high.value[0]</p>\n<div class=\"codehilite\"><pre><span></span><code>//RIFLE Classification\ndefine &quot;Adult RIFLE Class&quot;: \n  case \n    when &quot;isChild&quot; then &#39;Not Applicable&#39;\n    when &quot;LatestSerum value&quot; &gt; 3 * &quot;reference range high&quot; and &quot;isAdult&quot; then &#39;Failure&#39;\n    when &quot;LatestSerum value&quot; &gt; 2 * &quot;reference range high&quot; and &quot;isAdult&quot; then &#39;Injury&#39; \n    when &quot;LatestSerum value&quot; &gt; 1.5 * &quot;reference range high&quot; and &quot;isAdult&quot; then &#39;Risk&#39; \n    else &#39;Not at Risk&#39;\n  end\n\n//AKIN Classification \ndefine &quot;Adult AKIN Class&quot;: \n  case \n    when  &quot;isChild&quot; then &#39;Not Applicable&#39;\n    when &quot;LatestSerum value&quot; &gt; 3 * &quot;reference range high&quot; and &quot;isAdult&quot; then &#39;3&#39;\n    when &quot;LatestSerum value&quot; &gt; 2 * &quot;reference range high&quot; and &quot;isAdult&quot; then &#39;2&#39; \n    when &quot;LatestSerum value&quot; &gt; 1.5 * &quot;reference range high&quot; and &quot;isAdult&quot; then &#39;1&#39; \n    else &#39;Not at Risk&#39;\n  end\n</code></pre></div>\n\n<p>define \"LatesteCCR\":<br>\n  First([Observation: code = \"creatinine clearance\"] S <br>\n    where S.effective &gt; Now() - 7 days<br>\n    sort by (effective as dateTime) desc)</p>\n<p>define \"LatestClearance value\": \"LatesteCCR\".value.value</p>\n<p>define \"reference range low\": \"LatesteCCR\".referenceRange.low.value[0]</p>\n<p>//RIFLE Classification<br>\n    define \"Child RIFLE Class\": <br>\n      case <br>\n        when \"isAdult\" then 'Not Applicable'<br>\n        when \"LatestClearance value\" &lt; 0.25 * \"reference range low\" and \"isChild\" then 'Failure' <br>\n        when \"LatestClearance value\" &lt; 0.50 * \"reference range low\" and \"isChild\" then 'Injury' <br>\n        when \"LatestClearance value\" &lt; 0.75 * \"reference range low\" and \"isChild\" then 'Risk'<br>\n        else 'Not at Risk'<br>\n      end</p>",
        "id": 242665073,
        "sender_full_name": "ravi.kuchi",
        "timestamp": 1623708477
    },
    {
        "content": "<p>@JP, let me know if you need anything else, my goal is to create a CommunicationRequest resource upon the $apply and populate some data of CommunicationRequest from the Library and some data will be static like the 'Status' and 'Priority' which are pre-defined to 'draft' and 'routine'.</p>",
        "id": 242665224,
        "sender_full_name": "ravi.kuchi",
        "timestamp": 1623708577
    },
    {
        "content": "<p>The current output I am getting is :<br>\n{<br>\n    \"resourceType\": \"CommunicationRequest\",<br>\n    \"status\": \"unknown\",<br>\n    \"doNotPerform\": false,<br>\n    \"subject\": {<br>\n        \"reference\": \"PedPatient\"<br>\n    }<br>\n}<br>\nMy expectation is that the status should be set as 'draft' and the priority is missing</p>",
        "id": 242665537,
        "sender_full_name": "ravi.kuchi",
        "timestamp": 1623708764
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span>  One of My challenge is how do I define a static variable so I can assign the priority from enum in CQL<br>\ndefine \"MyPriority\":   CommunicationRequest.CommunicationPriority('routine')  -&gt; this is not working , referred CQL guide but unable to find some guidance<br>\nTried below as well:<br>\ndefine \"MyPriority\":  'Enumeration[routine]'</p>",
        "id": 242680122,
        "sender_full_name": "ravi.kuchi",
        "timestamp": 1623722785
    },
    {
        "content": "<p>CommunicationRequest.priority is a <code>FHIR.code</code>, which is an <code>Element</code>, and has <code>id</code>, <code>extension</code>, and <code>value</code> children. FHIRHelpers is providing implicit conversions so that when you compare to a string, you don't notice that it's a FHIR.code:</p>\n<div class=\"codehilite\"><pre><span></span><code>[CommunicationRequest] R where R.priority = &#39;routine&#39;\n</code></pre></div>\n<p>But if you're constructing a CommunicationRequest, you need to provide that FHIR.code value:</p>\n<div class=\"codehilite\"><pre><span></span><code>CommunicationRequest {\n  id: id { value: &#39;123&#39; },\n  priority: code { value: &#39;routine&#39; }\n}\n</code></pre></div>",
        "id": 242681787,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1623724896
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span> , part of my problem is I think with the way cqf-ruler works:<br>\nI have my Library defined as below:<br>\ncontext Patient<br>\ndefine \"Latest\":<br>\n  First([MedicationRequest: code = \"Colistin\"] S <br>\n    where S.authoredOn &lt; Now() - 7 days<br>\n  )<br>\ndefine \"LatestPriority\":  \"Latest\".priority<br>\ndefine \"MyIntent\":  code { value: 'routine' }</p>\n<p>The below works with ActivityDefinition<br>\n{<br>\n                    \"path\": \"priority\",<br>\n                    \"expression\": {</p>\n<div class=\"codehilite\"><pre><span></span><code>                    &quot;language&quot;: &quot;text/cql&quot;,\n                  &quot;expression&quot;: &quot;\\&quot;FMCNAMedDefinition\\&quot;.LatestPriority&quot;\n                }\n</code></pre></div>\n\n<p>}</p>",
        "id": 242725008,
        "sender_full_name": "ravi.kuchi",
        "timestamp": 1623760348
    },
    {
        "content": "<p>The below does not work in cqf-ruler:<br>\n{<br>\n                    \"path\": \"priority\",<br>\n                    \"expression\": {</p>\n<div class=\"codehilite\"><pre><span></span><code>                    &quot;language&quot;: &quot;text/cql&quot;,\n                  &quot;expression&quot;: &quot;\\&quot;FMCNAMedDefinition\\&quot;.MyIntent&quot;\n                }\n            }\n</code></pre></div>",
        "id": 242725062,
        "sender_full_name": "ravi.kuchi",
        "timestamp": 1623760388
    },
    {
        "content": "<p>Also, <span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span>  I am getting below error with your definition:<br>\ndefine \"comm\": CommunicationRequest {<br>\n  id: id { value: '123' },<br>\n  priority: code { value: 'routine' }<br>\n}         </p>\n<blockquote>\n<blockquote>\n<p>Error [31:15] Expected an expression of type 'FHIR.CommunicationPriority', but found an expression of type 'code'.</p>\n</blockquote>\n</blockquote>",
        "id": 242762526,
        "sender_full_name": "ravi.kuchi",
        "timestamp": 1623775276
    },
    {
        "content": "<p>Sorry, yes, needs to use the CommunicationPriority enumerated type:</p>\n<div class=\"codehilite\"><pre><span></span><code>define &quot;Test1&quot;:\n  CommunicationRequest {\n    id: id { value: &#39;123&#39; },\n    priority: CommunicationPriority { value: &#39;routine&#39; }\n  }\n</code></pre></div>",
        "id": 242942756,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1623877285
    },
    {
        "content": "<p>Regarding it not working in the ruler, what error are you getting?</p>",
        "id": 242942788,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1623877305
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span> The above is working well, Thanks! Can you also help me set some content in the Payload, I tried few things but not getting it right<br>\ndefine \"comm\": CommunicationRequest {<br>\n  id: id { value: '123' },<br>\n  priority: CommunicationPriority { value: 'routine' },<br>\n  payload : Payload [{content : content as string{value: 'some sample text'} ]<br>\n}</p>",
        "id": 243060516,
        "sender_full_name": "ravi.kuchi",
        "timestamp": 1623953705
    },
    {
        "content": "<p>For backbone elements, the model uses generated structure types, just like the Java and C# reference implementations do, so in this case it would be:</p>\n<div class=\"codehilite\"><pre><span></span><code>define &quot;comm&quot;: CommunicationRequest {\n  id: id { value: &#39;123&#39; },\n  priority: CommunicationPriority { value: &#39;routine&#39; },\n  payload : {\n    FHIR.CommunicationRequest.Payload {\n      content : string { value: &#39;some sample text&#39; }\n    }\n  }\n}\n</code></pre></div>",
        "id": 243064140,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1623955165
    },
    {
        "content": "<p>Note that payload is multi-cardinality, so it takes a List, which uses curly-braces in CQL.</p>",
        "id": 243064270,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1623955210
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span> , getting below error <br>\nCould not resolve type CommunicationRequest.Payload. Primary package for this resolver is org.hl7.fhir.r4.model<br>\nDo I need to include any packages? </p>\n<p>I have the below as of now :<br>\nusing FHIR version '4.0.1'<br>\ninclude \"FHIRHelpers\" version '4.0.1' called FHIRHelpers</p>",
        "id": 243072027,
        "sender_full_name": "ravi.kuchi",
        "timestamp": 1623958462
    },
    {
        "content": "<p>Hmmm, that seems like a bug in the engine's type resolver, the translator is fine with it. Would you mind submitting a github issue on the engine for that? (<a href=\"https://github.com/dbcg/cql_engine/issues\">https://github.com/dbcg/cql_engine/issues</a>)</p>",
        "id": 243086420,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1623964771
    },
    {
        "content": "<p>Sure, submitted an issue <a href=\"https://github.com/DBCG/cql_engine/issues/488\">https://github.com/DBCG/cql_engine/issues/488</a>, thanks for the help!</p>",
        "id": 243095653,
        "sender_full_name": "ravi.kuchi",
        "timestamp": 1623970343
    }
]