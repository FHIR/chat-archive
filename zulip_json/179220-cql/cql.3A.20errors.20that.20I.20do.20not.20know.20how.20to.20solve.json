[
    {
        "content": "<p>Hello, I am posting this here as I am not sure where does this kind of thread belong. I am working on converting some existing medical algorithms (which are currently in a custom format) to CQL libraries. Some of the medical algorithms have scoring systems where, in this example, the value of the respiratory rate and age of the patient yield score values and diagnostic depends on the total score. I am therefore trying to represent this with CQL functions. To do so, I have created a template code using the CDS authoring tool available at <a href=\"https://cds.ahrq.gov/\">https://cds.ahrq.gov/</a> in which I created the Respiratory rate as a basic value and then downloaded the generated CQL. I then added 2 functions that yield scores depending on the patient age and respiratory rate.  Then, I ran the CQL using the java-quickstart from <a href=\"https://github.com/cqframework/clinical_quality_language/blob/master/Src/java-quickstart/README.md\">https://github.com/cqframework/clinical_quality_language/blob/master/Src/java-quickstart/README.md</a> and I got a bunch of errors (output from java-quickstart):</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>line <span class=\"m\">4</span>:0 extraneous input <span class=\"s1\">'codesystem'</span> expecting <span class=\"o\">{</span><span class=\"s1\">'include'</span>, <span class=\"s1\">'parameter'</span>, <span class=\"s1\">'valueset'</span>, <span class=\"s1\">'let'</span>, <span class=\"s1\">'context'</span>, <span class=\"s1\">'define'</span><span class=\"o\">}</span>\nline <span class=\"m\">8</span>:7 no viable alternative at input <span class=\"s1\">'define \"Respiratory rate (observable entity)\"'</span>\nline <span class=\"m\">27</span>:35 missing <span class=\"s1\">':'</span> at <span class=\"s1\">'List'</span>\nline <span class=\"m\">27</span>:39 mismatched input <span class=\"s1\">'&lt;'</span> expecting <span class=\"o\">{</span><span class=\"s1\">','</span>, <span class=\"s1\">')'</span><span class=\"o\">}</span>\nline <span class=\"m\">36</span>:34 missing <span class=\"s1\">':'</span> at <span class=\"s1\">'Observation'</span>\nline <span class=\"m\">36</span>:46 mismatched input <span class=\"s1\">':'</span> expecting <span class=\"s1\">'{'</span>\nline <span class=\"m\">40</span>:29 missing <span class=\"s1\">':'</span> at <span class=\"s1\">'System'</span>\nline <span class=\"m\">40</span>:35 mismatched input <span class=\"s1\">'.'</span> expecting <span class=\"o\">{</span><span class=\"s1\">','</span>, <span class=\"s1\">')'</span><span class=\"o\">}</span>\nline <span class=\"m\">47</span>:27 mismatched input <span class=\"s1\">'returns'</span> expecting <span class=\"s1\">'{'</span>\nlibrary: score_system\nversion: <span class=\"m\">1</span>.0.0\n\nDefined Variables:\n\nDefined ValueSets:\n\nDefined Retrieves:\n</code></pre></div>\n<p>The weird thing here is that some of these errors are related to the code generated from the CDS authoring tool (which I thought would yield valid code). The second issue is that I do not know how to interpret the errors from the output, as I have followed the specifications from <a href=\"https://cql.hl7.org/03-developersguide.html#conditional-expressions\">https://cql.hl7.org/03-developersguide.html#conditional-expressions</a> and <a href=\"https://cql.hl7.org/03-developersguide.html#defining-functions\">https://cql.hl7.org/03-developersguide.html#defining-functions</a> .</p>\n<p>Therefore any help/advice is welcomed and I have attached the relevant .cql files in this post. Note that I do not intend to use this forum for other users to debug my code and instead would like to learn where to find relevant resources that could help me debug my code in the future. </p>\n<p>Thanks a lot !</p>\n<p><a href=\"/user_uploads/10155/5lweFOEKDsdlDWO1SGPSM4Pq/score_system.cql\">score_system.cql</a> <a href=\"/user_uploads/10155/PDRHVOJqk_O77FajIjuOKvE3/FHIRHelpers.json\">FHIRHelpers.json</a> <a href=\"/user_uploads/10155/W3tTJVbx1S60-i2dBqqA7T7Q/FHIRHelpers.cql\">FHIRHelpers.cql</a></p>",
        "id": 241793928,
        "sender_full_name": "Adrien Prost",
        "timestamp": 1623079588
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191469\">@Chris Moesel</span> </p>\n<p>I've never used the Java Quickstart.  Have you tried <a href=\"https://github.com/cqframework/clinical_quality_language/blob/master/Src/java/cql-to-elm/OVERVIEW.md\">cql-to-elm</a>?  That will translate your CQL to ELM JSON and I will use it to check for syntax errors.  There's also a plugin for the Atom editor which can also check syntax.  Once you have something that compiles I'd suggest defining some tests using something like the <a href=\"https://github.com/AHRQ-CDS/CQL-Testing-Framework\">cql-testing-framework</a>.</p>",
        "id": 241898098,
        "sender_full_name": "David Winters",
        "timestamp": 1623148626
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"195840\">@David Winters</span>  Thanks for the answer, indeed I have tried running the code using the web-based IDE at <a href=\"https://cql-runner.dataphoria.org/\">https://cql-runner.dataphoria.org/</a>  (I do not know what engine/cql-execution program is used there) and now it works, it seems like the Java version is out of date (for example it does not recognize the codesystem keyword). For CQL to ELM is there a software that I can run on linux to interpret ELM ?</p>",
        "id": 241918029,
        "sender_full_name": "Adrien Prost",
        "timestamp": 1623158653
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"418818\">@Adrien Prost</span> I think there are a couple of options.  There's the JavaScript <a href=\"https://github.com/cqframework/cql-execution\">CQL Execution</a> library and then the Java <a href=\"https://github.com/DBCG/cql-evaluator\">CQL Evaluator</a>.</p>",
        "id": 241919725,
        "sender_full_name": "David Winters",
        "timestamp": 1623159295
    },
    {
        "content": "<p>This might be a more opinionated question, but may I ask why a testing framework does not directly embed a CQL-to-ELM translator and this must be done manually be implementors? I think the whole concept of designing a standard for health data exchange is great, but making it user friendly would result in people actually implementing it :)</p>",
        "id": 241920415,
        "sender_full_name": "Adrien Prost",
        "timestamp": 1623159580
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"418818\">@Adrien Prost</span> - Are you familiar with the Atom cql-language plugin? I run it on Linux to execute ELM regularly:</p>\n<p><a href=\"https://atom.io/packages/language-cql\">https://atom.io/packages/language-cql</a></p>",
        "id": 241940984,
        "sender_full_name": "JP",
        "timestamp": 1623167258
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"194178\">@JP</span>  I used the vscode plugin but apparently it only does the syntax highlighting, I will definitely install atom to test my cql syntax then. Thanks !</p>",
        "id": 241942585,
        "sender_full_name": "Adrien Prost",
        "timestamp": 1623167924
    },
    {
        "content": "<p>And <span class=\"user-mention\" data-user-id=\"418818\">@Adrien Prost</span> - in order to run the tests you need to have the folder structure setup and populated with the FHIR resources (vocab-related and patient-related) as described in the language-cql page.    I also found that I had to run the test within a certain folder in order for all the artifacts to be found.   (Usually brought up Atom on the .../build folder, which was parallel to the input folder, which is where I directed the output from the cql-to-elm tool.  (the other thing I didn't realize was that the ../input/tests/&lt;cql-library-name&gt; had to be the name identified in the .cql file library statement, e.g.</p>\n<p>MyCqlTest.cql:</p>\n<p><code>library MyCqlTest version '0.1.0'\n...</code></p>\n<p><code>.../input/tests/MyCqlTest/&lt;patientId&gt;/...</code></p>",
        "id": 241957875,
        "sender_full_name": "John Silva",
        "timestamp": 1623173911
    },
    {
        "content": "<p>Great suggestion <span class=\"user-mention\" data-user-id=\"418818\">@Adrien Prost</span><br>\nI think the concept is that users would bring them both into their project as dependencies.  <span class=\"user-mention\" data-user-id=\"191469\">@Chris Moesel</span> and I have talked about setting up a \"starter kit\" that would be a skeleton project that would have these setup for people.  Wondering if that would be of interest to others out there.</p>",
        "id": 241964581,
        "sender_full_name": "David Winters",
        "timestamp": 1623176860
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"418818\">@Adrien Prost</span> turns out the testing framework does include the cql-to-elm translator: <a href=\"https://github.com/AHRQ-CDS/CQL-Testing-Framework/blob/master/package.json#L8\">https://github.com/AHRQ-CDS/CQL-Testing-Framework/blob/master/package.json#L8</a></p>",
        "id": 241981317,
        "sender_full_name": "David Winters",
        "timestamp": 1623184090
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"298707\">@John Silva</span>  Thanks for the tips,  it is indeed not very clear from the language-cql how these directories must be setup. Does the FHIR website provide a bundle of test resources that I could use to test CQL queries ?</p>",
        "id": 242033464,
        "sender_full_name": "Adrien Prost",
        "timestamp": 1623228286
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"195840\">@David Winters</span>  Yep I was thinking something similar like a script that generates a project folder, configurations files etc.. As I am new to this I am having trouble to understand how a FHIR/CQL production environment would look like in practice</p>",
        "id": 242033684,
        "sender_full_name": "Adrien Prost",
        "timestamp": 1623228422
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"418818\">@Adrien Prost</span>  on each FHIR resource page they typically provide some example resources in JSON and XML format.  The <code>cql-testing-framework</code> allows you to define FHIR resources in a YAML shorthand and then run them through your CQL.</p>",
        "id": 242051641,
        "sender_full_name": "David Winters",
        "timestamp": 1623238836
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"418818\">@Adrien Prost</span>  - the FHIR resources you need depend upon what your CQL logic is expecting so you probably need to generate them yourself.  One option would be to create FSH files for the resources that meet the requirements of your CQL logic, e.g. an Observation with a particular code that you expect, along with (of course) the Patient resource or others used in your CQL.</p>",
        "id": 242070026,
        "sender_full_name": "John Silva",
        "timestamp": 1623247365
    },
    {
        "content": "<p>The directory structure is based on the standard IG layout so currently the best way to figure it out is to take a look at an existing IG. Here's one for reference:</p>\n<p><a href=\"https://github.com/DBCG/connectathon/tree/master/fhir401\">https://github.com/DBCG/connectathon/tree/master/fhir401</a></p>",
        "id": 242080825,
        "sender_full_name": "JP",
        "timestamp": 1623251338
    },
    {
        "content": "<p>Late to the party here, but the testing structure is documented in the Atom Plugin readme:<br>\n<a href=\"https://github.com/cqframework/atom_cql_support/blob/master/README.md#using-the-cql-support-in-atom\">https://github.com/cqframework/atom_cql_support/blob/master/README.md#using-the-cql-support-in-atom</a></p>",
        "id": 242270306,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1623358853
    }
]