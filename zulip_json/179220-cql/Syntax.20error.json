[
    {
        "content": "<p>Given:<br>\n  medSupply = 10<br>\n  drugStrength.value = 5.0<br>\n  conversionFactor = 1.5</p>\n<p>Plug those value to the following expression:<br>\n  prescriptionMME: Quantity { value: medSupply * drugStrength.value * conversionFactor, unit: dailyDose.unit }</p>\n<p>Getting \"Expected an expression of type 'System.Decimal', but found an expression of type 'System.Quantity'\" error.</p>\n<p>Can you please let me know if there is anything wrong with the above expression?  Thank you.</p>",
        "id": 181574900,
        "sender_full_name": "Tien Thai",
        "timestamp": 1574364165
    },
    {
        "content": "<p>Without the full context of the types, it's hard to say.  But it seems to me like it's expecting <code>prescriptionMME</code> to be a <code>Decimal</code>, but you're assigning it a <code>Quantity</code>.  This may be the case since MME has an assumed unit.  But again, it's hard to say without all of the context.</p>",
        "id": 181576744,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1574365262
    },
    {
        "content": "<p>Code : <br>\n define function IntervalExtension(collapsed List&lt;Interval&lt;DateTime&gt;&gt;, source List&lt;Interval&lt;DateTime&gt;&gt;): <br>\n        if collapsed is null then null <br>\n      else<br>\nInterval[<br>\n        start of collapsed,<br>\n        start of collapsed + SumInDays(source sr where sr during collapsed)<br>\n       ]<br>\n   define function ExtendIntervals(intervals List&lt;Interval&lt;DateTime&gt;&gt;) returns List&lt;Interval&lt;DateTime&gt;&gt;:<br>\n      from (collapse intervals) CollapsedInterval,<br>\n         intervals  I<br>\n          return (if CollapsedInterval CI includes I and I includes CollapsedInterval then  I<br>\n          else ExtendIntervals(IntervalExtension(CollapsedInterval, intervals)))<br>\nError: Cannot resolve reference to expression or function ExtendIntervals() because it results in a circular reference.<br>\nWondering if there is a better way of writing this code to handle recursion.</p>",
        "id": 186818536,
        "sender_full_name": "Eghonghon Okpah",
        "timestamp": 1580239631
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"221800\">@Eghonghon Okpah</span> , I'm not sure I'm following what this is trying to do? In general, yes, CQL does not support recursive functions or queries. This is by design to ensure authors cannot build infinite recursion into their expressions, but it does put some recursive patterns out of reach; this might be one such case.</p>",
        "id": 186846012,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1580258419
    },
    {
        "content": "<p>We are considering adding recursive capabilities to the language, can you help me understand this use case so we can make sure it is handled by what we end up proposing?</p>",
        "id": 186846059,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1580258517
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span>  the goal is to compute MedicationDispenseEvents into a list of Intervals, each Interval corresponding to the date of the event and the amount dispensed, and then recursively collapsing and extending the list of Intervals until a stable result is achieved.</p>",
        "id": 187011803,
        "sender_full_name": "Eghonghon Okpah",
        "timestamp": 1580406737
    },
    {
        "content": "<p>I am trying to convert a QDM based eCQM to FHIR based eCQM and for some reasons, it kept giving me the \"Expected an expression of type 'FHIR.decimal' , but found an expression of type 'System.Decimal'\" error in the function below.  Can you please help me point out what could have caused the error?  Many thanks.<br>\nTT</p>\n<hr>\n<p>define function \"EnsureMicrogramQuantity\"(strength Quantity):<br>\n  if strength.value &lt; 0.1<br>\n    and ( PositionOf('mg', strength.unit)= 0 ) then Quantity { value: strength.value * 1000, unit: 'ug' + Substring(strength.unit, 2)}<br>\n      else strength</p>",
        "id": 189910292,
        "sender_full_name": "Tien Thai",
        "timestamp": 1583512578
    },
    {
        "content": "<p>There are actually two quantity types available when you've declared \"using FHIR version 'X.X.X'. One is the native CQL quantity (System.Quantity), and the other is the FHIR quantity (FHIR.Quanity). It's not clear from your code which you are intending to use, but here are two potential solutions:</p>\n<p>If you're intending to use FHIR.Quantity:</p>\n<div class=\"codehilite\"><pre><span></span>define function &quot;EnsureMicrogramQuantity&quot;(strength FHIR.Quantity):\n  if strength.value &lt; 0.1\n  and ( PositionOf(&#39;mg&#39;, strength.unit)= 0 ) then\n    Quantity {\n      value: FHIR.decimal { value : (strength.value * 1000) },\n      unit: FHIR.string { value: &#39;ug&#39; + Substring(strength.unit, 2)}\n    }\n  else strength\n</pre></div>\n\n\n<p>If you're intending to use System.Quantity:</p>\n<div class=\"codehilite\"><pre><span></span>define function &quot;EnsureMicrogramQuantity&quot;(strength System.Quantity):\n  if strength.value &lt; 0.1\n  and ( PositionOf(&#39;mg&#39;, strength.unit)= 0 ) then\n    System.Quantity {\n      value: strength.value * 1000,\n      unit: &#39;ug&#39; + Substring(strength.unit, 2)\n    }\n  else strength\n</pre></div>",
        "id": 189916464,
        "sender_full_name": "JP",
        "timestamp": 1583516618
    },
    {
        "content": "<p>Yes, the System.Quantity clears the error.  Thanks very much for your help, Jonathan!</p>",
        "id": 189921180,
        "sender_full_name": "Tien Thai",
        "timestamp": 1583519623
    },
    {
        "content": "<p>Hi Jonathan,</p>\n<p>I am defining a function that returns an interval (see below) but kept getting an \"Expected  an expression of type 'System.Decimal', but found an expression of type 'FHIR.Duration'\" error .  Can you please let me know what could have caused the error?  Your help is appreciated.<br>\nTT</p>\n<hr>\n<p>define function \"MedicationRelevantPeriod\"(OpioidMed \"MedicationRequest\"):<br>\n      Interval[start of OpioidMed.dispenseRequest.validityPeriod,<br>\n      case<br>\n        when OpioidMed.dispenseRequest.expectedSupplyDuration is not null<br>\n          then start of OpioidMed.dispenseRequest.validityPeriod + System.Quantity { value: OpioidMed.dispenseRequest.expectedSupplyDuration, unit: 'd' }<br>\n        else<br>\n          end of OpioidMed.dispenseRequest.validityPeriod<br>\n      end]</p>",
        "id": 189933445,
        "sender_full_name": "Tien Thai",
        "timestamp": 1583528284
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"249396\">@Tien Thai</span> , the issue is that the <a href=\"http://hl7.org/fhir/medicationrequest-definitions.html#MedicationRequest.dispenseRequest.expectedSupplyDuration\" target=\"_blank\" title=\"http://hl7.org/fhir/medicationrequest-definitions.html#MedicationRequest.dispenseRequest.expectedSupplyDuration\">MedicationRequest.dispenseRequest.expectedSupplyDuration</a> element is a <a href=\"http://hl7.org/fhir/datatypes.html#Duration\" target=\"_blank\" title=\"http://hl7.org/fhir/datatypes.html#Duration\">Duration</a>, which is a special type of Quantity, which means it has value and unit elements. So to create a Quantity out of it, you have to access the <code>value</code> element:</p>\n<div class=\"codehilite\"><pre><span></span>define function &quot;MedicationRelevantPeriod&quot;(OpioidMed &quot;MedicationRequest&quot;):\nInterval[start of OpioidMed.dispenseRequest.validityPeriod,\ncase\nwhen OpioidMed.dispenseRequest.expectedSupplyDuration is not null\nthen start of OpioidMed.dispenseRequest.validityPeriod + System.Quantity { value: OpioidMed.dispenseRequest.expectedSupplyDuration.value, unit: &#39;d&#39; }\nelse\nend of OpioidMed.dispenseRequest.validityPeriod\nend]\n</pre></div>",
        "id": 189999021,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1583641488
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span> what is the future of CQL &amp; FHIR with machine learning? I mean I know JSON is compatible with so many different frameworks and even Tensorflow. Is there any future prospect integration with TensorFlow?</p>",
        "id": 190197726,
        "sender_full_name": "Mohammad Afaq Khan",
        "timestamp": 1583859769
    },
    {
        "content": "<p>It's certainly a possibility, and there's a FHIR tracker about supporting machine learning models with the Library resource (<a href=\"http://jira.hl7.org/browse/FHIR-25046\" target=\"_blank\" title=\"http://jira.hl7.org/browse/FHIR-25046\">J#25046</a>). We've also looked at supporting predictive models as <code>external</code> calls in CQL, and enabling machine learning is a key motivator for computable guidelines work with FHIR and CQL. Would welcome any feedback on that topic, and be very interested to hear if you've done any exploration along those lines.</p>",
        "id": 190237515,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1583883406
    },
    {
        "content": "<p>Unfortunately, I am exploring this area as well. I think it will definitely become very important in the future. Hopefully, I can catchup on this topic to be able to provide relevant feedback in time <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span> .</p>",
        "id": 190291614,
        "sender_full_name": "Mohammad Afaq Khan",
        "timestamp": 1583939232
    }
]