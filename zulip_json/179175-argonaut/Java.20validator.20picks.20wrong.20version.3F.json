[
    {
        "content": "<p>I run latest java validator against a Provenance resource</p>\n<div class=\"codehilite\"><pre><span></span><code>java -jar validator_cli_5.4.9.jar -version 4.0.1 -ig hl7.fhir.us.core -profile http://hl7.org/fhir/us/core/StructureDefinition/us-core-provenance provenance-1.xml\n</code></pre></div>\n<p>I got a strange error</p>\n<div class=\"codehilite\"><pre><span></span><code>  Validate provenance-1.xmlValidation Infrastructure fail validating provenance-1.xml: Problem processing expression ($this.agent.who.resolve().is Practitioner or Device) implies exists() in profile http://hl7.org/fhir/us/core/StructureDefinition/us-core-provenance path Provenance.agent[0].onBehalfOf: Error @1, 2: Found Practitioner expecting a &quot;)&quot;\nException in thread &quot;main&quot; org.hl7.fhir.exceptions.FHIRException: org.hl7.fhir.exceptions.FHIRException: Problem processing expression ($this.agent.who.resolve().is Practitioner or Device) implies exists() in profile http://hl7.org/fhir/us/core/StructureDefinition/us-core-provenance path Provenance.agent[0].onBehalfOf: Error @1, 2: Found Practitioner expecting a &quot;)&quot;\n    at org.hl7.fhir.validation.ValidationEngine.validate(ValidationEngine.java:339)\n    at org.hl7.fhir.validation.cli.services.ValidationService.validateSources(ValidationService.java:91)\n    at org.hl7.fhir.validation.ValidatorCli.doValidation(ValidatorCli.java:238)\n    at org.hl7.fhir.validation.ValidatorCli.main(ValidatorCli.java:159)\n</code></pre></div>\n<p>When I look the header of the log, I notice a strange version (US Core v3.1.0) is used for validation</p>\n<div class=\"codehilite\"><pre><span></span><code>  Load FHIR v4.0 from hl7.fhir.r4.core#4.0.1 - 4575 resources (00:03.0904)\n  Load hl7.terminology#2.1.0 - 3767 resources (00:01.0078)\n  Terminology server http://tx.fhir.org - Version 1.9.378 (00:01.0239)\n  Load hl7.fhir.us.core#3.1.0 - 143 resources (00:00.0042)\n</code></pre></div>\n<p>The validator document says when NOT specifing a version, the _current published version_ of the IG is used.<br>\nThe current published version of US Core is 4.0.0 not 3.1.0</p>\n<p>So the question is why validator pulls US Core v3.1.0 as \"current published version\"?<br>\n<span class=\"user-mention\" data-user-id=\"191401\">@Eric Haas</span> <span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span></p>",
        "id": 247049127,
        "sender_full_name": "Yunwei Wang",
        "timestamp": 1627090097
    },
    {
        "content": "<p>That seems like a package server issue - <span class=\"user-mention\" data-user-id=\"248736\">@Mark Iantorno</span> ?</p>",
        "id": 247049406,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1627090577
    },
    {
        "content": "<p>hrm that's no good</p>",
        "id": 247186142,
        "sender_full_name": "Mark Iantorno",
        "timestamp": 1627295936
    },
    {
        "content": "<p>I\"ll look into it this morning</p>",
        "id": 247186149,
        "sender_full_name": "Mark Iantorno",
        "timestamp": 1627295941
    },
    {
        "content": "<p>So the fhir version is fine, it's the us core version profile version that's the incorrect one, right?</p>",
        "id": 247186243,
        "sender_full_name": "Mark Iantorno",
        "timestamp": 1627296005
    },
    {
        "content": "<p>Yes. US Core is default set to v3.1.0. The correct default version (current published) is v4.0.0</p>",
        "id": 247201379,
        "sender_full_name": "Yunwei Wang",
        "timestamp": 1627305933
    },
    {
        "content": "<p>So, strangely enough, when I run that command:</p>",
        "id": 247205248,
        "sender_full_name": "Mark Iantorno",
        "timestamp": 1627307714
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>  Load hl7.terminology#2.1.0 - 3767 resources (00:02.0823)\n  Terminology server http://tx.fhir.org - Version 1.9.378 (00:01.0434)\n  Load hl7.fhir.us.core#1.0.1 - 52 resources (00:00.0015)\n  Get set...  go (00:00.0518)\n</code></pre></div>",
        "id": 247205255,
        "sender_full_name": "Mark Iantorno",
        "timestamp": 1627307718
    },
    {
        "content": "<p>I get v1.0.1</p>",
        "id": 247205264,
        "sender_full_name": "Mark Iantorno",
        "timestamp": 1627307724
    },
    {
        "content": "<p>which is also not correct</p>",
        "id": 247205276,
        "sender_full_name": "Mark Iantorno",
        "timestamp": 1627307731
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"203235\">@Ward Weistra</span> any reason why the latest package would be incorrect?</p>",
        "id": 247205912,
        "sender_full_name": "Mark Iantorno",
        "timestamp": 1627308054
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"248736\">@Mark Iantorno</span> I don't think it's anything in the FHIR registry mechanics that does this. FHIR Package API (<a href=\"https://app.swaggerhub.com/apis-docs/firely/Simplifier.net_FHIR_Package_API/1.0.1#/default/get__package_name_\">https://app.swaggerhub.com/apis-docs/firely/Simplifier.net_FHIR_Package_API/1.0.1#/default/get__package_name_</a>) nicely lists 4.0.0 as the latest.</p>\n<p>Searching on Registry UI also gives you latest package for this: <a href=\"https://registry.fhir.org/results?query=%22http%3A%2F%2Fhl7.org%2Ffhir%2Fus%2Fcore%2FStructureDefinition%2Fus-core-provenance%22&amp;latestFilter=true\">https://registry.fhir.org/results?query=%22http%3A%2F%2Fhl7.org%2Ffhir%2Fus%2Fcore%2FStructureDefinition%2Fus-core-provenance%22&amp;latestFilter=true</a>. Though IF the Java validator is getting this from the package ecosystem, which I'm not sure about, it would of course be using the API. There's a specific catalog search endpoint to search on canonical or other terms, which would be perfect for this.</p>\n<p>I remember overhearing there's some specific US realm logic in the IG Publisher (perhaps Java validator too?), perhaps it is somewhere in there?</p>",
        "id": 247217369,
        "sender_full_name": "Ward Weistra",
        "timestamp": 1627312858
    },
    {
        "content": "<p>Or, given that it's different for both of you, it could be package cache related? Could just empty your package cache to be sure.</p>",
        "id": 247217474,
        "sender_full_name": "Ward Weistra",
        "timestamp": 1627312909
    },
    {
        "content": "<p>Interesting. It works after empty package cache. Thanks <span class=\"user-mention\" data-user-id=\"203235\">@Ward Weistra</span></p>",
        "id": 247218378,
        "sender_full_name": "Yunwei Wang",
        "timestamp": 1627313267
    },
    {
        "content": "<p>I run some tests with different version of US Core. Here is the steps:</p>\n<p>clean package cache<br>\nrun validator_cli.jar with <code>-ig hl7.fhir.us.core</code><br>\nvalidator loaded <code>hl7.fhir.us.core#4.0.0</code> -- ok<br>\nrun validator_cli.jar with <code>-ig hl7.fhir.us.core#3.1.1</code><br>\nvalidator loaded <code>hl7.fhir.us.core#3.1.1</code> -- ok<br>\nrun validator_cli.jar with <code>-ig hl7.fhir.us.core</code><br>\nvalidator loaded <code>hl7.fhir.us.core#3.1.1</code> -- NOT ok<br>\nrun validator_cli.jar with <code>-ig hl7.fhir.us.core#3.1.0</code><br>\nvalidator loaded <code>hl7.fhir.us.core#3.1.0</code> -- ok<br>\nrun validator_cli.jar with <code>-ig hl7.fhir.us.core</code><br>\nvalidator loaded <code>hl7.fhir.us.core#3.1.0</code> -- NOT ok<br>\nrun validator_cli.jar with <code>-ig hl7.fhir.us.core#3.2.0</code><br>\nvalidator loaded <code>hl7.fhir.us.core#3.2.0</code> -- ok<br>\nrun validator_cli.jar with <code>-ig hl7.fhir.us.core</code><br>\nvalidator loaded <code>hl7.fhir.us.core#3.1.0</code> -- NOT ok<br>\nremove hl7.fhir.us.core#3.1.0 from package cache<br>\nrun validator_cli.jar with <code>-ig hl7.fhir.us.core</code><br>\nvalidator loaded <code>hl7.fhir.us.core#3.1.1</code> -- NOT ok</p>\n<p>For the results, I found that when there are multiple versions in package cache, the validator always pick the lowest version not the highest. Is this a validator bug?</p>",
        "id": 247222646,
        "sender_full_name": "Yunwei Wang",
        "timestamp": 1627315137
    },
    {
        "content": "<p>package cache strikes again!</p>",
        "id": 247238476,
        "sender_full_name": "Mark Iantorno",
        "timestamp": 1627322372
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"203235\">@Ward Weistra</span></p>",
        "id": 247238485,
        "sender_full_name": "Mark Iantorno",
        "timestamp": 1627322377
    },
    {
        "content": "<p>I am unsure of the code implications of this <span class=\"user-mention\" data-user-id=\"191506\">@Yunwei Wang</span> , but can you get by just clearing your cache for now</p>",
        "id": 247238647,
        "sender_full_name": "Mark Iantorno",
        "timestamp": 1627322426
    },
    {
        "content": "<p>I did it again. It is the same result. </p>\n<p>clear package cache<br>\nrun validator_cli.jar with -ig hl7.fhir.us.core<br>\nvalidator loaded hl7.fhir.us.core#4.0.0 -- ok<br>\nrun validator_cli.jar with -ig hl7.fhir.us.core#3.1.1<br>\nvalidator loaded hl7.fhir.us.core#3.1.1 -- ok<br>\nrun validator_cli.jar with -ig hl7.fhir.us.core<br>\nvalidator loaded hl7.fhir.us.core#3.1.1 -- NOT ok</p>\n<p>I don't know why the last validation uses the v3.1.1 instead of v4.0.0<br>\n<span class=\"user-mention\" data-user-id=\"248736\">@Mark Iantorno</span></p>",
        "id": 247240497,
        "sender_full_name": "Yunwei Wang",
        "timestamp": 1627323151
    },
    {
        "content": "<p>Okay, but can you get it to work the way you want</p>",
        "id": 247241297,
        "sender_full_name": "Mark Iantorno",
        "timestamp": 1627323509
    },
    {
        "content": "<p>Like, if you clear the cache and then run it with the version you need, does it work?</p>",
        "id": 247241333,
        "sender_full_name": "Mark Iantorno",
        "timestamp": 1627323529
    },
    {
        "content": "<p>or, are you saying that your use case involves multiple runs with different versions</p>",
        "id": 247241381,
        "sender_full_name": "Mark Iantorno",
        "timestamp": 1627323554
    },
    {
        "content": "<p>Yes. I can get it work. I will create a JIRA ticket for the multiple versions issue. Thanks</p>",
        "id": 247245116,
        "sender_full_name": "Yunwei Wang",
        "timestamp": 1627325314
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"248736\">@Mark Iantorno</span> <a href=\"https://martinfowler.com/bliki/TwoHardThings.html\">https://martinfowler.com/bliki/TwoHardThings.html</a></p>\n<blockquote>\n<p>There are only two hard things in Computer Science: cache invalidation and naming things.</p>\n</blockquote>",
        "id": 247319891,
        "sender_full_name": "Ward Weistra",
        "timestamp": 1627384588
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"203235\">Ward Weistra</span> <a href=\"#narrow/stream/179175-argonaut/topic/Java.20validator.20picks.20wrong.20version.3F/near/247319891\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"248736\">Mark Iantorno</span> <a href=\"https://martinfowler.com/bliki/TwoHardThings.html\">https://martinfowler.com/bliki/TwoHardThings.html</a></p>\n<blockquote>\n<p>There are only two hard things in Computer Science: cache invalidation, naming things, and off-by-one errors.</p>\n</blockquote>\n</blockquote>\n<p>Fixed it for you!  <span aria-label=\"wink\" class=\"emoji emoji-1f609\" role=\"img\" title=\"wink\">:wink:</span></p>",
        "id": 247356776,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1627403214
    }
]