[
    {
        "content": "<p>I'm trying to track down the source of errors in the Build reported for my MeasureReport examples.  I'm about to push a build that will show these errors.  I cannot seem to track down where/why they are generated.  It's not that I don't understand the logic, what I'm trying to figure out is WHERE these constraints are coming from, because I cannot find them in the Resource definitions.  I'm guessing there's some custom validation code for resources which reference definitions. <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> <span class=\"user-mention\" data-user-id=\"191401\">@Eric Haas</span> <span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span></p>",
        "id": 194604105,
        "sender_full_name": "Keith Boone",
        "timestamp": 1587311553
    },
    {
        "content": "<p>yes there is additional validation that enforces rules stated or implied by the definitions that are not explicitly stated. These are work in progress - do you think they're wrong?</p>",
        "id": 194620781,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1587335094
    },
    {
        "content": "<p>There are actually two problems:</p>\n<ol>\n<li>The Validator converts the resource to R5, and I'm getting an error from the R4 to R5 converter due to our use of of data-absent-reason.  We report a count or a score that is in the measure, but indicate that the reason why @value is missing.  The converter doesn't like this.  As a result, several missing count/score values are being reported as in error by the validator, even though the element is present.</li>\n<li>We have several population measures (measure-population) in a group, further clarified with addition code values.  They are each in fact a different, non-stratified measure-population from the same initial-population in a measure.  I could make them measure-observation I guess, but they are just different counts of a population.  Stratifier isn't appropriate because CDC doesn't want all possible ways the data could be stratified across the two facets, just two of the strata are reported: IP = Hospitalized Patients, MP1 = Hospitalized Patients in ICU, and MP2 = ICU patients on a ventilator, and CDC isn't interested in the ratios (they can compute that from the MPs if they choose).</li>\n</ol>",
        "id": 194625746,
        "sender_full_name": "Keith Boone",
        "timestamp": 1587344191
    },
    {
        "content": "<p>Here's the exception for the conversion error on count.<br>\njava.lang.NullPointerException<br>\n    at org.hl7.fhir.convertors.VersionConvertor_40_50.convertInteger(VersionConvertor_40_50.java:249)<br>\n    at org.hl7.fhir.convertors.VersionConvertor_40_50.convertType(VersionConvertor_40_50.java:3668)<br>\n    at org.hl7.fhir.igtools.publisher.Publisher$TypeParserR4.parseType(Publisher.java:442)<br>\n    at org.hl7.fhir.r5.utils.NarrativeGenerator.parseType(NarrativeGenerator.java:1146)<br>\n    at org.hl7.fhir.r5.utils.NarrativeGenerator$BaseWrapperMetaElement.getBase(NarrativeGenerator.java:679)<br>\n    at org.hl7.fhir.r5.utils.NarrativeGenerator.renderLeaf(NarrativeGenerator.java:1531)<br>\n    at org.hl7.fhir.r5.utils.NarrativeGenerator.generateByProfile(NarrativeGenerator.java:1330)<br>\n    at org.hl7.fhir.r5.utils.NarrativeGenerator.generateByProfile(NarrativeGenerator.java:1352)<br>\n    at org.hl7.fhir.r5.utils.NarrativeGenerator.generateByProfile(NarrativeGenerator.java:1352)<br>\n    at org.hl7.fhir.r5.utils.NarrativeGenerator.generate(NarrativeGenerator.java:1248)<br>\n    at org.hl7.fhir.r5.utils.NarrativeGenerator.generate(NarrativeGenerator.java:1231)<br>\n    at org.hl7.fhir.igtools.publisher.Publisher.generateNarratives(Publisher.java:938)<br>\n    at org.hl7.fhir.igtools.publisher.Publisher.loadConformance(Publisher.java:3480)<br>\n    at org.hl7.fhir.igtools.publisher.Publisher.createIg(Publisher.java:813)<br>\n    at org.hl7.fhir.igtools.publisher.Publisher.execute(Publisher.java:674)<br>\n    at org.hl7.fhir.igtools.publisher.Publisher.main(Publisher.java:7103)</p>",
        "id": 194625865,
        "sender_full_name": "Keith Boone",
        "timestamp": 1587344410
    },
    {
        "content": "<p>this is reproducible in what is committed?</p>",
        "id": 194627839,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1587348456
    },
    {
        "content": "<p>Yes.</p>",
        "id": 194632485,
        "sender_full_name": "Keith Boone",
        "timestamp": 1587357410
    },
    {
        "content": "<p>I can probably create an even simpler example.</p>",
        "id": 194632496,
        "sender_full_name": "Keith Boone",
        "timestamp": 1587357428
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>public static org.hl7.fhir.r5.model.IntegerType convertInteger(org.hl7.fhir.r4.model.IntegerType src) throws FHIRException {\n    org.hl7.fhir.r5.model.IntegerType tgt = new org.hl7.fhir.r5.model.IntegerType(src.getValue());\n    copyElement(src, tgt);\n    return tgt;\n}\n</pre></div>\n\n\n<p>Does not check for null value in src.<br>\nproblem could be related to Java unboxing? getValue() returns java.lang.Integer, but called constructor would be IntegerType(int value), and so null pointer error</p>",
        "id": 194633166,
        "sender_full_name": "Keith Boone",
        "timestamp": 1587358569
    },
    {
        "content": "<p>/** Demonstrate conversion failure */<br>\npackage com.ainq.kboone.tools;<br>\nimport org.hl7.fhir.convertors.VersionConvertor_40_50;<br>\nimport org.hl7.fhir.r4.model.StringType;<br>\nimport org.hl7.fhir.r5.model.IntegerType;</p>\n<p>public class TestIntegerTypeConversion {</p>\n<div class=\"codehilite\"><pre><span></span>public static void main(String[] args) {\n    testConversion();\n}\npublic static void testConversion() {\n    IntegerType t2 = null;\n    org.hl7.fhir.r4.model.IntegerType t = new org.hl7.fhir.r4.model.IntegerType();\n    t.addExtension().setUrl(&quot;http://example.com/Any-Value&quot;).setValue(new StringType(&quot;A String Extension&quot;));\n    t2 = VersionConvertor_40_50.convertInteger(t);\n}\n</pre></div>\n\n\n<p>}</p>",
        "id": 194634372,
        "sender_full_name": "Keith Boone",
        "timestamp": 1587360435
    },
    {
        "content": "<p>Initialization of tgt should probably be something like:<br>\norg.hl7.fhir.r5.model.IntegerType tgt = src.hasValue() ? new org.hl7.fhir.r5.model.IntegerType(src.getValue()) : new org.hl7.fhir.r5.model.IntegerType();</p>",
        "id": 194634465,
        "sender_full_name": "Keith Boone",
        "timestamp": 1587360584
    },
    {
        "content": "<p>I have this fixed on a local branch, it was fairly straightforward:</p>\n<p>Perform a file search/replace operation:<br>\nSearch for:<br>\norg\\.hl7\\.fhir\\.(dstu2|dstu3|r4|r5)\\.model\\.([A-Za-z0-9]+)Type tgt = new org\\.hl7\\.fhir\\.(dstu2|dstu3|r4|r5)\\.model\\.([A-Za-z0-9]+)Type\\(src\\.getValue\\(\\)\\);</p>\n<p>Replace With:<br>\norg.hl7.fhir.$1.model.$2Type tgt = src.hasValue ?<br>\nnew org.hl7.fhir.$3.model.$4Type(src.getValue()) :<br>\nnew org.hl7.fhir.$3.model.$4Type();</p>\n<p>Add the following test to VersionConverter_10_30Test:</p>\n<p>@Test<br>\n  public void testConvertEmptyValuedUnsignedInt() {<br>\n    org.hl7.fhir.dstu2.model.UnsignedIntType input = new org.hl7.fhir.dstu2.model.UnsignedIntType();<br>\n    input.addExtension().setUrl(\"http://example.com/AnyValue\").setValue(new org.hl7.fhir.dstu2.model.StringType(\"A value\"));<br>\n    org.hl7.fhir.dstu3.model.UnsignedIntType output;<br>\n    output = (org.hl7.fhir.dstu3.model.UnsignedIntType)VersionConvertor_10_30.convertType(input);<br>\n    assertNull(output.getValue());</p>\n<p>}</p>",
        "id": 194652958,
        "sender_full_name": "Keith Boone",
        "timestamp": 1587375909
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"248736\">@Mark Iantorno</span> I'm way behind right now - can you look at this?</p>",
        "id": 194663917,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1587383505
    },
    {
        "content": "<p>Fix is here: <a href=\"https://github.com/hapifhir/org.hl7.fhir.core/pull/177\" title=\"https://github.com/hapifhir/org.hl7.fhir.core/pull/177\">https://github.com/hapifhir/org.hl7.fhir.core/pull/177</a></p>",
        "id": 194720909,
        "sender_full_name": "Mark Iantorno",
        "timestamp": 1587410437
    }
]