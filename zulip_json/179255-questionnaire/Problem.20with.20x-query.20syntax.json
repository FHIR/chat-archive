[
    {
        "content": "<p>As part of cleaning up the SDC spec, I moved the source for all of the examples from JSON to XML (so they could be validated during authoring).  In doing so, I discovered something unpleasant:<br>\n<code>          &lt;url value=\"Condition?patient={{%patient.id}}&amp;amp;active=true\"/&gt;</code><br>\nfails schema validation because the schema requires the value to match xs:anyURI, and % is not allowed in a URI.  Escaping it as &#x25; doesn't make any difference - it's still considered invalid</p>\n<p>Do we change the syntax to $patient.id or something like that instead?  <span class=\"user-mention\" data-user-id=\"195344\">@Paul Lynch</span> <span class=\"user-mention\" data-user-id=\"191367\">@Brian Postlethwaite</span> <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> <br>\nAlso, Grahame, this suggests that we need to tighten our validator somehow so it yells about the same things that schema validation does.</p>",
        "id": 265489900,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1639934143
    },
    {
        "content": "<p>That's fhirpath inside the braces, so that would break more things.</p>",
        "id": 265497966,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1639944965
    },
    {
        "content": "<p>Potentially, yes.  So - how do we escape the FHIRPath?  Do we just use HTML escaping?</p>",
        "id": 265502796,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1639951715
    },
    {
        "content": "<p>% is allowed in any Uri, that's the Unicode prefix char. Was news to me that they are uris and I needed to handle that decoding. (I'll need to go check my code now)</p>",
        "id": 265511256,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1639962565
    },
    {
        "content": "<p>Hang on, the url for the expression isn't in the url, it's in the expression string value. Which doesn't have that problem.</p>",
        "id": 265511995,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1639963497
    },
    {
        "content": "<p>The reference would be if the expression was defined elsewhere if I'm not mistaken.</p>",
        "id": 265512076,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1639963566
    },
    {
        "content": "<p>I don't understand this either - there's no way that % is not valid in a URI</p>",
        "id": 265512101,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1639963644
    },
    {
        "content": "<p>Won't matter, the value Lloyd is referring to should be in the expression not url field.</p>",
        "id": 265512149,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1639963683
    },
    {
        "content": "<p>The full context is this:</p>\n<div class=\"codehilite\"><pre><span></span><code>      &lt;entry&gt;\n        &lt;fullUrl value=&quot;urn:uuid:88f151c0-a954-468a-88bd-5ae15c08e060&quot;/&gt;\n        &lt;request&gt;\n          &lt;method value=&quot;GET&quot;/&gt;\n          &lt;url value=&quot;MedicationStatement?patient={{%patient.id}}&amp;amp;active=true&quot;/&gt;\n        &lt;/request&gt;\n      &lt;/entry&gt;\n</code></pre></div>",
        "id": 265515611,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1639968412
    },
    {
        "content": "<p>Which is part of a Bundle referenced by this:<br>\n  &lt;extension url=\"<a href=\"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-sourceQueries\">http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-sourceQueries</a>\"&gt;<br>\n    &lt;valueReference&gt;<br>\n      &lt;reference value=\"#PrePopQuery\"/&gt;<br>\n    &lt;/valueReference&gt;<br>\n  &lt;/extension&gt;</p>",
        "id": 265515641,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1639968480
    },
    {
        "content": "<p>Then that's not the x-fhir-query I thought you were talking about (in the expression datatype)</p>",
        "id": 265539156,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1639992634
    },
    {
        "content": "<p>That's a batch search request, and yes your problem might be there.</p>",
        "id": 265539195,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1639992672
    },
    {
        "content": "<p>Why not just update the schema validation to handle the embedded FHIRPath?  I don't think changing the FHIRPath syntax is the right thing to do.</p>",
        "id": 265572779,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1640011996
    },
    {
        "content": "<p>Validation schema for the type is normative, so that's hard to change.  For now, I've just HTTP-escaped the string and mentioned in the spec that that may be necessary.</p>",
        "id": 265576134,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1640013462
    }
]