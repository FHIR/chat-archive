[
    {
        "content": "<p>I am trying to do something similar to Brian's   <span class=\"user-mention\" data-user-id=\"191367\">@Brian Postlethwaite</span>     \"explanation.7   Options from a coding expanded using a fhir query, and a fhirpath expression. Useful when the expression is effected by other values on the form\"   at <a href=\"https://sqlonfhir-r4.azurewebsites.net/fhir/Questionnaire/coding-sampler\">https://sqlonfhir-r4.azurewebsites.net/fhir/Questionnaire/coding-sampler</a></p>\n<p>The example uses <a href=\"https://r4.ontoserver.csiro.au/fhir\">https://r4.ontoserver.csiro.au/fhir</a>     terminology server, but do I need to use one?  If I want to get the valueset for my answer expression from value set <a href=\"http://hl7.org/fhir/ValueSet/languages\">http://hl7.org/fhir/ValueSet/languages</a>  can I just expand it in the expression without the ontoserver?   Or does expansion require a terminology server in order to call the $expand operation?</p>\n<div class=\"codehilite\"><pre><span></span><code>&lt;extension url=&quot;http://hl7.org/fhir/StructureDefinition/variable&quot; &gt;\n     &lt;valueExpression &gt;\n             &lt;description value=&quot;Variable to hold the results of the expansion&quot;/&gt;\n             &lt;name value=&quot;vsListOfLanguages&quot;/&gt;\n             &lt;language value=&quot;application/x-fhir-query&quot;/&gt;\n             &lt;expression value=&quot;$expand?url=http://hl7.org/fhir/ValueSet/languages&quot;/&gt;\n     &lt;/valueExpression&gt;\n&lt;/extension&gt;\n</code></pre></div>\n<p>Alternately, if I have used a contained and expanded valueset (like the contained valueset #pre-expanded  at <a href=\"https://sqlonfhir-r4.azurewebsites.net/fhir/Questionnaire/coding-sampler\">https://sqlonfhir-r4.azurewebsites.net/fhir/Questionnaire/coding-sampler</a>),  how can I include that in my answer expression?   </p>\n<p>Do I create a variable first?   If yes, would this be the syntax?   I don't know how to get the contained valueset<br>\n #pre-expanded  into the variable.</p>\n<div class=\"codehilite\"><pre><span></span><code>&lt;extension url=&quot;http://hl7.org/fhir/StructureDefinition/variable&quot; &gt;\n    &lt;valueExpression &gt;\n        &lt;description value=&quot;Variable for #pre-expanded valueset &quot;/&gt;\n        &lt;name value=&quot;vsPreExpanded&quot;/&gt;\n        &lt;language value=&quot;text/fhirpath&quot;/&gt;\n        &lt;expression value=&quot;#pre-expanded&quot;/&gt;\n    &lt;/valueExpression&gt;\n&lt;/extension&gt;\n</code></pre></div>\n<p>Or do I skip the variable creation?  Can I refer to the #pre-expanded  contained  valueset in the answerExpression without putting it into a variable?</p>\n<div class=\"codehilite\"><pre><span></span><code>&lt;extension url=&quot;http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-answerExpression&quot; &gt;\n    &lt;valueExpression &gt;\n        &lt;description value=&quot;select the coded values from the expansion results in the above expression&quot;/&gt;\n        &lt;name value=&quot;ListOfLanguages&quot;/&gt;\n        &lt;language value=&quot;text/fhirpath&quot;/&gt;\n        &lt;expression value=&quot;#pre-expanded.expansion.contains&quot;/&gt;\n    &lt;/valueExpression&gt;\n&lt;/extension&gt;\n</code></pre></div>",
        "id": 264251204,
        "sender_full_name": "Diane",
        "timestamp": 1639019173
    },
    {
        "content": "<p>That's an option I hadn't considered, but I believe you should be able to reference that through $questionnaire.contained[0].expansion....</p>",
        "id": 264258154,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1639026785
    },
    {
        "content": "<p>Yes, I think that is a better way to reference the contained resource.   It seems like it should work.</p>\n<p>My answerExpression is iif(%resource.descendants().where(linkId = 'Q1').answer.value.exists(), %resource.descendants().where(linkId = 'Q1').answer.value, %resource.contained[0].expansion.contains)        but this doesn't work</p>\n<p>%resource.contained[0].expansion.contains  by itself  doesn't work either .  No drop down appears with these values.</p>\n<p>I am trying to prepopulate from Q1  if it exists; otherwise  show the contained expanded valueset.   </p>\n<p>I sent an email to LHC Forms support (Paul)   in case it has something to do with LHC Forms specifically.      Maybe the answerExpression is not compatible with expanded contained valuesets in LHC forms?    Or in the SDC standard?   </p>\n<p>If that is the case,  my only option is to use a terminology server with the $expand operation?    How do I pick a terminology server?</p>",
        "id": 264384199,
        "sender_full_name": "Diane",
        "timestamp": 1639093807
    },
    {
        "content": "<p>might need to check on if %resource or %questionnaire is the appropriate thing to connect to (not sure on the context of the path execution you've got there, if its on the QR, then %questionaire is the right one.)</p>",
        "id": 264407043,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1639116565
    },
    {
        "content": "<p>I think the issue is %questionnaire.contained is needed instead of %resource.contained.</p>",
        "id": 264464080,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1639150681
    },
    {
        "content": "<p>questionnaire.contained[0].expansion.contains   is what worked.   Thanks!  </p>\n<p>Before posting, I tried:</p>\n<p>%resource.contained...<br>\nresource.contained...<br>\n%Questionnaire.contained...<br>\nQuestionnaire.contained...<br>\n%questionnaire.contained...</p>\n<p>In the fhirpath testers (Brian's and fhirpath js):</p>\n<p>Questionnaire.title  works  but not questionnaire.title</p>\n<p>Questionnaire.contained[0].expansion.contains  works but not questionnaire.contained[0].expansion.contains</p>\n<p>%resource.contained[0].expansion.contains     works in Brian's fhirpath tester, but not fhirpath js tester</p>\n<p>So why is the answerExpression  using questionnaire...  when the fhirpath testers use Questionnaire...?  Do the answerExpressions only use lowercase versions of the resource name  for the fhirpath expression?  This is very confusing.</p>",
        "id": 264672465,
        "sender_full_name": "Diane",
        "timestamp": 1639381897
    },
    {
        "content": "<p>I am assume that you mean for the fhirpath.js tester, the demo at <a href=\"https://hl7.github.io/fhirpath.js/\">https://hl7.github.io/fhirpath.js/</a>.  That demo won't have %questionnaire defined, because %questionnaire is only set by a form renderer when a user is filling out a Questionnaire.  FHIRPath can be used in a lot of contexts in which there isn't a Questionnaire (or even a resource), so the demo only defines things like %context that are defined in the FHIRPath specification.  I suppose it would be helpful if the demo listed the variables that are defined.</p>",
        "id": 264734347,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1639413991
    },
    {
        "content": "<p>Yes, the fhirpath demo.   When should I be using questionnaire  (lowercase q)  vs.  Questionnaire in my answerExpressions?</p>",
        "id": 264761493,
        "sender_full_name": "Diane",
        "timestamp": 1639425584
    },
    {
        "content": "<p>Starting an expression with a resource name like \"Questionnaire\" means that the object in %context should be checked to make sure it is a resource of that type.  In nearly all cases in a QuestionnaireResponse (all that I can think of), %context will not have a Questionnaire, so it would probably not be useful to start it that way.</p>",
        "id": 264761961,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1639425752
    },
    {
        "content": "<p>OK. So what does questionnaire  (not the resource name \"Questionnaire\") do?   I am trying to use an included value set for the answerExpression, so I need to refer to this included valueset.  How does the expression know what %context to use?    Why does questionnaire.contained[0].expansion.contains         work?     Why doesn't   %questionnaire.contained[0]... work?</p>",
        "id": 264763523,
        "sender_full_name": "Diane",
        "timestamp": 1639426457
    },
    {
        "content": "<p>Do you mean %questionnaire?  \"questionnaire.contained...\"  (without the %) would not work, I don't think.</p>",
        "id": 264763640,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1639426521
    },
    {
        "content": "<p>Never mind.  %questionnaire is correct.    I understand why.   I was confusing myself.  And you.  <span aria-label=\"frown\" class=\"emoji emoji-1f641\" role=\"img\" title=\"frown\">:frown:</span></p>",
        "id": 264767392,
        "sender_full_name": "Diane",
        "timestamp": 1639428263
    },
    {
        "content": "<p>No problem.</p>",
        "id": 264767461,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1639428306
    },
    {
        "content": "<p>Yeah, the fhirpath tester doesn't have a way to define variables, but have been thinking how to do that.</p>",
        "id": 264937907,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1639522109
    },
    {
        "content": "<p>(UI suggestions welcomed there)</p>",
        "id": 264937928,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1639522124
    }
]