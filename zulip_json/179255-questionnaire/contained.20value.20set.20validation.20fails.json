[
    {
        "content": "<p>Hello!<br>\nI was trying to follow the questionnaire example here <a href=\"https://www.hl7.org/fhir/questionnaire-example-gcs.json.html\">https://www.hl7.org/fhir/questionnaire-example-gcs.json.html</a> because it defines \"contained Value Sets\". This is exactly what I need.<br>\nUnfortunately if I try to validate an example response against this questionnaire, it fails with the errors:<br>\n<code>ValueSet #verbal not found by validator</code><br>\n<code>ValueSet #motor not found by validator</code><br>\n<code>ValueSet #eye not found by validator</code></p>\n<p>Here is the example response I tried to validate:</p>\n<div class=\"codehilite\"><pre><span></span><code>{\n    &quot;resourceType&quot;: &quot;QuestionnaireResponse&quot;,\n    &quot;questionnaire&quot;: &quot;http://hl7.org/fhir/Questionnaire/gcs&quot;,\n    &quot;status&quot;: &quot;completed&quot;,\n    &quot;subject&quot;: {\n        &quot;reference&quot;: &quot;Patient/some-id&quot;\n    },\n    &quot;authored&quot;: &quot;2021-04-27T13:56:24.307Z&quot;,\n    &quot;item&quot;: [\n        {\n            &quot;linkId&quot;: &quot;1.1&quot;,\n            &quot;answer&quot;: [\n                {\n                    &quot;valueCoding&quot;: {\n                        &quot;system&quot;: &quot;http://loinc.org&quot;,\n                        &quot;code&quot;: &quot;LA6557-8&quot;\n                    }\n                }\n            ]\n        },\n        {\n            &quot;linkId&quot;: &quot;1.2&quot;,\n            &quot;answer&quot;: [\n                {\n                    &quot;valueCoding&quot;: {\n                        &quot;system&quot;: &quot;http://loinc.org&quot;,\n                        &quot;code&quot;: &quot;LA6563-6&quot;\n                    }\n                }\n            ]\n        },\n        {\n            &quot;linkId&quot;: &quot;1.3&quot;,\n            &quot;answer&quot;: [\n                {\n                    &quot;valueCoding&quot;: {\n                        &quot;system&quot;: &quot;http://loinc.org&quot;,\n                        &quot;code&quot;: &quot;LA6556-0&quot;\n                    }\n                }\n            ]\n        }\n    ]\n}\n</code></pre></div>\n<p>What is wrong here?</p>",
        "id": 236341047,
        "sender_full_name": "Christian Nau",
        "timestamp": 1619531845
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span></p>",
        "id": 236342394,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1619532326
    },
    {
        "content": "<p>I have seen smt. similar but slightly different using the validation code in HAPI (5.2. and 5.3, didn't try earlier versions): if one specifies a value set for a Questionnaire answer and make it a contained resource in the Questionnaire, the code in the QuestionnaireResponse are not checked against it (codes not in value set do not generate errors).  I suppose the difference to the case above could be that HAPI only classifies the inability to find the  contained value set as a warning, not an error.</p>",
        "id": 236343094,
        "sender_full_name": "Morten Ernebjerg",
        "timestamp": 1619532593
    },
    {
        "content": "<p>I'm using HAPI (Smile CDR) as well and tested Validation using <code>{{fhir-base-url}}/QuestionnaireResponse/$validate</code> with the above example request-body.<br>\n<span class=\"user-mention\" data-user-id=\"194703\">@Morten Ernebjerg</span> Do I understand you correctly, that you think HAPI isn't capable of validation contained Value-Sets and therefore returns a warning?<br>\nThis would not be so great, because this would mean I cannot use this approach without loosing validation for correct answers.</p>",
        "id": 236344114,
        "sender_full_name": "Christian Nau",
        "timestamp": 1619532935
    },
    {
        "content": "<p>A workaround would be to use answer-options <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 236344344,
        "sender_full_name": "Christian Nau",
        "timestamp": 1619533011
    },
    {
        "content": "<p>It <em>should</em> be capable.</p>",
        "id": 236346218,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1619533623
    },
    {
        "content": "<p>What I know is that the attached Questionnaire/QuestionnaireResponse pair (see below) does not cause a validation error in HAPI 5.2. and 5.3, though it should (I have a test that checks for this behavior so I will at least know if it starts working in later HAPI versions <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span> ). It works if the value sets are loaded separately, so that is what I do in my case (could, perhaps also be done on-the-fly).</p>\n<p>I also asked about it in the HAPI stream (see <a href=\"#narrow/stream/179167-hapi/topic/Validation.20does.20not.20find.20contained.20ValueSet\">this thread</a>), but didn't get an answer and forgot about it again.</p>\n<ul>\n<li><a href=\"/user_uploads/10155/VpYgL8lqA0qUXqZuSCAzbumI/test-questionnaire-r4.Questionnaire.json\">Questionnaire with contained value set</a> </li>\n<li><a href=\"/user_uploads/10155/sBn-CEn1mZQybuyIFxYyT0Fr/test-questionnaire-response-valid-r4.QuestionnaireResponse.json\">QuestionnaireResponse with answer code not in required value set</a></li>\n</ul>",
        "id": 236346585,
        "sender_full_name": "Morten Ernebjerg",
        "timestamp": 1619533743
    },
    {
        "content": "<p>Good to know. I will follow this thread.</p>\n<p>Any ideas from HAPI Power-Users? <span class=\"user-mention\" data-user-id=\"191451\">@Patrick Werner</span> :)</p>",
        "id": 236347271,
        "sender_full_name": "Christian Nau",
        "timestamp": 1619533950
    },
    {
        "content": "<p>we had a year ago an issue that contained valuesets get dropped when they were not referenced from the questionnaire itself in hapi, could that be the issue you have? see this <a href=\"#narrow/stream/179255-questionnaire/topic/Using.20answerOption.2EvalueReference\">discussion</a></p>",
        "id": 236348140,
        "sender_full_name": "Oliver Egger",
        "timestamp": 1619534209
    },
    {
        "content": "<p>Thank you <span class=\"user-mention\" data-user-id=\"191478\">@Oliver Egger</span> for this share. This looked like a not-to-bad workaround. Unfortunately this didn't work for me either. Still the same error message.<br>\nJust to be clear: I used the extension only for the <code>Questionnaire</code> definition, not within the Response, correct?</p>",
        "id": 236355874,
        "sender_full_name": "Christian Nau",
        "timestamp": 1619536350
    },
    {
        "content": "<p>how do you get this error?</p>",
        "id": 236430144,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1619568551
    },
    {
        "content": "<p>e.g. what is the full validator output?</p>",
        "id": 236430162,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1619568564
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> <br>\nI'm using the build in validator of HAPI (SmileCDR) which is executed when doing a POST request to this endpoint <code>{{fhir-base-url}}/QuestionnaireResponse/$validate</code></p>\n<p>The full response body looks like this (removed other warnings for clarity):</p>\n<div class=\"codehilite\"><pre><span></span><code>{\n    &quot;resourceType&quot;: &quot;OperationOutcome&quot;,\n    &quot;issue&quot;: [\n        {\n            &quot;severity&quot;: &quot;warning&quot;,\n            &quot;code&quot;: &quot;processing&quot;,\n            &quot;diagnostics&quot;: &quot;ValueSet #verbal not found by validator&quot;,\n            &quot;location&quot;: [\n                &quot;QuestionnaireResponse.item[0].answer[0]&quot;,\n                &quot;Line 16, Col 54&quot;\n            ]\n        },\n        {\n            &quot;severity&quot;: &quot;warning&quot;,\n            &quot;code&quot;: &quot;processing&quot;,\n            &quot;diagnostics&quot;: &quot;ValueSet #motor not found by validator&quot;,\n            &quot;location&quot;: [\n                &quot;QuestionnaireResponse.item[0].answer[0]&quot;,\n                &quot;Line 27, Col 54&quot;\n            ]\n        },\n        {\n            &quot;severity&quot;: &quot;warning&quot;,\n            &quot;code&quot;: &quot;processing&quot;,\n            &quot;diagnostics&quot;: &quot;ValueSet #eye not found by validator&quot;,\n            &quot;location&quot;: [\n                &quot;QuestionnaireResponse.item[0].answer[0]&quot;,\n                &quot;Line 38, Col 54&quot;\n            ]\n        }\n    ]\n}\n</code></pre></div>",
        "id": 236452133,
        "sender_full_name": "Christian Nau",
        "timestamp": 1619587074
    },
    {
        "content": "<p>then you need to ask on the HAPI stream; this works as expected on the command line validator, so it has to do with how the validator is hosted in HAPI</p>",
        "id": 236612262,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1619665635
    },
    {
        "content": "<p>Yes, <span class=\"user-mention\" data-user-id=\"194703\">@Morten Ernebjerg</span> already linked to <a href=\"#narrow/stream/179167-hapi/topic/Validation.20does.20not.20find.20contained.20ValueSet\">this HAPI thread</a> (see above).</p>",
        "id": 236628571,
        "sender_full_name": "Christian Nau",
        "timestamp": 1619679994
    }
]