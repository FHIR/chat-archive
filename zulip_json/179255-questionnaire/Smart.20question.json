[
    {
        "content": "<p>Has anyone put a question with answers like this in a questionnaire: ? <a href=\"https://www.painbc.ca/sites/default/files/inline-images/Pain%20Rating%20Scale.png\" target=\"_blank\" title=\"https://www.painbc.ca/sites/default/files/inline-images/Pain%20Rating%20Scale.png\">https://www.painbc.ca/sites/default/files/inline-images/Pain%20Rating%20Scale.png</a></p>\n<div class=\"message_inline_image\"><a href=\"https://www.painbc.ca/sites/default/files/inline-images/Pain%20Rating%20Scale.png\" target=\"_blank\" title=\"https://www.painbc.ca/sites/default/files/inline-images/Pain%20Rating%20Scale.png\"><img src=\"https://www.painbc.ca/sites/default/files/inline-images/Pain%20Rating%20Scale.png\"></a></div>",
        "id": 166687125,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1559025070
    },
    {
        "content": "<p>This app has a bunch of questions of that type and captures all its PROMs in QRs: <a href=\"https://play.google.com/store/apps/details?id=org.ehealthinnovation.icancope\" target=\"_blank\" title=\"https://play.google.com/store/apps/details?id=org.ehealthinnovation.icancope\">https://play.google.com/store/apps/details?id=org.ehealthinnovation.icancope</a></p>",
        "id": 166699651,
        "sender_full_name": "James Agnew",
        "timestamp": 1559036838
    },
    {
        "content": "<p>What do the questions look like in the questionnaire?</p>",
        "id": 166710386,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1559046182
    },
    {
        "content": "<p>The numeric scales are captured using valuesets that have the codes \"1\" through \"9\".</p>\n<p>It occurs to me you're probably asking about capturing that actual image in the questionnaire.. They aren't doing that, the display logic is all in the app.</p>",
        "id": 166711343,
        "sender_full_name": "James Agnew",
        "timestamp": 1559046922
    },
    {
        "content": "<p>You can use the xhtml extension to specify an image to render.  I don't have an example though.</p>",
        "id": 166712737,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1559047997
    },
    {
        "content": "<p>So the image data would not be in the Questionnaire itself, but only linked to from an img tag in the rendering-xhtml content?</p>",
        "id": 168709247,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1561145141
    },
    {
        "content": "<p>Actually, the img href could be of type data: for an embedded image (answering my own question).</p>",
        "id": 168710413,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1561146061
    },
    {
        "content": "<p>It could be in a contained Binary</p>",
        "id": 168718537,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1561152844
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span>  Do you mean the rendering-xhtml extension content could somehow refer to a Binary resource in Questionnaire.contained?</p>",
        "id": 168719411,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1561153675
    },
    {
        "content": "<p>I believe you would directly inline the image in the extension</p>",
        "id": 168723892,
        "sender_full_name": "Eric Haas",
        "timestamp": 1561158097
    },
    {
        "content": "<p>Right.  So if you binary had an id of 'someimage', your HTML could have &lt;img href=\"#someimage\"/&gt;</p>",
        "id": 168731610,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1561169827
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span>  I think you might mean \"src\" instead of href.  But, the bigger question is, how would a web-browser rendering this XHTML know what to do with #someimage?  By putting the image in Questionnaire.contained as a Binary, it is no longer a part of the XHTML.  I suppose one could specify (which I suspect we haven't) that things like href=#someimage are markers for IDs of contained Binaries, but it seems much more straightforward to just put the image data into the href.</p>",
        "id": 168947957,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1561475897
    },
    {
        "content": "<p>I don't know how it would work in practice.  We've just said that you could do this.  <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> <span class=\"user-mention\" data-user-id=\"191367\">@Brian Postlethwaite</span> ?</p>",
        "id": 168948244,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1561476156
    },
    {
        "content": "<p>example: <a href=\"http://www.hl7.org/fhir/list-example-familyhistory-genetics-profile-annie.json.html\" target=\"_blank\" title=\"http://www.hl7.org/fhir/list-example-familyhistory-genetics-profile-annie.json.html\">http://www.hl7.org/fhir/list-example-familyhistory-genetics-profile-annie.json.html</a></p>",
        "id": 168976463,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1561496061
    },
    {
        "content": "<p>Do you mean the online xhtml image data, or binary contained as in Grahame example?</p>",
        "id": 168980352,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1561499070
    },
    {
        "content": "<p>That example suggests that anytime there is XHTML, before it goes to the browser it should be parsed and searched for img tags with a src attribute of #something, and for each of those, if there is a contained Binary with an id of \"something\", replace the img tag src attribute value with a \"data:\" URL for the Binary's data.  Is that written down somewhere?  I would never have guessed that.</p>",
        "id": 169034521,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1561558697
    },
    {
        "content": "<p>Probably a good thing to note in the section on narrative and in the extension.  Care to submit a change request? :)</p>",
        "id": 169035819,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1561559481
    },
    {
        "content": "<p>(Advantage of the reference to a contained Binary is that if you have multiple references to the image, you only need to include it in the instance once.</p>",
        "id": 169035878,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1561559518
    },
    {
        "content": "<p><a href=\"https://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=22768\" target=\"_blank\" title=\"https://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=22768\">GF#22768</a></p>",
        "id": 169038798,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1561561090
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> <span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> <span class=\"user-mention\" data-user-id=\"195344\">@Paul Lynch</span>  - We have some of these image based questions in our app, and have used the following pattern to implement<br>\n{</p>\n<div class=\"codehilite\"><pre><span></span>       &quot;linkId&quot;: &quot;41&quot;,\n\n       &quot;text&quot;: &quot;Which colour do you prefer: red, blue, green or yellow?&quot;,\n\n       &quot;type&quot;: &quot;string&quot;,\n\n       &quot;required&quot;: true,\n\n       &quot;initialAttachment&quot;: {\n\n           &quot;url&quot;: &quot;data:image/png;base64,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&quot;\n\n       }\n\n   }\n</pre></div>\n\n\n<p>The user clicks on the image, and the coordinate string is passed back (\"answer\":[{\"valueString\":\"ImageCoordinatePosition:68,94\"}]) for the Questionnaire system to map to the image<br>\nIn this model, we are struggling with how the Questionnaire owner sends alt text for the image, for usability guidelines - any suggestions on how alt text for an image should be carried in a Questionnaire.item?</p>",
        "id": 170546299,
        "sender_full_name": "David Waters",
        "timestamp": 1562769091
    },
    {
        "content": "<p>I think you can only use initialAttachment if the item type is \"attachment\".<br>\nIf you use rendering-xthml, then the img tag for your image can include \"alt\".</p>",
        "id": 170550840,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1562772230
    },
    {
        "content": "<p>During the pre-population of this form, what order do you do things?<br>\n1. pre-pop launch parameter retrieval (or provided as parameters)<br>\n2. pre-pop query parameter replacement (potentially using above launch variables)<br>\n3. execution of the pre-pop query (retrieving data from the server)<br>\n(from here is where I struggle on the order of the next items as they could be interrelated)<br>\n4. evaluate all top level variable definitions (your BMI example has no values at this stage in those fields)<br>\n5. walk the items tree<br>\na) evaluate any variable definitions<br>\nb) performing the fhirpath pre-population based on the sdc-initialExpression extension<br>\nc) evaluate any calculatedExpressions<br>\nThe issues here are that there can be calculatedExpressions, variables and item answers that can all reference each other.<br>\n<span class=\"user-mention\" data-user-id=\"195344\">@Paul Lynch</span> do you have a specific way of handling this?</p>",
        "id": 170592741,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1562805715
    },
    {
        "content": "<p>I replied to Brian's question to me privately, but in case anyone else was interested in my answer, it was:<br>\n1) Loading of any known, needed resources happens first (launchContent and observationLinkPeriod), and I wait for them to finish Sometimes that takes several seconds if I am talking to a remote FHIR server. I don't handle FHIRPath in FHIR queries yet.<br>\n2) I don't distinguish between top-level variables and item-level variables. The \"top-level\" is just another node in the tree.<br>\n3) I process variables and field expressions (initial &amp; calculated) in a loop, where both are processed at least once, starting with variables. initialExpressions are only done the first pass through the loop. Thereafter, the loop continues with variables being evaluated if field values have changed (due to expressions) and with field expressions being run if variables have changed. When nothing has changed the loop exits. Per the spec, it should also exit after a certain number of iterations, but I haven't updated the logic yet.<br>\n4) Variables only affect their item and sub-items, so if a variable changes I set a flag on the item so that I know whether to bother re-running the field expressions that might depend on them.</p>\n<p>If you want to look at the code, the part of LHC-Forms that does this is the \"<a href=\"https://github.com/lhncbc/lforms/blob/master/app/scripts/lib/expression-processor.js\" target=\"_blank\" title=\"https://github.com/lhncbc/lforms/blob/master/app/scripts/lib/expression-processor.js\">ExpressionProcessor</a>\", and the loop that starts things off is in lines 35-45.</p>",
        "id": 170902070,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1563203607
    },
    {
        "content": "<p>sounds like the way that angularjs (v1) works..</p>",
        "id": 170918274,
        "sender_full_name": "David Hay",
        "timestamp": 1563214849
    },
    {
        "content": "<p>I am familiar with AngularJS, because that is what LHC-Forms is written in.  It is somewhat similar.  A difference is that we don't re-run the expressions a second time to see if the results have changed.  We compare the previous value to the new one.</p>",
        "id": 170935740,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1563228111
    }
]