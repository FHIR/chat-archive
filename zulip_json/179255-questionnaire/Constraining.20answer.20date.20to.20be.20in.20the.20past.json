[
    {
        "content": "<p>Hi <span aria-label=\"wave\" class=\"emoji emoji-1f44b\" role=\"img\" title=\"wave\">:wave:</span>  Suppose we have a questionnaire and one question asks for a date. The date entered must not be in the future (i.e. later than the date on which the answer is collected), e.g. suppose the question is \"When was your last visit?\" Is there any way to capture this constraint in a Questionnaire? I see the <a href=\"http://hl7.org/fhir/r4/extension-maxvalue.html\">max-value extension</a>, but I am assuming that it only allows specifying a <em>fixed</em> latest allowed date.</p>",
        "id": 208063365,
        "sender_full_name": "Morten Ernebjerg",
        "timestamp": 1598429349
    },
    {
        "content": "<p>It sounds like there is a need for a FHIRPath expression there.</p>",
        "id": 208099329,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1598452449
    },
    {
        "content": "<p>Ironically, we've come to this chat today to ask this very same question, only to find it had been asked in the morning! We've been considering using the questionnaire-constraint extension. It contains a FHIRPath expression, and the language has the function today(). But is it an appropriate use of the extension? Its use cases are not really documented, and it appears to be meant for expressing constraints on the resources underlying the Questionnaire, not the Questionnaire itself. It is not clear what resource or element should the FHIRPath expression be written against. The Observation? The QuestionnaireResponse? The QuestionnaireResponse.Item?</p>",
        "id": 208103620,
        "sender_full_name": "Vladimir Smirnov",
        "timestamp": 1598454157
    },
    {
        "content": "<p><a href=\"http://build.fhir.org/extension-questionnaire-constraint.html\">http://build.fhir.org/extension-questionnaire-constraint.html</a> would allow you to make such an assertion using FHIRPath</p>",
        "id": 208109517,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1598456658
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191320\">Lloyd McKenzie</span> <a href=\"#narrow/stream/179255-questionnaire/topic/Constraining.20answer.20date.20to.20be.20in.20the.20past/near/208109517\">said</a>:</p>\n<blockquote>\n<p><a href=\"http://build.fhir.org/extension-questionnaire-constraint.html\">http://build.fhir.org/extension-questionnaire-constraint.html</a> would allow you to make such an assertion using FHIRPath</p>\n</blockquote>\n<p>What should the FHIRPath be written against? The root of QuestionnaireResponse?</p>",
        "id": 208110949,
        "sender_full_name": "Vladimir Smirnov",
        "timestamp": 1598457380
    },
    {
        "content": "<p>The context would be the element the extension appears on - which could be the root or could be an item with in the Questionnaire.  It would be evaluated on the corresponding level of the QuestionnaireResponse</p>",
        "id": 208119953,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1598461767
    },
    {
        "content": "<p>We do this quite often exactly as above.</p>",
        "id": 208155039,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1598479491
    },
    {
        "content": "<p>It's also quite interesting in terms of later validation. It might pass now, but if updating later, what's the rule there...</p>",
        "id": 208155124,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1598479553
    },
    {
        "content": "<p>Good point about the validation, <span class=\"user-mention\" data-user-id=\"191367\">@Brian Postlethwaite</span>, had not considered that . We were considering adding this information as a hint to the UI that it should not allow the user to enter a future date. But once the data is collected, the constraint is effectively defunct in the sense that we'd want (need) to ignore it if validating the QuestionnaireResponse at a later time. I suppose this is actually a generic validation issue for such \"time-dependent\" constraints everywhere. So maybe we can't have our cake and eat, too?</p>",
        "id": 208192814,
        "sender_full_name": "Morten Ernebjerg",
        "timestamp": 1598518946
    },
    {
        "content": "<p>For the server side, that today() validation might substitute the author or lastmod date... But just a thought.</p>",
        "id": 208192950,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1598519055
    },
    {
        "content": "<p>For our usecase that could probably work quite well. But I imagine it would be hard to capture/communicate that expected transformation. I suppose what we wanted to communicate to the UI is actually a notion of \"context-sensitive validity\" (what is valid <em>at the point in time when the data is enteted</em>) that is difficult to bring together with the usual FHIR validity.</p>\n<p>So now I'm thinking the way to go might rather be to have an extension carrying a code to communicate \"not in the future\". The clients would have to pick that up , but the validator could ignore it. This would be along the lines of the <a href=\"https://www.hl7.org/fhir/extension-questionnaire-itemcontrol.html\">itemControl extension</a> that gives a code indicating how to render an item. Indeed, I suppose one could even use that ext directly by adding a code for \"date picker only accepting dates in the past\" <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span></p>",
        "id": 208209236,
        "sender_full_name": "Morten Ernebjerg",
        "timestamp": 1598531225
    },
    {
        "content": "<p>i have the same question and i'm think of the definition for the frontend in the questionnaire. the following proposition i defined</p>\n<p>Instance: undefined<br>\nInstanceOf: Questionnaire<br>\nUsage: #example</p>\n<ul>\n<li>status = #draft</li>\n<li>extension[0].url = \"<a href=\"http://hl7.org/fhir/StructureDefinition/variable\">http://hl7.org/fhir/StructureDefinition/variable</a>\"</li>\n<li>extension[=].valueExpression.name = \"todaydate\"</li>\n<li>extension[=].valueExpression.language = #text/fhirpath</li>\n<li>extension[=].valueExpression.expression = \"today()\"</li>\n<li>item[+].linkId = \"1\"</li>\n<li>item[=].text = \"Actual date\"</li>\n<li>item[=].type = #date</li>\n<li>item[=].extension[+].url = \"<a href=\"http://hl7.org/fhir/StructureDefinition/maxValue\">http://hl7.org/fhir/StructureDefinition/maxValue</a>\"</li>\n<li>item[=].extension[=].valueDate = \"%todaydate\"</li>\n<li>item[=].extension[=].valueDate.extension.url = \"<a href=\"http://hl7.org/fhir/StructureDefinition/cqf-calculatedValue\">http://hl7.org/fhir/StructureDefinition/cqf-calculatedValue</a>\"</li>\n<li>item[=].extension[=].valueDate.extension.valueString = \"max_date\"</li>\n<li>item[=].extension[+].url = \"<a href=\"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-initialExpression\">http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-initialExpression</a>\"</li>\n<li>item[=].extension[=].valueExpression.language = #text/fhirpath</li>\n<li>item[=].extension[=].valueExpression.expression = \"today()\"</li>\n</ul>\n<p>sushi has a problem with the \"cannot assign string value: %todaydate. Value does not match element type: date\" but somehow it likes me that it could be the in the right direction.</p>\n<p>someone an other proposition?</p>",
        "id": 259356905,
        "sender_full_name": "Roeland Luykx",
        "timestamp": 1635410540
    },
    {
        "content": "<p>If you're setting a date to an expression, you can't have valueDate, you need to have a valueExpression</p>",
        "id": 259398124,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1635431868
    },
    {
        "content": "<p>I don't think maxValue takes an Expression.  You could use cqf-expression on maxValue, but maxValue isn't one of the places the SDC IG mentions for using cqf-expression.</p>",
        "id": 259427663,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1635443775
    }
]