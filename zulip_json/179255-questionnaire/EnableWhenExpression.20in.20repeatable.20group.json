[
    {
        "content": "<p>Hello!<br>\nI hope you are doing well. I faced some issues when I try to define some conditional logic on repeatable group children.</p>\n<p>I want to define some conditional expressions for an element of a repeatable group.<br>\nIf there is an answer for the first, I would like to show the second question</p>\n<p>I am using YAML and first-class extension notation to make the Questionnaire resource more readable.</p>\n<div class=\"codehilite\" data-code-language=\"YAML\"><pre><span></span><code><span class=\"nt\">resourceType</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">Questionnaire</span>\n<span class=\"nt\">item</span><span class=\"p\">:</span>\n<span class=\"p p-Indicator\">-</span> <span class=\"nt\">type</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">group</span>\n  <span class=\"nt\">linkId</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">my-group</span>\n  <span class=\"nt\">repeats</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">true</span>\n  <span class=\"nt\">item</span><span class=\"p\">:</span>\n  <span class=\"p p-Indicator\">-</span> <span class=\"nt\">type</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">text</span>\n    <span class=\"nt\">linkId</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">first</span>\n  <span class=\"p p-Indicator\">-</span> <span class=\"nt\">type</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">text</span>\n    <span class=\"nt\">linkId</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">second</span>\n    <span class=\"nt\">enableWhenExpression</span><span class=\"p\">:</span> <span class=\"s\">'%parent.item.where(linkId='</span><span class=\"l l-Scalar l-Scalar-Plain\">first').count()&gt;0'</span>\n</code></pre></div>\n<p>I am confused about how can I define parent in this case.</p>\n<p>The best I did is</p>\n<div class=\"codehilite\" data-code-language=\"YAML\"><pre><span></span><code><span class=\"nt\">resourceType</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">Questionnaire</span>\n<span class=\"nt\">item</span><span class=\"p\">:</span>\n<span class=\"p p-Indicator\">-</span> <span class=\"nt\">type</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">group</span>\n  <span class=\"nt\">linkId</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">my-group</span>\n  <span class=\"nt\">repeats</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">true</span>\n  <span class=\"nt\">variable</span><span class=\"p\">:</span>\n  <span class=\"p p-Indicator\">-</span> <span class=\"nt\">name</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">parent</span>\n    <span class=\"nt\">expression</span><span class=\"p\">:</span> <span class=\"s\">'%context'</span>\n  <span class=\"nt\">item</span><span class=\"p\">:</span>\n  <span class=\"p p-Indicator\">-</span> <span class=\"nt\">type</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">text</span>\n    <span class=\"nt\">linkId</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">first</span>\n  <span class=\"p p-Indicator\">-</span> <span class=\"nt\">type</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">text</span>\n    <span class=\"nt\">linkId</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">second</span>\n    <span class=\"nt\">enableWhenExpression</span><span class=\"p\">:</span> <span class=\"s\">'%parent.answer.item.where(linkId='</span><span class=\"l l-Scalar l-Scalar-Plain\">first').count()&gt;0'</span>\n</code></pre></div>\n<p>Unfortunately, this doesn't work obviously. I got all answers to <code>my-group</code>, but I need only a current one.</p>\n<p>How can I define <code>%parent</code> to achieve desired behavior?</p>",
        "id": 247447621,
        "sender_full_name": "Ilya Beda",
        "timestamp": 1627472200
    },
    {
        "content": "<p>You shouldn't need to use enableWhenExpression at all there.  You'd just have enableWhen.question=first, operator=exists, answerBoolean=true</p>",
        "id": 247459866,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1627479571
    },
    {
        "content": "<p>Also, what is %parent?  I don't think there is such a thing, unless you create a variable named that.  Speaking of which, if you do define a variable on the group, you can capture the value of item \"first\", and each repetition of the group will have its own copy of the variable.</p>",
        "id": 247470441,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1627484303
    },
    {
        "content": "<p>It is my question - what should I use for <code>%parent</code> to work exactly as I described.<br>\n<span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> You are right, in this particular case, I can use <code>enableWhen</code> instead of <code>enableWhenExpression</code>.<br>\nHowever, I provided a very simplified version of the Questionnaire.<br>\nIn the real-life case, I can't use <code>enableWhen</code>, I need <code>enableWhenExpression</code>.</p>",
        "id": 247477433,
        "sender_full_name": "Ilya Beda",
        "timestamp": 1627487627
    },
    {
        "content": "<p>So, I don't think you want %parent, but define a %first on the group, as \"item.where(linkId='first')\"</p>",
        "id": 247478377,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1627488052
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"196255\">@Ilya Beda</span> I am sorry I misunderstood what you were asking about %parent.  I played with your test Questionnaire in LHC-Forms, and there I needed to change enableWhenExpression to calculatedExpression, because we don't support enableWhenExpression yet.  However, I have a sample form to work that shows a count of either 0 or 1 for  each repetition of the group,  depending on whether the first question in each repetition is filled in.  You can use the \"Load From File\" button at <a href=\"https://lhcforms.nlm.nih.gov/lhcforms\">https://lhcforms.nlm.nih.gov/lhcforms</a> to try the Questionnaire below.  Each repitition of the group gets its own group variable.  I would not recommend putting %context into a variable on the group, because that causes an endless loop, because the %context includes the child question answers, and the child question answers depend on that variable.</p>\n<div class=\"codehilite\"><pre><span></span><code>{\n  &quot;resourceType&quot;: &quot;Questionnaire&quot;,\n  &quot;item&quot;: [\n    {\n      &quot;type&quot;: &quot;group&quot;,\n      &quot;linkId&quot;: &quot;my-group&quot;,\n      &quot;text&quot;: &quot;some group&quot;,\n      &quot;repeats&quot;: true,\n      &quot;extension&quot;: [\n        {\n          &quot;url&quot;: &quot;http://hl7.org/fhir/StructureDefinition/variable&quot;,\n          &quot;valueExpression&quot;: {\n            &quot;name&quot;: &quot;count&quot;,\n            &quot;language&quot;: &quot;text/fhirpath&quot;,\n            &quot;expression&quot;: &quot;item.where(linkId=&#39;first&#39;).count()&quot;\n          }\n        }\n      ],\n      &quot;item&quot;: [\n        {\n          &quot;type&quot;: &quot;text&quot;,\n          &quot;linkId&quot;: &quot;first&quot;\n        },\n        {\n          &quot;type&quot;: &quot;string&quot;,\n          &quot;linkId&quot;: &quot;second&quot;,\n          &quot;readonly&quot;: true,\n          &quot;extension&quot;: [\n            {\n              &quot;url&quot;: &quot;http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-calculatedExpression&quot;,\n              &quot;valueExpression&quot;: {\n                &quot;language&quot;: &quot;text/fhirpath&quot;,\n                &quot;expression&quot;: &quot;%count&quot;\n              }\n            }\n          ]\n        }\n      ]\n    }\n  ]\n}\n</code></pre></div>",
        "id": 247507719,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1627501436
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"195344\">@Paul Lynch</span> <br>\nThank you for sharing your example.<br>\nI have a question about QuestionnaireResponse produced by LHC-Forms.</p>\n<p>It uses duplicated items with the same linkId if the type of \"my-group\" is a group.</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"p\">{</span>\n  <span class=\"nt\">\"resourceType\"</span><span class=\"p\">:</span> <span class=\"s2\">\"QuestionnaireResponse\"</span><span class=\"p\">,</span>\n  <span class=\"nt\">\"meta\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n    <span class=\"nt\">\"profile\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n      <span class=\"s2\">\"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaireresponse|2.7\"</span>\n    <span class=\"p\">],</span>\n    <span class=\"nt\">\"tag\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n      <span class=\"p\">{</span>\n        <span class=\"nt\">\"code\"</span><span class=\"p\">:</span> <span class=\"s2\">\"lformsVersion: 29.0.3\"</span>\n      <span class=\"p\">}</span>\n    <span class=\"p\">]</span>\n  <span class=\"p\">},</span>\n  <span class=\"nt\">\"status\"</span><span class=\"p\">:</span> <span class=\"s2\">\"completed\"</span><span class=\"p\">,</span>\n  <span class=\"nt\">\"authored\"</span><span class=\"p\">:</span> <span class=\"s2\">\"2021-07-29T09:59:46.758Z\"</span><span class=\"p\">,</span>\n  <span class=\"nt\">\"item\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n    <span class=\"p\">{</span>\n      <span class=\"nt\">\"linkId\"</span><span class=\"p\">:</span> <span class=\"s2\">\"my-group\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"text\"</span><span class=\"p\">:</span> <span class=\"s2\">\"some group\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"item\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n        <span class=\"p\">{</span>\n          <span class=\"nt\">\"linkId\"</span><span class=\"p\">:</span> <span class=\"s2\">\"first\"</span><span class=\"p\">,</span>\n          <span class=\"nt\">\"answer\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n            <span class=\"p\">{</span>\n              <span class=\"nt\">\"valueString\"</span><span class=\"p\">:</span> <span class=\"s2\">\"43\"</span>\n            <span class=\"p\">}</span>\n          <span class=\"p\">]</span>\n        <span class=\"p\">},</span>\n        <span class=\"p\">{</span>\n          <span class=\"nt\">\"linkId\"</span><span class=\"p\">:</span> <span class=\"s2\">\"second\"</span><span class=\"p\">,</span>\n          <span class=\"nt\">\"answer\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n            <span class=\"p\">{</span>\n              <span class=\"nt\">\"valueString\"</span><span class=\"p\">:</span> <span class=\"mi\">1</span>\n            <span class=\"p\">}</span>\n          <span class=\"p\">]</span>\n        <span class=\"p\">}</span>\n      <span class=\"p\">]</span>\n    <span class=\"p\">},</span>\n    <span class=\"p\">{</span>\n      <span class=\"nt\">\"linkId\"</span><span class=\"p\">:</span> <span class=\"s2\">\"my-group\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"text\"</span><span class=\"p\">:</span> <span class=\"s2\">\"some group\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"item\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n        <span class=\"p\">{</span>\n          <span class=\"nt\">\"linkId\"</span><span class=\"p\">:</span> <span class=\"s2\">\"second\"</span><span class=\"p\">,</span>\n          <span class=\"nt\">\"answer\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n            <span class=\"p\">{</span>\n              <span class=\"nt\">\"valueString\"</span><span class=\"p\">:</span> <span class=\"mi\">0</span>\n            <span class=\"p\">}</span>\n          <span class=\"p\">]</span>\n        <span class=\"p\">}</span>\n      <span class=\"p\">]</span>\n    <span class=\"p\">},</span>\n    <span class=\"p\">{</span>\n      <span class=\"nt\">\"linkId\"</span><span class=\"p\">:</span> <span class=\"s2\">\"my-group\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"text\"</span><span class=\"p\">:</span> <span class=\"s2\">\"some group\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"item\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n        <span class=\"p\">{</span>\n          <span class=\"nt\">\"linkId\"</span><span class=\"p\">:</span> <span class=\"s2\">\"first\"</span><span class=\"p\">,</span>\n          <span class=\"nt\">\"answer\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n            <span class=\"p\">{</span>\n              <span class=\"nt\">\"valueString\"</span><span class=\"p\">:</span> <span class=\"s2\">\"434\"</span>\n            <span class=\"p\">}</span>\n          <span class=\"p\">]</span>\n        <span class=\"p\">},</span>\n        <span class=\"p\">{</span>\n          <span class=\"nt\">\"linkId\"</span><span class=\"p\">:</span> <span class=\"s2\">\"second\"</span><span class=\"p\">,</span>\n          <span class=\"nt\">\"answer\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n            <span class=\"p\">{</span>\n              <span class=\"nt\">\"valueString\"</span><span class=\"p\">:</span> <span class=\"mi\">1</span>\n            <span class=\"p\">}</span>\n          <span class=\"p\">]</span>\n        <span class=\"p\">}</span>\n      <span class=\"p\">]</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">]</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>However, If I change type of the \"my-group\" to text it uses one item with multiple answers.<br>\n Also  the calculatedExpression stops to work.</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"p\">{</span>\n  <span class=\"nt\">\"resourceType\"</span><span class=\"p\">:</span> <span class=\"s2\">\"QuestionnaireResponse\"</span><span class=\"p\">,</span>\n  <span class=\"nt\">\"meta\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n    <span class=\"nt\">\"profile\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n      <span class=\"s2\">\"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaireresponse|2.7\"</span>\n    <span class=\"p\">],</span>\n    <span class=\"nt\">\"tag\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n      <span class=\"p\">{</span>\n        <span class=\"nt\">\"code\"</span><span class=\"p\">:</span> <span class=\"s2\">\"lformsVersion: 29.0.3\"</span>\n      <span class=\"p\">}</span>\n    <span class=\"p\">]</span>\n  <span class=\"p\">},</span>\n  <span class=\"nt\">\"status\"</span><span class=\"p\">:</span> <span class=\"s2\">\"completed\"</span><span class=\"p\">,</span>\n  <span class=\"nt\">\"authored\"</span><span class=\"p\">:</span> <span class=\"s2\">\"2021-07-29T09:58:02.083Z\"</span><span class=\"p\">,</span>\n  <span class=\"nt\">\"item\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n    <span class=\"p\">{</span>\n      <span class=\"nt\">\"linkId\"</span><span class=\"p\">:</span> <span class=\"s2\">\"my-group\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"text\"</span><span class=\"p\">:</span> <span class=\"s2\">\"some group\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"answer\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n        <span class=\"p\">{</span>\n          <span class=\"nt\">\"valueString\"</span><span class=\"p\">:</span> <span class=\"s2\">\"other\"</span><span class=\"p\">,</span>\n          <span class=\"nt\">\"item\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n            <span class=\"p\">{</span>\n              <span class=\"nt\">\"linkId\"</span><span class=\"p\">:</span> <span class=\"s2\">\"first\"</span><span class=\"p\">,</span>\n              <span class=\"nt\">\"answer\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n                <span class=\"p\">{</span>\n                  <span class=\"nt\">\"valueString\"</span><span class=\"p\">:</span> <span class=\"s2\">\"qwer\"</span>\n                <span class=\"p\">}</span>\n              <span class=\"p\">]</span>\n            <span class=\"p\">},</span>\n            <span class=\"p\">{</span>\n              <span class=\"nt\">\"linkId\"</span><span class=\"p\">:</span> <span class=\"s2\">\"second\"</span><span class=\"p\">,</span>\n              <span class=\"nt\">\"answer\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n                <span class=\"p\">{</span>\n                  <span class=\"nt\">\"valueString\"</span><span class=\"p\">:</span> <span class=\"mi\">0</span>\n                <span class=\"p\">}</span>\n              <span class=\"p\">]</span>\n            <span class=\"p\">}</span>\n          <span class=\"p\">]</span>\n        <span class=\"p\">},</span>\n        <span class=\"p\">{</span>\n          <span class=\"nt\">\"valueString\"</span><span class=\"p\">:</span> <span class=\"s2\">\"qqq\"</span><span class=\"p\">,</span>\n          <span class=\"nt\">\"item\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n            <span class=\"p\">{</span>\n              <span class=\"nt\">\"linkId\"</span><span class=\"p\">:</span> <span class=\"s2\">\"first\"</span><span class=\"p\">,</span>\n              <span class=\"nt\">\"answer\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n                <span class=\"p\">{</span>\n                  <span class=\"nt\">\"valueString\"</span><span class=\"p\">:</span> <span class=\"s2\">\"qqq\"</span>\n                <span class=\"p\">}</span>\n              <span class=\"p\">]</span>\n            <span class=\"p\">},</span>\n            <span class=\"p\">{</span>\n              <span class=\"nt\">\"linkId\"</span><span class=\"p\">:</span> <span class=\"s2\">\"second\"</span><span class=\"p\">,</span>\n              <span class=\"nt\">\"answer\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n                <span class=\"p\">{</span>\n                  <span class=\"nt\">\"valueString\"</span><span class=\"p\">:</span> <span class=\"mi\">0</span>\n                <span class=\"p\">}</span>\n              <span class=\"p\">]</span>\n            <span class=\"p\">}</span>\n          <span class=\"p\">]</span>\n        <span class=\"p\">}</span>\n      <span class=\"p\">]</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">]</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>It looks inconsistent.<br>\nFrom my opinion the second form looks better to me because it doesn't duplicates items wiht the same linkId.</p>",
        "id": 247564218,
        "sender_full_name": "Ilya Beda",
        "timestamp": 1627553049
    },
    {
        "content": "<p>Hey <span class=\"user-mention\" data-user-id=\"196255\">@Ilya Beda</span>, how are you converting your Questionnaire resources to/from JSON/YAML? <span class=\"user-mention\" data-user-id=\"235060\">@Grey Faulkenberry</span> created a package for this a while back using Dart, available <a href=\"https://pub.dev/packages/fhir_yaml\">here</a></p>",
        "id": 247580539,
        "sender_full_name": "John Manning",
        "timestamp": 1627564100
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"196255\">Ilya Beda</span> <a href=\"#narrow/stream/179255-questionnaire/topic/EnableWhenExpression.20in.20repeatable.20group/near/247564218\">said</a>:</p>\n<blockquote>\n<p>It looks inconsistent.</p>\n</blockquote>\n<p>I agree, but I think that is the way a QuestionnaireResponse is supposed to be.  Answers to child items of a question go under item.answer.item.answer, while answers to child items of a group go under item.item.answer.</p>",
        "id": 247586291,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1627566987
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"364926\">@John Manning</span> I am using aidbox as FHIR server, it provides such a feature</p>",
        "id": 247590204,
        "sender_full_name": "Ilya Beda",
        "timestamp": 1627568719
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"195344\">@Paul Lynch</span> does it mention somewhere in the spec? </p>\n<p>Duplication of item with same id confuses a lot. </p>\n<p>I am using item.item.answer when <code>repeats: false</code></p>",
        "id": 247590659,
        "sender_full_name": "Ilya Beda",
        "timestamp": 1627568884
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"196255\">Ilya Beda</span> <a href=\"#narrow/stream/179255-questionnaire/topic/EnableWhenExpression.20in.20repeatable.20group/near/247590659\">said</a>:</p>\n<blockquote>\n<p>I am using item.item.answer when <code>repeats: false</code></p>\n</blockquote>\n<p>I don't think that is correct unless the containing item is a group.  If both are questions, <a href=\"https://www.hl7.org/fhir/questionnaireresponse-definitions.html#QuestionnaireResponse.item\">https://www.hl7.org/fhir/questionnaireresponse-definitions.html#QuestionnaireResponse.item</a> says:  \"When dealing with questions, nesting must occur within each answer because some questions may have multiple answers (and the nesting occurs for each answer).\"</p>\n<p>For when the containing item is a group, I don't see how you can avoid repeating the group and its linkId for each repetition of the group.  But, the specification could be more clear on that point.  You might want to submit a change request.</p>",
        "id": 247591979,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1627569383
    },
    {
        "content": "<p>If you're nesting a question within a question, the child <em>must</em> be nested under answer.  repeats has no bearing on how nesting works.  We've approved a change to make this rule more explicit.</p>",
        "id": 247609528,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1627577307
    },
    {
        "content": "<p>What about %context value in repeatable questions with subquestions? I was trying to re-write the example from <span class=\"user-mention\" data-user-id=\"195344\">@Paul Lynch</span>. Here I need to calculate <code>second-question</code> that depends on <code>first-question</code>.</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"p\">{</span>\n  <span class=\"nt\">\"resourceType\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Questionnaire\"</span><span class=\"p\">,</span>\n  <span class=\"nt\">\"item\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n    <span class=\"p\">{</span>\n      <span class=\"nt\">\"type\"</span><span class=\"p\">:</span> <span class=\"s2\">\"text\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"linkId\"</span><span class=\"p\">:</span> <span class=\"s2\">\"top-question\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"text\"</span><span class=\"p\">:</span> <span class=\"s2\">\"top question\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"repeats\"</span><span class=\"p\">:</span> <span class=\"kc\">true</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"extension\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n        <span class=\"p\">{</span>\n          <span class=\"nt\">\"url\"</span><span class=\"p\">:</span> <span class=\"s2\">\"http://hl7.org/fhir/StructureDefinition/variable\"</span><span class=\"p\">,</span>\n          <span class=\"nt\">\"valueExpression\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n            <span class=\"nt\">\"name\"</span><span class=\"p\">:</span> <span class=\"s2\">\"count\"</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"language\"</span><span class=\"p\">:</span> <span class=\"s2\">\"text/fhirpath\"</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"expression\"</span><span class=\"p\">:</span> <span class=\"s2\">\"item.where(linkId='first-subquestion').count()\"</span>\n          <span class=\"p\">}</span>\n        <span class=\"p\">}</span>\n      <span class=\"p\">],</span>\n      <span class=\"nt\">\"item\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n        <span class=\"p\">{</span>\n          <span class=\"nt\">\"type\"</span><span class=\"p\">:</span> <span class=\"s2\">\"text\"</span><span class=\"p\">,</span>\n          <span class=\"nt\">\"text\"</span><span class=\"p\">:</span> <span class=\"s2\">\"First subquestion\"</span><span class=\"p\">,</span>\n          <span class=\"nt\">\"linkId\"</span><span class=\"p\">:</span> <span class=\"s2\">\"first-subquestion\"</span>\n        <span class=\"p\">},</span>\n        <span class=\"p\">{</span>\n          <span class=\"nt\">\"type\"</span><span class=\"p\">:</span> <span class=\"s2\">\"string\"</span><span class=\"p\">,</span>\n          <span class=\"nt\">\"linkId\"</span><span class=\"p\">:</span> <span class=\"s2\">\"second-subquestion\"</span><span class=\"p\">,</span>\n          <span class=\"nt\">\"text\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Second subquestion\"</span><span class=\"p\">,</span>\n          <span class=\"nt\">\"readonly\"</span><span class=\"p\">:</span> <span class=\"kc\">true</span><span class=\"p\">,</span>\n          <span class=\"nt\">\"extension\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n            <span class=\"p\">{</span>\n              <span class=\"nt\">\"url\"</span><span class=\"p\">:</span> <span class=\"s2\">\"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-calculatedExpression\"</span><span class=\"p\">,</span>\n              <span class=\"nt\">\"valueExpression\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n                <span class=\"nt\">\"language\"</span><span class=\"p\">:</span> <span class=\"s2\">\"text/fhirpath\"</span><span class=\"p\">,</span>\n                <span class=\"nt\">\"expression\"</span><span class=\"p\">:</span> <span class=\"s2\">\"%count\"</span>\n              <span class=\"p\">}</span>\n            <span class=\"p\">}</span>\n          <span class=\"p\">]</span>\n        <span class=\"p\">}</span>\n      <span class=\"p\">]</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">]</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Are there any ideas what should be placed into %context in my example?<br>\nI assume it must be answer[i] for each answer for 'top-question' . But according to the spec, %context shall refer to QuestionnaireResponse.item (<a href=\"https://build.fhir.org/ig/HL7/sdc/expressions.html#fhirpath-and-questionnaire\">https://build.fhir.org/ig/HL7/sdc/expressions.html#fhirpath-and-questionnaire</a>)</p>",
        "id": 247680461,
        "sender_full_name": "Vadim Laletin",
        "timestamp": 1627632344
    },
    {
        "content": "<p>Possible solution - connected subquestions can be wrapped into a group under top-question. What do you think?</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"p\">{</span>\n    <span class=\"nt\">\"resourceType\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Questionnaire\"</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"item\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n        <span class=\"p\">{</span>\n            <span class=\"nt\">\"type\"</span><span class=\"p\">:</span> <span class=\"s2\">\"text\"</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"linkId\"</span><span class=\"p\">:</span> <span class=\"s2\">\"top-question\"</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"text\"</span><span class=\"p\">:</span> <span class=\"s2\">\"top question\"</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"repeats\"</span><span class=\"p\">:</span> <span class=\"kc\">true</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"item\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n                <span class=\"p\">{</span>\n                    <span class=\"nt\">\"type\"</span><span class=\"p\">:</span> <span class=\"s2\">\"group\"</span><span class=\"p\">,</span>\n                    <span class=\"nt\">\"text\"</span><span class=\"p\">:</span> <span class=\"s2\">\"group\"</span><span class=\"p\">,</span>\n                    <span class=\"nt\">\"extension\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n                        <span class=\"p\">{</span>\n                            <span class=\"nt\">\"url\"</span><span class=\"p\">:</span> <span class=\"s2\">\"http://hl7.org/fhir/StructureDefinition/variable\"</span><span class=\"p\">,</span>\n                            <span class=\"nt\">\"valueExpression\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n                                <span class=\"nt\">\"name\"</span><span class=\"p\">:</span> <span class=\"s2\">\"count\"</span><span class=\"p\">,</span>\n                                <span class=\"nt\">\"language\"</span><span class=\"p\">:</span> <span class=\"s2\">\"text/fhirpath\"</span><span class=\"p\">,</span>\n                                <span class=\"nt\">\"expression\"</span><span class=\"p\">:</span> <span class=\"s2\">\"item.where(linkId='first-subquestion').count()\"</span>\n                            <span class=\"p\">}</span>\n                        <span class=\"p\">}</span>\n                    <span class=\"p\">],</span>\n                    <span class=\"nt\">\"item\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n                        <span class=\"p\">{</span>\n                            <span class=\"nt\">\"type\"</span><span class=\"p\">:</span> <span class=\"s2\">\"text\"</span><span class=\"p\">,</span>\n                            <span class=\"nt\">\"text\"</span><span class=\"p\">:</span> <span class=\"s2\">\"First subquestion\"</span><span class=\"p\">,</span>\n                            <span class=\"nt\">\"linkId\"</span><span class=\"p\">:</span> <span class=\"s2\">\"first-subquestion\"</span>\n                        <span class=\"p\">},</span>\n                        <span class=\"p\">{</span>\n                            <span class=\"nt\">\"type\"</span><span class=\"p\">:</span> <span class=\"s2\">\"string\"</span><span class=\"p\">,</span>\n                            <span class=\"nt\">\"linkId\"</span><span class=\"p\">:</span> <span class=\"s2\">\"second-subquestion\"</span><span class=\"p\">,</span>\n                            <span class=\"nt\">\"text\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Second subquestion\"</span><span class=\"p\">,</span>\n                            <span class=\"nt\">\"readonly\"</span><span class=\"p\">:</span> <span class=\"kc\">true</span><span class=\"p\">,</span>\n                            <span class=\"nt\">\"extension\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n                                <span class=\"p\">{</span>\n                                    <span class=\"nt\">\"url\"</span><span class=\"p\">:</span> <span class=\"s2\">\"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-calculatedExpression\"</span><span class=\"p\">,</span>\n                                    <span class=\"nt\">\"valueExpression\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n                                        <span class=\"nt\">\"language\"</span><span class=\"p\">:</span> <span class=\"s2\">\"text/fhirpath\"</span><span class=\"p\">,</span>\n                                        <span class=\"nt\">\"expression\"</span><span class=\"p\">:</span> <span class=\"s2\">\"%count\"</span>\n                                    <span class=\"p\">}</span>\n                                <span class=\"p\">}</span>\n                            <span class=\"p\">]</span>\n                        <span class=\"p\">}</span>\n                    <span class=\"p\">]</span>\n                <span class=\"p\">}</span>\n            <span class=\"p\">]</span>\n        <span class=\"p\">}</span>\n    <span class=\"p\">]</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 247689884,
        "sender_full_name": "Vadim Laletin",
        "timestamp": 1627640129
    },
    {
        "content": "<p>I think in <br>\n<span class=\"user-mention silent\" data-user-id=\"421492\">Vadim Laletin</span> <a href=\"#narrow/stream/179255-questionnaire/topic/EnableWhenExpression.20in.20repeatable.20group/near/247680461\">said</a>:</p>\n<blockquote>\n<p>What about %context value in repeatable questions with subquestions?<br>\nAre there any ideas what should be placed into %context in my example?<br>\nI assume it must be answer[i] for each answer for 'top-question' . But according to the spec, %context shall refer to QuestionnaireResponse.item (<a href=\"https://build.fhir.org/ig/HL7/sdc/expressions.html#fhirpath-and-questionnaire\">https://build.fhir.org/ig/HL7/sdc/expressions.html#fhirpath-and-questionnaire</a>)</p>\n</blockquote>\n<p>For items, %context is always the QuestionnaireResponse item.  Is there a problem with that?</p>",
        "id": 247710626,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1627653144
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"195344\">@Paul Lynch</span> In that case how it is possible to use first-question in caculatedExpression of the second-question for every top-question’s answer. %context will be set to QuestionnaireResponse.item that contains:</p>\n<div class=\"codehilite\"><pre><span></span><code>{\n    ”linkId”: ”top-question”,\n     ”answer”: […answer1, answer2, ….]\n}\n</code></pre></div>\n<p>Where answer1 and  answer2 are represented as:</p>\n<div class=\"codehilite\"><pre><span></span><code>{\n    ”value”: {…},\n     ”item”: [\n        {\n            ”linkId”: ”first-question”,\n            ”answer”: {…}\n        },\n        {\n            ”linkId”: ”second-question”,\n            ”answer”: {…}       // THIS answer should be calculated from first-question for every top-question.answer[i]\n        }\n    ]\n}\n</code></pre></div>",
        "id": 247714581,
        "sender_full_name": "Vadim Laletin",
        "timestamp": 1627654960
    },
    {
        "content": "<p>I see.  The problem is that the variable in the top-question group sees all of the answers for all of the repetitions, because the repetitions are under item.answer.item, and the top-question variable FHIRPath does not know which index is of interest (even if a separate copy of the variable could be created for each repetition).  I think your work around of nesting the sub-questions inside a sub-group and putting the variable on the sub-group is the only way to make that work.  Here is a complete form, without that workaround that demonstrates the issue in LHC-Forms (and can tried at <a href=\"https://lhcforms.nlm.nih.gov/lhcforms\">https://lhcforms.nlm.nih.gov/lhcforms</a>):</p>\n<div class=\"codehilite\"><pre><span></span><code>{\n  &quot;status&quot;: &quot;draft&quot;,\n  &quot;resourceType&quot;: &quot;Questionnaire&quot;,\n  &quot;meta&quot;: {\n    &quot;profile&quot;: [\n      &quot;http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire|2.7&quot;\n    ],\n    &quot;tag&quot;: [\n      {\n        &quot;code&quot;: &quot;lformsVersion: 29.1.2&quot;\n      }\n    ]\n  },\n  &quot;item&quot;: [\n    {\n      &quot;type&quot;: &quot;string&quot;,\n      &quot;required&quot;: false,\n      &quot;repeats&quot;: true,\n      &quot;linkId&quot;: &quot;topq&quot;,\n      &quot;text&quot;: &quot;topq&quot;,\n      &quot;extension&quot;: [\n        {\n          &quot;url&quot;: &quot;http://hl7.org/fhir/StructureDefinition/variable&quot;,\n          &quot;valueExpression&quot;: {\n            &quot;name&quot;: &quot;count&quot;,\n            &quot;language&quot;: &quot;text/fhirpath&quot;,\n            &quot;expression&quot;: &quot;answer.item.where(linkId=&#39;name&#39;).answer.count()&quot;\n          }\n        }\n      ],\n      &quot;item&quot;: [\n        {\n          &quot;type&quot;: &quot;string&quot;,\n          &quot;required&quot;: false,\n          &quot;repeats&quot;: true,\n          &quot;linkId&quot;: &quot;name&quot;,\n          &quot;text&quot;: &quot;name&quot;\n        },\n        {\n          &quot;type&quot;: &quot;string&quot;,\n          &quot;required&quot;: false,\n          &quot;repeats&quot;: true,\n          &quot;linkId&quot;: &quot;count of names&quot;,\n          &quot;text&quot;: &quot;count of names&quot;,\n          &quot;extension&quot;: [\n            {\n              &quot;url&quot;: &quot;http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-calculatedExpression&quot;,\n              &quot;valueExpression&quot;: {\n                &quot;language&quot;: &quot;text/fhirpath&quot;,\n                &quot;expression&quot;: &quot;%count&quot;\n              }\n            }\n          ]\n        }\n      ]\n    }\n  ]\n}\n</code></pre></div>",
        "id": 247721110,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1627657954
    }
]