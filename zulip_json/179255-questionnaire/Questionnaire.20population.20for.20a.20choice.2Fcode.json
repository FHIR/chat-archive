[
    {
        "content": "<p>I am trying to prepopulate a questionnaire using fhirpath expression to convert a string to a code, specifically populating a patient's gender.<br>\nIn the example on \"<a href=\"https://lhcforms.nlm.nih.gov/lforms-fhir-app/\">https://lhcforms.nlm.nih.gov/lforms-fhir-app/</a>\" for \"US Surgeon General family health portrait [54127-6]\" the resource Questionnaire has an initialExpression for Gender that uses %patient.gender, but this does not populate the questionnaire.<br>\nI found this post \"<a href=\"#narrow/stream/179266-fhirpath/topic/data.20extraction.20for.20Questionnaires\">https://chat.fhir.org/#narrow/stream/179266-fhirpath/topic/data.20extraction.20for.20Questionnaires</a>\" which is relevant but I was not able to find what was being discussed in the post in \"<a href=\"http://hl7.org/fhirpath/\">http://hl7.org/fhirpath/</a>\" or \"<a href=\"https://www.hl7.org/fhir/fhirpath.html\">https://www.hl7.org/fhir/fhirpath.html</a>\"<br>\nI found <code>%terminologies.subsumes(system, coded1, coded2, params) : code</code> but wasn't sure if that could be used for this purpose.<br>\nHow can I populate the questionnaire for choice types?</p>",
        "id": 241178292,
        "sender_full_name": "Corey Wen",
        "timestamp": 1622653323
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"195344\">@Paul Lynch</span></p>",
        "id": 241181413,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1622654761
    },
    {
        "content": "<p>Until <a href=\"http://jira.hl7.org/browse/FHIR-29324\">FHIR#29324</a> is addressed, there isn't a way to create a Coding.  However, if you have a Coding somewhere in the Questionnaire, you can use iif statements to pick the Coding you want and assign it via initialExpression.</p>",
        "id": 241297041,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1622657385
    },
    {
        "content": "<p>Example (with calculatedExpression setting a choice item): <a href=\"https://lforms-fhir.nlm.nih.gov/baseR4/Questionnaire/88121-9-x?_format=json\">https://lforms-fhir.nlm.nih.gov/baseR4/Questionnaire/88121-9-x?_format=json</a></p>",
        "id": 241298406,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1622657857
    },
    {
        "content": "<p>I tried following the example but wasn't able to get very far. I read the snippet about <a href=\"http://hl7.org/fhirpath/#iifcriterion-expression-true-result-collection-otherwise-result-collection-collection\">iif</a> but still am not sure if I'm following the syntax correctly.<br>\nI have the following under the extension for the choice for gender.</p>\n<div class=\"codehilite\"><pre><span></span><code>        {\n            &quot;type&quot;: &quot;choice&quot;,\n            &quot;code&quot;: [\n                {\n                    &quot;code&quot;: &quot;LL3324-2&quot;,\n                    &quot;display&quot;: &quot;Sex assigned at birth&quot;,\n                    &quot;system&quot;: &quot;http://loinc.org&quot;\n                }\n            ],\n            &quot;extension&quot;: [\n                {\n                    &quot;url&quot;: &quot;http://hl7.org/fhir/StructureDefinition/questionnaire-itemControl&quot;,\n                    &quot;valueCodeableConcept&quot;: {\n                        &quot;coding&quot;: [\n                            {\n                                &quot;system&quot;: &quot;http://hl7.org/fhir/questionnaire-item-control&quot;,\n                                &quot;code&quot;: &quot;drop-down&quot;,\n                                &quot;display&quot;: &quot;Drop down&quot;\n                            }\n                        ],\n                        &quot;text&quot;: &quot;Drop down&quot;\n                    }\n                },\n                {\n                    &quot;url&quot;: &quot;http://hl7.org/fhir/StructureDefinition/variable&quot;,\n                    &quot;valueExpression&quot;: {\n                        &quot;name&quot;: &quot;thisItem&quot;,\n                        &quot;language&quot;: &quot;text/fhirpath&quot;,\n                        &quot;expression&quot;: &quot;%questionnaire.item.where(linkId = &#39;/LL3324-2&#39;)&quot;\n                    }\n                },\n                {\n                    &quot;url&quot;: &quot;http://hl7.org/fhir/StructureDefinition/variable&quot;,\n                    &quot;valueExpression&quot;: {\n                        &quot;name&quot;: &quot;maleCoding&quot;,\n                        &quot;language&quot;: &quot;text/fhirpath&quot;,\n                        &quot;expression&quot;: &quot;%thisItem.answerOption.valueCoding.where(code=&#39;LA2-8&#39;)&quot;\n                    }\n                },\n                {\n                    &quot;url&quot;: &quot;http://hl7.org/fhir/StructureDefinition/variable&quot;,\n                    &quot;valueExpression&quot;: {\n                        &quot;name&quot;: &quot;femaleCoding&quot;,\n                        &quot;language&quot;: &quot;text/fhirpath&quot;,\n                        &quot;expression&quot;: &quot;%thisItem.answerOption.valueCoding.where(code=&#39;LA3-6&#39;)&quot;\n                    }\n                },\n                {\n                    &quot;url&quot;: &quot;http://hl7.org/fhir/StructureDefinition/questionnaire-calculatedExpression&quot;,\n                    &quot;valueExpression&quot;: {\n                        &quot;description&quot;: &quot;Birthsex from patient resource&quot;,\n                        &quot;language&quot;: &quot;text/fhirpath&quot;,\n                        &quot;expression&quot;: &quot;iif(%patient.gender=&#39;male&#39;, %maleCoding, %femaleCoding)&quot;\n                    }\n                }\n            ],\n            &quot;required&quot;: false,\n            &quot;linkId&quot;: &quot;/LL3324-2&quot;,\n            &quot;text&quot;: &quot;Sex assigned at birth&quot;,\n            &quot;answerOption&quot;: [\n                {\n                    &quot;valueCoding&quot;: {\n                        &quot;code&quot;: &quot;LA2-8&quot;,\n                        &quot;display&quot;: &quot;Male&quot;\n                    }\n                },\n                {\n                    &quot;valueCoding&quot;: {\n                        &quot;code&quot;: &quot;LA3-6&quot;,\n                        &quot;display&quot;: &quot;Female&quot;\n                    }\n                },\n                {\n                    &quot;valueCoding&quot;: {\n                        &quot;code&quot;: &quot;LA4489-6&quot;,\n                        &quot;display&quot;: &quot;Unknown&quot;\n                    }\n                }\n            ]\n        },\n</code></pre></div>",
        "id": 241451844,
        "sender_full_name": "Corey Wen",
        "timestamp": 1622753751
    },
    {
        "content": "<p>That looks good, as far as I can see.   Do you have \"patient\" defined from a launchContext extension somewhere?</p>",
        "id": 241470584,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1622763865
    },
    {
        "content": "<p>Yes, I have the following, however the field for gender is not being prepopulated and there are no error messages.</p>\n<p>Is the syntax for the comparison <code>\"$patient.gender = 'male' </code>and the syntax for the iif correct?<br>\n<code>iif(%patient.gender='male', %maleCoding, %femaleCoding)</code></p>\n<p>Also, is there a way to hardcode a initialExpression for a choice type? It may give me more insight.</p>\n<p>launchContext for Patient under extension</p>\n<div class=\"codehilite\"><pre><span></span><code>        {\n            &quot;url&quot;: &quot;http://hl7.org/fhir/StructureDefinition/questionnaire-launchContext&quot;,\n            &quot;extension&quot;: [\n                {\n                    &quot;url&quot;: &quot;name&quot;,\n                    &quot;valueId&quot;: &quot;patient&quot;\n                },\n                {\n                    &quot;url&quot;: &quot;type&quot;,\n                    &quot;valueCode&quot;: &quot;Patient&quot;\n                },\n                {\n                    &quot;url&quot;: &quot;descripton&quot;,\n                    &quot;valueString&quot;: &quot;For filling in patient information as the subject for the form&quot;\n                }\n            ]\n        }\n</code></pre></div>",
        "id": 241542928,
        "sender_full_name": "Corey Wen",
        "timestamp": 1622816760
    }
]