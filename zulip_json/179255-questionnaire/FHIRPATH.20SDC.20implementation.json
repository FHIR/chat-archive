[
    {
        "content": "<p>Is there a FHIRPath implementation which has a known good reference-quality implementation of the SDC add-ons - <code>answers()</code> in particular? I am trying to see whether I am interpreting the specification correctly, but the fhirpath.js implementation doesn't have <code>answers()</code> implemented and also fails on the equivalent from the spec <code>descendants().where($this is QuestionnaireResponse.item.answer.value)</code>.</p>",
        "id": 257816428,
        "sender_full_name": "Tilo Christ",
        "timestamp": 1634375440
    },
    {
        "content": "<p>Those functions were only exposed in the CI-build about a month ago, so quite possibly not.  <span class=\"user-mention\" data-user-id=\"191367\">@Brian Postlethwaite</span> <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span></p>",
        "id": 257841222,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1634399738
    },
    {
        "content": "<p>I haven't done it</p>",
        "id": 257855463,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634412988
    },
    {
        "content": "<p>I don't remember the answers() function, but can take a look at it.<br>\nWhat context are you running that expression?<br>\nI've found the fhirpathjs one to be quite good.<br>\nAnd the dotnet one is also very good (I'm using both of them, and have extended the dotnet one recently too)</p>",
        "id": 257862587,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1634419510
    },
    {
        "content": "<p>I am trying to get the PHQ9 scoring example to work: <a href=\"https://github.com/HL7/sdc/blob/master/input/examples/questionnaire-sdc-profile-example-PHQ9.json\">https://github.com/HL7/sdc/blob/master/input/examples/questionnaire-sdc-profile-example-PHQ9.json</a> - the expression <code>%resource.answers().value.ordinal().sum()</code>. I'm trying to implement the answers() function in terms of the descendants() function which again is short-hand for repeat(children()). I'm seeing wildly different results for the same expressions in different FHIRPath implementations (repeat(children()) on the same QuestionnaireResponse resource returning 58, 75, and 78 items on three different implementations). Hence my hope for a reference implementation that I can reliably compare against.</p>",
        "id": 257865517,
        "sender_full_name": "Tilo Christ",
        "timestamp": 1634422282
    },
    {
        "content": "<p>.sum()?</p>",
        "id": 257873654,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1634430669
    },
    {
        "content": "<p>I'm actually working in this specific implementation right now too.</p>",
        "id": 257873669,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1634430696
    },
    {
        "content": "<p>That query you're looking at I'd be more likely to do something like this<br>\n<code>%resource.item.where(linkId='groupofqs').item.answer.value.aggregate($this+$total,0)</code></p>",
        "id": 257873824,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1634430844
    },
    {
        "content": "<p>At the moment my implementation will be specifying the link ids explicitly that it will be summing so that the change detection can be marked.</p>",
        "id": 257873887,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1634430942
    },
    {
        "content": "<p>Also, there isn't a great ordinal() implementation too, so instead I'm summing the extension in the coded answer.<br>\n<code>answer.value.extension('...ordinal').value.aggregate</code></p>",
        "id": 257873975,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1634431044
    },
    {
        "content": "<p>(and put the full extension name in there)</p>",
        "id": 257873991,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1634431067
    },
    {
        "content": "<p>I am trying to evaluate this expression  \"patient.name.where(use='official').family()\" using FhirPathEngine and I am getting the following error,<br>\n org.hl7.fhir.r4.utils.FHIRLexer$FHIRLexerException: Error in ?? at 1, 1: The name family is not a valid function name<br>\n        at org.hl7.fhir.r4.utils.FHIRLexer.error(FHIRLexer.java:145)<br>\n        at org.hl7.fhir.r4.utils.FHIRLexer.error(FHIRLexer.java:141)<br>\n        at org.hl7.fhir.r4.utils.FHIRPathEngine.parseExpression(FHIRPathEngine.java:873)<br>\n        at org.hl7.fhir.r4.utils.FHIRPathEngine.parseExpression(FHIRPathEngine.java:907)<br>\n        at org.hl7.fhir.r4.utils.FHIRPathEngine.parseExpression(FHIRPathEngine.java:907)<br>\n        at org.hl7.fhir.r4.utils.FHIRPathEngine.parseExpression(FHIRPathEngine.java:907)<br>\n        at org.hl7.fhir.r4.utils.FHIRPathEngine.parse(FHIRPathEngine.java:338)<br>\n        at org.hl7.fhir.r4.utils.FHIRPathEngine.parse(FHIRPathEngine.java:331)<br>\n        at org.hl7.fhir.r4.utils.FHIRPathEngine.evaluate(FHIRPathEngine.java:520)<br>\nIt seems like FHIRLexer does not support 'where' and functions call.  Am I doing something wrong here or there's a missing support of mentioned operations.</p>",
        "id": 275235932,
        "sender_full_name": "Raazia Tariq",
        "timestamp": 1647264954
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"471025\">Raazia Tariq</span> has marked this topic as resolved.</p>",
        "id": 275236000,
        "sender_full_name": "Notification Bot",
        "timestamp": 1647264973
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"471025\">Raazia Tariq</span> has marked this topic as unresolved.</p>",
        "id": 275236007,
        "sender_full_name": "Notification Bot",
        "timestamp": 1647264975
    },
    {
        "content": "<p>I think it's complaining that family() is not a function.  Try removing the ().  Also, if the context you are running the expression against is a Patient resource, then \"Patient\" should be capitalized in the expression.</p>",
        "id": 275241514,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1647267383
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"195344\">Paul Lynch</span> <a href=\"#narrow/stream/179255-questionnaire/topic/FHIRPATH.20SDC.20implementation/near/275241514\">said</a>:</p>\n<blockquote>\n<p>I think it's complaining that family() is not a function.  Try removing the ().  Also, if the context you are running the expression against is a Patient resource, then \"Patient\" should be capitalized in the expression.</p>\n</blockquote>\n<p>Thanks Paul, I did your suggested changes and it works fine now.</p>",
        "id": 275248248,
        "sender_full_name": "Raazia Tariq",
        "timestamp": 1647270178
    },
    {
        "content": "<p>I want to know about that either FHIRPath supports variables to evaluate an expression or not?</p>\n<p>For example, we have a weight variable with the expression given below</p>\n<div class=\"codehilite\"><pre><span></span><code>{\n      &quot;url&quot;: &quot;http://hl7.org/fhir/StructureDefinition/variable&quot;,\n      &quot;valueExpression&quot;: {\n        &quot;name&quot;: &quot;weight&quot;,\n        &quot;language&quot;: &quot;text/fhirpath&quot;,\n        &quot;expression&quot;: &quot;%resource.repeat(item).where(linkId=&#39;3.3.1&#39;).item.answer.valueDecimal&quot;\n      }\n}\n</code></pre></div>\n<p>And first, we evaluate the value of this expression using the FHIRPath evaluate method, and then we want to use this variable value in the calculation of BMI given below,<br>\nYou can see that %weight is used as a variable, so do we have any such capability in FHIRPath to pass these variables(weight and height here) as input to evaluate this given expression <code>(%weight/(%height.power(2))).round(1)</code>?</p>\n<div class=\"codehilite\"><pre><span></span><code>{\n              &quot;url&quot;: &quot;http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-calculatedExpression&quot;,\n              &quot;valueExpression&quot;: {\n                &quot;description&quot;: &quot;BMI Calculation&quot;,\n                &quot;language&quot;: &quot;text/fhirpath&quot;,\n                &quot;expression&quot;: &quot;(%weight/(%height.power(2))).round(1)&quot;\n              }\n }\n</code></pre></div>",
        "id": 276058530,
        "sender_full_name": "Shoaib Mushtaq",
        "timestamp": 1647873033
    },
    {
        "content": "<p>So long as the variables are declared on the root of the Questionnaire or on an item that's an ancestor of the item that uses the calculatedExpression, yes that should work.</p>",
        "id": 276069745,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1647877062
    },
    {
        "content": "<p>And several implementations support it, including the lhc forms</p>",
        "id": 276098076,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1647888757
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191367\">Brian Postlethwaite</span> <a href=\"#narrow/stream/179255-questionnaire/topic/FHIRPATH.20SDC.20implementation/near/276098076\">said</a>:</p>\n<blockquote>\n<p>And several implementations support it, including the lhc forms</p>\n</blockquote>\n<p>Thanks <span class=\"user-mention\" data-user-id=\"191367\">@Brian Postlethwaite</span> for it. <br>\nCan you please mention some other implementations as well that support this other than LHC forms? Thanks</p>",
        "id": 276148456,
        "sender_full_name": "Shoaib Mushtaq",
        "timestamp": 1647931070
    },
    {
        "content": "<p>The 2 others I k ow of aren't open source at this stage.<br>\nAnd there are a few out of Europe too, however not sure if they do expression.</p>",
        "id": 276148537,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1647931140
    },
    {
        "content": "<p>public boolean evaluateToBoolean(Resource focusResource, Resource rootResource, Base base, String path) throws FHIRException {<br>\n    return convertToBoolean(evaluate(null, focusResource, rootResource, base, path));<br>\n  } <br>\nDoes anyone know what focusResource and rootResource are in this method? It is a FhirPathEngine method.<br>\nActually I want to use this method to evaluate enableWhenExpression (<a href=\"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-enableWhenExpression\">http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-enableWhenExpression</a>).</p>",
        "id": 276519735,
        "sender_full_name": "Raazia Tariq",
        "timestamp": 1648146115
    },
    {
        "content": "<p>focusResource is the resource you're dealing with and rootResource is typically the same, though if you're dealing with stuff in Bundles or Parameters or other resources that can contain other resources, it'll be the outermost resource for the instance.  See here: <a href=\"https://hl7.org/fhir/fhirpath.html#variables\">https://hl7.org/fhir/fhirpath.html#variables</a></p>",
        "id": 276527049,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1648149519
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191320\">Lloyd McKenzie</span> <a href=\"#narrow/stream/179255-questionnaire/topic/FHIRPATH.20SDC.20implementation/near/276527049\">said</a>:</p>\n<blockquote>\n<p>focusResource is the resource you're dealing with and rootResource is typically the same, though if you're dealing with stuff in Bundles or Parameters or other resources that can contain other resources, it'll be the outermost resource for the instance.  See here: <a href=\"https://hl7.org/fhir/fhirpath.html#variables\">https://hl7.org/fhir/fhirpath.html#variables</a></p>\n</blockquote>\n<p>Currently, I could have multiple resources or a single resource, so If I have a single resource I'll pass the same resource to all of the parameters. and if I have multiple resources I first need determine the context of each resource in the expression. Is this statement correct?</p>",
        "id": 276538645,
        "sender_full_name": "Raazia Tariq",
        "timestamp": 1648155561
    },
    {
        "content": "<p>Pretty much.  %rootResource isn't so much about \"multiple resources\" as specifically about resources that nest within other resources.</p>",
        "id": 276564417,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1648174914
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"398650\">@Shoaib Mushtaq</span> I have a library that can handle expressions written in CQL, which is similar to FHIRPath.</p>",
        "id": 276612072,
        "sender_full_name": "David Winters",
        "timestamp": 1648211812
    },
    {
        "content": "<p>I don't think it would be too hard to add support for FHIRPath.</p>",
        "id": 276612365,
        "sender_full_name": "David Winters",
        "timestamp": 1648211953
    },
    {
        "content": "<p>My European implementation supports it. Although it has a Japanese name and a FHIRPath of American ancestry. <br>\n<a href=\"https://legentix.com/faidashu/#/\">https://legentix.com/faidashu/#/</a><br>\n<a href=\"https://github.com/tiloc/faiadashu\">https://github.com/tiloc/faiadashu</a></p>\n<p><span class=\"user-mention silent\" data-user-id=\"191367\">Brian Postlethwaite</span> <a href=\"#narrow/stream/179255-questionnaire/topic/FHIRPATH.20SDC.20implementation/near/276148537\">said</a>:</p>\n<blockquote>\n<p>The 2 others I k ow of aren't open source at this stage.<br>\nAnd there are a few out of Europe too, however not sure if they do expression.</p>\n</blockquote>",
        "id": 276657318,
        "sender_full_name": "Tilo Christ",
        "timestamp": 1648231253
    },
    {
        "content": "<p>Is there a way to pass <a href=\"http://build.fhir.org/ig/HL7/sdc/expressions.html#variable\">variable/list of variables</a> with its/their values to fhirPath evaluate method with the expression having variables in it?</p>\n<p>For example, the expression is <code>\"expression\": \"%X + 2\",</code> in this <a href=\"https://github.com/lhncbc/lforms/blob/bec2dac9f5a930c546bf5050efe33aff1c35c4b2/src/test-data/e2e/R4/variable-scope-test.json\">questionnaire</a>. So can we pass the value of %X variable as parameter to evaluate method? is it supported or any other way to cater it?<br>\nP.S, I am using fhirPathEngine on Android to evaluate these expressions in the questionnaires.<br>\nThanks<br>\n<span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span>   cc: <span class=\"user-mention\" data-user-id=\"366686\">@Jing Tang</span></p>",
        "id": 278052513,
        "sender_full_name": "Shoaib Mushtaq",
        "timestamp": 1649263515
    },
    {
        "content": "<p>Within a Questionnaire, there are several extensions that allow defining variables, including 'variable' and 'launchParameter'.  All the expression names that are 'in context' of another expression are available for reference.  Take a look at this page in SDC: <a href=\"http://build.fhir.org/ig/HL7/sdc/expressions.html\">http://build.fhir.org/ig/HL7/sdc/expressions.html</a></p>",
        "id": 278056842,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1649265446
    },
    {
        "content": "<p>\"in context\" means the variable is on the item or a parent of the item that contains the expression referring to it.</p>",
        "id": 278078481,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1649275416
    },
    {
        "content": "<p>Technically 'ancestor' rather than 'parent'.  And if it's on the item, it needs to be earlier in the list than the extension doing the reference.</p>",
        "id": 278082729,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1649277472
    },
    {
        "content": "<p>This is an example of a BMI form that has some variables in it.<br>\n<a href=\"http://sqlonfhir-r4.azurewebsites.net/fhir/Questionnaire/55418-8-x/_history/13?_format=html\">http://sqlonfhir-r4.azurewebsites.net/fhir/Questionnaire/55418-8-x/_history/13?_format=html</a></p>",
        "id": 278083253,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1649277748
    }
]