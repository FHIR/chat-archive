[
    {
        "content": "<p>I'd like use   asynchronous messaging  to implement offline communication  between Patient and Practitioner.<br>\n Solution is based on concept described bellow:<br>\n3.4.4.1 Asynchronous Messaging using the RESTful API <br>\nIt is possible to exchange messages using the RESTful end-point as a central point of exchange. This is not particularly efficient compared to other methods, but is useful for low-volume asynchronous exchange.</p>\n<p>To send a message, a sender posts the message bundle to the /Bundle end-point, with a uri that identifies the receiver at MessageHeader.destination.endpoint. The RESTful server accepts the bundle, stores it as a single bundle, and indexes it on the MessageHeader.</p>\n<p>To receive messages, a receiver searches for all messages destined for itself, since its last check:</p>\n<p>GET [base]/Bundle?message.destination-uri=[rcv]&amp;_lastUpdated=&gt;2015-03-01T02:00:02+01:00<br>\nThe receiver works through the response, processing each message. As each message is processed, the receiver creates a response message, reversing the source and destination, and posts it back to the server.</p>\n<p>To check for responses, the original sender searches for response messages destined for itself, since its last check:</p>\n<p>GET [base]/Bundle?message.destination-uri=[snd]&amp;message.response-id:missing=false<br>\n      &amp;_lastUpdated=&gt;2015-03-03T06:03:522+01:00<br>\nThis lightweight protocol needs ongoing administration to ensure that multiple parties do not interfere with each other by re-using the same system identifier (and against malicious attack).</p>\n<p>I post Bundle  :<br>\n{<br>\n    \"resourceType\": \"Bundle\",<br>\n    \"id\": \"19203\",<br>\n    \"meta\": {<br>\n        \"versionId\": \"1\",<br>\n        \"lastUpdated\": \"2018-08-13T08:25:12.840+02:00\"<br>\n    },<br>\n    \"type\": \"message\",<br>\n    \"entry\": [<br>\n        {<br>\n            \"fullUrl\": \"<a href=\"http://localhost:9182/MessageHeader/19003\" target=\"_blank\" title=\"http://localhost:9182/MessageHeader/19003\">http://localhost:9182/MessageHeader/19003</a>\",<br>\n            \"resource\": {<br>\n                \"resourceType\": \"MessageHeader\",<br>\n                \"id\": \"19003\",<br>\n                \"event\": {<br>\n                    \"system\": \"<a href=\"http://example.org/fhir/message-events\" target=\"_blank\" title=\"http://example.org/fhir/message-events\">http://example.org/fhir/message-events</a>\",<br>\n                    \"code\": \"diagnosticreport-provide\"<br>\n                },<br>\n                \"destination\": [<br>\n                    {<br>\n                        \"endpoint\": \"<a href=\"https://vps.mymedic.com.pl/fhir/Practitioner/debb3012-01e7-4f57-afd6-95883c1f8f54\" target=\"_blank\" title=\"https://vps.mymedic.com.pl/fhir/Practitioner/debb3012-01e7-4f57-afd6-95883c1f8f54\">https://vps.mymedic.com.pl/fhir/Practitioner/debb3012-01e7-4f57-afd6-95883c1f8f54</a>\"<br>\n                    }<br>\n                ],<br>\n                \"timestamp\": \"2018-08-10T11:15:33+10:00\",<br>\n                \"source\": {<br>\n                    \"name\": \"Władysław Węglarz\",<br>\n                    \"contact\": {<br>\n                        \"system\": \"email\",<br>\n                        \"value\": \"<a href=\"mailto:wladyslaw.weglarz@telemedis.pl\" title=\"mailto:wladyslaw.weglarz@telemedis.pl\">wladyslaw.weglarz@telemedis.pl</a>\",<br>\n                        \"use\": \"home\"<br>\n                    },<br>\n                    \"endpoint\": \"<a href=\"https://vps.mymedic.com.pl/Patient/d9df0576-ad4c-4a82-bfa7-993cb3420d8a\" target=\"_blank\" title=\"https://vps.mymedic.com.pl/Patient/d9df0576-ad4c-4a82-bfa7-993cb3420d8a\">https://vps.mymedic.com.pl/Patient/d9df0576-ad4c-4a82-bfa7-993cb3420d8a</a>\"<br>\n                },<br>\n                \"responsible\": {<br>\n                    \"reference\": \"<a href=\"https://vps.mymedic.com.pl/fhir/Practitioner/debb3012-01e7-4f57-afd6-95883c1f8f54\" target=\"_blank\" title=\"https://vps.mymedic.com.pl/fhir/Practitioner/debb3012-01e7-4f57-afd6-95883c1f8f54\">https://vps.mymedic.com.pl/fhir/Practitioner/debb3012-01e7-4f57-afd6-95883c1f8f54</a>\"<br>\n                },<br>\n                \"reason\": {<br>\n                    \"coding\": [<br>\n                        {<br>\n                            \"system\": \"<a href=\"https://vps.mymedic.com.pl/fhir/ValueSet/kategoriaSerwisu\" target=\"_blank\" title=\"https://vps.mymedic.com.pl/fhir/ValueSet/kategoriaSerwisu\">https://vps.mymedic.com.pl/fhir/ValueSet/kategoriaSerwisu</a>\",<br>\n                            \"code\": \"2\",<br>\n                            \"display\": \"e-Porada\"<br>\n                        }<br>\n                    ]<br>\n                }<br>\n            }<br>\n        },<br>\n        {<br>\n            \"fullUrl\": \"<a href=\"http://localhost:9182/QuestionnaireResponse/19002\" target=\"_blank\" title=\"http://localhost:9182/QuestionnaireResponse/19002\">http://localhost:9182/QuestionnaireResponse/19002</a>\",<br>\n            \"resource\": {<br>\n                \"resourceType\": \"QuestionnaireResponse\",<br>\n                \"id\": \"19002\",<br>\n                \"status\": \"completed\",<br>\n                \"item\": [<br>\n                    {<br>\n                        \"linkId\": \"3\",<br>\n                        \"text\": \"Temat wiadomości:\",<br>\n                        \"answer\": [<br>\n                            {<br>\n                                \"valueString\": \"Temat wiadomosci\"<br>\n                            }<br>\n                        ]<br>\n                    },<br>\n                    {<br>\n                        \"linkId\": \"4\",<br>\n                        \"text\": \"Treść wiadomości:\",<br>\n                        \"answer\": [<br>\n                            {<br>\n                                \"valueString\": \"tresc wiadomosci\"<br>\n                            }<br>\n                        ]<br>\n                    },<br>\n                    {<br>\n                        \"linkId\": \"7\",<br>\n                        \"text\": \"Załączniki:\",<br>\n                        \"item\": [<br>\n                            {<br>\n                                \"linkId\": \"7.1\",<br>\n                                \"text\": \"WEB MyMedic-React (Nowa Rehabilitacja).postman_collection.json\",<br>\n                                \"answer\": [<br>\n                                    {<br>\n                                        \"valueString\": \"<a href=\"http://localhost:8089/upload/16835\" target=\"_blank\" title=\"http://localhost:8089/upload/16835\">http://localhost:8089/upload/16835</a>\"<br>\n                                    }<br>\n                                ]<br>\n                            },<br>\n                            {<br>\n                                \"linkId\": \"7.2\",<br>\n                                \"text\": \"foto.jpeg\",<br>\n                                \"answer\": [<br>\n                                    {<br>\n                                        \"valueString\": \"<a href=\"http://localhost:8089/upload/16833\" target=\"_blank\" title=\"http://localhost:8089/upload/16833\">http://localhost:8089/upload/16833</a>\"<br>\n                                    }<br>\n                                ]<br>\n                            },<br>\n                            {<br>\n                                \"linkId\": \"7.3\",<br>\n                                \"text\": \"foto.jpeg\",<br>\n                                \"answer\": [<br>\n                                    {<br>\n                                        \"valueString\": \"<a href=\"http://localhost:8089/upload/16834\" target=\"_blank\" title=\"http://localhost:8089/upload/16834\">http://localhost:8089/upload/16834</a>\"<br>\n                                    }<br>\n                                ]<br>\n                            }<br>\n                        ]<br>\n                    }<br>\n                ]<br>\n            }<br>\n        }<br>\n    ]<br>\n}</p>\n<p>Receiver can't  search  this  Bundle using  GET:<br>\n<a href=\"http://vps.mymedic.com.pl/fhir/Bundle/?message.destination-uri=https://vps.mymedic.com.pl/fhir/Practitioner/debb3012-01e7-4f57-afd6-95883c1f8f54\" target=\"_blank\" title=\"http://vps.mymedic.com.pl/fhir/Bundle/?message.destination-uri=https://vps.mymedic.com.pl/fhir/Practitioner/debb3012-01e7-4f57-afd6-95883c1f8f54\">vps.mymedic.com.pl/fhir/Bundle/?message.destination-uri=https://vps.mymedic.com.pl/fhir/Practitioner/debb3012-01e7-4f57-afd6-95883c1f8f54</a></p>\n<p>Server returns error:<br>\n\"diagnostics\": \"Don't know how to convert param type: URI\"</p>\n<p>The server is based on HAPI FHIR version 3.5.0 SNAPSHOT.</p>\n<p>And second problem when i  POST <br>\n<a href=\"http://vps.mymedic.com.pl/fhir/$process-message?async=true\" target=\"_blank\" title=\"http://vps.mymedic.com.pl/fhir/$process-message?async=true\">vps.mymedic.com.pl/fhir/$process-message?async=true</a></p>\n<p>I receive  :<br>\n\"diagnostics\": \"Invalid request: The FHIR endpoint on this server does not know how to handle POST operation[$process-message] with parameters [[async]]\"</p>\n<p>My question is \"HAPI FHIR versio 3.5.9 SNAPSHOT has'nt implementation  operation  $process-message  ?</p>\n<p>Please information from users HAPI FHIR</p>",
        "id": 153985709,
        "sender_full_name": "Władysław Węglarz",
        "timestamp": 1534152908
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span> ?</p>",
        "id": 153985790,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1534170039
    },
    {
        "content": "<p>Hi James<br>\nCould You help me in my problems with messaging in HAPI FHIR version 3.5.0 SNAPSHOT - please</p>",
        "id": 153985858,
        "sender_full_name": "Władysław Węglarz",
        "timestamp": 1534181589
    },
    {
        "content": "<p>The <code>$process-message</code> endpoint is an operation like any other operation. You can implement t using the standard <a href=\"http://hapifhir.io/doc_rest_operations.html#Extended_Operations\" target=\"_blank\" title=\"http://hapifhir.io/doc_rest_operations.html#Extended_Operations\">operation framework</a></p>",
        "id": 153985907,
        "sender_full_name": "James Agnew",
        "timestamp": 1534192339
    },
    {
        "content": "<p>Basically you're just implementing an operation on a IResourceProvider for the MessageHeader resource type with the name <code>process-message</code>.</p>",
        "id": 153985909,
        "sender_full_name": "James Agnew",
        "timestamp": 1534192380
    },
    {
        "content": "<p>HAPI FHIR doesn't come with this out of the box because you need to actually implement whatever processing logic you want to have, so you create the processor as a part of that. I've implemented a few message processors that work this way, it works quite nicely.</p>",
        "id": 153985910,
        "sender_full_name": "James Agnew",
        "timestamp": 1534192425
    },
    {
        "content": "<p>For the other problem, can you please provide a brief code snippet or unit test that demonstrates your issue? As brief a snippet as possible to show the issue would be helpful, ideally against a public server.</p>",
        "id": 153985912,
        "sender_full_name": "James Agnew",
        "timestamp": 1534192515
    },
    {
        "content": "<p>The message Bundle was POST to public server.<br>\n1. GET <a href=\"http://hapi.fhir.org/baseDstu3/Bundle/4737566\" target=\"_blank\" title=\"http://hapi.fhir.org/baseDstu3/Bundle/4737566\">http://hapi.fhir.org/baseDstu3/Bundle/4737566</a></p>\n<p>2. GET <a href=\"http://hapi.fhir.org/baseDstu3/Bundle?message.destination-uri=https://vps.mymedic.com.pl/fhir/Practitioner/debb3012-01e7-4f57-afd6-95883c1f8f54\" target=\"_blank\" title=\"http://hapi.fhir.org/baseDstu3/Bundle?message.destination-uri=https://vps.mymedic.com.pl/fhir/Practitioner/debb3012-01e7-4f57-afd6-95883c1f8f54\">http://hapi.fhir.org/baseDstu3/Bundle?message.destination-uri=https://vps.mymedic.com.pl/fhir/Practitioner/debb3012-01e7-4f57-afd6-95883c1f8f54</a></p>\n<p>the result is:<br>\n{<br>\n    \"resourceType\": \"OperationOutcome\",<br>\n    \"text\": {<br>\n        \"status\": \"generated\",<br>\n        \"div\": \"&lt;div xmlns=\\\"http://www.w3.org/1999/xhtml\\\"&gt;&lt;h1&gt;Operation Outcome&lt;/h1&gt;&lt;table border=\\\"0\\\"&gt;&lt;tr&gt;&lt;td style=\\\"font-weight: bold;\\\"&gt;ERROR&lt;/td&gt;&lt;td&gt;[]&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Don't know how to convert param type: URI&lt;/pre&gt;&lt;/td&gt;\\n\\t\\t\\t\\t\\t\\n\\t\\t\\t\\t\\n\\t\\t\\t&lt;/tr&gt;\\n\\t\\t&lt;/table&gt;\\n\\t&lt;/div&gt;\"<br>\n    },<br>\n    \"issue\": [<br>\n        {<br>\n            \"severity\": \"error\",<br>\n            \"code\": \"processing\",<br>\n            \"diagnostics\": \"Don't know how to convert param type: URI\"<br>\n        }<br>\n    ]<br>\n}</p>\n<p>The same wrong as on my server ?</p>",
        "id": 153985926,
        "sender_full_name": "Władysław Węglarz",
        "timestamp": 1534194522
    },
    {
        "content": "<p>on my server information about this error is the following:<br>\n2018-08-13 19:20:02.002 INFO  ca.uhn.fhir.context.FhirContext Creating new FHIR context for FHIR version [DSTU3]<br>\n2018-08-13 19:20:02.078 INFO  c.u.f.n.BaseThymeleafNarrativeGenerator Initializing narrative generator<br>\n2018-08-13 19:20:52.553 INFO  c.u.f.j.s.SearchCoordinatorSvcImpl Search initial phase completed in 2ms<br>\n2018-08-13 19:20:52.611 ERROR c.u.f.j.s.SearchCoordinatorSvcImpl Failed during search loading after 57ms<br>\nca.uhn.fhir.rest.server.exceptions.InternalErrorException: Don't know how to convert param type: URI<br>\n    at ca.uhn.fhir.jpa.dao.SearchBuilder.toParameterType(SearchBuilder.java:2017)<br>\n    at ca.uhn.fhir.jpa.dao.SearchBuilder.toParameterType(SearchBuilder.java:2023)<br>\n    at ca.uhn.fhir.jpa.dao.SearchBuilder.addPredicateReference(SearchBuilder.java:501)<br>\n    at ca.uhn.fhir.jpa.dao.SearchBuilder.searchForIdsWithAndOr(SearchBuilder.java:1931)<br>\n    at ca.uhn.fhir.jpa.dao.SearchBuilder.searchForIdsWithAndOr(SearchBuilder.java:1858)<br>\n    at ca.uhn.fhir.jpa.dao.SearchBuilder.createQuery(SearchBuilder.java:1389)<br>\n    at ca.uhn.fhir.jpa.dao.SearchBuilder.access$700(SearchBuilder.java:87)<br>\n    at ca.uhn.fhir.jpa.dao.SearchBuilder$QueryIterator.fetchNext(SearchBuilder.java:2238)<br>\n    at ca.uhn.fhir.jpa.dao.SearchBuilder$QueryIterator.hasNext(SearchBuilder.java:2310)<br>\n    at ca.uhn.fhir.jpa.search.SearchCoordinatorSvcImpl$SearchTask.doSearch(SearchCoordinatorSvcImpl.java:594)<br>\n    at ca.uhn.fhir.jpa.search.SearchCoordinatorSvcImpl$SearchTask.access$700(SearchCoordinatorSvcImpl.java:459)<br>\n    at ca.uhn.fhir.jpa.search.SearchCoordinatorSvcImpl$SearchTask$1.doInTransactionWithoutResult(SearchCoordinatorSvcImpl.java:524)<br>\n    at org.springframework.transaction.support.TransactionCallbackWithoutResult.doInTransaction(TransactionCallbackWithoutResult.java:36)<br>\n    at org.springframework.transaction.support.TransactionTemplate.execute(TransactionTemplate.java:140)<br>\n    at ca.uhn.fhir.jpa.search.SearchCoordinatorSvcImpl$SearchTask.call(SearchCoordinatorSvcImpl.java:521)<br>\n    at ca.uhn.fhir.jpa.search.SearchCoordinatorSvcImpl$SearchTask.call(SearchCoordinatorSvcImpl.java:459)<br>\n    at java.util.concurrent.FutureTask.run(FutureTask.java:266)<br>\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)<br>\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)<br>\n    at java.lang.Thread.run(Thread.java:748)<br>\n2018-08-13 19:20:52.628 ERROR c.u.f.r.s.i.ExceptionHandlingInterceptor Failure during REST processing<br>\nca.uhn.fhir.rest.server.exceptions.InternalErrorException: Don't know how to convert param type: URI<br>\n    at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)<br>\n    at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)<br>\n    at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)<br>\n    at java.lang.reflect.Constructor.newInstance(Constructor.java:423)<br>\n    at ca.uhn.fhir.rest.server.exceptions.BaseServerResponseException.newInstance(BaseServerResponseException.java:301)<br>\n    at ca.uhn.fhir.jpa.search.SearchCoordinatorSvcImpl.verifySearchHasntFailedOrThrowInternalErrorException(SearchCoordinatorSvcImpl.java:442)<br>\n    at ca.uhn.fhir.jpa.search.PersistedJpaSearchFirstPageBundleProvider.size(PersistedJpaSearchFirstPageBundleProvider.java:84)<br>\n    at ca.uhn.fhir.rest.server.method.BaseResourceReturningMethodBinding.doInvokeServer(BaseResourceReturningMethodBinding.java:323)<br>\n    at ca.uhn.fhir.rest.server.method.BaseResourceReturningMethodBinding.invokeServer(BaseResourceReturningMethodBinding.java:379)<br>\n    at ca.uhn.fhir.rest.server.RestfulServer.handleRequest(RestfulServer.java:917)<br>\n    at ca.uhn.fhir.rest.server.RestfulServer.doGet(RestfulServer.java:331)<br>\n    at ca.uhn.fhir.rest.server.RestfulServer.service(RestfulServer.java:1485)<br>\n    at javax.servlet.http.HttpServlet.service(HttpServlet.java:790)<br>\n    at org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:865)<br>\n    at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:535)<br>\n    at org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:255)<br>\n    at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:1595)<br>\n    at org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:255)<br>\n    at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1253)<br>\n    at org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:203)<br>\n    at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:473)<br>\n    at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:1564)<br>\n    at org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:201)<br>\n    at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1155)<br>\n    at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:144)<br>\n    at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)<br>\n    at org.eclipse.jetty.server.Server.handle(Server.java:531)<br>\n    at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:352)<br>\n    at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:260)<br>\n    at org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:281)<br>\n    at org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:102)<br>\n    at org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:118)<br>\n    at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:333)<br>\n    at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:310)<br>\n    at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:168)<br>\n    at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:126)<br>\n    at org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:366)<br>\n    at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:760)<br>\n    at org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:678)<br>\n    at java.lang.Thread.run(Thread.java:748)</p>",
        "id": 153985927,
        "sender_full_name": "Władysław Węglarz",
        "timestamp": 1534194617
    },
    {
        "content": "<p>Hi James. Thanks for the explanation. Does the processors you have created as part of implementing $process-message available for reference?</p>",
        "id": 153995864,
        "sender_full_name": "Aditya Joshi",
        "timestamp": 1536693692
    }
]