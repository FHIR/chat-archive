[
    {
        "content": "<p>Hi all,<br>\ni'm trying to learn and play with the fhir mapping language. i'm using the resources in <br>\n<a href=\"https://www.hl7.org/fhir/mapping-tutorial.html\" target=\"_blank\" title=\"https://www.hl7.org/fhir/mapping-tutorial.html\">https://www.hl7.org/fhir/mapping-tutorial.html</a><br>\n<a href=\"https://wiki.hl7.org/index.php?title=Using_the_FHIR_Mapping_Language\" target=\"_blank\" title=\"https://wiki.hl7.org/index.php?title=Using_the_FHIR_Mapping_Language\">https://wiki.hl7.org/index.php?title=Using_the_FHIR_Mapping_Language</a><br>\n<a href=\"https://www.devdays.com/wp-content/uploads/2018/06/DD18-US-R4-Mapping-Language-Grahame-Grieve-2018-06-21.pdf\" target=\"_blank\" title=\"https://www.devdays.com/wp-content/uploads/2018/06/DD18-US-R4-Mapping-Language-Grahame-Grieve-2018-06-21.pdf\">https://www.devdays.com/wp-content/uploads/2018/06/DD18-US-R4-Mapping-Language-Grahame-Grieve-2018-06-21.pdf</a> and <br>\n<a href=\"https://github.com/ahdis/fhir-mapping-tutorial\" target=\"_blank\" title=\"https://github.com/ahdis/fhir-mapping-tutorial\">https://github.com/ahdis/fhir-mapping-tutorial</a></p>\n<p>i'm trying to use the command line jar to take in a source XML file, like in the tutorial example step 1, and convert it to the TRight format. i used implemented resource files for the TLeft and TRight structure defs and the map from the github link. I had to make some updates to the SDs and the map - it seems they were made for an older format? i noticed some differences between the hl7 documentation and the PDF / github. </p>\n<p>my current issue is that i'm running into an inevitable NPE when trying to use version 3.0 or 4.0:<br>\nlines 844 or 855 of the <code>ValidatorEngine</code> (3.0 / 4.0 respectively) are </p>\n<div class=\"codehilite\"><pre><span></span>        res = new org.hl7.fhir.dstu3.utils.StructureMapUtilities(null).parse(new String(content));\n        res = new org.hl7.fhir.r4.utils.StructureMapUtilities(null).parse(new String(content), fn);\n</pre></div>\n\n\n<p>then later in the StructureMapUtilities constructor, it attempts to call a method on the null and it throws an NPE.<br>\nI noticed that the current version if statement uses different parse logic:</p>\n<div class=\"codehilite\"><pre><span></span>        r = new StructureMapUtilities(context, null, null).parse(TextFile.bytesToString(content), fn);\n</pre></div>\n\n\n<p>however, i can't figure out how to get into that if-block, since it checks for equality to <code>4.1</code> but the version variable is always set to <code>\"current\"</code> at that point. </p>\n<p>any assistance or add'l resources would be super helpful!</p>",
        "id": 184473174,
        "sender_full_name": "Harrison Tarr",
        "timestamp": 1577713264
    },
    {
        "content": "<p><a href=\"/user_uploads/10155/xsMyK8XxIl8qWp-HdYaJKVK4/structuredefinition-tright.xml\" target=\"_blank\" title=\"structuredefinition-tright.xml\">structuredefinition-tright.xml</a> <a href=\"/user_uploads/10155/6inDIelDKoDBk2yGPKmZyrd0/structuredefinition-tleft.xml\" target=\"_blank\" title=\"structuredefinition-tleft.xml\">structuredefinition-tleft.xml</a> <a href=\"/user_uploads/10155/gJgb5tvsxybbur8_iM-XLuye/step1.map\" target=\"_blank\" title=\"step1.map\">step1.map</a> </p>\n<p>i've attached my edited versions of the structure documents and map</p>",
        "id": 184473354,
        "sender_full_name": "Harrison Tarr",
        "timestamp": 1577713437
    },
    {
        "content": "<p>Hi Harrison - take a look at <a href=\"https://fhirblog.com/2019/12/20/making-a-transaction-bundle-using-the-mapping-language/\" target=\"_blank\" title=\"https://fhirblog.com/2019/12/20/making-a-transaction-bundle-using-the-mapping-language/\">https://fhirblog.com/2019/12/20/making-a-transaction-bundle-using-the-mapping-language/</a> and the prior post it references. That might help you (I'm learning too :) )</p>",
        "id": 184533946,
        "sender_full_name": "David Hay",
        "timestamp": 1577783995
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span></p>",
        "id": 184739209,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1578063276
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"246988\">@Harrison Tarr</span> : the ahdis repo you were referring to was based on STU3, the maps and structuredefinitions have been now updated to R4, thanks for your  notice. To use the maps with the java validator you need currently a patched version <a href=\"https://github.com/ahdis/org.hl7.fhir.core/releases/download/4.1.38-dev/org.hl7.fhir.validation.cli-4.1.38-SNAPSHOT.jar\" target=\"_blank\" title=\"https://github.com/ahdis/org.hl7.fhir.core/releases/download/4.1.38-dev/org.hl7.fhir.validation.cli-4.1.38-SNAPSHOT.jar\">https://github.com/ahdis/org.hl7.fhir.core/releases/download/4.1.38-dev/org.hl7.fhir.validation.cli-4.1.38-SNAPSHOT.jar</a>, otherwise the maps cannot be loaded, I need to provide a pull reqeuest for this.</p>",
        "id": 184863578,
        "sender_full_name": "Oliver Egger",
        "timestamp": 1578256413
    },
    {
        "content": "<p>The validator uses the r5.StructureMapUtilities, how you do end up in dstu3 or r4 NPE's?</p>",
        "id": 184863712,
        "sender_full_name": "Oliver Egger",
        "timestamp": 1578256614
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191478\">@Oliver Egger</span> <br>\nwhen i run it with the jar you provided, i get this output:</p>\n<div class=\"codehilite\"><pre><span></span> .. FHIR Version current, definitions from hl7.fhir.r5.core#current\n  .. connect to tx server @ http://tx.fhir.org\n    (vcurrent)\n+  .. load IG from /Users/harrison/projects/helios/fhir-mapping-tutorial/maptutorial/step1/logical/\n* load file: structuredefinition-tright.xml - ignored due to error: Unsupported version current\n* load file: structuredefinition-tleft.xml - ignored due to error: Unsupported version current\n+  .. load IG from /Users/harrison/projects/helios/fhir-mapping-tutorial/maptutorial/step1/map/step1.map\n* load file: /Users/harrison/projects/helios/fhir-mapping-tutorial/maptutorial/step1/map/step1.map - ignored due to error: Unsupported version current\n ...Failure: This does not appear to be a FHIR resource (unknown namespace/name &#39;http://hl7.org/fhir/tutorial::TLeft&#39;) at line 0 col 0\norg.hl7.fhir.exceptions.FHIRFormatError: This does not appear to be a FHIR resource (unknown namespace/name &#39;http://hl7.org/fhir/tutorial::TLeft&#39;) at line 0 col 0\n    at org.hl7.fhir.r5.elementmodel.ParserBase.logError(ParserBase.java:88)\n    at org.hl7.fhir.r5.elementmodel.ParserBase.getDefinition(ParserBase.java:110)\n    at org.hl7.fhir.r5.elementmodel.XmlParser.parse(XmlParser.java:171)\n    at org.hl7.fhir.r5.elementmodel.XmlParser.parse(XmlParser.java:163)\n    at org.hl7.fhir.r5.elementmodel.XmlParser.parse(XmlParser.java:135)\n    at org.hl7.fhir.r5.elementmodel.Manager.parse(Manager.java:78)\n    at org.hl7.fhir.r5.validation.ValidationEngine.transform(ValidationEngine.java:1229)\n    at org.hl7.fhir.r5.validation.ValidationEngine.transform(ValidationEngine.java:1222)\n    at org.hl7.fhir.r5.validation.Validator.main(Validator.java:592)\n</pre></div>\n\n\n<p>i think that's caused by the second error i mentioned above, where it interprets the version as \"current\" but then tries to compare it to \"4.1\". this is still using the same SD and map file that i provided above</p>",
        "id": 185135407,
        "sender_full_name": "Harrison Tarr",
        "timestamp": 1578504150
    },
    {
        "content": "<p>please try with the updated structuredefintions and map in the repo, they had all to be adjusted.</p>",
        "id": 185140676,
        "sender_full_name": "Oliver Egger",
        "timestamp": 1578507436
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191478\">@Oliver Egger</span> fantastic! i just pulled and reran according to the instructions and step 1 worked! i see that according to the readme some of the following steps fail, is that because of missing support in the jar or something else? <br>\nin any case, thank you so much for your help!</p>",
        "id": 185151607,
        "sender_full_name": "Harrison Tarr",
        "timestamp": 1578514120
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"246988\">@Harrison Tarr</span>  glad that it works. some of the steps fail because the java mapping language implementation does not work with the map provided for the fhir tutorial. as i am also learning to work with the fhir mapping language I did not yet check if its an issued in the tutorial or in the fhir mapping language implementation, the jar is just the same as the validator, just a different branch with a few commits ahead and behind, see <a href=\"https://github.com/ahdis/org.hl7.fhir.core\" target=\"_blank\" title=\"https://github.com/ahdis/org.hl7.fhir.core\">https://github.com/ahdis/org.hl7.fhir.core</a></p>",
        "id": 185154526,
        "sender_full_name": "Oliver Egger",
        "timestamp": 1578516127
    }
]