[
    {
        "content": "<p>I've created an FML map based on </p>\n<p><a href=\"http://www.hl7.org/fhir/medicationrequest-version-maps.html#11.1.9.1\">http://www.hl7.org/fhir/medicationrequest-version-maps.html#11.1.9.1</a></p>\n<p>there are some changes, including a Reference group function added where I'd attempted to get the context transform working, and I also changed the copy operations as it was complaining about some of the simple src -&gt; tgt copy mappings.  The FML is</p>\n<div class=\"codehilite\"><pre><span></span><code>map &quot;http://hl7.org/fhir/StructureMap/MedicationRequest3to4&quot; = &quot;R3 to R4 Conversions for MedicationRequest&quot;\n\nuses &quot;http://hl7.org/fhir/3.0/StructureDefinition/MedicationRequest&quot; alias MedicationRequestR3 as source\nuses &quot;http://hl7.org/fhir/StructureDefinition/MedicationRequest&quot; alias MedicationRequest as target\nuses &quot;http://hl7.org/fhir/3.0/StructureDefinition/Reference&quot; alias ReferenceR3 as source\nuses &quot;http://hl7.org/fhir/StructureDefinition/Reference&quot; alias Reference as target\n\nimports &quot;http://hl7.org/fhir/StructureMap/*3to4&quot;\n\ngroup MedicationRequest(source src : MedicationRequestR3, target tgt : MedicationRequest) &lt;&lt;type+&gt;&gt; {\n  src.id as id -&gt; tgt.id = id;\n  src.text as text -&gt; tgt.text = text;\n  src.extension as ext -&gt; tgt.extension = ext;\n  src.identifier as identifier -&gt; tgt.identifier = identifier;\n  src.definition as definition -&gt; tgt.instantiatesCanonical = definition;\n  src.basedOn as basedOn -&gt; tgt.basedOn = basedOn;\n  src.groupIdentifier as groupIdentifier -&gt; tgt.groupIdentifier = groupIdentifier;\n  src.status as status -&gt; tgt.status = status;\n  src.intent as intent -&gt; tgt.intent = intent;\n  src.category as category -&gt; tgt.category = category;\n  src.priority as priority -&gt; tgt.priority = priority;\n  src.medication : CodeableConcept as vs -&gt; tgt.medication = create(&#39;CodeableConcept&#39;) as vt then CodeableConcept(vs, vt);\n  src.medication : Reference as vs -&gt; tgt.medication = create(&#39;Reference&#39;) as vt then Reference(vs, vt);\n  src.subject as subject -&gt; tgt.subject = subject;\n  //HERE - Seems to not copy over\n  src.context -&gt; tgt.encounter;\n    //src.context : Reference as value -&gt; tgt.encounter = value &quot;value&quot;;\n    //src.context : Reference as vs -&gt; tgt.encounter = create(&#39;Reference&#39;) as vt then Reference(vs, vt);\n    //src.context as context -&gt; tgt.context = context;\n    //src.context as context -&gt; tgt.encounter = context;\n  src.supportingInformation as supportingInformation -&gt; tgt.supportingInformation = supportingInformation;\n  src.authoredOn as authoredOn -&gt; tgt.authoredOn = authoredOn;\n  //HERE - Seems to not copy over\n  src.requester as vs0 then requester(vs0, tgt);\n  src.recorder as recorder -&gt; tgt.recorder = recorder;\n  src.reasonCode as reasonCode -&gt; tgt.reasonCode = reasonCode;\n  src.reasonReference as reasonReference -&gt; tgt.reasonReference = reasonReference;\n  src.note as note -&gt; tgt.note = note;\n  src.dosageInstruction as dosageInstruction -&gt; tgt.dosageInstruction = dosageInstruction;\n  src.dispenseRequest as vs0 -&gt; tgt.dispenseRequest as vt0 then dispense(vs0, vt0);\n  src.substitution as vs0 -&gt; tgt.substitution as vt0 then subst(vs0, vt0);\n  src.priorPrescription as priorPrescription -&gt; tgt.priorPrescription = priorPrescription;\n  src.detectedIssue as detectedIssue -&gt; tgt.detectedIssue = detectedIssue;\n  src.eventHistory as eventHistory -&gt; tgt.eventHistory = eventHistory;\n}\n\ngroup requester(source src, target tgt) {\n  src.agent -&gt; tgt.requester;\n  src.onBehalfOf as v -&gt;  tgt.extension as vt,  vt.url = &#39;http://hl7.org/fhir/3.0/StructureDefinition/extension-MedicationRequest.requester.onBehalfOf&#39;,  vt.value = v;\n}\n\ngroup dispense(source src, target tgt) {\n  src.validityPeriod -&gt; tgt.validityPeriod;\n  src.numberOfRepeatsAllowed -&gt; tgt.numberOfRepeatsAllowed;\n  src.quantity -&gt; tgt.quantity;\n  src.expectedSupplyDuration -&gt; tgt.expectedSupplyDuration;\n  src.performer -&gt; tgt.performer;\n}\n\ngroup subst(source src, target tgt) {\n  src.allowed as vs -&gt; tgt.allowed = create(&#39;boolean&#39;) as vt then boolean(vs, vt);\n  src.reason -&gt; tgt.reason;\n}\n\ngroup Reference(source src : ReferenceR3, target tgt : Reference) &lt;&lt;type+&gt;&gt; {\n  src.reference as reference -&gt; tgt.reference = reference;\n  src.identifier as identifier -&gt; tgt.identifier = identifier;\n  src.display as display -&gt; tgt.display = display;\n}\n</code></pre></div>\n<p>and the resource to convert is</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"p\">{</span>\n  <span class=\"nt\">\"resourceType\"</span><span class=\"p\">:</span> <span class=\"s2\">\"MedicationRequest\"</span><span class=\"p\">,</span>\n  <span class=\"nt\">\"id\"</span><span class=\"p\">:</span> <span class=\"s2\">\"123\"</span><span class=\"p\">,</span>\n  <span class=\"nt\">\"text\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n    <span class=\"nt\">\"status\"</span><span class=\"p\">:</span> <span class=\"s2\">\"generated\"</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"div\"</span><span class=\"p\">:</span> <span class=\"s2\">\"&lt;div xmlns=\\\"http://www.w3.org/1999/xhtml\\\"&gt;&lt;p&gt;&lt;b&gt;Generated Narrative with Details&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;id&lt;/b&gt;: 123&lt;/p&gt;&lt;p&gt;&lt;b&gt;identifier&lt;/b&gt;: 12345 (OFFICIAL)&lt;/p&gt;&lt;p&gt;&lt;b&gt;status&lt;/b&gt;: active&lt;/p&gt;&lt;p&gt;&lt;b&gt;intent&lt;/b&gt;: order&lt;/p&gt;&lt;p&gt;&lt;b&gt;medication&lt;/b&gt;: &lt;a&gt;prescribed medication&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;subject&lt;/b&gt;: &lt;a&gt;Donald Duck&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;context&lt;/b&gt;: &lt;a&gt;encounter that leads to this prescription&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;authoredOn&lt;/b&gt;: 01/03/2015&lt;/p&gt;&lt;h3&gt;Requesters&lt;/h3&gt;&lt;table&gt;&lt;tr&gt;&lt;td&gt;-&lt;/td&gt;&lt;td&gt;&lt;b&gt;Agent&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;b&gt;OnBehalfOf&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;*&lt;/td&gt;&lt;td&gt;&lt;a&gt;Patrick Pump&lt;/a&gt;&lt;/td&gt;&lt;td&gt;&lt;a&gt;Organization/f002&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;p&gt;&lt;b&gt;reasonCode&lt;/b&gt;: Essential hypertension (disorder) &lt;span&gt;(Details : {SNOMED CT code '59621000' = 'Essential hypertension', given as 'Essential hypertension (disorder)'})&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;dosageInstruction&lt;/b&gt;: &lt;/p&gt;&lt;/div&gt;\"</span>\n  <span class=\"p\">},</span>\n  <span class=\"nt\">\"extension\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n    <span class=\"p\">{</span>\n      <span class=\"nt\">\"url\"</span><span class=\"p\">:</span> <span class=\"s2\">\"http://hl7.org/fhir/3.0/StructureDefinition/extension-MedicationRequest.requester.onBehalfOf\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"valueReference\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n        <span class=\"nt\">\"reference\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Organization/f002\"</span>\n      <span class=\"p\">}</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">],</span>\n  <span class=\"nt\">\"identifier\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n    <span class=\"p\">{</span>\n      <span class=\"nt\">\"use\"</span><span class=\"p\">:</span> <span class=\"s2\">\"official\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"system\"</span><span class=\"p\">:</span> <span class=\"s2\">\"http://www.bmc.nl/portal/prescriptions\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"value\"</span><span class=\"p\">:</span> <span class=\"s2\">\"12345\"</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">],</span>\n  <span class=\"nt\">\"status\"</span><span class=\"p\">:</span> <span class=\"s2\">\"active\"</span><span class=\"p\">,</span>\n  <span class=\"nt\">\"intent\"</span><span class=\"p\">:</span> <span class=\"s2\">\"order\"</span><span class=\"p\">,</span>\n  <span class=\"nt\">\"medicationReference\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n    <span class=\"nt\">\"reference\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Medication/med0316\"</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"display\"</span><span class=\"p\">:</span> <span class=\"s2\">\"prescribed medication\"</span>\n  <span class=\"p\">},</span>\n  <span class=\"nt\">\"subject\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n    <span class=\"nt\">\"reference\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Patient/pat1\"</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"display\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Donald Duck\"</span>\n  <span class=\"p\">},</span>\n  <span class=\"nt\">\"context\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n    <span class=\"nt\">\"reference\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Encounter/f001\"</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"display\"</span><span class=\"p\">:</span> <span class=\"s2\">\"encounter that leads to this prescription\"</span>\n  <span class=\"p\">},</span>\n  <span class=\"nt\">\"authoredOn\"</span><span class=\"p\">:</span> <span class=\"s2\">\"2015-03-01\"</span><span class=\"p\">,</span>\n  <span class=\"nt\">\"requester\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n    <span class=\"nt\">\"agent\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n      <span class=\"nt\">\"reference\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Practitioner/f007\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"display\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Patrick Pump\"</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">},</span>\n  <span class=\"nt\">\"reasonCode\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n    <span class=\"p\">{</span>\n      <span class=\"nt\">\"coding\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n        <span class=\"p\">{</span>\n          <span class=\"nt\">\"system\"</span><span class=\"p\">:</span> <span class=\"s2\">\"http://snomed.info/sct\"</span><span class=\"p\">,</span>\n          <span class=\"nt\">\"code\"</span><span class=\"p\">:</span> <span class=\"s2\">\"59621000\"</span><span class=\"p\">,</span>\n          <span class=\"nt\">\"display\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Essential hypertension (disorder)\"</span>\n        <span class=\"p\">}</span>\n      <span class=\"p\">]</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">],</span>\n  <span class=\"nt\">\"dosageInstruction\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n    <span class=\"p\">{</span>\n      <span class=\"nt\">\"sequence\"</span><span class=\"p\">:</span> <span class=\"mi\">1</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"text\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Take one tablet daily as directed\"</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">]</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>from STU3 to R4. For the most part it is just copying data from one to the other and that works.  There are two structural differences in the stu3 and r4 resources that correspond to</p>\n<p>stu3.context -&gt; r4.encounter<br>\nr4.requester -&gt; r4.requester</p>\n<p>These are not included in the r4 output when running the transform.  The command I'm using to run this is</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>java -jar validator_cli.jar ./medicationrequest-stu3.json -transform http://hl7.org/fhir/StructureMap/MedicationRequest3to4 -version <span class=\"m\">4</span>.0.1 -ig ./MedicationRequest.map -output ./medicationrequest-r4.json\n</code></pre></div>\n<p>the json diff of the r4 and the expected r4 is</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$ diff medicationrequest-r4.json expected-medicationrequest-r4.json\n8a9,12\n&gt;   <span class=\"s2\">\"encounter\"</span>: <span class=\"o\">{</span>\n&gt;     <span class=\"s2\">\"display\"</span>: <span class=\"s2\">\"encounter that leads to this prescription\"</span>,\n&gt;     <span class=\"s2\">\"reference\"</span>: <span class=\"s2\">\"Encounter/f001\"</span>\n&gt;   <span class=\"o\">}</span>,\n40a45,48\n&gt;   <span class=\"s2\">\"requester\"</span>: <span class=\"o\">{</span>\n&gt;     <span class=\"s2\">\"display\"</span>: <span class=\"s2\">\"Patrick Pump\"</span>,\n&gt;     <span class=\"s2\">\"reference\"</span>: <span class=\"s2\">\"Practitioner/f007\"</span>\n&gt;   <span class=\"o\">}</span>,\n</code></pre></div>\n<p>i.e. the context and requester objects are lost during the transform.  It runs without error and the context and requester rules are shown in the output when running (truncated to fit char limit)</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>Start Transform http://hl7.org/fhir/StructureMap/MedicationRequest3to4\nGroup : MedicationRequest<span class=\"p\">;</span> <span class=\"nv\">vars</span> <span class=\"o\">=</span> <span class=\"nb\">source</span> variables <span class=\"o\">[</span>src: <span class=\"o\">(</span>MedicationRequest<span class=\"o\">)]</span>, target variables <span class=\"o\">[</span>tgt: <span class=\"o\">(</span>MedicationRequest<span class=\"o\">)]</span>, shared variables <span class=\"o\">[]</span>\n  rule : id<span class=\"p\">;</span> <span class=\"nv\">vars</span> <span class=\"o\">=</span> <span class=\"nb\">source</span> variables <span class=\"o\">[</span>src: <span class=\"o\">(</span>MedicationRequest<span class=\"o\">)]</span>, target variables <span class=\"o\">[</span>tgt: <span class=\"o\">(</span>MedicationRequest<span class=\"o\">)]</span>, shared variables <span class=\"o\">[]</span>\n  rule : text<span class=\"p\">;</span> <span class=\"nv\">vars</span> <span class=\"o\">=</span> <span class=\"nb\">source</span> variables <span class=\"o\">[</span>src: <span class=\"o\">(</span>MedicationRequest<span class=\"o\">)]</span>, target variables <span class=\"o\">[</span>tgt: <span class=\"o\">(</span>MedicationRequest<span class=\"o\">)]</span>, shared variables <span class=\"o\">[]</span>\n  rule : extension<span class=\"p\">;</span> <span class=\"nv\">vars</span> <span class=\"o\">=</span> <span class=\"nb\">source</span> variables <span class=\"o\">[</span>src: <span class=\"o\">(</span>MedicationRequest<span class=\"o\">)]</span>, target variables <span class=\"o\">[</span>tgt: <span class=\"o\">(</span>MedicationRequest<span class=\"o\">)]</span>, shared variables <span class=\"o\">[]</span>\n  rule : identifier<span class=\"p\">;</span> <span class=\"nv\">vars</span> <span class=\"o\">=</span> <span class=\"nb\">source</span> variables <span class=\"o\">[</span>src: <span class=\"o\">(</span>MedicationRequest<span class=\"o\">)]</span>, target variables <span class=\"o\">[</span>tgt: <span class=\"o\">(</span>MedicationRequest<span class=\"o\">)]</span>, shared variables <span class=\"o\">[]</span>\n...\n  rule : context<span class=\"p\">;</span> <span class=\"nv\">vars</span> <span class=\"o\">=</span> <span class=\"nb\">source</span> variables <span class=\"o\">[</span>src: <span class=\"o\">(</span>MedicationRequest<span class=\"o\">)]</span>, target variables <span class=\"o\">[</span>tgt: <span class=\"o\">(</span>MedicationRequest<span class=\"o\">)]</span>, shared variables <span class=\"o\">[]</span>\n  rule : supportingInformation<span class=\"p\">;</span> <span class=\"nv\">vars</span> <span class=\"o\">=</span> <span class=\"nb\">source</span> variables <span class=\"o\">[</span>src: <span class=\"o\">(</span>MedicationRequest<span class=\"o\">)]</span>, target variables <span class=\"o\">[</span>tgt: <span class=\"o\">(</span>MedicationRequest<span class=\"o\">)]</span>, shared variables <span class=\"o\">[]</span>\n  rule : authoredOn<span class=\"p\">;</span> <span class=\"nv\">vars</span> <span class=\"o\">=</span> <span class=\"nb\">source</span> variables <span class=\"o\">[</span>src: <span class=\"o\">(</span>MedicationRequest<span class=\"o\">)]</span>, target variables <span class=\"o\">[</span>tgt: <span class=\"o\">(</span>MedicationRequest<span class=\"o\">)]</span>, shared variables <span class=\"o\">[]</span>\n  rule : requester<span class=\"p\">;</span> <span class=\"nv\">vars</span> <span class=\"o\">=</span> <span class=\"nb\">source</span> variables <span class=\"o\">[</span>src: <span class=\"o\">(</span>MedicationRequest<span class=\"o\">)]</span>, target variables <span class=\"o\">[</span>tgt: <span class=\"o\">(</span>MedicationRequest<span class=\"o\">)]</span>, shared variables <span class=\"o\">[]</span>\n      Group : requester<span class=\"p\">;</span> <span class=\"nv\">vars</span> <span class=\"o\">=</span> <span class=\"nb\">source</span> variables <span class=\"o\">[</span>src: <span class=\"o\">(</span>Reference<span class=\"o\">)]</span>, target variables <span class=\"o\">[</span>tgt: <span class=\"o\">(</span>MedicationRequest<span class=\"o\">)]</span>, shared variables <span class=\"o\">[]</span>\n        rule : agent<span class=\"p\">;</span> <span class=\"nv\">vars</span> <span class=\"o\">=</span> <span class=\"nb\">source</span> variables <span class=\"o\">[</span>src: <span class=\"o\">(</span>Reference<span class=\"o\">)]</span>, target variables <span class=\"o\">[</span>tgt: <span class=\"o\">(</span>MedicationRequest<span class=\"o\">)]</span>, shared variables <span class=\"o\">[]</span>\n        rule : onBehalfOf<span class=\"p\">;</span> <span class=\"nv\">vars</span> <span class=\"o\">=</span> <span class=\"nb\">source</span> variables <span class=\"o\">[</span>src: <span class=\"o\">(</span>Reference<span class=\"o\">)]</span>, target variables <span class=\"o\">[</span>tgt: <span class=\"o\">(</span>MedicationRequest<span class=\"o\">)]</span>, shared variables <span class=\"o\">[]</span>\n...\n ...success\nDone. Times: Loading: <span class=\"m\">00</span>:13.0413. Max <span class=\"nv\">Memory</span> <span class=\"o\">=</span> 3Gb\n</code></pre></div>\n<p>Any thoughts <span class=\"user-mention\" data-user-id=\"191478\">@Oliver Egger</span>?</p>",
        "id": 263870038,
        "sender_full_name": "Declan Kieran",
        "timestamp": 1638805935
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"456074\">Declan Kieran</span> <a href=\"#narrow/stream/181579-mapping-framework/topic/R3.20to.20R4.20using.20validator_cli.2Ejar/near/263870038\">said</a>:<br>\nI was able to get some data into an encounter object by adding</p>\n<div class=\"codehilite\"><pre><span></span><code>    src -&gt; tgt.encounter as enc then {\n      src -&gt; enc.reference = &quot;hello&quot; &quot;rule_a&quot;;\n    } &quot;rule_b&quot;;\n</code></pre></div>\n<p>to the map, but when trying to take it from the context in the STU3 MedicationRequest</p>\n<div class=\"codehilite\"><pre><span></span><code>    src -&gt; tgt.encounter as enc then {\n      src.context as con -&gt; enc.reference = con.reference &quot;rule_a&quot;;\n    } &quot;rule_b&quot;;\n</code></pre></div>\n<p>It runs without error, but no encounter object in the output.  It seems like its not getting the data from the context object...</p>\n<p>Edit:</p>\n<p>Another interesting observation is when I change the name of reference to something invalid, i.e.</p>\n<div class=\"codehilite\"><pre><span></span><code>src -&gt; tgt.encounter as enc then {\n  src -&gt; enc.xreference = &quot;hello&quot; &quot;rule_a&quot;;\n} &quot;rule_b&quot;;\n</code></pre></div>\n\n<p>I get a nice error, but when I include the context, i.e.</p>\n<div class=\"codehilite\"><pre><span></span><code>src -&gt; tgt.encounter as enc then {\n  src.context as con -&gt; enc.xreference = &quot;hello&quot; &quot;rule_a&quot;;\n} &quot;rule_b&quot;;\n</code></pre></div>\n\n<p>I don't get an error (or an encounter object in the output...)</p>",
        "id": 263977140,
        "sender_full_name": "Declan Kieran",
        "timestamp": 1638869916
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"456074\">@Declan Kieran</span>  Like this the source will be parsed as an R4 resource and most probably it is lenient that there is not an error thrown for context, requester.  I think you would need first to do the <a href=\"https://confluence.hl7.org/display/FHIR/Using+the+FHIR+Validator\">version conversion</a> with the validator that you have an R4 resource because this would probably adjust the context for R3 and R4 correctly.</p>",
        "id": 263982004,
        "sender_full_name": "Oliver Egger",
        "timestamp": 1638872944
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191478\">Oliver Egger</span> <a href=\"#narrow/stream/181579-mapping-framework/topic/R3.20to.20R4.20using.20validator_cli.2Ejar/near/263982004\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"456074\">Declan Kieran</span>  Like this the source will be parsed as an R4 resource and most probably it is lenient that there is not an error thrown for context, requester.  I think you would need first to do the <a href=\"https://confluence.hl7.org/display/FHIR/Using+the+FHIR+Validator\">version conversion</a> with the validator that you have an R4 resource because this would probably adjust the context for R3 and R4 correctly.</p>\n</blockquote>\n<p>Thanks <span class=\"user-mention\" data-user-id=\"191478\">@Oliver Egger</span> , I did have the source set as </p>\n<div class=\"codehilite\"><pre><span></span><code>uses &quot;http://hl7.org/fhir/3.0/StructureDefinition/MedicationRequest&quot; alias MedicationRequestR3 as source\n</code></pre></div>\n<p>But, yes it doesn't seem to be a stringent as opposed to the R4.</p>\n<p>I've ran the same source through the validator_cli using the parameters for version conversion, </p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>java -jar validator_cli.jar ./medicationrequest-stu3-apim.json -version <span class=\"m\">3</span>.0 -to-version <span class=\"m\">4</span>.0 -output ./to-version-r4.json\n</code></pre></div>\n<p>and interestingly I get an error on the context conversion</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>  rule : context<span class=\"p\">;</span> <span class=\"nv\">vars</span> <span class=\"o\">=</span> <span class=\"nb\">source</span> variables <span class=\"o\">[</span>src: <span class=\"o\">(</span>MedicationRequest<span class=\"o\">)]</span>, target variables <span class=\"o\">[</span>tgt: <span class=\"o\">(</span>MedicationRequest<span class=\"o\">)]</span>, shared variables <span class=\"o\">[]</span>\n ...Failure: Exception executing transform tgt.encounter <span class=\"o\">=</span> create<span class=\"o\">()</span> as vvv on Rule <span class=\"s2\">\"context\"</span>: Attempt to get types <span class=\"k\">for</span> an invalid property <span class=\"s1\">'encounter'</span> on <span class=\"nb\">type</span> MedicationRequest\norg.hl7.fhir.exceptions.FHIRException: Exception executing transform tgt.encounter <span class=\"o\">=</span> create<span class=\"o\">()</span> as vvv on Rule <span class=\"s2\">\"context\"</span>: Attempt to get types <span class=\"k\">for</span> an invalid property <span class=\"s1\">'encounter'</span> on <span class=\"nb\">type</span> MedicationRequest\n        at org.hl7.fhir.r5.utils.structuremap.StructureMapUtilities.runTransform<span class=\"o\">(</span>StructureMapUtilities.java:1746<span class=\"o\">)</span>\n        at org.hl7.fhir.r5.utils.structuremap.StructureMapUtilities.processTarget<span class=\"o\">(</span>StructureMapUtilities.java:1617<span class=\"o\">)</span>\n        at org.hl7.fhir.r5.utils.structuremap.StructureMapUtilities.executeRule<span class=\"o\">(</span>StructureMapUtilities.java:1206<span class=\"o\">)</span>\n        at org.hl7.fhir.r5.utils.structuremap.StructureMapUtilities.executeGroup<span class=\"o\">(</span>StructureMapUtilities.java:1193<span class=\"o\">)</span>\n        at org.hl7.fhir.r5.utils.structuremap.StructureMapUtilities.transform<span class=\"o\">(</span>StructureMapUtilities.java:1155<span class=\"o\">)</span>\n        at org.hl7.fhir.validation.ValidationEngine.transformVersion<span class=\"o\">(</span>ValidationEngine.java:663<span class=\"o\">)</span>\n        at org.hl7.fhir.validation.cli.services.ValidationService.transformVersion<span class=\"o\">(</span>ValidationService.java:248<span class=\"o\">)</span>\n        at org.hl7.fhir.validation.ValidatorCli.doValidation<span class=\"o\">(</span>ValidatorCli.java:259<span class=\"o\">)</span>\n        at org.hl7.fhir.validation.ValidatorCli.main<span class=\"o\">(</span>ValidatorCli.java:163<span class=\"o\">)</span>\nCaused by: org.hl7.fhir.exceptions.FHIRException: Attempt to get types <span class=\"k\">for</span> an invalid property <span class=\"s1\">'encounter'</span> on <span class=\"nb\">type</span> MedicationRequest\n        at org.hl7.fhir.r5.model.Base.getTypesForProperty<span class=\"o\">(</span>Base.java:313<span class=\"o\">)</span>\n        at org.hl7.fhir.r5.elementmodel.Element.getTypesForProperty<span class=\"o\">(</span>Element.java:740<span class=\"o\">)</span>\n        at org.hl7.fhir.r5.utils.structuremap.StructureMapUtilities.runTransform<span class=\"o\">(</span>StructureMapUtilities.java:1642<span class=\"o\">)</span>\n        ... <span class=\"m\">8</span> more\n</code></pre></div>\n<p>The error seems to be saying encounter is an invalid property?  Is your matchbox server able to run the -to-version type transform?  I have it running in an ide, so I can debug through, but I might also see if I can get a debugger on the validator_cli, unless of course I'm just doing something silly here!</p>",
        "id": 263985720,
        "sender_full_name": "Declan Kieran",
        "timestamp": 1638875282
    },
    {
        "content": "<p>it looks like that you get one step further no? I'm afraid you need to debug to check if you have really R3 and R4 MedicationRequest StructureDefinitions loaded (and then internally converted to R5), i'm not familiar with the conversion functionality of validator_cli, sorry. matchbox does not support version conversion at the moment.</p>",
        "id": 263987575,
        "sender_full_name": "Oliver Egger",
        "timestamp": 1638876409
    },
    {
        "content": "<p>Thanks Oliver, I'll update on any progress I make.</p>",
        "id": 263987843,
        "sender_full_name": "Declan Kieran",
        "timestamp": 1638876550
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191478\">@Oliver Egger</span> I have it working for my example now.  It seems that only the StructureDefintions for version 3 are being loaded into the ValidationEngine.  In the ValidationCli class (with the main), before the validator is initialised, the definitions string is set to the source, i.e. 3.0.2 in this case.  When it loads the npm package, it loads version \"hl7.fhir.r3.core#3.0.2\"</p>\n<p>The function getTargetResourceFromStructureMap searches the initialised ValidationEngine for a StuctureDefinition that matches the target url, i.e. <a href=\"http://hl7.org/fhir/StructureDefintion/MedicationRequest\">http://hl7.org/fhir/StructureDefintion/MedicationRequest</a>.</p>\n<p>The list it searches in the context only has version 3 StructureDefintions, so it uses that and when it gets the properties for the conversion, it doesn't find encounter since that is not in STU3.  There is also a HashMap (<a href=\"http://context.structures.map\">context.structures.map</a>) in the ValidationEngine object that seems to have all StructureDefintions, i.e. 2, 3 and 4, so I exposed this just by making a few things public (super hacky...) and searched it and found these StructureDefintions for MedicationRequest (which are a mixture of r3 and r4)</p>\n<p>r4-MedicationRequest<br>\n<a href=\"http://hl7.org/fhir/4.0/StructureDefinition/MedicationRequest|4.0.1\">http://hl7.org/fhir/4.0/StructureDefinition/MedicationRequest|4.0.1</a><br>\n<a href=\"http://hl7.org/fhir/4.0/StructureDefinition/MedicationRequest|4.0\">http://hl7.org/fhir/4.0/StructureDefinition/MedicationRequest|4.0</a><br>\nMedicationRequest<br>\n<a href=\"http://hl7.org/fhir/StructureDefinition/MedicationRequest\">http://hl7.org/fhir/StructureDefinition/MedicationRequest</a><br>\n<a href=\"http://hl7.org/fhir/StructureDefinition/MedicationRequest|#0\">http://hl7.org/fhir/StructureDefinition/MedicationRequest|#0</a><br>\n<a href=\"http://hl7.org/fhir/4.0/StructureDefinition/MedicationRequest\">http://hl7.org/fhir/4.0/StructureDefinition/MedicationRequest</a><br>\nr3-MedicationRequest<br>\n<a href=\"http://hl7.org/fhir/3.0/StructureDefinition/MedicationRequest\">http://hl7.org/fhir/3.0/StructureDefinition/MedicationRequest</a><br>\n<a href=\"http://hl7.org/fhir/3.0/StructureDefinition/MedicationRequest|#0\">http://hl7.org/fhir/3.0/StructureDefinition/MedicationRequest|#0</a></p>\n<p>I hardcoded (more hack...) the one with the name</p>\n<p><a href=\"http://hl7.org/fhir/4.0/StructureDefinition/MedicationRequest\">http://hl7.org/fhir/4.0/StructureDefinition/MedicationRequest</a></p>\n<p>It complained about not finding id (which was in the source input), but when id was removed it worked for the rest of the source example.  i.e. context was converted to encounter and the structure of requester was updated, which is what I expected originally.</p>\n<p>So not sure if this is more a package management problem, i.e. <a href=\"http://hl7.org/fhir/StructureDefintion/MedicationRequest\">http://hl7.org/fhir/StructureDefintion/MedicationRequest</a> should be r4.  Or maybe something needs be added to the ValidationEngine to ensure when the target is being handled, it doesn't use source definitions.  I'm not sure how to configure the npm packages yet, but I'm sure someone in nhsd will help me with that.  If it becomes apparent a code fix might be appropriate, would it be worth making a PR for it?</p>\n<p>edit:</p>\n<p>For to mention as it didn't seem to be relevant to make it work in the end, but on the creation of some Elements, there is an exception thrown and ignored  </p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>Method threw <span class=\"s1\">'java.lang.NullPointerException'</span> exception. Cannot evaluate org.hl7.fhir.r5.elementmodel.Element.toString<span class=\"o\">()</span>\n</code></pre></div>\n<p>org.hl7.fhir.r5.elementmodel.Element. does have an implementation of toString().  It's maybe not related, but thought it might be worth mentioning...</p>",
        "id": 264129724,
        "sender_full_name": "Declan Kieran",
        "timestamp": 1638955230
    },
    {
        "content": "<p>I too have been trying to test the R3-&gt;R4 maps via the FHIR validator, but it does appear to be broken. So far I have:</p>\n<div class=\"codehilite\"><pre><span></span><code>wget https://github.com/hapifhir/org.hl7.fhir.core/releases/latest/download/validator_cli.jar\nwget -O medicationrequest-stu3.json http://hl7.org/fhir/stu3/medicationrequest0331.json\njava -jar validator_cli.jar ./medicationrequest-stu3.json -transform http://hl7.org/fhir/StructureMap/MedicationRequest3to4 -version 3.0.2 -ig hl7.fhir.xver.r4#1.2.0 -output ./medicationrequest-r4.json\n</code></pre></div>\n<p>Sadly, this fails with <code>org.hl7.fhir.exceptions.FHIRException: No matches found for rule for 'Reference to BackboneElement' from http://hl7.org/fhir/StructureMap/MedicationRequest3to4, from rule 'agent'</code>.</p>\n<p>I believe the issue may be similar to what others have encountered (the transformations package does not seem to properly reference the R4 structure definitions, if I understand correctly). Any ideas how to solve this? Are there any unofficial updates to the <code>hl7.fhir.xver.r4</code> package anywhere beyond 1.2.0?</p>\n<p><span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span>  <span class=\"user-mention\" data-user-id=\"456074\">@Declan Kieran</span>  <span class=\"user-mention\" data-user-id=\"191478\">@Oliver Egger</span> <span class=\"user-mention\" data-user-id=\"191363\">@Vadim Peretokin</span> <span class=\"user-mention\" data-user-id=\"222054\">@Gino Canessa</span>  <span class=\"user-mention\" data-user-id=\"193430\">@Alexander Zautke</span></p>",
        "id": 274249926,
        "sender_full_name": "Nikolai Schwertner",
        "timestamp": 1646494900
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span></p>",
        "id": 274260170,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1646507835
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191496\">@Nikolai Schwertner</span> </p>\n<p>I've had a go at transforming this resource using the following (note using -to-version instead of specifying -transform)</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>java -jar validator_cli.jar medicationrequest-stu3.json -version <span class=\"m\">3</span>.0 -to-version <span class=\"m\">4</span>.0 -output medication_request_r4.json\n</code></pre></div>\n<p>In the demo I did here </p>\n<p><a href=\"https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo\">https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo</a></p>\n<p>I had to remove the ID's from all the resources, not sure I put this in the readme, so apologies for that!  Otherwise it fail with an error like this</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>rule : Resource-id<span class=\"p\">;</span> <span class=\"nv\">vars</span> <span class=\"o\">=</span> <span class=\"nb\">source</span> variables <span class=\"o\">[</span>src: <span class=\"o\">(</span>MedicationRequest<span class=\"o\">)]</span>, target variables <span class=\"o\">[</span>tgt: <span class=\"o\">(</span>MedicationRequest<span class=\"o\">)]</span>, shared variables <span class=\"o\">[]</span>\n ...Failure: Exception executing transform tgt.id <span class=\"o\">=</span> create<span class=\"o\">()</span> as vvv on Rule <span class=\"s2\">\"Resource-id\"</span>: null\norg.hl7.fhir.exceptions.FHIRException: Exception executing transform tgt.id <span class=\"o\">=</span> create<span class=\"o\">()</span> as vvv on Rule <span class=\"s2\">\"Resource-id\"</span>: null\n</code></pre></div>\n<p>Not handling ID's makes sense though from a migration perspective, but I suppose there might be uses cases where you'd want to maintain the same ID for a resource in a new system.</p>\n<p>Another thing I found was it didn't handle contained resources, so I just removed those from the input examples.  Again, sort of makes sense as you'd probably want to traverse though contained/linked resources at a different layer.</p>\n<p>So to transform the example you've used, I extracted the contained medication resources and put it in its own file and it successfully transformed using</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>java -jar validator_cli.jar medication.json -version <span class=\"m\">3</span>.0 -to-version <span class=\"m\">4</span>.0 -output medication_r4shell\n</code></pre></div>\n<p>For the rest of the example (without the contained), I reran the validator_cli </p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>java -jar validator_cli.jar medicationrequest-stu3.json -version <span class=\"m\">3</span>.0 -to-version <span class=\"m\">4</span>.0 -output medication_request_r4.json\n</code></pre></div>\n<p>But I've got an error about doseAndRate</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>      rule : doserate<span class=\"p\">;</span> <span class=\"nv\">vars</span> <span class=\"o\">=</span> <span class=\"nb\">source</span> variables <span class=\"o\">[</span>src: <span class=\"o\">(</span>Dosage<span class=\"o\">)]</span>, target variables <span class=\"o\">[</span>tgt: <span class=\"o\">(</span>Dosage<span class=\"o\">)]</span>, shared variables <span class=\"o\">[]</span>\n        condition <span class=\"o\">[</span>dose.exists<span class=\"o\">()</span> or rate.exists<span class=\"o\">()]</span> <span class=\"k\">for</span> <span class=\"nv\">dosageInstruction</span><span class=\"o\">=</span>Dosage<span class=\"o\">[</span><span class=\"m\">4</span> children<span class=\"o\">]</span> : <span class=\"nb\">true</span>\nException <span class=\"k\">in</span> thread <span class=\"s2\">\"main\"</span> java.lang.Error: Unrecognised name doseAndRate on dosageInstruction\n        at org.hl7.fhir.r5.elementmodel.Element.makeProperty<span class=\"o\">(</span>Element.java:471<span class=\"o\">)</span>\n</code></pre></div>\n<p>Which is odd as there isn't a doseAndRate element in the example and it's cardinality is 0..*.  It also doesn't seem to be in the map here <a href=\"https://www.hl7.org/fhir/medicationrequest-version-maps.html\">https://www.hl7.org/fhir/medicationrequest-version-maps.html</a></p>\n<p>So I removed the dosageInstruction and the rest of it transforms.  I haven't checked if the transform is correct, but by line count it looks like stuff carried across..</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>  <span class=\"m\">22</span> medication.json\n  <span class=\"m\">26</span> medication_r4.json\n  <span class=\"m\">66</span> medication_request_r4-nodosage.json\n  <span class=\"m\">64</span> medicationrequest-stu3-nodosage.json\n</code></pre></div>\n<p>To fix the dosage error, you might need to start playing with the FML and generating a new StructureMap to see if you can get round the error, but someone else might be able to correct me on that.  You'd then need to put the StructureMap into the xver package (again, for the way I'm doing it, there might be better ways)</p>\n<p>The modified xver package I'm using is here</p>\n<p><a href=\"https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/tree/main/packages/hl7.fhir.xver.r4%231.2.0-mod\">https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/tree/main/packages/hl7.fhir.xver.r4%231.2.0-mod</a></p>\n<p>You need to unpack that to the directory ~/.fhir/packages/hl7.fhir.xver.r4#1.2.0, as this is where the validator_cli will read it from</p>\n<p>This will give you the modification to the target URL's that will make it run like it does in the pipeline in the repo mentioned.  </p>\n<p>Example run<br>\n<a href=\"https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/runs/5101135359?check_suite_focus=true\">https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/runs/5101135359?check_suite_focus=true</a></p>\n<p>Pipeline yaml<br>\n<a href=\"https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/blob/main/.github/workflows/validate-transforms.yml\">https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/blob/main/.github/workflows/validate-transforms.yml</a></p>",
        "id": 274373856,
        "sender_full_name": "Declan Kieran",
        "timestamp": 1646649560
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"456074\">@Declan Kieran</span>  Thank you for sharing. </p>\n<p>It looks like </p>\n<div class=\"codehilite\"><pre><span></span><code>java -jar validator_cli.jar medicationrequest-stu3.json -transform http://hl7.org/fhir/StructureMap/MedicationRequest3to4 -version 3.0.2 -ig hl7.fhir.xver.r4#1.2.0 -output medicationrequest-r4.json\n</code></pre></div>\n<p>and</p>\n<div class=\"codehilite\"><pre><span></span><code>java -jar validator_cli.jar medicationrequest-stu3.json -version 3.0 -to-version 4.0 -output medicationrequest-r4.json\n</code></pre></div>\n<p>produce the same result.</p>\n<p>Your steps worked on my end as well with the medication request example. I still had to manually remove the <code>requester</code> attribute to squash the <code>agent</code> error.  Unfortunately, the conversion is not very exciting without the dosage and requester as the stu3 and r4 versions are identical under these conditions. The only difference I noticed was for the contained Medication (extracted into a separate resource) where the isBranded attribute is converted into an extension.</p>\n<p>I tried converting the example at <code>https://www.hl7.org/fhir/STU3/medicationexample0316.json</code> but that gives <code> Exception executing transform tgt.strength = create() as vvv on Rule \"amount\": Attempt to get types for an invalid property 'strength' on type BackboneElement</code>. I tried a couple other examples from different resource types only to run into an assortment of errors.</p>\n<p>I think the conclusion is that the <code>hl7.fhir.xver.r4</code> package would need to be fixed before it can be used with the validator tool to convert the sample resources convincingly.</p>",
        "id": 274433388,
        "sender_full_name": "Nikolai Schwertner",
        "timestamp": 1646676596
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191496\">@Nikolai Schwertner</span>  Yes I agree, I think there is more work to be done on the maps, but for the resources I was able to transform, the transforms appeared to mostly correct out of 794, although my method for automatically comparing the transforms had some limitations, i.e. it only examined keys.  However, it was quite good in general, 573 out 794 with no issues detected by my script</p>\n<p><a href=\"https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/tree/main/examples\">https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/tree/main/examples</a></p>\n<p>and of the ones where there was something detected, most of them are invalid data or elements that were renamed.  This would suggest that the StructureMap utilities can a handle good range of complexity.  Also the conversion of FML to StructureMap appears to be rock solid.</p>\n<p>The isBrand you mentioned being moved to an extension is something that I also saw happen in the examples I tested and shows the maps are pretty well developed.  isBrand is only in STU3 and not in R4, so it is maintaining the data in case you might want to \"round-trip\" (see <a href=\"https://build.fhir.org/versions.html#extensions\">https://build.fhir.org/versions.html#extensions</a>).  There is however probably even more work still to do there on making that complete.</p>\n<p>In terms of the work that needs done to make it production level, I'd say the maps that are there would be a good starting point to develop on for whatever workflows you're looking to implement.  If you're using everything, then of course that's not helpful!  But in developing your own maps, it seems like a good opportunity to provide back to general community as this is definitely something that will be beneficial across companies and organisations, and it would make sense to share this to allow for cross site collaboration.  Not sure what the process would be to feed that sort of stuff back <span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> ?.  NHS Digital are currently looking to provide maps for their various profiles, which will eventually be made public I believe.  </p>\n<p>Also, there were unit tests within the core libraries for the maps, but they are no longer being maintained.  This fix might help, but I'm guessing given the code is old, there'd probably be more issues there. </p>\n<p>The script that automatically checks the transforms in the repo I used for testing, doesn't refer to any mappings to do it.  I was thinking this would be a useful way to approach it, so that it could be used to fix any issues in the mappings.   If things are renamed it highlights that as possibly lost or renamed, as there is no way of determining that without referencing a mapping of some sort.  However once I have specific maps that are well tested for the particular set of resources I'm currently looking at, I think I'll extend the code to reference the maps to give me a cleaner test report, but its actually handier for testing at the moment as it is.  Definitely still work to do on this, and its a wild tricky problem!</p>",
        "id": 274466366,
        "sender_full_name": "Declan Kieran",
        "timestamp": 1646691349
    },
    {
        "content": "<p>This is more of an <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> question than a 'me' question.  Because we're doing an R4B release, there's an opportunity to fix the maps.  Whether there's energy/bandwidth, I don't know.</p>",
        "id": 274475284,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1646696577
    }
]