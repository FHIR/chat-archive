[
    {
        "content": "<p>I am struggling with defining a slice on an extension that is inside a slice. where the slice discriminator is the extension's valueReference.identifier.type. I have defined this, which does build</p>\n<div class=\"codehilite\"><pre><span></span><code>* agent.extension contains OtherId named otherId 0..* MS\n* agent[user].extension[otherId] ^slicing.discriminator.type = #pattern\n* agent[user].extension[otherId] ^slicing.discriminator.path = &quot;valueReference.identifier.type&quot;\n* agent[user].extension[otherId] ^slicing.rules = #open\n* agent[user].extension[otherId] contains\n    subject-id 0..1 and\n    npi 0..1 and\n    provider-id 0..1\n* agent[user].extension[otherId][subject-id].valueReference.identifier.type = OtherIdentifierTypes#SAML-subject-id\n* agent[user].extension[otherId][subject-id].valueReference.identifier.value 1..1 MS\n* agent[user].extension[otherId][subject-id].valueReference.identifier.value ^short = &quot;SAML Attribute subject-id&quot;\n</code></pre></div>\n<p>but my examples having this... </p>\n<div class=\"codehilite\"><pre><span></span><code>* agent[user].extension[otherId][subject-id].valueReference.identifier.type = OtherIdentifierTypes#SAML-subject-id\n* agent[user].extension[otherId][subject-id].valueReference.identifier.value = &quot;JohnDoe&quot;\n</code></pre></div>\n<p>get build error thrown by the build</p>\n<div class=\"codehilite\"><pre><span></span><code>error   Slicing cannot be evaluated: Could not match discriminator ([url]) for slice AuditEvent.agent:user.extension:otherId/subject-id in profile http://profiles.ihe.net/ITI/BasicAudit/StructureDefinition/ITI.BasicAudit.SAMLaccessTokenUse.Comprehensive - the discriminator [url] does not have fixed value, binding or existence assertions\n</code></pre></div>\n<p>First, not sure I did the slice in sushi right, but it seems happy at the sushi level.</p>",
        "id": 263715247,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638633215
    },
    {
        "content": "<p>Oh, this is on AuditEvent resource</p>",
        "id": 263715252,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638633229
    },
    {
        "content": "<p>Here is the IG build, pointing at the example that fails - <a href=\"http://build.fhir.org/ig/IHE/ITI.BasicAudit/branches/main/AuditEvent-ex-auditPoke-SAML-Comp.html\">http://build.fhir.org/ig/IHE/ITI.BasicAudit/branches/main/AuditEvent-ex-auditPoke-SAML-Comp.html</a></p>",
        "id": 263715334,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638633335
    },
    {
        "content": "<p>SPECIFICALLY is the following discriminator path legal?</p>\n<div class=\"codehilite\"><pre><span></span><code>^slicing.discriminator.path = &quot;valueReference.identifier.type&quot;\n</code></pre></div>",
        "id": 263715507,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638633545
    },
    {
        "content": "<p>or does the discriminator path MUST be at the root of the slice?</p>",
        "id": 263715724,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638633718
    },
    {
        "content": "<p>It seems a long shot, but should <code>valueReference</code> be <code>value[x]:valueReference</code> throughout?</p>",
        "id": 263739437,
        "sender_full_name": "Elliot Silver",
        "timestamp": 1638662936
    },
    {
        "content": "<p>I'm pretty sure a discriminator doesn't need to be at the root.</p>",
        "id": 263739507,
        "sender_full_name": "Elliot Silver",
        "timestamp": 1638663042
    },
    {
        "content": "<p>I believe that, in FHIRPath, there is no valueReference, there is just value.  so \"(value as Reference).identifier.type\" should/might work.</p>",
        "id": 263740340,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1638664516
    },
    {
        "content": "<p>nope, just tried it and it gets the same error.  sorry.</p>",
        "id": 263740538,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1638664907
    },
    {
        "content": "<p>this might be the problem that I had with davinci PAS.  I think that SUSHI has been updated to fix it? or this is entirely new and you've found a new edge case :)</p>",
        "id": 263740796,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1638665396
    },
    {
        "content": "<p>This conversation is continuing on the <a class=\"stream\" data-stream-id=\"179252\" href=\"/#narrow/stream/179252-IG-creation\">#IG creation</a> stream here: <a href=\"#narrow/stream/179252-IG-creation/topic/slicing.20sliced.20extension\">https://chat.fhir.org/#narrow/stream/179252-IG-creation/topic/slicing.20sliced.20extension</a></p>",
        "id": 263919886,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1638822356
    },
    {
        "content": "<p>so, a possible sushi problem... Many problems went away when I brought the original definition of the first slice into the second profile. Let me explain. I had a base profile that defined the slice and a set of criteria, I had a second profile that derived off of that first one, adding a bunch more things. This works for some kinds of things, but didn't seem to get everything right. When I copyied the first profile constraints into the second, then some of my problems went away..... Still working on the other issues, so not fully clear yet.</p>",
        "id": 263933707,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638829458
    },
    {
        "content": "<p>so it was not specifically a profile derived on a profile. It seems I needed to add the extensions to the .agent in the first profile, adding them in the second is what didn't work as well. Not a problem for me to add them in the first profile, but they are not really needed there.</p>",
        "id": 263934517,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638829946
    },
    {
        "content": "<p>Interesting.  It's still not clear to me if this is an issue w/ SUSHI or an issue w/ the snapshot generator.  As I noted in the other thread, the snapshot generator did not seem to be correctly generating the slices (it dropped the extension type).  So it's possible that your fix somehow addressed the limitation in the snapshot generator.</p>",
        "id": 264001014,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1638883994
    },
    {
        "content": "<p>yup, I was just trying to update this stream about that specific hack that got me a bit further. That hack is that I needed to add the extensions in my primary profile, couldn't add them in the secondary profile.</p>",
        "id": 264008597,
        "sender_full_name": "John Moehrke",
        "timestamp": 1638887254
    },
    {
        "content": "<p>I am still having trouble slicing an extension in a slice ... Here is my test IG that focuses ONLY on this issue - <a href=\"http://build.fhir.org/ig/JohnMoehrke/SlicingSlicedExtension/branches/main/index.html\">http://build.fhir.org/ig/JohnMoehrke/SlicingSlicedExtension/branches/main/index.html</a></p>",
        "id": 275389152,
        "sender_full_name": "John Moehrke",
        "timestamp": 1647358372
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> I  augmented the json that sushi spits out, and suppressed sushi running.. .but I still get the same error, so I don't think I understood fully the augmention you recommended.</p>\n<p>adding in the base and type as shown here.</p>\n<div class=\"codehilite\"><pre><span></span><code>      {\n        &quot;id&quot;: &quot;AuditEvent.agent:user.extension:extOtherId/npi&quot;,\n        &quot;path&quot;: &quot;AuditEvent.agent.extension&quot;,\n        &quot;sliceName&quot;: &quot;extOtherId/npi&quot;,\n        &quot;min&quot;: 0,\n        &quot;max&quot;: &quot;1&quot;,\n        &quot;base&quot;: {\n            &quot;path&quot;: &quot;Element.extension&quot;,\n            &quot;min&quot;: 0,\n            &quot;max&quot;: &quot;*&quot;\n        },\n        &quot;type&quot;: [\n          {\n            &quot;code&quot;: &quot;Extension&quot;\n          }\n        ]\n      },\n      {\n        &quot;id&quot;: &quot;AuditEvent.agent:user.extension:extOtherId/npi.valueReference&quot;,\n        &quot;path&quot;: &quot;AuditEvent.agent.extension.valueReference&quot;\n      },\n      {\n        &quot;id&quot;: &quot;AuditEvent.agent:user.extension:extOtherId/npi.valueReference.identifier.type&quot;,\n        &quot;path&quot;: &quot;AuditEvent.agent.extension.valueReference.identifier.type&quot;,\n        &quot;patternCodeableConcept&quot;: {\n          &quot;coding&quot;: [\n            {\n              &quot;code&quot;: &quot;NPI&quot;,\n              &quot;system&quot;: &quot;http://terminology.hl7.org/CodeSystem/v2-0203&quot;\n            }\n          ]\n        }\n      },\n</code></pre></div>",
        "id": 275430394,
        "sender_full_name": "John Moehrke",
        "timestamp": 1647375844
    },
    {
        "content": "<p>I'm still seeing a bare type=\"Extension\" and no profile declared on extension:extOtherId/npi</p>",
        "id": 275432877,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1647377148
    },
    {
        "content": "<p>That declaration needs to include the extension profile</p>",
        "id": 275432895,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1647377158
    },
    {
        "content": "<p>ah, Ill try that</p>",
        "id": 275433563,
        "sender_full_name": "John Moehrke",
        "timestamp": 1647377515
    },
    {
        "content": "<p>didn't help.. but I might have still done it wrong</p>",
        "id": 275434727,
        "sender_full_name": "John Moehrke",
        "timestamp": 1647378113
    },
    {
        "content": "<p>I committed to github the enhanced json project - <a href=\"https://github.com/JohnMoehrke/SlicingSlicedExtension\">https://github.com/JohnMoehrke/SlicingSlicedExtension</a></p>",
        "id": 275442450,
        "sender_full_name": "John Moehrke",
        "timestamp": 1647382052
    },
    {
        "content": "<p>I welcome further enhancements to make it work</p>",
        "id": 275442470,
        "sender_full_name": "John Moehrke",
        "timestamp": 1647382067
    },
    {
        "content": "<p>I've done some more investigation on this and found some interesting issues in snapshot generation.  Since this topic is in two streams now, I'll just direct you to the other stream where I noted my findings: <a href=\"#narrow/stream/179252-IG-creation/topic/slicing.20sliced.20extension/near/275577171\">https://chat.fhir.org/#narrow/stream/179252-IG-creation/topic/slicing.20sliced.20extension/near/275577171</a></p>",
        "id": 275577341,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1647464832
    }
]