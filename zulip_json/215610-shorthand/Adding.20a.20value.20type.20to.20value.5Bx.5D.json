[
    {
        "content": "<p>Hi! I am trying to add a value type to a value[x] field. I am not sure whether to use slicing or an extension for this, I have tried both and not succeeded. I am looking to add a value type to <code>item.answer.value[x]</code> in <code>QuestionnaireResponse</code> called \"valueTriggerCode\" which refers to a valueset/codesystem I've defined, so users of the profile can still choose to use any of the other value types possible, but also be able to use the additional one (valueTriggerCode). Is this possible with shorthand and how? Thanks =)</p>",
        "id": 231448118,
        "sender_full_name": "Max Körlinge",
        "timestamp": 1616495187
    },
    {
        "content": "<p>you probably want to restrict value[x] to CodeableConcept and then bind that CodeableConcept to your valueset. I don't think there's a valid way to define your own datatype<br>\n<a href=\"https://build.fhir.org/ig/HL7/fhir-shorthand/reference.html#type-rules\">https://build.fhir.org/ig/HL7/fhir-shorthand/reference.html#type-rules</a><br>\n<a href=\"https://build.fhir.org/ig/HL7/fhir-shorthand/reference.html#binding-rules\">https://build.fhir.org/ig/HL7/fhir-shorthand/reference.html#binding-rules</a></p>\n<p>so it would look something like </p>\n<ul>\n<li>path.value[x] only CodeableConcept</li>\n<li>path.value[x] from TriggerCode</li>\n</ul>",
        "id": 231489052,
        "sender_full_name": "ryan moehrke",
        "timestamp": 1616513060
    },
    {
        "content": "<p>As <span class=\"user-mention\" data-user-id=\"237342\">@ryan moehrke</span> indicated, you cannot define a new concrete type (like <code>TriggerCode</code>) or add an additional type to an existing choice element.  You can only constrain what is already there.</p>\n<p>I think Ryan's suggestion to use a value set is right, but since you said that you wanted other values to be allowed too, you probably do not want the <code>only</code> rule.  With that in mind, you might want something like this:</p>\n<div class=\"codehilite\"><pre><span></span><code>* item.answer.valueCoding from TriggerCodes (preferred)\n</code></pre></div>\n<p>where <code>TriggerCodes</code> is a value set.  (BTW, using the path <code>item.answer.valueCoding</code> will automatically create a type slice on the choice so the binding only applies to the <code>Coding</code>).  The strength of the binding (<code>example</code>, <code>preferred</code>, <code>extensible</code>, or <code>required</code>) will depend on if you want to allow other codes (not in <code>TriggerCodes</code>) as answers too.</p>\n<p>But... note also that the above is operating on <em>all</em> items in the <code>QuestionnaireResponse</code>.  I expect that maybe you really only want to constrain to <code>TriggerCodes</code> for specific items.  To do that, you would need to use slicing to create a slice based on the <code>linkId</code> for the items that <code>TriggerCodes</code> applies to.  But that starts to get a little more complex, so I won't elaborate further unless you indicate you need the help. ;-)</p>",
        "id": 231493439,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1616514591
    },
    {
        "content": "<p>Thank you both, helpful as always! I think the simplest option for me right now (.. under time pressure ;) ) is to set TriggerCode as <code>example</code> and indicate in the documentation when that would be a good option. Slicing as you suggest would probably be a more complete and constraining way to define it but that might need to wait until a v2 of the profile. Thanks!</p>",
        "id": 231519708,
        "sender_full_name": "Max Körlinge",
        "timestamp": 1616524171
    },
    {
        "content": "<p>Hm maybe I misunderstood you <span class=\"user-mention\" data-user-id=\"191469\">@Chris Moesel</span> , but using your suggestion (<code>* item.answer.valueCoding from TriggerCodes (example)</code>) seems to give me a closed slice which only includes <code>valueCoding</code> and not the other types. What I was looking for was for the profile to allow <code>valueString</code>,  <code>valueBoolean</code> etc. as well, and just sort of.. point out the fact that a TriggerCode will be useful in many cases (but not all). Maybe I'm just not using this the way it is intended?</p>",
        "id": 231534976,
        "sender_full_name": "Max Körlinge",
        "timestamp": 1616529893
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"397998\">@Max Körlinge</span> -- I don't think you misunderstood.  My suggestion was intended to allow multiple types.  When I try this in FSHOnline (<a href=\"https://fshschool.org/FSHOnline/#/share/2NJ74nw\">link</a>), this is the only thing it renders in the differential:</p>\n<div class=\"codehilite\"><pre><span></span><code>&quot;differential&quot;: {\n  &quot;element&quot;: [\n    {\n      &quot;id&quot;: &quot;QuestionnaireResponse.item.answer.valueCoding&quot;,\n      &quot;path&quot;: &quot;QuestionnaireResponse.item.answer.valueCoding&quot;,\n      &quot;min&quot;: 0,\n      &quot;max&quot;: &quot;1&quot;,\n      &quot;type&quot;: [\n        {\n          &quot;code&quot;: &quot;Coding&quot;\n        }\n      ],\n      &quot;binding&quot;: {\n        &quot;strength&quot;: &quot;example&quot;,\n        &quot;valueSet&quot;: &quot;http://example.org/ValueSet/TriggerCodes&quot;\n      }\n    }\n  ]\n}\n</code></pre></div>\n<p>Note that SUSHI does not actually creating the slicing; the IG Publisher does that during snapshot generation. Based on firely's excellent <a href=\"https://fire.ly/2019/09/13/type-slicing-in-fhir-r4/\">Type Slicing in FHIR R4</a> article, the above <em>should</em> only apply to the <code>Coding</code> choice <em>without</em> disallowing other types.  If you're seeing different behavior, it may be an issue with the IG Publisher?</p>",
        "id": 231539697,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1616531826
    },
    {
        "content": "<p>Hmm okay. I get the same differential actually but I was expecting to see the other value types in the Snapshot. Probably I just don't understand the information in the snapshot hehe. This is how it looks in the generated IG<br>\n<a href=\"/user_uploads/10155/pwHOn4_snm_U3F5YE8wsWydT/Skärmavbild-2021-03-23-kl.-21.49.16.png\">Skärmavbild-2021-03-23-kl.-21.49.16.png</a><br>\nDoes this look right to you?</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/pwHOn4_snm_U3F5YE8wsWydT/Skärmavbild-2021-03-23-kl.-21.49.16.png\" title=\"Skärmavbild-2021-03-23-kl.-21.49.16.png\"><img src=\"/user_uploads/10155/pwHOn4_snm_U3F5YE8wsWydT/Skärmavbild-2021-03-23-kl.-21.49.16.png\"></a></div>",
        "id": 231541484,
        "sender_full_name": "Max Körlinge",
        "timestamp": 1616532595
    },
    {
        "content": "<p>To be honest, I'm not sure.  I also would have expected to see the types enumerated -- and I don't know if a <code>closed</code> type slice means no other types are allowed (but if it does, that's not what we want).  This might be a question for <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> or <span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span>.</p>",
        "id": 231542214,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1616532940
    },
    {
        "content": "<p>you may just be able to do * item.answer.value[x] from TriggerCodes (preferred) and it may format similar to the base spec's example binding</p>",
        "id": 231542361,
        "sender_full_name": "ryan moehrke",
        "timestamp": 1616533021
    },
    {
        "content": "<p>I was thinking that the spec said somewhere you could only apply the <code>binding</code> to the type-specific element (not the <code>[x]</code> element) -- but I can't find that now, so I am probably wrong.  I think <span class=\"user-mention\" data-user-id=\"237342\">@ryan moehrke</span> may be on to something!</p>",
        "id": 231543028,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1616533291
    },
    {
        "content": "<p>But I did find this confirmation that using the type specific path should <em>not</em> constrain out the other types.  From <a href=\"http://hl7.org/fhir/elementdefinition.html#typesx\">2.30.0.4.2 Constraining elements with a choice of Type</a>:</p>\n<blockquote>\n<p>The inclusion of a type specific path (such as \"Patient.deceasedBoolean\") SHALL NOT be interpreted as constraining allowed types, but instead, it constrains the use of a particular type</p>\n</blockquote>\n<p>So... using <code>valueCoding</code> <em>should</em> be OK too -- but if applying the <code>binding</code> directly to <code>value[x]</code> works, that may be the best option for now.</p>",
        "id": 231543414,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1616533431
    },
    {
        "content": "<p>Closed does indeed mean that no other types are allowed.</p>",
        "id": 231544015,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1616533698
    },
    {
        "content": "<p>What I'd expect to see is a path of item.answer.value and an id of item.answer.value:valueCoding</p>",
        "id": 231544118,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1616533742
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> -- It's my understanding that the choice type renaming syntax is valid in the <code>id</code> and <code>path</code> in the differential (but <em>only</em> in the differential).  I see it used like that in FHIR core profiles like <a href=\"http://hl7.org/fhir/R4/bp.profile.json.html\">BP</a>, US Core profiles like <a href=\"http://www.hl7.org/fhir/us/core/StructureDefinition-us-core-smokingstatus.json.html\">Smoking Status</a>, and many other IGs -- so I'm pretty sure it's valid.  In the <em>snapshot</em>, however, the full slicing syntax needs to be used (no shortcuts/renaming allowed).</p>",
        "id": 231565764,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1616546342
    },
    {
        "content": "<p>But if closed slicing does indeed mean that no other types are allowed then I think there is a bug in snapshot generation -- as it should be generating the above with an open slicing then.  But I'll post to <a class=\"stream\" data-stream-id=\"179177\" href=\"/#narrow/stream/179177-conformance\">#conformance</a> to get confirmation that my understanding on that is correct.</p>",
        "id": 231565881,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1616546430
    },
    {
        "content": "<p>My understanding is that if the differential shows valueCodeableConcept, that means that's the only thing that's allowed</p>",
        "id": 231566528,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1616546898
    },
    {
        "content": "<p>That's how it worked in DSTU2 and STU3, but they changed it in R4.  See <a href=\"http://hl7.org/fhir/elementdefinition.html#typesx\">2.30.0.4.2 Constraining elements with a choice of Type</a>:</p>\n<blockquote>\n<p>The inclusion of a type specific path (such as \"Patient.deceasedBoolean\") SHALL NOT be interpreted as constraining allowed types, but instead, it constrains the use of a particular type</p>\n</blockquote>",
        "id": 231566590,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1616546959
    },
    {
        "content": "<p>Firely did a <a href=\"https://fire.ly/2019/09/13/type-slicing-in-fhir-r4/\">whole blog</a> outlining that change (otherwise I would have missed it too).</p>",
        "id": 231566697,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1616547029
    },
    {
        "content": "<p>Then it appears there's a bug...</p>",
        "id": 231568903,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1616548889
    },
    {
        "content": "<p>Yeah, I think so.  I posted over in conformance (<a href=\"#narrow/stream/179177-conformance/topic/Choice.20Type.20Renaming.20Should.20Not.20Constrain.20Types\">here</a>) to get a few more eyes on it.  Thanks, Lloyd!</p>",
        "id": 231569036,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1616549016
    },
    {
        "content": "<p>Thanks for going to the bottom with this. Applying the binding to value[x] works well for me right now</p>",
        "id": 231599032,
        "sender_full_name": "Max Körlinge",
        "timestamp": 1616575227
    }
]