[
    {
        "content": "<p>I got a weird issue with constrains on value[x] in an Extension. What i did:</p>\n<ul>\n<li>created a Profile on Money for Euro: <a href=\"https://simplifier.net/erezeptabgabedaten/dav-pr-erp-preisangabeeur\">https://simplifier.net/erezeptabgabedaten/dav-pr-erp-preisangabeeur</a></li>\n<li>used this in an Extension: <a href=\"https://simplifier.net/erezeptabgabedaten/davexerpkostenversicherter\">https://simplifier.net/erezeptabgabedaten/davexerpkostenversicherter</a> (extension[Kostenbetrag].value[x])</li>\n</ul>\n<p>When now trying to create Instances on these sushi converts this:</p>\n<div class=\"codehilite\"><pre><span></span><code>* lineItem[=].priceComponent.extension[KostenVersicherter].extension[Kostenbetrag].valueMoney.value = 5.00\n* lineItem[=].priceComponent.extension[KostenVersicherter].extension[Kostenbetrag].valueMoney.currency = #EUR\n</code></pre></div>\n<p>to this:</p>\n<div class=\"codehilite\"><pre><span></span><code>                   &quot;extension&quot;: [\n                      {\n                        &quot;url&quot;: &quot;Kategorie&quot;,\n                        &quot;valueCodeableConcept&quot;: {\n                          &quot;coding&quot;: [\n                            {\n                              &quot;code&quot;: &quot;0&quot;\n                            }\n                          ]\n                        }\n                      },\n                      {\n                        &quot;url&quot;: &quot;Kostenbetrag&quot;,\n                        &quot;value[x]&quot;: {\n                          &quot;currency&quot;: &quot;EUR&quot;\n                        },\n                        &quot;valueMoney&quot;: {\n                          &quot;currency&quot;: &quot;EUR&quot;,\n                          &quot;value&quot;: 5\n                        }\n                      }\n                    ]\n</code></pre></div>",
        "id": 226310538,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1613317612
    },
    {
        "content": "<p>i think the value[x] should be valueMoney in the Instance. Is this a bug? Or am i missing smth?</p>",
        "id": 226310559,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1613317658
    },
    {
        "content": "<p>Tried to replicate with defining the extension and profile in FSH, works:<br>\n<a href=\"https://fshschool.org/FSHOnline/#/share/2N78gko\">https://fshschool.org/FSHOnline/#/share/2N78gko</a></p>",
        "id": 226373695,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1613389553
    },
    {
        "content": "<p>will dig deeper</p>",
        "id": 226373698,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1613389558
    },
    {
        "content": "<p>Changed the fhs created Example to a complex extension -&gt; no change.<br>\n<a href=\"https://fshschool.org/FSHOnline/#/share/3jRrZAt\">https://fshschool.org/FSHOnline/#/share/3jRrZAt</a></p>",
        "id": 226380495,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1613393860
    },
    {
        "content": "<p>FSH seemst to work, i think this is some side effect from another issue</p>",
        "id": 226380538,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1613393882
    },
    {
        "content": "<p>And i managed to reproduce! :<br>\n<a href=\"https://fshschool.org/FSHOnline/#/share/2Zhcys3\">https://fshschool.org/FSHOnline/#/share/2Zhcys3</a></p>",
        "id": 226386860,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1613397412
    },
    {
        "content": "<p>I agree that the first output (w/ <code>value[x]</code> in the instance) definitely looks wrong.  But if we cannot reproduce it, it will be hard to fix it.  First things first -- are you running the latest version of SUSHI?</p>",
        "id": 226387137,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1613397555
    },
    {
        "content": "<p>Oh!  Our messages crossed paths.  I see you reproduced it now!</p>",
        "id": 226387201,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1613397586
    },
    {
        "content": "<p>Actually... that's not reproducing the same problem, is it?  I don't see any <code>value[x]</code> in the instance.  What I do see is an error about cardinality, which actually seems to be caused by a different issue: the top-level \"test\" extension in the instance is missing the extension URL.  This is a different bug that we're aware of and currently working on.</p>",
        "id": 226387829,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1613397846
    },
    {
        "content": "<p><del><a href=\"https://github.com/FHIR/sushi/issues/751\">SUSHI #751</a></del></p>\n<p><em>EDIT: Nope.  Not the same issue at 751.  I looked at it too quickly.  The real problem is that the two FSH statements that should be modifying the same instance of <code>valueMoney</code> are actually creating/modifying two separate extensions.  That's a new bug (but still not the same as the one originally reported).</em></p>",
        "id": 226387910,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1613397885
    },
    {
        "content": "<p>ah you are right, i'll keep investigating</p>",
        "id": 226387932,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1613397900
    },
    {
        "content": "<p>Logged the new double-extension issue as <a href=\"https://github.com/FHIR/sushi/issues/759\">SUSHI#759</a>.</p>",
        "id": 226389378,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1613398785
    },
    {
        "content": "<p>Alright.  I just reproduced the <code>value[x]</code> bug by bringing in your exact profile definitions (as JSON) and then creating a FSH Instance that uses them.  I haven't had time to look into it -- but I guess it may have to do specifically w/ how the extension is defined. <a href=\"/user_uploads/10155/8rZ-tP-SNMMctnJLrLngAPrj/ValueXBug.zip\">ValueXBug.zip</a></p>",
        "id": 226391915,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1613400187
    },
    {
        "content": "<p>thats also my current guess. Thanks for the \"confirmation\" <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 226392175,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1613400353
    },
    {
        "content": "<p>Alright, and that bug is now tracked as <a href=\"https://github.com/FHIR/sushi/issues/760\">SUSHI#760</a>.</p>",
        "id": 226399773,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1613404350
    }
]