[
    {
        "content": "<p>I have a profile that is defining a slice in Bundle for a couple of my profiles, but also a couple of core resources. Sushi seems to be treating the core resources differently, and not calling upon the core resource structureDefinition.   See  <a href=\"https://github.com/IHE/ITI.MHD/blob/master/input/fsh/provideBundle.fsh\">https://github.com/IHE/ITI.MHD/blob/master/input/fsh/provideBundle.fsh</a></p>",
        "id": 222664672,
        "sender_full_name": "John Moehrke",
        "timestamp": 1610582454
    },
    {
        "content": "<p>it seems that sushi did not like when I profiled the bundle by #profile, but sometimes using a core FHIR Resource (e.g. Binary and Patient). So I tried to do this in two different levels of profile. One level (dummy) that profiles by resource type, the second by profile... This second attempt fails differently in the IG build.</p>\n<p><a href=\"https://github.com/IHE/ITI.MHD\">https://github.com/IHE/ITI.MHD</a></p>\n<p>specifically this FSH file<br>\n<a href=\"https://github.com/IHE/ITI.MHD/blob/master/input/fsh/provideBundle.fsh\">https://github.com/IHE/ITI.MHD/blob/master/input/fsh/provideBundle.fsh</a></p>\n<p>which sushi does create this structureDefinition that the build is failing on<br>\n<a href=\"http://build.fhir.org/ig/IHE/ITI.MHD/branches/master/failure/fsh-generated/resources/StructureDefinition-IHE.MHD.Comprehensive.ProvideBundle.json\">http://build.fhir.org/ig/IHE/ITI.MHD/branches/master/failure/fsh-generated/resources/StructureDefinition-IHE.MHD.Comprehensive.ProvideBundle.json</a></p>",
        "id": 222738762,
        "sender_full_name": "John Moehrke",
        "timestamp": 1610640366
    },
    {
        "content": "<p>I really want to be able to do it the first way I did... </p>\n<div class=\"codehilite\"><pre><span></span><code>* entry contains\n    SubmissionSet 1..1 and\n    DocumentRefs 0..* and\n    Documents 0..* and\n    Folders 0..* and\n    Patient 0..1\n* entry[SubmissionSet].resource only\n    IHE.MHD.Minimal.SubmissionSet or\n    IHE.MHD.UnContained.Comprehensive.SubmissionSet or\n    IHE.MHD.Comprehensive.SubmissionSet\n* entry[SubmissionSet] ^short = &quot;the SubmissionSet&quot;\n* entry[SubmissionSet] ^definition = &quot;The SubmissionSet defines who submitted it, why they submitted it, when they submitted, what is in it, and where it is destine.&quot;\n* entry[SubmissionSet].request 1..1\n* entry[SubmissionSet].request.method = #POST\n* entry[DocumentRefs].resource only\n    IHE.MHD.Minimal.DocumentReference or\n    IHE.MHD.UnContained.Comprehensive.DocumentReference or\n    IHE.MHD.Comprehensive.DocumentReference\n* entry[DocumentRefs] ^short = &quot;the DocumentReference resources&quot;\n* entry[DocumentRefs] ^definition = &quot;any and all DocumentReference that are part of the SubmissionSet. These might be new, replacements, or other associations&quot;\n* entry[DocumentRefs].request 1..1\n* entry[DocumentRefs].request.method = #POST\n* entry[Documents].resource only Binary\n* entry[Documents] ^short = &quot;the documents&quot;\n* entry[Documents] ^definition = &quot;the documents referenced by the DocumentReference resources&quot;\n* entry[Documents].request 1..1\n* entry[Documents].request.method = #POST\n* entry[Folders].resource only\n    IHE.MHD.Minimal.Folder or\n    IHE.MHD.Minimal.Folder\n* entry[Folders] ^short = &quot;Folders&quot;\n* entry[Folders] ^definition = &quot;any Folders being created or updated&quot;\n* entry[Folders].request 1..1\n* entry[Folders].request.method = #POST\n* entry[Patient].resource only Patient\n* entry[Patient] ^short = &quot;the Patient&quot;\n* entry[Patient] ^definition = &quot;the Patient&quot;\n</code></pre></div>",
        "id": 222738961,
        "sender_full_name": "John Moehrke",
        "timestamp": 1610640464
    },
    {
        "content": "<p>It appears Moehrke-Research has come thru with a workaround... in my profile slice using #profile. I just explicitly point at the FHIR structureDefinition for the resources I mean...</p>\n<div class=\"codehilite\"><pre><span></span><code>* entry[Documents].resource only http://hl7.org/fhir/StructureDefinition/Binary\n</code></pre></div>",
        "id": 222743949,
        "sender_full_name": "John Moehrke",
        "timestamp": 1610642351
    },
    {
        "content": "<p>so note to others wanting to profile slice by #profile and use core resources, you just need to be explicit and not expect sushi is going to do the smart thing (until some future release of sushi... I would guess).</p>",
        "id": 222744047,
        "sender_full_name": "John Moehrke",
        "timestamp": 1610642397
    },
    {
        "content": "<p>I'm not sure I fully understand what you mean.  Are you saying that this did not work:</p>\n<div class=\"codehilite\"><pre><span></span><code>* entry[Documents].resource only Binary\n</code></pre></div>\n<p>but this did?</p>\n<div class=\"codehilite\"><pre><span></span><code>* entry[Documents].resource only http://hl7.org/fhir/StructureDefinition/Binary\n</code></pre></div>\n<p>Because if that's the case, I am surprised -- and think that's probably a bug to be fixed.  But if that's not what you're saying, can you elaborate on what _didn't_ work and what you needed to do to make it work?</p>",
        "id": 222746923,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1610643557
    },
    {
        "content": "<p>I guess I'm not fully clear on what is \"the smart thing\" that we should consider implementing in SUSHI.   Which makes it hard to implement it. ;-)</p>",
        "id": 222747236,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1610643664
    },
    {
        "content": "<p>the issue that we ran into was not that \"* entry[Documents].resource only Binary\" wasn't recognized by sushi, just that it only populated the ElementDef.type and not ElementDef.type.profile element, meaning that slicing by profile had nothing to work with.</p>",
        "id": 222749419,
        "sender_full_name": "ryan moehrke",
        "timestamp": 1610644462
    },
    {
        "content": "<p>But using the full URL to <code>Binary</code> forced SUSHI to populate the <code>profile</code> field too?  If so, I also find that surprising...</p>",
        "id": 222751348,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1610645190
    },
    {
        "content": "<p>Based on <a href=\"http://hl7.org/fhir/R4/profiling.html#discriminator\">discriminator docs</a> I think that technically you are supposed to use <code>#type</code> discriminator for non-profiled resources and <code>#profile</code> discriminator for profiled resources.  <span class=\"user-mention\" data-user-id=\"191404\">@John Moehrke</span> -- did you try using a composite discriminator like this?</p>\n<div class=\"codehilite\"><pre><span></span><code>* entry ^slicing.discriminator[0].type = #type\n* entry ^slicing.discriminator[0].path = &quot;resource&quot;\n* entry ^slicing.discriminator[1].type = #profile\n* entry ^slicing.discriminator[1].path = &quot;resource&quot;\n</code></pre></div>\n<p>I'm not positive it would work, but I <em>think</em> so?</p>",
        "id": 222752024,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1610645445
    },
    {
        "content": "<p>honestly I didn't see the canonical url working myself, I did something similar for a different reason and I had to use the carrot overrides<br>\nas for why we weren't jumping on #type, the other 3/5 slices explicitly use profile, we were considering using both but I didn't know how well that was going to work</p>",
        "id": 222752621,
        "sender_full_name": "ryan moehrke",
        "timestamp": 1610645652
    },
    {
        "content": "<p>I think that if you use &gt;1 discriminator, it discriminates on the combination of them together -- so I <em>think</em> it should work and seems more valid to me than trying to get a resource to specify the <code>profile</code> field.</p>",
        "id": 222753026,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1610645841
    },
    {
        "content": "<p>IG build didn't like two different slices. so the workaround is what I am going forward with for now</p>",
        "id": 222754009,
        "sender_full_name": "John Moehrke",
        "timestamp": 1610646258
    },
    {
        "content": "<p>Hmmm ... <span class=\"user-mention\" data-user-id=\"191404\">@John Moehrke</span> I'm trying to do something similar to you: to profile a bundle (in my case its a message bundle), and I do discrimination on type and resource (like you do on <a href=\"https://github.com/IHE/ITI.MHD/blob/a2354642807a8d0cb9b119c5869a5e21dc87a0e8/input/fsh/provideBundle.fsh#L22\">https://github.com/IHE/ITI.MHD/blob/a2354642807a8d0cb9b119c5869a5e21dc87a0e8/input/fsh/provideBundle.fsh#L22</a>).</p>\n<p>Now, I can't get it to work, and If I do the following (this is on your work, and I don't know if it is supposed to work):</p>\n<div class=\"codehilite\"><pre><span></span><code>java -jar validator_cli.jar bundle.json -version 4.0 -ig http://build.fhir.org/ig/IHE/ITI.MHD/branches/master -profile http://ihe.net/fhir/ihe.mhd.fhir/StructureDefinition/IHE.MHD.Minimal.ProvideBundle\n</code></pre></div>\n<p>-where bundle.json is <a href=\"http://build.fhir.org/ig/IHE/ITI.MHD/branches/master/Bundle-ex-minimalProvideDocumentBundle.json\">http://build.fhir.org/ig/IHE/ITI.MHD/branches/master/Bundle-ex-minimalProvideDocumentBundle.json</a> - I see the exact same errors as I see in my own project (<a href=\"#narrow/stream/179166-implementers/topic/validation.20quirks\">https://chat.fhir.org/#narrow/stream/179166-implementers/topic/validation.20quirks</a>). I've tried to change nuts and bolts but I cant get it to work</p>\n<p>The errors by the validator are the following:</p>\n<div class=\"codehilite\"><pre><span></span><code>FHIR Validation tool Version 5.2.13 (Git# 5f67b5bad03d). Built 2020-12-24T05:16:59.673Z (22 days old)\n  Java:   15 from /Library/Java/JavaVirtualMachines/adoptopenjdk-15.jdk/Contents/Home on x86_64 (64bit). 4096MB available\n  Paths:  Current = /Users/jvi/dk-medcom, Package Cache = /Users/jvi/.fhir/packages\n  Params: bundle.json -version 4.0 -ig http://build.fhir.org/ig/IHE/ITI.MHD/branches/master -profile http://ihe.net/fhir/ihe.mhd.fhir/StructureDefinition/IHE.MHD.Minimal.ProvideBundle\nLoading\n  Load FHIR v4.0 from hl7.fhir.r4.core#4.0.1 - 4575 resources (00:04.0901)\n  Load hl7.terminology#2.0.0 - 3749 resources (00:00.0987)\n  Terminology server http://tx.fhir.org - Version 1.9.369 (00:02.0081)\n  Load http://build.fhir.org/ig/IHE/ITI.MHD/branches/master - 33 resources (00:04.0633)\n  Get set...  go (00:00.0031)\nValidating\n  Profiles: [http://ihe.net/fhir/ihe.mhd.fhir/StructureDefinition/IHE.MHD.Minimal.ProvideBundle]\n  Validate bundle.json 00:00.0871\nDone. Times: Loading: 00:12.0989, validation: 00:00.0871\n\n*FAILURE*: 8 errors, 0 warnings, 1 notes\n  Error @ Bundle.entry[1].resource.ofType(List) (line 76, col19) : Multiple profiles found for contained resource. This is not supported at this time. (Type List: http://ihe.net/fhir/ihe.mhd.fhir/StructureDefinition/IHE.MHD.Minimal.Folder, http://ihe.net/fhir/ihe.mhd.fhir/StructureDefinition/IHE.MHD.Minimal.Folder)\n  Error @ Bundle.entry[2].resource.ofType(DocumentReference) (line 117, col31) : Multiple profiles found for contained resource. This is not supported at this time. (Type DocumentReference: http://ihe.net/fhir/ihe.mhd.fhir/StructureDefinition/IHE.MHD.Minimal.DocumentReference, http://ihe.net/fhir/ihe.mhd.fhir/StructureDefinition/IHE.MHD.UnContained.Comprehensive.DocumentReference, http://ihe.net/fhir/ihe.mhd.fhir/StructureDefinition/IHE.MHD.Comprehensive.DocumentReference)\n  Error @ Bundle.entry[0] (line 19, col6) : Slicing cannot be evaluated: Profile based discriminators must have a type with a profile (Bundle.entry:Documents.resource in profile http://ihe.net/fhir/ihe.mhd.fhir/StructureDefinition/IHE.MHD.Minimal.ProvideBundle)\n  Error @ Bundle.entry[0] (line 19, col6) : Slicing cannot be evaluated: Profile based discriminators must have a type with a profile (Bundle.entry:Patient.resource in profile http://ihe.net/fhir/ihe.mhd.fhir/StructureDefinition/IHE.MHD.Minimal.ProvideBundle)\n  Error @ Bundle.entry[1] (line 42, col6) : Slicing cannot be evaluated: Profile based discriminators must have a type with a profile (Bundle.entry:Documents.resource in profile http://ihe.net/fhir/ihe.mhd.fhir/StructureDefinition/IHE.MHD.Minimal.ProvideBundle)\n  Error @ Bundle.entry[1] (line 42, col6) : Slicing cannot be evaluated: Profile based discriminators must have a type with a profile (Bundle.entry:Patient.resource in profile http://ihe.net/fhir/ihe.mhd.fhir/StructureDefinition/IHE.MHD.Minimal.ProvideBundle)\n  Error @ Bundle.entry[2] (line 97, col6) : Slicing cannot be evaluated: Profile based discriminators must have a type with a profile (Bundle.entry:Documents.resource in profile http://ihe.net/fhir/ihe.mhd.fhir/StructureDefinition/IHE.MHD.Minimal.ProvideBundle)\n  Error @ Bundle.entry[2] (line 97, col6) : Slicing cannot be evaluated: Profile based discriminators must have a type with a profile (Bundle.entry:Patient.resource in profile http://ihe.net/fhir/ihe.mhd.fhir/StructureDefinition/IHE.MHD.Minimal.ProvideBundle)\n  Information @ Bundle (line 2, col2) : Bundle.entry:SubmissionSet: Unable to check minimum required (Bundle.entry) due to lack of slicing validation (from http://ihe.net/fhir/ihe.mhd.fhir/StructureDefinition/IHE.MHD.Minimal.ProvideBundle)\n</code></pre></div>",
        "id": 222895710,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1610732670
    },
    {
        "content": "<p>Looking at the generated structuredefs, it seems correct to me, but I could be wrong. <span class=\"user-mention\" data-user-id=\"191469\">@Chris Moesel</span> would you happen to have an example of a bundle being profiled where the discriminator.type is <code>#profile</code> and path is <code>resource</code>where the validator doesn't complain, that is done using FSH?</p>",
        "id": 222896035,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1610732824
    },
    {
        "content": "<p>here is my FSH profile details <a href=\"https://github.com/IHE/ITI.MHD/blob/master/input/fsh/provideBundle.fsh\">https://github.com/IHE/ITI.MHD/blob/master/input/fsh/provideBundle.fsh</a></p>",
        "id": 222925459,
        "sender_full_name": "John Moehrke",
        "timestamp": 1610744854
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"191427\">@Jens Villadsen</span> -- I haven't tried anything like that myself, but I think I recall seeing something like it in mCODE.  So... here's something in mCODE that might be what you're looking for?</p>\n<ul>\n<li><a href=\"https://github.com/HL7/fhir-mCODE-ig/blob/master/input/fsh/SD_Bundle.fsh\">MCODEPatientBundle SD</a></li>\n<li><a href=\"https://github.com/HL7/fhir-mCODE-ig/blob/master/input/fsh/EX_Scenario1_Bundle.fsh\">MCODEPatientBundle Example</a></li>\n</ul>\n<p>Note that the bundle SD uses the slicing definition <a href=\"https://github.com/HL7/fhir-mCODE-ig/blob/master/input/fsh/DEF_SlicingRules.fsh#L25-L29\">here</a>.  I haven't run it myself, but here's the <a href=\"http://build.fhir.org/ig/HL7/fhir-mCODE-ig/branches/radiation-procedure-redo/qa.html\">QA from the last auto build</a>.</p>",
        "id": 222940442,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1610753107
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191404\">@John Moehrke</span>  Here's the thing: the IG process/qa page doesn't flag the error. The errors shown above are from your IHE IG, John, using the validator on the example resources. Where the real issue is located I do not know</p>",
        "id": 222970831,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1610788364
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191469\">@Chris Moesel</span> running <code>curl http://build.fhir.org/ig/HL7/fhir-mCODE-ig/branches/master/Bundle-scenario1-mcode-patient-bundle.json -o mcode.json  &amp;&amp;  java -jar validator_cli.jar mcode.json -version 4.0 -ig http://build.fhir.org/ig/HL7/fhir-mCODE-ig -profile http://hl7.org/fhir/us/mcode/StructureDefinition/mcode-patient-bundle</code> works as intended. No errors there</p>",
        "id": 222973782,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1610792871
    },
    {
        "content": "<p>whoops - I'm sorry - I can see that I didn't inspect the <a href=\"http://build.fhir.org/ig/IHE/ITI.MHD/qa.html#_scratch_ig-build-temp-FDM7HC_repo_fsh-generated_resources_Bundle-ex-minimalProvideDocumentBundle\">http://build.fhir.org/ig/IHE/ITI.MHD/qa.html#_scratch_ig-build-temp-FDM7HC_repo_fsh-generated_resources_Bundle-ex-minimalProvideDocumentBundle</a> thoroughly as I can see that the QA page already complains. <span class=\"user-mention\" data-user-id=\"191404\">@John Moehrke</span> I assume this is part of your current issue.</p>",
        "id": 222987104,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1610810346
    },
    {
        "content": "<p>that is my current set of errors, not the ones I originally had.  </p>\n<p>I am not sure how to do what I need to do. I have a Bundle that can't contain anything other than 4 resource types, two of those must be specific profiles.  </p>\n<p>I have tried to have a core profile that just picked the four resources, then profiled that to further refine to the two profiles. But this fails in the IG build.</p>",
        "id": 223122649,
        "sender_full_name": "John Moehrke",
        "timestamp": 1610978415
    },
    {
        "content": "<p>So far - it seems like your errors <span class=\"user-mention\" data-user-id=\"191404\">@John Moehrke</span> are not directly related to mine. Mine seems to be focused on the fact that I've profiled the aggregation mode and my bundles are of type message. As you can see on my lates findings on <a href=\"#narrow/stream/179166-implementers/topic/validation.20quirks\">https://chat.fhir.org/#narrow/stream/179166-implementers/topic/validation.20quirks</a> , the Davinci IQ seems to have the same issues, but no one have responded yet. So my errors are probably not related to fsh</p>",
        "id": 223123401,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1610978766
    },
    {
        "content": "<p>I don't think mine are related to FSH either. except that when we all get these bundle profiling figured out, there will likely be some new features to be added to sushi</p>",
        "id": 223127339,
        "sender_full_name": "John Moehrke",
        "timestamp": 1610980694
    }
]