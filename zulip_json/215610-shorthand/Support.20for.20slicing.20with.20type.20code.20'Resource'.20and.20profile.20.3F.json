[
    {
        "content": "<p>We are working to convert our ch-core dependent ig's to sushi and like the tooling a lot, thanks a lot for that effort!</p>\n<p>We encounter a problem constraining profiled sliced entries in a bundle with slicing: </p>\n<p>We have a non Sushi ImplementationGuide and there the <a href=\"http://fhir.ch/ig/ch-core/StructureDefinition-ch-core-document.html\">slicing</a> is setup as following:</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code>     <span class=\"nt\">\"slicing\"</span> <span class=\"p\">:</span> <span class=\"p\">{</span>\n          <span class=\"nt\">\"discriminator\"</span> <span class=\"p\">:</span> <span class=\"p\">[</span>\n            <span class=\"p\">{</span>\n              <span class=\"nt\">\"type\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"profile\"</span><span class=\"p\">,</span>\n              <span class=\"nt\">\"path\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"resource\"</span>\n            <span class=\"p\">}</span>\n          <span class=\"p\">],</span>\n          <span class=\"nt\">\"rules\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"open\"</span>\n</code></pre></div>\n<p>a slice entry is then defined as:</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code>   <span class=\"p\">{</span>\n        <span class=\"nt\">\"id\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"Bundle.entry:Composition.resource\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"path\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"Bundle.entry.resource\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"min\"</span> <span class=\"p\">:</span> <span class=\"mi\">1</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"type\"</span> <span class=\"p\">:</span> <span class=\"p\">[</span>\n          <span class=\"p\">{</span>\n            <span class=\"nt\">\"code\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"Resource\"</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"profile\"</span> <span class=\"p\">:</span> <span class=\"p\">[</span>\n              <span class=\"s2\">\"http://fhir.ch/ig/ch-core/StructureDefinition/ch-core-composition\"</span>\n            <span class=\"p\">]</span>\n          <span class=\"p\">}</span>\n        <span class=\"p\">]</span>\n      <span class=\"p\">}</span>\n</code></pre></div>\n<p>the slicing entry type code  is set to 'Resource' according to testcase Grahame has setup for the <a href=\"#narrow/stream/179252-IG-creation/topic/profiling.20a.20transaction\">Java validator</a> and the setups works with our dependent non-sushi implementation guides for ch-core.</p>\n<p>The following problem surfaces now when changing the dependent ig to a sushi version:</p>\n<ol>\n<li>We want to restrict the slice with the composition, constraining that ch-orf-composition (dependent from ch-core-composition)<br>\nis used instead of ch-core-composition</li>\n</ol>\n<div class=\"codehilite\"><pre><span></span><code>* entry[Composition].resource only ChOrfComposition\n</code></pre></div>\n<p>Gives the <a href=\"http://build.fhir.org/ig/hl7ch/ch-orf/branches/fsh_slice_typeproblem/failure/build.log\">error</a>: <br>\nSushi: error The type \"ChOrfComposition\" does not match any of the allowed types: <a href=\"http://fhir.ch/ig/ch-core/StructureDefinition/ch-core-composition\">http://fhir.ch/ig/ch-core/StructureDefinition/ch-core-composition</a> (00:01.0533)</p>\n<p>We noticed that this error disappears if we fix the ch-core parent slice to </p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code>   <span class=\"p\">{</span>\n        <span class=\"nt\">\"id\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"Bundle.entry:Composition.resource\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"path\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"Bundle.entry.resource\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"min\"</span> <span class=\"p\">:</span> <span class=\"mi\">1</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"type\"</span> <span class=\"p\">:</span> <span class=\"p\">[</span>\n          <span class=\"p\">{</span>\n            <span class=\"nt\">\"code\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"Composition\"</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"profile\"</span> <span class=\"p\">:</span> <span class=\"p\">[</span>\n              <span class=\"s2\">\"http://fhir.ch/ig/ch-core/StructureDefinition/ch-core-composition\"</span>\n            <span class=\"p\">]</span>\n          <span class=\"p\">}</span>\n        <span class=\"p\">]</span>\n      <span class=\"p\">}</span>\n</code></pre></div>\n<p>(type.code to Composition instead of Resource), however this not the recommended setup to be used for slicing as indicated in the <a href=\"#narrow/stream/179252-IG-creation/topic/profiling.20a.20transaction\">zulip thread</a></p>\n<ol start=\"2\">\n<li>If we use sushi alone for slicing bundle entry the following differential is generated for the <a href=\"http://build.fhir.org/ig/ahdis/ch-ig/branches/bundle-entry-slice/StructureDefinition-slice-document.profile.json.html\">slice entries</a>:</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code>   <span class=\"p\">{</span>\n        <span class=\"nt\">\"id\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"Bundle.entry:TestComposition.resource\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"path\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"Bundle.entry.resource\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"min\"</span> <span class=\"p\">:</span> <span class=\"mi\">1</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"type\"</span> <span class=\"p\">:</span> <span class=\"p\">[</span>\n          <span class=\"p\">{</span>\n            <span class=\"nt\">\"code\"</span> <span class=\"p\">:</span> <span class=\"s2\">\"Composition\"</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"profile\"</span> <span class=\"p\">:</span> <span class=\"p\">[</span>\n              <span class=\"s2\">\"http://fhir.ch/ig/ch-ig/StructureDefinition/derived-composition\"</span>\n            <span class=\"p\">]</span>\n          <span class=\"p\">}</span>\n        <span class=\"p\">]</span>\n      <span class=\"p\">}</span>\n</code></pre></div>\n<p>Would it be possible to enhance sushi that 1) constraining of slices is allowed on type.code Resource and 2) that sushi generates the slicing with type.code Resource instead of the resource type?</p>\n<p>Thanks a lot for any feedback.</p>",
        "id": 232080812,
        "sender_full_name": "Oliver Egger",
        "timestamp": 1616841130
    },
    {
        "content": "<p>Thanks for the detailed description. To my eye, SUSHI should allow what you are doing here. It looks like we are overly restrictive on how we determine if a certain type can be used to constrain an existing type. I will log this as a bug, and we will work to fix this so that you can constrain the slice with the <code>type.code</code> set to <code>Resrouce</code>.</p>",
        "id": 232262031,
        "sender_full_name": "Nick Freiter",
        "timestamp": 1617022178
    },
    {
        "content": "<p>Here is the issue, for your reference: <a href=\"https://github.com/FHIR/sushi/issues/789\">https://github.com/FHIR/sushi/issues/789</a>.</p>",
        "id": 232262676,
        "sender_full_name": "Nick Freiter",
        "timestamp": 1617022452
    },
    {
        "content": "<p>I'm still wrapping my head around this issue.  I think the bug <span class=\"user-mention\" data-user-id=\"239822\">@Nick Freiter</span> logged is a good one and agree it should be fixed.  I believe that is request <code>1)</code> in <span class=\"user-mention\" data-user-id=\"191478\">@Oliver Egger</span>'s thread.</p>\n<p>Regarding request <code>2)</code>, however... I don't think I understand why the <code>type.code</code> must be <code>Resource</code> (not <code>Composition</code>) for this to validate.  I see that Grahame says it must be so, but I don't understand it.  When SUSHI processes an <code>only</code> rule, if the argument is a profile, SUSHI will narrow the <code>type.code</code> to the profile's type (in addition to adding the profile to <code>type.profile</code>).  I think that some authors expect this and it is definitely in use in some IGs. If we just switch the behavior to not affect <code>type.code</code> at all then we will be affecting other working IGs. So I'd like to understand it better before making such a change.</p>\n<p>Until then, have you tried any tricky workarounds like using the <code>^</code> syntax to set the type or profile instead of using an <code>only</code> rule?  For example, instead of:</p>\n<div class=\"codehilite\"><pre><span></span><code>* entry[Composition].resource only ChOrfComposition\n</code></pre></div>\n<p>have you tried:</p>\n<div class=\"codehilite\"><pre><span></span><code>* entry[Composition].resource ^type.profile = Canonical(ChOrfComposition)\n</code></pre></div>",
        "id": 232263965,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1617023035
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191469\">@Chris Moesel</span> thanks for following up. Regarding request 2) I can confirm that</p>\n<div class=\"codehilite\"><pre><span></span><code>* entry[Composition].resource ^type.profile = Canonical(ChOrfComposition)\n</code></pre></div>\n<p>sets only the profiles and leaves the code to 'Resource', so this is a very nice workaround (i am not a sushi chef yet :-)), thanks a lot.</p>\n<p>I have seen that you posted in the old zulip thread, so looking forward why it needs to be Resource and should not be the derived type.</p>",
        "id": 232270587,
        "sender_full_name": "Oliver Egger",
        "timestamp": 1617025724
    },
    {
        "content": "<p>the workaround works also for issue 1), thanks a lot <span class=\"user-mention\" data-user-id=\"191469\">@Chris Moesel</span></p>",
        "id": 232386525,
        "sender_full_name": "Oliver Egger",
        "timestamp": 1617090317
    }
]