[
    {
        "content": "<p>I ran into an issue with SUSHI and the IG Publisher which i believe is caused by the element order in the differential generated by SUSHI.<br>\nSo, the following FSH slices by target profile:</p>\n<div class=\"codehilite\"><pre><span></span><code>Profile:        LuFuBefund\nParent:         DiagnosticReport\nId:             lufu-befund\nTitle:          &quot;Lungenfunktions-Befund&quot;\nDescription:    &quot;Ein Befund, i.d.R. bestehend aus mehreren Messungen.&quot;\n\n//Slice result\n* result ^slicing.discriminator.type = #value\n* result ^slicing.discriminator.path = &quot;$this.resolve()&quot;\n* result ^slicing.rules = #open\n\n* result contains gewicht 0..1 and groesse 0..1 and geschlecht-geburt 0..1 and lufu-messwerte 1..*\n\n* result[gewicht] ^type.targetProfile = http://fhir.de/StructureDefinition/observation-de-vitalsign-koerpergewicht\n* result[groesse] ^type.targetProfile = http://fhir.de/StructureDefinition/observation-de-vitalsign-koerpergroesse\n* result[geschlecht-geburt] ^type.targetProfile = https://www.netzwerk-universitaetsmedizin.de/fhir/StructureDefinition/sex-assigned-at-birth\n* result[lufu-messwerte] ^type.targetProfile = https://fhir.miracum.org/uc2/StructureDefinition/lufu-observation\n</code></pre></div>\n<p>and is processed by SUSHI (v2.2.6) without errors but the IG Publisher (v ) fails with </p>\n<blockquote>\n<p>java.lang.Exception: Error generating snapshot for Lungenfunktions-Befund(lufu-befund): Unable to generate snapshot for <a href=\"https://fhir.miracum.org/uc2/StructureDefinition/lufu-befund\">https://fhir.miracum.org/uc2/StructureDefinition/lufu-befund</a> in C:\\Users\\deppenni\\MII\\miracum-igs\\uc2\\fsh-generated\\resources\\structuredefinition-lufu-befund<br>\n        at org.hl7.fhir.igtools.publisher.Publisher.generateSnapshots(Publisher.java:4824)<br>\n        at org.hl7.fhir.igtools.publisher.Publisher.loadConformance(Publisher.java:4108)<br>\n        at org.hl7.fhir.igtools.publisher.Publisher.createIg(Publisher.java:947)<br>\n        at org.hl7.fhir.igtools.publisher.Publisher.execute(Publisher.java:798)<br>\n        at org.hl7.fhir.igtools.publisher.Publisher.main(Publisher.java:9079)<br>\nCaused by: org.hl7.fhir.exceptions.FHIRException: Unable to generate snapshot for <a href=\"https://fhir.miracum.org/uc2/StructureDefinition/lufu-befund\">https://fhir.miracum.org/uc2/StructureDefinition/lufu-befund</a> in C:\\Users\\deppenni\\MII\\miracum-igs\\uc2\\fsh-generated\\resources\\structuredefinition-lufu-befund<br>\n        at org.hl7.fhir.igtools.publisher.Publisher.generateSnapshot(Publisher.java:4873)<br>\n        at org.hl7.fhir.igtools.publisher.Publisher.generateSnapshots(Publisher.java:4822)<br>\n        ... 4 more<br>\nCaused by: org.hl7.fhir.exceptions.DefinitionException: Das Differential hat kein Slice: DiagnosticReport.result/ (b:21 von 31 / 1/ 5) im Profil <a href=\"https://fhir.miracum.org/uc2/StructureDefinition/lufu-befund\">https://fhir.miracum.org/uc2/StructureDefinition/lufu-befund</a><br>\n        at org.hl7.fhir.r5.conformance.ProfileUtilities.processPaths(ProfileUtilities.java:1459)<br>\n        at org.hl7.fhir.r5.conformance.ProfileUtilities.generateSnapshot(ProfileUtilities.java:657)<br>\n        at org.hl7.fhir.igtools.publisher.Publisher.generateSnapshot(Publisher.java:4871)<br>\n        ... 5 more</p>\n</blockquote>\n<p>(Snapshot cannot be generated because  DiagnosticReport.result has no slice)<br>\nIf i look at the JSON generated by SUSHI, the element</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"p\">{</span>\n        <span class=\"nt\">\"id\"</span><span class=\"p\">:</span> <span class=\"s2\">\"DiagnosticReport.result\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"path\"</span><span class=\"p\">:</span> <span class=\"s2\">\"DiagnosticReport.result\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"slicing\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n          <span class=\"nt\">\"discriminator\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n            <span class=\"p\">{</span>\n              <span class=\"nt\">\"type\"</span><span class=\"p\">:</span> <span class=\"s2\">\"value\"</span><span class=\"p\">,</span>\n              <span class=\"nt\">\"path\"</span><span class=\"p\">:</span> <span class=\"s2\">\"$this.resolve()\"</span>\n            <span class=\"p\">}</span>\n          <span class=\"p\">],</span>\n          <span class=\"nt\">\"rules\"</span><span class=\"p\">:</span> <span class=\"s2\">\"open\"</span>\n        <span class=\"p\">},</span>\n        <span class=\"nt\">\"min\"</span><span class=\"p\">:</span> <span class=\"mi\">1</span>\n      <span class=\"p\">}</span>\n</code></pre></div>\n<p>exists, however is it the last element in the differential, while the individual slice definitions are at the beginning. If I move the \"DiagnosticReport.result\" element to the to start of the element list and pass the JSON to the IG Publisher directly, the IG is build without errors. So I assume SUSHI is generating elements in the wrong order here?</p>",
        "id": 268680833,
        "sender_full_name": "Noemi Deppenwiese",
        "timestamp": 1642679785
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"221444\">@Noemi Deppenwiese</span>.  SUSHI <em>should</em> put the elements in the right order.  I took your FSH and tried it in FSH Online (which also uses SUSHI 2.2.6) and it produced the elements in the correct order. See: <a href=\"https://fshschool.org/FSHOnline/#/share/3Kw25z2\">https://fshschool.org/FSHOnline/#/share/3Kw25z2</a></p>\n<p>Was that the complete example, exactly as you tried it, or did you remove some lines to keep the example short?  I'm just trying to understand why I cannot reproduce the problem.</p>",
        "id": 268692803,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1642686102
    },
    {
        "content": "<p>Ok weird. Yes, thats exactly my file content. I also tried moving the FSH file to a new folder and run SUSHI with FSHOnly: true, same (wrong element order) result. Also tried uninstalling and reinstalling SUSHI, same result... Maybe something in my npm is broken, I'll try reinstalling that next. Still, thank you!</p>",
        "id": 268695292,
        "sender_full_name": "Noemi Deppenwiese",
        "timestamp": 1642687121
    },
    {
        "content": "<p>Hmmm... What operating system are you on?  I was testing on Mac.</p>",
        "id": 268704444,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1642690874
    },
    {
        "content": "<p>And when you go to my FSH Online link above, does it come out in the right order for you there?</p>",
        "id": 268704958,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1642691046
    },
    {
        "content": "<p>Yes, FSHOnline works fine. I'm using Windows 10. Node.js un- and reinstall did nothing to fix it. I'll get a colleague to try it on their Windows machine to figure out whether it is Windows or just me....</p>",
        "id": 268708789,
        "sender_full_name": "Noemi Deppenwiese",
        "timestamp": 1642692374
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"221444\">Noemi Deppenwiese</span> <br>\nI tried it on a Linux machine, it build just fine. That's the result (picture)</p>\n<p>You might want to review your Java installation, perhaps? I would use the Amazon Corretto (based on OpenJDK but goes  through a certified testing process): </p>\n<p><a href=\"/user_uploads/10155/ylitpqL0JFh392r4ZlEPWG9G/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/ylitpqL0JFh392r4ZlEPWG9G/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/ylitpqL0JFh392r4ZlEPWG9G/image.png\"></a></div>",
        "id": 268833994,
        "sender_full_name": "Hank Lenzi",
        "timestamp": 1642767554
    },
    {
        "content": "<p>Ok, it is just me. My colleague got the correct order using the same node.js and sushi versions as I did. I still get the wrong order. No idea what else could be the cause. Seems like I have to reinstall my OS <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span> and switch to running the IG build in docker for now.<br>\n(My Java installation also seems to be ok (already using Amazon Coretto..))</p>",
        "id": 269128323,
        "sender_full_name": "Noemi Deppenwiese",
        "timestamp": 1643040645
    },
    {
        "content": "<p>Yeah, I am perplexed.  I'd love to help you, but I have no idea how.</p>",
        "id": 269574182,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1643291518
    }
]