[
    {
        "content": "<p>I'm trying to create slices on MessageHeader.focus to point to a couple of profiles in my IG and I've got the .fsh file looking like this (which I think is correct):</p>\n<ul>\n<li>focus ^slicing.discriminator.type = #pattern</li>\n<li>focus ^slicing.discriminator.path = \"reference\"</li>\n<li>focus ^slicing.rules = #open</li>\n<li>focus ^slicing.ordered = false</li>\n<li>focus ^slicing.description = \"Focus Resource types\"</li>\n<li>focus contains BDRPatient 1..1</li>\n<li>focus[BDRPatient] only Reference(BDRPatient)</li>\n<li>focus contains BDRReportableDiagnosis 1..*</li>\n<li>focus[BDRReportableDiagnosis] only Reference(BDRReportableDiagnosis)</li>\n</ul>\n<p>However, the IG ends up looking like this, where the overall cardinality of .focus is correct (2..*) but the cardinality of second slice is wrong:<br>\n<a href=\"/user_uploads/10155/DEJ7A-_wZa7nimyJVvNwGJxN/slice.jpg\">slice.jpg</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/DEJ7A-_wZa7nimyJVvNwGJxN/slice.jpg\" title=\"slice.jpg\"><img src=\"/user_uploads/10155/DEJ7A-_wZa7nimyJVvNwGJxN/slice.jpg\"></a></div>",
        "id": 198087301,
        "sender_full_name": "Craig Newman",
        "timestamp": 1589903824
    },
    {
        "content": "<p>Looking at the StructureDefinition, it seems to be missing the cardinality on the second slice<br>\n      {<br>\n        \"id\": \"MessageHeader.focus\",<br>\n        \"path\": \"MessageHeader.focus\",<br>\n        \"slicing\": {<br>\n          \"discriminator\": [<br>\n            {<br>\n              \"type\": \"pattern\",<br>\n              \"path\": \"reference\"<br>\n            }<br>\n          ],<br>\n          \"rules\": \"open\",<br>\n          \"ordered\": false,<br>\n          \"description\": \"Focus Resource types\"<br>\n        },<br>\n        \"min\": 2<br>\n      },<br>\n      {<br>\n        \"id\": \"MessageHeader.focus:BDRPatient\",<br>\n        \"path\": \"MessageHeader.focus\",<br>\n        \"sliceName\": \"BDRPatient\",<br>\n        \"min\": 1,<br>\n        \"max\": \"1\",<br>\n        \"type\": [<br>\n          {<br>\n            \"code\": \"Reference\",<br>\n            \"targetProfile\": [<br>\n              \"<a href=\"http://hl7.org/fhir/us/birthdefectreporting/StructureDefinition/bdr-patient\">http://hl7.org/fhir/us/birthdefectreporting/StructureDefinition/bdr-patient</a>\"<br>\n            ]<br>\n          }<br>\n       ]<br>\n      },<br>\n      {<br>\n        \"id\": \"MessageHeader.focus:BDRReportableDiagnosis\",<br>\n        \"path\": \"MessageHeader.focus\",<br>\n        \"sliceName\": \"BDRReportableDiagnosis\",<br>\n        \"type\": [<br>\n          {<br>\n            \"code\": \"Reference\",<br>\n            \"targetProfile\": [<br>\n              \"<a href=\"http://hl7.org/fhir/us/birthdefectreporting/StructureDefinition/bdr-reportablediagnosis\">http://hl7.org/fhir/us/birthdefectreporting/StructureDefinition/bdr-reportablediagnosis</a>\"<br>\n            ]<br>\n          }<br>\n        ]<br>\n      }<br>\n    ]<br>\n  }<br>\n}</p>",
        "id": 198087393,
        "sender_full_name": "Craig Newman",
        "timestamp": 1589903863
    },
    {
        "content": "<p>Have I messed up the .fsh file or is there maybe a problem in converting it to a StructureDefinition?</p>",
        "id": 198087552,
        "sender_full_name": "Craig Newman",
        "timestamp": 1589903895
    },
    {
        "content": "<p>Orthogonal from the FSH question: Normally, the focus would just point to the Condition - the Patient would hang off the Condition and not be a focus.  What is your event?</p>",
        "id": 198088215,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1589904165
    },
    {
        "content": "<p>The event is submission of a birth defect report to a jurisdictional program. There may be multiple reportable birth defect diagnoses in a message bundle but only a single patient. If the patient shouldn't be a focus, I can remove it. I just always think of the patient as central as well in a case like this.</p>",
        "id": 198088555,
        "sender_full_name": "Craig Newman",
        "timestamp": 1589904316
    },
    {
        "content": "<p>In an ADT message for a patient admit, the only focus would be the Encounter - even though you're probably sending 100+ resources.  Everything else is just linked somehow to that encounter (possibly through other resources).  Being 'important' has nothing to do with being a focus.  It's \"is this the focus of the event code\".</p>",
        "id": 198090796,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1589905321
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192758\">@Craig Newman</span> - I don't know why the cardinality is getting dropped on the 2nd slice. That looks like a bug in the SUSHI generation of the profile to me.  We'll have to try to reproduce this on our end.</p>\n<p>I'll add my own orthogonal comment as well -- I'm not sure that the discriminator is correct.  I think it may be more appropriate for the discriminator type to be <code>type</code> and the path to be <code>$this.resolve()</code>.  See: <a href=\"http://hl7.org/fhir/R4/profiling.html#discriminator\">http://hl7.org/fhir/R4/profiling.html#discriminator</a></p>",
        "id": 198093463,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1589906478
    },
    {
        "content": "<p>When using the <code>contains</code>, the more standard usage is to do:</p>\n<div class=\"codehilite\"><pre><span></span><code>* focus contains BDRPatient 1..1 and BDRReportableDiagnosis 1..*\n</code></pre></div>\n\n\n<p>instead of:</p>\n<div class=\"codehilite\"><pre><span></span><code>* focus contains BDRPatient 1..1\n* focus contains BDRReportableDiagnosis 1..*\n</code></pre></div>\n\n\n<p>However, I don't believe we have explicitly disallowed the second usage, so that should work correctly. So this is a bug, but for now using the first syntax shown will give you a workaround to that bug.</p>",
        "id": 198093637,
        "sender_full_name": "Nick Freiter",
        "timestamp": 1589906543
    },
    {
        "content": "<p>Thanks for the feedback. Given Lloyd's advice to limit .focus to the Condition, my original question is probably moot. I think now, rather than slicing, I can just restrict .focus to the reportable diagnosis profile Condition. Does this seem right?</p>\n<ul>\n<li>focus only Reference(&lt;Condition Profile&gt;)</li>\n</ul>",
        "id": 198094062,
        "sender_full_name": "Craig Newman",
        "timestamp": 1589906726
    },
    {
        "content": "<p>Yep -- that would work!  I'm glad we had this conversation though -- you uncovered a bug for us!  Thanks!</p>",
        "id": 198094219,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1589906793
    },
    {
        "content": "<p>And just for completeness, that bug is logged here: <a href=\"https://github.com/FHIR/sushi/issues/450\">https://github.com/FHIR/sushi/issues/450</a>.</p>",
        "id": 198094359,
        "sender_full_name": "Nick Freiter",
        "timestamp": 1589906850
    },
    {
        "content": "<p>I like to break things. I've been the idiot in many idiot-proofing activities. <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span><br>\nThanks for the quick feedback</p>",
        "id": 198094520,
        "sender_full_name": "Craig Newman",
        "timestamp": 1589906923
    },
    {
        "content": "<blockquote>\n<p>I've been the idiot in many idiot-proofing activities.</p>\n</blockquote>\n<p>I can empathise with that!</p>",
        "id": 198115445,
        "sender_full_name": "David Hay",
        "timestamp": 1589916746
    },
    {
        "content": "<p>Profile:        PatientDataBundle<br>\nParent:         Bundle<br>\nId:             PatientDataBundle</p>\n<p>I am trying to create a slice based on fullUrl for which I cannot fix the value or pattern. When trying validate the structure definition. I am getting error as below.<br>\nSingleValidationMessage[col=452,row=1,locationString=Parameters.parameter[0].resource.entry[0],message=Could not match discriminator ([fullUrl]) for slice Bundle.entry:Organization in profile <a href=\"http://labcorp.com/fhir/lvs-er/StructureDefinition/PatientDataBundle\">http://labcorp.com/fhir/lvs-er/StructureDefinition/PatientDataBundle</a> - the discriminator [fullUrl] does not have fixed value, binding or existence assertions,severity=error]</p>\n<p>Title:          \"PatientDataBundle\"<br>\nDescription:    \"Bundle for Patient Data that is a parameter within Input\"</p>\n<ul>\n<li>type = #collection</li>\n<li>entry ^slicing.discriminator.type = #value</li>\n<li>entry ^slicing.discriminator.path = \"fullUrl\"</li>\n<li>entry ^slicing.rules = #open</li>\n<li>entry ^slicing.ordered = false   // can be omitted, since false is the default</li>\n<li>entry ^slicing.description = \"Slice based on the entry.fullUrl pattern\"  // optional</li>\n<li>entry contains<br>\n    Organization 1..* and<br>\n    Practitioner 1..* and<br>\n    Patient 1..1 and<br>\n    ServiceRequest 1..1 and<br>\n    Encounter 1..* and<br>\n    DiagnosticReport 1..* and<br>\n    Observation 1..*</li>\n</ul>",
        "id": 198382694,
        "sender_full_name": "Gaurav Sharma",
        "timestamp": 1590098453
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"304287\">Gaurav Sharma</span> <a href=\"#narrow/stream/215610-shorthand/topic/slice.20cardinalities/near/198382694\">said</a>:</p>\n<blockquote>\n<p>Profile:        PatientDataBundle<br>\nParent:         Bundle<br>\nId:             PatientDataBundle</p>\n<p>I am trying to create a slice based on fullUrl for which I cannot fix the value or pattern. When trying validate the structure definition. I am getting error as below.<br>\nSingleValidationMessage[col=452,row=1,locationString=Parameters.parameter[0].resource.entry[0],message=Could not match discriminator ([fullUrl]) for slice Bundle.entry:Organization in profile <a href=\"http://labcorp.com/fhir/lvs-er/StructureDefinition/PatientDataBundle\">http://labcorp.com/fhir/lvs-er/StructureDefinition/PatientDataBundle</a> - the discriminator [fullUrl] does not have fixed value, binding or existence assertions,severity=error]</p>\n<p>Title:          \"PatientDataBundle\"<br>\nDescription:    \"Bundle for Patient Data that is a parameter within Input\"</p>\n<ul>\n<li>type = #collection</li>\n<li>entry ^slicing.discriminator.type = #value</li>\n<li>entry ^slicing.discriminator.path = \"fullUrl\"</li>\n<li>entry ^slicing.rules = #open</li>\n<li>entry ^slicing.ordered = false   // can be omitted, since false is the default</li>\n<li>entry ^slicing.description = \"Slice based on the entry.fullUrl pattern\"  // optional</li>\n<li>entry contains<br>\n    Organization 1..* and<br>\n    Practitioner 1..* and<br>\n    Patient 1..1 and<br>\n    ServiceRequest 1..1 and<br>\n    Encounter 1..* and<br>\n    DiagnosticReport 1..* and<br>\n    Observation 1..*</li>\n</ul>\n</blockquote>\n<p>My bad was trying to do wrong slicing. Changing to following worked fine.</p>\n<p>Profile:        PatientDataBundle<br>\nParent:         Bundle<br>\nId:             PatientDataBundle<br>\nTitle:          \"PatientDataBundle\"<br>\nDescription:    \"Bundle for Patient Data that is a parameter within Input\"</p>\n<ul>\n<li>type = #collection</li>\n<li>entry ^slicing.discriminator.type = #type</li>\n<li>entry ^slicing.discriminator.path = \"resource\"</li>\n<li>entry ^slicing.rules = #open</li>\n<li>entry ^slicing.ordered = false   // can be omitted, since false is the default</li>\n<li>entry ^slicing.description = \"Slice based on the entry.fullUrl pattern\"  // optional</li>\n<li>\n<p>entry contains<br>\n    Organization 1..* and<br>\n    Practitioner 1..* and<br>\n    Patient 1..1 and<br>\n    ServiceRequest 1..1 and<br>\n    Encounter 1..* and<br>\n    DiagnosticReport 1..* and<br>\n    Observation 1..*</p>\n</li>\n<li>\n<p>entry[Organization].resource only Organization</p>\n</li>\n<li>entry[Practitioner].resource only Practitioner</li>\n<li>entry[Patient].resource only Patient</li>\n<li>entry[ServiceRequest].resource only ServiceRequest</li>\n<li>entry[Encounter].resource only Encounter</li>\n<li>entry[DiagnosticReport].resource only DiagnosticReport</li>\n<li>entry[Observation].resource only Observation</li>\n</ul>",
        "id": 198389837,
        "sender_full_name": "Gaurav Sharma",
        "timestamp": 1590102710
    }
]