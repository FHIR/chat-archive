[
    {
        "content": "<p>Given a test IG I have -- <a href=\"https://github.com/JohnMoehrke/SlicingSlicedExtension\">https://github.com/JohnMoehrke/SlicingSlicedExtension</a><br>\nwhich I have simplified... but seems a slice inside an extension inside a slice is such that my examples can't use the slicename... I can't use my slice name of <code>npi</code> or <code>provider-id</code></p>\n<p>I want to say</p>\n<div class=\"codehilite\"><pre><span></span><code>* agent[user].extension[extOtherId][npi].valueIdentifier.type = http://terminology.hl7.org/CodeSystem/v2-0203#NPI\n* agent[user].extension[extOtherId][npi].valueIdentifier.value = &quot;1234567@myNPIregistry.example.org&quot;\n* agent[user].extension[extOtherId][provider-id].valueIdentifier.type = http://terminology.hl7.org/CodeSystem/v2-0203#PRN\n* agent[user].extension[extOtherId][provider-id].valueIdentifier.value = &quot;JohnD&quot;\n</code></pre></div>\n<p>but am forced to say</p>\n<div class=\"codehilite\"><pre><span></span><code>* agent[user].extension[extOtherId][+].valueIdentifier.type = http://terminology.hl7.org/CodeSystem/v2-0203#NPI\n* agent[user].extension[extOtherId][=].valueIdentifier.value = &quot;1234567@myNPIregistry.example.org&quot;\n* agent[user].extension[extOtherId][+].valueIdentifier.type = http://terminology.hl7.org/CodeSystem/v2-0203#PRN\n* agent[user].extension[extOtherId][=].valueIdentifier.value = &quot;JohnD&quot;\n</code></pre></div>",
        "id": 276102811,
        "sender_full_name": "John Moehrke",
        "timestamp": 1647891265
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"191404\">@John Moehrke</span>.  You've run into one of the few cases where ordering of statements does matter for SUSHI.  When you slice an element, SUSHI creates the slices using copies of that element with the constraints that were there <em>at the time it was sliced</em>.  If you add constraints to the base element <em>after</em> you've already sliced it, the slices will not take on those constraints.  This is a limitation of SUSHI, but there is a workaround.  Ensure that you define all constraints on the base slice <em>before</em> slicing it.</p>\n<p>So, in your example, instead of this:</p>\n<div class=\"codehilite\"><pre><span></span><code>* agent.extension contains OtherId named extOtherId 0..* MS\n// Here you are slicing agent *before* you sliced agent.extension, so these agent slices don&#39;t get the extension slices\n* agent ^slicing.discriminator.type = #pattern\n* agent ^slicing.discriminator.path = &quot;type&quot;\n* agent ^slicing.rules = #open\n* agent contains\n    user 1.. and\n    userorg 0..\n* agent[user].type = http://terminology.hl7.org/CodeSystem/v3-ParticipationType#IRCP &quot;information recipient&quot;\n* agent[user].who 1..1\n// Here is where you slice agent.extension, but it&#39;s just a little too late for SUSHI to add them to the slices\n* agent.extension[extOtherId] ^slicing.discriminator.type = #value\n* agent.extension[extOtherId] ^slicing.discriminator.path = &quot;type&quot;\n* agent.extension[extOtherId] ^slicing.rules = #open\n* agent.extension[extOtherId] contains\n    npi 0..1 and\n    provider-id 0..1\n* agent.extension[extOtherId][npi].valueIdentifier.type = http://terminology.hl7.org/CodeSystem/v2-0203#NPI\n* agent.extension[extOtherId][provider-id].valueIdentifier.type = http://terminology.hl7.org/CodeSystem/v2-0203#PRN\n* agent[userorg].type = http://terminology.hl7.org/CodeSystem/v3-RoleClass#PROV &quot;healthcare provider&quot;\n* agent[userorg].who 1..1\n</code></pre></div>\n<p>do this:</p>\n<div class=\"codehilite\"><pre><span></span><code>// Add all the constraints to agent FIRST\n* agent.extension contains OtherId named extOtherId 0..* MS\n* agent.extension[extOtherId] ^slicing.discriminator.type = #pattern\n* agent.extension[extOtherId] ^slicing.discriminator.path = &quot;value.type&quot;\n* agent.extension[extOtherId] ^slicing.rules = #open\n* agent.extension[extOtherId] contains\n    npi 0..1 and\n    provider-id 0..1\n* agent.extension[extOtherId][npi].valueIdentifier.type = http://terminology.hl7.org/CodeSystem/v2-0203#NPI\n* agent.extension[extOtherId][provider-id].valueIdentifier.type = http://terminology.hl7.org/CodeSystem/v2-0203#PRN\n// THEN slice it\n* agent ^slicing.discriminator.type = #pattern\n* agent ^slicing.discriminator.path = &quot;type&quot;\n* agent ^slicing.rules = #open\n* agent contains\n    user 1.. and\n    userorg 0..\n* agent[user].type = http://terminology.hl7.org/CodeSystem/v3-ParticipationType#IRCP &quot;information recipient&quot;\n* agent[user].who 1..1\n* agent[userorg].type = http://terminology.hl7.org/CodeSystem/v3-RoleClass#PROV &quot;healthcare provider&quot;\n* agent[userorg].who 1..1\n</code></pre></div>\n<p>This fixes the SUSHI issue (so you can reference the slices by name), but there are still IG Publisher issues w/ validation.  I've been looking into those too, but so far not making a ton of progress.</p>",
        "id": 276131479,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1647909448
    },
    {
        "content": "<p>Oh, I also had to fix <code>agent.extension[extOtherId]</code>'s discriminator type (<code>#value</code> --&gt; <code>#pattern</code>) and path (<code>type</code> --&gt; <code>value.type</code>).</p>",
        "id": 276132039,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1647910147
    },
    {
        "content": "<p>I've been able to fix some, but not all, of the QA errors by directly modifying the structure definition.  This was necessary because some of the issues were that the IG Publisher wants the differential to declare some properties that aren't really <em>different</em> -- and SUSHI is kind of a stickler for only putting truly <em>different</em> things into the differential.</p>\n<p>That got me down to 6 errors:</p>\n<ul>\n<li>Two of these: <code>Slicing cannot be evaluated: Could not match discriminator ([value.type]) for slice AuditEvent.agent:user.extension:extOtherId in profile http://johnmoehrke.github.io/SlicingSlicedExtension/StructureDefinition/ThirdSliceProfile - the discriminator [value.type] does not have fixed value, binding or existence assertions</code></li>\n<li>Two of these: <code>Profile http://johnmoehrke.github.io/SlicingSlicedExtension/StructureDefinition/ThirdSliceProfile, Element matches more than one slice - extOtherId, extOtherId/npi</code></li>\n<li>Two of these: <code>Profile http://johnmoehrke.github.io/SlicingSlicedExtension/StructureDefinition/ThirdSliceProfile, Element matches more than one slice - extOtherId, extOtherId/provider-id</code></li>\n</ul>\n<p>I can't figure out those first two (slicing cannot be evaluated) because as far as I can tell, the <code>value.type</code> is <em>definitely</em> fixed.  And the last four (matches more than one slice) seem like a bug in IGP to me -- it's not properly handling the re-slicing.  But I suspect this may actually be a consequence of those first two errors (i.e., it can't figure out how to evaluate the reslicing).</p>\n<p>I don't know where to go from here.  Here's my hand-modified structure definition for that profile: <a href=\"/user_uploads/10155/-6ad01xH9o-AfvhqstikG1h_/StructureDefinition-ThirdSliceProfile.json\">StructureDefinition-ThirdSliceProfile.json</a></p>",
        "id": 276132461,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1647910619
    },
    {
        "content": "<p>ah, so rearranging the order of the slicing definition here is unfortunate hack solution, as I really only want the otherId slice within a specific slice on agent.. I put this forward as I was hoping that using Identifier would have made the second slice easier.</p>",
        "id": 276176086,
        "sender_full_name": "John Moehrke",
        "timestamp": 1647949711
    }
]