[
    {
        "content": "<p>An issue came up when editing another projects  fsh tank. If there is a dependency in package.json labelled #dev, then sushi looks in the local cache to see if the package is there - failing if it can't find it. <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span>  has suggested that in this scenario sushi should 'fall back' to #current, and attempt to download it...</p>",
        "id": 194629249,
        "sender_full_name": "David Hay",
        "timestamp": 1587351197
    },
    {
        "content": "<p>that's what #dev is documented to mean</p>",
        "id": 194629362,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1587351367
    },
    {
        "content": "<p>OK, just found the referenced doc: <a href=\"https://confluence.hl7.org/pages/viewpage.action?pageId=35718627#IGPublisherDocumentation-DependencyList\" title=\"https://confluence.hl7.org/pages/viewpage.action?pageId=35718627#IGPublisherDocumentation-DependencyList\">https://confluence.hl7.org/pages/viewpage.action?pageId=35718627#IGPublisherDocumentation-DependencyList</a></p>\n<blockquote>\n<p>dev: use the latest local build of the IG. in the absence of a local build, this falls back to using the current version</p>\n</blockquote>\n<p>We'll look at this in SUSHI.  Thank you!</p>",
        "id": 194673725,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1587389008
    },
    {
        "content": "<p>OK, tracking it in SUSHI as <a href=\"https://github.com/FHIR/sushi/issues/374\" title=\"https://github.com/FHIR/sushi/issues/374\">#374</a>.</p>",
        "id": 194674097,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1587389175
    },
    {
        "content": "<p>So while trying to add support for automatically falling back to <code>#current</code>, we've discovered a difference in how SUSHI handles <code>#current</code> and how the IG Publisher seems to. With SUSHI, if  a dependency is specified as<code>#current</code>, then even if the desired package already exists in the local FHIR cache,  it is overwritten with the newest version found on <a href=\"https://build.fhir.org/ig/qas.json\" title=\"https://build.fhir.org/ig/qas.json\">https://build.fhir.org/ig/qas.json</a>, even if that newest version is exactly the same as what is already cached. We do not try to determine if the package has been updated or not, we just always overwrite.</p>\n<p>From some experimenting, it seems like when the IG Publisher sees a dependency that is specified as <code>#current</code>, it does not automatically overwrite that package if it already exists in the local cache. <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> , we were wondering if you could tell us how the IG Publisher determines what to do in this situation. If the IG Publisher uses a certain method for determining when a locally cached <code>#current</code> package needs to be overwritten, and when it does not, we would like to try to match that method in SUSHI.</p>",
        "id": 195210962,
        "sender_full_name": "Nick Freiter",
        "timestamp": 1587744945
    },
    {
        "content": "<p>being Australian, I am super concerned about bandwidth. (I've currently used 120G of my 80GB allowance 1/3 of the way through the month).</p>",
        "id": 195251305,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1587766897
    },
    {
        "content": "<p>pseudo code is :</p>\n<div class=\"codehilite\"><pre><span></span>  <span class=\"n\">NpmPackage</span> <span class=\"n\">npm</span> <span class=\"o\">=</span> <span class=\"n\">loadFromLocalCache</span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"p\">,</span> <span class=\"s\">&quot;current&quot;</span><span class=\"p\">);</span>\n  <span class=\"n\">Map</span><span class=\"o\">&lt;</span><span class=\"n\">PackageId</span><span class=\"p\">,</span> <span class=\"n\">URL</span><span class=\"o\">&gt;</span> <span class=\"n\">ciList</span> <span class=\"o\">=</span> <span class=\"n\">loadfrom</span><span class=\"p\">(</span><span class=\"s\">&quot;https://build.fhir.org/ig/qas.json&quot;</span><span class=\"p\">);</span>\n  <span class=\"n\">Json</span> <span class=\"n\">json</span> <span class=\"o\">=</span> <span class=\"n\">fetchJson</span><span class=\"p\">(</span><span class=\"n\">ciList</span><span class=\"p\">.</span><span class=\"na\">get</span><span class=\"p\">(</span><span class=\"n\">npm</span><span class=\"p\">.</span><span class=\"na\">name</span><span class=\"p\">())</span> <span class=\"o\">+</span> <span class=\"s\">&quot;/package.manifest.json&quot;</span><span class=\"p\">);</span>\n  <span class=\"n\">String</span> <span class=\"n\">currDate</span> <span class=\"o\">=</span> <span class=\"n\">json</span><span class=\"p\">.</span><span class=\"na\">getString</span><span class=\"p\">(</span><span class=\"s\">&quot;date&quot;</span><span class=\"p\">);</span>\n  <span class=\"n\">String</span> <span class=\"n\">packDate</span> <span class=\"o\">=</span> <span class=\"n\">npm</span><span class=\"p\">.</span><span class=\"na\">date</span><span class=\"p\">();</span>\n  <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">currDate</span><span class=\"p\">.</span><span class=\"na\">equals</span><span class=\"p\">(</span><span class=\"n\">packDate</span><span class=\"p\">))</span>\n      <span class=\"k\">return</span> <span class=\"n\">p</span><span class=\"p\">;</span>\n  <span class=\"k\">else</span>\n      <span class=\"n\">fetchFromCIBuild</span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"p\">);</span>\n</pre></div>",
        "id": 195252120,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1587767449
    },
    {
        "content": "<p>Great, thank you for the help! We will look to update that in SUSHI to help save some bandwidth. One more question, where does <code>npm.date()</code> pull the date from? Does it come from the package.json of the relevant package?</p>",
        "id": 195408699,
        "sender_full_name": "Nick Freiter",
        "timestamp": 1587990176
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> we have noticed an odd discrepancy between loading the package <code>hl7.fhir.us.core#3.1.0</code> with the IG Publisher vs with SUSHI. When SUSHI loads this package, it downloads it from <a href=\"http://packages.fhir.org/hl7.fhir.us.core/3.1.0\">packages.fhir.org/hl7.fhir.us.core/3.1.0</a>, and the folder that gets decompressed and added to the FHIR cache has this structure:<br>\n<a href=\"/user_uploads/10155/8sHQo3WYcDsTrpZLhXh_wvMz/image.png\">image.png</a> </p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/8sHQo3WYcDsTrpZLhXh_wvMz/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/8sHQo3WYcDsTrpZLhXh_wvMz/image.png\"></a></div><p>The above is the same structure you see if you visit <a href=\"http://packages.fhir.org/hl7.fhir.us.core/3.1.0\">packages.fhir.org/hl7.fhir.us.core/3.1.0</a> and decompress the downloaded package manually.</p>\n<p>But if we instead use the IG Publisher to add this package to the cache, the folder that gets decompressed and added to the cache has this structure:<br>\n<a href=\"/user_uploads/10155/KnRb_wRUEtbcj5W4L39lAbZL/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/KnRb_wRUEtbcj5W4L39lAbZL/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/KnRb_wRUEtbcj5W4L39lAbZL/image.png\"></a></div><p>And the <code>example</code>, <code>openapi</code>, <code>other</code>, and <code>xml</code> folders are nested within that <code>package</code> folder. This is the format we would expect based on the specification of FHIR NPM packages. So we are wondering:</p>\n<ol>\n<li>Is the IG Publisher getting that package from <a href=\"http://packages.fhir.org\">packages.fhir.org</a>?</li>\n<li>If yes, is the IG Publisher doing anything special to change the format of the package downloaded from <a href=\"http://packages.fhir.org\">packages.fhir.org</a>?</li>\n<li>If yes, do you expect it could be an issue if SUSHI <em>does not</em> change the format of the package in a similar way?</li>\n</ol>\n<p>Thank you for any insight!</p>",
        "id": 199502644,
        "sender_full_name": "Nick Freiter",
        "timestamp": 1591109013
    },
    {
        "content": "<p>There's history here. When we first wrote the NPM package specification, we said that these other folders would be peers of the <code>package</code> directory. And that's what you're seeing</p>",
        "id": 199556722,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1591133455
    },
    {
        "content": "<p>but in November last year, at DevDays in Amsterdam, it was pointed out in the Packages session that this is not conformant and they have to sub-folders of <code>package</code> not peers. It's too late to fix previously published packages but all new packages will have the folders as sub-folders. For consistency, those peer folders are turned into sub-folders when the package is installed into the local cache.</p>",
        "id": 199556914,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1591133584
    },
    {
        "content": "<p>I think it probably does matter that things are consistent. It might not matter to the java tools - they probably ignore the difference when reading the installed package too... not sure. but other tools will eventually run into this. probably. Or possibly, at least</p>",
        "id": 199557081,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1591133669
    },
    {
        "content": "<p>Interesting, thank you for the detailed explanation!</p>",
        "id": 199629119,
        "sender_full_name": "Nick Freiter",
        "timestamp": 1591195813
    },
    {
        "content": "<p>BTW -- <span class=\"user-mention\" data-user-id=\"239822\">@Nick Freiter</span> implemented the package restructuring in SUSHI here: <a href=\"https://github.com/FHIR/sushi/pull/482\">https://github.com/FHIR/sushi/pull/482</a></p>",
        "id": 201166126,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1592411383
    }
]