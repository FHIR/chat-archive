[
    {
        "content": "<p>I've been looking at config.yml, trying to set up preset endpoints and client info like the public Inferno PE site has for the Inferno Reference Server.  However the web UI isn't loading my presets.  Is there something I need to flip to enable the presets?  I skimmed config.yml but nothing jumped out at me.  Can someone post a working presets file (maybe the one in use by <a href=\"https://inferno.healthit.gov/inferno\">https://inferno.healthit.gov/inferno</a>)?    I skimmed <a href=\"https://github.com/onc-healthit/inferno-program/blob/ccb170f3c070cf7f318344fe6e9f211a33dc57c8/lib/app/views/index_onc_program.erb\">index_onc_program.erb</a>, and it looks like it should just be checking preset.present.  I don't know ruby well, but is \"present\" an existence check, or a property I need to set on the preset config?</p>",
        "id": 206725424,
        "sender_full_name": "Cooper Thompson",
        "timestamp": 1597253584
    },
    {
        "content": "<p>You <em>should</em> just be able to define it in the config.yml.</p>\n<p><a href=\"https://github.com/onc-healthit/inferno-program/blob/development/config.yml#L96\">e.g. this part of the config.yml for inferno-program</a></p>\n<p>Copied here for convenience:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"c1\"># preset fhir servers: optional. Minimally requires name, uri, module, optional inferno_uri, client_id, client_secret, scopes, instructions link</span>\n<span class=\"nt\">presets</span><span class=\"p\">:</span>\n  <span class=\"nt\">localhost_reference_server</span><span class=\"p\">:</span>\n    <span class=\"nt\">inferno_uri</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">http://localhost:4567</span>\n    <span class=\"nt\">name</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">Inferno Reference Server</span>\n    <span class=\"nt\">uri</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">https://inferno.healthit.gov/reference-server/r4</span>\n    <span class=\"nt\">module</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">onc_program</span>\n    <span class=\"nt\">client_id</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">SAMPLE_CONFIDENTIAL_CLIENT_ID</span>\n    <span class=\"nt\">confidential_client</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">true</span>\n    <span class=\"nt\">client_secret</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">SAMPLE_CONFIDENTIAL_CLIENT_SECRET</span>\n    <span class=\"nt\">onc_sl_url</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">https://inferno.healthit.gov/reference-server/r4</span>\n    <span class=\"nt\">onc_sl_client_id</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">SAMPLE_CONFIDENTIAL_CLIENT_ID</span>\n    <span class=\"nt\">onc_sl_confidential_client</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">true</span>\n    <span class=\"nt\">onc_sl_client_secret</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">SAMPLE_CONFIDENTIAL_CLIENT_SECRET</span>\n    <span class=\"nt\">onc_public_client_id</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">SAMPLE_PUBLIC_CLIENT_ID</span>\n    <span class=\"nt\">patient_ids</span><span class=\"p\">:</span> <span class=\"s\">&quot;76,185&quot;</span>\n</code></pre></div>\n\n\n<p>Note that the appropriate module must be enabled for the preset to appear.  So for the above example <code>onc_program</code> would need to be listed as a module.  (<a href=\"https://github.com/onc-healthit/inferno-program/blob/5f487cc0e37025aaa5dc288b39c1880e9e8bb866/config.yml#L44\">See here in the same config.yml</a>)</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"c1\"># module options: one or more must be set.  The first option in the list will be checked by default</span>\n<span class=\"nt\">modules</span><span class=\"p\">:</span>\n  <span class=\"p p-Indicator\">-</span> <span class=\"l l-Scalar l-Scalar-Plain\">onc_program</span>\n</code></pre></div>\n\n\n<p>Hopefully that helps!  We'll go back and update the wiki to add this information and make it more clear.</p>\n<p>Also yes <code>#present?</code> is an existence check (i.e. not nil, false, empty string, empty array, etc.).  You don't need to explicitly set it anywhere.</p>",
        "id": 206726774,
        "sender_full_name": "Reece Adamson",
        "timestamp": 1597254261
    },
    {
        "content": "<p>Hmm... I do have the onc_program module.  I'm basically just running the vanilla docker containers from the 1.1.0 release (d1c791e).  With no changes at all to config.yml, I don't get the UI widge for the preset selection at all (i.e. not even the Inferno Reference Server is an option).  I tried adding my own preset, but that that wasn't picked up either (unsurprisingly).</p>",
        "id": 206727555,
        "sender_full_name": "Cooper Thompson",
        "timestamp": 1597254711
    },
    {
        "content": "<p>I do know the config.yml is getting picked up - I updated the app_name and that change did get applied to the site.  I'll keep digging.</p>",
        "id": 206728090,
        "sender_full_name": "Cooper Thompson",
        "timestamp": 1597254947
    },
    {
        "content": "<p>hmmm.  Is it the only <code>module</code> you have set?  The preset selection looks a little different on program than community.  Look for \"Or test Inferno against a public sandbox\" under the URL input field.</p>\n<p>I just tried 1.1.0 (d1c791e) locally without any changes using <code>docker-compose up --build</code></p>\n<p>And I see:<br>\n<a href=\"/user_uploads/10155/xb75QKihgRskXruJSR0fUXUM/Inferno-Preset.gif\">Inferno-Preset.gif</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/xb75QKihgRskXruJSR0fUXUM/Inferno-Preset.gif\" title=\"Inferno-Preset.gif\"><img src=\"/user_uploads/10155/xb75QKihgRskXruJSR0fUXUM/Inferno-Preset.gif\"></a></div>",
        "id": 206733469,
        "sender_full_name": "Reece Adamson",
        "timestamp": 1597257530
    },
    {
        "content": "<p>Very strange.  I just did the following, and I don't get the preset selection:</p>\n<div class=\"codehilite\"><pre><span></span><code>curl -s -L https://api.github.com/repos/onc-healthit/inferno-program/releases/latest | jq -r &#39;.tarball_url&#39; | wget -O latest.tar.gz -i -\ntar -xzf latest.tar.gz\ncd onc-healthit-inferno-program-d1c791e/\n# I updated docker-compose.yml to bind to port 44567 instead of 4567 to avoid a port conflict, but that shouldn&#39;t affect anything.\ndocker-compose up --build\n</code></pre></div>\n\n\n<p>I then also updated the config.yml to change app_name to be 100% sure I was hitting the correct folder.</p>\n<p><a href=\"/user_uploads/10155/eYyd8en-cY4qPyEI7sMGGL0c/config.yml\">config.yml</a> <a href=\"/user_uploads/10155/iD7VyIZLX4_lbw9ighLbhzfv/docker-compose.yml\">docker-compose.yml</a> <a href=\"/user_uploads/10155/wxB7wyjFWoBePmDSF1ixNKT_/inferno-pe-no-presets.png\">inferno-pe-no-presets.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/wxB7wyjFWoBePmDSF1ixNKT_/inferno-pe-no-presets.png\" title=\"inferno-pe-no-presets.png\"><img src=\"/user_uploads/10155/wxB7wyjFWoBePmDSF1ixNKT_/inferno-pe-no-presets.png\"></a></div>",
        "id": 206738612,
        "sender_full_name": "Cooper Thompson",
        "timestamp": 1597260083
    },
    {
        "content": "<p>I think I've narrowed it down to this bit in endpoint.rb:</p>\n<div class=\"codehilite\"><pre><span></span><code>          presets = settings.presets.select do |_, v|\n            inferno_uri = v[&#39;inferno_uri&#39;]&amp;.chomp(&#39;/&#39;)\n            inferno_uri.nil? || inferno_uri == base_url || inferno_uri == base_url + base_path\n</code></pre></div>\n\n\n<p>Since I don't know Ruby or this syntax, I'm hoping you can help identify with what is going on.  After this line, the presets variable is null, and it then gets passed to index_onc_program as null.  However if I make an update to basically reset the presets to the raw settings.presets, the widget shows up:</p>\n<div class=\"codehilite\"><pre><span></span><code>          presets = settings.presets.select do |_, v|\n            inferno_uri = v[&#39;inferno_uri&#39;]&amp;.chomp(&#39;/&#39;)\n            inferno_uri.nil? || inferno_uri == base_url || inferno_uri == base_url + base_path\n          presets = settings.presets\n</code></pre></div>",
        "id": 206746235,
        "sender_full_name": "Cooper Thompson",
        "timestamp": 1597263713
    },
    {
        "content": "<p>Aha! Ok I think I found the issue.</p>\n<h2>To Fix It:</h2>\n<p>Go to the preset in your <code>config.yml</code> and change <code>inferno_uri</code> on line 98:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"gd\">-inferno_uri: http://localhost:4567</span>\n<span class=\"gi\">+inferno_uri: http://localhost:44567</span>\n</code></pre></div>",
        "id": 206746281,
        "sender_full_name": "Reece Adamson",
        "timestamp": 1597263723
    },
    {
        "content": "<p>What is going on here is that the <code>config.yml</code> is not documented well <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span> and there is no way you'd know this otherwise.  I created a ticket for us to update the docs for this.</p>\n<p>Really though the config lets you define different prefixes based on where Inferno is deployed.  You can see an <a href=\"https://github.com/onc-healthit/inferno/blob/development/config.yml#L58\">example of that in this config</a> where we have different presets set up based on whether or not its hosted at <code>localhost</code> or <code>inferno.healthit.gov</code>.</p>",
        "id": 206746557,
        "sender_full_name": "Reece Adamson",
        "timestamp": 1597263840
    },
    {
        "content": "<p>Ah - maybe we kinda got to the same place.  You only show presets that have the inferno_uri that matches the URL hosting the Inferno site?</p>",
        "id": 206746559,
        "sender_full_name": "Cooper Thompson",
        "timestamp": 1597263841
    },
    {
        "content": "<p>Yup exactly and you were looking in the right place!  Looks like it can also be left blank to apply for all situations.</p>",
        "id": 206747216,
        "sender_full_name": "Reece Adamson",
        "timestamp": 1597264171
    },
    {
        "content": "<p>Excellent! Got it working.  Thanks for the help!</p>",
        "id": 206747597,
        "sender_full_name": "Cooper Thompson",
        "timestamp": 1597264353
    },
    {
        "content": "<p>The reason for this is that often times you have different client registrations depending on deployment URL.  This certainly could be made more clear.</p>",
        "id": 206753574,
        "sender_full_name": "Robert Scanlon",
        "timestamp": 1597267189
    }
]