[
    {
        "content": "<p>Another question / potential issue with SLS-08: Token exchange response body contains required information encoded in JSON</p>",
        "id": 202115870,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1593190810
    },
    {
        "content": "<p><a href=\"/user_uploads/10155/mEuu3ctUZrTBq8Hejb1z8kh7/image.png\">image.png</a> <br>\nwhat does it look for to check if a patient id has been provided?</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/mEuu3ctUZrTBq8Hejb1z8kh7/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/mEuu3ctUZrTBq8Hejb1z8kh7/image.png\"></a></div>",
        "id": 202115924,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1593190850
    },
    {
        "content": "<p>I was under the impression that the patient id would be denoted by a \"patient\" claim in the access token and I verified the token I'm getting back includes a patient claim:</p>\n<div class=\"codehilite\"><pre><span></span><code>{\n  &quot;exp&quot;: 1593119295,\n  &quot;iat&quot;: 1593118995,\n  &quot;auth_time&quot;: 1593118152,\n  &quot;jti&quot;: &quot;...&quot;,\n  &quot;iss&quot;: &quot;...,\n  &quot;sub&quot;: &quot;...&quot;,\n  &quot;typ&quot;: &quot;Bearer&quot;,\n  &quot;azp&quot;: &quot;inferno&quot;,\n  &quot;session_state&quot;: &quot;...&quot;,\n  &quot;acr&quot;: &quot;0&quot;,\n  &quot;scope&quot;: &quot;openid offline_access patient/*.* user/*.* launch profile launch/patient&quot;,\n  &quot;patient&quot;: &quot;1234&quot;,\n  &quot;name&quot;: &quot;testy mctestface&quot;,\n}\n</code></pre></div>",
        "id": 202116134,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1593190967
    },
    {
        "content": "<p>am I doing it wrong?</p>",
        "id": 202116215,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1593191017
    },
    {
        "content": "<p>We are expecting a patient context in the token exchange.  Is this the access token?  If so, we do not check the content of the access token because it is opaque to the client (unlike the id_token).  You can check the request/response in the previous step to see if the patient context is provided in the token exchange.</p>",
        "id": 202138536,
        "sender_full_name": "Robert Scanlon",
        "timestamp": 1593203203
    },
    {
        "content": "<p>For example:</p>\n<p><a href=\"/user_uploads/10155/PKrtcpXOV01hyWQc4xDjp9qt/Screen-Shot-2020-06-26-at-4.24.49-PM.png\">Screen-Shot-2020-06-26-at-4.24.49-PM.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/PKrtcpXOV01hyWQc4xDjp9qt/Screen-Shot-2020-06-26-at-4.24.49-PM.png\" title=\"Screen-Shot-2020-06-26-at-4.24.49-PM.png\"><img src=\"/user_uploads/10155/PKrtcpXOV01hyWQc4xDjp9qt/Screen-Shot-2020-06-26-at-4.24.49-PM.png\"></a></div>",
        "id": 202138630,
        "sender_full_name": "Robert Scanlon",
        "timestamp": 1593203266
    },
    {
        "content": "<p>oh, interesting, i thought the patient was a claim to include in the token, not an attribute to include in the body of the token response...re-reading <a href=\"http://www.hl7.org/fhir/smart-app-launch/#step-3-app-exchanges-authorization-code-for-access-token\">http://www.hl7.org/fhir/smart-app-launch/#step-3-app-exchanges-authorization-code-for-access-token</a> I guess I had that wrong...but then how does the resource server which is servicing the request to know which patient is making the request?</p>",
        "id": 202139081,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1593203504
    },
    {
        "content": "<p>The purpose of the patient context is to communicate to the client which patient id to use in queries, because it cannot inspect the content of the bearer token (and you wouldn't want a user to have to tell the app they are using what patient ID to use, better to have the authorization service communicate that to the app).  You certainly would want to somehow associate authorization information with the bearer token also so the resource server can determine if it should grant access to the resource requested.  But how to do it is up to you.  You could encode it within the bearer token somehow (as it appears you have done here), or have the resource server query some kind of introspection service / data store.</p>",
        "id": 202139793,
        "sender_full_name": "Robert Scanlon",
        "timestamp": 1593203927
    },
    {
        "content": "<p>interesting</p>",
        "id": 202140182,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1593204186
    },
    {
        "content": "<p>FWIW JWTs aren't encrypted, they are just base64-encoded and cryptographically signed to prevent tampering</p>",
        "id": 202140189,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1593204194
    },
    {
        "content": "<p>anyone can inspect a JWT</p>",
        "id": 202140199,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1593204200
    },
    {
        "content": "<p>Right, I meant that it cannot assume a standard encoding.  Not all servers will use JWTs for bearer tokens, and that's ok.</p>",
        "id": 202140294,
        "sender_full_name": "Robert Scanlon",
        "timestamp": 1593204249
    },
    {
        "content": "<p>thanks for clearing up this fundamental misunderstanding i had with SMART...I had assumed user info would be in the id_token (or available from the userinfo endpoint on the auth server) and that the patient id was really needed in the bearer token itself</p>",
        "id": 202140400,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1593204327
    },
    {
        "content": "<p>Yes, id_token is for \"user\" information (who you are).  The bearer token signals what the app has been granted access to.  And the context parameters (patient, encounter) gives the app a enough information to make queries that are useful to the user of the app.</p>",
        "id": 202141718,
        "sender_full_name": "Robert Scanlon",
        "timestamp": 1593205141
    }
]