[
    {
        "content": "<p>Hi </p>\n<p>I need some help in bulk export. (IBM FHIR Server)</p>\n<p>I am getting this error. I am using storageProviders type as file</p>\n<p>{<br>\n\"resourceType\": \"OperationOutcome\",<br>\n\"id\": \"c0-a8-0-69-5031ca80-1f6a-49b1-af4a-dfc757338946\",<br>\n\"issue\": [<br>\n{<br>\n\"severity\": \"fatal\",<br>\n\"code\": \"not-supported\",<br>\n\"details\": {<br>\n\"text\": \"storageType is disallowed, error processing request\"<br>\n},<br>\n\"expression\": [<br>\n\"&lt;empty&gt;\"<br>\n]<br>\n}<br>\n]<br>\n}</p>\n<p>And here is my configuration</p>\n<p>\"storageProviders\": {<br>\n\"default\": {<br>\n\"type\": \"file\",<br>\n\"_type\": \"ibm-cos|aws-s3|file|https\",<br>\n\"validBaseUrls\": [],<br>\n\"fileBase\": \"C:/Projects/Code/FHIR/IBM/liberty-runtime/wlp/usr/servers/fhir-server/output\",<br>\n\"bucketName\": \"fhir-performance\",<br>\n\"location\": \"us\",<br>\n\"endpointInternal\": \"<a href=\"https://s3.us-east.cloud-object-storage.appdomain.cloud\">https://s3.us-east.cloud-object-storage.appdomain.cloud</a>\",<br>\n\"endpointExternal\": \"<a href=\"https://s3.us-east.cloud-object-storage.appdomain.cloud\">https://s3.us-east.cloud-object-storage.appdomain.cloud</a>\",<br>\n\"auth\": {<br>\n\"type\": \"hmac\",<br>\n\"accessKeyId\": \"key\",<br>\n\"secretAccessKey\": \"secret\"<br>\n},<br>\n\"_iam_auth\": {<br>\n\"type\": \"iam\",<br>\n\"iamApiKey\": \"apiKey\",<br>\n\"iamResourceInstanceId\": \"resourceId\"<br>\n},</p>",
        "id": 244715785,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1625238372
    },
    {
        "content": "<p>Are you subscribed in <a class=\"stream\" data-stream-id=\"212434\" href=\"/#narrow/stream/212434-ibm\">#ibm</a> ? I'll migrate this question over there.</p>",
        "id": 244732095,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1625246061
    },
    {
        "content": "<p>This topic was moved here from <a class=\"stream-topic\" data-stream-id=\"179250\" href=\"/#narrow/stream/179250-bulk-data/topic/NDJSON.20Resource.20Expectations\">#bulk data &gt; NDJSON Resource Expectations</a> by <span class=\"user-mention silent\" data-user-id=\"191315\">Josh Mandel</span></p>",
        "id": 244732142,
        "sender_full_name": "Notification Bot",
        "timestamp": 1625246091
    },
    {
        "content": "<p>Please try this... </p>\n<div class=\"codehilite\"><pre><span></span><code>curl -k -u &quot;fhiruser:change-password&quot; -H &quot;Content-Type: application/fhir+json&quot; \\\n    -X GET &#39;https://localhost:9443/fhir-server/api/v4/$export?_outputFormat=application/fhir%2Bndjson&amp;_type=Patient&#39; -v\n</code></pre></div>",
        "id": 244960723,
        "sender_full_name": "Paul Bastide",
        "timestamp": 1625507309
    },
    {
        "content": "<p>Hi</p>\n<p>For enabling smart module, are there any changes apart from fhir-server-config.json?<br>\nWe are testing with inferno testing tool and facing some issues.</p>\n<p>Thanks<br>\nMahesh</p>",
        "id": 245317612,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1625753160
    },
    {
        "content": "<p>yes, the fhir-smart module extends the ibm fhir server for this use case but its not prepackaged.  its a little confusing.</p>",
        "id": 245331334,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1625758651
    },
    {
        "content": "<p>the documentation is in 5.3.3 under <a href=\"https://ibm.github.io/FHIR/guides/FHIRServerUsersGuide#53-openid-connect-and-oauth-20\">https://ibm.github.io/FHIR/guides/FHIRServerUsersGuide#53-openid-connect-and-oauth-20</a></p>",
        "id": 245331500,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1625758716
    },
    {
        "content": "<p>so there's sort of three parts:</p>\n<ol>\n<li>configuring liberty to validate the tokens.  this can be skipped if the tokens are validated in front of the server</li>\n<li>advertising support (this is what is done through the fhir-server-config file)</li>\n<li>dropping the fhir-smart jar file into the server's userlib directory</li>\n</ol>",
        "id": 245331617,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1625758770
    },
    {
        "content": "<p>Ok great I will try that. Also can we change the certificate? Seems that inferno testing tool doesn't like self signed s=certificate. Do you have any steps for that? </p>\n<p>As we were testing some steps about security, we wanted to set security policy such that only few APIs are allowed e.g. Patient, Problem and Medication scopes. If we set that through OAuth then still it exposes other scopes also whereas it should not.</p>\n<p>Thanks<br>\nMahesh</p>",
        "id": 245345314,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1625765585
    },
    {
        "content": "<p>Yes, you can change the certificate.  The docs for that are at <a href=\"https://ibm.github.io/FHIR/guides/FHIRServerUsersGuide#5231-configure-the-keystores\">https://ibm.github.io/FHIR/guides/FHIRServerUsersGuide#5231-configure-the-keystores</a> but we mostly just rely on what Liberty provides for this.  If you happen to be running on Kubernetes, we might be able to offer some more guidance.</p>",
        "id": 245362382,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1625773736
    },
    {
        "content": "<blockquote>\n<p>We wanted to set security policy such that only few APIs are allowed e.g. Patient, Problem and Medication scopes. If we set that through OAuth then still it exposes other scopes also whereas it should not.</p>\n</blockquote>\n<p>the SMART auth server is what adds the scopes to the token.  THe IBM FHIR Server fhir-smart module should properly enforce the granted SMART scopes.<br>\nIts not clear to me which of those 2 you're having an issue with.  If you think the IBM FHIR Server (with the fhir-smart jar in the userlib) is returning resources it shouldn't, do let us know.</p>",
        "id": 245362561,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1625773806
    },
    {
        "content": "<p>seperately, its possible to restrict the IBM FHIR Server's REST api to select interactions on select resources types...if that is something you are interested in i can provide more info</p>",
        "id": 245362787,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1625773913
    },
    {
        "content": "<p>Hi Lee thanks a lot for detailed explanation. <a href=\"https://inferno.healthit.gov/inferno\">https://inferno.healthit.gov/inferno</a> is the tool where are are testing FHIR Apis. Also we dropped in fhir-smart-4.8.3.pom<br>\nfhir-smart-4.8.3.jar and some dependencies in userlib directory. Still getting some errors. Has anybody tested with Inferno? What changes are required to get it going with inferno? Does anybody has steps?</p>\n<p>Thanks<br>\nMahesh</p>",
        "id": 245429421,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1625829035
    },
    {
        "content": "<p>I will anyway put any issues as we face it while testing</p>",
        "id": 245432633,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1625831415
    },
    {
        "content": "<p><strong>REQUEST: For allergy it fails</strong><br>\n<a href=\"http://3.92.187.231:9443/fhir-server/api/v4/AllergyIntolerance?patient=17a818c38f8-229c1e6d-26a8-4b4a-aa8b-4bc81582bf4c\">http://3.92.187.231:9443/fhir-server/api/v4/AllergyIntolerance?patient=17a818c38f8-229c1e6d-26a8-4b4a-aa8b-4bc81582bf4c</a></p>\n<p>RESPONSE:<br>\n{<br>\n  \"resourceType\": \"OperationOutcome\",<br>\n  \"issue\": [<br>\n    {<br>\n      \"severity\": \"fatal\",<br>\n      \"code\": \"invalid\",<br>\n      \"details\": {<br>\n        \"text\": \"Fault: 'com.ibm.fhir.search.parameters.QueryParameter com.ibm.fhir.search.util.SearchUtil.buildInclusionCriteria(java.lang.String, java.util.Set, java.lang.String)'\"<br>\n      }<br>\n    }<br>\n  ]<br>\n}</p>\n<p>Caused by: java.lang.NoSuchMethodError: 'com.ibm.fhir.search.parameters.QueryParameter com.ibm.fhir.search.util.SearchUtil.buildInclusionCriteria(java.lang.String, java.util.Set, java.lang.String)'<br>\n    at com.ibm.fhir.smart.AuthzPolicyEnforcementPersistenceInterceptor.beforeSearch(AuthzPolicyEnforcementPersistenceInterceptor.java:162)<br>\n    at com.ibm.fhir.persistence.interceptor.impl.FHIRPersistenceInterceptorMgr.fireBeforeSearchEvent(FHIRPersistenceInterceptorMgr.java:175)<br>\n    at com.ibm.fhir.server.util.FHIRRestHelper.doSearch(FHIRRestHelper.java:1058)<br>\n    at com.ibm.fhir.server.util.FHIRRestHelper.doSearch(FHIRRestHelper.java:999)<br>\n    at com.ibm.fhir.server.resources.Search.doSearch(Search.java:73)<br>\n    at com.ibm.fhir.server.resources.Search.searchGet(Search.java:51)<br>\n    at com.ibm.fhir.server.resources.Search$Proxy$_$$_WeldClientProxy.searchGet(Unknown Source)<br>\n    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br>\n    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)<br>\n    at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)<br>\n    at java.base/java.lang.reflect.Method.invoke(Method.java:566)<br>\n    at com.ibm.ws.jaxrs20.cdi.component.JaxRsFactoryImplicitBeanCDICustomizer.serviceInvoke(JaxRsFactoryImplicitBeanCDICustomizer.java:342)<br>\n    at com.ibm.ws.jaxrs20.server.LibertyJaxRsServerFactoryBean.performInvocation(LibertyJaxRsServerFactoryBean.java:641)<br>\n    at com.ibm.ws.jaxrs20.server.LibertyJaxRsInvoker.performInvocation(LibertyJaxRsInvoker.java:160)<br>\n    at org.apache.cxf.service.invoker.AbstractInvoker.invoke(AbstractInvoker.java:101)</p>\n<p><strong>FOR DEVICE IT WORKS</strong><br>\n<a href=\"http://3.92.187.231:9443/fhir-server/api/v4/Device?patient=17a818c38f8-229c1e6d-26a8-4b4a-aa8b-4bc81582bf4c\">http://3.92.187.231:9443/fhir-server/api/v4/Device?patient=17a818c38f8-229c1e6d-26a8-4b4a-aa8b-4bc81582bf4c</a></p>",
        "id": 245435337,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1625833274
    },
    {
        "content": "<p>Do I need to so some config changes?</p>",
        "id": 245435352,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1625833287
    },
    {
        "content": "<p>Thats kind of a weird error.  Please make sure the version of <code>fhir-smart</code> you are using matches the version of the IBM FHIR Server that you're using.</p>",
        "id": 245445823,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1625838750
    },
    {
        "content": "<p>We've done some testing with inferno, although we found that the program edition didn't test what we were most interested in and so we've mostly used the community edition.</p>",
        "id": 245445906,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1625838799
    },
    {
        "content": "<p>Yeah that is same 4.8.3 both way. It seems that there are some dependencies or configuration settings which are causing issues. I found some issues similar to this. Not sure whether we need to make changes in search config file.</p>\n<p><a href=\"https://github.com/IBM/FHIR/issues/300\">https://github.com/IBM/FHIR/issues/300</a></p>\n<p>BTW without Smart it works fine to get all the resources, but again it is wide open. Smart FHIR gives security but never returns required resources.</p>",
        "id": 245446966,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1625839301
    },
    {
        "content": "<p><a href=\"/user_uploads/10155/reVsp4nCAxlnssSWZchNVIjz/extension-search-parameters.json\">extension-search-parameters.json</a> <a href=\"/user_uploads/10155/_7o2On8qSUd1_XCTsmLBWr7m/fhir-server-config.json\">fhir-server-config.json</a></p>",
        "id": 245447898,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1625839682
    },
    {
        "content": "<p><a href=\"https://github.com/IBM/FHIR/issues/300\">https://github.com/IBM/FHIR/issues/300</a> is quite different from a NoSuchMethodError:</p>",
        "id": 245448524,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1625840013
    },
    {
        "content": "<p>one place we've used for testing our fhir server together with keycloak for smart app launch is <a href=\"https://github.com/Alvearie/health-patterns/tree/main/data-access\">https://github.com/Alvearie/health-patterns/tree/main/data-access</a></p>",
        "id": 245448721,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1625840111
    },
    {
        "content": "<p>i've been meaning to point inferno at that demo setup for a while but havn't gotten to it yet.  perhaps it could be of some use as an example.</p>",
        "id": 245448766,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1625840143
    },
    {
        "content": "<p>here are the libs used in that env:</p>\n<div class=\"codehilite\"><pre><span></span><code>$ ls fhir/userlib\ncommons-codec-1.14.jar         fhir-smart-4.8.3.jar           jackson-core-2.11.0.jar        java-jwt-3.13.0.jar\nfhir-ig-us-core-4.8.3.jar      jackson-annotations-2.11.0.jar jackson-databind-2.11.0.jar\n</code></pre></div>\n<p>(my PR to bring it to 4.8.3 just got merged)</p>",
        "id": 245449661,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1625840615
    },
    {
        "content": "<p>oh we have java-jwt-3.13.0.pom, java-jwt-3.13.0.jar, fhir-smart-4.8.3.pom and fhir-smart-4.8.3.jar files only. Where I can find rest of jar files?</p>",
        "id": 245451707,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1625841539
    },
    {
        "content": "<p>i use maven to get them</p>",
        "id": 245451765,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1625841578
    },
    {
        "content": "<p>/home/ubuntu/liberty-runtime/wlp/usr/servers/fhir-server/userlib this is my folder</p>",
        "id": 245451774,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1625841586
    },
    {
        "content": "<p>oh ok let me search there and get them one by one and try out. the .pom files are needed right?</p>",
        "id": 245451908,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1625841629
    },
    {
        "content": "<p>here's the pom for this demo env:  <a href=\"https://github.com/lmsurpre/health-patterns/blob/main/data-access/pom.xml\">https://github.com/lmsurpre/health-patterns/blob/main/data-access/pom.xml</a></p>",
        "id": 245451936,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1625841648
    },
    {
        "content": "<p>with a pom like that you can just mvn clean install and it will copy the transitive dependencies</p>",
        "id": 245451969,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1625841668
    },
    {
        "content": "<p>obviously its just one way to do it though</p>",
        "id": 245451996,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1625841685
    },
    {
        "content": "<p>Seems that following code is throwing error</p>\n<p><a href=\"https://github.com/IBM/FHIR/blob/main/fhir-smart/src/main/java/com/ibm/fhir/smart/AuthzPolicyEnforcementPersistenceInterceptor.java\">https://github.com/IBM/FHIR/blob/main/fhir-smart/src/main/java/com/ibm/fhir/smart/AuthzPolicyEnforcementPersistenceInterceptor.java</a></p>\n<div class=\"codehilite\"><pre><span></span><code>                    // Build the Patient compartment inclusion criteria search parameter\n</code></pre></div>\n\n<p><strong>                        QueryParameter inclusionCriteria = SearchUtil.buildInclusionCriteria(PATIENT, patientIdFromToken, event.getFhirResourceType());</strong></p>\n<p>Anything to do with compartment config?</p>\n<p>Mahesh</p>",
        "id": 245467640,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1625849412
    },
    {
        "content": "<p>While getting device using </p>\n<p><a href=\"http://3.92.187.231:9443/fhir-server/api/v4/Device?patient=17a818c38f8-229c1e6d-26a8-4b4a-aa8b-4bc81582bf4c\">http://3.92.187.231:9443/fhir-server/api/v4/Device?patient=17a818c38f8-229c1e6d-26a8-4b4a-aa8b-4bc81582bf4c</a></p>\n<p>We are getting following warning, see if it can give some clue about some configuration issue?</p>\n<p>Found multiple resource-specific search parameters, '<a href=\"http://hl7.org/fhir/us/core/SearchParameter/us-core-device-patient\">http://hl7.org/fhir/us/core/SearchParameter/us-core-device-patient</a>' and '<a href=\"http://hl7.org/fhir/SearchParameter/Device-patient\">http://hl7.org/fhir/SearchParameter/Device-patient</a>', for code 'patient' on resource type 'Device'; use search parameter filtering to disambiguate. Using '<a href=\"http://hl7.org/fhir/us/core/SearchParameter/us-core-device-patient\">http://hl7.org/fhir/us/core/SearchParameter/us-core-device-patient</a>'.</p>\n<p>Thanks<br>\nMahesh</p>",
        "id": 245468414,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1625849782
    },
    {
        "content": "<p><a href=\"https://github.com/IBM/FHIR/blob/main/fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java\">https://github.com/IBM/FHIR/blob/main/fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java</a> line 318 is generating warning mentioned above.</p>",
        "id": 245469766,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1625850343
    },
    {
        "content": "<p>wrt the warning, thats saying that you have multiple search parameters that share a common code.  this is an unfortunate consequence of IGs like US Core redefining the search parameters that come with the base spec.<br>\nsince they use exactly the same expression, you can probably just ignore the warning.<br>\notherwise, if you want to make the warning go away, you can add \"search parameter disambiguation\" to your fhir-server-config.  for example, for this specific search parameter, the following config tells the server to use the base spec's search parameter definition:  <a href=\"https://github.com/IBM/FHIR/blob/main/demo/fhir/config/default/fhir-server-config.json#L60\">https://github.com/IBM/FHIR/blob/main/demo/fhir/config/default/fhir-server-config.json#L60</a></p>",
        "id": 245481963,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1625856284
    },
    {
        "content": "<p>So our situation right now is</p>\n<p>with samrt-fhir jar files and dependencies, only patient export works, allergies and all other are not working due to error </p>\n<p>QueryParameter inclusionCriteria = SearchUtil.buildInclusionCriteria(PATIENT, patientIdFromToken, event.getFhirResourceType());</p>\n<p>We looked in code also but are not getting any clue. There might be only two possibilities</p>\n<ol>\n<li>Either are are missing some Jar file (We downloaded and copied all Jar file to userlib folder, just copy no install. I hope that is sufficient)</li>\n<li>Or we aremissing some config file (We are using same fhir config file as yours just changed the Auth URLs)</li>\n</ol>\n<p>Any thoughts on what can go wrong? Without Smart-Fhir it works perfect without any restrictions.</p>\n<p>Thanks<br>\nMahesh</p>",
        "id": 245523513,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1625881868
    },
    {
        "content": "<p>This is our token</p>\n<p>{<br>\n  \"iss\": \"<a href=\"https://identityserverforfhir.azurewebsites.net\">https://identityserverforfhir.azurewebsites.net</a>\",<br>\n  \"nbf\": 1625901023,<br>\n  \"iat\": 1625901023,<br>\n  \"exp\": 1625904623,<br>\n  \"aud\": \"<a href=\"http://35.173.213.75:9443/fhir-server/api/v4\">http://35.173.213.75:9443/fhir-server/api/v4</a>\",<br>\n  \"scope\": \"launch/patient openid fhirUser patient/Medication.read patient/AllergyIntolerance.read patient/CarePlan.read patient/CareTeam.read patient/Condition.read patient/Device.read patient/DiagnosticReport.read patient/DocumentReference.read patient/Encounter.read patient/Goal.read patient/Immunization.read patient/Location.read patient/MedicationRequest.read patient/Observation.read patient/Organization.read patient/Patient.read patient/Practitioner.read patient/Procedure.read patient/Provenance.read patient/Patient.write offline_access\",<br>\n  \"group\": [<br>\n    \"FHIRUsers\",<br>\n    \"FHIRAdmins\"<br>\n  ],<br>\n  \"amr\": [<br>\n    \"pwd\"<br>\n  ],<br>\n  \"client_id\": \"Inferno\",<br>\n  \"sub\": \"818727\",<br>\n  \"auth_time\": 1625896133,<br>\n  \"idp\": \"local\",<br>\n  \"sid\": \"79B57016D38830A721312876B9F8E6CD\",<br>\n  \"patient\": \"17a818c38f8-229c1e6d-26a8-4b4a-aa8b-4bc81582bf4c\",<br>\n  \"patient_id\": \"17a818c38f8-229c1e6d-26a8-4b4a-aa8b-4bc81582bf4c\",<br>\n  \"upn\": \"818727\",<br>\n  \"need_patient_banner\": \"false\",<br>\n  \"smart_style_url\": \"<a href=\"https://identityserverforfhir.azurewebsites.net/SmartOnFHIR/v1.json\">https://identityserverforfhir.azurewebsites.net/SmartOnFHIR/v1.json</a>\",<br>\n  \"jti\": \"8E44AB5C7303464F19E7FA1687D57448\"<br>\n}</p>\n<p>And </p>\n<p>Algorithm and token type<br>\n{<br>\n  \"alg\": \"RS256\",<br>\n  \"kid\": \"987701C6B82719A6BD6DB54F24B42CC2\",<br>\n  \"typ\": \"at+jwt\"<br>\n}</p>",
        "id": 245534793,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1625901149
    },
    {
        "content": "<blockquote>\n<p>allergies and all other are not working due to error</p>\n</blockquote>\n<p>sorry to hear that you're still having trouble with it.  is it still the originally-reported error (Caused by: java.lang.NoSuchMethodError: 'com.ibm.fhir.search.parameters.QueryParameter com.ibm.fhir.search.util.SearchUtil.buildInclusionCriteria(java.lang.String, java.util.Set, java.lang.String)' or some other error?</p>",
        "id": 245692927,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1626099900
    },
    {
        "content": "<p>Hi Lee</p>\n<p>Will it be ok to give you access to my linux server if you want to look into any settings?<br>\nAnother option is I can upload my server liberty folder which you can download<br>\nI have oAuth setup on Azure, my liberty is configured for that. I will provide username and password for that also.</p>\n<p>Will this help to figure out what we are missing? </p>\n<p>I think what we are looking at is simple working of smart-fhir based on scopes, e.g. if we are requesting patient and problems then only two should be allowed and rest all should be denied. </p>\n<p>I think there might be something minor we might be missing <a href=\"/user_uploads/10155/XlGDgRCWtzA-Hi7rh0HtzA-l/config.zip\">config.zip</a></p>\n<p>Thanks<br>\nMahesh</p>",
        "id": 245820755,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1626181279
    },
    {
        "content": "<p>What would be most useful is if you share the error from the log.  Let me know if you need help finding the log.  If your using our docker container, its configured to go to console by default.</p>",
        "id": 245821603,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1626181642
    },
    {
        "content": "<p>Otherwise, the project I referenced above (<a href=\"https://github.com/Alvearie/health-patterns/tree/main/data-access\">https://github.com/Alvearie/health-patterns/tree/main/data-access</a>) is intended as a complete working example and I worked to make that README as easy-to-follow as possible.  Did you try it?</p>",
        "id": 245821765,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1626181714
    },
    {
        "content": "<p>no problem. Let me try fresh, will clean everything and provide you log</p>\n<p>Mahesh</p>",
        "id": 245822531,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1626182088
    },
    {
        "content": "<p><a href=\"/user_uploads/10155/WocNCGVMcLYT9i_CghEzRuRl/log.zip\">log.zip</a> </p>\n<p>Please see the log file. It is giving error while I try to get allergies. </p>\n<p>I am sending scope to allow everything, not sure why smart is not allowing it</p>\n<p>launch/patient openid fhirUser offline_access patient/Medication.read patient/AllergyIntolerance.read patient/CarePlan.read patient/CareTeam.read patient/Condition.read patient/Device.read patient/DiagnosticReport.read patient/DocumentReference.read patient/Encounter.read patient/Goal.read patient/Immunization.read patient/Location.read patient/MedicationRequest.read patient/Observation.read patient/Organization.read patient/Patient.read patient/Practitioner.read patient/Procedure.read patient/Provenance.read patient/Patient.write</p>\n<p>Mahesh</p>",
        "id": 245830130,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1626185476
    },
    {
        "content": "<p>I would suggest to review config I sent earlier along with log files.</p>",
        "id": 245830450,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1626185624
    },
    {
        "content": "<p>the logs indicate you are running IBM FHIR Server version 4.8.0:<br>\n<code>[7/13/21, 14:06:24:538 UTC] 0000001d com.ibm.fhir.server.FHIRApplication                          I FHIR Server version 4.8.0 build id 'Integration_refs/tags/4.8.0_8c843c76a1ccbbfccd96ab75c3a950a5c827ba51' starting.</code></p>",
        "id": 245847950,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1626192566
    },
    {
        "content": "<p><a href=\"#narrow/stream/212434-ibm/topic/NDJSON.20Resource.20Expectations/near/245445823\">https://chat.fhir.org/#narrow/stream/212434-ibm/topic/NDJSON.20Resource.20Expectations/near/245445823</a></p>",
        "id": 245848165,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1626192645
    },
    {
        "content": "<p>Interesting, I downloaded latest release from <a href=\"https://github.com/ibm/fhir/releases\">https://github.com/ibm/fhir/releases</a> which is FHIR 4.8.3, not sure why log is showing 4.8.o. Still I changed fhir-smart from 4.8.3 to 4.8.0 to match with whatever it says in log. In this case seems that smart configuration is not taking effect (restarted server also) and it keeps all objects wide open and not honoring scopes.</p>\n<p>Mahesh</p>",
        "id": 245938459,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1626255955
    },
    {
        "content": "<blockquote>\n<p>I downloaded latest release from <a href=\"https://github.com/ibm/fhir/releases\">https://github.com/ibm/fhir/releases</a> which is FHIR 4.8.3, not sure why log is showing 4.8.o</p>\n</blockquote>\n<p>not sure how thats possible.  i confirmed that the artifacts at <a href=\"https://github.com/IBM/FHIR/releases/tag/4.8.3\">https://github.com/IBM/FHIR/releases/tag/4.8.3</a> look right to me.<br>\nhave you downloaded and installed 4.8.0 previously?</p>\n<blockquote>\n<p>In this case seems that smart configuration is not taking effect (restarted server also) and it keeps all objects wide open and not honoring scopes.</p>\n</blockquote>\n<p>and the fhir-smart jar (and dependencies) are in your userlib? any errors in the logs?</p>",
        "id": 245960111,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1626269777
    },
    {
        "content": "<p>Let me do it again from start. I tried both 4.8.0 jar as well as 4.8.3 jar. 4.8.0 Jar is not showing any effect of Smart and 4.8.3 is throwing error. </p>\n<p>I will keep you posted</p>\n<p>Mahesh</p>",
        "id": 245967240,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1626272796
    },
    {
        "content": "<p>FYI personally, i find working with the docker image a little easier / less error-prone</p>",
        "id": 245967391,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1626272865
    },
    {
        "content": "<p>one thing you could try doing is to set a TRACE_SPEC of <code>com.ibm.fhir.persistence.interceptor.*=fine</code> so that you can see if the interceptor is even getting loaded.  info on setting the TRACE_SPEC is at <a href=\"https://ibm.github.io/FHIR/guides/FHIRServerUsersGuide#312-logging-and-trace\">https://ibm.github.io/FHIR/guides/FHIRServerUsersGuide#312-logging-and-trace</a></p>",
        "id": 245983114,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1626279636
    },
    {
        "content": "<p>Yeah I am anyway preparing fresh box. Let me test again step by step. I will update in a bit.</p>",
        "id": 246213364,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1626436530
    },
    {
        "content": "<p>Hi</p>\n<p>We installed fresh 4.8.3 and confirmed all the Jar versions and logs. <br>\nNow we configured OAuth, please see Server.XML and JWTRs.xml. Here we have configured users in Fhirusers group. <a href=\"/user_uploads/10155/WCHbIz6O5uxzk9oeUboJBSUh/server.xml\">server.xml</a> <a href=\"/user_uploads/10155/EBJOpLvs-GVhjdh7dNwMDH8w/jwtRS.xml\">jwtRS.xml</a> <a href=\"/user_uploads/10155/sP7npUji16BywwRYLoCJ3bL5/fhir-server-config.json\">fhir-server-config.json</a></p>\n<p>We are using Outh from our Azure Server, it is sending scope along with token properly (please see bellow for token). Since basic auth is false in config json file, we are expecting Allergy API to work properly with 200 response.. Now somehow Liberty is throwing error 403 when we try to get to allergies API after successful authentication in OAuth. Are we missing any user setting in liberty server.xml or jwtRS?</p>\n<p>{<br>\n  \"iss\": \"<a href=\"https://identityserverforfhir.azurewebsites.net\">https://identityserverforfhir.azurewebsites.net</a>\",<br>\n  \"nbf\": 1626686866,<br>\n  \"iat\": 1626686866,<br>\n  \"exp\": 1626690466,<br>\n  \"aud\": \"<a href=\"http://3.86.177.215:9443/fhir-server/api/v4\">http://3.86.177.215:9443/fhir-server/api/v4</a>\",<br>\n  \"scope\": \"launch/patient openid fhirUser patient/Medication.read patient/AllergyIntolerance.read patient/CarePlan.read patient/CareTeam.read patient/Condition.read patient/Device.read patient/DiagnosticReport.read patient/DocumentReference.read patient/Encounter.read patient/Goal.read patient/Immunization.read patient/Location.read patient/MedicationRequest.read patient/Observation.read patient/Organization.read patient/Patient.read patient/Practitioner.read patient/Procedure.read patient/Provenance.read offline_access\",<br>\n  \"group\": [<br>\n    \"FHIRUsers\",<br>\n    \"FHIRAdmins\"<br>\n  ],<br>\n  \"amr\": [<br>\n    \"pwd\"<br>\n  ],<br>\n  \"client_id\": \"Inferno\",<br>\n  \"sub\": \"fhiruser\",<br>\n  \"auth_time\": 1626673707,<br>\n  \"idp\": \"local\",<br>\n  \"sid\": \"4B90892A443BEC26395EE752C2094C73\",<br>\n  \"patient\": \"17ab437f80b-f1907e67-e141-467c-b3d9-c3f8ebd867be\",<br>\n  \"patient_id\": \"17ab437f80b-f1907e67-e141-467c-b3d9-c3f8ebd867be\",<br>\n  \"upn\": \"fhiruser\",<br>\n  \"need_patient_banner\": \"false\",<br>\n  \"smart_style_url\": \"<a href=\"https://identityserverforfhir.azurewebsites.net/SmartOnFHIR/v1.json\">https://identityserverforfhir.azurewebsites.net/SmartOnFHIR/v1.json</a>\",<br>\n  \"jti\": \"247B25C32AE454CD78168129E67EFB47\"<br>\n}</p>",
        "id": 246436025,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1626688675
    },
    {
        "content": "<p>Hi Lee</p>\n<p>Any help here will be appreciated. </p>\n<p>Thanks<br>\nMahesh</p>",
        "id": 246601870,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1626792913
    },
    {
        "content": "<p>Hi Mahesh, I'm on vacation this week (and next), so I might be slow (or might not respond at all for a bit).</p>\n<blockquote>\n<p>Now somehow Liberty is throwing error 403 when we try to get to allergies API after successful authentication in OAuth.</p>\n</blockquote>\n<p>I had a peak at the config.zip you sent earlier and I may know the issue.<br>\nSpecifically  this line:</p>\n<div class=\"codehilite\"><pre><span></span><code>&lt;group id=&quot;usersGroup&quot; access-id=&quot;group:https://localhost:8443/auth/realms/test/fhirUser&quot;/&gt;\n</code></pre></div>\n<p>Please try replacing that with the following:</p>\n<div class=\"codehilite\"><pre><span></span><code>&lt;group id=&quot;usersGroup&quot; access-id=&quot;group:https://identityserverforfhir.azurewebsites.net/FHIRUsers&quot;/&gt;\n</code></pre></div>\n<p>This part is definitely a bit tricky/confusing, but what Liberty is doing is appending the group name from the access token to the issuer url to uniquely identify the group and we're mapping users in that group to our FHIRUsers security-role.</p>",
        "id": 246616812,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1626799141
    },
    {
        "content": "<p>For example, if your token had something like this insead:</p>\n<div class=\"codehilite\"><pre><span></span><code>&quot;group&quot;: [\n&quot;fhirUser&quot;\n],\n</code></pre></div>\n<p>then the access-id would be <code>group:https://identityserverforfhir.azurewebsites.net/FHIRUsers</code> instead.</p>",
        "id": 246617587,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1626799514
    },
    {
        "content": "<p>Awesome. Seems that OAuth is working properly now, SMART is still giving scope issues. It either blocks everything or opens everything. It doesn't honor scopes. Tried resources as given in <a href=\"https://github.com/Alvearie/health-patterns/blob/main/data-access/fhir/config/default/fhir-server-config.json\">https://github.com/Alvearie/health-patterns/blob/main/data-access/fhir/config/default/fhir-server-config.json</a></p>\n<p>Thanks<br>\nMahesh</p>",
        "id": 246702205,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1626863664
    }
]