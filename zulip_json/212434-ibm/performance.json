[
    {
        "content": "<p>Dear IBM team,</p>\n<p>We are running ibm fhir server + postgresql database (version: 13.0) from docker-compose file.<br>\nWe noticed that posting fhir transaction bundles through Rest Api to both 4.5.1 and 4.5.2 is running much slower than the previous versions (&lt;=4.5.0) .</p>\n<p>We did some benchmark using the same setup in <code>server.xml</code> and <code>fhir-server-conifg.json</code>. Digesting fhir bundles is now about 4 times slower. So is it because of the change in database schema? Is there anything we can try to speed it up?</p>",
        "id": 219322267,
        "sender_full_name": "guokun zhang",
        "timestamp": 1607512022
    },
    {
        "content": "<p>Hi, the main schema change was introduced in 4.5.0 (to improve ingestion performance). Are you monitoring the database? Have you configured any form of Application Performance Management (NewRelic, for example) which can help pinpoint where most of the time is being spent. Have you configured any search parameter filters to reduce the number of parameters we store? Do your resources contain PHI or are they test data? If there's no PHI involved, you could enable tracing in the server.xml and share the output - that would help us to see where most of the time is being spent.</p>",
        "id": 219344199,
        "sender_full_name": "Robin Arnold",
        "timestamp": 1607524732
    },
    {
        "content": "<p>Are you using client-asserted identifiers or using ids generated by the server (e.g. POST)?</p>",
        "id": 219345715,
        "sender_full_name": "Robin Arnold",
        "timestamp": 1607525312
    },
    {
        "content": "<p>We are currently running 4.5.2.We are unable to post a bundle having 20k resources.We are facing below error while trying to post the bundle.</p>\n<p>0000005a com.ibm.fhir.server.resources.FHIRResource E Commit global transaction failed. See server log for details<br>\ncom.ibm.fhir.persistence.jdbc.exception.FHIRPersistenceDataAccessException: Commit global transaction failed. See server log for details [probeId=a-2c-0-1-3ea7a13d-c204-4abd-b597-e9b3568cf226]<br>\nat com.ibm.fhir.persistence.jdbc.connection.FHIRUserTransactionAdapter.end(FHIRUserTransactionAdapter.java:119)<br>\nat com.ibm.fhir.persistence.helper.FHIRTransactionHelper.commit(FHIRTransactionHelper.java:43)<br>\nat com.ibm.fhir.server.util.FHIRRestHelper.processBundleEntries(FHIRRestHelper.java:1520)<br>\nat com.ibm.fhir.server.util.FHIRRestHelper.doBundle(FHIRRestHelper.java:1078)<br>\nat com.ibm.fhir.server.resources.Batch.bundle(Batch.java:77)<br>\nat com.ibm.fhir.server.resources.Batch$Proxy$_$$_WeldClientProxy.bundle(Unknown Source)<br>\nat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br>\nat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)<br>\nat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)<br>\nat java.lang.reflect.Method.invoke(Method.java:498)<br>\nat com.ibm.ws.jaxrs20.cdi.component.JaxRsFactoryImplicitBeanCDICustomizer.serviceInvoke(JaxRsFactoryImplicitBeanCDICustomizer.java:339)<br>\nat com.ibm.ws.jaxrs20.server.LibertyJaxRsServerFactoryBean.performInvocation(LibertyJaxRsServerFactoryBean.java:641)<br>\nat com.ibm.ws.jaxrs20.server.LibertyJaxRsInvoker.performInvocation(LibertyJaxRsInvoker.java:160)<br>\nat org.apache.cxf.service.invoker.AbstractInvoker.invoke(AbstractInvoker.java:96)<br>\nat com.ibm.ws.jaxrs20.server.LibertyJaxRsInvoker.invoke(LibertyJaxRsInvoker.java:273)<br>\nat org.apache.cxf.jaxrs.JAXRSInvoker.invoke(JAXRSInvoker.java:210)<br>\nat com.ibm.ws.jaxrs20.server.LibertyJaxRsInvoker.invoke(LibertyJaxRsInvoker.java:444)<br>\nat org.apache.cxf.jaxrs.JAXRSInvoker.invoke(JAXRSInvoker.java:112)<br>\nat org.apache.cxf.interceptor.ServiceInvokerInterceptor$1.run(ServiceInvokerInterceptor.java:61)<br>\nat org.apache.cxf.interceptor.ServiceInvokerInterceptor.handleMessage(ServiceInvokerInterceptor.java:99)<br>\nat org.apache.cxf.phase.PhaseInterceptorChain.doIntercept(PhaseInterceptorChain.java:318)<br>\nat org.apache.cxf.transport.ChainInitiationObserver.onMessage(ChainInitiationObserver.java:123)<br>\nat org.apache.cxf.transport.http.AbstractHTTPDestination.invoke(AbstractHTTPDestination.java:273)<br>\nat com.ibm.ws.jaxrs20.endpoint.AbstractJaxRsWebEndpoint.invoke(AbstractJaxRsWebEndpoint.java:136)<br>\nat com.ibm.websphere.jaxrs.server.IBMRestServlet.handleRequest(IBMRestServlet.java:146)<br>\nat com.ibm.websphere.jaxrs.server.IBMRestServlet.doPost(IBMRestServlet.java:104)<br>\nat javax.servlet.http.HttpServlet.service(HttpServlet.java:706)<br>\nat com.ibm.websphere.jaxrs.server.IBMRestServlet.service(IBMRestServlet.java:96)<br>\nat com.ibm.ws.webcontainer.servlet.ServletWrapper.service(ServletWrapper.java:1230)<br>\nat com.ibm.ws.webcontainer.servlet.ServletWrapper.handleRequest(ServletWrapper.java:729)<br>\nat com.ibm.ws.webcontainer.servlet.ServletWrapper.handleRequest(ServletWrapper.java:426)<br>\nat com.ibm.ws.webcontainer.filter.WebAppFilterChain.invokeTarget(WebAppFilterChain.java:182)<br>\nat com.ibm.ws.webcontainer.filter.WebAppFilterChain.doFilter(WebAppFilterChain.java:93)<br>\nat com.ibm.fhir.server.filter.rest.FHIRRestServletFilter.doFilter(FHIRRestServletFilter.java:139)<br>\nat javax.servlet.http.HttpFilter.doFilter(HttpFilter.java:127)<br>\nat com.ibm.ws.webcontainer.filter.FilterInstanceWrapper.doFilter(FilterInstanceWrapper.java:201)<br>\nat com.ibm.ws.webcontainer.filter.WebAppFilterChain.doFilter(WebAppFilterChain.java:90)<br>\nat com.ibm.fhir.server.filter.rest.FHIRRestAuthorizationServletFilter.doFilter(FHIRRestAuthorizationServletFilter.java:86)<br>\nat com.ibm.ws.webcontainer.filter.FilterInstanceWrapper.doFilter(FilterInstanceWrapper.java:201)<br>\nat com.ibm.ws.webcontainer.filter.WebAppFilterChain.doFilter(WebAppFilterChain.java:90)<br>\nat com.ibm.ws.webcontainer.filter.WebAppFilterManager.doFilter(WebAppFilterManager.java:1001)<br>\nat com.ibm.ws.webcontainer.filter.WebAppFilterManager.invokeFilters(WebAppFilterManager.java:1139)<br>\nat com.ibm.ws.webcontainer.webapp.WebApp.handleRequest(WebApp.java:5037)<br>\nat com.ibm.ws.webcontainer.osgi.DynamicVirtualHost$2.handleRequest(DynamicVirtualHost.java:314)<br>\nat com.ibm.ws.webcontainer.WebContainer.handleRequest(WebContainer.java:1005)<br>\nat com.ibm.ws.webcontainer.osgi.DynamicVirtualHost$2.run(DynamicVirtualHost.java:279)<br>\nat com.ibm.ws.http.dispatcher.internal.channel.HttpDispatcherLink$TaskWrapper.run(HttpDispatcherLink.java:1134)<br>\nat com.ibm.ws.http.dispatcher.internal.channel.HttpDispatcherLink.wrapHandlerAndExecute(HttpDispatcherLink.java:415)<br>\nat com.ibm.ws.http.dispatcher.internal.channel.HttpDispatcherLink.ready(HttpDispatcherLink.java:374)<br>\nat com.ibm.ws.http.channel.internal.inbound.HttpInboundLink.handleDiscrimination(HttpInboundLink.java:577)<br>\nat com.ibm.ws.http.channel.internal.inbound.HttpInboundLink.handleNewRequest(HttpInboundLink.java:511)<br>\nat com.ibm.ws.http.channel.internal.inbound.HttpInboundLink.processRequest(HttpInboundLink.java:359)<br>\nat com.ibm.ws.http.channel.internal.inbound.HttpInboundLink.ready(HttpInboundLink.java:326)<br>\nat com.ibm.ws.channel.ssl.internal.SSLConnectionLink.determineNextChannel(SSLConnectionLink.java:1100)<br>\nat com.ibm.ws.channel.ssl.internal.SSLConnectionLink.readyInboundPostHandshake(SSLConnectionLink.java:757)<br>\nat com.ibm.ws.channel.ssl.internal.SSLConnectionLink$MyHandshakeCompletedCallback.complete(SSLConnectionLink.java:427)<br>\nat com.ibm.ws.channel.ssl.internal.SSLUtils.handleHandshake(SSLUtils.java:953)<br>\nat com.ibm.ws.channel.ssl.internal.SSLHandshakeIOCallback.complete(SSLHandshakeIOCallback.java:85)<br>\nat com.ibm.ws.tcpchannel.internal.WorkQueueManager.requestComplete(WorkQueueManager.java:504)<br>\nat com.ibm.ws.tcpchannel.internal.WorkQueueManager.attemptIO(WorkQueueManager.java:574)<br>\nat com.ibm.ws.tcpchannel.internal.WorkQueueManager.workerRun(WorkQueueManager.java:958)<br>\nat com.ibm.ws.tcpchannel.internal.WorkQueueManager$Worker.run(WorkQueueManager.java:1047)<br>\nat com.ibm.ws.threading.internal.ExecutorServiceImpl$RunnableWrapper.run(ExecutorServiceImpl.java:239)<br>\nat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)<br>\nat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)<br>\nat java.lang.Thread.run(Thread.java:823)</p>\n<p>0000005a com.ibm.fhir.server.filter.rest.FHIRRestServletFilter I Completed request[43.361 secs]: tenantId:[] dsId:[default] user:[fhiruser] method:[POST] uri:[<strong>*</strong>**] status:[500]</p>",
        "id": 219388157,
        "sender_full_name": "Digamber Kalivemula",
        "timestamp": 1607543128
    },
    {
        "content": "<p>Can you provide more context from the server messages.log? It's interesting that it's the commit that's failing...all the hard work has been done at this point. Were there any errors reported in the database logs around the time of this request?</p>",
        "id": 219391079,
        "sender_full_name": "Robin Arnold",
        "timestamp": 1607544644
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"253392\">@Digamber Kalivemula</span> are you working with <span class=\"user-mention\" data-user-id=\"240520\">@guokun zhang</span> ?<br>\nif not, please don't hijack this thread which is about a reported slowdown in ingestion performance in 4.5.1/4.5.2</p>",
        "id": 219391453,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1607544879
    },
    {
        "content": "<p>lets use <a href=\"#narrow/stream/212434-ibm/topic/FHIR.20DB.20issues\">https://chat.fhir.org/#narrow/stream/212434-ibm/topic/FHIR.20DB.20issues</a> for that one</p>",
        "id": 219391510,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1607544908
    }
]