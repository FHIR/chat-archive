[
    {
        "content": "<p>Scenario 1: patient/Patient.read<br>\nIt is observed that when we send scopes \"patient/Medication.read patient/AllergyIntolerance.read patient/CarePlan.read patient/CareTeam.read patient/Condition.read patient/Device.read patient/DiagnosticReport.read patient/DocumentReference.read patient/Encounter.read patient/Goal.read patient/Immunization.read patient/Location.read patient/MedicationRequest.read patient/Observation.read patient/Organization.read patient/Practitioner.read patient/Procedure.read patient/Provenance.read\" in the token, to read Patientdetails with URL  \"<a href=\"http://3.84.221.213:9443/fhir-server/api/v4/Patient/17ab437f80b-f1907e67-e141-467c-b3d9-c3f8ebd867be\">http://3.84.221.213:9443/fhir-server/api/v4/Patient/17ab437f80b-f1907e67-e141-467c-b3d9-c3f8ebd867be</a>\"</p>\n<p>it denies access (as expected) because we have not given \"patient/Patient.read\" in the scope list in the token.</p>\n<p>Following is a snapshot of the detailed trace<br>\n[8/6/21, 5:52:24:261 UTC] 0000002b AuthzPolicyEn 1   read permission for 'Patient/17ab437f80b-f1907e67-e141-467c-b3d9-c3f8ebd867be' is not granted by any of the provided scopes: [patient/Medication.read, patient/AllergyIntolerance.read, patient/CarePlan.read, patient/CareTeam.read, patient/Condition.read, patient/Device.read, patient/DiagnosticReport.read, patient/DocumentReference.read, patient/Encounter.read, patient/Goal.read, patient/Immunization.read, patient/Location.read, patient/MedicationRequest.read, patient/Observation.read, patient/Organization.read, patient/Practitioner.read, patient/Procedure.read, patient/Provenance.read] with context id(s): [17ab437f80b-f1907e67-e141-467c-b3d9-c3f8ebd867be]<br>\n[8/6/21, 5:52:24:262 UTC] 0000002b FHIRUserTrans 1   Marking transaction for rollback.<br>\n[8/6/21, 5:52:24:262 UTC] 0000002b FHIRUserTrans 1   Rolling back transaction on current thread...<br>\n[8/6/21, 5:52:24:264 UTC] 0000002b CacheTransact I   Transaction failed - afterCompletion(status = 4)<br>\n[8/6/21, 5:52:24:264 UTC] 0000002b FHIRPersisten 1   Transaction rolled back - clearing local maps<br>\n[8/6/21, 5:52:24:266 UTC] 0000002b FHIRResource  1   Requested interaction is not permitted by any of the passed scopes.</p>\n<p>Scenario 2: patient/AllergyIntolerance.read<br>\nWhen we send scopes \"patient/Medication.read patient/CarePlan.read patient/CareTeam.read patient/Condition.read patient/Device.read patient/DiagnosticReport.read patient/DocumentReference.read patient/Encounter.read patient/Goal.read patient/Immunization.read patient/Location.read patient/MedicationRequest.read patient/Observation.read patient/Organization.read patient/Practitioner.read patient/Procedure.read patient/Provenance.read patient/Patient.read\" , with no patient/AllergyIntolerance.read in it, it still allows access to Allergy of the patient (<a href=\"http://3.84.221.213:9443/fhir-server/api/v4/AllergyIntolerance?patient=17ab437f80b-f1907e67-e141-467c-b3d9-c3f8ebd867be\">http://3.84.221.213:9443/fhir-server/api/v4/AllergyIntolerance?patient=17ab437f80b-f1907e67-e141-467c-b3d9-c3f8ebd867be</a>) and gives 200 OK. It is expected here, that it should deny access to this resource.</p>\n<p>In the trace, we could not locate any log with  AuthzPolicyEn 1, the way it was present when we ran scenario 1. </p>\n<p>Even when we send no scopes in the token, the FHIR server still gives access to allergyIntolerance.</p>\n<p>Are we missing anything? Please help.</p>",
        "id": 248576797,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1628232229
    },
    {
        "content": "<p>Hi Mahesh, do you actually get the allergyIntolerance back or do you get just an empty page of results?</p>",
        "id": 248849639,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1628517548
    },
    {
        "content": "<p>What the fhir-smart interceptor does is it converts the searches into Patient Compartment searches.<br>\nThen, mostly to deal with <code>_include</code> and <code>_revinclude</code> search parameters, it also confirms that the user has access to all the resources it is about to return.  So, if AllergyIntolerance search cannot find any AllergyIntolerance for the \"in-context\" patient then I think it is expected that it will return en empty page.<br>\nWith that said, I agree that it would be better to reject the search up-front.  This can be done via either a gateway or within the FHIR Server, but the fhir-smart interceptor does not currently do that.  Care to open an issue for it?</p>",
        "id": 248851597,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1628518259
    },
    {
        "content": "<p>Thank you for your explanation of our previous questions. After we uploaded all resource-type data to a patient, the FHIR server started to honor scopes as expected. That means it will honor scopes only when there is patient data for those scopes.</p>\n<p>While we were testing with the Inferno tool, now we are getting an error \"UnsupportedOperationException: SMART scopes with context type 'user' are not yet supported.\". </p>\n<p>URL called: <br>\n<a href=\"http://54.88.8.62:9443/fhir-server/api/v4/Practitioner/17b350debf6-c44c90a7-7703-4bd9-bd57-6df97a2c0b9f\">http://54.88.8.62:9443/fhir-server/api/v4/Practitioner/17b350debf6-c44c90a7-7703-4bd9-bd57-6df97a2c0b9f</a></p>\n<p>Token sent:<br>\n       {<br>\n  \"iss\": \"<a href=\"https://identityserverforfhir.azurewebsites.net\">https://identityserverforfhir.azurewebsites.net</a>\",<br>\n  \"nbf\": 1628683595,<br>\n  \"iat\": 1628683595,<br>\n  \"exp\": 1628687195,<br>\n  \"aud\": \"<a href=\"http://54.88.8.62:9443/fhir-server/api/v4\">http://54.88.8.62:9443/fhir-server/api/v4</a>\",<br>\n  \"scope\": \"launch openid fhirUser user/Medication.read user/AllergyIntolerance.read user/CarePlan.read user/CareTeam.read user/Condition.read user/Device.read user/DiagnosticReport.read user/DocumentReference.read user/Encounter.read user/Goal.read user/Immunization.read user/Location.read user/MedicationRequest.read user/Observation.read user/Organization.read user/Patient.read user/Practitioner.read user/Procedure.read user/Provenance.read offline_access\",<br>\n  \"group\": [<br>\n    \"FHIRUsers\",<br>\n    \"FHIRAdmins\"<br>\n  ],<br>\n  \"amr\": [<br>\n    \"pwd\"<br>\n  ],<br>\n  \"client_id\": \"Inferno\",<br>\n  \"sub\": \"fhiruser\",<br>\n  \"auth_time\": 1628679442,<br>\n  \"idp\": \"local\",<br>\n  \"sid\": \"C98717AE4B6939B04B9D68763BBE60D0\",<br>\n  \"patient\": \"17ab437f80b-f1907e67-e141-467c-b3d9-c3f8ebd867be\",<br>\n  \"patient_id\": \"17ab437f80b-f1907e67-e141-467c-b3d9-c3f8ebd867be\",<br>\n  \"upn\": \"fhiruser\",<br>\n  \"need_patient_banner\": \"false\",<br>\n  \"smart_style_url\": \"<a href=\"https://identityserverforfhir.azurewebsites.net/SmartOnFHIR/v1.json\">https://identityserverforfhir.azurewebsites.net/SmartOnFHIR/v1.json</a>\",<br>\n  \"jti\": \"8C0419C23EBBC63990064C53821C14F4\"<br>\n}</p>\n<p>Response received: <br>\n{<br>\n  \"resourceType\": \"OperationOutcome\",<br>\n  \"issue\": [<br>\n    {<br>\n      \"severity\": \"fatal\",<br>\n      \"code\": \"exception\",<br>\n      \"details\": {<br>\n        \"text\": \"UnsupportedOperationException: SMART scopes with context type 'user' are not yet supported.\"<br>\n      }<br>\n    }<br>\n  ]<br>\n}</p>\n<p>Could you please help us with that?</p>",
        "id": 249099887,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1628685071
    },
    {
        "content": "<blockquote>\n<p>That means it will honor scopes only when there is patient data for those scopes.</p>\n</blockquote>\n<p>yep.  however, I think you've convinced me that we should be more restrictive (even with no data being returned) and so I opened <a href=\"https://github.com/IBM/FHIR/issues/2669\">https://github.com/IBM/FHIR/issues/2669</a> and that change is now expected for IBM FHIR Server 4.9.0</p>",
        "id": 249104716,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1628687502
    },
    {
        "content": "<p>Yes absolutely. As I see the last comment on the issue in github it says \"use of user/ permissions is still not implemented for some cases\" For now we are looking for read permission. Any idea when that can be available approximately? Is there any custom fix we can do till release for short- term. I mean if we can get Jar with this change (final release can take its own time as per schedule and it is ok)</p>\n<p>Thanks a lot and appreciate your help.</p>",
        "id": 249106852,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1628688535
    },
    {
        "content": "<p>We merged <a href=\"https://github.com/IBM/FHIR/pull/2675\">https://github.com/IBM/FHIR/pull/2675</a> this morning and that is now also expected for 4.9.0</p>",
        "id": 249133009,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1628699523
    },
    {
        "content": "<p>you can checkout and build from main today</p>",
        "id": 249133061,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1628699532
    },
    {
        "content": "<p>In the past I left supporting <code>user/</code> scopes as a TODO because, for most cases, it should really be tied to a more granular permissions model.  However, thats extremely challenging to do in a generic fhir server like ours, so this pull request just goes with the proposal that I read on Zulip a while back:  <a href=\"#narrow/stream/179170-smart/topic/Authorization.20for.20transactions/near/213346765\">https://chat.fhir.org/#narrow/stream/179170-smart/topic/Authorization.20for.20transactions/near/213346765</a></p>",
        "id": 249133410,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1628699708
    },
    {
        "content": "<p>If you do check out from main, let us know how it goes ASAP because we are <em>very</em> close to releasing 4.9.0.  We're testing it on a few projects ourselves, but it would be <em>great</em> to have some independent verification of these late-breaking fhir-smart changes.</p>",
        "id": 249133682,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1628699854
    },
    {
        "content": "<p>Hi Lee</p>\n<p>Where can I get fhir-smart-4.9.0.jar? I can test that with latest release of  IBM FHIR Server 4.9.0. Also what will be dependencies for this jar or it will work with old version of dependencies?</p>\n<p>Right now we are having following dependencies in usrlib folder</p>\n<p><a href=\"/user_uploads/10155/q_avLsQTjFbdQJoPHgbxuc3w/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/q_avLsQTjFbdQJoPHgbxuc3w/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/q_avLsQTjFbdQJoPHgbxuc3w/image.png\"></a></div><p>Thanks<br>\nMahesh</p>",
        "id": 249213364,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1628760453
    },
    {
        "content": "<p>We tagged 4.9.0 last night and the artifacts have been promoted to Maven Central.  So you can get from <a href=\"https://repo1.maven.org/maven2/com/ibm/fhir/fhir-smart/4.9.0/\">https://repo1.maven.org/maven2/com/ibm/fhir/fhir-smart/4.9.0/</a> or you can use Maven to get it (and its transitive dependencies).  I don't think there were any dependency version updates for fhir-smart in this release.</p>",
        "id": 249236270,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1628775872
    },
    {
        "content": "<p>Great. I saw the code change in github.  Please see attached screenshot of inferno. <br>\nDuring bulk export, we would need to honor system scopes. Also, has signature algorithm something to do with FHIR server?</p>\n<p><a href=\"/user_uploads/10155/mCMSxADqG9sqabYVFuu4UPDT/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/mCMSxADqG9sqabYVFuu4UPDT/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/mCMSxADqG9sqabYVFuu4UPDT/image.png\"></a></div>",
        "id": 249237903,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1628776775
    },
    {
        "content": "<p>Cool, I havn't done too much with that.  Please open an issue for it at <a href=\"http://github.com/ibm/fhir\">github.com/ibm/fhir</a> with what you're seeing and what you'd like to see.</p>",
        "id": 249239830,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1628777649
    },
    {
        "content": "<blockquote>\n<p>has signature algorithm something to do with FHIR server?</p>\n</blockquote>\n<p>From the FHIR server side, I think its just about being able to validate the tokens we get passed.  We opened an issue requesting specific support for ES384/RS384 in OpenLiberty a while back and the ticket is still open...but I havn't tried it in a while and there's always a chance that it could be made to work despite the issue being open still.  If you decide to give it a go, let us know how it goes.</p>",
        "id": 249268123,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1628790344
    },
    {
        "content": "<p>Hi Lee</p>\n<p>We tested latest version of smart and scoping is working as expected. really appreciate your help for addressing this in  your busy release schedule.</p>\n<p>I will test more and get you some feedback.</p>\n<p>Thanks<br>\nMahesh</p>",
        "id": 249702322,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1629197790
    },
    {
        "content": "<p>We successfully installed the latest IBM FHIR 4.9.2 and worked fine with basic authentication.</p>\n<p>Now when we configured it to use the SMART feature it is giving us the below exception. while running a GET on <a href=\"https://fhir.secureit.co.in:9443/fhir-server/api/v4/Patient\">https://fhir.secureit.co.in:9443/fhir-server/api/v4/Patient</a> </p>\n<p>We have the following jars under userlib.<br>\n      fhir-smart-4.9.2.jar<br>\n      java-jwt-3.13.0.jar</p>\n<p>Do you think we are missing more dependencies?</p>\n<p>Exception:<br>\n[INFO    ] Received request: tenantId:[default] dsId:[default] user:[fhiruser] method:[GET] uri:[https://fhir.secureit.co.in:9443/fhir-server/api/v4/Patient]<br>\n[INFO    ] Transaction failed - afterCompletion(status = 4)<br>\n[WARNING ] Application {http://resources.server.fhir.ibm.com/}Create has thrown exception, unwinding now<br>\ncom/fasterxml/jackson/databind/JsonDeserializer<br>\n[WARNING ] Exception in handleFault on interceptor org.apache.cxf.jaxrs.interceptor.JAXRSDefaultFaultOutInterceptor@341d5864<br>\ncom/fasterxml/jackson/databind/JsonDeserializer<br>\n[ERROR   ] An unexpected error occurred during error handling. No further error processing will occur.<br>\ncom/fasterxml/jackson/databind/JsonDeserializer<br>\n[ERROR   ] SRVE0777E: Exception thrown by application class 'org.apache.cxf.service.invoker.AbstractInvoker.createFault:167'<br>\norg.apache.cxf.interceptor.Fault: com/fasterxml/jackson/databind/JsonDeserializer<br>\nat org.apache.cxf.service.invoker.AbstractInvoker.createFault(AbstractInvoker.java:167)<br>\nat [internal classes]<br>\nat com.ibm.fhir.server.filter.rest.FHIRRestServletFilter.doFilter(FHIRRestServletFilter.java:155)<br>\nat javax.servlet.http.HttpFilter.doFilter(HttpFilter.java:127)<br>\nat [internal classes]<br>\nCaused by: java.lang.NoClassDefFoundError: com/fasterxml/jackson/databind/JsonDeserializer<br>\nat com.auth0.jwt.JWTDecoder.&lt;init&gt;(JWTDecoder.java:32)<br>\nat com.auth0.jwt.JWT.decode(JWT.java:45)<br>\nat com.ibm.fhir.smart.AuthzPolicyEnforcementPersistenceInterceptor.beforeSearch(AuthzPolicyEnforcementPersistenceInterceptor.java:113)<br>\nat com.ibm.fhir.persistence.interceptor.impl.FHIRPersistenceInterceptorMgr.fireBeforeSearchEvent(FHIRPersistenceInterceptorMgr.java:175)<br>\nat com.ibm.fhir.server.util.FHIRRestHelper.doSearch(FHIRRestHelper.java:1076)<br>\nat com.ibm.fhir.server.util.FHIRRestHelper.doSearch(FHIRRestHelper.java:1017)<br>\nat com.ibm.fhir.server.resources.Search.doSearch(Search.java:74)<br>\nat com.ibm.fhir.server.resources.Search.searchGet(Search.java:51)<br>\nat com.ibm.fhir.server.resources.Search$Proxy$_$$_WeldClientProxy.searchGet(Unknown Source)<br>\nat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br>\nat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)<br>\nat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)<br>\nat java.lang.reflect.Method.invoke(Method.java:498)<br>\nat com.ibm.ws.jaxrs20.cdi.component.JaxRsFactoryImplicitBeanCDICustomizer.serviceInvoke(JaxRsFactoryImplicitBeanCDICustomizer.java:342)<br>\n... 4 more</p>\n<p>[INFO    ] Error while setting request context or processing request<br>\ncom/fasterxml/jackson/databind/JsonDeserializer<br>\n[INFO    ] Completed request[0.04 secs]: tenantId:[default] dsId:[default] user:[fhiruser] method:[GET] uri:[https://fhir.secureit.co.in:9443/fhir-server/api/v4/Patient] status:[400]</p>",
        "id": 256036525,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1633343395
    },
    {
        "content": "<p><a href=\"https://github.com/IBM/FHIR/blob/main/fhir-smart/src/main/java/com/ibm/fhir/smart/AuthzPolicyEnforcementPersistenceInterceptor.java#L113\">https://github.com/IBM/FHIR/blob/main/fhir-smart/src/main/java/com/ibm/fhir/smart/AuthzPolicyEnforcementPersistenceInterceptor.java#L113</a></p>\n<p>Error on this line</p>",
        "id": 256044380,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1633347887
    },
    {
        "content": "<p>Hi Mahesh, sorry to hear that.  The concerning line is this one:</p>\n<blockquote>\n<p>Caused by: java.lang.NoClassDefFoundError: com/fasterxml/jackson/databind/JsonDeserializer</p>\n</blockquote>\n<p>Which version of the jackson jars do you have in userlib (alongside fhir-smart) ?</p>",
        "id": 256229168,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1633434025
    },
    {
        "content": "<p>We have the following jars under userlib.<br>\n      fhir-smart-4.9.2.jar<br>\n      java-jwt-3.13.0.jar</p>\n<p>For the previous versions of IBM FHIR we had this same set of jars and it worked fine.</p>",
        "id": 256426096,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1633532561
    },
    {
        "content": "<p>OK, I additionally have these ones:</p>\n<ul>\n<li>commons-codec-1.14.jar</li>\n<li>jackson-annotations-2.11.0.jar</li>\n<li>jackson-core-2.11.0.jar</li>\n<li>jackson-databind-2.11.0.jar</li>\n</ul>\n<p>You may have just gotten lucky that those other ones were in our webapp.  Like maybe the Cassandra stuff that was in there was pulling those in, but for 4.9.2 we slimmed it down a bit (via <a href=\"https://github.com/IBM/FHIR/pull/2757\">https://github.com/IBM/FHIR/pull/2757</a>).</p>",
        "id": 256430598,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1633534153
    },
    {
        "content": "<p>With that said, this conversation has motivated me to see about removing our java-jwt dependency (the thing that pulls in those transitive dependencies).  So I opened <a href=\"https://github.com/IBM/FHIR/pull/2833\">https://github.com/IBM/FHIR/pull/2833</a> as a draft PR...let me know what you think.</p>",
        "id": 256430787,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1633534215
    },
    {
        "content": "<p>Unless we do something like that, you'll need to be sure you're packaging all the fhir-smart dependencies in userlib</p>",
        "id": 256430879,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1633534248
    }
]