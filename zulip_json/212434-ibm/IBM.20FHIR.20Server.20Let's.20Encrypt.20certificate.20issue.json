[
    {
        "content": "<p>Hi everyone, </p>\n<p>we are trying to run the IBM FHIR server v4.10.2 and KeyCloak within a docker-compose. All these components are behind an nginx proxy and hosted on Digital Ocean with Let's Encrypt certificates. We are currently stuck with this error message: </p>\n<div class=\"codehilite\"><pre><span></span><code>ibm-fhir       | [3/6/22, 20:06:46:347 UTC] 00000028 IncidentImpl  I   FFDC1015I: An FFDC Incident has been created: &quot;org.apache.http.conn.HttpHostConnectException: Connect to keycloak.example.tech:443 [keycloak.example.tech/167.237.178.187] failed: Connection timed out (Connection timed out) com.ibm.ws.security.common.jwk.impl.JwKRetriever 792&quot; at ffdc_22.03.06_20.06.46.0.log\nibm-fhir       | [3/6/22, 20:06:46:356 UTC] 00000028 JwKRetriever  E   CWWKS6049E: A JSON Web Key (JWK) was not returned from the URL [https://keycloak.example.tech/auth/realms/Example/protocol/openid-connect/certs]. The response status was [0] and the content returned was [IOException: Connect to keycloak.example.tech:443 [keycloak.example.tech/167.237.178.187] failed: Connection timed out (Connection timed out) java.net.ConnectException: Connection timed out (Connection timed out)].\nibm-fhir       | [3/6/22, 20:06:46:359 UTC] 00000028 TAIJwtUtils   E   CWWKS5524E: The MicroProfile JWT feature encountered an error while creating a JWT by using the [jwtConsumer] configuration and the token included in the request. CWWKS6031E: The JSON Web Token (JWT) consumer [jwtConsumer] cannot process the token string. CWWKS6029E: The JSON Web Token (JWT) cannot be validated because a signing key cannot be found. The configured signature algorithm [RS256] requires a key to validate the token.\nibm-fhir       | [3/6/22, 20:06:46:360 UTC] 00000028 MicroProfileJ E   CWWKS5523E: The MicroProfile JWT feature cannot authenticate the request because the token that is included in the request cannot be validated. CWWKS5524E: The MicroProfile JWT feature encountered an error while creating a JWT by using the [jwtConsumer] configuration and the token included in the request. CWWKS6031E: The JSON Web Token (JWT) consumer [jwtConsumer] cannot process the token string. CWWKS6029E: The JSON Web Token (JWT) cannot be validated because a signing key cannot be found. The configured signature algorithm [RS256] requires a key to validate the token.\nibm-fhir       | [3/6/22, 20:06:46:362 UTC] 00000028 FHIRRestServl I   Received request: tenantId:[default] dsId:[default] user:[&amp;lt;unauthenticated&amp;gt;] method:[GET] uri:[https://fhir.example.tech/fhir-server/api/v4/Person]\n</code></pre></div>\n<p>I attached our configuration files for the FHIR server and the docker-compose.yml. We suspect it has something to do with the Let's Encrypt certificate, which the IBM FHIR server seems to have an issue with. The entire setup does work with a different kind of certificate. Has anyone seen this type of error before? <span class=\"user-mention\" data-user-id=\"191676\">@Lee Surprenant</span> Is there anything wrong in our configuration files that catches your eye?</p>\n<p><a href=\"/user_uploads/10155/Gukab-wruS07FDQ3EwdXguKo/docker-compose.yml\">docker-compose.yml</a></p>\n<p><a href=\"/user_uploads/10155/P16mXPaG73DwVfFb0SIgwBvR/fhir-server-config.json\">fhir-server-config.json</a> </p>\n<p><a href=\"/user_uploads/10155/bK1FMBENaK73IMmFD3qCdznC/jwtRS.xml\">jwtRS.xml</a> </p>\n<p><a href=\"/user_uploads/10155/StyrI4QgN9PNxrwnnjvZh4W3/server.xml\">server.xml</a></p>",
        "id": 274528539,
        "sender_full_name": "Yannick Börner",
        "timestamp": 1646739074
    },
    {
        "content": "<p>Hi Yannick, it definitely sounds like the FHIR Server is not able to dereference the JWKS endpoint.  I see you have that set to <code>https://keycloak.example.tech/auth/realms/Test/protocol/openid-connect/certs</code></p>\n<p>I recommend to <code>docker exec</code> to the fhir server container and confirm you can dereference that from there (and that it has the expected cert).<br>\nAssuming that works, then perhaps you'll need to add the TLS cert for that endpoint to your server's truststore.</p>",
        "id": 274535208,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1646743414
    },
    {
        "content": "<p>In general, that shouldn't be needed for a valid cert that is signed by a trusted root CA because we set SEC_TLS_TRUSTDEFAULTCERTS to true by default :  <a href=\"https://github.com/IBM/FHIR/blob/main/fhir-server-webapp%2Fsrc%2Fmain%2Fliberty%2Fconfig%2FconfigDropins%2Fdefaults%2FtrustDefault.xml#L3\">https://github.com/IBM/FHIR/blob/main/fhir-server-webapp%2Fsrc%2Fmain%2Fliberty%2Fconfig%2FconfigDropins%2Fdefaults%2FtrustDefault.xml#L3</a></p>\n<p>So while you're in there you could confirm that:</p>\n<ol>\n<li>you have our <code>trustDefault.xml</code> snippet in your configDropins/defaults; and</li>\n<li>you havn't overridden the SEC_TLS_TRUSTDEFAULTCERTS env var to something other than true</li>\n</ol>",
        "id": 274535496,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1646743569
    },
    {
        "content": "<p>Hi Lee, thank you for getting back to us so quickly. We are able to confirm 1. and 2. and your suspicion was correct: We could <strong>not</strong> reach the KeyCloak server at <code>https://keycloak.example.tech</code> from within the docker container. We'll investigate why that is the case a bit later today and report back to you <span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span></p>",
        "id": 274653649,
        "sender_full_name": "Yannick Börner",
        "timestamp": 1646812851
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191676\">@Lee Surprenant</span> We were able to find the issue thanks to your hints! However, the actual cause is too embarrassing for us to reveal :D</p>",
        "id": 274739128,
        "sender_full_name": "Yannick Börner",
        "timestamp": 1646853805
    },
    {
        "content": "<p>Oh, we’ve all been there :-)</p>",
        "id": 274739372,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1646853896
    }
]