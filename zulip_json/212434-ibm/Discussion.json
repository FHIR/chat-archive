[
    {
        "content": "<p>A new entry in the performance testing landscape:  <a href=\"#narrow/stream/179239-tooling/topic/Tests.20for.20FHIR.20REST.20API.3A.20stresty\" title=\"#narrow/stream/179239-tooling/topic/Tests.20for.20FHIR.20REST.20API.3A.20stresty\">https://chat.fhir.org/#narrow/stream/179239-tooling/topic/Tests.20for.20FHIR.20REST.20API.3A.20stresty</a></p>",
        "id": 182673319,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1575561514
    },
    {
        "content": "<p>The other one (thats been on my list to look into again for a LONG time) was <a href=\"https://github.com/FirelyTeam/Wind.Tunnel\" target=\"_blank\" title=\"https://github.com/FirelyTeam/Wind.Tunnel\">https://github.com/FirelyTeam/Wind.Tunnel</a></p>",
        "id": 182673411,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1575561566
    },
    {
        "content": "<p>would be great if we could help one of these get to \"industry benchmark\" level</p>",
        "id": 182673438,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1575561580
    },
    {
        "content": "<p>I wonder what we do on this front:  <a href=\"#narrow/stream/179166-implementers/topic/Searching.20with.20_elements.20and.20choice.20types\" title=\"#narrow/stream/179166-implementers/topic/Searching.20with.20_elements.20and.20choice.20types\">https://chat.fhir.org/#narrow/stream/179166-implementers/topic/Searching.20with.20_elements.20and.20choice.20types</a></p>",
        "id": 182723739,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1575598442
    },
    {
        "content": "<p>since its built into our parser, i'm guessing we actually want the full choiceElement (e.g. valueQuantity and not just value)?</p>",
        "id": 182723753,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1575598475
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"197632\">@Gidon Gershinsky</span> I saw your post at <a href=\"#narrow/stream/179250-bulk-data/topic/Parquet.20Bulk.20Data.20format\" title=\"#narrow/stream/179250-bulk-data/topic/Parquet.20Bulk.20Data.20format\">https://chat.fhir.org/#narrow/stream/179250-bulk-data/topic/Parquet.20Bulk.20Data.20format</a> :-)<br>\nI'm not sure if it helps you or not, but we have a module called <code>fhir-examples</code> which contains:</p>\n<ol>\n<li>all examples from the fhir spec;</li>\n<li>a set of generated examples from us which includes:</li>\n</ol>\n<ul>\n<li>\"minimal\" examples for each </li>\n<li>\"complete-mock\" examples which include fake data in every field</li>\n<li>\"complete-absent\" examples which include every field but no data</li>\n<li>a set of \"index\" files for quickly iterating over subsets of the examples</li>\n</ul>\n<ol start=\"3\">\n<li>a couple simple java classes to help get a Reader for the index files and resource examples</li>\n</ol>",
        "id": 182776374,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1575649037
    },
    {
        "content": "<p>\"complete-absent\" examples are especially helpful for finding cases where you fail to deal with the fact all fhir primitives can have extensions and no data (a common source of NullPointerExceptions)</p>",
        "id": 182776525,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1575649119
    },
    {
        "content": "<p>finally, to ensure strong test coverage, the generated examples include at least one resource example for each allowed \"choice\".  for example, if a resource has an element choice[x] with 3 allowed choices, we generate at least 3 examples of this resource.</p>",
        "id": 182776823,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1575649309
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 182777501,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1575649727
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191676\">@Lee Surprenant</span>  thanks, this is certainly helpful. We understand Parquet encryption, but any assistance with FHIR will be appreciated. In fact, it will be great if we can work together on that channel, pushing Parquet-for-FHIR-standard; or, at the very least, if we can be in touch with you to get advice on FHIR-related questions.</p>",
        "id": 182894357,
        "sender_full_name": "Gidon Gershinsky",
        "timestamp": 1575814118
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"197632\">@Gidon Gershinsky</span> <span class=\"user-mention\" data-user-id=\"251796\">@Eliot Salant</span> <br>\nper a quick search, here are the spec examples with contained resources:</p>\n<div class=\"codehilite\"><pre><span></span>activitydefinition-medicationorder-example.json\nactivitydefinition-questionnaire.json\nactualgroup-questionnaire.json\nallergyintolerance-questionnaire.json\nauditevent-example-error.json\nauditevent-questionnaire.json\nbiologicallyderivedproduct-questionnaire.json\nbmi-questionnaire.json\nbodyheight-questionnaire.json\nbodytemp-questionnaire.json\nbodyweight-questionnaire.json\nbp-questionnaire.json\ncareplan-example-f001-heart.json\ncareplan-example-f002-lung.json\ncareplan-example-f003-pharynx.json\ncareplan-example-f201-renal.json\ncareplan-example-f202-malignancy.json\ncareplan-example-f203-sepsis.json\ncareplan-example-GPVisit.json\ncareplan-example-integrated.json\ncareplan-example-pregnancy.json\ncareplan-example.json\ncareplan-questionnaire.json\ncareteam-example.json\ncatalog-questionnaire.json\ncdshooksrequestgroup-questionnaire.json\ncdshooksserviceplandefinition-questionnaire.json\nchargeitem-questionnaire.json\ncholesterol-questionnaire.json\nclaim-example-cms1500-medical.json\nclaim-example-oral-bridge.json\nclaim-example-oral-contained-identifier.json\nclaim-example-oral-contained.json\nclaim-example-vision-glasses-3tier.json\nclaim-questionnaire.json\nclaimresponse-questionnaire.json\nclinicaldocument-questionnaire.json\nclinicalimpression-questionnaire.json\ncodesystem-questionnaire.json\ncommunication-example-fm-solicited-attachment.json\ncommunication-questionnaire.json\ncommunicationrequest-example-fm-solicit-attachment.json\ncommunicationrequest-questionnaire.json\ncomposition-questionnaire.json\ncomputableplandefinition-questionnaire.json\nconceptmap-questionnaire.json\ncondition-questionnaire.json\nconsent-questionnaire.json\ncontract-questionnaire.json\ncoverage-questionnaire.json\ncoverageeligibilityrequest-questionnaire.json\ncoverageeligibilityresponse-example-benefits-2.json\ncoverageeligibilityresponse-questionnaire.json\ncqf-questionnaire-questionnaire.json\ncqllibrary-questionnaire.json\ndetectedissue-questionnaire.json\ndevicedefinition-questionnaire.json\ndevicemetricobservation-questionnaire.json\ndevicerequest-questionnaire.json\ndeviceusestatement-questionnaire.json\ndiagnosticreport-genetics-questionnaire.json\ndiagnosticreport-questionnaire.json\ndocumentmanifest-example.json\ndocumentmanifest-fm-attachment.json\ndocumentreference-example.json\nelementdefinition-de-questionnaire.json\nencounter-example-home.json\neventdefinition-questionnaire.json\nevidencevariable-questionnaire.json\nexplanationofbenefit-questionnaire.json\nfamilymemberhistory-genetic-questionnaire.json\nfamilymemberhistory-questionnaire.json\ngoal-questionnaire.json\ngroup-questionnaire.json\ngroupdefinition-questionnaire.json\nguidanceresponse-example.json\nguidanceresponse-questionnaire.json\nhdlcholesterol-questionnaire.json\nheadcircum-questionnaire.json\nhealthcareservice-example.json\nheartrate-questionnaire.json\nhlaresult-questionnaire.json\nimmunization-questionnaire.json\nimmunizationevaluation-questionnaire.json\nimmunizationrecommendation-questionnaire.json\nimplementationguide-questionnaire.json\ninvoice-questionnaire.json\njson-edge-cases.json\nldlcholesterol-questionnaire.json\nlibrary-questionnaire.json\nlipidprofile-questionnaire.json\nlist-example-double-cousin-relationship-pedigree.json\nlist-example-familyhistory-f201-roel.json\nlist-example-familyhistory-genetics-profile-annie.json\nlist-example-familyhistory-genetics-profile.json\nmeasure-questionnaire.json\nmeasurereport-cms146-cat1-example.json\nmeasurereport-cms146-cat2-example.json\nmeasurereport-cms146-cat3-example.json\nmedia-questionnaire.json\nmedication-questionnaire.json\nmedicationadministration-questionnaire.json\nmedicationadministration0301.json\nmedicationadministration0302.json\nmedicationadministration0303.json\nmedicationadministration0304.json\nmedicationadministration0305.json\nmedicationadministration0306.json\nmedicationadministration0307.json\nmedicationadministration0309.json\nmedicationadministration0310.json\nmedicationadministration0311.json\nmedicationadministrationexample3.json\nmedicationdispense-questionnaire.json\nmedicationdispense0301.json\nmedicationdispense0302.json\nmedicationdispense0303.json\nmedicationdispense0304.json\nmedicationdispense0305.json\nmedicationdispense0306.json\nmedicationdispense0308.json\nmedicationdispense0309.json\nmedicationdispense0310.json\nmedicationdispense0312.json\nmedicationdispense0313.json\nmedicationdispense0314.json\nmedicationdispense0315.json\nmedicationdispense0317.json\nmedicationdispense0319.json\nmedicationdispense0320.json\nmedicationdispense0329.json\nmedicationdispense0330.json\nmedicationdispense0331.json\nmedicationdispenseexample8.json\nmedicationexample0301.json\nmedicationexample0302.json\nmedicationexample0303.json\nmedicationexample0304.json\nmedicationexample0305.json\nmedicationexample0306.json\nmedicationexample0307.json\nmedicationexample0308.json\nmedicationexample0309.json\nmedicationexample0310.json\nmedicationexample0311.json\nmedicationexample0312.json\nmedicationexample0316.json\nmedicationexample0320.json\nmedicationexample0321.json\nmedicationexample15.json\nmedicationknowledge-example.json\nmedicationknowledge-questionnaire.json\nmedicationrequest-questionnaire.json\nmedicationrequest0301.json\nmedicationrequest0302.json\nmedicationrequest0303.json\nmedicationrequest0304.json\nmedicationrequest0305.json\nmedicationrequest0306.json\nmedicationrequest0307.json\nmedicationrequest0309.json\nmedicationrequest0310.json\nmedicationrequest0315.json\nmedicationrequest0316.json\nmedicationrequest0317.json\nmedicationrequest0318.json\nmedicationrequest0319.json\nmedicationrequest0321.json\nmedicationrequest0322.json\nmedicationrequest0323.json\nmedicationrequest0328.json\nmedicationrequest0329.json\nmedicationrequest0330.json\nmedicationrequest0331.json\nmedicationrequest0332.json\nmedicationrequest0333.json\nmedicationrequest0336.json\nmedicationrequest0337.json\nmedicationrequest0338.json\nmedicationrequest0339.json\nmedicationrequestexample1.json\nmedicationstatement-questionnaire.json\nmedicationstatementexample1.json\nmedicationstatementexample2.json\nmedicationstatementexample7.json\nmedicinalproduct-questionnaire.json\nmedicinalproductauthorization-questionnaire.json\nmedicinalproductcontraindication-questionnaire.json\nmedicinalproductindication-questionnaire.json\nmedicinalproductinteraction-questionnaire.json\nmessagedefinition-questionnaire.json\nmessageheader-questionnaire.json\nnutritionorder-questionnaire.json\nobservation-example-10minute-apgar-score.json\nobservation-example-1minute-apgar-score.json\nobservation-example-20minute-apgar-score.json\nobservation-example-2minute-apgar-score.json\nobservation-example-5minute-apgar-score.json\nobservation-genetics-questionnaire.json\nobservation-questionnaire.json\noxygensat-questionnaire.json\nparameters-questionnaire.json\npatient-questionnaire.json\npicoelement-questionnaire.json\nplandefinition-example-cardiology-os.json\nplandefinition-example-kdn5-simplified.json\nplandefinition-example.json\nplandefinition-options-example.json\nplandefinition-protocol-example.json\nplandefinition-questionnaire.json\nprocedure-questionnaire.json\nprovenance-questionnaire.json\nquestionnaire-example-gcs.json\nquestionnaire-profile-example-ussg-fht.json\nquestionnaire-questionnaire.json\nquestionnaireresponse-example.json\nquestionnaireresponse-questionnaire.json\nrequestgroup-example.json\nrequestgroup-kdn5-example.json\nrequestgroup-questionnaire.json\nresearchdefinition-questionnaire.json\nresearchelementdefinition-questionnaire.json\nresprate-questionnaire.json\nriskassessment-example-population.json\nriskassessment-questionnaire.json\nservicerequest-example-lipid.json\nservicerequest-example2.json\nservicerequest-genetics-questionnaire.json\nservicerequest-questionnaire.json\nshareableactivitydefinition-questionnaire.json\nshareablecodesystem-questionnaire.json\nshareablelibrary-questionnaire.json\nshareablemeasure-questionnaire.json\nshareableplandefinition-questionnaire.json\nshareablevalueset-questionnaire.json\nspecimen-example-isolate.json\nspecimen-example.json\nspecimen-questionnaire.json\nspecimendefinition-questionnaire.json\nstructuremap-questionnaire.json\nsubstance-example-amoxicillin-clavulanate.json\nsubstance-questionnaire.json\nsubstancereferenceinformation-questionnaire.json\nsubstancespecification-questionnaire.json\nsupplydelivery-questionnaire.json\nsupplyrequest-questionnaire.json\ntask-example1.json\ntask-questionnaire.json\ntriglyceride-questionnaire.json\nvalueset-example-hierarchical.json\nvalueset-nhin-purposeofuse.json\nvalueset-questionnaire.json\nvaluesets.json (2 matches)\nvitalsigns-questionnaire.json\nvitalspanel-questionnaire.json\n</pre></div>",
        "id": 182967223,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1575905855
    },
    {
        "content": "<p>you have a couple options for getting them:</p>\n<ol>\n<li>download them from the spec:  navigate to <a href=\"https://www.hl7.org/fhir/downloads.html\" target=\"_blank\" title=\"https://www.hl7.org/fhir/downloads.html\">https://www.hl7.org/fhir/downloads.html</a> and donwload the JSON \"Examples\"</li>\n<li>grab them from our <code>fhir-examples</code> project...as indicated above we've copied all the spec examples into a module (and combined with some of our own) and added a couple helper classes for getting them.  for example, you could add a new <code>index</code> file that contains just the examples listed above</li>\n</ol>",
        "id": 182967674,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1575906085
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192334\">@John Timm</span> where, in your opinion, would a utility such as this belong:</p>\n<div class=\"codehilite\"><pre><span></span>    protected Code convertToCodeSubtype(Visitable parent, String elementName, Code value) {\n        Class&lt;?&gt; targetType = ModelSupport.getElementType(parent.getClass(), elementName);\n        if (value.getClass() != targetType) {\n            MethodType mt = MethodType.methodType(targetType, String.class);\n            try {\n                MethodHandle methodHandle = MethodHandles.publicLookup().findStatic(targetType, &quot;of&quot;, mt);\n                value = (Code) methodHandle.invoke(((Code)value).getValue());\n            } catch (Throwable e) {\n                throw new IllegalArgumentException(&quot;Value of type &#39;&quot; + value.getClass() +\n                    &quot;&#39; cannot be used to populate target of type &#39;&quot; + targetType + &quot;&#39;&quot;);\n            }\n        }\n        return value;\n    }\n</pre></div>",
        "id": 187451022,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1580907823
    },
    {
        "content": "<p>currently I have that in the CopyingVisitor which my FHIRPathPatch visitors extend (they are the only ones using it today), but I'm wondering if it should be a static helper instead</p>",
        "id": 187451096,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1580907873
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192334\">@John Timm</span> another one for you.  Today we have both:</p>\n<ul>\n<li><code>ModelSupport.getTypeName(Class&lt;?&gt; type)</code></li>\n<li>\n<p><code>ModelSupport.getResourceTypes()</code><br>\n and </p>\n</li>\n<li>\n<p><code>FHIRUtil.getResourceTypeName(Resource resource)</code></p>\n</li>\n<li><code>FHIRUtil.getResourceTypeNames()</code> </li>\n</ul>\n<p>In general, I think we were deprecating the methods in FHIRUtil and switching things over to ModelSupport.<br>\nShould we deprecate <code>FHIRUtil.getResourceTypeNames()</code> in favor of <code>ModelSupport.getResourceTypes()</code>?<br>\nShould we  introduce a <code>ModelSupport.getResourceTypeNames()</code> and deprecate  <code>FHIRUtil.getResourceTypeNames()</code>?</p>\n<p>Also, as you look at <a href=\"https://github.com/IBM/FHIR/issues/623\" target=\"_blank\" title=\"https://github.com/IBM/FHIR/issues/623\">https://github.com/IBM/FHIR/issues/623</a>, I'm wondering if we should have a variant of the <code>getResourceTypes()</code> and <code>getResourceTypeNames()</code> methods that controls whether or not they return:<br>\nA. abstract supertypes like Resource / DomainResource; and/or<br>\nB. \"logical\" resource types like MetadataResource (and/or Definition?)</p>",
        "id": 187558145,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1581003186
    },
    {
        "content": "<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"192334\">John Timm</span> where, in your opinion, would a utility such as this belong:</p>\n</blockquote>\n<div class=\"codehilite\"><pre><span></span>protected Code convertToCodeSubtype(Visitable parent, String elementName, Code value) {\n    Class&lt;?&gt; targetType = ModelSupport.getElementType(parent.getClass(), elementName);\n    if (value.getClass() != targetType) {\n        MethodType mt = MethodType.methodType(targetType, String.class);\n        try {\n            MethodHandle methodHandle = MethodHandles.publicLookup().findStatic(targetType, &quot;of&quot;, mt);\n            value = (Code) methodHandle.invoke(((Code)value).getValue());\n        } catch (Throwable e) {\n            throw new IllegalArgumentException(&quot;Value of type &#39;&quot; + value.getClass() + \n                &quot;&#39; cannot be used to populate target of type &#39;&quot; + targetType + &quot;&#39;&quot;);\n        }\n    }\n    return value;\n}\n</pre></div>\n\n\n<div class=\"codehilite\"><pre><span></span>\n</pre></div>\n\n\n<p>I think we can leave it where it is for now. I think we'd like to encourage users of the API to use the code subtypes directly.</p>",
        "id": 187559829,
        "sender_full_name": "John Timm",
        "timestamp": 1581004288
    },
    {
        "content": "<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"192334\">John Timm</span> another one for you.  Today we have both:</p>\n<ul>\n<li><code>ModelSupport.getTypeName(Class&lt;?&gt; type)</code></li>\n<li>\n<p><code>ModelSupport.getResourceTypes()</code><br>\n and </p>\n</li>\n<li>\n<p><code>FHIRUtil.getResourceTypeName(Resource resource)</code></p>\n</li>\n<li><code>FHIRUtil.getResourceTypeNames()</code> </li>\n</ul>\n<p>In general, I think we were deprecating the methods in FHIRUtil and switching things over to ModelSupport.<br>\nShould we deprecate <code>FHIRUtil.getResourceTypeNames()</code> in favor of <code>ModelSupport.getResourceTypes()</code>?<br>\nShould we  introduce a <code>ModelSupport.getResourceTypeNames()</code> and deprecate  <code>FHIRUtil.getResourceTypeNames()</code>?</p>\n<p>Also, as you look at <a href=\"https://github.com/IBM/FHIR/issues/623\" target=\"_blank\" title=\"https://github.com/IBM/FHIR/issues/623\">https://github.com/IBM/FHIR/issues/623</a>, I'm wondering if we should have a variant of the <code>getResourceTypes()</code> and <code>getResourceTypeNames()</code> methods that controls whether or not they return:<br>\nA. abstract supertypes like Resource / DomainResource; and/or<br>\nB. \"logical\" resource types like MetadataResource (and/or Definition?)</p>\n</blockquote>\n<p>There's really only one logical resource type that we need to deal with at the moment (MetadataResource). The list will should not return \"logical\" resource types once 623 is completed. As for \"abstract\" resource types, the client could filter those out pretty easily (really it's only Resource and DomainResource). I will think about this as I work 623 and whether we should introduce other method signatures. I agree that we should deprecate FHIRUtil methods that overlap with ModelSupport.</p>",
        "id": 187560034,
        "sender_full_name": "John Timm",
        "timestamp": 1581004428
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"197632\">@Gidon Gershinsky</span> <span class=\"user-mention\" data-user-id=\"251796\">@Eliot Salant</span> FYI I wrote up a guide on \"how to create a new persistence layer\" for the IBM FHIR Server:  <a href=\"https://ibm.github.io/FHIR/guides/BringYourOwnPersistence\" target=\"_blank\" title=\"https://ibm.github.io/FHIR/guides/BringYourOwnPersistence\">https://ibm.github.io/FHIR/guides/BringYourOwnPersistence</a></p>",
        "id": 188478011,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1582050875
    },
    {
        "content": "<p>please let me know what you think</p>",
        "id": 188478018,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1582050880
    },
    {
        "content": "<p>I recently did some work to enable OpenID Connect / OAuth 2.0 in my local branch.  We've had some exemplary config commented out in our default <code>server.xml</code> for quite some time, but I never had the time to try it out until now.<br>\n<a href=\"https://github.com/IBM/FHIR/pull/939\" title=\"https://github.com/IBM/FHIR/pull/939\">https://github.com/IBM/FHIR/pull/939</a> modifies this commented out config in order to pass more of the Inferno test tool, although work remains to pass more of it.</p>",
        "id": 194673259,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1587388773
    },
    {
        "content": "<p>One thing I discovered during this effort is that Liberty supports \"dynamic client registration\", but that it requires you to create 3 tables associated with storing and caching the clients in a databaseStore.<br>\nPaul added a comment to suggest moving the DDL for these tables out of our doc and into somewhere more executable:<br>\n<a href=\"https://github.com/IBM/FHIR/pull/939/files/6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b#diff-46968fda8c8c67feeaad01de47b14d30\" title=\"https://github.com/IBM/FHIR/pull/939/files/6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b#diff-46968fda8c8c67feeaad01de47b14d30\">https://github.com/IBM/FHIR/pull/939/files/6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b#diff-46968fda8c8c67feeaad01de47b14d30</a></p>\n<p>Question:  is it worth moving these into <code>fhir-persistence-schema</code> so they can get created like the rest of our tables?<br>\nShould they have their own separate \"action\"? (e.g. a <code>--oauth-client-store</code> flag you pass to the tool to have it create these)?</p>",
        "id": 194673972,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1587389118
    },
    {
        "content": "<p>I think it's worthy of a separate action</p>",
        "id": 194811886,
        "sender_full_name": "Paul Bastide",
        "timestamp": 1587480217
    },
    {
        "content": "<p>when I see it laid out here, I think a separate flag makes sense</p>",
        "id": 194811930,
        "sender_full_name": "Paul Bastide",
        "timestamp": 1587480233
    },
    {
        "content": "<p>it's a good idea</p>",
        "id": 194811940,
        "sender_full_name": "Paul Bastide",
        "timestamp": 1587480237
    },
    {
        "content": "<p>haha, I just pushed an update that creates it as part of the create-schema and update-schema actions</p>",
        "id": 194855282,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1587499947
    },
    {
        "content": "<p>i pushed and then signed on here and saw your messages</p>",
        "id": 194855316,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1587499963
    },
    {
        "content": "<p>no worries - I think both are fine!</p>",
        "id": 194925162,
        "sender_full_name": "Paul Bastide",
        "timestamp": 1587560111
    },
    {
        "content": "<p>Issue 1504 analysis:</p>\n<p><strong>Current processing of local references for transaction bundles:</strong></p>\n<ol>\n<li>bundle entries can have a local reference specified in the Bundle.Entry.fullUrl field - the local reference must start with 'urn:'</li>\n<li>for resources specified in POST and PUT requests, we look for reference fields containing references starting with 'urn:' and if they match a bundle entry local reference, we replace them with the actual resource reference of the resource in the matching bundle entry</li>\n<li>\n<p>we build a map of [local reference --&gt; real resource reference] to enable the local reference resolution in the previous step. The map is built as follows:<br>\n   a. after a POST request is processed, its [local ref --&gt; real resource ref] mapping is added to the map (because it's only at that point that we know the logical ID the resource was created with)<br>\n   b. after all POST resources have been processed, but before any PUT resources have been processed, all PUT [local ref --&gt; real resource ref] mappings are added to the map (we can do this before processing because PUT requests are updates, so resources already have logical ID set)</p>\n</li>\n<li>\n<p>processing order of requests is all POST requests first, then PUT requests</p>\n</li>\n</ol>\n<p><strong>With current code, the following scenarios work:</strong></p>\n<ol>\n<li>any POST resource containing a local reference to a POST resource processed before it in the bundle will have the reference resolved properly because each POST resource has its mapping added to the map after being processed, meaning a mapping for a resource already processed will exist when a resource lower in the bundle is processed</li>\n<li>any PUT resource containing a local reference to a POST resource will have the reference resolved properly because all POST resources will have their mappings added to the map before any PUT resources are processed.</li>\n<li>any PUT resource containing a local reference to another PUT resource will have the reference resolved properly because all PUT resources will have their mappings added to the map before any PUT resources are processed.</li>\n</ol>\n<p><strong>With current code, the following scenarios fail:</strong></p>\n<ol>\n<li>any POST resource containing a local reference to a PUT resource will not have the reference resolved properly because the PUT resources will not have their mappings added to the map until after all POST resources have been processed.</li>\n<li>any POST resource containing a local reference to a POST resource below it in the bundle will not have the reference resolved properly because the POST resource lower in the bundle will not have its mapping in the map at the time the resource higher in the bundle is processed.</li>\n</ol>\n<p><strong>Options to fix failing scenarios:</strong></p>\n<ul>\n<li>Failing scenario 1 can be fixed simply by adding PUT resource mappings to the map before processing POST resources</li>\n<li>Failing scenario 2 I think can only be fixed by 'pre-allocating' logical IDs for resources to be created. This would allow the mappings to be added to the map before processing any POST resources, but would require that the logical ID be passed into and used by the persistence layer on resource creation.</li>\n</ul>\n<p><strong>Cases where mapping can't be added until after resource is processed:</strong></p>\n<ol>\n<li>On POSTs, there is a conditional create option based on the Bundle.Entry.Request.ifNoneExist field. A search query can be specified in that field, and if a single search result is found for that query, the POSTed resource is not created. Instead, the metadata for the search result will be returned, meaning that the logical ID could be different than a pre-allocated ID. So if that Bundle.Entry.Request.ifNoneExist field is populated, we wouldn't want to add a mapping before processing that resource.</li>\n<li>On PUTs, there is a conditional update option based on the Bundle.Entry.Request.url field. A search query can be specified on the end of that url (i.e. Patient?_id=abc). If no search results are returned for the query AND if the resource ID is null, a create will be performed rather than an update, meaning we wouldn't know the logical ID until after the create. So if the Bundle.Entry.Request.url field contains a query string, we wouldn't want to add a mapping before processing that resource.</li>\n</ol>\n<ul>\n<li>For these cases, if we really wanted to support resolution of local references to them, we could execute the searches prior to fully processing the resources, just to get the logical ID for our mappings.</li>\n</ul>",
        "id": 212329606,
        "sender_full_name": "Mike Schroeder",
        "timestamp": 1601918129
    },
    {
        "content": "<p>Great analysis.  Does FHIR spec say anything about those \"failing scenarios\"?  Trying to gauge whether a client should reasonably expect those scenarios to work or not...</p>",
        "id": 212334482,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1601920715
    },
    {
        "content": "<p>My current inclination would be to make the easy fix for scenario 1 and just punt on scenario 2 (unless we think this violates the specification in some way)</p>",
        "id": 212334613,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1601920787
    },
    {
        "content": "<p>The spec (<a href=\"https://www.hl7.org/fhir/http.html#transaction\">https://www.hl7.org/fhir/http.html#transaction</a>) isn't real straight-forward, but it does say the following:<br>\n<code>A transaction may include references from one resource to another in the bundle, including circular references where resources refer to each other. When the server assigns a new id to any resource in the bundle which has a POST method as part of the processing rules above, it SHALL also update any references to that resource in the same bundle as they are processed (see about Ids in a bundle).</code><br>\nI think that implies we should probably support both failing scenarios. As far as the conditional create and updates, the spec says this:<br>\n<code>Note that transactions and conditional create/update/delete are complex interactions and it is not expected that every server will implement them. Servers that don't support the batches or transactions SHOULD return an HTTP 400 error and MAY include an OperationOutcome. </code><br>\nSo I think it's more reasonable that we don't support local references to bundle entries with conditional creates/updates - the last 2 scenarios listed above.</p>",
        "id": 212336541,
        "sender_full_name": "Mike Schroeder",
        "timestamp": 1601921689
    },
    {
        "content": "<blockquote>\n<p>it SHALL also update any references to that resource in the same bundle as they are processed (see about Ids in a bundle)</p>\n</blockquote>\n<p>really wonder what they mean by \"as they are processed\" there and whether it could be construed to support our current behavior where order matters</p>",
        "id": 212339120,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1601922886
    },
    {
        "content": "<p>i guess that reading doesn't jive with the \"circular\" comment</p>",
        "id": 212339299,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1601922970
    },
    {
        "content": "<p>so what would pre-computing resource ids look like?<br>\nsomething like this:</p>\n<ol>\n<li>turn the \"generate a new resource id into standalone utility (if it isn't already)...currently that is used in <code>create</code></li>\n<li>use this utility to generate a resource id for any resources being created as part of the bundle</li>\n<li>under the covers, during bundle processing, we switch all the <code>create</code> operations into <code>create-via-update</code> operations and pass our pre-allocated resource id to ResourceHelper.doUpdate (instead of calling doCreate like it does now)<br>\n?</li>\n</ol>",
        "id": 212339841,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1601923216
    },
    {
        "content": "<blockquote>\n<p>So I think it's more reasonable that we don't support local references to bundle entries with conditional creates/updates - the last 2 scenarios listed above.</p>\n</blockquote>\n<p>+1 from me on this part of it</p>",
        "id": 212339874,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1601923232
    },
    {
        "content": "<p>I was thinking the following for the pre-allocation process:</p>\n<p>Currently, the FHIRPersistence class generates the new ID in its create() method. I think we'd want to do the following:</p>\n<ol>\n<li>Turn the ID generator into stand-alone utility (one already exists for the JDBC persistence layer - TimestampPrefixedUUID - which is called by FHIRPersistenceJDBCImpl.create() ).</li>\n<li>Either 1) add a new FHIRPersistence.create() interface, same as the current one except that it takes one additional parameter - 'logicalId', or 2) just change the existing create() interface to take the additional 'logicalId' parameter</li>\n<li>Add a new ResourceHelper.doCreate() interface (or just change the existing doCreate() interface) that takes the additional 'logicalId' parameter, which will be passed along to the FHIRPersistence.create() method.</li>\n<li>For all non-conditional POST requests, generate an ID and add a mapping to the [local ref--&gt;real resource ref] mapping table</li>\n<li>Now just process the POST requests followed by the PUT requests as we do now, with the slight change that POST requests will pass their logicalId on the call to doCreate(). Since we've got a mapping for every non-conditional POST or PUT request in the mapping table before starting any processing, all local references should be resolved properly to their actual resource references, regardless of order of processing.  </li>\n</ol>\n<p>But I like your idea of calling doUpdate and using the <code>create-via-update</code>path instead of messing with adding/changing the doCreate() interfaces. Would just have to make sure the Bundle.Entry.Response sent back was equivalent to what would be sent back from doCreate.</p>",
        "id": 212345108,
        "sender_full_name": "Mike Schroeder",
        "timestamp": 1601925740
    },
    {
        "content": "<p>pretty sure that we do return a 201 when you PUT for the first time (create-on-update).  but seems your approach would work similarly.  no strong preference.  i think the most \"interesting\" bit will be where to put the newly-extracted utility for generating ids.  <br>\ni sort of like the idea of delegating that to the PL (so, for example, our jdbc impl can generate these special ids, but a different PL could do simpler ones), but I think it will be much easier just move the code to <code>fhir-core</code> (or similar)</p>",
        "id": 212345597,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1601926033
    }
]