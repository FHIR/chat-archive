[
    {
        "content": "<p>Hello,</p>\n<p>We're trying to get the IBM FHIR server running with SMART launch context. We have an application that issues JWTs, and we can successfully authenticate users using the mpJwt feature. We're now looking to limit the scope of these users using the <code>fhir-smart</code> userlib module. However, we think the PersistenceInterceptor is not being loaded, because we can't find the log messages relating to the <code>FHIRPersistenceInterceptorMgr</code> or <code>AuthzPolicyEnforcementPersistenceInterceptor</code>.</p>\n<p>The contents of our userlib directory, using <code>github.com/Alvearie/health-patterns/data-access</code> as a base, but increasing the version to 4.10.1:</p>\n<div class=\"codehilite\"><pre><span></span><code>fhir-smart-4.10.1.jar\nfhir-ig-us-core-4.10.1.jar\n</code></pre></div>\n<p>Last log lines after startup:</p>\n<div class=\"codehilite\"><pre><span></span><code>ibm-fhir_1   | [11/24/21, 15:56:25:081 UTC] 00000037 FeatureManage A   CWWKF0012I: The server installed the following features: [appSecurity-2.0, appSecurity-3.0, batch-1.0, batchManagement-1.0, cdi-2.0, distributedMap-1.0, el-3.0, jaxrs-2.1, jaxrsClient-2.1, jdbc-4.1, jndi-1.0, json-1.0, jsonp-1.1, jwt-1.0, localConnector-1.0, mpConfig-2.0, mpJwt-1.2, servlet-4.0, ssl-1.0, transportSecurity-1.0, websocket-1.1].\nibm-fhir_1   | [11/24/21, 15:56:25:081 UTC] 00000037 FeatureManage I   CWWKF0008I: Feature update completed in 5.830 seconds.\nibm-fhir_1   | [11/24/21, 15:56:25:081 UTC] 00000037 FeatureManage A   CWWKF0011I: The defaultServer server is ready to run a smarter planet. The defaultServer server started in 6.807 seconds.\n</code></pre></div>\n<p>After sending a request with one of our issued JWTs. The requesting user is being recognized correctly (<a href=\"mailto:1@gmail.com\">1@gmail.com</a>):</p>\n<div class=\"codehilite\"><pre><span></span><code>ibm-fhir_1   | [11/24/21, 15:58:04:786 UTC] 0000005a Authenticatio I   CWWKS4358I: The authentication filter filter configuration was successfully processed.\nibm-fhir_1   | [11/24/21, 15:58:05:095 UTC] 0000005a FHIRRestServl I   Received request: tenantId:[default] dsId:[default] user:[1@gmail.com] method:[GET] uri:[http://ibm-fhir:9080/fhir-server/api/v4/Patient?_id=selfmeasurements-send-patient1]\nibm-fhir_1   | [11/24/21, 15:58:05:263 UTC] 0000005a FHIRRestServl I   Completed request[0.172 secs]: tenantId:[default] dsId:[default] user:[1@gmail.com] method:[GET] uri:[http://ibm-fhir:9080/fhir-server/api/v4/Patient?_id=selfmeasurements-send-patient1] status:[403]\n</code></pre></div>\n<p>What are we missing, do we need to take aditional steps to use the fhir-smart module?</p>\n<p>Thanks in advance!</p>",
        "id": 262608469,
        "sender_full_name": "Sibren Talens",
        "timestamp": 1637770353
    },
    {
        "content": "<p>Hi Sibren.  I havn't gotten around to updating <code>github.com/Alvearie/health-patterns/data-access</code> for the latest release yet and so I think whats happening here is a version mismatch where the base fhir server is 4.9 but the interceptors are 4.10.1.  ordinarily that might work, but we changed the package name for the FHIRPersistenceInterceptor interface in 4.10...which just means the ibm fhir server version really needs to match across this version boundary.  if you havn't yet, please update <a href=\"https://github.com/Alvearie/health-patterns/blob/main/data-access/docker-compose.yaml#L4\">this line</a> to 4.10.1 and see if that clears up your issue.  i'll be off the next couple days with the thanksgiving holiday, but do let us know how it goes.  best of luck!</p>",
        "id": 262652003,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1637797382
    },
    {
        "content": "<p>ps. a good way to check the version of the running server is to hit the <code>[host]/fhir-server/api/v4/metadata</code> and look for a software version field</p>",
        "id": 262652163,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1637797542
    },
    {
        "content": "<p>Hi Lee, thanks for the help! We tried running the <code>data-access</code> project on the 4.9.2 version (with matching userlib dependencies), but we still can't seem to find the log lines we're looking for to confirm that the fhir-smart module has been loaded properly.</p>\n<p>We've set <code>TRACE_SPEC=\"*=all\"</code> and we're looking for the log lines from the <a href=\"https://github.com/IBM/FHIR/blob/4.9.2/fhir-persistence/src/main/java/com/ibm/fhir/persistence/interceptor/impl/FHIRPersistenceInterceptorMgr.java#L44-L60\"><code>FHIRPersistenceInterceptorMgr</code></a> constructor.</p>\n<p>Is there another way to confirm that the <code>fhir-smart</code> module has been loaded?</p>",
        "id": 263114836,
        "sender_full_name": "Sibren Talens",
        "timestamp": 1638262413
    },
    {
        "content": "<p>hi sibren, sorry for the delay.  bumping the trace_spec seems like it should have worked, although I'd expect <code>*=all</code> to be SUPER noisy</p>",
        "id": 263319528,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1638377108
    },
    {
        "content": "<blockquote>\n<p>Is there another way to confirm that the fhir-smart module has been loaded?</p>\n</blockquote>\n<p>if you make a request to a patient compartment resource without the appropriate scopes in your otherwise valid jwt ;-)</p>",
        "id": 263319658,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1638377161
    },
    {
        "content": "<p>I ran through the README at <a href=\"http://github.com/Alvearie/health-patterns/data-access\">github.com/Alvearie/health-patterns/data-access</a> today and confirmed that everything was working as expected for me.  I then opened this PR to update it for the latest ibm fhir server and smart-keycloak versions:  <a href=\"https://github.com/Alvearie/health-patterns/pull/332\">https://github.com/Alvearie/health-patterns/pull/332</a><br>\nLet me know if you're still having trouble...I'd like it to be pretty turn-key and so it would be interesting to see where you went wrong.</p>",
        "id": 263663239,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1638571417
    },
    {
        "content": "<p>Thanks for bumping the versions!</p>\n<p>We did manage to get our own patient scoped tokens working. We ran into trouble because we were looking for the persistence interceptors log messages, but we couldn't find them because our tokens were rejected before that by \"Subject is NOT authorized to access resource fhir-server-webapp\". We fixed that by updating the security role, similar to how it's configured in <a href=\"https://github.com/Alvearie/health-patterns/blob/main/data-access/fhir/configDropins/overrides/keycloakJwt.xml#L7-L14\">keycloakJwt.xml</a>.</p>\n<div class=\"codehilite\" data-code-language=\"XML\"><pre><span></span><code>  <span class=\"nt\">&lt;webApplication</span> <span class=\"na\">id=</span><span class=\"s\">\"fhir-server-webapp\"</span><span class=\"nt\">&gt;</span>\n        <span class=\"nt\">&lt;application-bnd</span> <span class=\"na\">id=</span><span class=\"s\">\"bind\"</span><span class=\"nt\">&gt;</span>\n            <span class=\"nt\">&lt;security-role</span> <span class=\"na\">id=</span><span class=\"s\">\"users\"</span><span class=\"nt\">&gt;</span>\n                <span class=\"nt\">&lt;special-subject</span> <span class=\"na\">type=</span><span class=\"s\">\"ALL_AUTHENTICATED_USERS\"</span><span class=\"nt\">/&gt;</span>\n                <span class=\"nt\">&lt;special-subject</span> <span class=\"na\">type=</span><span class=\"s\">\"EVERYONE\"</span><span class=\"nt\">/&gt;</span>\n            <span class=\"nt\">&lt;/security-role&gt;</span>\n        <span class=\"nt\">&lt;/application-bnd&gt;</span>\n    <span class=\"nt\">&lt;/webApplication&gt;</span>\n</code></pre></div>\n<p>We're now looking into user/person scoped tokens instead of patient scoped tokens to allow access to multiple patients with one token. If we run into issues there, we'll let you know :)</p>",
        "id": 264449802,
        "sender_full_name": "Sibren Talens",
        "timestamp": 1639144429
    },
    {
        "content": "<p>Thanks for following up, Sibren.  Glad it is finally working for you.  That mapping from user principal in the JWT to a security-role in the webapp is definitely a bit tricky in Liberty.<br>\nI've mostly just looked at patient access to date, so I'm guessing you'll find gaps on the user/ scope side.<br>\nCurrent state:</p>\n<ul>\n<li>you can configure keycloak to issue user/ scopes, but there's no currently established mechanism for scoping that down to a particular set of patients (e.g. based on the user's permissions)</li>\n<li>fhir-smart will validate the <code>[resourceType].[read|write]</code> part of the <code>user/[resourceType].[read|write]</code> scopes, but currently it will give the user access to all such resources (doesn't scope it to the <a href=\"http://Patient.id\">Patient.id</a> values that are in the token like it does for the patient/ scopes).</li>\n</ul>\n<p>The only way I've really used the <code>user/</code> scopes to date is to grant access to resources that aren't really patient-specific (we allow <code>patient/</code> scopes for those too, but I found that many in the community were using <code>user/</code> scopes for those and so I added that support).</p>",
        "id": 264451208,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1639145033
    },
    {
        "content": "<p>With that said, the current behavior does support <code>launch/patient</code> behavior where that user has access to <em>multiple</em> patient records.<br>\nThe \"patient context picker\" is used to narrow it down to just one patient (and this context is passed to the client app in the OIDC token response payload--as indicated in SMART App Launch), but the actual JWT we issue will include <em>all</em> <a href=\"http://Patient.id\">Patient.id</a> values that the user has access to (and that is what we're using to enforce access from fhir-smart).  This is something I went back and forth on (and its easy to change), but I mention it here because it might be a useful example / viable approach to issuing/enforcing <code>user/</code> scopes that are scoped to some subset of patients.</p>",
        "id": 264452123,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1639145451
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"459750\">@Sibren Talens</span> &lt;- curious for your feedback on this proposed behavior change: <a href=\"https://github.com/IBM/FHIR/issues/3495\">https://github.com/IBM/FHIR/issues/3495</a></p>",
        "id": 276189764,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1647956442
    }
]