[
    {
        "content": "<p>Hi all, i am having an issue with connecting the IBM/FHIR project to an external keycloak auth server to validate access tokens which are generated by the external keycloak server. I just enabled oauth in fhir-server-config.json file and set the auth server endpoints but i am not sure which files should i modify to connect the keycloak server from the IBM/FHIR project and validate tokens successfully. Is there any documentation, blog post etc. about it or can somebody guide me about the issue? Thanks for your support!</p>",
        "id": 223544449,
        "sender_full_name": "Burak Şentuna",
        "timestamp": 1611250978
    },
    {
        "content": "<p>hi Burak.  have you seen <a href=\"https://github.com/IBM/FHIR/issues/1703\">https://github.com/IBM/FHIR/issues/1703</a> yet?</p>",
        "id": 223544603,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1611251064
    },
    {
        "content": "<p>specifically <a href=\"https://github.com/IBM/FHIR/issues/1703#issuecomment-728132487\">https://github.com/IBM/FHIR/issues/1703#issuecomment-728132487</a></p>",
        "id": 223544742,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1611251127
    },
    {
        "content": "<p>yeah, i've implemented all the steps but i got <code>403 Forbidden</code> error always and there is no log about it. Is there any way to display more detailed logs?</p>",
        "id": 223545368,
        "sender_full_name": "Burak Şentuna",
        "timestamp": 1611251406
    },
    {
        "content": "<p>one scenario where I've found the logs lacking (from our underlying app server) is if you have not properly configured the usersGroup.  not sure if thats your issue or not, but you could double-check your server.xml / configDropins</p>",
        "id": 223545790,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1611251595
    },
    {
        "content": "<p>for example, see <a href=\"https://github.com/IBM/FHIR/blob/master/fhir-server/liberty-config/configDropins/disabled/keycloakRP.xml#L13\">https://github.com/IBM/FHIR/blob/master/fhir-server/liberty-config/configDropins/disabled/keycloakRP.xml#L13</a></p>",
        "id": 223545855,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1611251629
    },
    {
        "content": "<p>specifically, if you use this pattern, liberty will look in the JWT access token for the value of whatever you've configured as the <code>groupNameAttribute</code>, then append that to the <code>issuer</code> and use that as the access-id in that group field.</p>",
        "id": 223546231,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1611251806
    },
    {
        "content": "<p>Thanks Lee! Let me check all the configuration and i will inform you about the result. Thanks for your support</p>",
        "id": 223547973,
        "sender_full_name": "Burak Şentuna",
        "timestamp": 1611252491
    },
    {
        "content": "<p>Hi Burak</p>\n<p>Do you have any sample token of Keycloak? We are trying to enable smart-fhir but it is not honoring scopes given in config file.</p>\n<p>thanks<br>\nmahesh</p>",
        "id": 246810895,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1626932390
    },
    {
        "content": "<p><a href=\"/user_uploads/10155/f1jqmncQZRYmGzDWVvt73bmp/trace.log\">trace.log</a> </p>\n<p>Here is detailed log where trace is enabled. We have done change in config file and dropped the Smart Jar with exactly same version as FHIR server (4.8.3) in userlib. Still it is not honoring scopes. Do you get any clue from logs?</p>\n<p>Mahesh</p>",
        "id": 246840736,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1626957644
    },
    {
        "content": "<p>Hi </p>\n<p>Seems that we are getting there. Please ignore all previous messages. Now we are able to hit the URL which is denying scope properly. Here is error message. So what scope we can give so that we can create patients? </p>\n<p>[7/22/21, 14:07:19:605 UTC] 0000001f AuthzPolicyEn 1   write permission for 'Patient/5cbc121b-cd71-4428-b8b7-31e53eba8184' is not granted by any of the provided scopes: [patient/Medication.read, patient/AllergyIntolerance.read, patient/CarePlan.read, patient/CareTeam.read, patient/Condition.read, patient/Device.read, patient/DiagnosticReport.read, patient/DocumentReference.read, patient/Encounter.read, patient/Goal.read, patient/Immunization.read, patient/Location.read, patient/MedicationRequest.read, patient/Observation.read, patient/Organization.read, patient/Patient.read, patient/Practitioner.read, patient/Procedure.read, patient/Provenance.read, patient/Patient.write, user/Patient.write, user/<em>.</em>, patient/<em>.</em>] with context id(s): [17ab437f80b-f1907e67-e141-467c-b3d9-c3f8ebd867be]<br>\n[7/22/21, 14:07:19:605 UTC] 0000001f FHIRUserTrans 1   Marking transaction for rollback.<br>\n[7/22/21, 14:07:19:605 UTC] 0000001f FHIRUserTrans 1   Rolling back transaction on current thread...<br>\n[7/22/21, 14:07:19:606 UTC] 0000001f CacheTransact I   Transaction failed - afterCompletion(status = 4)<br>\n[7/22/21, 14:07:19:606 UTC] 0000001f FHIRPersisten 1   Transaction rolled back - clearing local maps<br>\n[7/22/21, 14:07:19:606 UTC] 0000001f FHIRResource  1   Requested interaction is not permitted by any of the passed scopes.<br>\n                                 com.ibm.fhir.persistence.interceptor.FHIRPersistenceInterceptorException: Requested interaction is not permitted by any of the passed scopes.  [probeId=ac-1e-0-b2-0895b081-94c8-44d2-9a58-4b80224bf722]<br>\n    at com.ibm.fhir.smart.AuthzPolicyEnforcementPersistenceInterceptor.enforce(AuthzPolicyEnforcementPersistenceInterceptor.java:374)<br>\n    at com.ibm.fhir.smart.AuthzPolicyEnforcementPersistenceInterceptor.beforeCreate(AuthzPolicyEnforcementPersistenceInterceptor.java:178)<br>\n    at com.ibm.fhir.persistence.interceptor.impl.FHIRPersistenceInterceptorMgr.fireBeforeCreateEvent(FHIRPersistenceInterceptorMgr.java:91)<br>\n    at com.ibm.fhir.server.util.FHIRRestHelper.doCreate(FHIRRestHelper.java:265)<br>\n    at com.ibm.fhir.server.operation.spi.FHIRResourceHelpers.doCreate(FHIRResourceHelpers.java:46)<br>\n    at com.ibm.fhir.server.resources.Create.create(Create.java:74)<br>\n    at com.ibm.fhir.server.resources.Create$Proxy$_$$_WeldClientProxy.create(Unknown Source)<br>\n    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br>\n    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)<br>\n    at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)<br>\n    at java.base/java.lang.reflect.Method.invoke(Method.java:566)<br>\n    at com.ibm.ws.jaxrs20.cdi.component.JaxRsFactoryImplicitBeanCDICustomizer.serviceInvoke(JaxRsFactoryImplicitBeanCDICustomizer.java:342)<br>\n    at com.ibm.ws.jaxrs20.server.LibertyJaxRsServerFactoryBean.performInvocation(LibertyJaxRsServerFactoryBean.java:641)<br>\n    at com.ibm.ws.jaxrs20.server.LibertyJaxRsInvoker.performInvocation(LibertyJaxRsInvoker.java:160)<br>\n    at org.apache.cxf.service.invoker.AbstractInvoker.invoke(AbstractInvoker.java:101)<br>\n    at com.ibm.ws.jaxrs20.server.LibertyJaxRsInvoker.invoke(LibertyJaxRsInvoker.java:273)<br>\n    at org.apache.cxf.jaxrs.JAXRSInvoker.invoke(JAXRSInvoker.java:213)<br>\n    at com.ibm.ws.jaxrs20.server.LibertyJaxRsInvoker.invoke(LibertyJaxRsInvoker.java:444)<br>\n    at org.apache.cxf.jaxrs.JAXRSInvoker.invoke(JAXRSInvoker.java:112)<br>\n    at org.apache.cxf.interceptor.ServiceInvokerInterceptor$1.run(ServiceInvokerInterceptor.java:59)<br>\n    at org.apache.cxf.interceptor.ServiceInvokerInterceptor.handleMessage(ServiceInvokerInterceptor.java:96)<br>\n    at org.apache.cxf.phase.PhaseInterceptorChain.doIntercept(PhaseInterceptorChain.java:308)<br>\n    at org.apache.cxf.transport.ChainInitiationObserver.onMessage(ChainInitiationObserver.java:123)<br>\n    at org.apache.cxf.transport.http.AbstractHTTPDestination.invoke(AbstractHTTPDestination.java:274)<br>\n    at com.ibm.ws.jaxrs20.endpoint.AbstractJaxRsWebEndpoint.invoke(AbstractJaxRsWebEndpoint.java:137)<br>\n    at com.ibm.websphere.jaxrs.server.IBMRestServlet.handleRequest(IBMRestServlet.java:146)<br>\n    at com.ibm.websphere.jaxrs.server.IBMRestServlet.doPost(IBMRestServlet.java:104)<br>\n    at javax.servlet.http.HttpServlet.service(HttpServlet.java:706)<br>\n    at com.ibm.websphere.jaxrs.server.IBMRestServlet.service(IBMRestServlet.java:96)<br>\n    at com.ibm.ws.webcontainer.servlet.ServletWrapper.service(ServletWrapper.java:1258)<br>\n    at com.ibm.ws.webcontainer.servlet.ServletWrapper.handleRequest(ServletWrapper.java:746)<br>\n    at com.ibm.ws.webcontainer.servlet.ServletWrapper.handleRequest(ServletWrapper.java:443)<br>\n    at com.ibm.ws.webcontainer.filter.WebAppFilterChain.invokeTarget(WebAppFilterChain.java:183)<br>\n    at com.ibm.ws.webcontainer.filter.WebAppFilterChain.doFilter(WebAppFilterChain.java:94)<br>\n    at com.ibm.fhir.server.filter.rest.FHIRRestServletFilter.doFilter(FHIRRestServletFilter.java:155)<br>\n    at javax.servlet.http.HttpFilter.doFilter(HttpFilter.java:127)<br>\n    at com.ibm.ws.webcontainer.filter.FilterInstanceWrapper.doFilter(FilterInstanceWrapper.java:197)<br>\n    at com.ibm.ws.webcontainer.filter.WebAppFilterChain.doFilter(WebAppFilterChain.java:91)<br>\n    at com.ibm.ws.security.jaspi.JaspiServletFilter.doFilter(JaspiServletFilter.java:56)<br>\n    at com.ibm.ws.webcontainer.filter.FilterInstanceWrapper.doFilter(FilterInstanceWrapper.java:197)<br>\n    at com.ibm.ws.webcontainer.filter.WebAppFilterChain.doFilter(WebAppFilterChain.java:91)<br>\n    at com.ibm.ws.webcontainer.filter.WebAppFilterManager.doFilter(WebAppFilterManager.java:1002)<br>\n    at com.ibm.ws.webcontainer.filter.WebAppFilterManager.invokeFilters(WebAppFilterManager.java:1140)<br>\n    at com.ibm.ws.webcontainer.filter.WebAppFilterManager.invokeFilters(WebAppFilterManager.java:1011)<br>\n    at com.ibm.ws.webcontainer.servlet.CacheServletWrapper.handleRequest(CacheServletWrapper.java:75)<br>\n    at com.ibm.ws.webcontainer40.servlet.CacheServletWrapper40.handleRequest(CacheServletWrapper40.java:85)<br>\n    at com.ibm.ws.webcontainer.WebContainer.handleRequest(WebContainer.java:938)<br>\n    at com.ibm.ws.webcontainer.osgi.DynamicVirtualHost$2.run(DynamicVirtualHost.java:279)<br>\n    at com.ibm.ws.http.dispatcher.internal.channel.HttpDispatcherLink$TaskWrapper.run(HttpDispatcherLink.java:1159)<br>\n    at com.ibm.ws.http.dispatcher.internal.channel.HttpDispatcherLink.wrapHandlerAndExecute(HttpDispatcherLink.java:428)<br>\n    at com.ibm.ws.http.dispatcher.internal.channel.HttpDispatcherLink.ready(HttpDispatcherLink.java:387)<br>\n    at com.ibm.ws.http.channel.internal.inbound.HttpInboundLink.handleDiscrimination(HttpInboundLink.java:566)<br>\n    at com.ibm.ws.http.channel.internal.inbound.HttpInboundLink.handleNewRequest(HttpInboundLink.java:500)<br>\n    at com.ibm.ws.http.channel.internal.inbound.HttpInboundLink.processRequest(HttpInboundLink.java:360)<br>\n    at com.ibm.ws.http.channel.internal.inbound.HttpInboundLink.ready(HttpInboundLink.java:327)<br>\n    at com.ibm.ws.tcpchannel.internal.NewConnectionInitialReadCallback.sendToDiscriminators(NewConnectionInitialReadCallback.java:167)<br>\n    at com.ibm.ws.tcpchannel.internal.NewConnectionInitialReadCallback.complete(NewConnectionInitialReadCallback.java:75)<br>\n    at com.ibm.ws.tcpchannel.internal.WorkQueueManager.requestComplete(WorkQueueManager.java:504)<br>\n    at com.ibm.ws.tcpchannel.internal.WorkQueueManager.attemptIO(WorkQueueManager.java:574)<br>\n    at com.ibm.ws.tcpchannel.internal.WorkQueueManager.workerRun(WorkQueueManager.java:958)<br>\n    at com.ibm.ws.tcpchannel.internal.WorkQueueManager$Worker.run(WorkQueueManager.java:1047)<br>\n    at com.ibm.ws.threading.internal.ExecutorServiceImpl$RunnableWrapper.run(ExecutorServiceImpl.java:238)<br>\n    at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)<br>\n    at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)<br>\n    at java.base/java.lang.Thread.run(Thread.java:829)</p>\n<p>[7/22/21, 14:07:19:607 UTC] 0000001f FHIRResource  1   <br>\nOperationOutcome:<br>\n{\"resourceType\":\"OperationOutcome\",\"id\":\"ac-1e-0-b2-0895b081-94c8-44d2-9a58-4b80224bf722\",\"issue\":[{\"severity\":\"fatal\",\"code\":\"forbidden\",\"details\":{\"text\":\"Requested interaction is not permitted by any of the passed scopes.\"},\"expression\":[\"&lt;empty&gt;\"]}]}</p>",
        "id": 246852258,
        "sender_full_name": "Mahesh Dabi",
        "timestamp": 1626963161
    },
    {
        "content": "<p>Hi Mahesh, I'm back from vacation now.  Glad to hear you found some success.  The way the <code>fhir-smart</code> interceptor is currently designed, I think it would only allow a user to create resources to which they would have access.<br>\nFor example, a user bearing a token with <code>patient_id = 17ab437f80b-f1907e67-e141-467c-b3d9-c3f8ebd867be</code> that includes scope <code>patient/Patient.write</code> would ONLY be able to create a Patient resource by that same id.<br>\nHowever, even then, its a case that will require some testing because most of the SMART use cases we've dealt with to date are read-only (i.e. the server is loaded some other way...typically a second instance that is not exposed externally with a different auth strategy).</p>",
        "id": 247964653,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1627934738
    }
]