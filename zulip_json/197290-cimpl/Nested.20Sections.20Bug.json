[
    {
        "content": "<p>Hello <span class=\"user-mention\" data-user-id=\"191469\">@Chris Moesel</span>  and <span class=\"user-mention\" data-user-id=\"191447\">@Mark Kramer</span> <br>\nI think there may be a bug in how nested Composition sections are handled. I create a section called \"Findings\", and then create two sections under findings (Left Breast Finding\" and \"Right Breast Finding\". Finding gets created correctly, but it looks like the sub sections never get created, and Findings.Section is not sliced for left and right. Could this have anything to do with my mapping? I have attached the CIMPL and map file.<br>\nAlternately, you can grab the whole project at <br>\n<a href=\"https://github.com/applicadia/Fhir-BreastRadiologyReport\" target=\"_blank\" title=\"https://github.com/applicadia/Fhir-BreastRadiologyReport\">https://github.com/applicadia/Fhir-BreastRadiologyReport</a><br>\nThanks!<br>\nKurt A.</p>\n<p><a href=\"/user_uploads/10155/L0mo1vmhmOwoAVNp3bf8oRkJ/BreastRadiologyDocument.txt\" target=\"_blank\" title=\"BreastRadiologyDocument.txt\">BreastRadiologyDocument.txt</a> <a href=\"/user_uploads/10155/nr6ZvGd_4c54SpHSZvDYKLQc/BreastRadiologyDocument_map.txt\" target=\"_blank\" title=\"BreastRadiologyDocument_map.txt\">BreastRadiologyDocument_map.txt</a><br>\n<a href=\"user_uploads/10155/eQepznJ5AVhvF-CiZ3s2BRkz/structuredefinition-breastrad-BreastRadiologyDocument-extension.json\" target=\"_blank\" title=\"user_uploads/10155/eQepznJ5AVhvF-CiZ3s2BRkz/structuredefinition-breastrad-BreastRadiologyDocument-extension.json\">structuredefinition-breastrad-BreastRadiologyDocument-extension.json</a><br>\n<a href=\"user_uploads/10155/4Mk5-EPyUYtNqQygYNC4WKFo/structuredefinition-breastrad-BreastRadiologyDocument.json\" target=\"_blank\" title=\"user_uploads/10155/4Mk5-EPyUYtNqQygYNC4WKFo/structuredefinition-breastrad-BreastRadiologyDocument.json\">structuredefinition-breastrad-BreastRadiologyDocument.json</a></p>",
        "id": 171037268,
        "sender_full_name": "Kurt Allen",
        "timestamp": 1563321219
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"192611\">@Kurt Allen</span> </p>\n<p>The mapping for composition is missing a slicing directive for <code>section</code>.  If you look at the <code>Composition</code> mapping in  <code>obf_foundation_map_r4.txt</code>, you need to change the line that maps <code>section</code> to this:</p>\n<div class=\"codehilite\"><pre><span></span>Section maps to section (slice on = code; slice strategy = includes)\n</pre></div>\n\n\n<p>This will tell it to slice sections using <code>code</code> as the differentiator -- and that the CIMPL <code>includes</code> constraint defines what the slices are.</p>\n<p>Note that the latest mappings in our shr_spec <a href=\"https://github.com/standardhealth/shr_spec/tree/dev6\" target=\"_blank\" title=\"https://github.com/standardhealth/shr_spec/tree/dev6\">dev6</a> branch already contain this fix <a href=\"https://github.com/standardhealth/shr_spec/blob/4f055c0b1c050532871cde7aad5847960377feba/spec/obf_foundation_map_r4.txt#L39\" target=\"_blank\" title=\"https://github.com/standardhealth/shr_spec/blob/4f055c0b1c050532871cde7aad5847960377feba/spec/obf_foundation_map_r4.txt#L39\">here</a> and also contain some other fixes that may benefit you (for example, fixes to invalid value sets that get reported in the IG qa.html).  If possible, you may want to consider updating all of the definitions you copied over from us (like obf, shr.core, etc) so you can benefit from our recent updates.</p>\n<p>After applying the mapping change above, I found that your <code>BreastRadiologyReport</code> seemed more like you would expect.  Here's a partial screenshot of the results:</p>\n<p><a href=\"/user_uploads/10155/mz97Tjo8nEGaNHmsOE8Z30NH/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/mz97Tjo8nEGaNHmsOE8Z30NH/pasted_image.png\" target=\"_blank\" title=\"pasted image\"><img src=\"/user_uploads/10155/mz97Tjo8nEGaNHmsOE8Z30NH/pasted_image.png\"></a></div>",
        "id": 171081604,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1563372596
    },
    {
        "content": "<p>Yo <span class=\"user-mention\" data-user-id=\"191469\">@Chris Moesel</span> <br>\nI must be doing something wrong here. I got the latest shr-spec from git, copied it over and deleted the deprecated*.txt files (they caused compile errors), rebuilt shr-cli (6.2.2 #219)  and reran everything. </p>\n<p>I get a findings section, but no FindingsLeftBreast or FindingsRightBreast.<br>\nAttached is the html file, and the git hub repo is up to date (development branch).</p>\n<p>Also, FYI: I tried getting 6.3, but had compile errors in the shr-spec files. I see that you tightened type checking (yah!!!) and some of the shr-spec files had some issues. 6.3 showed me some errors in my code that I needed to clean up,so kudos on 6.3, but shr-spec probably needs some attention.</p>\n<p>Any ideas?</p>\n<p>Best,<br>\nKurt A.</p>\n<p><a href=\"/user_uploads/10155/R7XY7Jx5eoOuhcEzSIxEqB8U/Breast-Radiology-Reporting.html\" target=\"_blank\" title=\"Breast-Radiology-Reporting.html\">Breast-Radiology-Reporting.html</a></p>",
        "id": 171098046,
        "sender_full_name": "Kurt Allen",
        "timestamp": 1563384304
    },
    {
        "content": "<p>Hi Kurt.  Yes, 6.3 was just released today and the spec team is catching up on fixing some of the type inconsistencies it brings to light.  I expect the fixes will be pushed to shr_spec soon.</p>\n<p>As for the continued issue w/ the Findings, I'll take a look.  I'm not sure why you'd get something different than I get.</p>",
        "id": 171101085,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1563385837
    },
    {
        "content": "<p>thx</p>",
        "id": 171102925,
        "sender_full_name": "Kurt Allen",
        "timestamp": 1563386921
    },
    {
        "content": "<p>Oh... I see now.  You're using sub-sections.  In the <code>master</code> branch (that I originally tested with), <code>FindingsLeftBreast</code> and <code>FindingsRightBreast</code> were in the top-level sections.  But I see here that you are now employing nested sections, so <code>Findings</code> is the top-level section and the left/right breast findings are a nested section within that.</p>\n<p>Hopefully we can support that!  It will require at least some additional mapping...  I'm working on it -- but if you don't hear from me for a while it's because I'm currently in an airport and due to board soon.</p>",
        "id": 171103963,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1563387590
    },
    {
        "content": "<p>OK.  It looks like I got it to work.  I'm assuming you don't want to modify the files that we (the SHR team) provide, so... you can update the specific <code>BreastRadiologyDocument</code> mapping to be this:</p>\n<div class=\"codehilite\"><pre><span></span>Grammar: Map 6.0\nNamespace: breastrad\nTarget: FHIR_R4\n\nBreastRadiologyDocument maps to Composition:\n    Section.Section maps to section.section (slice on = code; slice strategy = includes)\n    Section.Section.Title maps to section.section.title\n    Section.Section.Code maps to section.section.code\n    Section.Section.Author maps to section.section.author\n    Section.Section.FocalSubject maps to section.section.focus\n    Section.Section.Narrative maps to section.section.text\n    Section.Section.Type maps to section.section.mode\n    Section.Section.SortOrder maps to section.section.orderedBy // terrible FHIR name!\n    Section.Section.DomainResource maps to section.section.entry  (slice on = reference.resolve(); slice on type = profile; slice strategy = includes)\n    Section.Section.EmptyReason maps to section.section.emptyReason\n    Section.Section.Section maps to section.section.section\n</pre></div>\n\n\n<p>You can see that I essentially just mapped one more level down.  You'd need to continue to do that for each level of section you need.  We probably need to figure out a way to define recursive mapping statements!   Anyway, that worked for me.  Hopefully it will work for you too!</p>",
        "id": 171104406,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1563387873
    },
    {
        "content": "<p>(FYI -- it inherits all the other mappings from the parent mapping, which is why I just have the new mappings defined above)</p>",
        "id": 171104439,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1563387910
    },
    {
        "content": "<p>Gotta get on my plane.  Good luck!</p>",
        "id": 171104450,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1563387923
    },
    {
        "content": "<p>Hey <span class=\"user-mention\" data-user-id=\"191469\">@Chris Moesel</span> </p>\n<p>Looks like that worked. <br>\nThis approach might get cumbersome if nesting gets very deep. I wonder if you don't need to add some form of mapping resource fragments like</p>\n<p>BreastRadiologyDocument.Section maps to Composition.section:<br>\n...</p>\n<p>and then this mapping could be applied recursively to itself unless explicitly overruled in a specific rule for a specific nested element.</p>\n<p>(i.e. BreastRadiologyDocument.Section.Section, BreastRadiologyDocument.Section.Section.Section, ... would all have BreastRadiologyDocument.Section applied to them since they are all BreastRadiologyDocument.Section's)</p>\n<p>Just a thought.</p>\n<p>Anyways, this item is fixed and many thanks. Hope your flite is extremely uneventful and that you are  flying somewhere fun!</p>\n<p>Best,<br>\nKurt A</p>",
        "id": 171114635,
        "sender_full_name": "Kurt Allen",
        "timestamp": 1563395356
    },
    {
        "content": "<p>Yeah, I was thinking maybe something along those same lines.  We'd have to think on it a bit more...  We're also considering a significant rewrite of the mapping language -- so maybe a new grammar would lend itself to a more obvious solution as well.</p>",
        "id": 171123900,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1563403707
    }
]