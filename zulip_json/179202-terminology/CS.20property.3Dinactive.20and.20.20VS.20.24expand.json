[
    {
        "content": "<p>Hello,</p>\n<p>I have a question on the inactive property of codeSystems how it affects $expand  for valueSets.</p>\n<p>In my test scenario I have added property attributes in my local codeSystem for a few concepts that I believe should mark those as inactive.</p>\n<p>{<br>\n\"code\": \"orange\",<br>\n\"display\": \"Orange\",<br>\n\"property\": [<br>\n{<br>\n\"code\": \"inactive\",<br>\n\"valueBoolean\": true<br>\n}<br>\n]<br>\n},<br>\n{<br>\n\"code\": \"purple\",<br>\n\"display\": \"Purple\",<br>\n\"property\": [<br>\n{<br>\n\"code\": \"inactive\",<br>\n\"valueBoolean\": true<br>\n}<br>\n]<br>\n},</p>\n<p>Other concepts I did not add any property attributes.</p>\n<p>In my valueSet, I'm extending LOINC to also include my local codeSystem<br>\nI have set the compose section like:<br>\n\"compose\": {<br>\n    \"inactive\": \"false\",<br>\n    \"include\": [<br>\n      {<br>\n        \"system\": \"<a href=\"http://loinc.org\" target=\"_blank\" title=\"http://loinc.org\">http://loinc.org</a>\",<br>\n        \"concept\": [<br>\n          {<br>\n            \"code\": \"64290-0\",<br>\n            \"display\": \"My Patient’s insurance card\"<br>\n          }<br>\n        ]<br>\n      },<br>\n      {<br>\n        \"system\": \"<a href=\"https://my-zuilp/code-system/my-zuilp-test\" target=\"_blank\" title=\"https://my-zuilp/code-system/my-zuilp-test\">https://my-zuilp/code-system/my-zuilp-test</a>\",<br>\n        \"concept\": [<br>\n          {<br>\n            \"code\": \"red\",<br>\n            \"display\": \"Red from vs\"<br>\n          },<br>\n          {<br>\n            \"code\": \"orange\",<br>\n            \"display\": \"Orange from vs\"<br>\n          },<br>\n          {<br>\n            \"code\": \"purple\",<br>\n            \"display\": \"Purple from vs\"<br>\n          },<br>\n          {<br>\n            \"code\": \"blue\",<br>\n            \"display\": \"Blue from vs\"<br>\n          },<br>\n          {<br>\n            \"code\": \"yellow\",<br>\n            \"display\": \"Yellow from vs\"<br>\n          },<br>\n          {<br>\n            \"code\":  \"cyan\",<br>\n            \"display\": \"Cyan from vs\"<br>\n          }<br>\n        ]<br>\n      }<br>\n    ]<br>\n  },<br>\n  \"expansion\": {<br>\n    \"contains\": [<br>\n      {<br>\n        \"inactive\": \"false\"<br>\n      }<br>\n    ]<br>\n  }<br>\n}<br>\n I believe I also have tried setting the expansion.contains.inactive to \"true\" as well.</p>\n<p>I query the server via a Postman Get<br>\n{{FHIR_SERVER}}/ValueSet/my-zuilp-test/$expand?activeOnly=true</p>\n<p>And I am getting the \"code\": \"purple\" and \"code\": \"orange\" concepts in the expanded list. I had expected that those would not be in the result (below)<br>\nAm I setting something incorrectly?</p>\n<p>Thanks!</p>\n<p>{<br>\n    \"resourceType\": \"ValueSet\",<br>\n    \"meta\": {<br>\n        \"lastUpdated\": \"2018-06-12T13:51:28.851-04:00\"<br>\n      },<br>\n    \"status\": \"active\",<br>\n    \"compose\": {<br>\n        \"include\": [<br>\n            {<br>\n                \"system\": \"<a href=\"http://loinc.org\" target=\"_blank\" title=\"http://loinc.org\">http://loinc.org</a>\",<br>\n                \"concept\": [<br>\n                    {<br>\n                        \"code\": \"64290-0\",<br>\n                        \"display\": \"My Patient’s insurance card\"<br>\n                    }<br>\n                ]<br>\n            },<br>\n            {<br>\n                \"system\": \"<a href=\"https://my-zuilp/code-system/my-zuilp-test\" target=\"_blank\" title=\"https://my-zuilp/code-system/my-zuilp-test\">https://my-zuilp/code-system/my-zuilp-test</a>\",<br>\n                \"concept\": [<br>\n                    {<br>\n                        \"code\": \"red\",<br>\n                        \"display\": \"Red from vs\"<br>\n                    },<br>\n                    {<br>\n                        \"code\": \"orange\",<br>\n                        \"display\": \"orange from vs\"<br>\n                    },<br>\n                    {<br>\n                        \"code\": \"purple\",<br>\n                        \"display\": \"Purple from vs\"<br>\n                    },<br>\n                    {<br>\n                        \"code\": \"blue\",<br>\n                        \"display\": \"Blue from vs\"<br>\n                    },<br>\n                    {<br>\n                        \"code\": \"yellow\",<br>\n                        \"display\": \"yellow from vs\"<br>\n                    },<br>\n                    {<br>\n                        \"code\": \"cyan\",<br>\n                        \"display\": \"Cyan from vs\"<br>\n                    }<br>\n                ]<br>\n            }<br>\n        ]<br>\n    },<br>\n    \"expansion\": {<br>\n        \"identifier\": \"urn:uuid:7eddc7e6-2f5d-480b-a338-ad3707b817a6\",<br>\n        \"timestamp\": \"2018-06-12T13:53:46-04:00\",<br>\n        \"total\": 6,<br>\n        \"parameter\": [<br>\n            {<br>\n                \"name\": \"version\",<br>\n                \"valueUri\": \"<a href=\"https://my-zuilp/code-system/my-zuilp-test|1.0.0\" target=\"_blank\" title=\"https://my-zuilp/code-system/my-zuilp-test|1.0.0\">https://my-zuilp/code-system/my-zuilp-test|1.0.0</a>\"<br>\n            }<br>\n        ],<br>\n        \"contains\": [<br>\n            {<br>\n                \"system\": \"<a href=\"https://my-zuilp/code-system/my-zuilp-test\" target=\"_blank\" title=\"https://my-zuilp/code-system/my-zuilp-test\">https://my-zuilp/code-system/my-zuilp-test</a>\",<br>\n                \"code\": \"red\",<br>\n                \"display\": \"Red from vs\"<br>\n            },<br>\n            {<br>\n                \"system\": \"<a href=\"https://my-zuilp/code-system/my-zuilp-test\" target=\"_blank\" title=\"https://my-zuilp/code-system/my-zuilp-test\">https://my-zuilp/code-system/my-zuilp-test</a>\",<br>\n                \"code\": \"orange\",<br>\n                \"display\": \"Orange from vs\"<br>\n            },<br>\n            {<br>\n                \"system\": \"<a href=\"https://my-zuilp/code-system/my-zuilp-test\" target=\"_blank\" title=\"https://my-zuilp/code-system/my-zuilp-test\">https://my-zuilp/code-system/my-zuilp-test</a>\",<br>\n                \"code\": \"purple\",<br>\n                \"display\": \"Purple from vs\"<br>\n            },<br>\n            {<br>\n                \"system\": \"<a href=\"https://my-zuilp/code-system/my-zuilp-test\" target=\"_blank\" title=\"https://my-zuilp/code-system/my-zuilp-test\">https://my-zuilp/code-system/my-zuilp-test</a>\",<br>\n                \"code\": \"blue\",<br>\n                \"display\": \"Blue from vs\"<br>\n            },<br>\n            {<br>\n                \"system\": \"<a href=\"https://my-zuilp/code-system/my-zuilp-test\" target=\"_blank\" title=\"https://my-zuilp/code-system/my-zuilp-test\">https://my-zuilp/code-system/my-zuilp-test</a>\",<br>\n                \"code\": \"yellow\",<br>\n                \"display\": \"Yellow from vs\"<br>\n            },<br>\n            {<br>\n                \"system\": \"<a href=\"https://my-zuilp/code-system/my-zuilp-test\" target=\"_blank\" title=\"https://my-zuilp/code-system/my-zuilp-test\">https://my-zuilp/code-system/my-zuilp-test</a>\",<br>\n                \"code\": \"cyan\",<br>\n                \"display\": \"Cyan from vs\"<br>\n            }<br>\n        ]<br>\n    }<br>\n}</p>",
        "id": 153968748,
        "sender_full_name": "M Crenshaw",
        "timestamp": 1528827566
    },
    {
        "content": "<p>Which terminology server is this.  If you've set activeOnly=true in the $expand call then you should not be getting inactive codes in the resulting expansion</p>",
        "id": 153968769,
        "sender_full_name": "Michael Lawley",
        "timestamp": 1528833742
    },
    {
        "content": "<p>Those \"inactive\" concept are from your local defined code system. Unless the server knows that code system, it cannot identify which concept is \"inactive\". Also, it is not necessary to specify expansion.contains.inactive = false in your definition. That value is filled by $expand operation.</p>",
        "id": 153968794,
        "sender_full_name": "Yunwei Wang",
        "timestamp": 1528844347
    },
    {
        "content": "<p>Also, at least on my implementation, I only check inactive for intensional value set.</p>",
        "id": 153968798,
        "sender_full_name": "Yunwei Wang",
        "timestamp": 1528844628
    },
    {
        "content": "<p>Sorry for the delay in getting back on this, and thank you both for your responses.</p>\n<p>We are using Hapi and it is a local server.</p>\n<p>Yumwei, I removed the expansion.contains.inactive = false and it still behaves the same.<br>\nIs there a good example of how to configure this on one of the public server that I can reference ?<br>\nIt does not seem like the filters for VS.compse.include or exclude are working as I would expect them to as well.</p>",
        "id": 153970149,
        "sender_full_name": "M Crenshaw",
        "timestamp": 1529087319
    },
    {
        "content": "<p>Some of this behavior is dependent on the particular server implementation, and detailed aspects of the terminology-specific behavior are likely not discoverable from the capability statement.  That should improve when the TerminologyCapabilities metadata endpoint is available (I'm sure that's not implemented by anyone yet), but even that might not necessarily address this.  I don't know how far HAPI is in implementing this.  I'm working with it now doing some extensive work with filtering for defining LOINC group value sets in FHIR, but I haven't actually looked at this aspect.  I think this is a question that would be good to raise in the <a href=\"https://groups.google.com/forum/#!forum/hapi-fhir\" target=\"_blank\" title=\"https://groups.google.com/forum/#!forum/hapi-fhir\">HAPI Google group</a>.</p>",
        "id": 153970152,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1529088219
    },
    {
        "content": "<p>Hello,</p>\n<p>I'm looking again at codeSystems and ValueSets and then 'Gets' on those ValueSet with $expand. <br>\nI'm attempting  set a 'property' in the CS that will allow the VS to exclude items in the CS. I have tried a property of 'status' and 'inactive' and several other configs as well. However,  no success in my tests yet.  I have tested scenarios on hapi 3.1, 3.4, and 3.6  running FHIR 3.1.</p>\n<p>I've loaded some of my test on <a href=\"http://fhirtest.uhn.ca/baseDstu3\" target=\"_blank\" title=\"http://fhirtest.uhn.ca/baseDstu3\">http://fhirtest.uhn.ca/baseDstu3</a>. The CS has a small group of concepts (6).</p>\n<p>In the CS id 'test-birds-S' I set the property 'status' with type 'string'<br>\n         \"property\": [<br>\n                    {<br>\n                      \"code\": \"status\",<br>\n                      \"uri\": \"<a href=\"http://hl7.org/fhir/concept-properties#status\" target=\"_blank\" title=\"http://hl7.org/fhir/concept-properties#status\">http://hl7.org/fhir/concept-properties#status</a>\",<br>\n                      \"description\": \"A property that indicates the status of the concept\",<br>\n                      \"type\": \"string\"<br>\n                    }<br>\n          ],</p>\n<div class=\"codehilite\"><pre><span></span>    In two of the concepts I set the property of status = &quot;retired&quot;\n     &quot;property&quot;: [\n                  {\n                    &quot;code&quot;: &quot;status&quot;,\n                    &quot;valueString&quot;: &quot;retired&quot;\n                  }\n                ]\n\n    In the associated VS,  &#39;test-birds-S-exclude&#39;, I&#39;m used an exclude filter\n         &quot;filter&quot;: [\n                                    {\n                                        &quot;property&quot;: &quot;status&quot;,\n                                        &quot;op&quot;: &quot;=&quot;,\n                                        &quot;value&quot;: &quot;retired&quot;\n                                    }\n                                ]\n    The &#39;Get&#39; on that VS(/ValueSet/test-birds-S-exclude/$expand) does not filter out the retired concepts as expected.\n</pre></div>\n\n\n<p>In my second test I created a similar CS ('test-birds-I')with a property of 'inactive' and type 'boolean'<br>\n     \"property\": [<br>\n                {<br>\n                    \"code\": \"inactive\",<br>\n                     \"uri\": \"<a href=\"http://hl7.org/fhir/concept-properties#inactive\" target=\"_blank\" title=\"http://hl7.org/fhir/concept-properties#inactive\">http://hl7.org/fhir/concept-properties#inactive</a>\",<br>\n                     \"description\": \"True if the concept is not considered active - e.g. not a valid concept any more\",<br>\n                     \"type\": \"boolean\"<br>\n                }<br>\n      ],</p>\n<div class=\"codehilite\"><pre><span></span>I set the same two elements to &#39;inactive&#39; (and true) with that property\nExample:\n            &quot;property&quot;: [\n              {\n                &quot;code&quot;: &quot;inactive&quot;,\n                &quot;valueBoolean&quot;: true\n              }\n            ]\n\nIn the VS  (&#39;test-birds-I-exclude&#39; ) I set exclude with the filter for &#39;inactive&#39;\n    &quot;exclude&quot;: [\n          {\n            &quot;system&quot;:  &quot;http://hl7.org/fhir/CodeSystem/test-birds-I&quot;,\n                                &quot;filter&quot;: [\n                                    {\n                                        &quot;property&quot;: &quot;inactive&quot;,\n                                        &quot;op&quot;: &quot;=&quot;,\n                                        &quot;value&quot;: true\n                                    }\n                                ]\n          }\n       ….\n</pre></div>\n\n\n<p>Again, the 'Get' on that VS(/ValueSet/test-birds-I-exclude/$expand) does not filter out the inactive concepts as expected.</p>\n<p>I've looked through several hapi FHIR test servers, and I have not found any examples of  valuesets that leverage ValueSet.compose.exclude.filter. ( or ValueSet.compose.include.filter)<br>\nIt would be nice to see some samples of CS and the related VS's with filters.</p>\n<p>In my testing, I also tried these scenarios with the ValueSet.compose.include.filter looking for values of false, where the CS had the property set for 'inactive' on each concept. . ( 'inactive' set to false for 4 of the 6 concepts, and 'inactive = true - as they are set in the example above). </p>\n<p>I have also tried scenarios with ValueSet.compose.inactive set to true/false</p>\n<p>I have been successful to explicitly exclude a concept<br>\n\"exclude\": [<br>\n      {<br>\n        \"system\":  \"<a href=\"http://hl7.org/fhir/CodeSystem/test-birds-S\" target=\"_blank\" title=\"http://hl7.org/fhir/CodeSystem/test-birds-S\">http://hl7.org/fhir/CodeSystem/test-birds-S</a>\",  but I don't think that is the correct way to support these types of CS changes.</p>\n<div class=\"codehilite\"><pre><span></span>    &quot;concept&quot;: [\n        {\n            &quot;code&quot;: &quot;CP&quot;\n        },\n        {\n            &quot;code&quot;: &quot;LD&quot;\n        }\n</pre></div>\n\n\n<p>]      <br>\n….</p>\n<p>There is also a posted on the google groups to request examples as well <a href=\"https://groups.google.com/forum/#!topic/hapi-fhir/tq8jwfOMY8o\" target=\"_blank\" title=\"https://groups.google.com/forum/#!topic/hapi-fhir/tq8jwfOMY8o\">https://groups.google.com/forum/#!topic/hapi-fhir/tq8jwfOMY8o</a></p>\n<p>Any help in understanding this configuration is appreciated!</p>",
        "id": 159747495,
        "sender_full_name": "M Crenshaw",
        "timestamp": 1551473116
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191405\">@Rob Hausam</span> ?</p>",
        "id": 159747778,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1551473385
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"194749\">@M Crenshaw</span> Have you tried any other terminology servers?  What you're doing sounds right.  Perhaps try with <a href=\"https://stu3.ontoserver.csiro.au/fhir\" target=\"_blank\" title=\"https://stu3.ontoserver.csiro.au/fhir\">https://stu3.ontoserver.csiro.au/fhir</a> to confirm.</p>",
        "id": 160053527,
        "sender_full_name": "Michael Lawley",
        "timestamp": 1551830518
    },
    {
        "content": "<p>Apologies for the slow response.  I'm not sure that I've followed every detail, but I agree with Michael that what you've been doing seems likely reasonable.  Trying with Ontoserver is a good idea, as what you're seeing may be a HAPI issue.</p>",
        "id": 160061589,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1551840555
    },
    {
        "content": "<p>Hello,</p>\n<p>Thank you @Michael Lawley and @Rob Hausam for your responses.</p>\n<p>Yesterday, I was able to create some tests on the Ontoserver instance. <br>\nI tested 3 scenarios:<br>\n    1. CS with a property - 'inactive' type Boolean (the 'inactive' property set to true on 2 concepts, the other concepts do not have a property)/VS exclude filter on 'inactive' = true<br>\n        ○ CS: test-birds-I<br>\n        ○ VS: test-birds-I-exclude<br>\n    2. CS with a property - 'inactive' type Boolean  (the 'inactive' property set to true on 2 concepts, the other concepts do not have a property)/VS with \"inactive\":false and no exclude statement,<br>\n        ○ CS: test-birds-I<br>\n        ○ VS: test-birds-II-include<br>\n    3. CS with a property - 'status' type string (the 'status' property set to('retired' on 2 concepts, the other concepts do not have a property)/VS exclude filter on 'status' = 'retired' <br>\n        ○ CS: test-birds-S<br>\n        ○ VS: test-birds-S-exclude</p>\n<p>Scenarios 2, 3 worked, the request on the VS with $expand produced the expected results.<br>\nScenario 1 did not exclude with the filter as expected. This VS, however, will return the expect results with the operation $expand?activeOnly=true</p>\n<p>I retested on a local HAPI 3.6 and I did not get the expected results.</p>\n<p>I believe the Ontoserver is just FHIR 3.0.1, so  this looks like this is a HAPI issue.</p>\n<p>Thanks for your help!</p>",
        "id": 160236334,
        "sender_full_name": "M Crenshaw",
        "timestamp": 1551991810
    },
    {
        "content": "<p>I assume you're probably aware of the HAPI FHIR Google <a href=\"https://groups.google.com/forum/#!forum/hapi-fhir\" target=\"_blank\" title=\"https://groups.google.com/forum/#!forum/hapi-fhir\">group</a>?  That would be a good place to raise this issue with James Agnew and the HAPI community and see about getting it addressed.</p>",
        "id": 160256143,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1552009971
    },
    {
        "content": "<p>Or use Ontoserver <span aria-label=\"wink\" class=\"emoji emoji-1f609\" role=\"img\" title=\"wink\">:wink:</span> (disclaimer: I'm a bit biased on that one! <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span> )</p>",
        "id": 160256165,
        "sender_full_name": "Jim Steel",
        "timestamp": 1552010006
    },
    {
        "content": "<p>No problem with that!</p>",
        "id": 160256231,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1552010086
    },
    {
        "content": "<p>Interestingly you've uncovered a bug in Ontoserver; scenario 1 should have worked.<br>\nThis is now fixed.</p>",
        "id": 160283215,
        "sender_full_name": "Michael Lawley",
        "timestamp": 1552046088
    }
]