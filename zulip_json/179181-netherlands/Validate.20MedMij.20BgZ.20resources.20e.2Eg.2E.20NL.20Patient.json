[
    {
        "content": "<p>I'm pretty new to the MedMij, Nictiz and FHIR standards and I'm trying to be able to get a grasp on coding systems, value sets and validating resources.</p>\n<p>Consider I have a FHIR STU3 <code>Patient.json</code>(example \"Irma Jongeneel-de Haas\" from <a href=\"https://simplifier.net/nictizstu3-zib2017/patient-example-duplicate-12\" target=\"_blank\" title=\"https://simplifier.net/nictizstu3-zib2017/patient-example-duplicate-12\">https://simplifier.net/nictizstu3-zib2017/patient-example-duplicate-12</a>) which, after reading <a href=\"https://confluence.hl7.org/display/FHIR/Using+the+FHIR+Validator\" target=\"_blank\" title=\"https://confluence.hl7.org/display/FHIR/Using+the+FHIR+Validator\">https://confluence.hl7.org/display/FHIR/Using+the+FHIR+Validator</a>, am able to validate like this:</p>\n<p><span aria-label=\"boom\" class=\"emoji emoji-1f4a5\" role=\"img\" title=\"boom\">:boom:</span> Default FHIR STU3 validation fails:</p>\n<div class=\"codehilite\"><pre><span></span>tvinke@localhost ~/projects/medmij (master) $ java -jar org.hl7.fhir.validator.jar Patient.json -version 3.0\nFHIR Validation tool Version 4.1.21-SNAPSHOT (Git# 89592da490df). Built 2019-12-09T17:47:19.708+11:00 (43 days old)\nDetected Java version: 1.8.0_121 from /Library/Java/JavaVirtualMachines/jdk1.8.0_121.jdk/Contents/Home/jre on x86_64 (64bit). 3641MB available\nArguments: Patient.json -version 3.0\nDirectories: Current = /Users/tvinke/projects/medmij, Package Cache = /Users/tvinke/.fhir/packages\n  .. FHIR Version 3.0, definitions from hl7.fhir.r3.core#3.0.2\n  .. connect to tx server @ http://tx.fhir.org\n    (v3.0.2)\n  .. validate [Patient.json]\nSuccess...validating Patient.json:  error:0 warn:3 info:1\n  Information @ Patient.address[0].extension[0] (line 91, col18) : Unknown extension http://fhir.nl/fhir/StructureDefinition/nl-core-address-official\n  Warning @ Patient.contact[0].relationship[0] (line 138, col18) : None of the codes provided are in the value set http://hl7.org/fhir/ValueSet/v2-0131 (http://hl7.org/fhir/ValueSet/v2-0131, and a code should come from this value set unless it has no suitable code) (codes = urn:oid:2.16.840.1.113883.2.4.3.11.22.472#1)\n  Warning @ Patient.contact[0].relationship[1] (line 147, col18) : None of the codes provided are in the value set http://hl7.org/fhir/ValueSet/v2-0131 (http://hl7.org/fhir/ValueSet/v2-0131, and a code should come from this value set unless it has no suitable code) (codes = http://hl7.org/fhir/v3/RoleCode#HUSB)\n  Warning @ Patient.meta.profile[0] (line 1, col2) : StructureDefinition reference &quot;http://fhir.nl/fhir/StructureDefinition/nl-core-patient&quot; could not be resolved\n</pre></div>\n\n\n<p>Assumption: I've probably got all these errors because the JSON contains all Dutch-specific extensions right?</p>\n<p>Since it's not just an international FHIR patient, I would like to validate it as valid \"MedMij\" patient. <br>\nIs a valid \"MedMij\" patient the same as a valid Nictiz <a href=\"https://simplifier.net/nictizstu3-zib2017/nl-core-patient\" target=\"_blank\" title=\"https://simplifier.net/nictizstu3-zib2017/nl-core-patient\">https://simplifier.net/nictizstu3-zib2017/nl-core-patient</a> ?</p>\n<p>If so, how would I go about validating it according to nl-core-patient? I saw that the validator could be pointed to a <strong>profile</strong>. Unfortunately, the following fails.</p>\n<p><span aria-label=\"boom\" class=\"emoji emoji-1f4a5\" role=\"img\" title=\"boom\">:boom:</span> Validating with <code>-profile http://fhir.nl/fhir/StructureDefinition/nl-core-patient</code> parameter fails:</p>\n<div class=\"codehilite\"><pre><span></span>tvinke@localhost ~/projects/medmij (master) $ java -jar org.hl7.fhir.validator.jar Patient.json -version 3.0 -profile http://fhir.nl/fhir/StructureDefinition/nl-core-patient\nFHIR Validation tool Version 4.1.21-SNAPSHOT (Git# 89592da490df). Built 2019-12-09T17:47:19.708+11:00 (43 days old)\nDetected Java version: 1.8.0_121 from /Library/Java/JavaVirtualMachines/jdk1.8.0_121.jdk/Contents/Home/jre on x86_64 (64bit). 3641MB available\nArguments: Patient.json -version 3.0 -profile http://fhir.nl/fhir/StructureDefinition/nl-core-patient\nDirectories: Current = /Users/tvinke/projects/medmij, Package Cache = /Users/tvinke/.fhir/packages\n  .. FHIR Version 3.0, definitions from hl7.fhir.r3.core#3.0.2\n  .. connect to tx server @ http://tx.fhir.org\n    (v3.0.2)\nFetch Profile from http://fhir.nl/fhir/StructureDefinition/nl-core-patient\nException in thread &quot;main&quot; org.hl7.fhir.exceptions.FHIRException: unable to determine format\n    at org.hl7.fhir.r5.formats.FormatUtilities.determineFormat(FormatUtilities.java:143)\n    at org.hl7.fhir.r5.formats.FormatUtilities.determineFormat(FormatUtilities.java:131)\n    at org.hl7.fhir.r5.validation.ValidationEngine.loadProfile(ValidationEngine.java:779)\n    at org.hl7.fhir.r5.validation.Validator.main(Validator.java:630)\n</pre></div>\n\n\n<p>Ok, the validation wiki page talks about also specifying an \"loading an implementation guide\".  Luckily I saw a \"package\" <strong>nictiz.fhir.nl.stu3.zib2017</strong> is available on <a href=\"https://simplifier.net/packages/nictiz.fhir.nl.stu3.zib2017/1.3.3\" target=\"_blank\" title=\"https://simplifier.net/packages/nictiz.fhir.nl.stu3.zib2017/1.3.3\">https://simplifier.net/packages/nictiz.fhir.nl.stu3.zib2017/1.3.3</a> so I tried additionally specifying that name with the <code>-ig</code> parameter -- but it fails:</p>\n<p><span aria-label=\"boom\" class=\"emoji emoji-1f4a5\" role=\"img\" title=\"boom\">:boom:</span> Validating with <code>-ig nictiz.fhir.nl.stu3.zib2017 -profile http://fhir.nl/fhir/StructureDefinition/nl-core-patient</code> parameter fails:</p>\n<div class=\"codehilite\"><pre><span></span>tvinke@localhost ~/projects/medmij (master) $ java -jar org.hl7.fhir.validator.jar Patient.json -version 3.0 -ig nictiz.fhir.nl.stu3.zib2017 -profile http://fhir.nl/fhir/StructureDefinition/nl-core-patient\nFHIR Validation tool Version 4.1.21-SNAPSHOT (Git# 89592da490df). Built 2019-12-09T17:47:19.708+11:00 (43 days old)\nDetected Java version: 1.8.0_121 from /Library/Java/JavaVirtualMachines/jdk1.8.0_121.jdk/Contents/Home/jre on x86_64 (64bit). 3641MB available\nArguments: Patient.json -version 3.0 -ig nictiz.fhir.nl.stu3.zib2017 -profile http://fhir.nl/fhir/StructureDefinition/nl-core-patient\nDirectories: Current = /Users/tvinke/projects/medmij, Package Cache = /Users/tvinke/.fhir/packages\n  .. FHIR Version 3.0, definitions from hl7.fhir.r3.core#3.0.2\n  .. connect to tx server @ http://tx.fhir.org\n    (v3.0.2)\n+  .. load IG from nictiz.fhir.nl.stu3.zib2017\nException in thread &quot;main&quot; org.hl7.fhir.exceptions.FHIRException: Unable to resolve the package &#39;nictiz.fhir.nl.stu3.zib2017&#39;\n    at org.hl7.fhir.utilities.cache.PackageCacheManager.loadPackage(PackageCacheManager.java:605)\n    at org.hl7.fhir.r5.validation.ValidationEngine.resolvePackage(ValidationEngine.java:694)\n    at org.hl7.fhir.r5.validation.ValidationEngine.fetchByPackage(ValidationEngine.java:683)\n    at org.hl7.fhir.r5.validation.ValidationEngine.loadIgSource(ValidationEngine.java:522)\n    at org.hl7.fhir.r5.validation.ValidationEngine.loadIg(ValidationEngine.java:786)\n    at org.hl7.fhir.r5.validation.Validator.main(Validator.java:567)\n</pre></div>\n\n\n<p>3rd strike. I saw on the validator page that the <code>-ig</code> parameter could also point to a directory!</p>\n<p>Downloading profiles &amp; value sets manually (as Henk-Jan Meijer did in <a href=\"#narrow/stream/179181-netherlands/topic/Validation.20of.20MedMij.20example\" title=\"#narrow/stream/179181-netherlands/topic/Validation.20of.20MedMij.20example\">\"Validation of MedMij example\"</a>) seems error-prone, so tried to download the entire package <strong>nictiz.fhir.nl.stu3.zib2017</strong> with the instructions using NPM:</p>\n<div class=\"codehilite\"><pre><span></span>tvinke@localhost ~/projects/medmij (master) $ npm --registry https://packages.simplifier.net install nictiz.fhir.nl.stu3.zib2017@1.3.3\nnpm WARN saveError ENOENT: no such file or directory, open &#39;/Users/tvinke/projects/medmij/package.json&#39;\nnpm notice created a lockfile as package-lock.json. You should commit this file.\nnpm WARN enoent ENOENT: no such file or directory, open &#39;/Users/tvinke/projects/medmij/package.json&#39;\nnpm WARN medmij No description\nnpm WARN medmij No repository field.\nnpm WARN medmij No README data\nnpm WARN medmij No license field.\n\n+ nictiz.fhir.nl.stu3.zib2017@1.3.3\nadded 1 package from 1 contributor in 0.84s\n</pre></div>\n\n\n<p>(It's just that I happened to have NPM already on my Macbook, instead of this Torinox.)</p>\n<p>Result, a directory in a <code>node_modules</code> with 500+ JSON files:</p>\n<div class=\"codehilite\"><pre><span></span>tvinke@localhost ~/projects/medmij (master) $ tree node_modules/\nnode_modules/\n└── nictiz.fhir.nl.stu3.zib2017\n    ├── AanvullendeGebruiksinstructie-2.16.840.1.113883.2.4.3.11.60.20.77.11.9--20160407000000.json\n    ├── AanvullendeWensenCodelijst-2.16.840.1.113883.2.4.3.11.60.40.2.9.10.1--20171231000000.json\n    ...\n    ├── zib-Vaccination.json\n    ├── zib-VaccinationRecommendation-OrderStatus.json\n    └── zib-VaccinationRecommendation.json\n\n1 directory, 548 files\n</pre></div>\n\n\n<p><span aria-label=\"boom\" class=\"emoji emoji-1f4a5\" role=\"img\" title=\"boom\">:boom:</span> Using the <code>-ig node_modules/nictiz.fhir.nl.stu3.zib2017 -profile http://fhir.nl/fhir/StructureDefinition/nl-core-patient</code> parameter pointing to the directory does seem to process its files ( <span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span> ) but all kinds of errors about the files themselves it seems:</p>\n<div class=\"codehilite\"><pre><span></span>...\n* load file: example-zib-NursingIntervention.json - ignored due to error: Unknown resource Procedure\n* load file: medmij-bgz-fhir3-0-1-coverage-ts-02.json - ignored due to error: Unknown resource Coverage\n  .. validate [Patient.json] against [http://fhir.nl/fhir/StructureDefinition/nl-core-patient]\nUnable to generate snapshot for http://nictiz.nl/fhir/StructureDefinition/zib-InstructionsForUse: Error at path Dosage.dose[x]: Slice name must be &#39;doseQuantity&#39; but is &#39;DoseQuantity&#39;\nUnable to generate snapshot for zib-AdministrationAgreement from MedicationDispense because Error at path Dosage.dose[x]: Slice name must be &#39;doseQuantity&#39; but is &#39;DoseQuantity&#39;\norg.hl7.fhir.exceptions.FHIRException: Error at path Dosage.dose[x]: Slice name must be &#39;doseQuantity&#39; but is &#39;DoseQuantity&#39;\n    at org.hl7.fhir.r5.conformance.ProfileUtilities.processPaths(ProfileUtilities.java:867)\n    at org.hl7.fhir.r5.conformance.ProfileUtilities.generateSnapshot(ProfileUtilities.java:472)\n    at org.hl7.fhir.r5.conformance.ProfileUtilities.processPaths(ProfileUtilities.java:700)\n    at org.hl7.fhir.r5.conformance.ProfileUtilities.generateSnapshot(ProfileUtilities.java:472)\n    at org.hl7.fhir.r5.context.SimpleWorkerContext.generateSnapshot(SimpleWorkerContext.java:616)\n    at org.hl7.fhir.r5.context.SimpleWorkerContext.allStructures(SimpleWorkerContext.java:479)\n    at org.hl7.fhir.r5.validation.ValidationEngine.prepare(ValidationEngine.java:1326)\n    at org.hl7.fhir.r5.validation.Validator.main(Validator.java:652)\nmismatch in paths: Observa...\n...etc\n</pre></div>\n\n\n<p>So I gave up :-) <br>\n<strong>What would be the correct way to validate a Dutch patient from the command-line?</strong></p>",
        "id": 186192825,
        "sender_full_name": "Ted Vinke",
        "timestamp": 1579619999
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"259573\">@Ted Vinke</span>, I've tried validating with our Torinox command line tool - see <a href=\"https://simplifier.net/downloads/torinox\" target=\"_blank\" title=\"https://simplifier.net/downloads/torinox\">https://simplifier.net/downloads/torinox</a>, and get a succes.  Torinox is a dotnet core tool, which makes it run cross platform. It uses the validator of the official .NET API for HL7 FHIR. After you have installed the tool, and assuming you have the patient data in a file called patient.json, these are the steps to take:</p>\n<div class=\"codehilite\"><pre><span></span>$ fhir install nictiz.fhir.nl.stu3.zib2017\n$ fhir push patient.json\n$ fhir validate\n</pre></div>",
        "id": 186307980,
        "sender_full_name": "Mirjam Baltus",
        "timestamp": 1579713043
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"191347\">@Mirjam Baltus</span>, thank you!</p>\n<p>I sure hope some user of the Java validator will still be able to give some feedback on its usage. Seems more light-weight and more easy to run validation on any of our development systems since Java has been installed everywhere by default. <span aria-label=\"blush\" class=\"emoji emoji-1f60a\" role=\"img\" title=\"blush\">:blush:</span> but I will give Torinox definitely a try. <span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span></p>\n<p>Do you perhaps know who created the Java validator so I can get in touch with the author?</p>",
        "id": 186369100,
        "sender_full_name": "Ted Vinke",
        "timestamp": 1579769886
    },
    {
        "content": "<p>I think Grahame and/or on of the HAPI guys.<br>\nAnyhow. I noticed that passing the validation doesnot garantee a valid FHIR json. Especially with the StructureDefinitions and Extensions. I have not gotten my head around it yet.</p>",
        "id": 186381725,
        "sender_full_name": "Michael van der Zel",
        "timestamp": 1579781249
    },
    {
        "content": "<p>I'm still reconciling with the dutch medmij definitions. There's some underlying issues that we haven't sorted yet. If you think that validator isn't checking something, please tell me about it</p>",
        "id": 186467178,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1579847856
    },
    {
        "content": "<p>I will let you know the things I have found.</p>",
        "id": 186472264,
        "sender_full_name": "Michael van der Zel",
        "timestamp": 1579854875
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191375\">@Alexander Henket</span> I had a spare hour, so I looked at this again. The profile <a href=\"http://nictiz.nl/fhir/StructureDefinition/zib-BodyHeight\" target=\"_blank\" title=\"http://nictiz.nl/fhir/StructureDefinition/zib-BodyHeight\">http://nictiz.nl/fhir/StructureDefinition/zib-BodyHeight</a> allows Group in it's target list, but it's a constraint on <a href=\"http://nictiz.nl/fhir/StructureDefinition/zib-VitalSigns\" target=\"_blank\" title=\"http://nictiz.nl/fhir/StructureDefinition/zib-VitalSigns\">http://nictiz.nl/fhir/StructureDefinition/zib-VitalSigns</a> (via an intermediate step) which constrains observation.subject to <a href=\"http://fhir.nl/fhir/StructureDefinition/nl-core-patient\" target=\"_blank\" title=\"http://fhir.nl/fhir/StructureDefinition/nl-core-patient\">http://fhir.nl/fhir/StructureDefinition/nl-core-patient</a>. This error happens quite a bit</p>",
        "id": 186532042,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1579898569
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> Interesting you should call this an error. I thought that it was still under debate how you would interpret that in a multi-type, only one of them is named in a differential with a targetProfile.</p>\n<ul>\n<li>You can use only this type with this targetProfile (or derived profile thereof). Other types are excluded</li>\n<li>You must use this this type with this targetProfile (or derived profile thereof). Other types are not constrained.</li>\n</ul>\n<p>Is the word out that the former is the correct interpretation? It means you will always need to leave all types in the differential if you want to apply a targetProfile to one of them.</p>\n<p>I've filed the issue here: <a href=\"https://bits.nictiz.nl/browse/MM-894\" target=\"_blank\" title=\"https://bits.nictiz.nl/browse/MM-894\">https://bits.nictiz.nl/browse/MM-894</a> - we are releasing updates on a monthly basis as long as they are backward compatible.</p>",
        "id": 186661131,
        "sender_full_name": "Alexander Henket",
        "timestamp": 1580113188
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> Side note: running the java validator on the command line still yields String index out of range: -1</p>\n<div class=\"codehilite\"><pre><span></span>$ java -jar org.hl7.fhir.validator.jar -ig &quot;../GitHub/Nictiz/Nictiz-STU3-Zib2017/Profiles - ZIB 2017&quot; -version 3.0 -recurse -debug STU3-Java/instances/medmij-bgz-fhir3-0-1-labresult-ts-01.xml\n\nFHIR Validation tool Version 4.1.53-SNAPSHOT (Git# ee6e0d90de9b). Built 2020-01-24T17:20:43.54+11:00 (3 days old)\nDetected Java version: 1.8.0_121 from /Library/Java/JavaVirtualMachines/jdk1.8.0_121.jdk/Contents/Home/jre on x86_64 (64bit). 3641MB available\nArguments: -ig &quot;../GitHub/Nictiz/Nictiz-STU3-Zib2017/Profiles - ZIB 2017&quot; -version 3.0 -recurse -debug STU3-Java/instances/medmij-bgz-fhir3-0-1-labresult-ts-01.xml\nDirectories: Current = /Users/ahenket/Development/FHIR, Package Cache = /Users/ahenket/.fhir/packages\n  .. FHIR Version 3.0, definitions from hl7.fhir.r3.core#3.0.2\n  .. connect to tx server @ http://tx.fhir.org\n    (v3.0.2)\n+  .. load IG from ../GitHub/Nictiz/Nictiz-STU3-Zib2017/Profiles - ZIB 2017\nException in thread &quot;main&quot; java.lang.StringIndexOutOfBoundsException: String index out of range: -1\n    at java.lang.String.substring(String.java:1967)\n    at org.hl7.fhir.utilities.Utilities.path(Utilities.java:584)\n    at org.hl7.fhir.r5.validation.ValidationEngine.loadIgSource(ValidationEngine.java:504)\n    at org.hl7.fhir.r5.validation.ValidationEngine.loadIg(ValidationEngine.java:789)\n    at org.hl7.fhir.r5.validation.Validator.main(Validator.java:572)\n</pre></div>\n\n\n<p>While running it in Eclipse yields results albeit that I don't understand them. Why does the latest generator give me 50-60 errors like this:</p>\n<div class=\"codehilite\"><pre><span></span>Unable to generate snapshot for zib-MedicationAgreement from MedicationRequest because Profile Zib MedicationAgreement (http://nictiz.nl/fhir/StructureDefinition/zib-MedicationAgreement). Error generating snapshot: Duplicate Element id MedicationRequest.extension:additionalInformation.value[x]:valueCodeableConcept\norg.hl7.fhir.exceptions.DefinitionException: Profile Zib MedicationAgreement (http://nictiz.nl/fhir/StructureDefinition/zib-MedicationAgreement). Error generating snapshot: Duplicate Element id MedicationRequest.extension:additionalInformation.value[x]:valueCodeableConcept\n    at org.hl7.fhir.r5.context.SimpleWorkerContext.generateSnapshot(SimpleWorkerContext.java:619)\n    at org.hl7.fhir.r5.context.SimpleWorkerContext.allStructures(SimpleWorkerContext.java:479)\n    at org.hl7.fhir.r5.validation.ValidationEngine.prepare(ValidationEngine.java:1326)\n    at org.hl7.fhir.r5.validation.Validator.main(Validator.java:652)\n</pre></div>\n\n\n<p>This one above appears to concern a quite common thing we do which is to apply a binding to an extension in the calling profile instead of the extension itself.</p>",
        "id": 186662340,
        "sender_full_name": "Alexander Henket",
        "timestamp": 1580114643
    },
    {
        "content": "<p>I'm still working through the errors as I have time. I don't know what's going on with that one yet.</p>",
        "id": 186664729,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1580116963
    },
    {
        "content": "<p>The definition for targetProfile says: </p>\n<blockquote>\n<p>If any profiles are specified, then the content must conform to at least one of them</p>\n</blockquote>\n<p>which means that this interpretation applies:</p>\n<blockquote>\n<p>You can use only this type with this targetProfile (or derived profile thereof). Other types are excluded</p>\n</blockquote>\n<p>And it must, really, else you can't exclude the other types</p>",
        "id": 186664802,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1580117039
    }
]