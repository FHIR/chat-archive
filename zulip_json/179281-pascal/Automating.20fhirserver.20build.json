[
    {
        "content": "<p>I'm new to pascal (well, I mean, beyond nerd camp for nerds in the mid 90's) and looking at Grahame's instructions for compiling the fhirserver (<a href=\"https://github.com/grahamegrieve/fhirserver/blob/master/linux-install-instructions.txt\">https://github.com/grahamegrieve/fhirserver/blob/master/linux-install-instructions.txt</a>. Aim is to get a dockerized build process that's automated and repeatable, all from the commandline (i.e., without a desktop environment if possible).</p>\n<p>I'm installing on ubuntu 20.04 starting from the 3 packages at <a href=\"https://sourceforge.net/projects/lazarus/files/Lazarus%20Linux%20amd64%20DEB/Lazarus%202.2RC1/\">https://sourceforge.net/projects/lazarus/files/Lazarus%20Linux%20amd64%20DEB/Lazarus%202.2RC1/</a></p>\n<p>After following <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span>'s README steps I can do:</p>\n<div class=\"codehilite\"><pre><span></span><code>lazbuild work/fhirserver/packages/fhir.lpk\nlazbuild work/fhirserver/packages/fhir4.lpk\n</code></pre></div>\n\n<p>with a bunch of warnings, hints, and notes -- but no errors. That's good, right? Do I need to compile other lpks in that packages directory too?  What needs to happen next? (I don't see any executable outputs when I look with <code>find work/fhirserver -executable -type f</code>.)</p>",
        "id": 255914821,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633226763
    },
    {
        "content": "<p>you need to compile all those packages yes</p>",
        "id": 255917470,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633229834
    },
    {
        "content": "<p>once you've compiled all those packages, then you need to compile work/fhirserver/server/fhirserver.lpi</p>",
        "id": 255917530,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633229885
    },
    {
        "content": "<p>that will produce the executable</p>",
        "id": 255917542,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633229913
    },
    {
        "content": "<blockquote>\n<p>a dockerized build process that's automated and repeatable</p>\n</blockquote>\n<p>That'll be a lovely outcome I'd really like</p>",
        "id": 255917560,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633229954
    },
    {
        "content": "<p>and that you got fhir.lpk to build makes it very likely you'll get all the way - that includes all the code I know that depends on recent features of lazarus</p>",
        "id": 255917694,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633230054
    },
    {
        "content": "<p>OK, a couple of issues:</p>\n<div class=\"codehilite\"><pre><span></span><code>#14 15.18 (3104) Compiling /work/fhirserver/library/wp/wp_types.pas\n#14 15.18 /work/fhirserver/library/wp/wp_types.pas(35,3) Fatal: (10022) Can&#39;t find unit Windows used by wp_types\n#14 15.30 Fatal: (1018) Compilation aborted\n#14 15.30 Error: /usr/bin/ppcx64 returned an error exitcode\n#14 15.30 Error: (lazarus) Compile package fhir_wp 0.0: stopped with exit code 1\n#14 15.30 Error: (lazbuild) fhir_wp 0.0 compilation failed\n</code></pre></div>\n<p>If I skip <code>fhir_wp</code>, compiling the rest of the packages works, but when I move on to compiling <code>server/fhirserver.lpi</code> I see:</p>\n<div class=\"codehilite\"><pre><span></span><code> &gt; [11/11] RUN lazbuild work/fhirserver/server/fhirserver.lpi:\n#15 1.630 Hint: (lazarus) [RunTool] &quot;/usr/bin/fpc&quot; &quot;-iWTOTP&quot;\n#15 1.630 Hint: (lazarus) [RunTool] &quot;/usr/bin/fpc&quot; &quot;-va&quot; &quot;compilertest.pas&quot;\n#15 1.630 Hint: (lazarus) [RunTool] &quot;/usr/bin/fpc&quot; &quot;-iWTOTP&quot; &quot;-Px86_64&quot; &quot;-Tlinux&quot;\n#15 1.630 Hint: (lazarus) [RunTool] &quot;/usr/bin/fpc&quot; &quot;-va&quot; &quot;compilertest.pas&quot; &quot;-Px86_64&quot; &quot;-Tlinux&quot;\n#15 2.022 ### TCodeToolManager.HandleException: [20170422130152] &quot;include file not found &quot;fhir.inc&quot;&quot; at Line=31 Col=5 in &quot;/work/fhirserver/server/fhirserver.lpr&quot;\n#15 2.022 Error: (lazbuild) Broken dependency: MarkdownTests\n</code></pre></div>\n<p>This is after <code>lazbuild work/delphi-markdown/packages/markdownengine.lpk</code>, but I can't tell whether that actually includes MarkdownTests. If I try doing <code>lazbuild work/delphi-markdown/tests/markdowntests.lpk</code> before building the server, I get on to some new errors that have to do with windows32 platform (?)</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>win32 errors?</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\"><pre><span></span><code>#16 1.680 Hint: (lazarus) [RunTool] &quot;/usr/bin/fpc&quot; &quot;-iWTOTP&quot; &quot;-Pi386&quot; &quot;-Twin32&quot;\n#16 1.680 Warning: [TPCTargetConfigCache.Update] cannot find real compiler for this platform: Compiler=&quot;/usr/bin/fpc&quot; Options=&quot;-Pi386 -Twin32&quot; RealCompiler=&quot;&quot;\n#16 1.777 Hint: (lazarus) Missing state file of LCL 2.2.0.1: /usr/share/lazarus/2.2.0RC1/lcl/units/i386-win32/win32/LCL.compiled\n#16 1.777 Hint: (lazarus) Missing state file of LazControls 1.0.1: /usr/share/lazarus/2.2.0RC1/components/lazcontrols/lib/i386-win32/win32/LazControls.compiled\n#16 1.781 Hint: (lazarus) Missing state file of lclextensions_package 0.6.1: /usr/share/lazarus/2.2.0RC1/components/lclextensions/lib/i386-win32-win32/lclextensions_package.compiled\n#16 1.787 Hint: (lazarus) Missing state file of markdowntests 0.0: /work/delphi-markdown/tests/lib/i386-win32/markdowntests.compiled\n#16 1.787 Hint: (lazarus) Missing state file of SynEdit 1.0: /usr/share/lazarus/2.2.0RC1/components/synedit/units/i386-win32/win32/SynEdit.compiled\n#16 1.817 Hint: (lazarus) Missing state file of FPCUnitTestRunner 0.1: /usr/share/lazarus/2.2.0RC1/components/fpcunit/lib/i386-win32/win32/FPCUnitTestRunner.compiled\n#16 1.817 Hint: (lazarus) Missing state file of IDEIntf 1.0: /usr/share/lazarus/2.2.0RC1/components/ideintf/units/i386-win32/win32/IDEIntf.compiled\n#16 1.842 Hint: (lazarus) Missing state file of laz.virtualtreeview_package 5.5.3.1: /usr/share/lazarus/2.2.0RC1/components/virtualtreeview/lib/i386-win32-win32/laz.virtualtreeview_package.compiled\n#16 1.842 Hint: (lazarus) Missing state file of PascalTZ 2.2: /work/PascalTZ/package/lib/i386-win32/PascalTZ.compiled\n#16 1.856 Hint: (lazarus) Missing state file of fhir_fsl 0.0: /work/fhirserver/packages/lib/i386-win32/fhir_fsl.compiled\n#16 1.856 ### TCodeToolManager.HandleException: [20170422130152] &quot;include file not found &quot;fhir.inc&quot;&quot; at Line=31 Col=5 in &quot;/work/fhirserver/library/fsl/fsl_java_utilities.pas&quot;\n#16 1.895 Hint: (lazarus) Missing state file of idetester 0.0: /work/lazarus-ide-tester/package/lib/i386-win32/idetester.compiled\n#16 1.895 Hint: (lazarus) Missing state file of fhir 0.0: /work/fhirserver/packages/lib/i386-win32/fhir.compiled\n#16 2.055 Hint: (lazarus) Missing state file of fhir2 0.0: /work/fhirserver/packages/lib/i386-win32/fhir2.compiled\n#16 2.055 Hint: (lazarus) Missing state file of fhir3 0.0: /work/fhirserver/packages/lib/i386-win32/fhir3.compiled\n#16 2.365 Hint: (lazarus) Missing state file of fhir4 0.0: /work/fhirserver/packages/lib/i386-win32/fhir4.compiled\n#16 2.365 Hint: (lazarus) Missing state file of fhir5 0.0: /work/fhirserver/packages/lib/i386-win32/fhir5.compiled\n#16 2.365 Hint: (lazarus) Missing state file of fhir_fui 0.0: /work/fhirserver/packages/lib/i386-win32/fhir_fui.compiled\n#16 2.452 Hint: (lazarus) Missing state file of fhir_xver 0.0: /work/fhirserver/packages/lib/i386-win32/fhir_xver.compiled\n#16 2.452 Error: ppc386 can&#39;t be executed, error message: Failed to execute &quot;ppc386&quot;, error code: 127\n#16 2.506 Error: (lazarus) Compile package FCL 1.0.1: stopped with exit code 1\n#16 2.506 Error: (lazarus) [TLazPackageGraph.CompileRequiredPackages] &quot;Exit code 1&quot;\n#16 2.506 Error: (lazbuild) Project dependencies of /work/fhirserver/server/fhirserver.lpi\n</code></pre></div>\n</div></div>",
        "id": 255920047,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633232769
    },
    {
        "content": "<p>SO:</p>",
        "id": 255922637,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633235790
    },
    {
        "content": "<ul>\n<li>fhir_wp - don't compile that. I forgot it was there</li>\n<li>markdowntests - yes, I missed that. Have to add that to the package list</li>\n<li>the last error.... don't know why you're compiling for win32 at all</li>\n</ul>",
        "id": 255922688,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633235859
    },
    {
        "content": "<p>I think you need --build-mode=Linux</p>",
        "id": 255922774,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633235941
    },
    {
        "content": "<p>btw, once you've built it, it won't run. I'm working on that now - some .so dependency issue, and I find them very hard to figure out (won't run on OSX for the same reason, different .dylib)</p>",
        "id": 255922795,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633235972
    },
    {
        "content": "<p>well, if I could figure out how to commit from my linux dev PC, it would run, but the personal access token thing seems specifically designed to keep me out</p>",
        "id": 255935297,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633250183
    },
    {
        "content": "<p>sorted that out. it should run, at least, though I have a lot of testing to do.</p>",
        "id": 255936953,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633251918
    },
    {
        "content": "<p>Here's my experience with cross platform development, when I run into a problem:</p>\n<ul>\n<li>windows: I find the answer immediately </li>\n<li>linux : I find hundreds of different answers, one of which might be correct for me, but I can't figure out which</li>\n<li>macos: I can't find <em>anything</em></li>\n</ul>",
        "id": 255937032,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633251987
    },
    {
        "content": "<p>brew tells me that openSSL 1.1 is installed... but I can't find the dylib files. Where should I look?</p>",
        "id": 255938687,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633253768
    },
    {
        "content": "<blockquote>\n<p>openssl failed to load: dlopen(libssl.1.1.dylib, 1): image not found</p>\n</blockquote>\n<p>So I can't find it and neither can my program</p>",
        "id": 255939311,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633254470
    },
    {
        "content": "<p>but brew says:</p>",
        "id": 255939354,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633254484
    },
    {
        "content": "<blockquote>\n<p>brew install <a href=\"mailto:openssl@1.1\">openssl@1.1</a><br>\nWarning: <a href=\"mailto:openssl@1.1\">openssl@1.1</a> 1.1.1l is already installed and up-to-date.<br>\nTo reinstall 1.1.1l, run:<br>\n brew reinstall <a href=\"mailto:openssl@1.1\">openssl@1.1</a></p>\n</blockquote>",
        "id": 255939374,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633254532
    },
    {
        "content": "<p>Will try with <code>--buildmode=Linux</code>. Alas I can't help on the MacOS / brew front</p>",
        "id": 256002085,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633318895
    },
    {
        "content": "<p>Build succeeds with <code>--build-mode=Linux</code>.  I see when I try running it that at least libChakraCore is missing.</p>",
        "id": 256003558,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633320353
    },
    {
        "content": "<p>that should be resolved now.</p>",
        "id": 256003711,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633320486
    },
    {
        "content": "<p>no. somehow git beat me, and the code to fix that wasn't pushed</p>",
        "id": 256003761,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633320567
    },
    {
        "content": "<p>OK -- I see when I manually install chakraCore I get X related errors. I don't know if the server needs a graphical environment, but I've updated <a href=\"https://github.com/jmandel/fhirserver/blob/patch-3/Dockerfile\">https://github.com/jmandel/fhirserver/blob/patch-3/Dockerfile</a> to give it one...</p>",
        "id": 256004076,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633320902
    },
    {
        "content": "<p>At which point it fails to find <code>/work/fhirserver/exec/64/tz.dat</code> (I note that <code>/work/fhirserver/exec/pack/tz.dat</code> does exist, and if I try to copy this file to the other path and re-run the <code>fhirserver</code>, I get a segfault.)</p>",
        "id": 256004182,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633320998
    },
    {
        "content": "<p>hmm. you shouldn't. the one in /pack is the correct file - it will need all the .dat files in there</p>",
        "id": 256006205,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633323147
    },
    {
        "content": "<p>how did you manually install chakracore?</p>",
        "id": 256006222,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633323175
    },
    {
        "content": "<p><a href=\"https://github.com/jmandel/fhirserver/blob/dc43a3a0c10e0fe6ac83daf09725dc9d5b952d07/Dockerfile#L45\">https://github.com/jmandel/fhirserver/blob/dc43a3a0c10e0fe6ac83daf09725dc9d5b952d07/Dockerfile#L45</a></p>",
        "id": 256006327,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633323271
    },
    {
        "content": "<p>just copy it into /usr/lib? weird. I'd <em>never</em> do that on windows.</p>",
        "id": 256006359,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633323322
    },
    {
        "content": "<p>anyway, the one in pack should go next to the executable, but the compiler flag for that didn't get pushed.</p>",
        "id": 256006379,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633323353
    },
    {
        "content": "<p>(I'm not sure if that's the right way to install; I was just trying to get past the error)</p>",
        "id": 256006458,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633323410
    },
    {
        "content": "<p>ok</p>",
        "id": 256006480,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633323435
    },
    {
        "content": "<p>I just hate git</p>",
        "id": 256007038,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633323953
    },
    {
        "content": "<p>well....... maybe that will sort it.... maybe.</p>",
        "id": 256007137,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633324048
    },
    {
        "content": "<p>so with that commit, chakracore should be in the exec/64  folder now</p>",
        "id": 256007213,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633324106
    },
    {
        "content": "<p>the next issue for me to resolve is to get sqlite working on linux</p>",
        "id": 256014263,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633330765
    },
    {
        "content": "<p>nothing special there - standard install of sqlite3 and dev tools, and it's good to go. </p>\n<p>These parameters should do the trick:</p>\n<p><code>-cmd exec -cfg http://tx.fhir.org/config -version 4 </code></p>",
        "id": 256031123,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633340414
    },
    {
        "content": "<p>it defaults to running on port 80. if you want a different port, create a file web.ini in the same directory:</p>\n<div class=\"codehilite\" data-code-language=\"INI\"><pre><span></span><code><span class=\"k\">[web]</span>\n<span class=\"na\">http</span><span class=\"o\">=</span><span class=\"s\">{port}</span>\n</code></pre></div>",
        "id": 256031196,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633340454
    },
    {
        "content": "<p>I'm running with these updated args, but still seeing </p>\n<div class=\"codehilite\"><pre><span></span><code>EFOpenError: Unable to open file &quot;/work/fhirserver/exec/64/tz.dat&quot;: No such file or directory\n</code></pre></div>\n\n<p>(This is on commit 80bdd22ae24f9f21798b9ce5882de2d183a5b53c of fhirserver.)</p>",
        "id": 256068883,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633358079
    },
    {
        "content": "<p>and that file exists?</p>",
        "id": 256102731,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633370146
    },
    {
        "content": "<p>yay well, the server runs on OSX now</p>",
        "id": 256184097,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633414852
    },
    {
        "content": "<p>figuring out the install won't be much fun... every .dylib will hurt</p>",
        "id": 256184137,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633414887
    },
    {
        "content": "<p>Is the Linux install working?</p>",
        "id": 256229527,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1633434098
    },
    {
        "content": "<p>I can test it during the weekend - I can either test the installation, or test the server if the install goes well</p>",
        "id": 256229826,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1633434156
    },
    {
        "content": "<blockquote>\n<p>Grahame Grieve: and that file exists?</p>\n</blockquote>\n<p>No, <code>/work/fhirserver/exec/64/</code> has only the fhirserver binary inside.</p>",
        "id": 256261917,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633446256
    },
    {
        "content": "<p>so the files in exec/pack and exec/pack/linux need to be copied into exec/64 before executing</p>",
        "id": 256297907,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633459607
    },
    {
        "content": "<p>I know I got it most of the way there on Linux the last time that I tried, but that's been a little while now.  I may try to dust it off and give it another try there, too (also probably over the weekend).</p>",
        "id": 256299708,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1633460283
    },
    {
        "content": "<p>it's a lot easier now. And Josh's work is making it easier</p>",
        "id": 256302133,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633461179
    },
    {
        "content": "<blockquote>\n<p>figuring out the install won't be much fun... every .dylib will hurt</p>\n</blockquote>\n<p>Not sure if this might help, but homebrew (macOS) creates symlinks to many .dylib files under /usr/local/lib.  OpenSSL seems to be an exception.</p>\n<blockquote>\n<p>$ brew info openssl<br>\n...<br>\nopenssl&#64;1.1 is keg-only, which means it was not symlinked into /usr/local,<br>\nbecause macOS provides LibreSSL.</p>\n</blockquote>",
        "id": 256326922,
        "sender_full_name": "Joel Schneider",
        "timestamp": 1633471772
    },
    {
        "content": "<p>Adding the relevant <code>cp</code>s for those config files. Now I see:</p>\n<div class=\"codehilite\"><pre><span></span><code>/work/fhirserver/library/fdb/fdb_odbc_fpc.pas(52,1) Fatal: (2002) illegal character &quot;&#39;!&#39;&quot; ($21)\n</code></pre></div>\n\n<p>which may be a new source code error in the repo?</p>",
        "id": 256330956,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633474071
    },
    {
        "content": "<p>I committed a fix for that several hours ago</p>",
        "id": 256331049,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633474123
    },
    {
        "content": "<p>I git pulled 60sec ago</p>",
        "id": 256331089,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633474159
    },
    {
        "content": "<p>well... git on my linux box says that line is fixed, and everything is committed and pushed.</p>",
        "id": 256331276,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633474279
    },
    {
        "content": "<p>but it's very evidently not the case</p>",
        "id": 256331335,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633474319
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191926\">@Joel Schneider</span> the problem is, so far I can only get the dylibs to load by providing a full path (including version) to the dylibs at their source. But what would I deploy for other users? I find OSX really very hostile.</p>",
        "id": 256331595,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633474483
    },
    {
        "content": "<p>Now at <code>956a0a7b1b45555a5af3b5285853d573c1efb266</code>:</p>\n<div class=\"codehilite\"><pre><span></span><code>/work/fhirserver/server/remote_config.pas(414,18) Error: (5000) Identifier not found &quot;UniversalDateTime&quot;\n/work/fhirserver/server/remote_config.pas(421,91) Error: (5000) Identifier not found &quot;UniversalDateTime&quot;\nremote_config.pas(491) Fatal: (10026) There were 2 errors compiling module, stopping\nFatal: (1018) Compilation aborted\n</code></pre></div>",
        "id": 256342760,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633482051
    },
    {
        "content": "<p>really? more git won't commit for me. I wish I understood :-(</p>",
        "id": 256377880,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633509949
    },
    {
        "content": "<p>Hrm. We should dig into these git issues. Maybe record a screen cast or something?</p>",
        "id": 256406755,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633525402
    },
    {
        "content": "<p>not sure. I decided to try living with git command line. I made my changes and then git commit -a and git push. Said it had, and nothing more to do, but the changes disappeared. I've moved on, rebuilt the repo and installed gitkraken, which is working as I expected</p>",
        "id": 256416479,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633529015
    },
    {
        "content": "<p>anyway, compile issues should be sorted now</p>",
        "id": 256416519,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633529031
    },
    {
        "content": "<p>Okay. If gitkraken works for you, great! (The git cli has a learning curve but it's not, like, buggy/lossy.)</p>",
        "id": 256417509,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633529400
    },
    {
        "content": "<p>Rebuilding now...</p>",
        "id": 256417570,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633529417
    },
    {
        "content": "<p>For the dependencies in this project</p>\n<div class=\"codehilite\"><pre><span></span><code>    git clone https://github.com/dezlov/PascalTZ &amp;&amp; \\\n    git clone https://github.com/grahamegrieve/delphi-markdown &amp;&amp; \\\n    git clone https://github.com/mriscoc/extrasyn &amp;&amp; \\\n    git clone https://github.com/grahamegrieve/HtmlViewer &amp;&amp; \\\n    git clone https://github.com/grahamegrieve/lazarus-ide-tester &amp;&amp; \\\n    git clone https://github.com/Xor-el/QRCodeGenLib4Pascal\n</code></pre></div>\n<p>...  how do you version these in your development / when do you update them? I'm thinking I should be cloning a specific tag or commit to avoid surprises as these evolve.</p>",
        "id": 256418249,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633529682
    },
    {
        "content": "<p>I haven't considered that. They're pretty stable but I probably should. I may have to fork them</p>",
        "id": 256420525,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633530543
    },
    {
        "content": "<p>If you just want to pin to a git tag or hash, you don't need to fork. If you want to make your own changes... well, fork time.</p>",
        "id": 256420750,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633530616
    },
    {
        "content": "<p>Hmm, following your instructions I have two copies o-f <a href=\"http://libChakraCore.so\">libChakraCore.so</a>:</p>\n<div class=\"codehilite\"><pre><span></span><code>$ find /work/fhirserver/ | grep -i chakraCore.so\n/work/fhirserver/exec/pack/linux/libChakraCore.so\n/work/fhirserver/exec/64/libChakraCore.so\n</code></pre></div>\n<p>... but the fhirserver executable isn't finding these. (I can revert to putting this in /usr/lib, where the fhirserver finds it. Overall I wouldn't check 45MB compiled libraries into your git source tree, since the libChakraCore team already makes these available in a published release.)</p>\n<p>Anyway, after putting the lib in a good spot I get:</p>\n<div class=\"codehilite\"><pre><span></span><code>fhirserver: malloc.c:3839: _int_malloc: Assertion `chunk_main_arena (bck-&gt;bk)&#39; failed.\n</code></pre></div>",
        "id": 256421310,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633530822
    },
    {
        "content": "<p>running out of memory?</p>",
        "id": 256474397,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633550279
    },
    {
        "content": "<p>Definitely not -- this happens instantaneously and I have ~32GB free.</p>",
        "id": 256480537,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633552829
    },
    {
        "content": "<p>no, I'm at a loss. this is ubuntu?</p>",
        "id": 256488132,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633555896
    },
    {
        "content": "<p>Yes, built according to the dockerfile I shared</p>",
        "id": 256489573,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633556595
    },
    {
        "content": "<p>It actually generates various outputs when it fails.</p>",
        "id": 256489857,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633556753
    },
    {
        "content": "<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>A medium-sized output</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<h1>/work/fhirserver/exec/64/fhirserver</h1>\n<p>[FORMS.PP] ExceptionOccurred <br>\n  Sender=EAccessViolation<br>\n  Exception=Access violation<br>\n  Stack trace:<br>\n  $0000000000435B73<br>\nException at 0000000000435B73: EAccessViolation:<br>\nAccess violation.<br>\n[FORMS.PP] ExceptionOccurred <br>\n  Sender=EAccessViolation<br>\n  Exception=Access violation<br>\n  Stack trace:<br>\n  $0000000000ED369C<br>\n  $00000000007D8FE6  TRYGETVALUE,  line 601 of inc/generics.dictionaries.inc<br>\n  $00000000007DAB34  DESTROY,  line 946 of ../library/fsl/fsl_base.pas<br>\n  $00000000007DAE52  FREE,  line 1011 of ../library/fsl/fsl_base.pas<br>\n  $0000000000838100  DESTROY,  line 1631 of ../library/fsl/fsl_base.pas<br>\n  $00000000007DAE52  FREE,  line 1011 of ../library/fsl/fsl_base.pas<br>\n  $0000000000849314  DESTROY,  line 1212 of ../library/fsl/fsl_threads.pas<br>\n  $00000000007DAE52  FREE,  line 1011 of ../library/fsl/fsl_base.pas<br>\n  $0000000000844C15  DELETERANGE,  line 1905 of ../library/fsl/fsl_base.pas<br>\n  $0000000000842FCC  SETCOUNT,  line 1382 of ../library/fsl/fsl_base.pas<br>\n  $0000000000844FCA  CLEAR,  line 1911 of ../library/fsl/fsl_base.pas<br>\n  $0000000000843E83  DESTROY,  line 1629 of ../library/fsl/fsl_base.pas<br>\n  $00000000007DAE52  FREE,  line 1011 of ../library/fsl/fsl_base.pas<br>\n  $000000000084A8EA  DESTROY,  line 1441 of ../library/fsl/fsl_threads.pas<br>\n  $00000000007DAE52  FREE,  line 1011 of ../library/fsl/fsl_base.pas<br>\n  $0000000000846B4C  DONEUNIT,  line 684 of ../library/fsl/fsl_threads.pas<br>\n  $000000000084C6B9  FSL_THREADS_$$_finalize$,  line 1802 of ../library/fsl/fsl_threads.pas<br>\nException at 0000000000ED369C: EAccessViolation:<br>\nAccess violation.<br>\nrealloc(): invalid old size<br>\nAborted (core dumped)</p>\n</div></div>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>A shorter output</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<h1>/work/fhirserver/exec/64/fhirserver</h1>\n<p>[FORMS.PP] ExceptionOccurred <br>\n  Sender=EAccessViolation<br>\n  Exception=Access violation<br>\n  Stack trace:<br>\n  $0000000000435B73<br>\nException at 0000000000435B73: EAccessViolation:<br>\nAccess violation.<br>\nrealloc(): invalid old size<br>\nAborted (core dumped)</p>\n</div></div>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>A longer output</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<h1>/work/fhirserver/exec/64/fhirserver</h1>\n<p>[FORMS.PP] ExceptionOccurred <br>\n  Sender=EAccessViolation<br>\n  Exception=Access violation<br>\n  Stack trace:<br>\n  $0000000000435B73<br>\nException at 0000000000435B73: EAccessViolation:<br>\nAccess violation.<br>\n[FORMS.PP] ExceptionOccurred <br>\n  Sender=EAccessViolation<br>\n  Exception=Access violation<br>\n  Stack trace:<br>\n  $0000000000423FD0<br>\n  $00000000007D8FE6  TRYGETVALUE,  line 601 of inc/generics.dictionaries.inc<br>\n  $00000000007DAB34  DESTROY,  line 946 of ../library/fsl/fsl_base.pas<br>\n  $00000000046D872D  DESTROY,  line 420 of ../library/fsl/tests/fsl_testing.pas<br>\nException at 0000000000423FD0: EAccessViolation:<br>\nAccess violation.<br>\n[FORMS.PP] ExceptionOccurred <br>\n  Sender=EAccessViolation<br>\n  Exception=Access violation<br>\n  Stack trace:<br>\n  $0000000000423FD0<br>\n  $00000000007D8FE6  TRYGETVALUE,  line 601 of inc/generics.dictionaries.inc<br>\n  $00000000007DAB34  DESTROY,  line 946 of ../library/fsl/fsl_base.pas<br>\n  $00000000007DAE52  FREE,  line 1011 of ../library/fsl/fsl_base.pas<br>\n  $000000000087F350  DESTROY,  line 1631 of fsl_base.pas<br>\n  $00000000007DAE52  FREE,  line 1011 of ../library/fsl/fsl_base.pas<br>\n  $0000000000888C34  DESTROY,  line 1756 of ../library/fdb/fdb_manager.pas<br>\n  $00000000007DAE52  FREE,  line 1011 of ../library/fsl/fsl_base.pas<br>\n  $000000000088A958  CLOSEUPGMANAGERS,  line 2084 of ../library/fdb/fdb_manager.pas<br>\n  $000000000088D049  FDB_MANAGER_$$_finalize$,  line 2090 of ../library/fdb/fdb_manager.pas<br>\n  $0000000000439F47<br>\nException at 0000000000423FD0: EAccessViolation:<br>\nAccess violation.<br>\n[FORMS.PP] ExceptionOccurred <br>\n  Sender=EAccessViolation<br>\n  Exception=Access violation<br>\n  Stack trace:<br>\n  $0000000000423FD0<br>\n  $00000000007D8FE6  TRYGETVALUE,  line 601 of inc/generics.dictionaries.inc<br>\n  $00000000007DAB34  DESTROY,  line 946 of ../library/fsl/fsl_base.pas<br>\n  $00000000007DAE52  FREE,  line 1011 of ../library/fsl/fsl_base.pas<br>\n  $0000000000830F64  DESTROY,  line 223 of ../library/fsl/fsl_logging.pas<br>\n  $00000000007DAE52  FREE,  line 1011 of ../library/fsl/fsl_base.pas<br>\n  $0000000000832190  DESTROY,  line 476 of ../library/fsl/fsl_logging.pas<br>\n  $00000000007DAE52  FREE,  line 1011 of ../library/fsl/fsl_base.pas<br>\n  $0000000000833EA3  FSL_LOGGING_$$_finalize$,  line 763 of ../library/fsl/fsl_logging.pas<br>\n  $0000000000439F47<br>\n  $000000000088A958  CLOSEUPGMANAGERS,  line 2084 of ../library/fdb/fdb_manager.pas<br>\n  $000000000088D049  FDB_MANAGER_$$_finalize$,  line 2090 of ../library/fdb/fdb_manager.pas<br>\n  $0000000000439F47<br>\nException at 0000000000423FD0: EAccessViolation:<br>\nAccess violation.<br>\n[FORMS.PP] ExceptionOccurred <br>\n  Sender=EAccessViolation<br>\n  Exception=Access violation<br>\n  Stack trace:<br>\n  $0000000000423FD0<br>\n  $00000000007D8FE6  TRYGETVALUE,  line 601 of inc/generics.dictionaries.inc<br>\n  $00000000007DAB34  DESTROY,  line 946 of ../library/fsl/fsl_base.pas<br>\n  $00000000007DAE52  FREE,  line 1011 of ../library/fsl/fsl_base.pas<br>\n  $0000000000838100  DESTROY,  line 1631 of ../library/fsl/fsl_base.pas<br>\n  $00000000007DAE52  FREE,  line 1011 of ../library/fsl/fsl_base.pas<br>\n  $0000000000849307  DESTROY,  line 1211 of ../library/fsl/fsl_threads.pas<br>\n  $00000000007DAE52  FREE,  line 1011 of ../library/fsl/fsl_base.pas<br>\n  $0000000000844C15  DELETERANGE,  line 1905 of ../library/fsl/fsl_base.pas<br>\n  $0000000000842FCC  SETCOUNT,  line 1382 of ../library/fsl/fsl_base.pas<br>\n  $0000000000844FCA  CLEAR,  line 1911 of ../library/fsl/fsl_base.pas<br>\n  $0000000000843E83  DESTROY,  line 1629 of ../library/fsl/fsl_base.pas<br>\n  $00000000007DAE52  FREE,  line 1011 of ../library/fsl/fsl_base.pas<br>\n  $000000000084A8EA  DESTROY,  line 1441 of ../library/fsl/fsl_threads.pas<br>\n  $00000000007DAE52  FREE,  line 1011 of ../library/fsl/fsl_base.pas<br>\n  $0000000000846B4C  DONEUNIT,  line 684 of ../library/fsl/fsl_threads.pas<br>\n  $000000000084C6B9  FSL_THREADS_$$_finalize$,  line 1802 of ../library/fsl/fsl_threads.pas<br>\nException at 0000000000423FD0: EAccessViolation:<br>\nAccess violation.<br>\n[FORMS.PP] ExceptionOccurred <br>\n  Sender=EAccessViolation<br>\n  Exception=Access violation<br>\n  Stack trace:<br>\n  $000000000042DA88<br>\n  $00000000007D7662  DOGETCURRENT,  line 171 of inc/generics.dictionaries.inc<br>\n  $00000000007D9D71  ENDUNIT,  line 751 of ../library/fsl/fsl_base.pas<br>\n  $00000000007DF3C9  FSL_BASE_$$_finalize$,  line 3330 of ../library/fsl/fsl_base.pas<br>\n  $0000000000439F47<br>\n  $0000000000846B4C  DONEUNIT,  line 684 of ../library/fsl/fsl_threads.pas<br>\n  $000000000084C6B9  FSL_THREADS_$$_finalize$,  line 1802 of ../library/fsl/fsl_threads.pas<br>\n  $0000000000439F47<br>\n  $0000000000833EA3  FSL_LOGGING_$$_finalize$,  line 763 of ../library/fsl/fsl_logging.pas<br>\n  $0000000000439F47<br>\n  $000000000088A958  CLOSEUPGMANAGERS,  line 2084 of ../library/fdb/fdb_manager.pas<br>\n  $000000000088D049  FDB_MANAGER_$$_finalize$,  line 2090 of ../library/fdb/fdb_manager.pas<br>\n  $0000000000439F47<br>\nException at 000000000042DA88: EAccessViolation:<br>\nAccess violation.<br>\nrealloc(): invalid old size<br>\nAborted (core dumped)</p>\n</div></div>",
        "id": 256490136,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633556890
    },
    {
        "content": "<p>what parameters are you running the server with?</p>",
        "id": 256490379,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633557035
    },
    {
        "content": "<p><a href=\"https://github.com/jmandel/fhirserver/blob/patch-3/Dockerfile#L64\">https://github.com/jmandel/fhirserver/blob/patch-3/Dockerfile#L64</a></p>\n<div class=\"codehilite\"><pre><span></span><code>ENTRYPOINT [&quot;/bin/entrypoint.sh&quot;]\nCMD [&quot;-cmd&quot;,  &quot;exec&quot;,  &quot;-cfg&quot;, &quot;http://tx.fhir.org/config&quot;, &quot;-version&quot;,  &quot;4&quot;]\n</code></pre></div>",
        "id": 256490453,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633557082
    },
    {
        "content": "<p>This is equivalent to:</p>\n<div class=\"codehilite\"><pre><span></span><code>/work/fhirserver/exec/64/fhirserver -cmd exec -cfg http://tx.fhir.org/config -version 4\n</code></pre></div>",
        "id": 256490552,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633557128
    },
    {
        "content": "<p>(I think I just cribbed this from you.)</p>",
        "id": 256490572,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633557139
    },
    {
        "content": "<p>Actually, those outputs were from running by hand with no args.</p>",
        "id": 256490668,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633557202
    },
    {
        "content": "<p>(As documented in the individual spoilers.)</p>",
        "id": 256490689,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633557214
    },
    {
        "content": "<p>Here are some more, with the args you supplied:</p>",
        "id": 256490703,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633557220
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>[xcb] Most likely this is a multi-threaded client and XInitThreads has not been called\n</code></pre></div>\n\n<p>^ that's interesting</p>",
        "id": 256490777,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633557243
    },
    {
        "content": "<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<h1>/work/fhirserver/exec/64/fhirserver -cmd exec -cfg <a href=\"http://tx.fhir.org/config\">http://tx.fhir.org/config</a> -version 4</h1>\n<p>2021-10-06--------------------------------<br>\n21:53:47 00:00:00 FHIR Server 1.9.363 Linux-64/FreePascal +Assertions +Debug<br>\n21:53:47 00:00:00 /work/fhirserver/exec/64/fhirserver -cmd exec -cfg <a href=\"http://tx.fhir.org/config\">http://tx.fhir.org/config</a> -version 4<br>\n21:53:47 00:00:00 Loading Dependencies<br>\n[FORMS.PP] ExceptionOccurred <br>\n  Sender=EAccessViolation<br>\n  Exception=Access violation<br>\n  Stack trace:<br>\n  $0000000000435B73<br>\n[xcb] Unknown sequence number while appending request<br>\n[xcb] Most likely this is a multi-threaded client and XInitThreads has not been called<br>\n[xcb] Aborting, sorry about that.<br>\nfhirserver: ../../src/xcb_io.c:145: append_pending_request: Assertion `!xcb_xlib_unknown_seq_number' failed.<br>\nAborted (core dumped)</p>\n<h1>/work/fhirserver/exec/64/fhirserver -cmd exec -cfg <a href=\"http://tx.fhir.org/config\">http://tx.fhir.org/config</a> -version 4</h1>\n<p>2021-10-06--------------------------------<br>\n21:53:52 00:00:00 FHIR Server 1.9.363 Linux-64/FreePascal +Assertions +Debug<br>\n21:53:52 00:00:00 /work/fhirserver/exec/64/fhirserver -cmd exec -cfg <a href=\"http://tx.fhir.org/config\">http://tx.fhir.org/config</a> -version 4<br>\n21:53:52 00:00:00 Loading Dependencies<br>\n[FORMS.PP] ExceptionOccurred <br>\n  Sender=EAccessViolation<br>\n  Exception=Access violation<br>\n  Stack trace:<br>\n  $0000000000435B73<br>\nException at 0000000000435B73: EAccessViolation:<br>\nAccess violation.<br>\n[FORMS.PP] ExceptionOccurred <br>\n  Sender=EAccessViolation<br>\n  Exception=Access violation<br>\n  Stack trace:<br>\n  $0000000000ED369C<br>\n  $00000000007D8FE6  TRYGETVALUE,  line 601 of inc/generics.dictionaries.inc<br>\n  $00000000007DAB34  DESTROY,  line 946 of ../library/fsl/fsl_base.pas<br>\n  $00000000007DAE52  FREE,  line 1011 of ../library/fsl/fsl_base.pas<br>\n  $0000000000838100  DESTROY,  line 1631 of ../library/fsl/fsl_base.pas<br>\n  $00000000007DAE52  FREE,  line 1011 of ../library/fsl/fsl_base.pas<br>\n  $0000000000849314  DESTROY,  line 1212 of ../library/fsl/fsl_threads.pas<br>\n  $00000000007DAE52  FREE,  line 1011 of ../library/fsl/fsl_base.pas<br>\n  $0000000000844C15  DELETERANGE,  line 1905 of ../library/fsl/fsl_base.pas<br>\n  $0000000000842FCC  SETCOUNT,  line 1382 of ../library/fsl/fsl_base.pas<br>\n  $0000000000844FCA  CLEAR,  line 1911 of ../library/fsl/fsl_base.pas<br>\n  $0000000000843E83  DESTROY,  line 1629 of ../library/fsl/fsl_base.pas<br>\n  $00000000007DAE52  FREE,  line 1011 of ../library/fsl/fsl_base.pas<br>\n  $000000000084A8EA  DESTROY,  line 1441 of ../library/fsl/fsl_threads.pas<br>\n  $00000000007DAE52  FREE,  line 1011 of ../library/fsl/fsl_base.pas<br>\n  $0000000000846B4C  DONEUNIT,  line 684 of ../library/fsl/fsl_threads.pas<br>\n  $000000000084C6B9  FSL_THREADS_$$_finalize$,  line 1802 of ../library/fsl/fsl_threads.pas<br>\nException at 0000000000ED369C: EAccessViolation:<br>\nAccess violation.<br>\n[FORMS.PP] ExceptionOccurred <br>\n  Sender=EAccessViolation<br>\n  Exception=Access violation<br>\n  Stack trace:<br>\n  $00000000004356B8<br>\n  $00000000007DF3C9  FSL_BASE_$$_finalize$,  line 3330 of ../library/fsl/fsl_base.pas<br>\n  $0000000000439F47<br>\n  $0000000000846B4C  DONEUNIT,  line 684 of ../library/fsl/fsl_threads.pas<br>\n  $000000000084C6B9  FSL_THREADS_$$_finalize$,  line 1802 of ../library/fsl/fsl_threads.pas<br>\nException at 00000000004356B8: EAccessViolation:<br>\nAccess violation.<br>\nrealloc(): invalid old size<br>\nAborted (core dumped)</p>\n<h1>/work/fhirserver/exec/64/fhirserver -cmd exec -cfg <a href=\"http://tx.fhir.org/config\">http://tx.fhir.org/config</a> -version 4</h1>\n<p>2021-10-06--------------------------------<br>\n21:54:08 00:00:00 FHIR Server 1.9.363 Linux-64/FreePascal +Assertions +Debug<br>\n21:54:08 00:00:00 /work/fhirserver/exec/64/fhirserver -cmd exec -cfg <a href=\"http://tx.fhir.org/config\">http://tx.fhir.org/config</a> -version 4<br>\n21:54:08 00:00:00 Loading Dependencies<br>\n[FORMS.PP] ExceptionOccurred <br>\n  Sender=EAccessViolation<br>\n  Exception=Access violation<br>\n  Stack trace:<br>\n  $0000000000435B73<br>\nException at 0000000000435B73: EAccessViolation:<br>\nAccess violation.<br>\nrealloc(): invalid old size<br>\nAborted (core dumped)</p>\n<h1>/work/fhirserver/exec/64/fhirserver -cmd exec -cfg <a href=\"http://tx.fhir.org/config\">http://tx.fhir.org/config</a> -version 4</h1>\n<p>2021-10-06--------------------------------<br>\n21:54:11 00:00:00 FHIR Server 1.9.363 Linux-64/FreePascal +Assertions +Debug<br>\n21:54:11 00:00:00 /work/fhirserver/exec/64/fhirserver -cmd exec -cfg <a href=\"http://tx.fhir.org/config\">http://tx.fhir.org/config</a> -version 4<br>\n21:54:11 00:00:00 Loading Dependencies<br>\n[FORMS.PP] ExceptionOccurred <br>\n  Sender=EAccessViolation<br>\n  Exception=Access violation<br>\n  Stack trace:<br>\n  $0000000000435B73<br>\nException at 0000000000435B73: EAccessViolation:<br>\nAccess violation.<br>\n[FORMS.PP] ExceptionOccurred <br>\n  Sender=EAccessViolation<br>\n  Exception=Access violation<br>\n  Stack trace:<br>\n  $00000000004356B8<br>\nException at 00000000004356B8: EAccessViolation:<br>\nAccess violation.<br>\nrealloc(): invalid old size<br>\nAborted (core dumped)</p>\n<h1>/work/fhirserver/exec/64/fhirserver -cmd exec -cfg <a href=\"http://tx.fhir.org/config\">http://tx.fhir.org/config</a> -version 4</h1>\n<p>2021-10-06--------------------------------<br>\n21:54:16 00:00:00 FHIR Server 1.9.363 Linux-64/FreePascal +Assertions +Debug<br>\n21:54:16 00:00:00 /work/fhirserver/exec/64/fhirserver -cmd exec -cfg <a href=\"http://tx.fhir.org/config\">http://tx.fhir.org/config</a> -version 4<br>\n21:54:16 00:00:00 Loading Dependencies<br>\n[FORMS.PP] ExceptionOccurred <br>\n  Sender=EAccessViolation<br>\n  Exception=Access violation<br>\n  Stack trace:<br>\n  $0000000000435B73<br>\n[xcb] Unknown sequence number while appending request<br>\n[xcb] Most likely this is a multi-threaded client and XInitThreads has not been called<br>\n[xcb] Aborting, sorry about that.<br>\nfhirserver: ../../src/xcb_io.c:145: append_pending_request: Assertion `!xcb_xlib_unknown_seq_number' failed.<br>\nAborted (core dumped)</p>\n</div></div>",
        "id": 256490862,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633557290
    },
    {
        "content": "<p>I'm assuming fhirserver needs an GUI so I've created a framebuffer-backed X display for it to run against; if I don't give it this, I get </p>\n<div class=\"codehilite\"><pre><span></span><code>(fhirserver:155): Gtk-WARNING **: 21:55:29.347: cannot open display:\n</code></pre></div>",
        "id": 256491033,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633557382
    },
    {
        "content": "<p>it doesn't need a display as far as I'm concerned.</p>",
        "id": 256491153,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633557478
    },
    {
        "content": "<p>I don't understand any of this at all.</p>",
        "id": 256491213,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633557500
    },
    {
        "content": "<p>the parameters you're using are correct, and it runs fine for me without all this system craziness</p>",
        "id": 256491251,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633557526
    },
    {
        "content": "<p>why would it be different? it's a console application....</p>",
        "id": 256491264,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633557539
    },
    {
        "content": "<p>Hmm. I honestly don't know. When I look at the server binary I see a 417MB file with 243 of mentions of \"X11\" inside. What do you see?</p>\n<div class=\"codehilite\"><pre><span></span><code># du -h  /work/fhirserver/exec/64/fhirserver\n417M    /work/fhirserver/exec/64/fhirserver\n\n# strings /work/fhirserver/exec/64/fhirserver | grep -i x11 | wc -l\n243\n\n# strings /work/fhirserver/exec/64/fhirserver | grep -i x11 | head\nlibgdk-x11-2.0.so.0\ngdk_x11_get_default_xdisplay\ngdk_window_impl_x11_get_type\ngdk_x11_drawable_get_xdisplay\ngdk_x11_colormap_get_xdisplay\ngdk_x11_cursor_get_xdisplay\ngdk_x11_image_get_ximage\ngdk_x11_colormap_get_xcolormap\ngdk_x11_display_get_xdisplay\ngdk_x11_get_default_screen\n</code></pre></div>",
        "id": 256492165,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633557987
    },
    {
        "content": "<p>that'</p>",
        "id": 256492562,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633558213
    },
    {
        "content": "<p>that's why I asked you about parameters. because some parameters will lead to guis, but we're not interested in them</p>",
        "id": 256492607,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633558238
    },
    {
        "content": "<p>but all those are warnings...?</p>",
        "id": 256492683,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633558284
    },
    {
        "content": "<p>The spoilers I included above are the console output of the commands in big font. They don't look like warnings, but hard errors for the most part.</p>",
        "id": 256492899,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633558396
    },
    {
        "content": "<p>but you said the spoilers were running without parameters?</p>",
        "id": 256493127,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633558510
    },
    {
        "content": "<p>The first set, yes. And then I posted another one. Each one has the full command I ran at the top</p>",
        "id": 256493651,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633558783
    },
    {
        "content": "<p>I see the same command, different outcomes. so it's not predictable? or there's more going on?</p>",
        "id": 256494054,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633558956
    },
    {
        "content": "<p>well, I suspect that the problem is the openSSL dependency, but I added some more logging, so try again</p>",
        "id": 256494928,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633559407
    },
    {
        "content": "<p>I do see hints of that when I strace the execution -- it first looks for X11 libraries in a \"./tls\" directory.</p>",
        "id": 256495547,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633559799
    },
    {
        "content": "<p>nothing to do with me...</p>",
        "id": 256495749,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633559931
    },
    {
        "content": "<p>presumably this is because gui stuff is linked in.</p>",
        "id": 256495768,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633559946
    },
    {
        "content": "<p>anyway, let me know what the new log is</p>",
        "id": 256498872,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633561917
    },
    {
        "content": "<p>Still seeing all kinds of errors, nondeterministically.  e.g.</p>\n<div class=\"codehilite\"><pre><span></span><code>$ docker run --rm  -it   fhirterm\n2021-10-07--------------------------------\n00:21:18 00:00:00 FHIR Server 1.9.363 Linux-64/FreePascal +Assertions +Debug\n00:21:18 00:00:00 /work/fhirserver/exec/64/fhirserver -cmd exec -cfg http://tx.fhir.org/config -version 4\n00:21:18 00:00:00 Loading Dependencies\n00:21:18 00:00:00 SSL 1.1 from (default)\n00:21:18 00:00:00 Timezone Data\n[FORMS.PP] ExceptionOccurred\n  Sender=EAccessViolation\n  Exception=Access violation\n  Stack trace:\ncorrupted double-linked list\n</code></pre></div>\n<p>... and it still expects X to be there even when called with the CLI args you provided.</p>",
        "id": 256504946,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633566205
    },
    {
        "content": "<p>Maybe 5% of the time now it ... doesn't immediately crash, but does output</p>\n<div class=\"codehilite\"><pre><span></span><code>[FORMS.PP] ExceptionOccurred\n  Sender=EAccessViolation\n  Exception=Access violation\n  Stack trace:\n  $0000000000435B73\n</code></pre></div>",
        "id": 256505074,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633566303
    },
    {
        "content": "<p>and then... proceeds to use 100% of available CPU for... we'll see how long</p>",
        "id": 256505260,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633566434
    },
    {
        "content": "<p>weird. how would I investigate? Something really low level I'm taking for granted is not true</p>",
        "id": 256509206,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633569534
    },
    {
        "content": "<p><a href=\"https://forum.lazarus.freepascal.org/index.php/topic,56623.0.html\">https://forum.lazarus.freepascal.org/index.php/topic,56623.0.html</a></p>",
        "id": 256509517,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633569825
    },
    {
        "content": "<p>maybe I should try the binary you're compiling?</p>",
        "id": 256509884,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633570106
    },
    {
        "content": "<p>or vice versa</p>",
        "id": 256510347,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633570500
    },
    {
        "content": "<p>Huh. For sure you're welcome to try the thing I've compiled -- do you want it as part of the docker image, or just uploaded somewhere on its own?</p>",
        "id": 256510672,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633570793
    },
    {
        "content": "<p>I don't know the tool chain, so I don't really know what dependencies it has dynamically linked -- is it likely to be portable?</p>",
        "id": 256510743,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633570838
    },
    {
        "content": "<p>should be, if I understand. Just the binary</p>",
        "id": 256511610,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633571625
    },
    {
        "content": "<p><a href=\"https://cloudflare-ipfs.com/ipfs/QmZiEVubPt8aX6hbvNBQ7ebZ8sSzsqqAhUh5v6fqeYcM1U/fhirserver\">https://cloudflare-ipfs.com/ipfs/QmZiEVubPt8aX6hbvNBQ7ebZ8sSzsqqAhUh5v6fqeYcM1U/fhirserver</a></p>",
        "id": 256514031,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633573467
    },
    {
        "content": "<p>well, progress of a sort. Your binary bombs on my development PC exactly as you described.</p>",
        "id": 256517808,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633576968
    },
    {
        "content": "<p>so it's something to do with the compile, not the execution environment. I will investigate</p>",
        "id": 256517822,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633576991
    },
    {
        "content": "<p>is the docker image in the PR up to date?</p>",
        "id": 256517852,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633577038
    },
    {
        "content": "<p>Yes I'm keeping the docker file up to date. I will take it to use your build script today.</p>",
        "id": 256569782,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633610356
    },
    {
        "content": "<p>Looking now and will clean up the script you have -- but I'll note that this kind of monolithic script makes it very hard to cache layers -- like, with a typical Dockerfile when you run \"docker build\" the system is smart enough to use cached layers for any steps that have already completed. So, like, you'd want to avoid running the full fpclazup process every time you change a single line of source code in fhirserver. So I'll probably refactor these into \"build/linux-setup.sh\" that covers all the \"dependencies\" including dev tools and compiling dependent modules; and a \"build/linux-compile-fhirserver.sh\" or  somesuch.</p>",
        "id": 256600281,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633621518
    },
    {
        "content": "<p>When I compile <code>toolkit2/fhirtoolkit.lpr</code>I see:</p>\n<blockquote>\n<p>(9015) Linking /work/fhirserver/server/C:/work/fhirserver/Exec/64/fhirserver</p>\n</blockquote>\n<p>which I... don't expect to see (\"C:/\")</p>",
        "id": 256608270,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633624356
    },
    {
        "content": "<p>Similarly for:</p>\n<blockquote>\n<p>(9022) Compiling resource &gt;/work/fhirserver/server/lib/x86_64-linux/fhirserver.or<br>\n(9015) Linking &gt;/work/fhirserver/server/C:/work/fhirserver/Exec/64/fhirserver</p>\n</blockquote>",
        "id": 256613586,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633626310
    },
    {
        "content": "<p>... but this is good progress -- I still need an X server running even with the \"CLI\" mode, but the sever now runs and tries to download vocabularies, then eventually fails at</p>\n<div class=\"codehilite\"><pre><span></span><code>17:18:09 00:10:03 Zero Configuration Process failed: Unable to write the entire buffer: &#39;/root/fhir-server/sct_intl_20190731.cache&#39;\n17:18:09 00:10:03 First time, so can&#39;t continue.\nEIOException: Unable to write the entire buffer: &#39;/root/fhir-server/sct_intl_20190731.cache&#39;\n</code></pre></div>",
        "id": 256618380,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633628130
    },
    {
        "content": "<p>Grahame, can you clarify where <code>libChakraCore.so</code> needs to be in order for <code>$BUILD/tools/lazarus/lazbuild server/fhirserver.lpr</code> to succeed? (And is there any assumption about the current working directory when this command is executed?)</p>",
        "id": 256627639,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633631816
    },
    {
        "content": "<p>In the meantime, code at <a href=\"https://github.com/grahamegrieve/fhirserver/pull/128\">https://github.com/grahamegrieve/fhirserver/pull/128</a> is working (with a few documented workarounds in the PR) and I think it's ready to be merged</p>",
        "id": 256630219,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633632753
    },
    {
        "content": "<blockquote>\n<p>Linking /work/fhirserver/server/C:/work/fhirserver/Exec/64/fhirserver</p>\n</blockquote>\n<p>I forgot to includes the build mode</p>",
        "id": 256630289,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633632778
    },
    {
        "content": "<blockquote>\n<p>Unable to write the entire buffer</p>\n</blockquote>\n<p>ran out of space?</p>",
        "id": 256630367,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633632809
    },
    {
        "content": "<blockquote>\n<p>where <a href=\"http://libChakraCore.so\">libChakraCore.so</a> needs to be</p>\n</blockquote>\n<p>same directory, but probably needs the build mode to be right</p>",
        "id": 256630439,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633632834
    },
    {
        "content": "<p>I'm not running out of space.</p>",
        "id": 256631335,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633633160
    },
    {
        "content": "<p>\"same directory\" as what?</p>",
        "id": 256631349,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633633169
    },
    {
        "content": "<p>/exec/64</p>",
        "id": 256631723,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633633300
    },
    {
        "content": "<p>are you still getting the \"Unable to write the entire buffer\" or is it working?</p>",
        "id": 256631840,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633633332
    },
    {
        "content": "<p>Re: libChakraCore: you mean <code>exec/64</code> and not <code>server/C:/work/fhirserver/Exec/64/</code>, right? (the tzdat files need to be <em>there</em> which seems off).</p>",
        "id": 256631992,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633633410
    },
    {
        "content": "<p>Re: \"unable to write entire buffer\" this happened after several minutes/Gb of downloads</p>",
        "id": 256632025,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633633423
    },
    {
        "content": "<p>Not sure if it's what happens when there's a connectivity blip, or what.</p>",
        "id": 256632108,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633633444
    },
    {
        "content": "<blockquote>\n<p>not server/C:/work/fhirserver/Exec/64/</p>\n</blockquote>\n<p>I said that was because I forgot to include the build mode</p>",
        "id": 256632148,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633633461
    },
    {
        "content": "<p>OK -- let me know when I can revert this.</p>",
        "id": 256632205,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633633483
    },
    {
        "content": "<p>I'll push soon.</p>",
        "id": 256632249,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633633502
    },
    {
        "content": "<p>you didn't git pull in your script?</p>",
        "id": 256632270,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633633510
    },
    {
        "content": "<p>The script sets up the environment; it has by definition just cloned these repos.</p>",
        "id": 256632322,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633633530
    },
    {
        "content": "<p>May want a different script to do updates, if you're keeping the cloned folders alive over time.</p>",
        "id": 256632386,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633633555
    },
    {
        "content": "<p>modularity, right. That might not true for <a href=\"http://linux-fhirserver.sh\">linux-fhirserver.sh</a></p>",
        "id": 256632392,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633633557
    },
    {
        "content": "<p>If you're re-pulling dependencies you need to re-build them. So maybe there's a</p>\n<ul>\n<li>linux-setup</li>\n<li>linux-rebuild-dependenceis</li>\n<li>linux-fhirserver</li>\n</ul>",
        "id": 256632525,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633633603
    },
    {
        "content": "<p>(Refactored.)</p>",
        "id": 256637148,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633635340
    },
    {
        "content": "<p>Build is failing now at:</p>\n<div class=\"codehilite\"><pre><span></span><code>(10001) PPU Loading /work/fhirserver/packages/lib/x86_64-linux/v2_dictionary_database.ppu\n(10011) PPU Source: v2_dictionary_database.pas not found\n(10011) PPU Source: fhir.inc not available\n(10028) Recompiling v2_dictionary_database, checksum changed for /work/fhirserver/server/lib/linux/fdb_manager.ppu\n/work/fhirserver/library/v2/tests/v2_tests.pas(50,83) Fatal: (10022) Can&#39;t find unit v2_dictionary_database used by v2_tests\nFatal: (1018) Compilation aborted\n</code></pre></div>\n<p>I'm guessing this isn't my fault.</p>",
        "id": 256648851,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633640427
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>cp ./library/v2/v2_dictionary_database.pas library/v2/tests/\n</code></pre></div>\n\n<p>^^ this rescues it.</p>",
        "id": 256650035,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633640874
    },
    {
        "content": "<p>maybe but something really bad is going on three</p>",
        "id": 256652397,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633641774
    },
    {
        "content": "<p>you hacked it to make it worse later</p>",
        "id": 256652459,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633641807
    },
    {
        "content": "<p>but I can't tell what the actual problem is without more output</p>",
        "id": 256652699,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633641910
    },
    {
        "content": "<p>What output would you like?</p>",
        "id": 256656041,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633643688
    },
    {
        "content": "<p>I've set up a GH actions build, so logs should be at <a href=\"https://github.com/jmandel/fhirserver/runs/3832657077?check_suite_focus=true\">https://github.com/jmandel/fhirserver/runs/3832657077?check_suite_focus=true</a> (... I'm assuming it'll break the same way it does for me locally; will take &gt;10min to find out.)</p>",
        "id": 256657916,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633644607
    },
    {
        "content": "<p>how to trigger this?</p>",
        "id": 256659068,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633645250
    },
    {
        "content": "<p><a href=\"https://github.com/jmandel/fhirserver/runs/3832657077?check_suite_focus=true#step:3:22720\">https://github.com/jmandel/fhirserver/runs/3832657077?check_suite_focus=true#step:3:22720</a> is the error I'm getting, in the context of the full log</p>",
        "id": 256659240,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633645366
    },
    {
        "content": "<p>(Every push triggers this.)</p>",
        "id": 256659249,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633645372
    },
    {
        "content": "<p>(Every push to my fork, that is; if you merge my fork, you'll have the same behavior, which you may or may not care for.)</p>",
        "id": 256659276,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633645392
    },
    {
        "content": "<p>I do want a build process like this, yes</p>",
        "id": 256660292,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633646022
    },
    {
        "content": "<p>but I can't understand the error. It happens when the packages have overlapping search paths, and I can't find any</p>",
        "id": 256660353,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633646046
    },
    {
        "content": "<p>are you still cloning the source file? (What is the source for those builds. btw?)</p>",
        "id": 256660662,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633646246
    },
    {
        "content": "<p>No, as I said, introducing that <code>cp</code> *fixed` the build and it all seems to work swimmingly.</p>",
        "id": 256661344,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633646697
    },
    {
        "content": "<p>But I removed it to show you the errors.</p>",
        "id": 256661355,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633646706
    },
    {
        "content": "<p><a href=\"https://github.com/jmandel/fhirserver/blob/patch-3/Dockerfile\">https://github.com/jmandel/fhirserver/blob/patch-3/Dockerfile</a> is the source for the build</p>",
        "id": 256661396,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633646731
    },
    {
        "content": "<p>(and <a href=\"https://github.com/jmandel/fhirserver/blob/patch-3/.github/workflows/linux-docker-build.yml\">https://github.com/jmandel/fhirserver/blob/patch-3/.github/workflows/linux-docker-build.yml</a> kicks it off)</p>",
        "id": 256661492,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633646785
    },
    {
        "content": "<p>what's <a href=\"http://entrypoint.sh\">entrypoint.sh</a> about?</p>",
        "id": 256661507,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633646795
    },
    {
        "content": "<p><a href=\"http://entrypoint.sh\">entrypoint.sh</a> is the script that runs every time the container starts. It</p>\n<ul>\n<li>starts a headless X server</li>\n<li>\n<p>executes fhirserver with any CLI arguments passed in to the image, or  if none are passed, defaults to <br>\n     *[\"-cmd\",  \"exec\",  \"-cfg\", \"<a href=\"http://tx.fhir.org/config\">http://tx.fhir.org/config</a>\", \"-version\",  \"4\", \"-local\", \"$TERMINOLOGY_CACHE\"]</p>\n</li>\n<li>\n<p>Evaluates any CLI arguments as needed so, <code>$TERMINOLOGY_CACHE</code> can be an environment variable</p>\n</li>\n</ul>",
        "id": 256661622,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633646876
    },
    {
        "content": "<p>The idea here is that with <a href=\"http://entrypoint.sh\">entrypoint.sh</a> set up this way, someone can invoke the fhir server as:</p>\n<div class=\"codehilite\"><pre><span></span><code>docker run fhir/fhirserver -cmd exec -cfg https://some-other-cfg -version 5\n</code></pre></div>\n\n<p>or whatever other combination of args they want to pass in.</p>",
        "id": 256661797,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633646983
    },
    {
        "content": "<p>The <code>docker run fhir/fhirserver</code> bit will act a lot like just running the fhirsever binary (i.e., you can pass it the same args you'd pass the binary), but it takes care of setting up the environment first.</p>",
        "id": 256661888,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633647024
    },
    {
        "content": "<p>for the github pull action, we want to run tests not execute the server, of course. But we're not up to that yet</p>",
        "id": 256662150,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633647183
    },
    {
        "content": "<p>i don't understand line 7 of the dockerfile</p>",
        "id": 256662420,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633647314
    },
    {
        "content": "<blockquote>\n<p>COPY build/linux-toolchain.sh build/linux-update-dependencies.sh /work/bootstrap/</p>\n</blockquote>\n<p>The operating model here is that you're starting from a blank slate (fresh Ubuntu filesystem) each time you do a <code>docker build</code>. The only way files get into that filesystem is to copy them in, or to download them from within the build process. COPY takes files from the host directory and puts them into the image. </p>\n<p>Here, I copy just a couple of files into the image instead of copying the whole git repo, because of the way Docker builds are cached. Docker's smart enough to notice that the inputs (build/linux-toolchain.sh, build/linux-update-dependencies.sh) haven't changed, so it re-uses the \"layer\" it has created up through line 13, meaning I don't have to download and re-install the pascal compiler every time I change a single file in the FHIR server's source tree.</p>",
        "id": 256662818,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633647538
    },
    {
        "content": "<p>In line 13 I COPY in the full git repo, because... well, at this point I need to actually build the code.</p>",
        "id": 256662886,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633647577
    },
    {
        "content": "<p>line 7 you copy the two scripts... but you don't need to?</p>",
        "id": 256662984,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633647606
    },
    {
        "content": "<p>oh no I see.</p>",
        "id": 256663219,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633647712
    },
    {
        "content": "<p>my real question was, why did you copy them somewhere else. But I think the answer was 'just because' not 'I actually needed ot'</p>",
        "id": 256665371,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633649015
    },
    {
        "content": "<p>anyway, I can reproduce the problem.</p>",
        "id": 256665377,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633649021
    },
    {
        "content": "<blockquote>\n<p>my real question was, why did you copy them somewhere else</p>\n</blockquote>\n<p>You mean, to /work/bootstrap instead of to /work/fhirserver? I could have copied to /work/fhirserver/build, yes.</p>",
        "id": 256666205,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633649544
    },
    {
        "content": "<blockquote>\n<p>Grahame Grieve: anyway, I can reproduce the problem.</p>\n</blockquote>\n<p>Excellent</p>",
        "id": 256666215,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633649551
    },
    {
        "content": "<p>and I fixed them. I updated the scripts in the master repo - the build should work once you get them</p>",
        "id": 256667610,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633650572
    },
    {
        "content": "<p>Thanks -- grabbed.</p>",
        "id": 256669864,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633652093
    },
    {
        "content": "<p><a href=\"https://github.com/grahamegrieve/fhirserver/blob/master/build/linux-toolchain.sh#L26\">https://github.com/grahamegrieve/fhirserver/blob/master/build/linux-toolchain.sh#L26</a> Why did you add this back</p>",
        "id": 256671709,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633653453
    },
    {
        "content": "<p>oversight</p>",
        "id": 256672405,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633653998
    },
    {
        "content": "<p>Which change was the fix for the compile error I was hitting?</p>",
        "id": 256672574,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633654171
    },
    {
        "content": "<p>deleting the .ppu and .o files</p>",
        "id": 256672586,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633654184
    },
    {
        "content": "<p>thought that might not be necessary after my next push. I'll let you know</p>",
        "id": 256672622,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633654203
    },
    {
        "content": "<p>not necessary - I found the problem. weird how it turned up in the wrong place. Anyway, the build scripts work nicely for me now</p>",
        "id": 256678167,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633658922
    },
    {
        "content": "<p>there's going to be test cases.. and one of the thing the tests need is a big snomed file.</p>",
        "id": 256715744,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633687168
    },
    {
        "content": "<p>not sure how to deploy that - can't put it in git...</p>",
        "id": 256715764,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633687179
    },
    {
        "content": "<p>How often will these large files change? Do they need to be under version control (where the contents of the test file might need to change even though the file name remains static) or can they be represented with some kind of a content addressing scheme (where you would change the \"file open\" code in your test cases to specify a new file name when the vocabulary changes)?</p>",
        "id": 256763754,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633709596
    },
    {
        "content": "<p>Maybe <a href=\"https://docs.github.com/en/repositories/working-with-files/managing-large-files/about-large-files-on-github\">this</a> will help?</p>",
        "id": 256770680,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1633712391
    },
    {
        "content": "<p>If there's a need for version control, then yes -- but the GH implementation of git-lfs is not free, and I'm not sure we have the need. That's what my questions above are intended to elicit.</p>",
        "id": 256780498,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633716192
    },
    {
        "content": "<p>no need for version control. it hasn't changed for years. I'm going to put it on my website</p>",
        "id": 256782188,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633716912
    },
    {
        "content": "<p>Perfect. Put it on your website, the GH actions config can run <code>wget</code>it to make it locally available before the tests run, and we can use GH Actions caching to prevent re-fetches across runs.</p>",
        "id": 256782490,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633717036
    },
    {
        "content": "<p>the test cases need an configuration file with file locations and passwords / key pair locations + passphrases. how should we manage that?</p>",
        "id": 256783131,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633717301
    },
    {
        "content": "<p>They should be managed with GH Secrets and exposed to the container as environment variables.</p>",
        "id": 256783592,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633717487
    },
    {
        "content": "<p>The locations are set by the .sh files. can the .sh write them and the environment variables to a config file?</p>",
        "id": 256783698,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633717534
    },
    {
        "content": "<p>Not exactly. There's no secure storage area you can write to between invocations, so what happens instead is you can paste a config file (embedding whatever secrets, etc) into <a href=\"https://github.com/jmandel/fhirserver/settings/secrets/actions\">https://github.com/jmandel/fhirserver/settings/secrets/actions</a> and then have a step in the gh actions script that prints this to a file, so it's available.</p>",
        "id": 256785265,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633718116
    },
    {
        "content": "<p>(Or instead of a full config file as one secret, you can break this down into individual secrets that are managed separately.)</p>",
        "id": 256785316,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633718136
    },
    {
        "content": "<p>sorry, I asked slightly the wrong question. I should have asked:</p>\n<p>The locations are set by the parameters passed to the .sh files. can the GH Actions write them and the environment variables to a config file?</p>",
        "id": 256785747,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633718294
    },
    {
        "content": "<p>GH Actions lets you run arbitrary scripts. And lets you read secrets that have been configured from the web portal. I'm not really sure what kind of workflow you are describing, but if it can be expressed as a shell script that takes secrets as environment variables, and it can set up the whole environment required by the test scripts before running the test scripts, then it will work.</p>",
        "id": 256786433,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633718606
    },
    {
        "content": "<p>right. so what kind of config files can the shell scripts write to? A ini file? Because that's what currently happens - there's a file /work/fhirserver/exec/64/test-settings.ini that provides all the parameters:</p>\n<div class=\"codehilite\" data-code-language=\"INI\"><pre><span></span><code><span class=\"k\">[locations]</span>\n<span class=\"na\">fhirserver</span><span class=\"o\">=</span><span class=\"s\">c:\\work\\fhirserver</span>\n<span class=\"na\">fhir-test-cases</span><span class=\"o\">=</span><span class=\"s\">c:\\work\\org.hl7.fhir\\fhir-test-cases</span>\n<span class=\"na\">markdown</span><span class=\"o\">=</span><span class=\"s\">c:\\work\\pascal\\markdown</span>\n<span class=\"na\">snomed</span><span class=\"o\">=</span><span class=\"s\">C:\\work\\fhirserver\\testcases\\snomed\\snomed.cache</span>\n\n<span class=\"k\">[mssql]</span>\n<span class=\"na\">driver</span><span class=\"o\">=</span><span class=\"s\">SQL Server</span>\n<span class=\"na\">server</span><span class=\"o\">=</span><span class=\"s\">(local)</span>\n<span class=\"na\">database</span><span class=\"o\">=</span><span class=\"s\">test</span>\n\n<span class=\"k\">[mysql]</span>\n<span class=\"na\">driver</span><span class=\"o\">=</span><span class=\"s\">MySQL ODBC 8.0 Unicode Driver</span>\n<span class=\"na\">server</span><span class=\"o\">=</span><span class=\"s\">34.122.27.199</span>\n<span class=\"na\">database</span><span class=\"o\">=</span><span class=\"s\">test</span>\n<span class=\"na\">username</span><span class=\"o\">=</span><span class=\"s\">test</span>\n<span class=\"na\">password</span><span class=\"o\">=</span><span class=\"s\">XXX</span>\n\n<span class=\"k\">[email]</span>\n<span class=\"na\">sender</span><span class=\"o\">=</span><span class=\"s\">fhir-server@healthintersections.com.au</span>\n<span class=\"na\">password</span><span class=\"o\">=</span><span class=\"s\">XXXX</span>\n<span class=\"na\">destination</span><span class=\"o\">=</span><span class=\"s\">grahameg@gmail.com</span>\n\n<span class=\"k\">[ssl]</span>\n<span class=\"na\">cert</span><span class=\"o\">=</span><span class=\"s\">C:\\work\\RDPs\\certificates\\new\\fhir.org.crt</span>\n<span class=\"na\">key</span><span class=\"o\">=</span><span class=\"s\">C:\\work\\RDPs\\certificates\\new\\fhir.org.key</span>\n<span class=\"na\">cacert</span><span class=\"o\">=</span><span class=\"s\">C:\\work\\RDPs\\certificates\\new\\fhir.org.int.crt</span>\n<span class=\"na\">password</span><span class=\"o\">=</span><span class=\"s\">XXX</span>\n</code></pre></div>",
        "id": 256786888,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633718770
    },
    {
        "content": "<p>the source for the snomed file is at <a href=\"http://www.healthintersections.com.au/FhirServer/snomed.test.cache\">http://www.healthintersections.com.au/FhirServer/snomed.test.cache</a></p>",
        "id": 256788608,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633719479
    },
    {
        "content": "<p>So if you want to, you could take a version of exactly that config file (with all the details filled in) you listed here and throw it into a secret. Then we could just echo that secret into any file location you wanted right before running the tests.</p>",
        "id": 256790356,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633720179
    },
    {
        "content": "<p>It appears that the secret points to other files that are also secrets; so we would need to capture those as well, if I'm understanding the format correctly.</p>",
        "id": 256790456,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633720207
    },
    {
        "content": "<p>But there is no way that you want to load production server secrets like a TLS key for the <a href=\"http://fhir.org\">fhir.org</a> website as a prerequisite for running tests, right?</p>",
        "id": 256790538,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633720241
    },
    {
        "content": "<p>Similarly, I'm not sure why the tests would be connecting to an externally hosted MySQL database.</p>",
        "id": 256790635,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633720293
    },
    {
        "content": "<p>there's a test case for checking that all the database infrastructure for MySQL works.</p>",
        "id": 256790917,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633720422
    },
    {
        "content": "<p>it doesn't have to be external</p>",
        "id": 256790939,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633720433
    },
    {
        "content": "<p>same for mssql</p>",
        "id": 256791011,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633720456
    },
    {
        "content": "<p>and I wouldn't use the production key for <a href=\"http://fhir.org\">fhir.org</a> in the tests, but I did internally, since I have to have it anyway</p>",
        "id": 256791052,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633720476
    },
    {
        "content": "<p>we could check in a testing key and just have the passphrase as the secret</p>",
        "id": 256791107,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633720500
    },
    {
        "content": "<p>What are the things that actually need to be secret that the tests require to run?</p>",
        "id": 256791207,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633720550
    },
    {
        "content": "<p>the secrets:</p>\n<ul>\n<li>email password</li>\n<li>ssl passphrase</li>\n</ul>\n<p>local config:</p>\n<ul>\n<li>where the files are</li>\n<li>what the email addresses are</li>\n<li>what the database details are</li>\n</ul>",
        "id": 256792760,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633721235
    },
    {
        "content": "<p>For ssl, we could just generate a certificate each time the tests run, so this would not need to be a secret.</p>\n<p>For email, can you give me the quick rundown on where and how the test suite is interacting with email?</p>",
        "id": 256793234,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633721436
    },
    {
        "content": "<p>it sends a test email, to check that emailing works. It occasionally fails, when google introduces a new security requirement</p>",
        "id": 256793820,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633721709
    },
    {
        "content": "<p>Okay, so sounds that's the only true secret in the process.</p>",
        "id": 256802456,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633725553
    },
    {
        "content": "<p>right. the destination email address and sender email address are configured, but not secret</p>",
        "id": 256802990,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633725833
    },
    {
        "content": "<p>OK, so tests are  running at this point; you can see passing/failing/error output at <a href=\"https://github.com/jmandel/fhirserver/runs/3853245288?check_suite_focus=true#step:5:17890\">https://github.com/jmandel/fhirserver/runs/3853245288?check_suite_focus=true#step:5:17890</a> (I don't really understand the outputs but I expect you might, Grahame.)</p>\n<p>(To make this work, I added <a href=\"https://github.com/jmandel/fhirserver/blob/patch-3/fixtures/test-settings.ini.template\">https://github.com/jmandel/fhirserver/blob/patch-3/fixtures/test-settings.ini.template</a> and I fill out the template at runtime via <a href=\"https://github.com/jmandel/fhirserver/blob/patch-3/.github/workflows/linux-docker-build.yml#L33\">https://github.com/jmandel/fhirserver/blob/patch-3/.github/workflows/linux-docker-build.yml#L33</a>)</p>",
        "id": 256986250,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633901512
    },
    {
        "content": "<p>do the first think it is that it looks like the setting locations/fhirserver is missing or blank</p>\n<p>[locations]<br>\nfhirserver=</p>",
        "id": 256990638,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633905480
    },
    {
        "content": "<p>that's the home directory for the fhirserver repo itself</p>",
        "id": 256990683,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633905498
    },
    {
        "content": "<p>and also locations/snomed</p>",
        "id": 256990695,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633905529
    },
    {
        "content": "<blockquote>\n<p>do the first think it is that it looks like the setting locations/fhirserver is missing or blank</p>\n</blockquote>\n<p>So, this should be set to <code>/work/fhirserver</code>, per <a href=\"https://github.com/jmandel/fhirserver/blob/patch-3/.github/workflows/linux-docker-build.yml#L19\">https://github.com/jmandel/fhirserver/blob/patch-3/.github/workflows/linux-docker-build.yml#L19</a> -- is that the wrong value, or are you saying it's not <em>actually</em> getting set to that value?</p>",
        "id": 256991782,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633906730
    },
    {
        "content": "<p>it's not getting set to any value</p>",
        "id": 256991795,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633906747
    },
    {
        "content": "<p>there's no evidence I can see that anything in there is set</p>",
        "id": 256991812,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633906771
    },
    {
        "content": "<p>Hmm, I'll add some debug printouts.</p>",
        "id": 256991972,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633906880
    },
    {
        "content": "<p>When I run locally, what can I look for to determine if these settings are being picked up?</p>",
        "id": 256991977,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633906893
    },
    {
        "content": "<p>well, I just committed some a to print the locations explicitly</p>",
        "id": 256992313,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633907215
    },
    {
        "content": "<p>Awesome. I'll merge that.</p>",
        "id": 256992323,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633907228
    },
    {
        "content": "<p>On the plus side, I am getting</p>\n<p><a href=\"/user_uploads/10155/k1tkNYAqKsoewWOlhiMtByQ8/image.png\">image.png</a> </p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/k1tkNYAqKsoewWOlhiMtByQ8/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/k1tkNYAqKsoewWOlhiMtByQ8/image.png\"></a></div><p>(Though I'm not sure how to tell if that's coming from running the tests locally, or in GH actions.)</p>",
        "id": 256992420,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633907320
    },
    {
        "content": "<p>if you got that, then the email password bit is working for sure</p>",
        "id": 256992451,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633907372
    },
    {
        "content": "<p><a href=\"https://github.com/jmandel/fhirserver/runs/3853692645?check_suite_focus=true#step:5:55\">https://github.com/jmandel/fhirserver/runs/3853692645?check_suite_focus=true#step:5:55</a> your logs indicate the location is populated, I think?</p>",
        "id": 256995662,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633910881
    },
    {
        "content": "<p>certainly do.</p>",
        "id": 256996057,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633911262
    },
    {
        "content": "<p>so it's real weird. The file evidently existed, since it's read on line 50. But then it's not found on line 75</p>",
        "id": 256996078,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633911298
    },
    {
        "content": "<p>oh</p>",
        "id": 256996109,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633911328
    },
    {
        "content": "<p>apparently some of the tests assume that the current directory is the same as the directory that the executable is run from. There aren't supposed to be any, but there are</p>",
        "id": 256996180,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633911368
    },
    {
        "content": "<p>looks to me like the snomed location is wrong though</p>",
        "id": 256996693,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633911884
    },
    {
        "content": "<p>I fixed the tests that stood out and added more logging - try again</p>",
        "id": 256997232,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633912456
    },
    {
        "content": "<p>Cool -- <a href=\"https://github.com/jmandel/fhirserver/runs/3854355842?check_suite_focus=true#step:7:52\">https://github.com/jmandel/fhirserver/runs/3854355842?check_suite_focus=true#step:7:52</a> confirms that <code>snomed.test.cache</code> exists; more logs below.</p>",
        "id": 257003668,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633919444
    },
    {
        "content": "<p>I see the problem</p>",
        "id": 257003762,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633919531
    },
    {
        "content": "<p><code>snomed.test.cache</code> vs <code>snomed.cache</code></p>",
        "id": 257003765,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633919538
    },
    {
        "content": "<p>Fixing that now.</p>",
        "id": 257003805,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633919588
    },
    {
        "content": "<p>I added some more debugging if you could update- thanks</p>",
        "id": 257008076,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633924009
    },
    {
        "content": "<p><a href=\"https://github.com/jmandel/fhirserver/actions/runs/1327450135\">https://github.com/jmandel/fhirserver/actions/runs/1327450135</a> should have more in 15min or so</p>",
        "id": 257009461,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633925328
    },
    {
        "content": "<p>so the piece that's failing in one of the tests is</p>\n<div class=\"codehilite\" data-code-language=\"Delphi\"><pre><span></span><code> <span class=\"nb\">FileSetReadOnly</span><span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"o\">,</span> <span class=\"k\">true</span><span class=\"p\">)</span><span class=\"o\">;</span>\n  <span class=\"n\">FileDelete</span><span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">)</span><span class=\"o\">;</span>\n  <span class=\"n\">assertTrue</span><span class=\"p\">(</span><span class=\"nb\">FileExists</span><span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">)</span><span class=\"o\">,</span> <span class=\"s\">'FileExists(filename) #3'</span><span class=\"p\">)</span><span class=\"o\">;</span>\n</code></pre></div>",
        "id": 257012973,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633928624
    },
    {
        "content": "<p>FileSetReadyOnly is </p>\n<div class=\"codehilite\" data-code-language=\"Delphi\"><pre><span></span><code>  <span class=\"k\">if</span> <span class=\"n\">readOnly</span> <span class=\"k\">then</span>\n    <span class=\"n\">i</span> <span class=\"o\">:=</span> <span class=\"n\">fpchmod</span><span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"o\">,</span> <span class=\"n\">S_IRUSR</span> <span class=\"k\">or</span> <span class=\"n\">S_IRGRP</span> <span class=\"k\">or</span> <span class=\"n\">S_IROTH</span> <span class=\"k\">or</span> <span class=\"n\">S_IRUSR</span> <span class=\"k\">or</span> <span class=\"n\">S_IXGRP</span> <span class=\"k\">or</span> <span class=\"n\">S_IXOTH</span><span class=\"p\">)</span>\n  <span class=\"k\">else</span>\n    <span class=\"n\">i</span> <span class=\"o\">:=</span> <span class=\"n\">fpchmod</span><span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"o\">,</span> <span class=\"n\">S_IRWXU</span> <span class=\"k\">or</span> <span class=\"n\">S_IRWXG</span> <span class=\"k\">or</span> <span class=\"n\">S_IRWXO</span><span class=\"p\">)</span><span class=\"o\">;</span>\n</code></pre></div>",
        "id": 257013037,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633928658
    },
    {
        "content": "<p>so the readonly file can't be deleted on my linux box but can be on the CI build... wonder why it would be different?</p>",
        "id": 257013059,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633928689
    },
    {
        "content": "<p>I think I've fixed the TestFslDateTime test - relied on an implied timezone</p>",
        "id": 257019908,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633934736
    },
    {
        "content": "<p>testWebServer_110 [00.000] fail @?#?: CA SSL Certificate not found at /work/fhiserver/fixtures/rootCA.crt - looks like a set up thing?</p>",
        "id": 257019920,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633934752
    },
    {
        "content": "<p>the mysql test - can you add installing the mysql odbc driver?</p>",
        "id": 257020025,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633934840
    },
    {
        "content": "<p>the TestSQLite is confusing - is it possible that /tmp doesn't exist, or access is denied?</p>",
        "id": 257020053,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633934873
    },
    {
        "content": "<blockquote>\n<p>Grahame Grieve: so the readonly file can't be deleted on my linux box but can be on the CI build... wonder why it would be different?</p>\n</blockquote>\n<p>Are you writing unit tests for the OS (i.e., testing that the OS is providing the protection it claims to be)? Like, as a regular user if I own a file with <code>400</code> permissions, I can still delete it -- like</p>\n<div class=\"codehilite\"><pre><span></span><code>$ls -l ownj_deletej\n-r-------- 1 jmandel jmandel 0 Oct 11 08:40 ownj_deletej\n\n$ rm -f  ownj_deletej\n</code></pre></div>\n<p>If I leave out <code>-f</code> (\"force\"), I get a prompt like \"rm: remove write-protected regular empty file 'ownj_deletej'?\" -- and with <code>-f</code>, the file is deleted straightaway. So the fact that it's \"readonly\" doesn't mean that the owner can't delete it.</p>",
        "id": 257066342,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633959958
    },
    {
        "content": "<p>I'm not sure what your <code>FileDelete</code> is intended to do, but you may need \"softer\" behavior. Keep in mind that during the CI  process these tests are running in a docker container as root; that might explain the differences you're seeing, and making the server run as an unprivileged user would be nice for other reasons; we can start a separate thread on that once we've got the basics ironed out.</p>",
        "id": 257066575,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633960070
    },
    {
        "content": "<blockquote>\n<p>/work/fhiserver/fixtures/rootCA.crt </p>\n</blockquote>\n<p><a href=\"https://github.com/jmandel/fhirserver/tree/patch-3/fixtures\">https://github.com/jmandel/fhirserver/tree/patch-3/fixtures</a> should be mounted at <code>/work/fhirserver/fixtures</code> -- does your error message indicate the <em>file</em> isn't found, or just that there's something unexpected/wrong about the file?</p>",
        "id": 257066814,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633960168
    },
    {
        "content": "<p>Re: DB tests, I'm hesitate to dive in here because the configuration space is big and I don't know that I'll be able to see this all the way through. Do you have a complete step by step writeup detailing the components and setup required? <a href=\"https://github.com/grahamegrieve/fhirserver/blob/master/linux-install-instructions.txtdoesn't\">https://github.com/grahamegrieve/fhirserver/blob/master/linux-install-instructions.txtdoesn't</a> mention mysql</p>",
        "id": 257067185,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633960329
    },
    {
        "content": "<p>to rootCA file... it doesn't exist - or doesn't look like it does to the fhirserver</p>",
        "id": 257117793,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633987004
    },
    {
        "content": "<p>the root thing is probably the difference for the file test. I'm thinking about that.</p>",
        "id": 257117839,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633987035
    },
    {
        "content": "<p>I would very much like to get at least the mysql test working - it's a forerunner for a whole lot of tests I have yet to add into the linux version that will use a mysql store</p>",
        "id": 257117874,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633987071
    },
    {
        "content": "<blockquote>\n<p>Grahame Grieve: the root thing is probably the difference for the file test. I'm thinking about that.<br>\nto rootCA file... it doesn't exist - or doesn't look like it does to the fhirserver</p>\n</blockquote>\n<p>I'm not sure how this could happen; it's part of the repo that's copied into the container at build time. What makes you say it's absent?</p>",
        "id": 257118647,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633987554
    },
    {
        "content": "<blockquote>\n<p>Grahame Grieve: I would very much like to get at least the mysql test working - it's a forerunner for a whole lot of tests I have yet to add into the linux version that will use a mysql store</p>\n</blockquote>\n<p>OK. If you can document the setup process (starting from: host machine has a mysql server running but nothing set up) we can try to replicate this in CI.</p>",
        "id": 257118717,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633987585
    },
    {
        "content": "<p>working on the set up</p>",
        "id": 257118735,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633987598
    },
    {
        "content": "<blockquote>\n<p>All Tests [12:23.300] : 3176 ok, 7 errors, 3 failed</p>\n</blockquote>\n<p>That's pretty good though :-)</p>",
        "id": 257118753,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633987618
    },
    {
        "content": "<p>it is good.</p>",
        "id": 257118770,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633987633
    },
    {
        "content": "<p>assertTrue(FileExists(TestSettings.SSLCAFile), 'CA SSL Certificate not found at '+TestSettings.SSLCAFile);</p>",
        "id": 257118773,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633987635
    },
    {
        "content": "<p>Typo</p>",
        "id": 257118816,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633987676
    },
    {
        "content": "<p>That'd do the trick.</p>",
        "id": 257118820,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633987679
    },
    {
        "content": "<blockquote>\n<p>/work/fhiserver/fixtures/rootCA.crt</p>\n</blockquote>\n<p>I should put an <code>r</code> in FHIR. Can't forget the \"resoruces\".</p>",
        "id": 257118879,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1633987698
    },
    {
        "content": "<p>I make both those typos often too</p>",
        "id": 257118912,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1633987725
    },
    {
        "content": "<p>ok. mysql commands to set up a working test environment from vanilla set up:</p>",
        "id": 257183634,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634036285
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"SQL\"><pre><span></span><code><span class=\"k\">create</span> <span class=\"k\">user</span> <span class=\"s1\">'test'</span><span class=\"o\">@</span><span class=\"s1\">'%'</span> <span class=\"n\">identified</span> <span class=\"k\">by</span> <span class=\"s1\">'test'</span><span class=\"p\">;</span>\n<span class=\"k\">create</span> <span class=\"k\">database</span> <span class=\"n\">test</span><span class=\"p\">;</span>\n<span class=\"k\">GRANT</span> <span class=\"k\">ALL</span> <span class=\"k\">PRIVILEGES</span> <span class=\"k\">ON</span> <span class=\"n\">test</span><span class=\"p\">.</span><span class=\"o\">*</span> <span class=\"k\">TO</span> <span class=\"s1\">'test'</span><span class=\"o\">@</span><span class=\"s1\">'%'</span><span class=\"p\">;</span>\n<span class=\"n\">flush</span> <span class=\"k\">privileges</span><span class=\"p\">;</span>\n</code></pre></div>",
        "id": 257183661,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634036299
    },
    {
        "content": "<p>And how do we tell the test suite what host and port the DB is running on?</p>",
        "id": 257195575,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634042512
    },
    {
        "content": "<p>And what version of mysql?</p>",
        "id": 257195711,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634042560
    },
    {
        "content": "<p>I have MariaDB 10.4.20 working</p>",
        "id": 257209070,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634047825
    },
    {
        "content": "<p>mysql had some issues that I don't recall, sorry</p>",
        "id": 257209103,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634047839
    },
    {
        "content": "<p>I also remember having to add this to the configuration (my.ini): </p>\n<div class=\"codehilite\" data-code-language=\"INI\"><pre><span></span><code><span class=\"na\">query_cache_size</span> <span class=\"o\">=</span>  <span class=\"s\">64M</span>\n<span class=\"c1\">#query_cache_size =  0</span>\n<span class=\"na\">query_cache_min_res_unit</span> <span class=\"o\">=</span><span class=\"s\">2</span>\n<span class=\"na\">tmp_table_size</span> <span class=\"o\">=</span> <span class=\"s\">128M</span>\n<span class=\"na\">max_heap_table_size</span> <span class=\"o\">=</span> <span class=\"s\">128M</span>\n<span class=\"c1\">#skip-name-resolve</span>\n<span class=\"na\">innodb_file_per_table</span> <span class=\"o\">=</span> <span class=\"s\">1</span>\n<span class=\"na\">innodb_buffer_pool_size</span> <span class=\"o\">=</span> <span class=\"s\">1280M</span>\n<span class=\"na\">lower_case_table_names</span> <span class=\"o\">=</span> <span class=\"s\">1</span>\n<span class=\"na\">max_binlog_size</span>         <span class=\"o\">=</span> <span class=\"s\">100M</span>\n<span class=\"na\">expire_logs_days</span><span class=\"o\">=</span><span class=\"s\">2</span>\n<span class=\"na\">innodb_ft_min_token_size</span><span class=\"o\">=</span><span class=\"s\">1</span>\n<span class=\"na\">ft_min_word_len</span><span class=\"o\">=</span><span class=\"s\">2</span>\n<span class=\"na\">autocommit</span><span class=\"o\">=</span><span class=\"s\">1</span>\n<span class=\"na\">connect_timeout</span><span class=\"o\">=</span><span class=\"s\">240</span>\n<span class=\"na\">long_query_time</span><span class=\"o\">=</span><span class=\"s\">180</span>\n<span class=\"na\">transaction-isolation</span> <span class=\"o\">=</span> <span class=\"s\">READ-COMMITTED</span>\n<span class=\"na\">character-set-server</span> <span class=\"o\">=</span> <span class=\"s\">utf8</span>\n<span class=\"na\">collation-server</span> <span class=\"o\">=</span> <span class=\"s\">utf8_general_ci</span>\n<span class=\"na\">innodb_flush_method</span><span class=\"o\">=</span><span class=\"s\">O_DIRECT</span>\n<span class=\"na\">optimizer_switch</span><span class=\"o\">=</span><span class=\"s\">orderby_uses_equalities=off</span>\n<span class=\"na\">max_allowed_packet</span><span class=\"o\">=</span><span class=\"s\">128M</span>\n</code></pre></div>",
        "id": 257209344,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634047929
    },
    {
        "content": "<p>my DB init commands are the same as Grahame writes, except I added utf8 explicitly<br>\n<code>CREATE DATABASE fhirDB CHARACTER SET utf8 COLLATE utf8_unicode_ci;</code></p>",
        "id": 257209718,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634048057
    },
    {
        "content": "<p>(Don't know if this helps. I'm trying to catch up, let me know if I can do something - maybe I can take mysql setup because I've done it once)</p>",
        "id": 257209778,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634048094
    },
    {
        "content": "<p>Wow. This is a lot of config just to support running tests.</p>",
        "id": 257210317,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634048292
    },
    {
        "content": "<p>sorry, not for tests, that was for the prod-like server</p>",
        "id": 257216287,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634050448
    },
    {
        "content": "<p>(i missed the context)</p>",
        "id": 257216311,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634050460
    },
    {
        "content": "<p>I think there's a MySQL server in place now (mysql8, host: \"mysql\", as communicated via .ini param at <a href=\"https://github.com/jmandel/fhirserver/blob/patch-3/fixtures/test-settings.ini.template#L14\">https://github.com/jmandel/fhirserver/blob/patch-3/fixtures/test-settings.ini.template#L14</a>); I'm still seeing errors from <a href=\"https://github.com/jmandel/fhirserver/runs/3871257411?check_suite_focus=true#step:10:56\">https://github.com/jmandel/fhirserver/runs/3871257411?check_suite_focus=true#step:10:56</a></p>",
        "id": 257217766,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634050981
    },
    {
        "content": "<p>OK then I'll test the proper config and do the same thing as I did before - check if the text indexing is working , etc. If it's mysql, then we use that</p>",
        "id": 257220849,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634052185
    },
    {
        "content": "<p>port defaults to normal. I haven't got a config for that.</p>",
        "id": 257248573,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634062774
    },
    {
        "content": "<p>host = server</p>",
        "id": 257248582,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634062777
    },
    {
        "content": "<p>version doesn't matter for the tests</p>",
        "id": 257248614,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634062792
    },
    {
        "content": "<p>you also have to install the MySQL odbc driver - which I believe is:</p>\n<div class=\"codehilite\"><pre><span></span><code>wget https://dev.mysql.com/get/Downloads/Connector-ODBC/8.0/mysql-connector-odbc_8.0.26-1ubuntu20.04_amd64.deb\ndpkg -i mysql-connector-odbc_8.0.26–1ubuntu20.04_amd64.deb\n</code></pre></div>",
        "id": 257249473,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634063123
    },
    {
        "content": "<p>also can you update from the master - I have some changes to the code.</p>",
        "id": 257251024,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634063796
    },
    {
        "content": "<blockquote>\n<p>host = server</p>\n</blockquote>\n<p>I don't know what this means.</p>",
        "id": 257267739,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634070819
    },
    {
        "content": "<blockquote>\n<p>Grahame Grieve: also can you update from the master - I have some changes to the code.</p>\n</blockquote>\n<p>Done.</p>",
        "id": 257268032,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634070928
    },
    {
        "content": "<p>Re: that mysql connector, somehow their ubuntu release has like hundreds of  megs of dependencies. What even is this?</p>",
        "id": 257276608,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634075033
    },
    {
        "content": "<p>it's the ODBC driver for mysql for linux?</p>",
        "id": 257280862,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634077280
    },
    {
        "content": "<blockquote>\n<p>host = server</p>\n</blockquote>\n<p>you asked, how do you specify the host. That's the server setting in the test-settings.ini... or do I mis-understand?</p>",
        "id": 257280974,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634077328
    },
    {
        "content": "<p>Oh, yeah I guess I already populated the host value then.</p>",
        "id": 257281520,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634077620
    },
    {
        "content": "<p>Re; ODBC driver, that doesn't install for me because one of the dependencies is no longer available. The whole distribution process for that driver seems super sketchy and weird, like bad printer drivers.</p>",
        "id": 257281655,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634077705
    },
    {
        "content": "<p>totally agree. it's not a good thing</p>",
        "id": 257282552,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634078274
    },
    {
        "content": "<p>but it does work for me. what dependency is no longer available?</p>",
        "id": 257283413,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634078855
    },
    {
        "content": "<p>I'm not at the computer anymore, but something like mysql-community-blah</p>",
        "id": 257284175,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634079288
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> some follow up quetsions on all this. First of all, thanks for doing all this - I appreciate it greatly.</p>\n<ul>\n<li>what's Dockerfile.slimmed? </li>\n<li>we still don't have the tests running? </li>\n<li>how does the build work if it executes a process that doesn't finish?</li>\n</ul>",
        "id": 257422877,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634153123
    },
    {
        "content": "<blockquote>\n<p>what's Dockerfile.slimmed?</p>\n</blockquote>\n<p>Right now the Docker image you get if you run <code>docker build -f Dockerfile</code> includes the whole fpc toolchain, source code, dev packages, etc. The <code>slimmed</code> package just takes a raw ubuntu image and copies in the <em>compiled</em> output from the build process. If someone wanted a simple way to distribute/run the fhirserver using a Docker registry (i.e., so anyone in the world could just <code>docker run hl7fhir:fhirserver</code> and have it up and running), something like this slimmed image would be the right starting point.</p>",
        "id": 257424629,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634153846
    },
    {
        "content": "<blockquote>\n<p>we still don't have the tests running?</p>\n</blockquote>\n<p>Tests are <em>running</em>, so I assume your question is why they're not <em>passing</em>. Current blocker: I don't have a way to install the mysql dependency you said is necessary.</p>",
        "id": 257424827,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634153918
    },
    {
        "content": "<blockquote>\n<p>how does the build work if it executes a process that doesn't finish?</p>\n</blockquote>\n<p>Right now, it'll just run until the GH Actions timeout hits (360 min by default; we could set this lower with a param in the GH Actions job).</p>",
        "id": 257425029,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634154009
    },
    {
        "content": "<blockquote>\n<p>First of all, thanks for doing all this - I appreciate it greatly.</p>\n</blockquote>\n<p>You're welcome. It has been a learning experience!</p>",
        "id": 257425059,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634154023
    },
    {
        "content": "<p>I'm thinking it may be easier to install the binary release for mysql odbc rather than the borked ubuntu packages.</p>",
        "id": 257427125,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634154893
    },
    {
        "content": "<p>yes indeed, the binary release is what I've been installing</p>",
        "id": 257427173,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634154912
    },
    {
        "content": "<p>how are the tests running? the docker ends with :<br>\n<code>CMD [\"-cmd\",  \"exec\",  \"-cfg\", \"http://tx.fhir.org/config\", \"-version\",  \"4\", \"-local\", \"$TERMINOLOGY_CACHE\"]</code></p>",
        "id": 257427254,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634154938
    },
    {
        "content": "<ul>\n<li>but you pointed me to the ubuntu packes at <a href=\"https://dev.mysql.com/get/Downloads/Connector-ODBC/8.0/mysql-connector-odbc_8.0.26-1ubuntu20.04_amd64.deb\">https://dev.mysql.com/get/Downloads/Connector-ODBC/8.0/mysql-connector-odbc_8.0.26-1ubuntu20.04_amd64.deb</a> rather than the generic release tarball at <a href=\"https://dev.mysql.com/get/Downloads/Connector-ODBC/8.0/mysql-connector-odbc-8.0.26-linux-glibc2.12-x86-64bit.tar.gz\">https://dev.mysql.com/get/Downloads/Connector-ODBC/8.0/mysql-connector-odbc-8.0.26-linux-glibc2.12-x86-64bit.tar.gz</a> :-)</li>\n</ul>",
        "id": 257427444,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634155012
    },
    {
        "content": "<p>did I? I'm very sorry if I did that</p>",
        "id": 257427480,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634155028
    },
    {
        "content": "<p>The <code>CMD</code> line defines the default args that will be passed in when the container starts, if no other CLI args are passed</p>",
        "id": 257427537,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634155051
    },
    {
        "content": "<p>hmm what overrides that?</p>",
        "id": 257427571,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634155070
    },
    {
        "content": "<p>But we run the container in the test script at <a href=\"https://github.com/jmandel/fhirserver/blob/109745215693e144ee645bc3f1a4d3c2db3310f5/.github/workflows/linux-docker-build.yml#L70\">https://github.com/jmandel/fhirserver/blob/109745215693e144ee645bc3f1a4d3c2db3310f5/.github/workflows/linux-docker-build.yml#L70</a></p>",
        "id": 257427584,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634155077
    },
    {
        "content": "<p>Where we call it with:</p>\n<div class=\"codehilite\"><pre><span></span><code>-tests\n</code></pre></div>",
        "id": 257427655,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634155091
    },
    {
        "content": "<p>At <a href=\"#narrow/stream/179281-pascal/topic/Automating.20fhirserver.20build/near/257249473\">https://chat.fhir.org/#narrow/stream/179281-pascal/topic/Automating.20fhirserver.20build/near/257249473</a> you did -- but you wrote \"I believe\" and not \"I promise\" ;-)</p>",
        "id": 257427757,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634155142
    },
    {
        "content": "<p>We'll see how the tests at <a href=\"https://github.com/jmandel/fhirserver/runs/3887155777?check_suite_focus=true\">https://github.com/jmandel/fhirserver/runs/3887155777?check_suite_focus=true</a> do -- mysql-odbc is now being installed without errors.</p>",
        "id": 257427861,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634155184
    },
    {
        "content": "<p>(Well, almost being installed without errors. Tweaking...)</p>",
        "id": 257429194,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634155651
    },
    {
        "content": "<p>where do I find all the apt -install stuff?</p>",
        "id": 257431083,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634156363
    },
    {
        "content": "<p>I don't understand the question.</p>\n<p>BTW I just committed <a href=\"https://github.com/jmandel/fhirserver/commit/99b42f04a4db898ebf45b611f060718eedf3be7a\">https://github.com/jmandel/fhirserver/commit/99b42f04a4db898ebf45b611f060718eedf3be7a</a> because some of these lpk files don't exist (but previously this wasn't causing errors; not sure why.)</p>",
        "id": 257431810,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634156664
    },
    {
        "content": "<p>oh. I was getting to that</p>",
        "id": 257435331,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634158172
    },
    {
        "content": "<p>no I had fixed it - you want what is in my repo</p>",
        "id": 257435947,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634158421
    },
    {
        "content": "<blockquote>\n<p>where do I find all the apt -install stuff?</p>\n</blockquote>\n<p>we need to install git, mysql, wget, unixodbc etc. Where does this happen in the set up?</p>",
        "id": 257436649,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634158684
    },
    {
        "content": "<blockquote>\n<p>we need to install git, mysql, wget, unixodbc etc. Where does this happen in the set up?</p>\n</blockquote>\n<p><a href=\"https://github.com/jmandel/fhirserver/blob/patch-3/Dockerfile#L5-L12\">https://github.com/jmandel/fhirserver/blob/patch-3/Dockerfile#L5-L12</a></p>\n<p>(Note that mysql itself isn't installed in the docker image; it's a service we're running in a sibling docker container accessible over the network as host <code>mysql</code>, created <a href=\"https://github.com/jmandel/fhirserver/blob/patch-3/.github/workflows/linux-docker-build.yml#L17-L24\">here</a>.)</p>",
        "id": 257439709,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634159935
    },
    {
        "content": "<p>Still seeing errors at <a href=\"https://github.com/jmandel/fhirserver/runs/3887632649?check_suite_focus=true#step:10:67\">https://github.com/jmandel/fhirserver/runs/3887632649?check_suite_focus=true#step:10:67</a> even after installing libs/bins from <a href=\"https://dev.mysql.com/get/Downloads/Connector-ODBC/8.0/mysql-connector-odbc-8.0.26-linux-glibc2.12-x86-64bit.tar.gz\">https://dev.mysql.com/get/Downloads/Connector-ODBC/8.0/mysql-connector-odbc-8.0.26-linux-glibc2.12-x86-64bit.tar.gz</a></p>",
        "id": 257440318,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634160151
    },
    {
        "content": "<p>I don't know what the error means.</p>",
        "id": 257441152,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634160491
    },
    {
        "content": "<p>can we get a list of the odbc drivers installed after the mysql driver is installed? It might be that the driver name is slightly different?</p>",
        "id": 257441289,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634160548
    },
    {
        "content": "<blockquote>\n<p>Grahame Grieve: can we get a list of the odbc drivers installed after the mysql driver is installed? It might be that the driver name is slightly different?</p>\n</blockquote>\n<p>I have no idea. How do you get a list of ODBC drivers, and how do you tell ODBC drivers from every other library present on the system?</p>",
        "id": 257441405,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634160599
    },
    {
        "content": "<p>I can get you the library name..</p>",
        "id": 257441522,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634160628
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>mysql-connector-odbc-8.0.26-linux-glibc2.12-x86-64bit/lib/libmyodbc8w.so\nmysql-connector-odbc-8.0.26-linux-glibc2.12-x86-64bit/lib/libmyodbc8a.so\n</code></pre></div>\n<p>these are copied into <code>/usr/local/lib</code></p>",
        "id": 257441630,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634160673
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> what do you think of this?</p>",
        "id": 257476403,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634184245
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"nb\">echo</span> <span class=\"s2\">\"## ODBC info\"</span>\n\nodbcinst -j\n\n<span class=\"nb\">echo</span> <span class=\"s2\">\"</span><span class=\"k\">$(</span>&lt;/etc/odbcinst.ini<span class=\"k\">)</span><span class=\"s2\">\"</span>\n</code></pre></div>",
        "id": 257476436,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634184263
    },
    {
        "content": "<p>output:</p>\n<div class=\"codehilite\"><pre><span></span><code>#14 0.054 ## ODBC info\n#14 0.056 unixODBC 2.3.6\n#14 0.056 DRIVERS............: /etc/odbcinst.ini\n#14 0.056 SYSTEM DATA SOURCES: /etc/odbc.ini\n#14 0.056 FILE DATA SOURCES..: /etc/ODBCDataSources\n#14 0.056 USER DATA SOURCES..: /root/.odbc.ini\n#14 0.056 SQLULEN Size.......: 8\n#14 0.056 SQLLEN Size........: 8\n#14 0.056 SQLSETPOSIROW Size.: 8\n#14 0.056 /work/fhirserver/build/linux-fhirserver.sh: line 7: /etc/odbcinst.ini: No such file or directory\n</code></pre></div>",
        "id": 257476446,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634184280
    },
    {
        "content": "<p>where in the chain does mysql get set up?</p>",
        "id": 257476498,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634184357
    },
    {
        "content": "<p>I don't know exactly what you are asking. I copy the library files in the first step of the docker file. But I don't do anything that would generate /etc/odbcinst.ini. what is this file and who is responsible for creating it? What should it contain and how should it come to contain that? </p>\n<p>I think this is clear, but the doker image does not include any MySQL server components. It only contains the client components that you have pointed me to.</p>",
        "id": 257538540,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634219562
    },
    {
        "content": "<p>Okay I have one lead anyway.</p>",
        "id": 257538899,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634219675
    },
    {
        "content": "<p><a href=\"https://dev.mysql.com/doc/connector-odbc/en/connector-odbc-installation-binary-unix-tarball.html\">https://dev.mysql.com/doc/connector-odbc/en/connector-odbc-installation-binary-unix-tarball.html</a> contains steps three and four which perhaps I should consider following in addition to steps 1 and 2</p>",
        "id": 257538983,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634219711
    },
    {
        "content": "<p>OK, now there should be something like the following present in the docker environment:</p>\n<div class=\"codehilite\"><pre><span></span><code>$ cat /etc/odbcinst.ini\n[MySQL ODBC 8.0 Driver]\nDriver=/usr/local/lib/libmyodbc8w.so\nUsageCount=1\n\n[MySQL ODBC 8.0]\nDriver=/usr/local/lib/libmyodbc8a.so\nUsageCount=1\n</code></pre></div>",
        "id": 257558929,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634226924
    },
    {
        "content": "<p>Indeed your <a href=\"https://github.com/jmandel/fhirserver/runs/3896487331?check_suite_focus=true#step:7:11166\">logs show</a>:</p>\n<div class=\"codehilite\"><pre><span></span><code>#14 [ 9/10] RUN /work/fhirserver/build/linux-fhirserver.sh /work/bootstrap\n#14 0.083 ## ODBC info\n#14 0.085 unixODBC 2.3.6\n#14 0.085 DRIVERS............: /etc/odbcinst.ini\n#14 0.085 SYSTEM DATA SOURCES: /etc/odbc.ini\n#14 0.085 FILE DATA SOURCES..: /etc/ODBCDataSources\n#14 0.085 USER DATA SOURCES..: /root/.odbc.ini\n#14 0.085 SQLULEN Size.......: 8\n#14 0.085 SQLLEN Size........: 8\n#14 0.085 SQLSETPOSIROW Size.: 8\n#14 0.087 [MySQL ODBC 8.0 Driver]\n#14 0.087 Driver=/usr/local/lib/libmyodbc8w.so\n#14 0.087 UsageCount=1\n#14 0.087\n#14 0.087 [MySQL ODBC 8.0]\n#14 0.087 Driver=/usr/local/lib/libmyodbc8a.so\n#14 0.087 UsageCount=1\n</code></pre></div>",
        "id": 257559205,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634227029
    },
    {
        "content": "<p>great thanks</p>",
        "id": 257589756,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634239039
    },
    {
        "content": "<p>Progress! <a href=\"https://github.com/jmandel/fhirserver/runs/3899833569?check_suite_focus=true#step:10:53\">https://github.com/jmandel/fhirserver/runs/3899833569?check_suite_focus=true#step:10:53</a> makes it look like some database tests are actually running (and failing, but hey) !</p>",
        "id": 257612295,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634248596
    },
    {
        "content": "<p>well, they all pass now, except for MSSQL which is being ignored, but wrongly counted as an error in the wash up. So I have to sort out that, and get to the bottom of the timezone issue causing another failure. And then there's smtp password issue - can we get to that?</p>",
        "id": 257613504,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634249179
    },
    {
        "content": "<p>SMTP password should be covered. In my fork I'm using a gmail account that I registered for this purpose; we can configure it however you like in your repository.</p>",
        "id": 257614118,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634249486
    },
    {
        "content": "<p>\"Must provide password for SMTP test in /work/fhirserver/exec/64/test-settings.ini\"</p>",
        "id": 257614467,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634249654
    },
    {
        "content": "<p>FHIRSERVER_EMAIL_PASSWORD is blank then</p>",
        "id": 257614485,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634249665
    },
    {
        "content": "<p>Hmm, I may be messing that up. Will review.</p>",
        "id": 257624588,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634255426
    },
    {
        "content": "<p><a href=\"/user_uploads/10155/6FboOUUgH5R75uD_-Utd3djp/image.png\">image.png</a> <br>\n<a href=\"https://github.com/jmandel/fhirserver/runs/3901846542?check_suite_focus=true\">https://github.com/jmandel/fhirserver/runs/3901846542?check_suite_focus=true</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/6FboOUUgH5R75uD_-Utd3djp/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/6FboOUUgH5R75uD_-Utd3djp/image.png\"></a></div>",
        "id": 257640320,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634268309
    },
    {
        "content": "<p>And I don't know why you say the email password is blank; I'm getting:</p>\n<p><a href=\"/user_uploads/10155/CN61Gr-6_ScmiCT0xqmvqU9q/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/CN61Gr-6_ScmiCT0xqmvqU9q/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/CN61Gr-6_ScmiCT0xqmvqU9q/image.png\"></a></div>",
        "id": 257640452,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634268418
    },
    {
        "content": "<p>I merged this into your master branch now <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> . You can:</p>\n<ol>\n<li>Update <a href=\"https://github.com/grahamegrieve/fhirserver/blob/master/.github/workflows/linux-docker-build.yml#L49\">https://github.com/grahamegrieve/fhirserver/blob/master/.github/workflows/linux-docker-build.yml#L49</a> to set <code>FHIRSERVER_EMAIL_SENDER</code> with the gmail account you like</li>\n<li>Use <a href=\"https://github.com/grahamegrieve/fhirserver/settings/secrets/actions\">https://github.com/grahamegrieve/fhirserver/settings/secrets/actions</a> to add a Repository Secret called <code>FHIRSERVER_EMAIL_PASSWORD</code> with the value of your choice, like:</li>\n</ol>\n<p><a href=\"/user_uploads/10155/QZMQDBNfkSvzrJr1yMXPoicE/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/QZMQDBNfkSvzrJr1yMXPoicE/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/QZMQDBNfkSvzrJr1yMXPoicE/image.png\"></a></div>",
        "id": 257640705,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634268640
    },
    {
        "content": "<p>(I can't do this for you without admin access on the repo.)</p>",
        "id": 257640715,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634268655
    },
    {
        "content": "<p>done. Hopefully, that'll mean all tests pass</p>",
        "id": 257641016,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634268948
    },
    {
        "content": "<p>yay they did! awesome</p>",
        "id": 257643780,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634271489
    },
    {
        "content": "<p>one last question... reading about how to release the linux server turns into a typical linux experience - a myriad of ways to do it, most of them probably wrong, and I don't know which. I particularly liked this line in the ubuntu package documentation:</p>\n<blockquote>\n<p>Setting pbuilder up is very easy, run:<br>\n<code>$ pbuilder-dist &lt;release&gt; create</code><br>\nwhere &lt;release&gt; is for example xenial, zesty, artful or in the case of Debian maybe sid or buster.</p>\n</blockquote>\n<p>whatever \"xenial, zesty, artful or in the case of Debian maybe sid or buster\" might be. No hint as to what they are or why you'd chose one over the other, or maybe you have to do them all. So typical... (or even why 'in the case of debian' since this is a ubuntu guide)</p>",
        "id": 257770088,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634334538
    },
    {
        "content": "<p>They are Ubuntu release codenames</p>",
        "id": 257773134,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634336020
    },
    {
        "content": "<p><a href=\"https://wiki.ubuntu.com/Releases\">https://wiki.ubuntu.com/Releases</a></p>",
        "id": 257773295,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634336082
    },
    {
        "content": "<p>What are you working on?</p>",
        "id": 257773640,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634336266
    },
    {
        "content": "<p>I'd consider just offering a dockerized version as the only supported option and see who complains.</p>",
        "id": 257774342,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634336634
    },
    {
        "content": "<p>(The folks who want support for specific distos may be the best positioned to maintain those ;-))</p>",
        "id": 257774418,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634336658
    },
    {
        "content": "<p>That might be a reasonable approach to take.</p>",
        "id": 257774725,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1634336838
    },
    {
        "content": "<p>And sid and buster are Debian release names - and Ubuntu and Debian are very close (Ubuntu is based on Debian), so it's not necessarily too strange for them to be mentioned alongside the actual Ubuntu releases.</p>",
        "id": 257775047,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1634337018
    },
    {
        "content": "<p>so you build different distribution packages for your app depending on which ubuntu version? weird</p>",
        "id": 257779074,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634339386
    },
    {
        "content": "<p>the problem with the dockerized version - unless I misunderstand - is the 25 min start up process while everything is compiled</p>",
        "id": 257779144,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634339407
    },
    {
        "content": "<p>Nonono, we'd just publish the image</p>",
        "id": 257779276,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634339512
    },
    {
        "content": "<p>That's the intent behind the <code>.slimmed</code> file: something we could push to a Docker registry for easy deployment.</p>",
        "id": 257779348,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634339546
    },
    {
        "content": "<p>Then anyone can do <code>docker run</code> without having to do the <code>docker build</code> process themselves.</p>",
        "id": 257779382,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634339577
    },
    {
        "content": "<p>so one the build was complete</p>\n<ul>\n<li>delete the source + tools directories</li>\n<li>delete all the unnecessary source files</li>\n<li>leaving behind just what is needed for executable?</li>\n</ul>",
        "id": 257779590,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634339722
    },
    {
        "content": "<p>because the stuff that's not needed is about 16GB</p>",
        "id": 257779690,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634339775
    },
    {
        "content": "<p>Yeah that's pretty much the deal. But in a Docker file like this you can't just delete content because Docker needs to save each layer of the image as it builds things up. So adding a gigabyte of content in one layer and deleting it in the next layer creates a 2 gigabyte stack of layers instead of zero. You can go through some kind of compacting step to avoid this but what I'm doing instead is just to build up a fresh Ubuntu container <code>FROM ubuntu...</code>  and copying in any requires stuff from the first image,  rather than deleting anything.)</p>",
        "id": 257779941,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634339953
    },
    {
        "content": "<p>well, I can tell you what's required: </p>\n<ul>\n<li><code>exec/64/fhirserver</code></li>\n<li><code>exec/pack/*.*</code></li>\n<li><code>exec/pack/linux/*.*</code></li>\n</ul>\n<p>And all the linux dependencies and maybe mysql</p>",
        "id": 257782489,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634341909
    },
    {
        "content": "<p><a href=\"https://github.com/grahamegrieve/fhirserver/blob/9cae4a5fe8ebfd984daced2d880fbf2b3390d383/Dockerfile.slimmed#L8\">https://github.com/grahamegrieve/fhirserver/blob/9cae4a5fe8ebfd984daced2d880fbf2b3390d383/Dockerfile.slimmed#L8</a> captures it pretty closely already, considering that the pack files have been copied into the first path in original build. But I will clean this up.</p>",
        "id": 257782983,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634342262
    },
    {
        "content": "<p>By the way, if it is possible to remove the dependencies on gtk and X windows, that would save a good chunk of space in the base layers.</p>",
        "id": 257783042,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634342288
    },
    {
        "content": "<p>I looked into that. If I removed gtk, we'd still need it because I'd just need to split the executable into something that would still be needed in some configurations</p>",
        "id": 257783782,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634342814
    },
    {
        "content": "<p>btw, add to the list above:</p>",
        "id": 257783787,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634342819
    },
    {
        "content": "<ul>\n<li>exec/64/fhirconsole</li>\n</ul>",
        "id": 257783799,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634342828
    },
    {
        "content": "<p>I was trying to run the dockerfile, until I got an error. Is that supposed to be working on  windows or only a *nix machines?</p>",
        "id": 258316916,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634709891
    },
    {
        "content": "<p>I don't know. we only tested in on linux so far. what's the error?</p>",
        "id": 258317613,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634710508
    },
    {
        "content": "<p>on windows, you'd be better to try the windows batch files though</p>",
        "id": 258317801,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634710675
    },
    {
        "content": "<p>I'm just trying to get a docker image by running <code>docker build</code> on the Dockerfile.</p>",
        "id": 258338662,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634722640
    },
    {
        "content": "<p>I'll try in a linux terminal</p>",
        "id": 258338720,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634722679
    },
    {
        "content": "<p>same error from a windows powershell or windows WSL2 terminal:</p>\n<div class=\"codehilite\"><pre><span></span><code> &gt; [ 4/10] RUN /work/bootstrap/linux-toolchain.sh /work/bootstrap:\n#8 0.419 /usr/bin/env: &#39;bash\\r&#39;: No such file or directory\n</code></pre></div>",
        "id": 258343665,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634725162
    },
    {
        "content": "<p>that's a <span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> question</p>",
        "id": 258346382,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634726670
    },
    {
        "content": "<p>and Josh, we're not quite finished until the other docker is built correctly, right?</p>",
        "id": 258427961,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634757765
    },
    {
        "content": "<p>I would only expect this to work on linux; this should WSL on windows, which I'll test from my work PC.</p>",
        "id": 258429357,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634758300
    },
    {
        "content": "<blockquote>\n<p>Grahame Grieve: and Josh, we're not quite finished until the other docker is built correctly, right?</p>\n</blockquote>\n<p>\"Finished\" re: the goal of distributing a built image? Yeah, it'd be good to set up an automated push to a docker registry when certain tags are applied. Do you have a convention for tagging release branches?</p>",
        "id": 258429483,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634758339
    },
    {
        "content": "<p>not yet. I have to talk to <span class=\"user-mention\" data-user-id=\"248736\">@Mark Iantorno</span> about how to do releases. But I figured we would just get the release pipeline going before I sorted that out.</p>",
        "id": 258429575,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634758379
    },
    {
        "content": "<p>I want to build the windows installer as part of that too. It looks like I can - all the things I need to do can be done on linux.</p>",
        "id": 258429647,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634758406
    },
    {
        "content": "<p>Cool!</p>",
        "id": 258429676,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634758416
    },
    {
        "content": "<p>authenticate signing: <a href=\"https://www.ssl.com/how-to/microsoft-authenticode-code-signing-in-linux-with-jsign/\">https://www.ssl.com/how-to/microsoft-authenticode-code-signing-in-linux-with-jsign/</a><br>\nbuilding the installer: <a href=\"https://gist.github.com/amake/3e7194e5e61d0e1850bba144797fd797\">https://gist.github.com/amake/3e7194e5e61d0e1850bba144797fd797</a></p>\n<p>The rest of what happens can be done in shell scripts one way or another</p>",
        "id": 258430020,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634758498
    },
    {
        "content": "<blockquote>\n<p>just get the release pipeline going</p>\n</blockquote>\n<p>I think we're pretty good here; We'll basically want to do <code>docker build -t ghcr.io/grahamegrieve/fhirserver -f Dockerfile.slimmed . &amp;&amp; docker push</code> in whatever deployment action</p>",
        "id": 258430173,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634758530
    },
    {
        "content": "<p>(Re: the docker image piece; the windows release stuff I will leave to your capable hands :-))</p>",
        "id": 258430275,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634758549
    },
    {
        "content": "<p>I don't have a mental picture for what happens after that. The windows executable will end up here: <a href=\"https://github.com/HealthIntersections/fhirserver/releases\">https://github.com/HealthIntersections/fhirserver/releases</a> (well, that's what I think should happen). But what happens with the docker image?</p>",
        "id": 258430656,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634758677
    },
    {
        "content": "<p>The docker image will end up in the <a href=\"https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry\">GH container registry</a> so anyone in the world can <code>docker pull ghcr.io/grahamegrieve/fhirserver</code> and get the latest, or specify <code>:latest</code> explicitly as a suffix for the same behavior, or specify <code>:{{some tag}}</code> explicitly as a suffix to fetch a specific version.</p>",
        "id": 258430922,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634758786
    },
    {
        "content": "<p>how does the version get into the picture with docker push?</p>",
        "id": 258431017,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634758814
    },
    {
        "content": "<p>Before you push, you apply tags; the pushed image can be retrieved with those tags using the <code>:</code> syntax as a suffix to the image name. That's following docker standards/conventions.</p>",
        "id": 258431132,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634758872
    },
    {
        "content": "<p>well, the server has a semver version on it. When we finish the release pipeline, it will go to 2.x.x, and the tag will simply be the version</p>",
        "id": 258431358,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634758968
    },
    {
        "content": "<p>Sounds good to me.</p>",
        "id": 258431755,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634759123
    },
    {
        "content": "<p>Should be easy to meet the <a href=\"https://docs.docker.com/engine/reference/commandline/tag\">requirements</a>.</p>\n<blockquote>\n<p>A tag name must be valid ASCII and may contain lowercase and uppercase letters, digits, underscores, periods and dashes. A tag name may not start with a period or a dash and may contain a maximum of 128 characters.</p>\n</blockquote>",
        "id": 258431793,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634759142
    },
    {
        "content": "<p>should we do snapshot releases of the current? or just formal releases?</p>",
        "id": 258432252,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634759312
    },
    {
        "content": "<p>I don't think I'd push an image for every commit, but we could. Would start with releases.</p>",
        "id": 258433070,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634759626
    },
    {
        "content": "<p>if we pushed it with the same version, it would replace the last one, yes?</p>",
        "id": 258433261,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634759691
    },
    {
        "content": "<p>Yes, various combinations possible:</p>\n<ul>\n<li>Tag each image with a git SHA <em>and</em>  a semver, and <code>:latest</code> and push all tags, so every build is available all the time, and <code>:latest</code> always grabs the latest</li>\n<li>Tag each image with some subset of these tags...</li>\n</ul>",
        "id": 258434023,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634759998
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191315\">Josh Mandel</span> <a href=\"#narrow/stream/179281-pascal/topic/Automating.20fhirserver.20build/near/258429357\">said</a>:</p>\n<blockquote>\n<p>I would only expect this to work on linux; this should WSL on windows, which I'll test from my work PC.</p>\n</blockquote>\n<p>Still doesn't work. could it be this line ?</p>\n<div class=\"codehilite\"><pre><span></span><code>Xvfb  :99 -screen 0 1024x768x8 -nolisten tcp &amp; \\n\\\n</code></pre></div>",
        "id": 258623597,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634853378
    },
    {
        "content": "<p>Does it work if you remove this line? (I have not tried this on WSL but can do.)</p>",
        "id": 258623796,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634853498
    },
    {
        "content": "<p>I'll try tomorrow. I recall some discussions around enabling graphics so I thought it could be needed</p>",
        "id": 258629513,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634856549
    },
    {
        "content": "<p>I don't have a Linux machine, just a Linux terminal prompt on windows. So I don't have X</p>",
        "id": 258629576,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634856597
    },
    {
        "content": "<p>This doesn't use X as a grpahical environment though. It uses  Xvfb, a virtual framebuffer. Headless implementation.</p>",
        "id": 258630998,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634857396
    },
    {
        "content": "<p>Confirmed that I can run </p>\n<div class=\"codehilite\"><pre><span></span><code>~/fhirserver$ docker build -t grahamegrieve/fhirserver -f Dockerfile .\n</code></pre></div>\n\n<p>in WSL2 on my windows laptop. (Though it ... was not fast.)</p>",
        "id": 258631446,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634857604
    },
    {
        "content": "<p>what does not fast mean?</p>",
        "id": 258631479,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634857629
    },
    {
        "content": "<p>Having done so, </p>\n<div class=\"codehilite\"><pre><span></span><code>$ docker run --rm -it grahamegrieve/fhirserver\n</code></pre></div>\n\n<p>succeeds in starting the server for me</p>",
        "id": 258631490,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634857635
    },
    {
        "content": "<blockquote>\n<p>Grahame Grieve: what does not fast mean?</p>\n</blockquote>\n<p>I mean, my work laptop is long in the tooth. But my internet connection is <em>fast</em>. This took me </p>\n<div class=\"codehilite\"><pre><span></span><code> Building 3848.5s (15/15) FINISHED\n</code></pre></div>",
        "id": 258631535,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634857664
    },
    {
        "content": "<p>(!)</p>",
        "id": 258631540,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634857667
    },
    {
        "content": "<p>that's definitely not fast. The full build including tests is taking 30min on github</p>",
        "id": 258631642,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634857729
    },
    {
        "content": "<p>sorry ~25min</p>",
        "id": 258631676,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634857759
    },
    {
        "content": "<p>GH is caching though, keep in mind (it caches the lazarus stuff until/unless the early lines of the dockerfile change)</p>",
        "id": 258631828,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634857849
    },
    {
        "content": "<p>hmm. I'll time my linux laptop, but it feels about the same starting from scratch</p>",
        "id": 258631897,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634857885
    },
    {
        "content": "<p>It may be; the speedup in GH from caching was only about 5min when I clocked it, because the caching itself isn't super fast. We can cut it out for simplicity if you prefer.</p>",
        "id": 258632042,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634857945
    },
    {
        "content": "<p>no keep it</p>",
        "id": 258632576,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634858278
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191315\">Josh Mandel</span> <a href=\"#narrow/stream/179281-pascal/topic/Automating.20fhirserver.20build/near/258631446\">said</a>:</p>\n<blockquote>\n<p>Confirmed that I can run </p>\n<div class=\"codehilite\"><pre><span></span><code>~/fhirserver$ docker build -t grahamegrieve/fhirserver -f Dockerfile .\n</code></pre></div>\n\n<p>in WSL2 on my windows laptop. (Though it ... was not fast.)</p>\n</blockquote>\n<p>Found it. It's a CR/LF thing. It depends on one's git configuration. To fix it, I had to replace all CRLF to LF</p>",
        "id": 258668404,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634883661
    },
    {
        "content": "<p>unbelievable</p>",
        "id": 258668508,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634883732
    },
    {
        "content": "<p>more unbelievable is how silly I am to fix one file, run it for 10 minutes, and only then realizing that of course I have to do the same for all the other .sh scripts</p>",
        "id": 258668826,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634884044
    },
    {
        "content": "<p>Confirmed. It builds ok now.</p>",
        "id": 258671458,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634886091
    },
    {
        "content": "<p>1038 seconds on a Ryzen 9 3900x desktop</p>",
        "id": 258671683,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634886243
    },
    {
        "content": "<p>i now get a <code>First time, so can't continue.</code><br>\nWhat do i need to look at to pick up from here?</p>",
        "id": 258672024,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634886491
    },
    {
        "content": "<p>where do you get that?</p>",
        "id": 258686591,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634895388
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191832\">@Jose Costa Teixeira</span>  did you clone this repository within wsl, or copied in from a Windows git operation performed outside of WSL? Just trying to figure out where your configuration and mine differed. I believe that the default Windows settings for new lines in git are different than the default Linux settings because the operating systems have different conventions. As you point out, configuring git is one way to resolve this; using default git settings in WSL should be another.</p>",
        "id": 258708242,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634907789
    },
    {
        "content": "<p>And Grahame for the record what is your</p>\n<div class=\"codehilite\"><pre><span></span><code>git config core.autocrlf\n</code></pre></div>",
        "id": 258710712,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634909068
    },
    {
        "content": "<p>(<a href=\"https://stackoverflow.com/a/20653073/318206\">https://stackoverflow.com/a/20653073/318206</a> has a good overview.)</p>",
        "id": 258710805,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634909111
    },
    {
        "content": "<p>I got the files in Windows</p>",
        "id": 258726458,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634915906
    },
    {
        "content": "<p>So no clone in wsl</p>",
        "id": 258726493,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634915918
    },
    {
        "content": "<blockquote>\n<p>git config core.autocrlf</p>\n</blockquote>\n<p>false</p>",
        "id": 258748798,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634925463
    },
    {
        "content": "<p>(Let me RTFM to see if we can prevent others from encountering the same issue)</p>",
        "id": 258759124,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634929810
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191316\">Grahame Grieve</span> <a href=\"#narrow/stream/179281-pascal/topic/Automating.20fhirserver.20build/near/258686591\">said</a>:</p>\n<blockquote>\n<p>where do you get that?</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> I just run the docker image, I don't know if there are any parameters when I do that</p>",
        "id": 258777832,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634938352
    },
    {
        "content": "<p>I'm running <code>docker run --rm -it fhirserver</code></p>",
        "id": 258778015,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634938478
    },
    {
        "content": "<p>What should I run to get the DB initialized?</p>",
        "id": 258778037,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634938494
    },
    {
        "content": "<p>Do you see an error prior to \"First time, so can't continue\"? (When I saw this once, it was right after a download failed.)</p>",
        "id": 258778385,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634938727
    },
    {
        "content": "<p>right, sorry I missed that:</p>\n<div class=\"codehilite\"><pre><span></span><code>07:07:09 00:00:00 Local Config in /terminology/fhir-server/\n07:07:09 00:00:00 Read Zero Config from http://tx.fhir.org/config/config.json\n07:07:10 00:00:00 Realm: uv\n07:07:10 00:00:00 Download rxnorm-20210208.db. HTTP/1.1 500 Internal Server Error\n07:07:10 00:00:00 Zero Configuration Process failed: HTTP/1.1 500 Internal Server Error\n</code></pre></div>",
        "id": 258778459,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634938780
    },
    {
        "content": "<p>So if you try again you may get a different result. Best to mount in a volume so you don't lose the vocabs that <em>have</em> successfully downloaded between each run.</p>",
        "id": 258778655,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634938884
    },
    {
        "content": "<p>tried a few times, same result.</p>",
        "id": 258778695,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634938909
    },
    {
        "content": "<p>OK -- looks like an error in the cloud-hosted sever's stack then. (<code>HTTP/1.1 500</code>)</p>",
        "id": 258778760,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634938931
    },
    {
        "content": "<p>mounting in volume: <code>docker run -v ____</code> ?</p>",
        "id": 258778974,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634939064
    },
    {
        "content": "<p>(I created a volume named fhirserver - what is the path where the volume is mounted?)</p>",
        "id": 258779108,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634939154
    },
    {
        "content": "<p>Let's say you have a host directory like /tmp/term, then you can do</p>\n<div class=\"codehilite\"><pre><span></span><code>docker run \\\n  --rm -it \\\n  -v /tmp/term:/terminology \\\n  grahamegrieve/fhirserver\n</code></pre></div>\n\n<p>For reference</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$ docker inspect fhirserver <span class=\"p\">|</span> jq <span class=\"s1\">'.[].Config.Volumes'</span>\n<span class=\"o\">{</span>\n  <span class=\"s2\">\"/terminology\"</span>: <span class=\"o\">{}</span>\n<span class=\"o\">}</span>\n</code></pre></div>\n<p>or</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$ cat Dockerfile <span class=\"p\">|</span> grep -i volume\nVOLUME /terminology\n</code></pre></div>",
        "id": 258779671,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634939466
    },
    {
        "content": "<p>thanks</p>",
        "id": 258780255,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634939776
    },
    {
        "content": "<p>(I see the same errors as you :-)</p>",
        "id": 258780378,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634939859
    },
    {
        "content": "<p>I can't say I'm happy about that, but I'm kind of happy about that :)</p>",
        "id": 258780528,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634939938
    },
    {
        "content": "<p>so I guess the server error is no longer a docker issue but in the pascal code?</p>",
        "id": 258781581,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634940507
    },
    {
        "content": "<p>I think it's an issue with the web server Grahame hosts at <a href=\"http://tx.fhir.org\">tx.fhir.org</a>, which your local server is trying to connect to on startup to fetch vocab filesr</p>",
        "id": 258781631,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634940538
    },
    {
        "content": "<p>i'm trying to see if the files are actually on the server, but they're now</p>",
        "id": 258781638,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634940542
    },
    {
        "content": "<p>right.</p>",
        "id": 258781660,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634940551
    },
    {
        "content": "<p>how do we point it to a different config.json file, instead of getting the config.json online?</p>",
        "id": 258781742,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634940596
    },
    {
        "content": "<p>no , let me check that in the code</p>",
        "id": 258781822,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634940618
    },
    {
        "content": "<p>oh - first time can't continue in that place - totally my problem. I'll look at it tonight and figure out why - it was broken for a while yesterday but should be good now</p>",
        "id": 258782038,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634940732
    },
    {
        "content": "<p>ok meanwhile I see that we can pass a -cfg parameter in the command line.</p>",
        "id": 258782130,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634940810
    },
    {
        "content": "<p>Is there a way to pass a parameter to the fhirserver command line when doing docker run?</p>",
        "id": 258782212,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634940849
    },
    {
        "content": "<p>Just add arguments after \"grahamegrieve/fhirserver\"</p>",
        "id": 258782337,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634940924
    },
    {
        "content": "<p>in the build line, or can also be just in the run?</p>",
        "id": 258782383,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634940950
    },
    {
        "content": "<p>like <code>docker run grahamegrieve/fhirserver -cfg /tmp/file</code></p>",
        "id": 258782391,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634940952
    },
    {
        "content": "<p>(But you'll need to point to a file that exists in the container or mount one in)</p>",
        "id": 258782445,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634940964
    },
    {
        "content": "<p>ok perfect i thought I had to rebuild. thanks</p>",
        "id": 258782462,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634940970
    },
    {
        "content": "<p>but why do you need to do that? what's actually broken? you need to access the file it says that it can't read...</p>",
        "id": 258782619,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634941077
    },
    {
        "content": "<p>while I am getting the 500 error from the server, I want to experiment with the config file, <br>\nI want to learn how to run a server with my own config.json</p>",
        "id": 258782750,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634941155
    },
    {
        "content": "<p>For now, I just want to see if I can get it to move on when I have a config file that doesn't have the rxnorm db</p>",
        "id": 258782871,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634941209
    },
    {
        "content": "<p>well, ok, but why are you getting a 500 error from the server? can you access it in a browser?</p>",
        "id": 258782884,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634941215
    },
    {
        "content": "<p>no<br>\n<code>The webpage at http://tx.fhir.org/config/rxnorm-20210208.db might be temporarily down or it may have moved permanently to a new web address.</code></p>",
        "id": 258782951,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634941255
    },
    {
        "content": "<p>oh interesting. the server won't download the .db files... I wonder why</p>",
        "id": 258782993,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634941276
    },
    {
        "content": "<p>I will look at this tonight</p>",
        "id": 258783001,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634941282
    },
    {
        "content": "<p><a href=\"https://tx.fhir.org/config/loinc-2.71.cache\">https://tx.fhir.org/config/loinc-2.71.cache</a> does work</p>",
        "id": 258783002,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634941282
    },
    {
        "content": "<p>which reminds me <span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> I got around to looking into putting this stuff into cloud storage. Is there a cloud storage that doesn't suck? both AWS and GCS, I couldn't even figure out how to start doing it - so many configuration options in language I can't understand, and the hl7 guys tell me that AWS doesn't want new publicly available cloud storages...</p>",
        "id": 258783189,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634941396
    },
    {
        "content": "<blockquote>\n<p>Is there a cloud storage that doesn't suck? </p>\n</blockquote>\n<p>I'm not sure what you mean about \"new publicly available cloud storages\" You can configure S3 public buckets following <a href=\"https://docs.aws.amazon.com/AmazonS3/latest/userguide/UsingBucket.html#block-public-access-intro\">https://docs.aws.amazon.com/AmazonS3/latest/userguide/UsingBucket.html#block-public-access-intro</a></p>",
        "id": 258790237,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634946570
    },
    {
        "content": "<p>(Looks like they have introduced defaults designed to prevent <a href=\"https://www.computerweekly.com/news/252476870/Exposed-AWS-buckets-again-implicated-in-multiple-data-leaks\">https://www.computerweekly.com/news/252476870/Exposed-AWS-buckets-again-implicated-in-multiple-data-leaks</a>)</p>",
        "id": 258790345,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634946659
    },
    {
        "content": "<p>Or... I put the snomed.test.cache file (for tests) in <a href=\"https://console.cloud.google.com/storage/browser/ig-build\">https://console.cloud.google.com/storage/browser/ig-build</a> which supports public https access -- e.g., at <a href=\"https://storage.googleapis.com/ig-build/snomed.test.cache\">https://storage.googleapis.com/ig-build/snomed.test.cache</a></p>",
        "id": 258790465,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634946758
    },
    {
        "content": "<p>so I created  a sub-folder /tx. now: <a href=\"https://storage.googleapis.com/ig-build/tx/config.json\">https://storage.googleapis.com/ig-build/tx/config.json</a> = access denied.</p>",
        "id": 258795955,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634952993
    },
    {
        "content": "<p>so I have to explicitly add allUsers for all files in the folder :-(</p>",
        "id": 258796125,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634953235
    },
    {
        "content": "<p><a href=\"https://storage.googleapis.com/ig-build/tx/ucum-essence-2.0.1.xml\">https://storage.googleapis.com/ig-build/tx/ucum-essence-2.0.1.xml</a></p>",
        "id": 258796204,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634953358
    },
    {
        "content": "<p>why doesn't access to this work? As I said, sucky. permissions model is impossible to navigate</p>",
        "id": 258796210,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634953379
    },
    {
        "content": "<p>There is no such thing as a folder in this paradigm. Merely conventions about <del>file</del> blob name prefixes which happened to include slashes :-)</p>",
        "id": 258797555,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634955280
    },
    {
        "content": "<p>But you can set up a bucket so that all files in our public by default which you might want here.</p>",
        "id": 258797558,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634955294
    },
    {
        "content": "<p>it was how it was set up but apparently it doesn't matter how it's set up, only how it was set up when the file was uploaded</p>",
        "id": 258798209,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634956310
    },
    {
        "content": "<p>ok sorted that. Uploading will be a nightmare, but... the new zero config URL for the server is <a href=\"https://storage.googleapis.com/tx-fhir-org\">https://storage.googleapis.com/tx-fhir-org</a></p>",
        "id": 258799708,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634958546
    },
    {
        "content": "<p><a href=\"http://tx.fhir.org\">tx.fhir.org</a> will be using that set up from the next time it restarts</p>",
        "id": 258799711,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634958588
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191832\">@Jose Costa Teixeira</span> you've seen <a href=\"https://confluence.hl7.org/display/FHIR/Running+your+own+copy+of+tx.fhir.org\">https://confluence.hl7.org/display/FHIR/Running+your+own+copy+of+tx.fhir.org</a> ?</p>",
        "id": 258799985,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1634958981
    },
    {
        "content": "<p>Thanks, just did, i'm now downloading</p>",
        "id": 258814068,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1634982101
    },
    {
        "content": "<p>Lovely, I get ~350Mb/s from there</p>\n<div class=\"codehilite\"><pre><span></span><code>15:30:15 00:00:00 Config: https://storage.googleapis.com/tx-fhir-org\n15:30:15 00:00:00 Local Config in /terminology/fhir-server/\n15:30:15 00:00:00 Read Zero Config from https://storage.googleapis.com/tx-fhir-org/config.json\n15:30:16 00:00:00 Realm: uv\n15:30:16 00:00:00 Download rxnorm-20210208.db.................................................. Done (1.3 GB, 29sec)\n15:30:45 00:00:29 Download ndc-20210923.db.................................................. Done (60.5 MB, 1sec)\n15:30:47 00:00:31 Download unii-20210810.db.................................................. Done (55.2 MB, 6sec)\n15:30:54 00:00:38 Download sct_intl_20210731-fixed.cache.................................................. Done (733.0 MB, 23sec)\n15:31:18 00:01:02 Download loinc-2.71.cache.................................................. Done (168.0 MB, 4sec)\n15:31:22 00:01:06 Download ucum-essence-2.0.1.xml........................................ Done (82.4 KB, 340ms)\n15:31:23 00:01:07 Realm: au\n15:31:23 00:01:07 Download sct_au_20210630.cache.................................................. Done (898.7 MB, 20sec)\n15:31:43 00:01:27 Realm: ca\n15:31:43 00:01:27 Download sct_ca_20210331.cache.................................................. Done (0.9 GB, 22sec)\n15:32:05 00:01:49 Realm: old\n15:32:05 00:01:49 Download sct_intl_20190731.cache.................................................. Done (880.6 MB, 20sec)\n15:32:26 00:02:10 Download sct_intl_20200731.cache.................................................. Done (1.0 GB, 24sec)\n15:32:50 00:02:34 Download sct_intl_20200131.cache.................................................. Done (1.0 GB, 23sec)\n15:33:13 00:02:57 Realm: us\n15:33:13 00:02:57 Download sct_us_20210901.cache.................................................. Done (760.3 MB, 17sec)\n</code></pre></div>",
        "id": 258829232,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635003250
    },
    {
        "content": "<p>Is it expected that I see slow steps like the following each time I start the server, even though the config hasn't changed?</p>\n<div class=\"codehilite\"><pre><span></span><code>15:37:19 00:00:05 Installing Package from https://packages.simplifier.net/hl7.fhir.r4.core/4.0.1 to /var/lib/.fhir/packages\n</code></pre></div>\n\n<p>If this is expected: is there an underlying reason why contents from <a href=\"http://packages.simplifier.org\">packages.simplifier.org</a> can't be saved locally the way vocabularies are? (I'm thinking that once I have set up the server, or once I have fed in the right volumes with data dependencies... I should be able to start/run it in a totally internal way without it needing to reach to the internet.)</p>",
        "id": 258829408,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635003545
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> I broke something, and I don't understand what.</p>",
        "id": 260068063,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635892988
    },
    {
        "content": "<p><a href=\"https://github.com/HealthIntersections/fhirserver/runs/4086273976?check_suite_focus=true\">https://github.com/HealthIntersections/fhirserver/runs/4086273976?check_suite_focus=true</a></p>",
        "id": 260068093,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635893011
    },
    {
        "content": "<p>which is because of the changes I made to the dockerfile in the gg-202110-code-scanning branch</p>",
        "id": 260068155,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635893043
    },
    {
        "content": "<p>I wanted to run another executable, but why is it blowing up on it?</p>",
        "id": 260068177,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635893060
    },
    {
        "content": "<p>Let's see...</p>",
        "id": 260069884,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635894305
    },
    {
        "content": "<p><a href=\"https://github.com/HealthIntersections/fhirserver/blame/gg-202110-code-scanning/Dockerfile\">https://github.com/HealthIntersections/fhirserver/blame/gg-202110-code-scanning/Dockerfile</a></p>",
        "id": 260070042,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635894376
    },
    {
        "content": "<p>You've added lines to the entry point script, with two problems:</p>\n<ol>\n<li>They are syntactically invalid (need <code>\\</code> at the end to continue this block, like the lines above and below</li>\n<li>They don't make sense; the entry point script executes every time someone does <code>docker run</code>; it should accept arguments and do one job, but you seem to be trying to do two different</li>\n</ol>",
        "id": 260070212,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635894504
    },
    {
        "content": "<p>what entry point script?</p>",
        "id": 260070246,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635894530
    },
    {
        "content": "<p>I am trying to run another executable, yes, and run it before the test cases</p>",
        "id": 260070261,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635894543
    },
    {
        "content": "<p>The comments are also wrong; you've written \"run tests\" but the function of this line is to execute server with any supplied arguments (tests are passed in via the GH action but default cmd arguments below are just to run the server with <a href=\"http://tx.fhir.org\">tx.fhir.org</a> configuration)</p>",
        "id": 260070332,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635894601
    },
    {
        "content": "<p>Think of the entry point as a wrapper around the <code>fhirserver</code> executable. The whole job of the entry point is to get configuration in place, pass through any command line args, and get out of the way.</p>",
        "id": 260070436,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635894675
    },
    {
        "content": "<p>so how can I do this then? I build this executable in /work/fhirserver/utilities/codescan/codescan, and I want to run it</p>",
        "id": 260070439,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635894678
    },
    {
        "content": "<p>before the fhirserver runs</p>",
        "id": 260070450,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635894687
    },
    {
        "content": "<p>If you want to affect the tests that run in CI..</p>",
        "id": 260070452,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635894689
    },
    {
        "content": "<p>You'll want to edit <a href=\"https://github.com/HealthIntersections/fhirserver/blob/gg-202110-code-scanning/.github/workflows/linux-docker-build.yml#L69\">https://github.com/HealthIntersections/fhirserver/blob/gg-202110-code-scanning/.github/workflows/linux-docker-build.yml#L69</a></p>",
        "id": 260070471,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635894712
    },
    {
        "content": "<p>E.g., add a line like <code>docker run --entrypoint /work/fhir server/.../codescan ... fhirserver</code></p>",
        "id": 260070592,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635894791
    },
    {
        "content": "<p>I suppose I just don't understand the relationship between the dockerfile and this .yml file, and which is done in which</p>",
        "id": 260070625,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635894826
    },
    {
        "content": "<p>If you need to pass in a a command line arg to the codescan binary, that goes at the end</p>",
        "id": 260070637,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635894837
    },
    {
        "content": "<p>The Dockerfile builds a docker image with a fhirserver and related tools/libraries inside it</p>",
        "id": 260070699,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635894867
    },
    {
        "content": "<p>The GH action runs a container based on this image, invoking the executables with whatever arguments are required for the CI process to be happy that this commit is valid</p>",
        "id": 260070776,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635894941
    },
    {
        "content": "<p>The Dockerfile includes a default entry point that executes fhirserver, so real users can basically treat it as the fhirserver. If you want to execute other binaries inside, you need to specify a different entry point</p>",
        "id": 260070870,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635895020
    },
    {
        "content": "<p>so what I don't understand in linux-docker-build.yml is when does the build actually happen?</p>",
        "id": 260073110,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635896549
    },
    {
        "content": "<p>is it Buildx?  if not, what is Buildx doing?</p>",
        "id": 260073122,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635896563
    },
    {
        "content": "<p>and what's the <code>`... fhirserver</code> about in what you put above?</p>",
        "id": 260073265,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635896682
    },
    {
        "content": "<p><code>docker buildx build</code> at <a href=\"https://github.com/HealthIntersections/fhirserver/blob/7e072c7e5ab9e2d6e4455f7524c5d0a657be219c/.github/workflows/linux-docker-build.yml#L42\">https://github.com/HealthIntersections/fhirserver/blob/7e072c7e5ab9e2d6e4455f7524c5d0a657be219c/.github/workflows/linux-docker-build.yml#L42</a> builds the image.</p>",
        "id": 260076143,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635898992
    },
    {
        "content": "<p>Based on the Dockerfile</p>",
        "id": 260076150,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635898998
    },
    {
        "content": "<p>The <code>...</code> was a placeholder for any arguments you might want to supply like if you need to mount any directories into the container or define any ports. I'm still not sure I understand what the codescan is doing; is it meant to scan the source code in your repository for \"Trojan Source\" contents?</p>",
        "id": 260076264,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635899095
    },
    {
        "content": "<p>If that's the main reason, you might just run grep outside of all this Dickers stuff as a standalone step -- <a href=\"https://news.ycombinator.com/item?id=29062307\">https://news.ycombinator.com/item?id=29062307</a> has pointers</p>",
        "id": 260076496,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635899300
    },
    {
        "content": "<p>(And I expect someone will build this into existing source code scanning GH actions within a few days.)</p>",
        "id": 260076534,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635899361
    },
    {
        "content": "<p>that was the trigger for me to get around to doing this, but it does other things in the code as well</p>",
        "id": 260076546,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635899374
    },
    {
        "content": "<p>Sounds good.</p>",
        "id": 260076567,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635899401
    },
    {
        "content": "<p>well, I'm getting there, but still not there yet.</p>",
        "id": 260079346,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635902078
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>021-11-03T01:00:30.2283884Z ##[group]Run docker run --entrypoint /work/fhirserver/codescan/codescan /work/bootstrap\n2021-11-03T01:00:30.2285434Z \u001b[36;1mdocker run --entrypoint /work/fhirserver/codescan/codescan /work/bootstrap\u001b[0m\n2021-11-03T01:00:30.3214919Z shell: /usr/bin/bash -e {0}\n2021-11-03T01:00:30.3215465Z ##[endgroup]\n2021-11-03T01:00:30.3956267Z docker: invalid reference format.\n2021-11-03T01:00:30.3968559Z See &#39;docker run --help&#39;.\n2021-11-03T01:00:30.3993955Z ##[error]Process completed with exit code 125.\n</code></pre></div>",
        "id": 260079357,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635902095
    },
    {
        "content": "<p>I don't understand what \"invalid reference format\" means?</p>",
        "id": 260079376,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635902122
    },
    {
        "content": "<p>You need to specify an image. Assuming it's the image that we've tagged as \"fhirserver\":</p>\n<div class=\"codehilite\"><pre><span></span><code>docker run --entrypoint /work/fhirserver/codescan/codescan fhirserver /work/bootstrap\n</code></pre></div>",
        "id": 260079476,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635902217
    },
    {
        "content": "<blockquote>\n<p>Assuming it's the image that we've tagged as \"fhirserver\"</p>\n</blockquote>\n<p>I don't know what that means.</p>",
        "id": 260079489,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635902237
    },
    {
        "content": "<p>/work/fhirserver/codescan/codescan is an executable that should exist on the system, and I want to run it</p>",
        "id": 260079496,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635902257
    },
    {
        "content": "<p><a href=\"https://github.com/HealthIntersections/fhirserver/blob/7e072c7e5ab9e2d6e4455f7524c5d0a657be219c/.github/workflows/linux-docker-build.yml#L46\">https://github.com/HealthIntersections/fhirserver/blob/7e072c7e5ab9e2d6e4455f7524c5d0a657be219c/.github/workflows/linux-docker-build.yml#L46</a> assigns a tag</p>",
        "id": 260079500,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635902267
    },
    {
        "content": "<p>You need to do \"docker run [--entrypoint /path/to/bin] {tag} [cli args]\" where {} is a required value and [] is optional</p>",
        "id": 260079603,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635902372
    },
    {
        "content": "<p>In your case, try the command I listed above</p>",
        "id": 260079614,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635902400
    },
    {
        "content": "<p>ok thanks, I think I understand now.</p>",
        "id": 260079717,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635902499
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> sigh. like fhirserver, the code scanner needs gui support. I tried to rip it out, but it's a huge code change for me. Maybe I'm doing it wrong, but any thing with color reasoning brings in the gui framework</p>",
        "id": 260081438,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635904680
    },
    {
        "content": "<p>so the code scanner, since it depends on the same base string library that does colour / string wrangling. and so I get this:</p>",
        "id": 260081491,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635904714
    },
    {
        "content": "<p>Oy. The code scanner uses colors?</p>",
        "id": 260081493,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635904717
    },
    {
        "content": "<p>(codescan:1): Gtk-WARNING **: 01:54:49.280: cannot open display: :99</p>",
        "id": 260081495,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635904720
    },
    {
        "content": "<p>it's really hard to fix this, and I thought that we had sorted this out for the FHIRServer, so it should just work?</p>",
        "id": 260081583,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635904806
    },
    {
        "content": "<p>I did spend 30 minutes trying to splice the GUI code out, but then I realised just how big a task that is. Might take me 3 or 4 days</p>",
        "id": 260081691,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635904851
    },
    {
        "content": "<p>(Er, accidentally deleted this msg; can't fix on mobile but you can see the history.)</p>",
        "id": 260081745,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635904917
    },
    {
        "content": "<p>Or we could keep one entry point file and require users to pass an additional arg telling it which executable to run. But I think that clouds the common case DX</p>",
        "id": 260081819,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635904984
    },
    {
        "content": "<p>ok, well, I bit the bullet and reshuffled a little differently, and now my code scanner runs.</p>",
        "id": 260088253,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635912745
    },
    {
        "content": "<p>and it tells me that the code in the dependent repositories isn't being updated.</p>",
        "id": 260088257,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635912759
    },
    {
        "content": "<p>looking at the raw log (<a href=\"https://pipelines.actions.githubusercontent.com/ndybd65Zkxa5S6FQ0UrdL992It9FGwV31XpzWUz7if34N6rUNI/_apis/pipelines/1/runs/116/signedlogcontent/2?urlExpires=2021-11-03T04%3A12%3A15.4520223Z&amp;urlSigningMethod=HMACV1&amp;urlSignature=qXhvJopunSXQEI6xxKCwOebQlb5EDdIg7zmFgeAcQYw%3D\">https://pipelines.actions.githubusercontent.com/ndybd65Zkxa5S6FQ0UrdL992It9FGwV31XpzWUz7if34N6rUNI/_apis/pipelines/1/runs/116/signedlogcontent/2?urlExpires=2021-11-03T04%3A12%3A15.4520223Z&amp;urlSigningMethod=HMACV1&amp;urlSignature=qXhvJopunSXQEI6xxKCwOebQlb5EDdIg7zmFgeAcQYw%3D</a>):</p>\n<p><code>021-11-03T02:55:00.7044244Z #10 [ 5/10] RUN /work/bootstrap/unix-libraries.sh /work/bootstrap</code></p>",
        "id": 260088269,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635912782
    },
    {
        "content": "<p>that must lead to lines like this running:</p>",
        "id": 260088275,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635912791
    },
    {
        "content": "<p><code>echo \"Updating dependencies for linux\"</code></p>",
        "id": 260088278,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635912801
    },
    {
        "content": "<p>but no, nothing. So I think that script isn't being executed at all</p>",
        "id": 260088281,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635912813
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span></p>",
        "id": 260088285,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635912816
    },
    {
        "content": "<p>That URI is \"expired\". But what's going on here is caching of docker layers across CI runs, which we've specifically enabled and can turn off if you don't want it, for a build time penalty. Alternatively, you can modify one of the input input files (e.g., add a comment line to unix-libraries that you update when you want to bust this caching) or alternatively we could play some trick to prevent any caching beyond the point at which the tool chain is installed, like copying a temp file with random content into the container right after that step)m</p>",
        "id": 260137258,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635947836
    },
    {
        "content": "<p>I don't understand. Why does caching stop git update from being run?</p>",
        "id": 260172269,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635962183
    },
    {
        "content": "<p>Docker has a \"dumb\" model for caching layers where:</p>\n<ul>\n<li>Each line of the Dockerfile represents a \"step\" of the build process, and the output of each step is a new \"layer\" (i.e., a docker image representing the state after that step has been run)</li>\n<li>Only a few steps (<code>COPY</code> and <code>ADD</code> steps) directly bring external content into their output layer (other steps like <code>RUN</code> can of course fetch files from the network, etc -- but Docker does not attempt to account for this in its caching model)</li>\n<li>A step that has already run will never run-run unless its inputs have changed (or the inputs to its predecessors have changed)</li>\n</ul>\n<p>So... the way it's currently configured, if the inputs to the first <code>COPY</code> step  (<code>build/linux-toolchain.sh</code> and <code>build/unix-libraries.sh</code>) haven't changed, then the <a href=\"https://github.com/HealthIntersections/fhirserver/blob/16c15813689739c37e4b45503540c7ce61e40d3e/Dockerfile#L16-L20\">lines leading up to the next COPY</a> won't run, since they're cached.</p>",
        "id": 260174046,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635962887
    },
    {
        "content": "<p>This  kind of flexibility can be quite helpful, but you have you be intentional about it. I think the main goal is to prevent re-installing <code>fpclazup</code> on every build, since that's particularly slow. We can accomplish this while still re-fetching dependencies (e.g., using \"Option 1\" from <a href=\"https://www.keepsecure.ca/blog/2021/advanced-docker-tips-pt2-know-when-to-cache/\">https://www.keepsecure.ca/blog/2021/advanced-docker-tips-pt2-know-when-to-cache/</a> to insert a step  between the toolchain script and the dependencies script).</p>",
        "id": 260174727,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635963150
    },
    {
        "content": "<p>but <a href=\"http://linux-fhirserver.sh\">linux-fhirserver.sh</a> runs each time, right? We just want <a href=\"http://unix-libraries.sh\">unix-libraries.sh</a> to run before <a href=\"http://linux-fhirserver.sh\">linux-fhirserver.sh</a> runs - should we just call unix-libraries from <a href=\"http://linux-fhirserver.sh\">linux-fhirserver.sh</a>?</p>",
        "id": 260174986,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635963253
    },
    {
        "content": "<p><a href=\"http://linux-fhirserver.sh\">linux-fhirserver.sh</a> runs any time <em>any of the repo contents</em> have changed, except for a few things listed in <a href=\"https://github.com/HealthIntersections/fhirserver/blob/master/.dockerignore\">https://github.com/HealthIntersections/fhirserver/blob/master/.dockerignore</a> -- so that's effectively always.</p>",
        "id": 260175117,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635963314
    },
    {
        "content": "<p>If you want to rebuild the unix libraries every time, we can indeed move that RUN step so it happens after the big COPY and before <a href=\"http://linux-fhirserver.sh\">linux-fhirserver.sh</a> runs</p>",
        "id": 260175168,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635963346
    },
    {
        "content": "<p>I just added a <a href=\"https://github.com/HealthIntersections/fhirserver/commit/219ef3a3edf8d31c49af8f87e19f8727c6a03da9\">commit</a> at  <a href=\"https://github.com/HealthIntersections/fhirserver/blob/gg-202110-code-scanning/Dockerfile\">https://github.com/HealthIntersections/fhirserver/blob/gg-202110-code-scanning/Dockerfile</a></p>",
        "id": 260175363,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1635963416
    },
    {
        "content": "<p>ok thanks. and yes, we do want the latest copes of the libraries each time</p>",
        "id": 260175896,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635963648
    },
    {
        "content": "<p>yay we got there, thanks</p>",
        "id": 260191676,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1635970670
    },
    {
        "content": "<p>I want to launch the server using a local config.json file. How can I do this? <br>\nI have a bind mount to a local folder, but I don't know how I can point to a file in that folder:<br>\nmy local folder is <code>/mnt/c/work/fhirserver/docker/cache</code>. How would the docker command line look like?<br>\n<code>docker run --name tx_server --env PORT=80 --mount type=bind,source=/mnt/c/work/fhirserver/docker/cache,target=/root/fhir-server  -p 80:80 fhirserver -cfg XXX</code></p>",
        "id": 260340147,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1636062963
    },
    {
        "content": "<p>What should I use as XXX?</p>",
        "id": 260340236,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1636063040
    },
    {
        "content": "<p>Why are you mounting a folder into /root/fhir-server? Is that a path that you expect to exist? I would have expected you to mount into something like /my-config. </p>\n<p>But in any case for the example, as you have written it, XXX=<code>/root/fhir-server/config.json</code> assuming that /mint/c/work/fhirserver/docker/cache/config.json exists on the host.</p>",
        "id": 260340444,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636063178
    },
    {
        "content": "<p>I have never supplied a local JSON file, only a URL, so I guess I'm also not sure what the server expects for this argument. I'm just answering your top level question about how to refer to a file on a  path that you have mounted into your docker container.</p>",
        "id": 260340522,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636063206
    },
    {
        "content": "<p>You'll also need an argument like <code>-cmd exec</code> and probably other arguments</p>",
        "id": 260340646,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636063249
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191315\">Josh Mandel</span> <a href=\"#narrow/stream/179281-pascal/topic/Automating.20fhirserver.20build/near/260340444\">said</a>:</p>\n<blockquote>\n<p>Why are you mounting a folder into /root/fhir-server? Is that a path that you expect to exist? I would have expected you to mount into something like /my-config. </p>\n</blockquote>\n<p>that is where the server keeps the cache files. If I use another folder, i'd need to tell the server about that other location (and I don't know how)</p>",
        "id": 260342762,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1636064489
    },
    {
        "content": "<p>I'm starting with something that works and there try to change a few things, so that I can always come back to a working setup</p>",
        "id": 260342837,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1636064543
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191315\">Josh Mandel</span> <a href=\"#narrow/stream/179281-pascal/topic/Automating.20fhirserver.20build/near/260340444\">said</a>:</p>\n<blockquote>\n<p>But in any case for the example, as you have written it, XXX=<code>/root/fhir-server/config.json</code> assuming that /mint/c/work/fhirserver/docker/cache/config.json exists on the host.</p>\n</blockquote>\n<p>it doesn't work. complains about <code>Unable to find the lang file \"\"</code></p>",
        "id": 260343012,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1636064668
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191315\">Josh Mandel</span> <a href=\"#narrow/stream/179281-pascal/topic/Automating.20fhirserver.20build/near/260340646\">said</a>:</p>\n<blockquote>\n<p>You'll also need an argument like <code>-cmd exec</code> and probably other arguments</p>\n</blockquote>\n<p>This is not needed. The server does start ok (if I use the URL)</p>",
        "id": 260343054,
        "sender_full_name": "Jose Costa Teixeira",
        "timestamp": 1636064705
    },
    {
        "content": "<p>hey <span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> this has suddenly started happening on the build, running the tests:</p>\n<blockquote>\n<p>(fhirserver:9): Gtk-WARNING **: 23:04:44.912: cannot open display: :99<br>\nError: Process completed with exit code 1.</p>\n</blockquote>",
        "id": 260346722,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636067145
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191832\">@Jose Costa Teixeira</span> I'm not sure what that error means from the server</p>",
        "id": 260347284,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636067500
    },
    {
        "content": "<p>Hmm, that's curious re: display error. Has this happened before? I'll see if I can reproduce locally.</p>",
        "id": 260348855,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636068676
    },
    {
        "content": "<p>hadn't happened since you first set it up, then failed for the last two runs</p>",
        "id": 260348997,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636068775
    },
    {
        "content": "<p>(master branch, and PR branch)</p>",
        "id": 260349008,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636068784
    },
    {
        "content": "<p>I can't think of any reason why it should fail transiently. Guess I'm not thinking creatively enough.</p>",
        "id": 260349341,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636069077
    },
    {
        "content": "<p>Well, I couldn't reproduce locally. On retriggering <a href=\"https://github.com/HealthIntersections/fhirserver/actions/runs/1423271582\">https://github.com/HealthIntersections/fhirserver/actions/runs/1423271582</a> succeeded. I'm retriggering the failed branch build too.</p>",
        "id": 260356691,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636075652
    },
    {
        "content": "<p>I'm puzzled about this failure mode.</p>",
        "id": 260356707,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636075680
    },
    {
        "content": "<p>X is having trouble starting? it's a timing thing?</p>",
        "id": 260356767,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636075713
    },
    {
        "content": "<p>It's possible there's a race condition, yeah.</p>",
        "id": 260356784,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636075735
    },
    {
        "content": "<p>If this happens again let's follow <a href=\"https://unix.stackexchange.com/a/310688\">https://unix.stackexchange.com/a/310688</a> or just add a sleep in the entrypoint file.</p>",
        "id": 260356870,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636075813
    },
    {
        "content": "<p>hey <span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> this happens for every PR created by someone other than you or me:</p>\n<blockquote>\n<div class=\"codehilite\"><pre><span></span><code>    testSendEmail [00.000] fail @?#?: Must provide password for SMTP test in work/fhirserver/exec/64/test-settings.ini ([email] ***\n</code></pre></div>\n\n</blockquote>\n<p>(see <a href=\"https://github.com/HealthIntersections/fhirserver/runs/4162397321?check_suite_focus=true\">https://github.com/HealthIntersections/fhirserver/runs/4162397321?check_suite_focus=true</a>)</p>",
        "id": 261048960,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636575592
    },
    {
        "content": "<p>I think it can't be co-incidence</p>",
        "id": 261048994,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636575602
    },
    {
        "content": "<p>Is it specific to you and me, or are the PRs being made from external forks? Just want to narrow down the permissions issues here.</p>",
        "id": 261051311,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636576702
    },
    {
        "content": "<p>See <a href=\"https://securitylab.github.com/research/github-actions-preventing-pwn-requests/\">https://securitylab.github.com/research/github-actions-preventing-pwn-requests/</a> for background</p>",
        "id": 261051344,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636576718
    },
    {
        "content": "<blockquote>\n<p>Due to the dangers inherent to automatic processing of PRs, GitHub’s standard pull_request workflow trigger by default prevents write permissions and secrets access to the target repository.</p>\n</blockquote>",
        "id": 261051587,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636576820
    },
    {
        "content": "<p>yes could be external PRs - that makes sense. And yes, I can see why they do that.</p>",
        "id": 261051856,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636576981
    },
    {
        "content": "<p>... but what's the solution?</p>",
        "id": 261052026,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636577058
    },
    {
        "content": "<p>further reading says 'by default' is misleading - there's no non-default here; it's a hard rule</p>",
        "id": 261060172,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636581223
    },
    {
        "content": "<p>We can run <em>almost all the tests</em> with no secrets at all, right? I think that should be the default, and the tests should pass.</p>",
        "id": 261060399,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636581351
    },
    {
        "content": "<p>yes I'm just sucking it up and making that change.</p>",
        "id": 261060477,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636581375
    },
    {
        "content": "<p>(We can add back email tests more thoughtfully -- like, maybe in the main branch the password <em>will</em> be present, and when present the tests will require this email test to pass.)</p>",
        "id": 261060495,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636581384
    },
    {
        "content": "<p>it does spectacularly screw up my plans for tx-cache mgmt though</p>",
        "id": 261060523,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636581402
    },
    {
        "content": "<p>So just make the email tests conditional</p>",
        "id": 261060533,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636581408
    },
    {
        "content": "<p>Hmm, what's the interaction with tx-cache management?</p>",
        "id": 261060546,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636581415
    },
    {
        "content": "<p>the plan was that the password to commit the updated tx-cache would use a password in the github repo. But, of course, it won't have one</p>",
        "id": 261060718,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636581497
    },
    {
        "content": "<p>but even more, if you create a fork in your own gh space, and then work from that, it won't pick up the tx-cache from the server because the org will be different</p>",
        "id": 261060780,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636581528
    },
    {
        "content": "<p>I'm not quite following. The submission of cache updates happens in the build pipeline (core or IG), right?</p>",
        "id": 261060806,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636581538
    },
    {
        "content": "<p>right. the build pipeline, yes</p>",
        "id": 261060836,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636581554
    },
    {
        "content": "<p>The secrets just need to be present in the build pipeline, then. Don't need to be in any GH actions.</p>",
        "id": 261060863,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636581565
    },
    {
        "content": "<p>how do we get them into the build pipeline then? the only way I knew was from a gh repo secret</p>",
        "id": 261060913,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636581594
    },
    {
        "content": "<p>By \"build pipeline\" I mean:</p>\n<ul>\n<li>Core: Azure Pipelines maintained by Mark</li>\n<li>IGs: Kubernetes based \"auto-ig-builder\" maintained by me</li>\n</ul>\n<p>... each of these has its own secret management functionality.</p>",
        "id": 261061102,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636581636
    },
    {
        "content": "<p>Like when I run the IG publisher I inject a <code>ig.builder.keyfile.ini</code> that you gave me.</p>",
        "id": 261061349,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636581748
    },
    {
        "content": "<p>oh. great. can you add an entry to it for me?</p>",
        "id": 261061396,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636581782
    },
    {
        "content": "<p>Um, not readily ;-) Let me see.</p>",
        "id": 261061451,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636581811
    },
    {
        "content": "<p>it should be</p>",
        "id": 261061529,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636581843
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"INI\"><pre><span></span><code><span class=\"k\">[keys]</span>\n<span class=\"na\">name</span><span class=\"o\">=</span><span class=\"s\">value</span>\n</code></pre></div>",
        "id": 261061578,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636581863
    },
    {
        "content": "<p>This should be a separate file though, right? like <code>ig.builder.keyfile.ini</code> passed in to the publisher as <code>-api-key-file</code></p>",
        "id": 261061593,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636581871
    },
    {
        "content": "<p>And this is a different kind of input.</p>",
        "id": 261061609,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636581879
    },
    {
        "content": "<p>y</p>",
        "id": 261061611,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636581879
    },
    {
        "content": "<p>Maybe?</p>",
        "id": 261061619,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636581884
    },
    {
        "content": "<p>I want to put an entry in that ini file?</p>",
        "id": 261061653,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636581909
    },
    {
        "content": "<p>I guess it's empty right now -- we set this up but never used it?</p>",
        "id": 261062338,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636582208
    },
    {
        "content": "<p>that makes sense. I want to use it now. So we can add:</p>",
        "id": 261062382,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636582230
    },
    {
        "content": "<p>Don't tell me secrets here ;-)</p>",
        "id": 261062397,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636582240
    },
    {
        "content": "<p>[keys]<br>\ntx.fhir.org=XX</p>",
        "id": 261062415,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636582248
    },
    {
        "content": "<p>I wasn't going to put it in here <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span></p>",
        "id": 261062475,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636582286
    },
    {
        "content": "<p>yay: I've redone the existing release process to use github releases</p>",
        "id": 261299669,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636745393
    },
    {
        "content": "<p><a href=\"https://github.com/HealthIntersections/fhirserver/releases\">https://github.com/HealthIntersections/fhirserver/releases</a></p>",
        "id": 261299672,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636745395
    },
    {
        "content": "<p>cool! do you apply release tags in git? should we trigger container publication based on this?</p>",
        "id": 261300375,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636745748
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> a question. I've started releasing my toolkit. It's a bunch of useful stuff in a IDE-lite - a desktop program. It builds and works for windows, linux, and OSX. If I was going to release a linux version, what would be the way to distribute it?</p>",
        "id": 261300447,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636745777
    },
    {
        "content": "<p>well, the gh documentation says that it auto-creates a tag for the release</p>",
        "id": 261300475,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636745793
    },
    {
        "content": "<p>e.g. <a href=\"https://github.com/HealthIntersections/fhirserver/releases/tag/v2.0.0\">https://github.com/HealthIntersections/fhirserver/releases/tag/v2.0.0</a></p>",
        "id": 261300492,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636745803
    },
    {
        "content": "<p>and it would be good to put the linux release there too</p>",
        "id": 261300517,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636745822
    },
    {
        "content": "<p>toolkit options - .zip, .tgz, docker, linux package, installer... the simpler options feel more inadequate but the complex ones feel out of reach</p>",
        "id": 261300732,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636745915
    },
    {
        "content": "<p>I don't have experience packaging linux apps; I tend to lean on docker but you might want to evaluate <a href=\"https://docs.appimage.org/\">https://docs.appimage.org/</a> or snap</p>",
        "id": 261301267,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1636746171
    },
    {
        "content": "<p>appimage seems like an appropriate option. I can even run it on windows. If only I could do the OSX release process from windows...</p>",
        "id": 261302158,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636746575
    },
    {
        "content": "<p>I may be able to do the windows release from linux - need to run several windows cli under wine - maybe they will...</p>",
        "id": 261302811,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1636746887
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> something's gone wrong with the build set up - see <a href=\"https://github.com/HealthIntersections/fhirserver/runs/4400650018?check_suite_focus=true\">https://github.com/HealthIntersections/fhirserver/runs/4400650018?check_suite_focus=true</a></p>",
        "id": 263517573,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1638489581
    },
    {
        "content": "<p>It looks like the snomed tests are failing;</p>",
        "id": 263517810,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1638489714
    },
    {
        "content": "<p>I can't tell from the logs whether this is an infrastructure issue</p>",
        "id": 263517816,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1638489721
    },
    {
        "content": "<p>the snomed loading code hasn't changed, and I'm checking that the file is present, and it is, but it's somehow corrupt...?</p>",
        "id": 263518089,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1638489899
    },
    {
        "content": "<p>You mean the cached db file?</p>",
        "id": 263518421,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1638490190
    },
    {
        "content": "<p>In theory it should either be present and correct or absent all together when we run the step that downloads it. And we skip the download if it is present.</p>",
        "id": 263518496,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1638490220
    },
    {
        "content": "<p>We can augment the download step to print out some logging information about file size and hash</p>",
        "id": 263518543,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1638490269
    },
    {
        "content": "<p>might have to ... I don't know what else could be the problem</p>",
        "id": 263518657,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1638490337
    },
    {
        "content": "<p>the hex representation of the SHA-256 hash is 'AA2BF154DC360AD5AFED687638CB8DC1EAE831E2EABD4498F327726F2EF92816' for me</p>",
        "id": 263519408,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1638490898
    },
    {
        "content": "<p>Of the correct file?</p>",
        "id": 263519477,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1638490929
    },
    {
        "content": "<p>my local file that works. Which is the correct file, yes</p>",
        "id": 263519497,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1638490943
    },
    {
        "content": "<p>Okay, and that's what's in the GCP bucket?</p>",
        "id": 263519515,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1638490961
    },
    {
        "content": "<p>I think so. checking...</p>",
        "id": 263519738,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1638491149
    },
    {
        "content": "<p>my local file: 914,069,742 bytes</p>",
        "id": 263519809,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1638491195
    },
    {
        "content": "<p>Error&gt;<br>\n&lt;Code&gt;AccessDenied&lt;/Code&gt;<br>\n&lt;Message&gt;Access denied.&lt;/Message&gt;<br>\n&lt;Details&gt;Anonymous caller does not have storage.objects.get access to the Google Cloud Storage object.&lt;/Details&gt;<br>\n&lt;/Error&gt;</p>\n<p>trying to download what's in the cache?</p>",
        "id": 263519872,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1638491259
    },
    {
        "content": "<p>and I can't see it's metadata... I'm only an admin, wth. permissions have changed?</p>",
        "id": 263519952,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1638491304
    },
    {
        "content": "<p>yes the hash is different when running on the server.</p>",
        "id": 263522312,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1638493214
    },
    {
        "content": "<p>Okay, so your local file and the one in cloud storage match,  and those are both  different from the file from the build pipeline today.</p>",
        "id": 263524050,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1638494423
    },
    {
        "content": "<p>If you just want to try clearing the cache you can merge the PR I just created</p>",
        "id": 263524228,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1638494551
    },
    {
        "content": "<p>( but obviously the file shouldn't be corrupted; it could of course be old...)</p>",
        "id": 263524252,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1638494571
    },
    {
        "content": "<p>I don't know if they match, I can't check. They are suppose to</p>",
        "id": 263524636,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1638494861
    },
    {
        "content": "<p>Were you unable to check the value in Google cloud storage? It should be publicly available.</p>",
        "id": 263525085,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1638495183
    },
    {
        "content": "<p>I can't access it at all, even logged in as administrator</p>",
        "id": 263525179,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1638495264
    },
    {
        "content": "<p>Well that would be a problem then.</p>",
        "id": 263525191,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1638495278
    },
    {
        "content": "<p>It seems the permissions have indeed been changed.</p>",
        "id": 263525251,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1638495323
    },
    {
        "content": "<p>I am getting the same error as you and I try to view the file even when authenticated. I tried giving myself explicit storage admin permissions in addition to owner permissions and still no dice.</p>",
        "id": 263525784,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1638495784
    },
    {
        "content": "<p>The whole thing is marked public for sure.</p>",
        "id": 263525789,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1638495793
    },
    {
        "content": "<p>It looks like the legacy roles no longer work the way they used to. I added another view all role for all users, which seems to have improved things.</p>",
        "id": 263526415,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1638496341
    },
    {
        "content": "<p>That said, my pull  request is failing way before the step where it tries to update the cash, so you might want to check out the compilation error.</p>",
        "id": 263526431,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1638496359
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 263526433,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1638496361
    },
    {
        "content": "<p>Well, my build succeeded after you made those changes, so that was it</p>",
        "id": 263528164,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1638498098
    },
    {
        "content": "<p>Thanks</p>",
        "id": 263528224,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1638498128
    }
]