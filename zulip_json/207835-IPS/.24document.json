[
    {
        "content": "<p>I've split up the Bundle example and posted it to <a href=\"https://server.fire.ly/\">https://server.fire.ly/</a>. It's possible to call $document on Composition/30551ce1-5a28-4356-b684-1e639094ad4d. <a href=\"https://server.fire.ly/Composition/30551ce1-5a28-4356-b684-1e639094ad4d/$document\">https://server.fire.ly/Composition/30551ce1-5a28-4356-b684-1e639094ad4d/$document</a> will contain the same resources as provided in the example Bundle <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 239273079,
        "sender_full_name": "Alexander Zautke",
        "timestamp": 1621351558
    },
    {
        "content": "<p>That's great.  I'm working on doing pretty much the same on my HAPI server.  Hopefully shouldn't be too long for that.</p>",
        "id": 239273426,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1621351676
    },
    {
        "content": "<p>When I try this server/composition combo in our Inferno IPS tests, I get a <code>415</code> error:</p>",
        "id": 239273879,
        "sender_full_name": "Michael O'Keefe",
        "timestamp": 1621351828
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>      &quot;severity&quot;: &quot;error&quot;,\n      &quot;code&quot;: &quot;not-supported&quot;,\n      &quot;details&quot;: {\n        &quot;coding&quot;: [\n          {\n            &quot;system&quot;: &quot;http://hl7.org/fhir/dotnet-api-operation-outcome&quot;,\n            &quot;code&quot;: &quot;5011&quot;\n          }\n        ],\n        &quot;text&quot;: &quot;Resource for Composition/30551ce1-5a28-4356-b684-1e639094ad4d was found but in a different informationmodel: Fhir4.0.&quot;\n      }\n    }```\n</code></pre></div>",
        "id": 239273888,
        "sender_full_name": "Michael O'Keefe",
        "timestamp": 1621351830
    },
    {
        "content": "<p>Specifically for <code>GET https://server.fire.ly/Composition/30551ce1-5a28-4356-b684-1e639094ad4d </code></p>",
        "id": 239273955,
        "sender_full_name": "Michael O'Keefe",
        "timestamp": 1621351853
    },
    {
        "content": "<p>It looks like it's because Inferno isn't adding <code>;fhirVersion=4.0</code> to the <code>Accept: application/fhir+json</code> header, so the server is thinking it should default to FHIR 3.0</p>",
        "id": 239274999,
        "sender_full_name": "Michael O'Keefe",
        "timestamp": 1621352241
    },
    {
        "content": "<p>I've added the FHIR version to the URL from <span class=\"user-mention\" data-user-id=\"193430\">@Alexander Zautke</span> so it looked like this:<br>\n<a href=\"https://server.fire.ly/r4/Composition/30551ce1-5a28-4356-b684-1e639094ad4d/$document\">https://server.fire.ly/r4/Composition/30551ce1-5a28-4356-b684-1e639094ad4d/$document</a><br>\nand it worked for me</p>",
        "id": 239276897,
        "sender_full_name": "Reinhard Egelkraut",
        "timestamp": 1621352959
    },
    {
        "content": "<p>Good idea. Let me give that a try</p>",
        "id": 239276930,
        "sender_full_name": "Michael O'Keefe",
        "timestamp": 1621352976
    },
    {
        "content": "<p>I took the base URL from conman and hoped for the best <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span></p>",
        "id": 239276992,
        "sender_full_name": "Reinhard Egelkraut",
        "timestamp": 1621353000
    },
    {
        "content": "<p>the Accept header is fine though, that does not cause any problems</p>",
        "id": 239277188,
        "sender_full_name": "Reinhard Egelkraut",
        "timestamp": 1621353055
    },
    {
        "content": "<p>Using the <code>/r4/</code> endpoint, I'm able to get tests to run</p>",
        "id": 239277252,
        "sender_full_name": "Michael O'Keefe",
        "timestamp": 1621353084
    },
    {
        "content": "<p><span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span></p>",
        "id": 239277328,
        "sender_full_name": "Reinhard Egelkraut",
        "timestamp": 1621353113
    },
    {
        "content": "<p>Here are the results of running the \"document operation tests\" in Inferno against <span class=\"user-mention\" data-user-id=\"193430\">@Alexander Zautke</span> 's server: <a href=\"https://inferno-qa.healthit.gov/community/bj3yeOxOqI3/test_sets/ad_hoc_testing/#IPSOperations/ad_hoc_testing_IPSOperations_IpsDocumentOperationSequence\">https://inferno-qa.healthit.gov/community/bj3yeOxOqI3/test_sets/ad_hoc_testing/#IPSOperations/ad_hoc_testing_IPSOperations_IpsDocumentOperationSequence</a></p>",
        "id": 239277406,
        "sender_full_name": "Michael O'Keefe",
        "timestamp": 1621353125
    },
    {
        "content": "<p>Oh, sorry. Yes, the server is running on STU3 by default. You need to add an Accept-Header with \"application/fhir+json; fhirVersion=4.0\" or use /r4 in the base url</p>",
        "id": 239277587,
        "sender_full_name": "Alexander Zautke",
        "timestamp": 1621353187
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"193430\">@Alexander Zautke</span> Does the server only support using GET for the $document operation? I get a 501 trying to do it with a POST. (abbreviated response below)</p>\n<div class=\"codehilite\"><pre><span></span><code>{\n  &quot;resourceType&quot;: &quot;OperationOutcome&quot;,\n  &quot;id&quot;: &quot;fa4fa726-1522-4b79-ac4e-52678f2db9a9&quot;,\n  &quot;issue&quot;: [\n    {\n      &quot;severity&quot;: &quot;warning&quot;,\n      &quot;code&quot;: &quot;not-supported&quot;,\n      &quot;diagnostics&quot;: &quot;/Composition&quot;\n    },\n    {\n      &quot;severity&quot;: &quot;warning&quot;,\n      &quot;code&quot;: &quot;not-supported&quot;,\n      &quot;diagnostics&quot;: &quot;/30551ce1-5a28-4356-b684-1e639094ad4d&quot;\n    },\n    {\n      &quot;severity&quot;: &quot;warning&quot;,\n      &quot;code&quot;: &quot;not-supported&quot;,\n      &quot;diagnostics&quot;: &quot;persist=true&quot;\n    }\n  ]\n}\n</code></pre></div>",
        "id": 239282452,
        "sender_full_name": "Stephen MacVicar",
        "timestamp": 1621354777
    },
    {
        "content": "<p>When I test against Alexander's server, I get (among others) this message: <code>Bundle.AllergyIntolerance[1]: AllergyIntolerance.code.coding[0].code: This element is not allowed by the profile http://hl7.org/fhir/uv/ips/StructureDefinition/CodeableConcept-uv-ips</code></p>",
        "id": 239284090,
        "sender_full_name": "Michael O'Keefe",
        "timestamp": 1621355380
    },
    {
        "content": "<p>One of the two <code>AllergyIntolerance</code> resources uses <code>no-known-food-allergies</code>, the other uses a SNOMED code that doesn't appear to be part of the required binding slice for <code>AllergyIntolerance.code</code>:</p>",
        "id": 239285044,
        "sender_full_name": "Michael O'Keefe",
        "timestamp": 1621355732
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>              &quot;system&quot;: &quot;http://snomed.info/sct&quot;,\n              &quot;code&quot;: &quot;373270004&quot;,\n              &quot;display&quot;: &quot;Substance with penicillin structure and antibacterial mechanism of action (substance)&quot;\n            }\n</code></pre></div>",
        "id": 239285049,
        "sender_full_name": "Michael O'Keefe",
        "timestamp": 1621355735
    },
    {
        "content": "<p>It's not necessary that the SNOMED code match one in the allergyIntoleranceGPSCode slice, as that code may be a legitimate SNOMED CT allergy code but <strong>not</strong> be one that is in the GPS.  The GPS slice is there to call attention to the GPS (and identify what codes are included in it, which may be important if you are in a non SNOMED member country).  But it doesn't restrict the codes used to only those that are in that slice, as the open slicing rule allows codes that don't match any of the ones in the slice to still be used.</p>",
        "id": 239286159,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1621356175
    },
    {
        "content": "<p>Hm. I guess I'm not sure then why the validator is complaining that <code>code.coding[0].code</code> isn't allowed?</p>",
        "id": 239286548,
        "sender_full_name": "Michael O'Keefe",
        "timestamp": 1621356329
    },
    {
        "content": "<p>I've seen that error show up before.  I think it might be due to an error in the profile (maybe?).  If there is a way that you can try it with the connecthon branch package, that might be instructive (and hopefully useful).</p>",
        "id": 239293982,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1621359127
    },
    {
        "content": "<p>Ok; I'll give that a try later today</p>",
        "id": 239299448,
        "sender_full_name": "Michael O'Keefe",
        "timestamp": 1621361317
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191405\">@Rob Hausam</span> I tried this with the conectathon branch package, and those errors went away.</p>",
        "id": 239302431,
        "sender_full_name": "Michael O'Keefe",
        "timestamp": 1621362415
    },
    {
        "content": "<p><a href=\"/user_uploads/10155/ZS6MBLTyOooFWpWGYMVWBcnk/Screen-Shot-2021-05-18-at-14.27.06.png\">Screen-Shot-2021-05-18-at-14.27.06.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/ZS6MBLTyOooFWpWGYMVWBcnk/Screen-Shot-2021-05-18-at-14.27.06.png\" title=\"Screen-Shot-2021-05-18-at-14.27.06.png\"><img src=\"/user_uploads/10155/ZS6MBLTyOooFWpWGYMVWBcnk/Screen-Shot-2021-05-18-at-14.27.06.png\"></a></div>",
        "id": 239302508,
        "sender_full_name": "Michael O'Keefe",
        "timestamp": 1621362444
    },
    {
        "content": "<p>Excellent!</p>",
        "id": 239311483,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1621365981
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191647\">@Michael O'Keefe</span> I've fixed the issue for DO-02 (can't deploy it unfortunately). The other issues are not related to the server, right? Do you see an error in the composition?</p>",
        "id": 239322076,
        "sender_full_name": "Alexander Zautke",
        "timestamp": 1621370364
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"193430\">@Alexander Zautke</span> I believe you are correct that the other issues are related to us sending some of the resources to the validator without their referenced resources. I don't think they are actual composition-related errors</p>",
        "id": 239322475,
        "sender_full_name": "Michael O'Keefe",
        "timestamp": 1621370519
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191405\">@Rob Hausam</span> Can you give me an Composition ID that I can test $document operation?</p>",
        "id": 239322536,
        "sender_full_name": "Yunwei Wang",
        "timestamp": 1621370533
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"193430\">@Alexander Zautke</span> I rerun test using my local dev branch. There are two issues found: <br>\n<a href=\"/user_uploads/10155/OiwqmDQhEVYj7MtbpOPCt7ki/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/OiwqmDQhEVYj7MtbpOPCt7ki/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/OiwqmDQhEVYj7MtbpOPCt7ki/image.png\"></a></div>",
        "id": 239323201,
        "sender_full_name": "Yunwei Wang",
        "timestamp": 1621370827
    },
    {
        "content": "<p>Test it on which server, <span class=\"user-mention\" data-user-id=\"191506\">@Yunwei Wang</span>?  I'm working to have instances (at least one) available for that on my server, but I haven't yet been able to load the individual resources via a transaction bundle - for some reason that is giving an error right now and I'm trying to track that down.  I can post them individually, but that will take me a little longer.</p>",
        "id": 239323319,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1621370870
    },
    {
        "content": "<p>Here's a Postman collection to validate and create the individual resources<br>\n<a href=\"/user_uploads/10155/FQJZnPwDkiAe9oiztdKd4SyO/IPS.postman_collection.json\">IPS.postman_collection.json</a></p>",
        "id": 239323653,
        "sender_full_name": "Alexander Zautke",
        "timestamp": 1621371000
    },
    {
        "content": "<p>Went down that path today :D</p>",
        "id": 239323736,
        "sender_full_name": "Alexander Zautke",
        "timestamp": 1621371024
    },
    {
        "content": "<p>Oh no problem. I have run tests on both <span class=\"user-mention\" data-user-id=\"193430\">@Alexander Zautke</span> and <span class=\"user-mention\" data-user-id=\"191364\">@Peter Jordan</span></p>",
        "id": 239323765,
        "sender_full_name": "Yunwei Wang",
        "timestamp": 1621371032
    },
    {
        "content": "<p>I should have something for you shortly.</p>",
        "id": 239324764,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1621371435
    },
    {
        "content": "<p>The HAPI server is choking on the Observation 2639657a-c19a-48e2-82cc-471e13b8ad94.  All the other supporting resources are created fine (I haven't created the Composition yet), but this one errors out with that same \"Index 0 out of bounds for length 0\"error that I mentioned before with the transaction bundle.  But it validates just fine with the FHIR validator.  So I still need to figure out what's going on with it.</p>",
        "id": 239329985,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1621373839
    },
    {
        "content": "<p>At least I know for sure where the error is coming from now.</p>",
        "id": 239330079,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1621373885
    },
    {
        "content": "<p>And now I know what the error is - it appears to be a HAPI server bug!  The HAPI server will not let me PUT (or POST) the Observation resource with a CodeableConcept containing 'text' only:</p>\n<div class=\"codehilite\"><pre><span></span><code>    &quot;code&quot;: {\n        &quot;text&quot;: &quot;Blood typing&quot;\n    },\n</code></pre></div>\n<p>That causes the error, even though it's perfectly valid in the base FHIR spec and the IPS IG, and it passes the Java validator just fine.  If I add a 'coding' in the datatype then the resource is created without a problem.</p>",
        "id": 239334020,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1621375975
    },
    {
        "content": "<p>So now you can test $document on my server with <a href=\"http://Composition.id\">Composition.id</a> = 30551ce1-5a28-4356-b684-1e639094ad4d (but that one Observation is just slightly different).</p>",
        "id": 239334299,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1621376149
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191405\">@Rob Hausam</span>  I run an Inferno test on your server. There are two issues. One is that Bundle.entry does not have fullUrl. The other one is one Observation entry does not have value</p>",
        "id": 239389856,
        "sender_full_name": "Yunwei Wang",
        "timestamp": 1621415168
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191506\">@Yunwei Wang</span> I will look at the details between now and our 10:30 UTC session.  I think the second one is probably as it is intended - and if so, we should discuss.</p>",
        "id": 239397466,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1621419001
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191405\">@Rob Hausam</span> We figured out the issue that was causing the <code>$document</code> operation to fail on your server when we used POST. The http library we're using was silently adding a <code>Content-Type</code> header.  So it's a problem on our end rather than your end.</p>",
        "id": 239435613,
        "sender_full_name": "Stephen MacVicar",
        "timestamp": 1621435106
    },
    {
        "content": "<p>Ah, good.  I'm glad you figured out.  I has also been able to confirm that it did work for me using Postman.</p>",
        "id": 239436219,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1621435321
    },
    {
        "content": "<p>.. general question .. a conformant server offering the $document operation shall or may support persistency and graph definitions ?</p>",
        "id": 239545061,
        "sender_full_name": "Giorgio Cangioli",
        "timestamp": 1621494890
    },
    {
        "content": "<p>Both parameters are optional: <a href=\"https://www.hl7.org/fhir/composition-operation-document.html\">https://www.hl7.org/fhir/composition-operation-document.html</a></p>",
        "id": 239545589,
        "sender_full_name": "Alexander Zautke",
        "timestamp": 1621495257
    },
    {
        "content": "<p>I see, my question is how optionality should be interpreted : is optional for the consumer (you are not required to send them) or for both (the server is not expected to support all of the parameters)</p>",
        "id": 239551782,
        "sender_full_name": "Giorgio Cangioli",
        "timestamp": 1621498385
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191506\">@Yunwei Wang</span>  I tried the IPS $document validation. The report (<a href=\"https://inferno-qa.healthit.gov/community/Ct1lvqcjUW/\">https://inferno-qa.healthit.gov/community/Ct1lvqcjUW/</a>) includes several validation errors (..missing parts..). <br>\nI tried also to validate the IPS bundle returned by the same operation, saved on a file, with the Inferno tool and the only returned error is the well-known one with the ATC code. <br>\nare the two tools using different validators ?</p>",
        "id": 239559797,
        "sender_full_name": "Giorgio Cangioli",
        "timestamp": 1621502702
    },
    {
        "content": "<p>can an IG make them required? I am not sure if there is a mechanism like with resources (profiles) for operations.</p>",
        "id": 239571084,
        "sender_full_name": "John Moehrke",
        "timestamp": 1621508564
    },
    {
        "content": "<p>I see other errors when I try to validate that bundle at <a href=\"https://inferno-qa.healthit.gov/validator\">https://inferno-qa.healthit.gov/validator</a><br>\nDid you select the IPS Bundle profile under advanced options?</p>",
        "id": 239581439,
        "sender_full_name": "Stephen MacVicar",
        "timestamp": 1621513594
    },
    {
        "content": "<p>I used <a href=\"https://inferno.healthit.gov/\">https://inferno.healthit.gov/</a> with the IPS package selected this is the only Validation error:<br>\nBundle.entry[21].resource.ofType(AllergyIntolerance).code.coding[0]: The code \"J01CA\" is not valid in the system <a href=\"http://www.whocc.no/atc\">http://www.whocc.no/atc</a>; The code provided (<a href=\"http://www.whocc.no/atc#J01CA\">http://www.whocc.no/atc#J01CA</a>) is not valid in the value set 'All codes known to the system' (from <a href=\"http://tx.fhir.org/r4\">http://tx.fhir.org/r4</a>) for '<a href=\"http://www.whocc.no/atc#J01CA\">http://www.whocc.no/atc#J01CA</a>' on line 1. Jump to error.</p>",
        "id": 239592204,
        "sender_full_name": "Giorgio Cangioli",
        "timestamp": 1621517794
    },
    {
        "content": "<p>same result if I use directly the java validator</p>",
        "id": 239592638,
        "sender_full_name": "Giorgio Cangioli",
        "timestamp": 1621517976
    },
    {
        "content": "<p><a href=\"http://inferno-qa.healthit.gov\">inferno-qa.healthit.gov</a> and <a href=\"http://inferno.healthit.gov\">inferno.healthit.gov</a> are not necessarily using the same version of the validator.<br>\nUsing the validator on <a href=\"http://inferno-qa.healthit.gov\">inferno-qa.healthit.gov</a>, I get the following error:</p>\n<blockquote>\n<p>Bundle: Bundle.entry:composition: minimum required = 1, but only found 0 (from <a href=\"http://hl7.org/fhir/uv/ips/StructureDefinition/Bundle-uv-ips\">http://hl7.org/fhir/uv/ips/StructureDefinition/Bundle-uv-ips</a>) on line 1.</p>\n</blockquote>",
        "id": 239592870,
        "sender_full_name": "Stephen MacVicar",
        "timestamp": 1621518058
    },
    {
        "content": "<p>no differences with <a href=\"https://inferno-qa.healthit.gov/\">https://inferno-qa.healthit.gov/</a></p>",
        "id": 239592907,
        "sender_full_name": "Giorgio Cangioli",
        "timestamp": 1621518074
    },
    {
        "content": "<p>So is that what we are expecting/wanting?</p>",
        "id": 239593093,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1621518140
    },
    {
        "content": "<p>mmhh...that means that the object retrieved using the ARC client is not the same of that obtained and processed by the validator...</p>",
        "id": 239593185,
        "sender_full_name": "Giorgio Cangioli",
        "timestamp": 1621518177
    },
    {
        "content": "<p>I think I'm not quite following all of this discussion.  Remind me what the ARC client is?  We can also do something about resolving the  'code \"J01CA\" is not valid' error.  I can add support for that (and whatever other ATC codes that we know we need at the moment) to <a href=\"http://tx.fhir.org\">tx.fhir.org</a>.</p>",
        "id": 239594374,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1621518619
    },
    {
        "content": "<p>..ARC is just another REST Client..</p>",
        "id": 239594579,
        "sender_full_name": "Giorgio Cangioli",
        "timestamp": 1621518710
    },
    {
        "content": "<p>for the ATC code I'll send to you the missing codes</p>",
        "id": 239594825,
        "sender_full_name": "Giorgio Cangioli",
        "timestamp": 1621518823
    },
    {
        "content": "<p>When I try to validate just the Composition from the Bundle, I get errors. Which means that it doesn't fit the profile, so it doesn't satisfy the condition for the composition slice of the Bundle. So it seems like a valid error to me.</p>",
        "id": 239596436,
        "sender_full_name": "Stephen MacVicar",
        "timestamp": 1621519376
    },
    {
        "content": "<p>The only way that you could successfully validate the Composition independently is if the validator is able to resolve all of the section.entry references and can check the referred to resource instances to determine if all of the profile constraints are being satisfied  - which I don't believe will be possible.  That's why we would validate the Composition as part of the entire bundle.</p>",
        "id": 239598288,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1621520030
    },
    {
        "content": "<p>Hello <span class=\"user-mention\" data-user-id=\"191415\">@Giorgio Cangioli</span> The inferno-qa server is not updated to the latest fix yet. There is a problem for the current Composition validation. When Inferno test the receiving bundle, it validates each entry of the bundle individually. That is fine for all entry except Composition since Composition has some mandatory section.reference values with specific profiles (slicing by profile). Validator could not validates those references with Composition itself only. We have a fix for that but it is on my dev branch and not merged to deployment branch yet. We will complete the code reviews and deployment hopefully this or next week. I will let you know when that is done.</p>",
        "id": 239610398,
        "sender_full_name": "Yunwei Wang",
        "timestamp": 1621524213
    },
    {
        "content": "<p>Great ! <br>\nI'd like to advertise inferno in my affiliate, let me know when I should do it</p>",
        "id": 239618784,
        "sender_full_name": "Giorgio Cangioli",
        "timestamp": 1621527337
    }
]