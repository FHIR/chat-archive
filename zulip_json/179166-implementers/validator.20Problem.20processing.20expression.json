[
    {
        "content": "<p>Hi everyone,<br>\nI am using the validator_cli.jar in my programm to validate bundles and redownloaded it about an hour ago from the confluence page, so it should be the most recent one.<br>\nBut there appears to be a problem with the address.country attribute.<br>\nIf I remove the country from all addresses, I get a normal output with errors/warnings/informations. <br>\nHowevery if there is an address.country attribute somewhere in the bundle the validation fails with the following output:</p>\n<p>$ java -jar validator_cli.jar E:/git/validator/toValidate/composition.json -version 4.0 -ig hl7.fhir.uv.ips<br>\nFHIR Validation tool Version 5.1.6 (Git# 7349ad1f0e25). Built 2020-08-27T08:10:25.221Z (51 hours old)<br>\nDetected Java version: 1.8.0_242 from C:\\Program Files\\Amazon Corretto\\jdk1.8.0_242\\jre on amd64 (64bit). 3628MB available<br>\nArguments: E:/git/validator/toValidate/composition.json -version 4.0 -ig hl7.fhir.uv.ips<br>\nDirectories: Current = E:\\git\\validator, Package Cache = C:\\Users\\Niklas\\.fhir\\packages<br>\n  .. FHIR Version 4.0, definitions from hl7.fhir.r4.core#4.0.1<br>\n  .. connect to tx server @ <a href=\"http://tx.fhir.org\">http://tx.fhir.org</a><br>\n    (v4.0.1)</p>\n<ul>\n<li>.. load IG from hl7.fhir.uv.ips<br>\n  .. validate [E:/git/validator/toValidate/composition.json]<br>\nValidation Infrastructure fail validating E:/git/validator/toValidate/composition.json: Problem processing expression IF country NOT IN <a href=\"http://hl7.org/fhir/ValueSet/iso3166-1-2\">http://hl7.org/fhir/ValueSet/iso3166-1-2</a> THEN country IN <a href=\"http://hl7.org/fhir/ValueSet/iso3166-1-3\">http://hl7.org/fhir/ValueSet/iso3166-1-3</a> in profile <a href=\"http://hl7.org/fhir/uv/ips/StructureDefinition/Patient-uv-ips\">http://hl7.org/fhir/uv/ips/StructureDefinition/Patient-uv-ips</a> path Bundle.entry[1].resource.ofType(Patient).address[0].country: Error in ?? at 1, 2: Premature ExpressionNode termination at unexpected token \"country\"<br>\nException in thread \"main\" org.hl7.fhir.exceptions.FHIRException: org.hl7.fhir.exceptions.FHIRException: Problem processing expression IF country NOT IN <a href=\"http://hl7.org/fhir/ValueSet/iso3166-1-2\">http://hl7.org/fhir/ValueSet/iso3166-1-2</a> THEN country IN <a href=\"http://hl7.org/fhir/ValueSet/iso3166-1-3\">http://hl7.org/fhir/ValueSet/iso3166-1-3</a> in profile <a href=\"http://hl7.org/fhir/uv/ips/StructureDefinition/Patient-uv-ips\">http://hl7.org/fhir/uv/ips/StructureDefinition/Patient-uv-ips</a> path Bundle.entry[1].resource.ofType(Patient).address[0].country: Error in ?? at 1, 2: Premature ExpressionNode termination at unexpected token \"country\"<br>\n        at org.hl7.fhir.validation.ValidationEngine.validate(ValidationEngine.java:1266)<br>\n        at org.hl7.fhir.validation.cli.services.ValidationService.validateSources(ValidationService.java:73)<br>\n        at org.hl7.fhir.validation.Validator.main(Validator.java:210)<br>\nCaused by: org.hl7.fhir.exceptions.FHIRException: Problem processing expression IF country NOT IN <a href=\"http://hl7.org/fhir/ValueSet/iso3166-1-2\">http://hl7.org/fhir/ValueSet/iso3166-1-2</a> THEN country IN <a href=\"http://hl7.org/fhir/ValueSet/iso3166-1-3\">http://hl7.org/fhir/ValueSet/iso3166-1-3</a> in profile <a href=\"http://hl7.org/fhir/uv/ips/StructureDefinition/Patient-uv-ips\">http://hl7.org/fhir/uv/ips/StructureDefinition/Patient-uv-ips</a> path Bundle.entry[1].resource.ofType(Patient).address[0].country: Error in ?? at 1, 2: Premature ExpressionNode termination at unexpected token \"country\"<br>\n        at org.hl7.fhir.validation.instance.InstanceValidator.checkInvariant(InstanceValidator.java:4574)<br>\n        at org.hl7.fhir.validation.instance.InstanceValidator.checkInvariants(InstanceValidator.java:4524)<br>\n        at org.hl7.fhir.validation.instance.InstanceValidator.checkInvariants(InstanceValidator.java:4415)<br>\n        at org.hl7.fhir.validation.instance.InstanceValidator.checkChild(InstanceValidator.java:4061)<br>\n        at org.hl7.fhir.validation.instance.InstanceValidator.validateElement(InstanceValidator.java:3931)<br>\n        at org.hl7.fhir.validation.instance.InstanceValidator.checkChild(InstanceValidator.java:4200)<br>\n        at org.hl7.fhir.validation.instance.InstanceValidator.validateElement(InstanceValidator.java:3931)<br>\n        at org.hl7.fhir.validation.instance.InstanceValidator.startInner(InstanceValidator.java:3674)<br>\n        at org.hl7.fhir.validation.instance.InstanceValidator.start(InstanceValidator.java:3585)<br>\n        at org.hl7.fhir.validation.instance.InstanceValidator.validateResource(InstanceValidator.java:4657)<br>\n        at org.hl7.fhir.validation.instance.InstanceValidator.validateContains(InstanceValidator.java:3831)<br>\n        at org.hl7.fhir.validation.instance.InstanceValidator.checkChild(InstanceValidator.java:4102)<br>\n        at org.hl7.fhir.validation.instance.InstanceValidator.validateElement(InstanceValidator.java:3931)<br>\n        at org.hl7.fhir.validation.instance.InstanceValidator.checkChild(InstanceValidator.java:4119)<br>\n        at org.hl7.fhir.validation.instance.InstanceValidator.validateElement(InstanceValidator.java:3931)<br>\n        at org.hl7.fhir.validation.instance.InstanceValidator.startInner(InstanceValidator.java:3674)<br>\n        at org.hl7.fhir.validation.instance.InstanceValidator.start(InstanceValidator.java:3561)<br>\n        at org.hl7.fhir.validation.instance.InstanceValidator.validateResource(InstanceValidator.java:4657)<br>\n        at org.hl7.fhir.validation.instance.InstanceValidator.validate(InstanceValidator.java:688)<br>\n        at org.hl7.fhir.validation.instance.InstanceValidator.validate(InstanceValidator.java:541)<br>\n        at org.hl7.fhir.validation.ValidationEngine.validate(ValidationEngine.java:1355)<br>\n        at org.hl7.fhir.validation.ValidationEngine.validate(ValidationEngine.java:1259)<br>\n        ... 2 more</li>\n</ul>\n<p>The problem appears to be the expression, that is used to validate the attribute.<br>\nDoes anyone know a way to fix this?</p>\n<p>Thanks for your attention,<br>\nNiklas</p>",
        "id": 208430652,
        "sender_full_name": "Niklas Haldorn",
        "timestamp": 1598702968
    },
    {
        "content": "<p>It seems that the invariant it's complaining about in your build is different than the text of the current invariant.  <span class=\"user-mention\" data-user-id=\"191405\">@Rob Hausam</span></p>",
        "id": 208437328,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1598712412
    },
    {
        "content": "<p>I can't reproduce this. I use the bundle example from the current specification, and validated like so</p>\n<p><code>[jar] -version 4.0 C:\\temp\\ips.json -ig hl7.fhir.uv.ips</code>:</p>\n<div class=\"codehilite\"><pre><span></span><code>FHIR Validation tool Version 5.0.7-SNAPSHOT (Git# 6bc790d98b04). Built 2020-06-07T08:35:37.25+10:00 (84 days old)\nDetected Java version: 1.8.0_251 from C:\\Program Files\\Java\\jre1.8.0_251 on amd64 (64bit). 14526MB available\nArguments: -version 4.0 C:\\temp\\ips.json -ig hl7.fhir.uv.ips\nDirectories: Current = c:\\temp, Package Cache = C:\\Users\\graha\\.fhir\\packages\n  .. FHIR Version 4.0, definitions from hl7.fhir.r4.core#4.0.1\n  .. connect to tx server @ http://tx.fhir.org\n    (v4.0.1)\n+  .. load IG from hl7.fhir.uv.ips\nInstalling hl7.fhir.uv.ips#0.3.0 to the package cache\n  Fetching:..\n  Installing: .. done.\n  .. validate [C:\\temp\\ips.json]\n[main] INFO org.hl7.fhir.utilities.cache.BasePackageCacheManager - Failed to resolve package hl7.terminology#2.7 from server: http://packages.fhir.org\n[main] INFO org.hl7.fhir.utilities.cache.BasePackageCacheManager - Failed to resolve package hl7.terminology#2.7 from server: http://packages2.fhir.org/packages\nInstalling hl7.terminology#2.7 to the package cache\n  Fetching:*FAILURE* validating C:\\temp\\ips.json:  error:1 warn:3 info:6\n  Error @ Bundle.entry[2].resource.ofType(Practitioner).qualification[0].code.coding[0].system (line 340, col81) : URL value &#39;http://terminology.hl7.org/CodeSystem/v2-0360|2.7&#39; does not resolve\n  Information @ Bundle.entry[4].resource.ofType(Condition).severity (line 430, col22) : None of the codes provided are in the value set http://hl7.org/fhir/ValueSet/condition-severity (http://hl7.org/fhir/ValueSet/condition-severity), and a code is recommended to come from this value set) (codes = http://loinc.org#LA6751-7)\n  Information @ Bundle.entry[10].resource.ofType(Condition).severity (line 753, col22) : None of the codes provided are in the value set http://hl7.org/fhir/ValueSet/condition-severity (http://hl7.org/fhir/ValueSet/condition-severity), and a code is recommended to come from this value set) (codes = http://loinc.org#LA6750-9)\n  Information @ Bundle.entry[0].resource.ofType(Composition).author[0] (line 40, col12) : Details for Practitioner/1c616b24-3895-48c4-9a02-9a64110351ef matching against Profilehttp://hl7.org/fhir/StructureDefinition/Practitioner\n  Information @ Bundle.entry[0].resource.ofType(Composition).attester[0].party (line 52, col14) : Details for Practitioner/1c616b24-3895-48c4-9a02-9a64110351ef matching against Profilehttp://hl7.org/fhir/StructureDefinition/Practitioner\n  Information @ Bundle.entry[7].resource.ofType(Medication).code.coding[1] (line 597, col14) : Code System URI &#39;urn:oid:2.16.840.1.113883.2.4.4.1&#39; is unknown so the code cannot be validated\n  Information @ Bundle.entry[7].resource.ofType(Medication).code.coding[2] (line 602, col14) : Code System URI &#39;urn:oid:2.16.840.1.113883.2.4.4.7&#39; is unknown so the code cannot be validated\n  Warning @ Bundle.entry[1].resource.ofType(Patient).contact[0].relationship[0] (line 274, col16) : None of the codes provided are in the value set http://hl7.org/fhir/ValueSet/patient-contactrelationship (http://hl7.org/fhir/ValueSet/patient-contactrelationship), and a code should come from this value set unless it has no suitable code) (codes = http://terminology.hl7.org/CodeSystem/v3-RoleCode#MTH)\n  Warning @ Bundle.entry[4].resource.ofType(Condition).category[0] (line 419, col12) : None of the codes provided are in the value set http://hl7.org/fhir/ValueSet/condition-category (http://hl7.org/fhir/ValueSet/condition-category), and a code should come from this value set unless it has no suitable code) (codes = http://loinc.org#75326-9)\n  Warning @ Bundle.entry[10].resource.ofType(Condition).category[0] (line 742, col12) : None of the codes provided are in the value set http://hl7.org/fhir/ValueSet/condition-category (http://hl7.org/fhir/ValueSet/condition-category), and a code should come from this value set unless it has no suitable code) (codes = http://loinc.org#75326-9)\n</code></pre></div>",
        "id": 208505076,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1598822955
    },
    {
        "content": "<p>Does the validator use the meta.profile Attribute to choose which profile to validate against? <br>\nBecause the error occurs when trying to validate a patient resource against the Patient(IPS) profile, but the patient in the ips bundle example has no meta.profile attribute.<br>\nIf the attribute is added and set to the Patient(IPS) profiles official URL (\"<a href=\"http://hl7.org/fhir/uv/ips/StructureDefinition/Patient-uv-ips\">http://hl7.org/fhir/uv/ips/StructureDefinition/Patient-uv-ips</a>\")  the validation fails with the same error.</p>",
        "id": 208534216,
        "sender_full_name": "Niklas Haldorn",
        "timestamp": 1598864526
    },
    {
        "content": "<p>It does, so that is possibly the cause. do you want to post the bundle you are validating? (or just send it to me directly)</p>",
        "id": 208537282,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1598866872
    },
    {
        "content": "<p>It does, so that is possibly the cause. do you want to post the bundle you are validating? (or just send it to me directly)</p>",
        "id": 208537330,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1598866921
    },
    {
        "content": "<p><a href=\"/user_uploads/10155/RywhA3DvYJeHvMvkDQJ6VeUt/composition_test.json\">composition_test.json</a></p>",
        "id": 208543677,
        "sender_full_name": "Niklas Haldorn",
        "timestamp": 1598871939
    },
    {
        "content": "<p>The problem appears to be caused by an older ips version. I checked my FHIR package cache and realised there was an hl7.fhir.uv.ips#0.3.0 folder and an hl7.fhir.uv.ips#1.0.0 folder, so I deleted both to check which one the validator is using. If I start the validator with  -ig hl7.fhir.uv.ips, it downloads hl7.fhir.uv.ips#0.3.0 and the validation fails. However if I explicitly use the current version and start the validator with  -ig hl7.fhir.uv.ips#1.0.0 or hl7.fhir.uv.ips#current it works.</p>",
        "id": 209486942,
        "sender_full_name": "Niklas Haldorn",
        "timestamp": 1599642045
    },
    {
        "content": "<p>is this still a problem with the current validator?</p>",
        "id": 209968675,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1600064773
    },
    {
        "content": "<p>It still happens. If the validator is started with <a href=\"http://hl7.org/fhir/uv/ips/\">http://hl7.org/fhir/uv/ips/</a> , hl7.fhir.uv.ips#1.0.0 or hl7.fhir.uv.ips#current as ig it works, but with hl7.fhir.uv.ips it downloads hl7.fhir.uv.ips#0.3.0 and the validation fails. But I as far as I understand it, the validator is behaving correctly and the problem is caused by the ig.  I checked the entries on <a href=\"https://registry.fhir.org/package/hl7.fhir.uv.ips|0.3.0\">https://registry.fhir.org/package/hl7.fhir.uv.ips|0.3.0</a> and the simplifier package list and both show 0.3.0 as latest version, so the validator validates against the currenty published version, when no version is specified.</p>",
        "id": 209980393,
        "sender_full_name": "Niklas Haldorn",
        "timestamp": 1600074642
    }
]