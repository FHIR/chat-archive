[
    {
        "content": "<p>I'm working on implementing validation against StructureDefinitions. One thing I'm finding confusing is how cardinality affects the evaluation of  pattern/fixed constraints. Looking at the <a href=\"https://confluence.hl7.org/display/FHIR/Using+the+FHIR+Validator\">Java FHIR validator</a>. It seems that for non-slices: min: 0 and fixed fails on an empty field; min: 0 and pattern does not fail on an empty field. It seems like they should both fail, but the slicing case is more confusing. An empty slice doesn't fail for pattern or fixed on an empty field. This makes sense intuitively, if a slice is allowed to be empty then we shouldn't check the pattern rules. But we do check them if it's not a slice, which makes actually implementing these rules confusing. So the question is why does it pass when the slice is empty? Is it because we don't run any rules on an empty slice? Or is it something more specialized, like we should not recheck the discriminator rule specifically? If there was a binding in addition to the pattern/fixed does that get run? I think the easiest way to implement this is \"when evaluating slice rules, if the slice is empty don't check any of the other rules in the slice definition\", but I want to make sure I'm not missing an edge case</p>",
        "id": 204453287,
        "sender_full_name": "Nik Klassen",
        "timestamp": 1595267376
    },
    {
        "content": "<p>My (non-authoritative) interpretation:</p>\n<p>Non-Sliced:</p>\n<ul>\n<li>pattern is a check against a present value; since <code>min: 0</code> means the field is optional, the pattern isn't tested and a missing value passes.</li>\n<li>fixed is a check that the exact value is present - even though the value is optional, the required value isn't present and it fails.</li>\n</ul>\n<p>Slicing is more complicated, because slicing =).</p>\n<ul>\n<li>If the slice is required and <code>slicing.rules = closed</code> (assuming the correct value is present somewhere else), it should fail (invalid value).</li>\n<li>If the slice is required and not present (regardless of open/closed), it should fail (required slice not found).</li>\n<li>If the slice is defined but not required, it should pass.</li>\n</ul>",
        "id": 204456261,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1595268839
    },
    {
        "content": "<p>Everything here matches my understanding, except the first point. The spec says  \"pattern[x]: Specifies a value that the value in the instance SHALL follow - that is, any value in the pattern must be found in the instance.\" <em>the value in the instance</em> says to me that there must be an instance to check against.</p>",
        "id": 204461819,
        "sender_full_name": "Nik Klassen",
        "timestamp": 1595271666
    },
    {
        "content": "<blockquote>\n<p>It seems that for non-slices: min: 0 and fixed fails on an empty field; min: 0 and pattern does not fail on an empty field</p>\n</blockquote>\n<p>That's certainly surprising to me</p>",
        "id": 204473253,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1595277531
    },
    {
        "content": "<p>do you have your test cases?</p>",
        "id": 204473261,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1595277538
    },
    {
        "content": "<p>I used the ElementDefinition</p>\n<div class=\"codehilite\"><pre><span></span><code>{\n  &quot;path&quot;: &quot;Patient.identifier&quot;,\n  &quot;id&quot;: &quot;Patient.identifier&quot;,\n  &quot;min&quot;: 0,\n  &quot;max&quot;: &quot;*&quot;,\n  &quot;base&quot;: {\n    &quot;min&quot;: 0,\n    &quot;max&quot;: &quot;*&quot;\n  },\n  &quot;patternIdentifier&quot;: {\n    &quot;use&quot;: &quot;usual&quot;\n  }\n}\n</code></pre></div>\n\n\n<p>with an empty Patient. It may be that using a StructureDefinition this minimal isn't expected to work. <a href=\"/user_uploads/10155/caFofv-aKCkEtxwF3UBbs6zR/sd.json\">sd.json</a> <a href=\"/user_uploads/10155/3rVak-sng2eotdg5sf983rac/patient.json\">patient.json</a></p>",
        "id": 204579335,
        "sender_full_name": "Nik Klassen",
        "timestamp": 1595353554
    },
    {
        "content": "<p>I moved this discussion to <a href=\"#narrow/stream/179177-conformance/topic/fixed.2Fpattern.20on.20min.20.3D.200\">https://chat.fhir.org/#narrow/stream/179177-conformance/topic/fixed.2Fpattern.20on.20min.20.3D.200</a> for ease of focus</p>",
        "id": 204613456,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1595372894
    }
]