[
    {
        "content": "<p>I am trying to convert a STU3 StructureDefinition to R4 with the Java validator. Not sure I am doing it correctly, as I am getting the below error. Any help or pointers would be great!</p>\n<div class=\"codehilite\"><pre><span></span><code>PS C:\\git\\java-validator-transform&gt; java -jar validator_cli.jar zib-AllergyIntolerance.xml -output output-zib-AllergyIntolerance.xml -transform http://hl7.org/fhir/StructureMap/StructureDefinition3to4 -version 3.0 -ig hl7.fhir.xver.r4#1.2.0\n</code></pre></div>\n\n\n<div class=\"codehilite\"><pre><span></span><code>FHIR Validation tool Version 5.1.15 (Git# 5bb59c3b8265). Built 2020-09-26T00:16:14.10Z (4 days old)\n  Java:   1.8.0_241 from C:\\Program Files\\Java\\jre1.8.0_241 on amd64 (64bit). 3616MB available\n  Paths:  Current = C:\\git\\java-validator-transform, Package Cache = C:\\Users\\Ardon\\.fhir\\packages\n  Params: zib-AllergyIntolerance.xml -output output-zib-AllergyIntolerance.xml -transform http://hl7.org/fhir/StructureMap/StructureDefinition3to4 -version 3.0 -ig hl7.fhir.xver.r4#1.2.0\nLoading\n  Load FHIR v3.0 from hl7.fhir.r3.core#3.0.2 - 4017 resources (00:04.0215)\n  Terminology server http://tx.fhir.org - Version 1.0.353 (00:02.0194)\n  Load hl7.fhir.xver.r4#1.2.0 - 2327 resources (00:10.0589)\n  Get set...  go (00:00.0047)\n ...Failure: null\njava.lang.NullPointerException\n        at java.io.FileOutputStream.&lt;init&gt;(Unknown Source)\n        at java.io.FileOutputStream.&lt;init&gt;(Unknown Source)\n        at java.io.PrintWriter.&lt;init&gt;(Unknown Source)\n        at org.hl7.fhir.validation.ValidationEngine.setMapLog(ValidationEngine.java:1602)\n        at org.hl7.fhir.validation.cli.services.ValidationService.transform(ValidationService.java:152)\n        at org.hl7.fhir.validation.Validator.main(Validator.java:192)\nDone. Times: Loading: 00:17.0303\n</code></pre></div>",
        "id": 211848655,
        "sender_full_name": "Ardon Toonstra",
        "timestamp": 1601505252
    },
    {
        "content": "<p>fixed next release</p>",
        "id": 211860632,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1601516593
    },
    {
        "content": "<p>I wasn't aware of that feature - thats awesome!</p>",
        "id": 211875825,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1601536450
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span>  Thanks. The next releases fixed that issue. But I run into another one (it now started with the transform). The same issue happens wilt multiple profiles, with and without snapshot.</p>\n<div class=\"codehilite\"><pre><span></span><code>PS C:\\git\\java-validator-transform&gt; java -jar validator_cli.jar zib-AllergyIntolerance.xml -output output-zib-AllergyIntolerance.xml -transform http://hl7.org/fhir/StructureMap/StructureDefinition3to4 -version 3.0 -ig hl7.fhir.xver.r4#1.2.0\nFHIR Validation tool Version 5.1.16 (Git# ea0b4c0c1c10). Built 2020-10-01T04:39:09.65Z (4 days old)\n  Java:   1.8.0_241 from C:\\Program Files\\Java\\jre1.8.0_241 on amd64 (64bit). 3616MB available\n  Paths:  Current = C:\\git\\java-validator-transform, Package Cache = C:\\Users\\Ardon\\.fhir\\packages\n  Params: zib-AllergyIntolerance.xml -output output-zib-AllergyIntolerance.xml -transform http://hl7.org/fhir/StructureMap/StructureDefinition3to4 -version 3.0 -ig hl7.fhir.xver.r4#1.2.0\n</code></pre></div>\n\n\n<div class=\"codehilite\"><pre><span></span><code>Exception in thread &quot;main&quot; java.lang.Error: Unrecognised name valueSet on binding\n        at org.hl7.fhir.r5.elementmodel.Element.makeProperty(Element.java:456)\n        at org.hl7.fhir.r5.utils.StructureMapUtilities.processTarget(StructureMapUtilities.java:1859)\n        at org.hl7.fhir.r5.utils.StructureMapUtilities.executeRule(StructureMapUtilities.java:1435)\n        at org.hl7.fhir.r5.utils.StructureMapUtilities.executeGroup(StructureMapUtilities.java:1422)\n        at org.hl7.fhir.r5.utils.StructureMapUtilities.executeDependency(StructureMapUtilities.java:1481)\n        at org.hl7.fhir.r5.utils.StructureMapUtilities.executeRule(StructureMapUtilities.java:1443)\n        at org.hl7.fhir.r5.utils.StructureMapUtilities.executeGroup(StructureMapUtilities.java:1422)\n        at org.hl7.fhir.r5.utils.StructureMapUtilities.executeRule(StructureMapUtilities.java:1456)\n        at org.hl7.fhir.r5.utils.StructureMapUtilities.executeRule(StructureMapUtilities.java:1439)\n        at org.hl7.fhir.r5.utils.StructureMapUtilities.executeGroup(StructureMapUtilities.java:1422)\n        at org.hl7.fhir.r5.utils.StructureMapUtilities.transform(StructureMapUtilities.java:1384)\n        at org.hl7.fhir.validation.ValidationEngine.transform(ValidationEngine.java:1537)\n        at org.hl7.fhir.validation.ValidationEngine.transform(ValidationEngine.java:1524)\n        at org.hl7.fhir.validation.cli.services.ValidationService.transform(ValidationService.java:153)\n        at org.hl7.fhir.validation.Validator.main(Validator.java:194)\n</code></pre></div>",
        "id": 212279487,
        "sender_full_name": "Ardon Toonstra",
        "timestamp": 1601892513
    },
    {
        "content": "<p>It seems to bomb out processing this rule:</p>\n<div class=\"codehilite\"><pre><span></span><code>src.valueSet : Reference as vs0 -&gt; tgt.valueSet as vt0 then Reference2Canonical(vs0, vt0) &quot;binding-valueSetR&quot;;\n</code></pre></div>\n\n\n<p>For some reason the engine can't create the <code>valueSet</code> inside <code>binding</code>.</p>",
        "id": 213131466,
        "sender_full_name": "Vadim Peretokin",
        "timestamp": 1602582032
    },
    {
        "content": "<p>Yep ... seeing the same thing. <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> is this something you'll have a look at?</p>",
        "id": 229854392,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1615472153
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>rule : binding-valueSetU; vars = source variables [src: (Element)], target variables [tgt: (Element)], shared variables []\n              rule : binding-valueSetR; vars = source variables [src: (Element)], target variables [tgt: (Element)], shared variables []\nException in thread &quot;main&quot; java.lang.Error: Unrecognised name valueSet on binding\n    at org.hl7.fhir.r5.elementmodel.Element.makeProperty(Element.java:456)\n    at org.hl7.fhir.r5.utils.structuremap.StructureMapUtilities.processTarget(StructureMapUtilities.java:1631)\n    at org.hl7.fhir.r5.utils.structuremap.StructureMapUtilities.executeRule(StructureMapUtilities.java:1209)\n    at org.hl7.fhir.r5.utils.structuremap.StructureMapUtilities.executeGroup(StructureMapUtilities.java:1196)\n    at org.hl7.fhir.r5.utils.structuremap.StructureMapUtilities.executeDependency(StructureMapUtilities.java:1255)\n    at org.hl7.fhir.r5.utils.structuremap.StructureMapUtilities.executeRule(StructureMapUtilities.java:1217)\n    at org.hl7.fhir.r5.utils.structuremap.StructureMapUtilities.executeGroup(StructureMapUtilities.java:1196)\n    at org.hl7.fhir.r5.utils.structuremap.StructureMapUtilities.executeRule(StructureMapUtilities.java:1230)\n    at org.hl7.fhir.r5.utils.structuremap.StructureMapUtilities.executeRule(StructureMapUtilities.java:1213)\n    at org.hl7.fhir.r5.utils.structuremap.StructureMapUtilities.executeGroup(StructureMapUtilities.java:1196)\n    at org.hl7.fhir.r5.utils.structuremap.StructureMapUtilities.transform(StructureMapUtilities.java:1158)\n    at org.hl7.fhir.validation.ValidationEngine.transform(ValidationEngine.java:392)\n    at org.hl7.fhir.validation.ValidationEngine.transform(ValidationEngine.java:382)\n    at org.hl7.fhir.validation.cli.services.ValidationService.transform(ValidationService.java:167)\n    at org.hl7.fhir.validation.ValidatorCli.doValidation(ValidatorCli.java:206)\n    at org.hl7.fhir.validation.ValidatorCli.main(ValidatorCli.java:158)\n</code></pre></div>",
        "id": 229854525,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1615472181
    },
    {
        "content": "<p>Or <span class=\"user-mention\" data-user-id=\"191363\">@Vadim Peretokin</span> - would it be you?</p>",
        "id": 229855542,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1615472527
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"195340\">@Erik Nielsen</span> - this should also have your attention</p>",
        "id": 229864388,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1615475497
    },
    {
        "content": "<p>Hmmm ... it seems to work without snapshots ;)</p>",
        "id": 230016230,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1615549881
    },
    {
        "content": "<p>Hmmm ... guess I didn't look at the details. It still doesn't work. If you run it on SD's without snapshot, the output fhirVersion is still stated as 3.0.1</p>",
        "id": 233305144,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1617710033
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> would you know what is causing this issue?</p>",
        "id": 233305206,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1617710055
    },
    {
        "content": "<p><code>FHIR Validation tool Version 5.3.8 (Git# 282188388860). Built 2021-04-01T18:57:27.206Z (4 days old)</code></p>",
        "id": 233308694,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1617711789
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"203235\">@Ward Weistra</span> does Firely Terminal support transformation of SD's from one FHIR version to another? eg. from STU3 to R4</p>",
        "id": 233451239,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1617784269
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191427\">@Jens Villadsen</span> It does not yet.<br>\nWe've thought about building the Mapping Engine into Firely Terminal. But I understood mapping between different FHIR versions was more provided as a documentation than something which you could really run for transformations. The most general process I know is changing the fhirVersion field in your StructureDefinition, opening in Forge and resolving the errors you get.<br>\nPerhaps <span class=\"user-mention\" data-user-id=\"194020\">@Gustav Vella</span> knows more on where inter-FHIR version mappings stand <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 233461664,
        "sender_full_name": "Ward Weistra",
        "timestamp": 1617789779
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"203235\">Ward Weistra</span> <a href=\"#narrow/stream/179166-implementers/topic/R3.20to.20R4.20StructureDefinition.20transformation/near/233461664\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"191427\">Jens Villadsen</span> It does not yet.<br>\nWe've thought about building the Mapping Engine into Firely Terminal. But I understood mapping between different FHIR versions was more provided as a documentation than something which you could really run for transformations. The most general process I know is changing the fhirVersion field in your StructureDefinition, opening in Forge and resolving the errors you get.<br>\nPerhaps <span class=\"user-mention silent\" data-user-id=\"194020\">Gustav Vella</span> knows more on where inter-FHIR version mappings stand :)</p>\n</blockquote>\n<p>Hi Ward, we worked on an estimation for the mapper to support this and may pick it up depending customer decison:</p>\n<p>Prerequisites and estimations<br>\nPrerequisite 1: The Mapping Engine must provide both StructureDefinitions from R3 and R4</p>\n<p>Option 1<br>\nIn order to fulfill this prerequisite, one needs StructureDefinitionProviders from multiple Information Models.</p>\n<p>=&gt; Estimation: unclear (10-20 person-days + the help of Firely due to firely server dependency)</p>\n<p>Option 2 (Workaround)<br>\nIn order to eliminate prerequisite 1, one could theoretically use a workaround. In this workaround, one would append a FHIR version number in all the StructureDefinitions' profile URLs during a preprocessing step. These preprocessed StructureDefinitions would then be imported into the desired information model (i.e. import stu3 into r4) and used in conjunction with the alias functionality for usage in the map.</p>\n<p>=&gt; Estimation: 4 person-days</p>\n<p>Prerequisite 2: The Mapping Engine must be able to deal with the alias at the top of the map<br>\nCurrently, this is not working. We estimate 3-4 days for this functionality.</p>\n<p>=&gt; Estimation: 3-4 person-days</p>\n<p>Prerequisite 3: The Mapping Engine must provide the conditional : source side rules<br>\nIn order for this to work, our parser and the MappingEngine should be able to handle the conditional : source side rules.</p>\n<p>=&gt; Estimation: 0 person-days</p>\n<p>Prerequisite 4: The Mapping Engine must be able to deal with the extends keyword<br>\nIn order for this to work, our parser and the MappingEngine should be able to handle the 'extends' keyword in the group definition. The 'extends' keyword marks groups that extend other groups and will automatically call all rules in the extended group as well.</p>\n<p>=&gt; Estimation: 4-6 person-days</p>\n<p>Prerequisite 5: The Mapping Engine must be able to deal with the default mapping groups<br>\nIn order for this to work, our parser and the MappingEngine should be able to handle the '&lt;&gt;' and '&lt;&gt;' keyword in the group definition. These keywords are used in order to mark default groups for specific types. Groups marked with &lt;&gt; can only exist once with the specified parameters whereas groups marked with &lt;&gt; will also be called if the target type does not match (i.e. if the target element is a choice type, this will be called too as long as the source type matches).</p>\n<p>=&gt; Estimation: 4-6 person-days</p>\n<p>Total without workaround: 21-36 person days</p>\n<p>Total with workaround: 15-20 person days</p>",
        "id": 233678577,
        "sender_full_name": "Gustav Vella",
        "timestamp": 1617897109
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"194020\">@Gustav Vella</span> Not an easy fix for sure! Thanks for the overview, interesting to know <span aria-label=\"thumbs up\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"thumbs up\">:thumbs_up:</span></p>",
        "id": 233793895,
        "sender_full_name": "Ward Weistra",
        "timestamp": 1617961672
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> is this something that you are willing to have a look at - or should I just proceed to do this upgrade manually <span aria-label=\"sob\" class=\"emoji emoji-1f62d\" role=\"img\" title=\"sob\">:sob:</span></p>",
        "id": 234229121,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1618261115
    },
    {
        "content": "<div class=\"message_inline_image\"><a href=\"https://media2.giphy.com/media/Lklr3P8LZUxUZahuyX/giphy.gif?cid=ecf05e47t7e5gman21iq8oy4g8wh09ry52ngfwf84fwluv6m&amp;rid=giphy.gif&amp;ct=g\"><img src=\"https://media2.giphy.com/media/Lklr3P8LZUxUZahuyX/giphy.gif?cid=ecf05e47t7e5gman21iq8oy4g8wh09ry52ngfwf84fwluv6m&amp;rid=giphy.gif&amp;ct=g\"></a></div>",
        "id": 234529687,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1618417302
    },
    {
        "content": "<p>it's on my list, but I'm not sure how much I'll be fixing, or when I'll get to it</p>",
        "id": 234798597,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1618552680
    }
]