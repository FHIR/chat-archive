[
    {
        "content": "<p>There are a few FHIRPath invariants, defined on various elements of a profile. <br>\nSome of those invariants/constraints restricts the elements present downward in the hierarchy. <br>\ne.g. an invariant having the key \"inv-1\" defined on the Patient  element having expression \"name.exists() or identifier.exists()\" involves three elements: <strong>Patient</strong>, <strong>name</strong> and <strong>identifier</strong>. <br>\nI want the (I) Flag to appear on <strong>each of the three elements above</strong>, in both the <strong>Differential</strong> or <strong>Snapshot</strong> views of the Patient profile.<br>\nThis page <strong>http://hl7.org/fhir/R4/formats.html#table</strong> states this about the (I) flag ---&gt; I: This element defines or is affected by constraints <br>\nI am using Firely Forge and IG Publisher to edit the profile and generate the IG, but the results are mostly inconsistent and incorrect. <br>\nIn most of the cases the xml fragment added is like this: <strong>&lt;condition value=\"invariant-key\" /&gt;</strong><br>\ne.g.<br>\n&lt;StructureDefinition xmlns=\"<a href=\"http://hl7.org/fhir\" target=\"_blank\" title=\"http://hl7.org/fhir\">http://hl7.org/fhir</a>\"&gt;<br>\n.<br>\n.<br>\n.<br>\n &lt;differential&gt;<br>\n    &lt;element id=\"Patient\"&gt;<br>\n      &lt;path value=\"Patient\" /&gt;<br>\n      &lt;constraint&gt;<br>\n<strong>&lt;key value=\"inv-1\" /&gt;</strong><br>\n        &lt;severity value=\"error\" /&gt;<br>\n        &lt;human value=\"The patient must have a name or an identifer\" /&gt;<br>\n        &lt;expression value=\"name.exists() or identifier.exists\" /&gt;<br>\n      &lt;/constraint&gt;<br>\n    &lt;/element&gt;<br>\n.<br>\n.<br>\n.<br>\n    &lt;element id=\"Patient.identifier\"&gt;<br>\n      &lt;path value=\"Patient.identifier\" /&gt;<br>\n<strong>&lt;condition value=\"inv-1\" /&gt;</strong><br>\n    &lt;/element&gt;<br>\n    &lt;element id=\"<a href=\"http://Patient.name\" target=\"_blank\" title=\"http://Patient.name\">Patient.name</a>\"&gt;<br>\n      &lt;path value=\"<a href=\"http://Patient.name\" target=\"_blank\" title=\"http://Patient.name\">Patient.name</a>\" /&gt;<br>\n<strong>&lt;condition value=\"inv-1\" /&gt;</strong><br>\n    &lt;/element&gt;<br>\n.<br>\n.<br>\n.<br>\n &lt;/differential&gt;<br>\n&lt;/StructureDefinition&gt;</p>\n<p>Just wanted to know if anyone has tested doing it before and have they got the intended results?</p>",
        "id": 176072217,
        "sender_full_name": "Vikas Mittal",
        "timestamp": 1568874167
    },
    {
        "content": "<p>you have an example?</p>",
        "id": 176081352,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1568884491
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span>  </p>\n<p>I have tried to re-create the issue I faced working on the Agency profiles, using the HL7AU (FHIR R4) Practitioner profile.<br>\nThe link of the profile I have used is -- <a href=\"http://build.fhir.org/ig/hl7au/au-fhir-base/StructureDefinition-au-practitioner.html\" target=\"_blank\" title=\"http://build.fhir.org/ig/hl7au/au-fhir-base/StructureDefinition-au-practitioner.html\">http://build.fhir.org/ig/hl7au/au-fhir-base/StructureDefinition-au-practitioner.html</a> <br>\nGitHub link --- <a href=\"https://github.com/hl7au/au-fhir-base/blob/master/resources/au-practitioner.xml\" target=\"_blank\" title=\"https://github.com/hl7au/au-fhir-base/blob/master/resources/au-practitioner.xml\">https://github.com/hl7au/au-fhir-base/blob/master/resources/au-practitioner.xml</a> <br>\nThis is the copy of the profile that currently exists -- <a href=\"/user_uploads/10155/zTbnZ_SaAnaNfJkaAH1e9OvB/au-practitioner.xml\" target=\"_blank\" title=\"au-practitioner.xml\">au-practitioner.xml</a>.</p>\n<p>Then I added the following five conditions on the relevant elements using Forge.<br>\n      &lt;condition value=\"inv-hpii-0\" /&gt;<br>\n      &lt;condition value=\"inv-hpii-1\" /&gt;<br>\n      &lt;condition value=\"inv-hpii-2\" /&gt;<br>\n      &lt;condition value=\"inv-caei-0\" /&gt;<br>\n      &lt;condition value=\"inv-ahpra-1\" /&gt;<br>\nA copy of the modified file is here --- <a href=\"/user_uploads/10155/d3ulqeGRyzm2GjZKeDInvJXn/au-practitioner-conditions-only.xml\" target=\"_blank\" title=\"au-practitioner-conditions-only.xml\">au-practitioner-conditions-only.xml</a>  </p>\n<p>The \"Differential Table\" shows the (I) Flag as expected, on the elements the condition is added on. Screenshot here --- <a href=\"/user_uploads/10155/5vJk33bUzraRlhFvtbhgWdC4/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a><br>\nBut the \"Snapshot Table\" does not! Screenshot here --- <a href=\"/user_uploads/10155/10NgGeavSTAV_d1aKfnV0WbE/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a><br>\nAlso the \"Detailed Descriptions\" Tab does not have the text which <br>\n- <strong>either</strong> says \"This element is affected by the following invariants: &lt;inv-key&gt;\" <br>\n- <strong>or</strong> probably something similar to this as shown in this screenshot --- <a href=\"/user_uploads/10155/K2ck71f4hwhiiQJcJbx4gPWw/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a></p>\n<p>Please let me know in case I have missed anything or I am still not very clear. </p>\n<p>PS: I have deliberately not added the queries about the au-practitioner profile the Forge Tool generated, when I added the 5 conditions, as that would potentially add to confusion.</p>",
        "id": 176170459,
        "sender_full_name": "Vikas Mittal",
        "timestamp": 1568963922
    },
    {
        "content": "<p>Seems like a rendering error? I would expect the rendering logic to pick up and display your constraints &amp; conditions.</p>",
        "id": 176177280,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1568971217
    },
    {
        "content": "<p>fixed next release</p>",
        "id": 176409870,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1569272888
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span></p>",
        "id": 176428456,
        "sender_full_name": "Vikas Mittal",
        "timestamp": 1569294134
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"191336\">@Michel Rutten</span>, just a query in relation to this. (Not sure if this is the right place to raise it. Please advise if you think a separate topic in another stream will be preferable)</p>\n<p>As described above I used this <a href=\"http://build.fhir.org/ig/hl7au/au-fhir-base/StructureDefinition-au-practitioner.html\" target=\"_blank\" title=\"http://build.fhir.org/ig/hl7au/au-fhir-base/StructureDefinition-au-practitioner.html\">au-practitioner</a> profile to add Invariant Flag conditions, a copy of which is here --- <a href=\"/user_uploads/10155/zTbnZ_SaAnaNfJkaAH1e9OvB/au-practitioner.xml\" target=\"_blank\" title=\"au-practitioner.xml\">au-practitioner.xml</a>  <br>\nI opened this file in Forge and added only these five conditions, without changing anything else and then saved it.<br>\n&lt;condition value=\"inv-hpii-0\" /&gt;<br>\n&lt;condition value=\"inv-hpii-1\" /&gt;<br>\n&lt;condition value=\"inv-hpii-2\" /&gt;<br>\n&lt;condition value=\"inv-caei-0\" /&gt;<br>\n&lt;condition value=\"inv-ahpra-1\" /&gt;</p>\n<p>The resultant file I got is this --- <a href=\"/user_uploads/10155/UhxgtiZDM8dNemgNS37e1mUZ/au-practitioner-forge-default.xml\" target=\"_blank\" title=\"au-practitioner-forge-default.xml\">au-practitioner-forge-default.xml</a> </p>\n<p>In this file you can see that the Forge tool added &lt;source/&gt; tags and removed some of the xml code! <br>\nJust wanted to know is it the correct behaviour from the tool?</p>\n<p><strong>An outcome of the Forge tool adding the &lt;source/&gt; element is that the constraint key and the constraint human value \"goes missing\" from the Differential and Snapshot Tables in the profile generated by IGPublisher!</strong></p>",
        "id": 176429066,
        "sender_full_name": "Vikas Mittal",
        "timestamp": 1569295313
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"192203\">@Vikas Mittal</span>, Forge re-generates the <code>StructureDefinition.differential</code> component by excluding all inherited constraints, as specified by the base profile and element type profiles (if any). A decrease in size of the differential component indicates that Forge removed some redundant constraints.<br>\nThe <code>ElementDefinition.constraint.source</code> field was introduced in FHIR R4. Forge R4 automatically generates this field value in the snapshot component, as specified by the spec:<br>\n<a href=\"http://hl7.org/fhir/elementdefinition-definitions.html#ElementDefinition.constraint.source\" target=\"_blank\" title=\"http://hl7.org/fhir/elementdefinition-definitions.html#ElementDefinition.constraint.source\">http://hl7.org/fhir/elementdefinition-definitions.html#ElementDefinition.constraint.source</a></p>",
        "id": 176552604,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1569408462
    },
    {
        "content": "<p>I don't know why the IG Publisher stumbles on this field. Maybe you discovered a bug in the rendering code?</p>",
        "id": 176552674,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1569408523
    },
    {
        "content": "<p>the java snapshot generator was missing ElementDefinition.condition. I fixed that today</p>",
        "id": 176554279,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1569410219
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"191336\">@Michel Rutten</span> and <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> <br>\nI will test it with the latest IG Publisher and get back to you in case it's required further.</p>",
        "id": 176556391,
        "sender_full_name": "Vikas Mittal",
        "timestamp": 1569412237
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> <br>\n I have tested it with FHIR IG Publisher (Version 0.9.82-SNAPSHOT - Built 2019-09-24T07:48:38.927+10:00 - Git 7c7c6916f395) <br>\nIt has now fixed the rendering issue for the (I) Flag,in both the Snapshot Table and the Detailed Descriptions tabs.<br>\nThe other rendering issue still remains where, constraint key and the constraint human value goes missing from the Differential and Snapshot Tables in the profile.</p>",
        "id": 176894081,
        "sender_full_name": "Vikas Mittal",
        "timestamp": 1569802454
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192203\">@Vikas Mittal</span>  is this still a problem? If so, how do I reproduce it?</p>",
        "id": 178440412,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1571369259
    },
    {
        "content": "<p>Yes <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> it is still an issue. </p>\n<p>To reproduce you can either <br>\n.<br>\nclone  <a href=\"https://github.com/hl7au/au-fhir-base.git\" target=\"_blank\" title=\"https://github.com/hl7au/au-fhir-base.git\">https://github.com/hl7au/au-fhir-base.git</a> repository and open this file (<a href=\"https://github.com/hl7au/au-fhir-base/blob/master/resources/au-practitioner.xml\" target=\"_blank\" title=\"https://github.com/hl7au/au-fhir-base/blob/master/resources/au-practitioner.xml\">https://github.com/hl7au/au-fhir-base/blob/master/resources/au-practitioner.xml</a>) in the Forge R4 tool. Then add a condition (&lt;condition value=\"inv-hpii-0\" /&gt;) and save it. The file generated by the Forge tool now adds this (&lt;source value=\"Practitioner\" /&gt;). If you run the IG Publisher on HL7AU and the resulting page of au-practitioner will have missing constraint keys and constraint human values. <br>\n.<br>\nOR<br>\n.<br>\nyou can just replace the au-practitioner.xml file in the <a href=\"https://github.com/hl7au/au-fhir-base.git\" target=\"_blank\" title=\"https://github.com/hl7au/au-fhir-base.git\">https://github.com/hl7au/au-fhir-base.git</a> cloned repository with this file (<a href=\"/user_uploads/10155/4pZGOFkccgiXsBV6jiBXvRnn/au-practitioner.xml\" target=\"_blank\" title=\"au-practitioner.xml\">au-practitioner.xml</a>) and then run the IG Publisher setup . </p>\n<p>Please let me know if you want me to create and send you the setup as a branch of some repository.</p>",
        "id": 178443391,
        "sender_full_name": "Vikas Mittal",
        "timestamp": 1571374277
    },
    {
        "content": "<p>the file you provided is identical?</p>",
        "id": 179010463,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1571962024
    },
    {
        "content": "<p>Yes <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> <br>\nI took this file (<a href=\"https://github.com/hl7au/au-fhir-base/blob/master/resources/au-practitioner.xml\" target=\"_blank\" title=\"https://github.com/hl7au/au-fhir-base/blob/master/resources/au-practitioner.xml\">https://github.com/hl7au/au-fhir-base/blob/master/resources/au-practitioner.xml</a>) and edited it using the Forge tool. <br>\nThe resultant file (<a href=\"user_uploads/10155/4pZGOFkccgiXsBV6jiBXvRnn/au-practitioner.xml\" target=\"_blank\" title=\"user_uploads/10155/4pZGOFkccgiXsBV6jiBXvRnn/au-practitioner.xml\">https://chat.fhir.org/user_uploads/10155/4pZGOFkccgiXsBV6jiBXvRnn/au-practitioner.xml</a>) that the Forge tool generated, is the file that I have provided in my previous comment. <br>\nAnd that is the file that the IG Publisher is having rendering issues with. <br>\n.<br>\nWhile the current file on the github (<a href=\"https://github.com/hl7au/au-fhir-base/blob/master/resources/au-practitioner.xml\" target=\"_blank\" title=\"https://github.com/hl7au/au-fhir-base/blob/master/resources/au-practitioner.xml\">https://github.com/hl7au/au-fhir-base/blob/master/resources/au-practitioner.xml</a>) does not have those rendering issues.</p>",
        "id": 179014229,
        "sender_full_name": "Vikas Mittal",
        "timestamp": 1571966114
    },
    {
        "content": "<p>So the problem is that the invariants are not rendered like this:</p>",
        "id": 179022534,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1571980319
    },
    {
        "content": "<p><a href=\"/user_uploads/10155/Zt1NtbxiCqAUjA_A-iDYlSv6/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/Zt1NtbxiCqAUjA_A-iDYlSv6/pasted_image.png\" target=\"_blank\" title=\"pasted image\"><img src=\"/user_uploads/10155/Zt1NtbxiCqAUjA_A-iDYlSv6/pasted_image.png\"></a></div>",
        "id": 179022576,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1571980354
    },
    {
        "content": "<p>That results from a decision by the IG creation stream to not render constraints that come from inherited models. So to get your constraints to render, remove the \"source\" statement on them</p>",
        "id": 179022589,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1571980410
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> <br>\n<span class=\"user-mention\" data-user-id=\"191336\">@Michel Rutten</span> do you think it is okay for the Forge to add the &lt;source/&gt; tags when I am \"editing an existing profile\" and not \"deriving and creating a new profile\"?</p>",
        "id": 179024626,
        "sender_full_name": "Vikas Mittal",
        "timestamp": 1571983834
    },
    {
        "content": "<p>Forge R4 contains some basic logic to ensure that <code>.constraint.source</code> fields are initialized. The description of the field mentions rendering, but remains a bit vague. I was waiting for some feedback/guidance from the community about this aspect.<br>\n<span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> I guess that rendering logic could also determine if a constraint is introduced or inherited by inspecting the source; if source points to the containing resource, then the constraint is introduced, not inherited? (similar to <code>ElementDefinition.base.path</code>)</p>",
        "id": 179031725,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1571992741
    },
    {
        "content": "<p>well, that's the intent. What we're doing is leaving it blank when it's defined in this structure definition, and populating it otherwise. but I see that we're not populating it correctly - it should be the canonical URL of the source</p>",
        "id": 179088149,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1572036774
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191336\">@Michel Rutten</span>, is Forge R4 change to stop initializing <code>ElementDefinition.constraint.source</code> in plan?</p>",
        "id": 182503968,
        "sender_full_name": "Dusica Bojicic",
        "timestamp": 1575412208
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191336\">@Michel Rutten</span>, we have been testing use of Forge R4 as part of the Canadian Baseline Profiling effort.  As noted by Vikas above, Forge adds <code>.constraint.source</code> whenever we edit and save a profile that introduces constraints.  This causes the constraints to fail to render in the IG Publisher output.  Is there a plan to change this?</p>",
        "id": 183494352,
        "sender_full_name": "Russell Buchanan",
        "timestamp": 1576426854
    },
    {
        "content": "<p>Hey <span class=\"user-mention\" data-user-id=\"192379\">@Dusica Bojicic</span> and <span class=\"user-mention\" data-user-id=\"193891\">@Russell Buchanan</span>, thanks for mentioning that! It seems it is valid FHIR to fill that field, but the Publisher doesn't accept it?<br>\n<span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> would this then be something to fix in the IG Publisher instead?</p>",
        "id": 183567458,
        "sender_full_name": "Ward Weistra",
        "timestamp": 1576514903
    },
    {
        "content": "<p>I think that Forge is populating it wrongly. the renderer does not publish the constraint if the source indicates it comes from some inherited model (the profiles are littered with inherited constraints). So if the source is empty, or doesn't match the current canonical, then it doesn't get rendered. From memory, forge isn't putting a canonical in there?</p>",
        "id": 183583155,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1576525358
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span>, Forge does not put the canonical, I think it populates the field with the resource name. IG Publisher does not render constraints either when the source is populated with the current canonical (unless that changed in the last 10 days or so).</p>",
        "id": 183589447,
        "sender_full_name": "Dusica Bojicic",
        "timestamp": 1576529643
    },
    {
        "content": "<p>you're right. I thought I had fixed that. Next release will allow source = self</p>",
        "id": 183590189,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1576530143
    },
    {
        "content": "<p>It doesn't work in v 1.0.24 of the igPublisher.</p>",
        "id": 183623257,
        "sender_full_name": "Richard Townley-O'Neill",
        "timestamp": 1576565980
    },
    {
        "content": "<p>OK thanks <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> <span class=\"user-mention\" data-user-id=\"192379\">@Dusica Bojicic</span>. Based on the above I understand Forge is behaving correctly. Please correct me if I'm wrong!</p>",
        "id": 183632618,
        "sender_full_name": "Ward Weistra",
        "timestamp": 1576575876
    },
    {
        "content": "<p>no. it needs to populate the source with the canonical URL, not the name</p>",
        "id": 183632670,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1576575944
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"203235\">@Ward Weistra</span> <span class=\"user-mention\" data-user-id=\"191334\">@Marten Smits</span> found the same issue independently. Bug report can be found here: <a href=\"https://github.com/FirelyTeam/fhir-net-api/issues/1188\" target=\"_blank\" title=\"https://github.com/FirelyTeam/fhir-net-api/issues/1188\">https://github.com/FirelyTeam/fhir-net-api/issues/1188</a></p>",
        "id": 183633694,
        "sender_full_name": "Alexander Zautke",
        "timestamp": 1576576803
    },
    {
        "content": "<p>Ah wonderful, and it's already planned for the upcoming API sprint. Once it's included there we'll add it to Forge!<br>\nRight now we're planning a January release of Forge, but the API release might not be out yet by then. So probably the next release after that. cc <span class=\"user-mention\" data-user-id=\"192379\">@Dusica Bojicic</span> <span class=\"user-mention\" data-user-id=\"193891\">@Russell Buchanan</span> Sorry for the inconvenience until then.</p>",
        "id": 183634129,
        "sender_full_name": "Ward Weistra",
        "timestamp": 1576577185
    }
]