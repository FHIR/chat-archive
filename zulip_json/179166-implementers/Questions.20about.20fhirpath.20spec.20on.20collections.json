[
    {
        "content": "<p>I have some questions about how some methods are supposed to behave on empty collections in fhirpath, where the spec isn't clear.</p>\n<p>The Fhirpath spec (NormBallot2) says in section 4.3:</p>\n<blockquote>\n<p>Finally, FHIRPath supports the notion of functions, which all take a collection of values as input and produce another collection as output and may take parameters. For example:<br>\n<code>(name.given | name.family).substring(0,4)</code></p>\n</blockquote>\n<p>This suggests to me that this example is valid, and that if name.given is \"Jane\" and name.family is \"Smith\", then this expression would produce the colleciton {'Jane', 'Smit'}.</p>\n<p>However, <code>substring</code> is defined in section 5.6, which says</p>\n<blockquote>\n<p>The functions in this section [e.g. substring] operate on collections with a single item. If there is more than one item, or an item that is not a String, the evaluation of the expression will end and signal an error to the calling environment.</p>\n</blockquote>\n<p>If that's correct, then this example should produce an error. What's the intended behavior of .substring? Should it produce a collection in this case, or an error because it was passed a collection of more than a single item?</p>\n<p>More interestingly, how about this example?<br>\n<code>{}.substring(0, 4)</code><br>\nShould it raise an error, or produce an empty collection? The note at the beginning of section 5.6 doesn't say what is supposed to happen with empty collections.</p>\n<p>Relatedly, what should this expression produce? Should it raise an error, or produce 'T'?<br>\n<code>{1, 2}.iif($this.exists(), 'T', 'F')</code><br>\nAnd likewise?<br>\n<code>{}.iif($this.empty(), 'T', 'F')</code><br>\nI ask because <code>iif</code> is defined in section 5.5 (\"Conversion\"), which has the same note about raising an error on collections that have more than a single item.</p>",
        "id": 183959918,
        "sender_full_name": "Justin Pombrio",
        "timestamp": 1576866276
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span></p>",
        "id": 183967545,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1576871705
    },
    {
        "content": "<p>The example in section 4.3 is incorrect, that would produce an error. <a href=\"http://build.fhir.org/ig/HL7/FHIRPath/#indexofsubstring-string-integer\" target=\"_blank\" title=\"http://build.fhir.org/ig/HL7/FHIRPath/#indexofsubstring-string-integer\">Substring</a> expects a singleton, so to invoke it on a collection you would use <code>.select()</code>. If you invoke <code>.substring()</code> on an empty collection, the result is an empty collection. And yes <a href=\"http://build.fhir.org/ig/HL7/FHIRPath/#iifcriterion-expression-true-result-collection-otherwise-result-collection-collection\" target=\"_blank\" title=\"http://build.fhir.org/ig/HL7/FHIRPath/#iifcriterion-expression-true-result-collection-otherwise-result-collection-collection\"><code>.iff()</code></a> is a singleton function as well, so the example <code>{ 1, 2 }.iif(...</code> would throw an error, and the invocation on the empty collection would result in an empty collection. I've submitted a tracker (<a href=\"http://jira.hl7.org/browse/FHIR-25403\" target=\"_blank\" title=\"http://jira.hl7.org/browse/FHIR-25403\">J#25403</a>) to address the example.</p>",
        "id": 183989071,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1576891350
    },
    {
        "content": "<p>Thanks Bryn. That fully answers my question (together with the bit in spec that I had missed before that says \"If a single-input function operates on an empty collection, the result is an empty collection\").</p>\n<p>It does make it hard to produce an expression that evaluates to <code>'A'</code> if a collection is empty, or <code>'B'</code> otherwise, which was the motivation behind this question. But I suppose you can say <code>collection.empty().iff($this, 'A', 'B')</code>.</p>",
        "id": 184498798,
        "sender_full_name": "Justin Pombrio",
        "timestamp": 1577738043
    }
]