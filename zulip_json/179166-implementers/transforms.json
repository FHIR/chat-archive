[
    {
        "content": "<p>Hi, here in the UK we are looking at creating a <em>transform capability</em> to allow a FHIR message to be sent/received to/from an endpoint that is built to accept a different version of FHIR.  I understand there are many options from developing the FHIR Mapping files to using the HAPI FHIR library. Is there anyone trying this or any other option?</p>",
        "id": 247445618,
        "sender_full_name": "Sufyan Patel",
        "timestamp": 1627470614
    },
    {
        "content": "<p>Hi  </p>\n<p>I was looking for an example for how to carry out a transform and found an example on the old wiki at  </p>\n<p><a href=\"https://wiki.hl7.org/Using_the_FHIR_Validator_to_transform_content\">https://wiki.hl7.org/Using_the_FHIR_Validator_to_transform_content</a>  </p>\n<p>The new wiki page on the new wiki seems to still need migrated  </p>\n<p><a href=\"https://confluence.hl7.org/display/FHIR/R3-R4+Transformations\">https://confluence.hl7.org/display/FHIR/R3-R4+Transformations</a>  </p>\n<p>I took an example from the STU3 AllergyIntolerance resource and tried using the example in the wiki to convert it to R4.    <br>\nWhen I ran the validator_cli.jar with the following parameters.    </p>\n<div class=\"codehilite\"><pre><span></span><code>java -jar validator_cli.jar r4_allergyintolerance-example.json -output r3_allergyintolerance-transformed.json -transform  http://hl7.org/fhir/StructureMap/*4to3 -ig hl7.fhir.transforms.v4v3\n</code></pre></div>\n<p>I got the error  </p>\n<div class=\"codehilite\"><pre><span></span><code>Exception in thread &quot;main&quot; java.lang.Error: Unable to find map http://hl7.org/fhir/StructureMap/*4to3 (Known Maps = [http://hl7.org/fhir/StructureMap/supplyrequest-transform, http://hl7.org/fhir/StructureMap/example|0.1, http://hl7.org/fhir/StructureMap/example, supplyrequest-transform, http://hl7.org/fhir/StructureMap/supplyrequest-transform|#0, example])\n        at org.hl7.fhir.validation.ValidationEngine.transform(ValidationEngine.java:405)\n        at org.hl7.fhir.validation.ValidationEngine.transform(ValidationEngine.java:397)\n        at org.hl7.fhir.validation.cli.services.ValidationService.transform(ValidationService.java:218)\n        at org.hl7.fhir.validation.ValidatorCli.doValidation(ValidatorCli.java:241)\n        at org.hl7.fhir.validation.ValidatorCli.main(ValidatorCli.java:163)\n</code></pre></div>\n<p>A search of <a href=\"https://packages2.fhir.org/packages\">https://packages2.fhir.org/packages</a> shows no packages with transforms as part of the title, so I tried changing the IG to just the r3 and r4 core packages, but then got the error  </p>\n<div class=\"codehilite\"><pre><span></span><code>Exception in thread &quot;main&quot; java.lang.Error: Unable to find map http://hl7.org/fhir/StructureMap/*4to3 (Known Maps = [http://hl7.org/fhir/StructureMap/supplyrequest-transform, http://hl7.org/fhir/StructureMap/example|0.1, http://hl7.org/fhir/StructureMap/example, supplyrequest-transform, http://hl7.org/fhir/StructureMap/supplyrequest-transform|#0, example])\n        at org.hl7.fhir.validation.ValidationEngine.transform(ValidationEngine.java:405)\n        at org.hl7.fhir.validation.ValidationEngine.transform(ValidationEngine.java:397)\n        at org.hl7.fhir.validation.cli.services.ValidationService.transform(ValidationService.java:218)\n        at org.hl7.fhir.validation.ValidatorCli.doValidation(ValidatorCli.java:241)\n        at org.hl7.fhir.validation.ValidatorCli.main(ValidatorCli.java:163)\n</code></pre></div>\n<p>I also changed <a href=\"http://hl7.org/fhir/StructureMap/*4to3\">http://hl7.org/fhir/StructureMap/*4to3</a> to <a href=\"http://hl7.org/fhir/StructureMap/AllergyIntolerance4to3\">http://hl7.org/fhir/StructureMap/AllergyIntolerance4to3</a> based on the instructions in the wiki, but got the same error.   </p>\n<p>Is there other documentation or examples I could refer to?  Is it possible to use the latest pre-built validator_cli.jar to run transforms in this way?  </p>\n<p>Thanks</p>",
        "id": 260687419,
        "sender_full_name": "Declan Kieran",
        "timestamp": 1636391436
    },
    {
        "content": "<p>AFAIK FHIR only comes with the transforms for the various Profiling resources, but not for all resource types. You can define your own mapping and subsequently use the validator to execute the transformations.</p>",
        "id": 260762353,
        "sender_full_name": "Ren√© Spronk",
        "timestamp": 1636442670
    },
    {
        "content": "<p>Thanks, that's good to know. I've been able to make some progress following the tutorial implementation by <span class=\"user-mention\" data-user-id=\"191478\">@Oliver Egger</span>  (Thanks, really helpful!) here <a href=\"https://github.com/ahdis/fhir-mapping-tutorial\">https://github.com/ahdis/fhir-mapping-tutorial</a>, based on <a href=\"https://www.hl7.org/fhir/mapping-tutorial.html\">https://www.hl7.org/fhir/mapping-tutorial.html</a>.  </p>\n<p>Using the instructions for using the validator_cli.jar in java.md, allowed me to run the validator_cli.jar successfully and with a few modifications to the tleft StructureDefinition, StructureMap and FML in the maps directory, I was able to add a new element to the source and remap the simple example in step1 to change the value in the output transform.  </p>\n<p>I'm going to use this to see if I can now transform the AllergyIntolerance using the FML given here <a href=\"https://www.hl7.org/fhir/allergyintolerance-version-maps.html\">https://www.hl7.org/fhir/allergyintolerance-version-maps.html</a>, as I think either the $convert or $transform operation in the StructureMap resource should generate a StructureMap from the FML (I think...), otherwise I'll try to handcraft it based on the FML.</p>",
        "id": 260966919,
        "sender_full_name": "Declan Kieran",
        "timestamp": 1636538080
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"456074\">@Declan Kieran</span> using the maps to transform from R3 to R4 needs special setup because the transform needs to be aware of the different versions. There is java test code available which demonstrates it, see <a href=\"https://github.com/hapifhir/org.hl7.fhir.core/blob/master/org.hl7.fhir.validation/src/test/java/org/hl7/fhir/conversion/tests/R3R4ConversionTests.java\">https://github.com/hapifhir/org.hl7.fhir.core/blob/master/org.hl7.fhir.validation/src/test/java/org/hl7/fhir/conversion/tests/R3R4ConversionTests.java</a>.</p>",
        "id": 260970916,
        "sender_full_name": "Oliver Egger",
        "timestamp": 1636540503
    },
    {
        "content": "<p>Hello,<br>\nI am new to the transform topic. I tried a transformation with an own mapping file, but it failed. Does anyone have an answer to that error?</p>\n<p>Exception in thread \"main\" java.lang.Error: Unable to find map <a href=\"http://example.org/fhir/StructureMap/TestPatientPractioner\">http://example.org/fhir/StructureMap/TestPatientPractioner</a> (Known Maps = [http://hl7.org/fhir/StructureMap/supplyrequest-transform, <a href=\"http://hl7.org/fhir/StructureMap/example|0.1\">http://hl7.org/fhir/StructureMap/example|0.1</a>, <a href=\"http://hl7.org/fhir/StructureMap/example\">http://hl7.org/fhir/StructureMap/example</a>, supplyrequest-transform, <a href=\"http://hl7.org/fhir/StructureMap/supplyrequest-transform|#0\">http://hl7.org/fhir/StructureMap/supplyrequest-transform|#0</a>, example])<br>\n        at org.hl7.fhir.validation.ValidationEngine.transform(ValidationEngine.java:401)<br>\n        at org.hl7.fhir.validation.ValidationEngine.transform(ValidationEngine.java:393)<br>\n        at org.hl7.fhir.validation.cli.services.ValidationService.transform(ValidationService.java:218)<br>\n        at org.hl7.fhir.validation.ValidatorCli.doValidation(ValidatorCli.java:241)<br>\n        at org.hl7.fhir.validation.ValidatorCli.main(ValidatorCli.java:163)</p>\n<p>I tried it with the direct location of the map file \"c:\\...\\TestPatientPractioner.map, with the URL of the map <a href=\"http://example.org/fhir/StructureMap/TestPatientPractioner\">http://example.org/fhir/StructureMap/TestPatientPractioner</a>, inside and outside of my little IG. But the error ist still the same and -allow-example-urls true was always  in the command for the validator.<br>\nI use VS Code with the  FHIR tools extension, which includes the validator. <br>\nSo I looked through all DevDay Youtube Videos, FHIR Mapping Language and validator documentation and all Tutorials. The Tutorial of <span class=\"user-mention\" data-user-id=\"191478\">@Oliver Egger</span> worked fine, thanks a lot.  <br>\nThanks to all your ideas.</p>",
        "id": 261046342,
        "sender_full_name": "Antje Borgmann",
        "timestamp": 1636574481
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"196504\">@Antje Borgmann</span> did you provide the map file in a directory and specified the directory with the ig parameter? here an example form the tutorial: </p>\n<div class=\"codehilite\"><pre><span></span><code>java -jar validator_cli.jar ./maptutorial/step1/source/source1.xml -transform http://hl7.org/fhir/StructureMap/tutorial -version 4.0.1 -ig ./maptutorial/step1/logical -ig ./maptutorial/step1/map -log test.txt -output ./maptutorial/step1/output.xml\n</code></pre></div>\n<p>if you say your map is within your ig. Did you add there the xml or json StructureMap in the ig? can you confirm that the StructureMap is available in the ig (e.g. artifacts.html)?</p>",
        "id": 261049146,
        "sender_full_name": "Oliver Egger",
        "timestamp": 1636575662
    },
    {
        "content": "<p>Thanks for your quick reply.<br>\nYes, the map file is within the ig and I used the ig parameter like in step 1. <br>\nBut there is no StructureMap resource  in my ig.  In the most github projects were only maps but no StructureMap resources. So I thought the validator doesn't need a StructureMap resource.<br>\nThat's the next problem. I can't find something in the validator documentation to convert a map into a StructureMap resource. <br>\nIs it possible to have core resources e.g. Patient as source, Practioner as target (no profiling) and a map file to copy the name of Patient to Practioner with the validator, only with these three things?</p>",
        "id": 261101827,
        "sender_full_name": "Antje Borgmann",
        "timestamp": 1636615860
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"196504\">Antje Borgmann</span> <a href=\"#narrow/stream/179166-implementers/topic/transforms/near/261101827\">said</a>:</p>\n<blockquote>\n<p>Is it possible to have core resources e.g. Patient as source, Practioner as target (no profiling) and a map file to copy the name of Patient to Practioner with the validator, only with these three things?</p>\n</blockquote>\n<p>yes, i uploaded a minimal example here from QuestionnaireResponse to a Patient <a href=\"https://github.com/ahdis/fhir-mapping-tutorial/tree/master/qrtopat\">here</a>, you can use the validator like this:</p>\n<div class=\"codehilite\"><pre><span></span><code>java -jar validator_cli.jar ./qr.json -transform http://ahdis.ch/matchbox/fml/qr2patgender -version 4.0.1 -ig ./map -output ./output.xml\n</code></pre></div>",
        "id": 261107544,
        "sender_full_name": "Oliver Egger",
        "timestamp": 1636620933
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"196504\">Antje Borgmann</span> <a href=\"#narrow/stream/179166-implementers/topic/transforms/near/261101827\">said</a>:</p>\n<blockquote>\n<p>In the most github projects were only maps but no StructureMap resources. </p>\n</blockquote>\n<p>for our projects we always include the StructureMap resource, e.g. see <a href=\"http://fhir.ch/ig/ch-orf/artifacts.html#terminology-structure-maps\">http://fhir.ch/ig/ch-orf/artifacts.html#terminology-structure-maps</a></p>",
        "id": 261107723,
        "sender_full_name": "Oliver Egger",
        "timestamp": 1636621062
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"196504\">Antje Borgmann</span> <a href=\"#narrow/stream/179166-implementers/topic/transforms/near/261101827\">said</a>:</p>\n<blockquote>\n<p>I can't find something in the validator documentation to convert a map into a StructureMap resource. </p>\n</blockquote>\n<p>I thought it functionality was once included, but cannot find it anymore. Feel free to use the transformation service on our test server, it uses also the java implementation internally, you need do a POST call to <a href=\"https://test.ahdis.ch/matchbox/fhir/StructureMap\">https://test.ahdis.ch/matchbox/fhir/StructureMap</a>,  see <a href=\"https://github.com/ahdis/matchbox/blob/main/fml.http#L12\">example with REST Client</a></p>",
        "id": 261108580,
        "sender_full_name": "Oliver Egger",
        "timestamp": 1636621596
    },
    {
        "content": "<p>Thanks this was very helpful.</p>",
        "id": 261130293,
        "sender_full_name": "Antje Borgmann",
        "timestamp": 1636635634
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191478\">Oliver Egger</span> <a href=\"#narrow/stream/179166-implementers/topic/transforms/near/260970916\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"456074\">Declan Kieran</span> using the maps to transform from R3 to R4 needs special setup because the transform needs to be aware of the different versions. There is java test code available which demonstrates it, see <a href=\"https://github.com/hapifhir/org.hl7.fhir.core/blob/master/org.hl7.fhir.validation/src/test/java/org/hl7/fhir/conversion/tests/R3R4ConversionTests.java\">https://github.com/hapifhir/org.hl7.fhir.core/blob/master/org.hl7.fhir.validation/src/test/java/org/hl7/fhir/conversion/tests/R3R4ConversionTests.java</a>.</p>\n</blockquote>\n<p>Hi <span class=\"user-mention silent\" data-user-id=\"191478\">Oliver Egger</span>  I've got the unit tests running, but they are all failing.  It seems the structure definitions are not being added to the context, and this seems to be causing a failure in the parsing of the example files.  i.e. after</p>\n<p><code>StructureMapUtilities smu3 = new StructureMapUtilities(contextR3, this);</code></p>\n<p>contextR3.structures is empty, which seems to be something to do with the SimpleWorkerContext being null.  When the xml is being parsed, the StructureDefintion is not found and the following error is thrown</p>\n<p><code> This does not appear to be a FHIR resource (unknown namespace/name...</code></p>\n<p>I'm using the example file from the <a href=\"https://github.com/HL7/fhir.git\">https://github.com/HL7/fhir.git</a> repo, at commit 4cf6f3c0dad1f3691a36c13ce2b0c09a0cf814b6, with the files placed at \"C:\\work\\org.hl7.fhir\\build\".  I running test() in R3R4ConversionTests at whatever version was there when I cloned the org.hl7.fhir.core repo and when that didn't work, I used the code at commit 992f870cb42395938eaf5f38f127ee0a708016f8 (unit test conversions r3r4), which seems to be when the unit tests were merged into the main.</p>\n<p>You mentioned that there needs to be some setup done, is there something I'm missing here to load in the structure defintions maybe?</p>\n<p>Here is the console output for the first test, including a stack trace.</p>\n<div class=\"codehilite\"><pre><span></span><code>loading R3\nloading R4\nloading Maps\nloaded\n\norg.hl7.fhir.exceptions.FHIRFormatError: This does not appear to be a FHIR resource (unknown namespace/name &#39;http://hl7.org/fhir::Account&#39;) at line 0 col 0\n\n    at org.hl7.fhir.r4.elementmodel.ParserBase.logError(ParserBase.java:88)\n    at org.hl7.fhir.r4.elementmodel.ParserBase.getDefinition(ParserBase.java:110)\n    at org.hl7.fhir.r4.elementmodel.XmlParser.parse(XmlParser.java:170)\n    at org.hl7.fhir.r4.elementmodel.XmlParser.parse(XmlParser.java:162)\n    at org.hl7.fhir.r4.elementmodel.XmlParser.parse(XmlParser.java:134)\n    at org.hl7.fhir.conversion.tests.R3R4ConversionTests.test(R3R4ConversionTests.java:145)\n    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n    at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n    at java.base/java.lang.reflect.Method.invoke(Method.java:566)\n    at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)\n    at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\n    at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)\n    at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)\n    at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:325)\n    at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:78)\n    at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:57)\n    at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)\n    at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)\n    at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)\n    at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)\n    at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)\n    at org.junit.runners.ParentRunner.run(ParentRunner.java:363)\n    at org.junit.runners.Suite.runChild(Suite.java:128)\n    at org.junit.runners.Suite.runChild(Suite.java:27)\n    at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)\n    at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)\n    at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)\n    at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)\n    at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)\n    at org.junit.runners.ParentRunner.run(ParentRunner.java:363)\n    at org.junit.runner.JUnitCore.run(JUnitCore.java:137)\n    at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:69)\n    at com.intellij.rt.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:33)\n    at com.intellij.rt.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:235)\n    at com.intellij.rt.junit.JUnitStarter.main(JUnitStarter.java:54)\n</code></pre></div>",
        "id": 262096205,
        "sender_full_name": "Declan Kieran",
        "timestamp": 1637341591
    }
]