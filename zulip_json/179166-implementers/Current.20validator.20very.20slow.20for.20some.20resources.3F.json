[
    {
        "content": "<p>Hi <span aria-label=\"wave\" class=\"emoji emoji-1f44b\" role=\"img\" title=\"wave\">:wave:</span> Running the latest validator this morning, I noticed it was extremely slow for certain resources. It seems to be very dependent on the resource/resource type (seem to work as usual for some), but I see it e.g. on this  QuestionnaireResponse example: <a href=\"http://hl7.org/fhir/R4/questionnaire-example.json\">http://hl7.org/fhir/R4/questionnaire-example.json</a> Validating this standard example just now took 1 min 19 secs!  The slowness remains even when switching off the terminology serverm, so that is not the issue. There are no errors being thrown,  either (see command line output below). Any ideas where this might be coming from?</p>\n<div class=\"codehilite\"><pre><span></span><code>FHIR Validation tool Version 5.1.21 (Git# 5b62d35f715f). Built 2020-11-11T02:04:31.124Z (5 hours old)\n  Java:   1.8.0_222 from /Library/Java/JavaVirtualMachines/adoptopenjdk-8.jdk/Contents/Home/jre on x86_64 (64bit). 3641MB available\n  Paths:  Current = [....], Package Cache = /Users/[...]/.fhir/packages\n  Params: -version 4.0.1 -tx n/a test.json\nLoading\n  Load FHIR v4.0 from hl7.fhir.r4.core#4.0.1 - 4575 resources (00:03.0671)\n  Terminology server null - Version n/a: No Terminology Server (00:00.0000)\n  Get set...  go (00:00.0002)\nValidating\n  Validate test.jsonTerminology server: Check for supported code systems for http://cancer.questionnaire.org/system/code/yesno\n==============!! Running without terminology server !! ==============\n=====================================================================\n 01:19.0046\nDone. Times: Loading: 00:03.0862, validation: 01:19.0046\n\nSuccess: 0 errors, 2 warnings, 5 notes\n  Information @ QuestionnaireResponse (line 1, col2) : No questionnaire is identified, so no validation can be performed against the base questionnaire\n  Information @ QuestionnaireResponse.item[0].item[0].answer[0].value.ofType(Coding) (line 77, col83) : Code System URI &#39;http://cancer.questionnaire.org/system/code/yesno&#39; is unknown so the code cannot be validated\n  Information @ QuestionnaireResponse.item[0].item[0].answer[0].item[0].item[0].answer[0].value.ofType(Coding) (line 87, col99) : Code System URI &#39;http://cancer.questionnaire.org/system/code/yesno&#39; is unknown so the code cannot be validated\n  Information @ QuestionnaireResponse.item[0].item[0].answer[0].item[0].item[1].answer[0].value.ofType(Coding) (line 96, col99) : Code System URI &#39;http://cancer.questionnaire.org/system/code/yesno&#39; is unknown so the code cannot be validated\n  Information @ QuestionnaireResponse.item[0].item[0].answer[0].item[0].item[2].answer[0].value.ofType(Coding) (line 105, col99) : Code System URI &#39;http://cancer.questionnaire.org/system/code/yesno&#39; is unknown so the code cannot be validated\n  Warning @ QuestionnaireResponse.contained[0].ofType(Patient).identifier[1].type (line 18, col22) : No code provided, and a code should be provided from the value set http://hl7.org/fhir/ValueSet/identifier-type (http://hl7.org/fhir/ValueSet/identifier-type)\n  Warning @ QuestionnaireResponse.contained[2].ofType(Practitioner).identifier[0].type (line 44, col18) : No code provided, and a code should be provided from the value set http://hl7.org/fhir/ValueSet/identifier-type (http://hl7.org/fhir/ValueSet/identifier-type)\n</code></pre></div>",
        "id": 216316797,
        "sender_full_name": "Morten Ernebjerg",
        "timestamp": 1605082172
    },
    {
        "content": "<p>Does it run slow still once you have an updated cache?  (Questionnaires often involve lots of vocabulary validation)</p>",
        "id": 216353351,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1605105377
    },
    {
        "content": "<p>Strangely, this morning the example I mentioned above runs fine (less than a second), but I still see this problem on other resources. I played around a bit and found the following:</p>\n<ul>\n<li>Running the same validation repeatedly does not improve the speed - I imagine that means it is not due to a stale cache(?)</li>\n<li>All the slow runs seem to run for pretty much exactly 1 min 19 secs, so there does not seem to be a strong dependence on resource details</li>\n<li>Slow runs seem to be triggered by custom code system canonical URLs that contain particular \"FHIR-words\", e.g. \"CodeSystem\". For instance, comparing the two examples below,  having \"CodeSystem\"  (as opposed to \"SodeCystem\") in the URL bumps the validation time from 0.5 secs to 1 min 19 secs (!):</li>\n</ul>\n<p>Slow example <code>Encounter.type.coding.system</code> = \"<a href=\"http://somreandomurl.com/CodeSystem/test\">http://somreandomurl.com/CodeSystem/test</a>\" :</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"p\">{</span>\n    <span class=\"nt\">\"resourceType\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Encounter\"</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"status\"</span><span class=\"p\">:</span> <span class=\"s2\">\"finished\"</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"class\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n        <span class=\"nt\">\"system\"</span><span class=\"p\">:</span> <span class=\"s2\">\"http://terminology.hl7.org/CodeSystem/v3-ActCode\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"code\"</span><span class=\"p\">:</span> <span class=\"s2\">\"AMB\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"display\"</span><span class=\"p\">:</span> <span class=\"s2\">\"ambulatory\"</span>\n    <span class=\"p\">},</span>\n    <span class=\"nt\">\"type\"</span><span class=\"p\">:</span> <span class=\"p\">[{</span>\n        <span class=\"nt\">\"coding\"</span><span class=\"p\">:</span> <span class=\"p\">[{</span>\n            <span class=\"nt\">\"system\"</span><span class=\"p\">:</span> <span class=\"s2\">\"http://somreandomurl.com/CodeSystem/test\"</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"code\"</span><span class=\"p\">:</span> <span class=\"s2\">\"somecode\"</span>\n        <span class=\"p\">}]</span>\n    <span class=\"p\">}],</span>\n    <span class=\"nt\">\"period\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n        <span class=\"nt\">\"start\"</span><span class=\"p\">:</span> <span class=\"s2\">\"2020-02-06\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"end\"</span><span class=\"p\">:</span> <span class=\"s2\">\"2020-02-06\"</span>\n    <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Fast example  - identical to the above, except that <code>Encounter.type.coding.system</code> = \"<a href=\"http://somreandomurl.com/SodeCystem/test\">http://somreandomurl.com/SodeCystem/test</a>\" :</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"p\">{</span>\n    <span class=\"nt\">\"resourceType\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Encounter\"</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"status\"</span><span class=\"p\">:</span> <span class=\"s2\">\"finished\"</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"class\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n        <span class=\"nt\">\"system\"</span><span class=\"p\">:</span> <span class=\"s2\">\"http://terminology.hl7.org/CodeSystem/v3-ActCode\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"code\"</span><span class=\"p\">:</span> <span class=\"s2\">\"AMB\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"display\"</span><span class=\"p\">:</span> <span class=\"s2\">\"ambulatory\"</span>\n    <span class=\"p\">},</span>\n    <span class=\"nt\">\"type\"</span><span class=\"p\">:</span> <span class=\"p\">[{</span>\n        <span class=\"nt\">\"coding\"</span><span class=\"p\">:</span> <span class=\"p\">[{</span>\n            <span class=\"nt\">\"system\"</span><span class=\"p\">:</span> <span class=\"s2\">\"http://somreandomurl.com/SodeCystem/test\"</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"code\"</span><span class=\"p\">:</span> <span class=\"s2\">\"somecode\"</span>\n        <span class=\"p\">}]</span>\n    <span class=\"p\">}],</span>\n    <span class=\"nt\">\"period\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n        <span class=\"nt\">\"start\"</span><span class=\"p\">:</span> <span class=\"s2\">\"2020-02-06\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"end\"</span><span class=\"p\">:</span> <span class=\"s2\">\"2020-02-06\"</span>\n    <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 216444561,
        "sender_full_name": "Morten Ernebjerg",
        "timestamp": 1605172977
    },
    {
        "content": "<p>I have been experiencing problems as well on a number of different machines, with different network configurations, and with different versions of the Validator. I used WireShark to capture some network traffic and found a number of 502 Bad Gateway responses to <a href=\"http://packages2.fhir.org\">http://packages2.fhir.org</a>. I did notice that one validation (sadly, I can't recall which particular file) did run at what I would call a \"normal\" speed.</p>",
        "id": 216538660,
        "sender_full_name": "Charlie Filkins",
        "timestamp": 1605220240
    },
    {
        "content": "<p>hmm it shouldn't be hitting <a href=\"http://packages2.fhir.org\">packages2.fhir.org</a>...</p>",
        "id": 216539677,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1605220698
    },
    {
        "content": "<p>you'll both be glad to know that for me, validating the fast resource takes 01:28, and the slow resource takes 1:50</p>",
        "id": 216550061,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1605227652
    },
    {
        "content": "<p>and now that I fixed a few things, both now take 00:00.02</p>",
        "id": 216553848,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1605230698
    },
    {
        "content": "<p>Indeed, sounds great! <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 216570156,
        "sender_full_name": "Morten Ernebjerg",
        "timestamp": 1605246523
    }
]