[
    {
        "content": "<p>Hi, I am trying to understand why crucible thinks that the test <a href=\"https://projectcrucible.org/servers/5c89107d04ebd024be000000#5c8a6caf04ebd0675a000008/history001/HI08\" target=\"_blank\" title=\"https://projectcrucible.org/servers/5c89107d04ebd024be000000#5c8a6caf04ebd0675a000008/history001/HI08\">https://projectcrucible.org/servers/5c89107d04ebd024be000000#5c8a6caf04ebd0675a000008/history001/HI08</a> did not return a bundle. If I look at the response: <a href=\"https://projectcrucible.org/servers/5c89107d04ebd024be000000#0-response\" target=\"_blank\" title=\"https://projectcrucible.org/servers/5c89107d04ebd024be000000#0-response\">https://projectcrucible.org/servers/5c89107d04ebd024be000000#0-response</a> I see the xml bundle just fine. Any hints?</p>",
        "id": 160790918,
        "sender_full_name": "Florian Apolloner",
        "timestamp": 1552576978
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191381\">@Jason Walonoski</span> ?</p>",
        "id": 160794860,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1552579131
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192576\">@Robert Scanlon</span> Similar issue to this? <a href=\"#narrow/stream/179204-crucible/topic/Can't.20figure.20out.20why.20test.20fails/near/157278207\" title=\"#narrow/stream/179204-crucible/topic/Can't.20figure.20out.20why.20test.20fails/near/157278207\">https://chat.fhir.org/#narrow/stream/179204-crucible/topic/Can't.20figure.20out.20why.20test.20fails/near/157278207</a></p>",
        "id": 160818424,
        "sender_full_name": "Jason Walonoski",
        "timestamp": 1552594741
    },
    {
        "content": "<p>Hmmm, looking into it now.</p>",
        "id": 160819854,
        "sender_full_name": "Robert Scanlon",
        "timestamp": 1552595786
    },
    {
        "content": "<p>This appears to be Crucible's fault.  I put in a candidate fix but will be a little while before it gets deployed.  <span class=\"user-mention\" data-user-id=\"191381\">@Jason Walonoski</span> : <a href=\"https://github.com/fhir-crucible/fhir_client/pull/110\" target=\"_blank\" title=\"https://github.com/fhir-crucible/fhir_client/pull/110\">https://github.com/fhir-crucible/fhir_client/pull/110</a></p>",
        "id": 160824526,
        "sender_full_name": "Robert Scanlon",
        "timestamp": 1552599069
    },
    {
        "content": "<p>Ah perfect. I have no issue with waiting, I am glad it is not an issue in my code :) Thank you!</p>",
        "id": 160856872,
        "sender_full_name": "Florian Apolloner",
        "timestamp": 1552639765
    },
    {
        "content": "<p>No problem, thanks for the report!  One thing I am noticing is that the order of the entries in the bundle don't always appear to be in the right order, but that issue is being masked by this problem.</p>",
        "id": 160872246,
        "sender_full_name": "Robert Scanlon",
        "timestamp": 1552655088
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>      PASS hi01_history_for_specific_resource_test:\n      PASS hi01.1_history_request_entries_test:\n      PASS hi02_full_history_of_a_resource_by_id_with_since_test:\n      PASS hi03_individual_history_versions_test:\n      PASS hi04_history_for_missing_resource_test:\n      **FAIL hi06_all_history_for_resource_with_since_test: Result contains entries in the wrong order.**\n      PASS hi08_all_history_whole_system_with_since_test:\n      PASS hi09_resource_history_page_forward_test:\n      PASS hi10_resource_history_page_backwards_test:\n      PASS hi11_first_page_full_history_test:\nExecute HistoryTest completed in 19.866114000004018 seconds.\n</pre></div>",
        "id": 160872373,
        "sender_full_name": "Robert Scanlon",
        "timestamp": 1552655189
    },
    {
        "content": "<p>Sometimes it works, sometimes it doesn't, which makes me think that your DB tends to return the data in the right order based on how the data happens to be accessed, but there isn't an explicit sort in there</p>",
        "id": 160872638,
        "sender_full_name": "Robert Scanlon",
        "timestamp": 1552655394
    },
    {
        "content": "<p>(that is total speculation though)</p>",
        "id": 160872702,
        "sender_full_name": "Robert Scanlon",
        "timestamp": 1552655407
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192576\">@Robert Scanlon</span> Yes I also saw that one, but couldn't figure out what the expected order is. I am currently sorting strictly by \"creation_timestamp DESC\" which should mean that newer entries should show up first (every operation creates a new entry and as such also a new version). Also to get the crucible tests passing I have to truncate my database before the testrun because it otherwise fetches old entries marked as deleted (not yet sure if I implement something against the spec here or of the tests in crucible are having issues here)</p>",
        "id": 160872754,
        "sender_full_name": "Florian Apolloner",
        "timestamp": 1552655460
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"213323\">@Florian Apolloner</span> -- We deployed a fix to the issue where the bundle wasn't recognized, so that should be all set.</p>",
        "id": 161088883,
        "sender_full_name": "Robert Scanlon",
        "timestamp": 1552937681
    },
    {
        "content": "<p>I'm curious about the other issues though.  I assume what is being returned now is that issue you need to truncate your database to pass?</p>",
        "id": 161089174,
        "sender_full_name": "Robert Scanlon",
        "timestamp": 1552937892
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192576\">@Robert Scanlon</span> Yeah, I made a mistake there when removing the 'resource' objects for deleted entries. Fixed that and now I get invalid order again: <a href=\"https://projectcrucible.org/servers/5c89107d04ebd024be000000#5c901b6804ebd01d60000002/history001/HI06\" target=\"_blank\" title=\"https://projectcrucible.org/servers/5c89107d04ebd024be000000#5c901b6804ebd01d60000002/history001/HI06\">https://projectcrucible.org/servers/5c89107d04ebd024be000000#5c901b6804ebd01d60000002/history001/HI06</a> -- having a hard time figuring out why though :/</p>",
        "id": 161102337,
        "sender_full_name": "Florian Apolloner",
        "timestamp": 1552948179
    },
    {
        "content": "<p>Ah, I think I failed in incrementing my version ID when recreating a deleted entry.</p>\n<p>EDIT:// Nope, something else seems to be going on there. I noticed that crucible does a PUT with a versionId in the test-setup for that test. Is that allowed? I've left the data as it is currently in the broken state, maybe you have an idea.</p>\n<p>Do I really need to order by version_id instead of just a time based history?</p>",
        "id": 161102480,
        "sender_full_name": "Florian Apolloner",
        "timestamp": 1552948278
    },
    {
        "content": "<p>ie <a href=\"https://bap-fhir.herokuapp.com/fhir/STU3/Patient/_history?_since=2019-03-18T22%3A26%3A53Z\" target=\"_blank\" title=\"https://bap-fhir.herokuapp.com/fhir/STU3/Patient/_history?_since=2019-03-18T22%3A26%3A53Z\">https://bap-fhir.herokuapp.com/fhir/STU3/Patient/_history?_since=2019-03-18T22%3A26%3A53Z</a> currently returns vids 4,3,2,1,4,3,2,1 (since it returns 2 resources), should that return 4,4,3,3,2,2,1,1 instead?</p>",
        "id": 161103210,
        "sender_full_name": "Florian Apolloner",
        "timestamp": 1552948947
    },
    {
        "content": "<p>Doing a create and an update with a meta.versionId is valid, but the server should ignore them and put in their own values: \"If the request body includes a meta, the server SHALL ignore the existing versionId and lastUpdated values. The server SHALL populate the id, meta.versionId and meta.lastUpdated with the new correct values.\" <a href=\"http://hl7.org/fhir/stu3/http.html#create\" target=\"_blank\" title=\"http://hl7.org/fhir/stu3/http.html#create\">http://hl7.org/fhir/stu3/http.html#create</a></p>",
        "id": 161154371,
        "sender_full_name": "Robert Scanlon",
        "timestamp": 1553005290
    },
    {
        "content": "<p>Similar language is in there for updates <a href=\"http://hl7.org/fhir/stu3/http.html#update\" target=\"_blank\" title=\"http://hl7.org/fhir/stu3/http.html#update\">http://hl7.org/fhir/stu3/http.html#update</a></p>",
        "id": 161154533,
        "sender_full_name": "Robert Scanlon",
        "timestamp": 1553005392
    },
    {
        "content": "<p>Now, it appears that Crucible is wrong in that it assumes there is a global incrementing versionId:    <a href=\"https://github.com/fhir-crucible/plan_executor/blob/master/lib/tests/suites/history_test.rb#L307\" target=\"_blank\" title=\"https://github.com/fhir-crucible/plan_executor/blob/master/lib/tests/suites/history_test.rb#L307\">https://github.com/fhir-crucible/plan_executor/blob/master/lib/tests/suites/history_test.rb#L307</a></p>",
        "id": 161154677,
        "sender_full_name": "Robert Scanlon",
        "timestamp": 1553005492
    },
    {
        "content": "<p>\"The version can be globally unique, or scoped by the Logical Id of the resource. Version identifiers are generally either a serially incrementing id scoped by the logical id, or a uuid, though neither of these approaches is required. There is no fixed order for version ids - clients cannot assume that a versionId that comes after another one either numerically or alphabetically represents a later version. The same versionId can never be used for more than one version of the same resource.\" <a href=\"http://hl7.org/fhir/stu3/resource.html#metadata\" target=\"_blank\" title=\"http://hl7.org/fhir/stu3/resource.html#metadata\">http://hl7.org/fhir/stu3/resource.html#metadata</a></p>",
        "id": 161154870,
        "sender_full_name": "Robert Scanlon",
        "timestamp": 1553005632
    },
    {
        "content": "<p>So i think we need to remove that line, and perhaps add some logic to make sure that versionIds are not reused within a single resource.</p>",
        "id": 161155055,
        "sender_full_name": "Robert Scanlon",
        "timestamp": 1553005769
    },
    {
        "content": "<p>FYI <span class=\"user-mention\" data-user-id=\"191381\">@Jason Walonoski</span>, let me know if there is something I'm not considering here.  I think this part of the test might have been from an early version of FHIR that did not have concrete guidance on version ids.</p>",
        "id": 161155469,
        "sender_full_name": "Robert Scanlon",
        "timestamp": 1553005980
    },
    {
        "content": "<p>Yes, it looks like incrementing version ids are not required... which is sad, because it means they are totally opaque and meaningless. We need to change the logic that you linked to.</p>",
        "id": 161161823,
        "sender_full_name": "Jason Walonoski",
        "timestamp": 1553010117
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192576\">@Robert Scanlon</span> Ah yes, I have version numbers per resource_id, not something globally unique, even though that would be easily doable. Thank you for your help!</p>",
        "id": 161165351,
        "sender_full_name": "Florian Apolloner",
        "timestamp": 1553012489
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"213323\">@Florian Apolloner</span> -- To be clear, version ids don't have to be globally unique, just unique on a per resource basis, according to the spec.  But you can make them globally unique if you'd like (uuids would do that).  We'll update our tests to remove the logic that assumes they are incrementing integers and will update here when that is deployed.  Thanks again!</p>",
        "id": 161169040,
        "sender_full_name": "Robert Scanlon",
        "timestamp": 1553014870
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"213323\">@Florian Apolloner</span> -- fixed the issue on our side with requiring incrementing global versioning and now it looks good.  <a href=\"https://projectcrucible.org/servers/5c89107d04ebd024be000000#5c946aeb04ebd0266c000002/history001/HI01\" target=\"_blank\" title=\"https://projectcrucible.org/servers/5c89107d04ebd024be000000#5c946aeb04ebd0266c000002/history001/HI01\">https://projectcrucible.org/servers/5c89107d04ebd024be000000#5c946aeb04ebd0266c000002/history001/HI01</a></p>",
        "id": 161420485,
        "sender_full_name": "Robert Scanlon",
        "timestamp": 1553230691
    },
    {
        "content": "<p>Ah lovely. Many thanks!</p>",
        "id": 161429763,
        "sender_full_name": "Florian Apolloner",
        "timestamp": 1553243928
    }
]