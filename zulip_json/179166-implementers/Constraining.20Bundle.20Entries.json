[
    {
        "content": "<p>We have a use case where we need to constrain the entries in a Bundle. What is the correct way to achieve this?</p>\n<p>1) How would you constrain the first entry to be a  \"MessageHeader\" resource?<br>\n2) How would you constrain the first entry to be a \"MessageHeader\" with Profiles \"xxxxx\"?</p>\n<p>FHIR stipulates that certain Bundle types have constraints, looking for a way to describe these in a StructureDefinition.</p>\n<p>A \"FHIR Document\" Bundle states the first entry is a Composition<br>\nA \"FHIR Message\" Bundle states the first entry is a MessageHeader</p>",
        "id": 153873018,
        "sender_full_name": "Richard Kavanagh",
        "timestamp": 1487750383
    },
    {
        "content": "<p>I've done it using invariants.  In principle you can do it with slicing, but the validator used to have trouble slicing through Resource (as opposed to Reference)</p>",
        "id": 153873021,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1487755578
    },
    {
        "content": "<p>In terms of profiles, at the moment with FHIRPath the best you can do is force a given profile to be declared (and then rely on the validator to validate against that profile).  There isn't yet a mechanism in FHIRPath to assert that a given element must be valid against a specified profile, though a request has been made to add such a feature.</p>",
        "id": 153873022,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1487755649
    },
    {
        "content": "<p>I have currently set it up with slicing the following way for a fhir document enforing a composition and it works with the validator:</p>\n<div class=\"codehilite\"><pre>&lt;differential&gt;\n        &lt;element id=&quot;Bundle&quot;&gt;\n            &lt;path value=&quot;Bundle&quot; /&gt;\n            &lt;min value=&quot;1&quot; /&gt;\n            &lt;max value=&quot;1&quot; /&gt;\n        &lt;/element&gt;\n        &lt;element id=&quot;Bundle.type&quot;&gt;\n            &lt;path value=&quot;Bundle.type&quot; /&gt;\n            &lt;fixedCode value=&quot;document&quot; /&gt;\n        &lt;/element&gt;\n        &lt;element id=&quot;Bundle.entry&quot;&gt;\n            &lt;path value=&quot;Bundle.entry&quot; /&gt;\n            &lt;slicing&gt;\n                &lt;discriminator&gt;\n                    &lt;type value=&quot;type&quot; /&gt;\n                    &lt;path value=&quot;resource.type&quot; /&gt;\n                &lt;/discriminator&gt;\n                &lt;ordered value=&quot;true&quot; /&gt;\n                &lt;rules value=&quot;openAtEnd&quot; /&gt;\n            &lt;/slicing&gt;\n            &lt;min value=&quot;1&quot; /&gt;\n            &lt;max value=&quot;*&quot; /&gt;\n        &lt;/element&gt;\n        &lt;element id=&quot;Bundle.entry.resource:Composition&quot;&gt;\n            &lt;path value=&quot;Bundle.entry.resource&quot; /&gt; \n          &lt;sliceName value=&quot;Composition&quot; /&gt;\n            &lt;min value=&quot;1&quot; /&gt;\n            &lt;max value=&quot;1&quot; /&gt;\n            &lt;type&gt;\n                &lt;code value=&quot;Composition&quot; /&gt;\n                &lt;profile value=&quot;snip&quot;/&gt; \n            &lt;/type&gt;\n        &lt;/element&gt;\n    &lt;/differential&gt;\n</pre></div>",
        "id": 153873024,
        "sender_full_name": "Oliver Egger",
        "timestamp": 1487759526
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span>  That's what I feared... For DSTU2 the base resources dont have FHIRPath so will need to see what can be achieved in that area looks like we will have to inject a little non standard validation.</p>\n<p>As for using the \"validator\" then shaping things to work around that seems strange especially considering that will not be a choice that many people make.</p>\n<p><span class=\"user-mention\" data-user-id=\"191478\">@Oliver Egger</span> Your suggestions gets us half way to where we need to be and looks like an approach we'll explore - thank you.</p>\n<p>As for the complete requirements then I guess it's something that FHIR just does not support at this point in time.</p>",
        "id": 153873025,
        "sender_full_name": "Richard Kavanagh",
        "timestamp": 1487759962
    },
    {
        "content": "<p>I've done similar to Oliver but this was for display purposes (using Endeavour/InterOpen's profile generator). [Document Bundle <a href=\"http://test-rr8.trust.leedsth.nhs.uk:8080/web/fhir/Bundle.Document.html\" target=\"_blank\" title=\"http://test-rr8.trust.leedsth.nhs.uk:8080/web/fhir/Bundle.Document.html\">http://test-rr8.trust.leedsth.nhs.uk:8080/web/fhir/Bundle.Document.html</a>  - N3 connection is required]</p>",
        "id": 153873026,
        "sender_full_name": "Kevin Mayfield",
        "timestamp": 1487759987
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191362\">@Richard Kavanagh</span> my  example is also R3, for DSTU2 it would be</p>\n<div class=\"codehilite\"><pre><span></span>&lt;slicing&gt;\n                &lt;discriminator value=&quot;resource.@type&quot; /&gt;\n                &lt;ordered value=&quot;true&quot; /&gt;\n                &lt;rules value=&quot;openAtEnd&quot; /&gt;\n            &lt;/slicing&gt;\n</pre></div>",
        "id": 153873029,
        "sender_full_name": "Oliver Egger",
        "timestamp": 1487764580
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191362\">@Richard Kavanagh</span> It's fully enforceable with xpath too.  If you intend to use the validator and don't have time/ability to enhance it, then its limitations are relevant (it was for my project).  Perfectly fine for it not to be relevant to you :)</p>",
        "id": 153873048,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1487774718
    },
    {
        "content": "<p>I think that FHIRPath is available in R2 in the C# code. It certainly is in java</p>",
        "id": 153873275,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1487963071
    },
    {
        "content": "<p>forcing an element to conform to a slice in a FHIRPath invariant:</p>",
        "id": 153873278,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1487963090
    },
    {
        "content": "<div class=\"codehilite\"><pre>[some path].conformsTo(&quot;http://hl7.org/fhir/StructureDefinition/integer&quot;)\n</pre></div>",
        "id": 153873280,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1487963162
    },
    {
        "content": "<p>though a profile URL would be appropriate, not a base type</p>",
        "id": 153873281,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1487963181
    },
    {
        "content": "<p>conformsTo is new and not yet supported by the Java code, correct?</p>",
        "id": 153873316,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1487967275
    },
    {
        "content": "<p>it's not new. but agree it's not implemented in the code yet</p>",
        "id": 153873317,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1487967329
    },
    {
        "content": "<p>not sure about using it in the validator either - could easily get circular</p>",
        "id": 153873318,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1487967352
    },
    {
        "content": "<p>Not sure about \"easily\" but it's within the realm of theoreticaly possibility</p>",
        "id": 153873321,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1487967504
    },
    {
        "content": "<p>Yes, can confirm that the fhirpath expressions are in the c# code also.</p>",
        "id": 153873471,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1488070267
    },
    {
        "content": "<p>Both in the invariant definitions and also the search parameter expressions.<br>\n(there was a standard extension added to hold them)</p>",
        "id": 153873472,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1488070307
    }
]