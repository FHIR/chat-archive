[
    {
        "content": "<p>Im trying to make a reference between \"Practitoner\" and \"PractitionerRole\". Both are contained resources within an appointment.</p>\n<div class=\"codehilite\"><pre><span></span><code>&lt;contained&gt;\n    &lt;Practitioner&gt;\n      &lt;id value=&quot;1&quot; /&gt;\n      &lt;text&gt;\n        &lt;status value=&quot;generated&quot; /&gt;\n        &lt;div xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;vorname1 NachnameDesBehandlers&lt;/div&gt;\n      &lt;/text&gt;\n      &lt;name&gt;\n        &lt;text value=&quot;vorname1 NachnameDesBehandlers&quot; /&gt;\n        &lt;family value=&quot;NachnameDesBehandlers&quot; /&gt;\n        &lt;given value=&quot;vorname1&quot; /&gt;\n        &lt;given value=&quot;vorname2&quot; /&gt;\n      &lt;/name&gt;\n    &lt;/Practitioner&gt;\n  &lt;/contained&gt;\n  &lt;contained&gt;\n    &lt;PractitionerRole&gt;\n      &lt;id value=&quot;0&quot; /&gt;\n      &lt;text&gt;\n        &lt;status value=&quot;generated&quot; /&gt;\n        &lt;div xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;Behandler: vorname1 NachnameDesBehandlers&lt;/div&gt;\n      &lt;/text&gt;\n      &lt;practitioner&gt;\n        &lt;reference value=&quot;#1&quot; /&gt;\n      &lt;/practitioner&gt;\n      &lt;code&gt;\n        &lt;coding&gt;\n          &lt;system value=&quot;http://fhir.uniklinik-freiburg.de/ig/appointment/ValueSet/PractionerRoleVS&quot; /&gt;\n          &lt;code value=&quot;Behandler&quot; /&gt;\n          &lt;display value=&quot;Behandler: vorname1 NachnameDesBehandlers&quot; /&gt;\n        &lt;/coding&gt;\n        &lt;text value=&quot;vorname1 NachnameDesBehandlers&quot; /&gt;\n      &lt;/code&gt;\n    &lt;/PractitionerRole&gt;\n  &lt;/contained&gt;\n</code></pre></div>\n\n\n<p>When validating, I got an error:</p>\n<div class=\"codehilite\"><pre><span></span><code>&lt;issue&gt;\n    &lt;severity value=&quot;error&quot;/&gt;\n    &lt;code value=&quot;processing&quot;/&gt;\n    &lt;diagnostics value=&quot;ref-1: SHALL have a contained resource if a local reference is provided ( (url: 1; ids: )) [reference.startsWith(&#39;#&#39;).not() or (reference.substring(1).trace(&#39;url&#39;) in %resource.contained.id.trace(&#39;ids&#39;))]&quot;/&gt;\n    &lt;location value=&quot;Appointment.contained[1].practitioner&quot;/&gt;\n    &lt;location value=&quot;Line 31, Col 21&quot;/&gt;\n&lt;/issue&gt;\n</code></pre></div>",
        "id": 198040542,
        "sender_full_name": "Michael Sauer",
        "timestamp": 1589880090
    },
    {
        "content": "<p><del>The Practitioner should be contained inside the PractitionerRole (...but it gets really weird)</del> (wrong, sorry, see below)</p>",
        "id": 198062087,
        "sender_full_name": "Michele Mottini",
        "timestamp": 1589893515
    },
    {
        "content": "<p>contained resources can't contain other resources :)</p>",
        "id": 198070014,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1589897006
    },
    {
        "content": "<p>\"Contained resources SHALL NOT contain additional contained resources.\" from <a href=\"http://hl7.org/fhir/references.html#contained\">http://hl7.org/fhir/references.html#contained</a></p>",
        "id": 198070425,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1589897161
    },
    {
        "content": "<p>That validation seems wrong</p>",
        "id": 198070621,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1589897237
    },
    {
        "content": "<p>unless I'm missing something...</p>",
        "id": 198070841,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1589897319
    },
    {
        "content": "<p>It's  a resource with 2 sibling-contained-resources. That's ok. They should be able to reference each other.</p>",
        "id": 198075165,
        "sender_full_name": "Ren√© Spronk",
        "timestamp": 1589899076
    },
    {
        "content": "<p>that is what I would expect too - may need to reach out to Hapi (if that's the validator) to see why this fails?</p>",
        "id": 198076951,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1589899740
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191356\">@Jenni Syed</span> is correct.  All contained resources must be siblings.  You can't have a contained within a contained.  The identifiers are all evaluated within the scope of the overall containing resource.  It looks like there's a problem with the invariant - it doesn't allow for the possibility of the linkage from the container to a contained resource being through <em>another</em> contained resource.  In the short term, you may need an extension to create a link to satisfy the invariant.  However, please submit a change request for us to fix the invariant <span class=\"user-mention\" data-user-id=\"194649\">@Michael Sauer</span></p>",
        "id": 198084342,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1589902575
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> Thank you very much for your clarification and for your explanation. I will submit a change request! :-)</p>",
        "id": 198085925,
        "sender_full_name": "Michael Sauer",
        "timestamp": 1589903254
    },
    {
        "content": "<p>Can one contained resource reference another contained resource within the same container? E.g., the List resource has Patient and Encounter as contained resources, and the contained Encounter reference to the contained Patient.</p>",
        "id": 246470148,
        "sender_full_name": "Shamil Nizamov",
        "timestamp": 1626708447
    },
    {
        "content": "<p>Yes.</p>",
        "id": 246470296,
        "sender_full_name": "Paul Church",
        "timestamp": 1626708491
    },
    {
        "content": "<p>Then what will be the reference link - in the same way as List references to the contained Patient, e.g., <em>#patient1</em> , or back to the container and then to the contained, i.e., - <em>#/#patient1</em> ?</p>",
        "id": 246470940,
        "sender_full_name": "Shamil Nizamov",
        "timestamp": 1626708745
    },
    {
        "content": "<p>It's just #patient1. Because contained resources cannot be nested, there is only one namespace.</p>",
        "id": 246471099,
        "sender_full_name": "Paul Church",
        "timestamp": 1626708832
    },
    {
        "content": "<p>The only special case is that \"#\" refers to the container.</p>",
        "id": 246471189,
        "sender_full_name": "Paul Church",
        "timestamp": 1626708873
    }
]