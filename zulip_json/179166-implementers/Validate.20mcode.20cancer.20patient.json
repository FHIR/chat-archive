[
    {
        "content": "<p>Hi! I am building an application that would work with mcode profiles.<br>\nRight now i have a problem with validating it using hapi-fhir library:</p>\n<p>I use canonicals to load structure definitions: </p>\n<div class=\"codehilite\"><pre><span></span>    <span class=\"n\">String</span> <span class=\"n\">mcodeCancerPatient</span> <span class=\"o\">=</span> <span class=\"s\">&quot;http://hl7.org/fhir/us/mcode/StructureDefinition/mcode-cancer-patient&quot;</span><span class=\"p\">;</span>\n    <span class=\"n\">String</span> <span class=\"n\">usCoreRaceExtension</span> <span class=\"o\">=</span> <span class=\"s\">&quot;http://hl7.org/fhir/us/core/StructureDefinition/us-core-race&quot;</span><span class=\"p\">;</span>\n    <span class=\"n\">String</span> <span class=\"n\">usCoreEthnicityExtension</span> <span class=\"o\">=</span> <span class=\"s\">&quot;http://hl7.org/fhir/us/core/StructureDefinition/us-core-ethnicity&quot;</span><span class=\"p\">;</span>\n    <span class=\"n\">String</span> <span class=\"n\">usCoreBithsexExtension</span> <span class=\"o\">=</span> <span class=\"s\">&quot;http://hl7.org/fhir/us/core/StructureDefinition/us-core-birthsex&quot;</span><span class=\"p\">;</span>\n    <span class=\"n\">String</span> <span class=\"n\">ombRaceCategory</span> <span class=\"o\">=</span> <span class=\"s\">&quot;http://hl7.org/fhir/us/core/ValueSet/omb-race-category&quot;</span><span class=\"p\">;</span>\n\n    <span class=\"n\">ResponseEntity</span><span class=\"o\">&lt;</span><span class=\"n\">String</span><span class=\"o\">&gt;</span> <span class=\"n\">cancerPatient</span> <span class=\"o\">=</span> <span class=\"n\">restTemplate</span><span class=\"p\">.</span><span class=\"na\">getForEntity</span><span class=\"p\">(</span><span class=\"n\">mcodeCancerPatient</span><span class=\"p\">,</span> <span class=\"n\">String</span><span class=\"p\">.</span><span class=\"na\">class</span><span class=\"p\">);</span>\n    <span class=\"n\">ResponseEntity</span><span class=\"o\">&lt;</span><span class=\"n\">String</span><span class=\"o\">&gt;</span> <span class=\"n\">raceExtension</span> <span class=\"o\">=</span> <span class=\"n\">restTemplate</span><span class=\"p\">.</span><span class=\"na\">getForEntity</span><span class=\"p\">(</span><span class=\"n\">usCoreRaceExtension</span><span class=\"p\">,</span> <span class=\"n\">String</span><span class=\"p\">.</span><span class=\"na\">class</span><span class=\"p\">);</span>\n    <span class=\"n\">ResponseEntity</span><span class=\"o\">&lt;</span><span class=\"n\">String</span><span class=\"o\">&gt;</span> <span class=\"n\">ethnicityExtension</span> <span class=\"o\">=</span> <span class=\"n\">restTemplate</span><span class=\"p\">.</span><span class=\"na\">getForEntity</span><span class=\"p\">(</span><span class=\"n\">usCoreEthnicityExtension</span><span class=\"p\">,</span> <span class=\"n\">String</span><span class=\"p\">.</span><span class=\"na\">class</span><span class=\"p\">);</span>\n    <span class=\"n\">ResponseEntity</span><span class=\"o\">&lt;</span><span class=\"n\">String</span><span class=\"o\">&gt;</span> <span class=\"n\">birthsexExtension</span> <span class=\"o\">=</span> <span class=\"n\">restTemplate</span><span class=\"p\">.</span><span class=\"na\">getForEntity</span><span class=\"p\">(</span><span class=\"n\">usCoreBithsexExtension</span><span class=\"p\">,</span> <span class=\"n\">String</span><span class=\"p\">.</span><span class=\"na\">class</span><span class=\"p\">);</span>\n    <span class=\"n\">ResponseEntity</span><span class=\"o\">&lt;</span><span class=\"n\">String</span><span class=\"o\">&gt;</span> <span class=\"n\">ombRaceCategoryResp</span> <span class=\"o\">=</span> <span class=\"n\">restTemplate</span><span class=\"p\">.</span><span class=\"na\">getForEntity</span><span class=\"p\">(</span><span class=\"n\">ombRaceCategory</span><span class=\"p\">,</span> <span class=\"n\">String</span><span class=\"p\">.</span><span class=\"na\">class</span><span class=\"p\">);</span>\n\n    <span class=\"n\">StructureDefinition</span> <span class=\"n\">cancerPatientDefinition</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">StructureDefinition</span><span class=\"p\">)</span> <span class=\"n\">parser</span><span class=\"p\">.</span><span class=\"na\">parseResource</span><span class=\"p\">(</span><span class=\"n\">cancerPatient</span><span class=\"p\">.</span><span class=\"na\">getBody</span><span class=\"p\">());</span>\n    <span class=\"n\">StructureDefinition</span> <span class=\"n\">raceExtensionDefinition</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">StructureDefinition</span><span class=\"p\">)</span> <span class=\"n\">parser</span><span class=\"p\">.</span><span class=\"na\">parseResource</span><span class=\"p\">(</span><span class=\"n\">raceExtension</span><span class=\"p\">.</span><span class=\"na\">getBody</span><span class=\"p\">());</span>\n    <span class=\"n\">StructureDefinition</span> <span class=\"n\">ethnicityExtensionDefinition</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">StructureDefinition</span><span class=\"p\">)</span> <span class=\"n\">parser</span><span class=\"p\">.</span><span class=\"na\">parseResource</span><span class=\"p\">(</span><span class=\"n\">ethnicityExtension</span><span class=\"p\">.</span><span class=\"na\">getBody</span><span class=\"p\">());</span>\n    <span class=\"n\">StructureDefinition</span> <span class=\"n\">birthsexExtensionDefinition</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">StructureDefinition</span><span class=\"p\">)</span> <span class=\"n\">parser</span><span class=\"p\">.</span><span class=\"na\">parseResource</span><span class=\"p\">(</span><span class=\"n\">birthsexExtension</span><span class=\"p\">.</span><span class=\"na\">getBody</span><span class=\"p\">());</span>\n</pre></div>\n\n\n<p>then i create FhirValidator and passing structure definitions to it:</p>\n<div class=\"codehilite\"><pre><span></span>    <span class=\"n\">Resource</span> <span class=\"n\">resource</span> <span class=\"o\">=</span> <span class=\"n\">resourceLoader</span><span class=\"p\">.</span><span class=\"na\">getResource</span><span class=\"p\">(</span><span class=\"s\">&quot;classpath:codesystem/CodeSystem-cdcrec.json&quot;</span><span class=\"p\">);</span>\n    <span class=\"n\">CodeSystem</span> <span class=\"n\">raceAndEthnicityCodeSystem</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">CodeSystem</span><span class=\"p\">)</span> <span class=\"n\">parser</span><span class=\"p\">.</span><span class=\"na\">parseResource</span><span class=\"p\">(</span><span class=\"n\">resource</span><span class=\"p\">.</span><span class=\"na\">getInputStream</span><span class=\"p\">());</span>\n    <span class=\"n\">ValueSet</span> <span class=\"n\">ombRaceValueSet</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">ValueSet</span><span class=\"p\">)</span> <span class=\"n\">parser</span><span class=\"p\">.</span><span class=\"na\">parseResource</span><span class=\"p\">(</span><span class=\"n\">ombRaceCategoryResp</span><span class=\"p\">.</span><span class=\"na\">getBody</span><span class=\"p\">());</span>\n\n    <span class=\"n\">PrePopulatedValidationSupport</span> <span class=\"n\">prePopulatedValidationSupport</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"n\">PrePopulatedValidationSupport</span><span class=\"p\">();</span>\n    <span class=\"n\">prePopulatedValidationSupport</span><span class=\"p\">.</span><span class=\"na\">addStructureDefinition</span><span class=\"p\">(</span><span class=\"n\">cancerPatientDefinition</span><span class=\"p\">);</span>\n    <span class=\"n\">prePopulatedValidationSupport</span><span class=\"p\">.</span><span class=\"na\">addStructureDefinition</span><span class=\"p\">(</span><span class=\"n\">raceExtensionDefinition</span><span class=\"p\">);</span>\n    <span class=\"n\">prePopulatedValidationSupport</span><span class=\"p\">.</span><span class=\"na\">addStructureDefinition</span><span class=\"p\">(</span><span class=\"n\">ethnicityExtensionDefinition</span><span class=\"p\">);</span>\n    <span class=\"n\">prePopulatedValidationSupport</span><span class=\"p\">.</span><span class=\"na\">addStructureDefinition</span><span class=\"p\">(</span><span class=\"n\">birthsexExtensionDefinition</span><span class=\"p\">);</span>\n\n    <span class=\"n\">prePopulatedValidationSupport</span><span class=\"p\">.</span><span class=\"na\">addValueSet</span><span class=\"p\">(</span><span class=\"n\">ombRaceValueSet</span><span class=\"p\">);</span>\n    <span class=\"n\">prePopulatedValidationSupport</span><span class=\"p\">.</span><span class=\"na\">addCodeSystem</span><span class=\"p\">(</span><span class=\"n\">raceAndEthnicityCodeSystem</span><span class=\"p\">);</span>\n    <span class=\"n\">FhirValidator</span> <span class=\"n\">fhirValidator</span> <span class=\"o\">=</span> <span class=\"n\">FhirVersion</span><span class=\"p\">.</span><span class=\"na\">R4</span><span class=\"p\">.</span><span class=\"na\">getFhirContext</span><span class=\"p\">().</span><span class=\"na\">newValidator</span><span class=\"p\">();</span>\n    <span class=\"n\">ValidationSupportChain</span> <span class=\"n\">validationSupportChain</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"n\">ValidationSupportChain</span><span class=\"p\">(</span>\n      <span class=\"k\">new</span> <span class=\"n\">DefaultProfileValidationSupport</span><span class=\"p\">(),</span>\n      <span class=\"n\">prePopulatedValidationSupport</span>\n    <span class=\"p\">);</span>\n    <span class=\"n\">FhirInstanceValidator</span> <span class=\"n\">instanceValidator</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"n\">FhirInstanceValidator</span><span class=\"p\">(</span><span class=\"n\">validationSupportChain</span><span class=\"p\">);</span>\n    <span class=\"n\">fhirValidator</span><span class=\"p\">.</span><span class=\"na\">registerValidatorModule</span><span class=\"p\">(</span><span class=\"n\">instanceValidator</span><span class=\"p\">);</span>\n</pre></div>\n\n\n<p>Then i am validating resource: </p>\n<div class=\"codehilite\"><pre><span></span>{\n  &quot;resourceType&quot;: &quot;Patient&quot;,\n  &quot;id&quot;: &quot;1&quot;,\n  &quot;meta&quot;: {\n    &quot;versionId&quot;: &quot;1&quot;,\n    &quot;profile&quot;: [\n      &quot;http://hl7.org/fhir/us/mcode/StructureDefinition/mcode-cancer-patient&quot;\n    ]\n  },\n  &quot;extension&quot;: [\n    {\n      &quot;url&quot;: &quot;http://hl7.org/fhir/us/core/StructureDefinition/us-core-race&quot;,\n      &quot;extension&quot;: [\n        {\n          &quot;url&quot;: &quot;ombCategory&quot;,\n          &quot;valueCoding&quot;: {\n            &quot;system&quot;: &quot;urn:oid:2.16.840.1.113883.6.238&quot;,\n            &quot;code&quot;: &quot;2076-8&quot;,\n            &quot;display&quot;: &quot;Native Hawaiian or Other Pacific Islander&quot;\n          }\n        },\n        {\n          &quot;url&quot;: &quot;text&quot;,\n          &quot;valueString&quot;: &quot;Native Hawaiian Or Other Pacific Islander&quot;\n        }\n      ]\n    },\n    {\n      &quot;url&quot;: &quot;http://hl7.org/fhir/us/core/StructureDefinition/us-core-ethnicity&quot;,\n      &quot;extension&quot;: [\n        {\n          &quot;url&quot;: &quot;ombCategory&quot;,\n          &quot;valueCoding&quot;: {\n            &quot;system&quot;: &quot;urn:oid:2.16.840.1.113883.6.238&quot;,\n            &quot;code&quot;: &quot;2186-5&quot;,\n            &quot;display&quot;: &quot;Not Hispanic or Latino&quot;\n          }\n        },\n        {\n          &quot;url&quot;: &quot;text&quot;,\n          &quot;valueString&quot;: &quot;Black Or African American&quot;\n        }\n      ]\n    }\n  ],\n  &quot;identifier&quot;: [\n    {\n      &quot;use&quot;: &quot;usual&quot;,\n      &quot;type&quot;: {\n        &quot;coding&quot;: [\n          {\n            &quot;system&quot;: &quot;http://terminology.hl7.org/CodeSystem/v2-0203&quot;,\n            &quot;code&quot;: &quot;MR&quot;\n          }\n        ]\n      },\n      &quot;system&quot;: &quot;urn:oid:1.2.36.146.595.217.0.1&quot;,\n      &quot;value&quot;: &quot;12345&quot;,\n      &quot;period&quot;: {\n        &quot;start&quot;: &quot;2001-05-06&quot;\n      },\n      &quot;assigner&quot;: {\n        &quot;display&quot;: &quot;Acme Healthcare&quot;\n      }\n    }\n  ],\n  &quot;active&quot;: true,\n  &quot;name&quot;: [\n    {\n      &quot;use&quot;: &quot;official&quot;,\n      &quot;family&quot;: &quot;Chalmers&quot;,\n      &quot;given&quot;: [\n        &quot;Peter&quot;,\n        &quot;James&quot;\n      ]\n    },\n    {\n      &quot;use&quot;: &quot;usual&quot;,\n      &quot;given&quot;: [\n        &quot;Jim&quot;\n      ]\n    },\n    {\n      &quot;use&quot;: &quot;maiden&quot;,\n      &quot;family&quot;: &quot;Windsor&quot;,\n      &quot;given&quot;: [\n        &quot;Peter&quot;,\n        &quot;James&quot;\n      ],\n      &quot;period&quot;: {\n        &quot;end&quot;: &quot;2002&quot;\n      }\n    }\n  ],\n  &quot;gender&quot;: &quot;female&quot;,\n  &quot;birthDate&quot;: &quot;1990-02-12&quot;,\n  &quot;deceasedDateTime&quot;: &quot;2020-03-20T00:00:00+03:00&quot;,\n}\n</pre></div>\n\n\n<p>But ValidationResult gives me next message:<br>\nUnknown code: urn:oid:2.16.840.1.113883.6.238 / 2076-8</p>\n<p>I've lost a lot of time debugging this problem and it seems to me like validator can't validate complex extensions (like us core race) and doesn't properly handle bindings on elements.</p>\n<p>I will be glad to any help, thanks!</p>",
        "id": 192548367,
        "sender_full_name": "Roman Rodnin",
        "timestamp": 1585755832
    },
    {
        "content": "<p>You can't use an OID as the system id of something that has a defined URL</p>",
        "id": 192558428,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1585760021
    },
    {
        "content": "<p>There's an official URL for the race &amp; ethnicity code system used by US core - and that's the only URI permitted.  If you're converting between v3 (e.g. CDA) and FHIR, you must transform your code and identifier systems wherever an official URL has been defined.  (And in general you're encouraged to convert from OIDs to URLs everywhere - using OIDs is harder on implementers, can't resolve, etc.</p>",
        "id": 192558723,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1585760135
    },
    {
        "content": "<p>I've download the codesystem here: <a href=\"https://www.hl7.org/fhir/us/core/CodeSystem-cdcrec.html\" title=\"https://www.hl7.org/fhir/us/core/CodeSystem-cdcrec.html\">https://www.hl7.org/fhir/us/core/CodeSystem-cdcrec.html</a> <br>\nand there is no defined URL</p>",
        "id": 192559700,
        "sender_full_name": "Roman Rodnin",
        "timestamp": 1585760497
    },
    {
        "content": "<p>It's unfortunate that US Core chose to stick with an OID (<span class=\"user-mention\" data-user-id=\"191410\">@Brett Marquard</span> <span class=\"user-mention\" data-user-id=\"191401\">@Eric Haas</span>  - any insight on why?)  From a validation perspective if you pass in the id of the US Core IG as part of the validation, it should load the definition for that code system and validate correctly.</p>",
        "id": 192562610,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1585761660
    },
    {
        "content": "<p>But i have already load this codesystem from file to a ValidationModule, and all other required  StructureDefinitions as well. Is there any example of validating us core patient using hapi-fhir library? I didn't find one</p>",
        "id": 192564552,
        "sender_full_name": "Roman Rodnin",
        "timestamp": 1585762468
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span></p>",
        "id": 192567513,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1585763768
    },
    {
        "content": "<p>that OID is available and used by the other HL7 standards and a URL is not.</p>",
        "id": 192567628,
        "sender_full_name": "Eric Haas",
        "timestamp": 1585763823
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"253983\">@Roman Rodnin</span> the current validator validates this jut fine. What versions of hapi-fhir and fhir-core are you using?</p>",
        "id": 192576127,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1585767455
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span>  i am using the latest (4.2.0)</p>",
        "id": 192577225,
        "sender_full_name": "Roman Rodnin",
        "timestamp": 1585767871
    },
    {
        "content": "<p>then the problem is probably to do with the way HAPI hosts the validator. Thats getting a lot of work in 5.x of HAPI</p>",
        "id": 192577603,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1585768040
    },
    {
        "content": "<p>So, is this a bug in 4.2.0 version and i should wait for it being fixed or my code contains some errors?</p>",
        "id": 192579371,
        "sender_full_name": "Roman Rodnin",
        "timestamp": 1585768735
    },
    {
        "content": "<p>I don't know. you should ask on the <a class=\"stream\" data-stream-id=\"179167\" href=\"/#narrow/stream/179167-hapi\">#hapi</a> stream or the HAPI support forum (after trying with v5 first)</p>",
        "id": 192580818,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1585769412
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191401\">@Eric Haas</span> There are OIDs available for lots of code systems - we still define URLs for most because OIDs suck and it's better to suffer the pain of mapping between OIDs and URLs than to suffer the pain of OIDs ongoing.  (All implementers will have to support mapping regardless because of the number of terminology and identifiers that <em>do</em> have URLs that are mandated.)</p>",
        "id": 192590948,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1585774106
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> Thank you! Moving to snapshot version of library helped me a lot. <br>\nNow i stuck with validating snomed ct codes. As i understand i should have ValueSet resource and CodeSystem as well provided to the <em>PrePopulatedValidationSupport</em>, but i can't find snomedct CodeSystem resource to download. I found that there is <em>ITerminologyServices</em> interface authored by you, but without any implementations or usage examples. Could you please help me with this?<br>\n(Probably i should have created a new topic in #hapi stream, but i don't want to spam everywhere)</p>",
        "id": 192677312,
        "sender_full_name": "Roman Rodnin",
        "timestamp": 1585839526
    },
    {
        "content": "<p>you won't find a CodeSystem resource for the big public terminologies; they have their own custom perfectly honed distribution formats already, and trying to reproduce them in a generic format like CodeSystem results in resources that are GB large.</p>",
        "id": 192716726,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1585857006
    },
    {
        "content": "<p>so HAPI has it's own Snomed provider</p>",
        "id": 192716740,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1585857015
    }
]