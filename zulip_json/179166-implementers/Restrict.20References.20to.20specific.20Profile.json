[
    {
        "content": "<p>Hi all,</p>\n<p>i created two custom Profiles:</p>\n<ul>\n<li>MyCareTeam</li>\n<li>MyPatient</li>\n</ul>\n<p>My goal is to restrict MyCareTeam.subject, so that only resources conforming to the MyPatient profile can be referenced inside the CareTeam resource. </p>\n<p>I thought i will be able to achieve it by just removing the default target Profile and add my custom one. <a href=\"/user_uploads/10155/4P83x1XWRD8ThHn9r3RY9l1U/forge.png\">forge.png</a><br>\nBut testing it on a HAPI 5.1.0 Server with validation enabled, i am still able to reference Patient-Resources that don't conform to the MyPatient Profile. </p>\n<p><strong>Update:</strong><br>\nI uploaded my StructureDefinitions to <a href=\"http://hapi.fhir.org/baseR4\">http://hapi.fhir.org/baseR4</a>:</p>\n<ul>\n<li><a href=\"http://www.google.com/url?q=http%3A%2F%2Fhapi.fhir.org%2FbaseR4%2FStructureDefinition%2F1437751%2F&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHd1iqqlibbiicd2XvhicUZqINDaw\">MyPatient</a> : needs to have a <strong>gender</strong> (by changing cardinality to 1..1)</li>\n<li><a href=\"http://www.google.com/url?q=http%3A%2F%2Fhapi.fhir.org%2FbaseR4%2FStructureDefinition%2F1437752%2F&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHJotvWpIa4w63QAthkeIO3B3tc4Q\">MyCareTeam</a> : only allows MyPatient-References in <strong>subject</strong> (by removing the default target Profiles and adding the cannonical URL for MyPatient)</li>\n</ul>\n<p>Than i uploaded 2 resources of Patient and 2 resources of CareTeam:</p>\n<ul>\n<li><a href=\"http://www.google.com/url?q=http%3A%2F%2Fhapi.fhir.org%2FbaseR4%2FPatient%2F1438246&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNFw_KPiDkNmYzrGQC5D9qJO4iOpNA\">Patient conforming to MyPatient profile</a></li>\n<li><a href=\"http://www.google.com/url?q=http%3A%2F%2Fhapi.fhir.org%2FbaseR4%2FPatient%2F1438247&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHiU041m6dvaNW5gNWPGI8EJb7WGg\">Patient not conforming to MyPatient profile</a></li>\n<li><a href=\"http://www.google.com/url?q=http%3A%2F%2Fhapi.fhir.org%2FbaseR4%2FCareTeam%2F1438248&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNGwka671TBF4rogDbPGZmZdR3_syw\">CareTeam containing conforming Patient</a> (<a href=\"http://www.google.com/url?q=http%3A%2F%2Fhapi.fhir.org%2FbaseR4%2FCareTeam%2F1438248%2F%24validate&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHkMpmJRH3TypmcSXGqOmWOXqrXLg\">$validate</a>)</li>\n<li><a href=\"http://www.google.com/url?q=http%3A%2F%2Fhapi.fhir.org%2FbaseR4%2FCareTeam%2F1438249&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHigYdAuVRj1hL-5lKvEfCitJyAvA\">CareTeam containing non conforming Patient </a>(<a href=\"http://www.google.com/url?q=http%3A%2F%2Fhapi.fhir.org%2FbaseR4%2FCareTeam%2F1438249%2F%24validate&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNEz0StxUHGvxnS4gaCAeQ__KjxOig\">$validate</a>)</li>\n</ul>\n<p>Now when calling the <strong>$validate</strong> operation on the CareTeam resources, i would expect the first one to not contain any errors and the second one to contain one error, since the referenced Patient resource does not conform to the MyPatient profile.<br>\nTo my surprise both CareTeam resources don't have any errors.</p>\n<p>Than i tried another approch and added the following constraint to the StructureDefinition of MyCareTeam:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"nt\">&lt;constraint&gt;</span>\n    <span class=\"nt\">&lt;key</span> <span class=\"na\">value=</span><span class=\"s\">&quot;req-01&quot;</span><span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;requirements</span> <span class=\"na\">value=</span><span class=\"s\">&quot;Subject is not conforming&quot;</span><span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;severity</span> <span class=\"na\">value=</span><span class=\"s\">&quot;warning&quot;</span><span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;human</span> <span class=\"na\">value=</span><span class=\"s\">&quot;Subject is not conforming&quot;</span><span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;expression</span> <span class=\"na\">value=</span><span class=\"s\">&quot;subject.reference.resolve().conformsTo(&#39;http://example.org/fhir/StructureDefinition/MyPatient&#39;)&quot;</span><span class=\"nt\">/&gt;</span>\n<span class=\"nt\">&lt;/constraint&gt;</span>\n</code></pre></div>\n\n\n<p>Now i am expecting to see a warning when validating the second CareTeam resource. But both CareTeam resources contain the warning! It seems like either the resolve() or the conformsTo() method is not working with the FHIRPath expression.</p>",
        "id": 207401323,
        "sender_full_name": "Sergej Reiser",
        "timestamp": 1597840663
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"260796\">@Sergej Reiser</span> ,</p>\n<p>I have taken the liberty off adding your MyPatient and the two examples to a Simplifier project I created. Please have a look: <a href=\"https://simplifier.net/zullipchat\">https://simplifier.net/zullipchat</a> . And please try the validation there as well. You will see that the validation goes as you expected. </p>\n<p>I've taken a look at you examples and in the conforming example it had</p>\n<ul>\n<li>\"profile\": [ \"<a href=\"http://example.org/fhir/StructureDefinition/MyPatient\">http://example.org/fhir/StructureDefinition/MyPatient</a>\" ]*</li>\n</ul>\n<p>in the meta data, but this was missing in the non-conforming example you created.</p>\n<p>All I did was add that line to the meta in the non-conforming example and it works as intended. </p>\n<p>Would this solve your issue in the HAPI setting as well?</p>\n<p>Kind regards,<br>\nMatthijs</p>",
        "id": 207522601,
        "sender_full_name": "Matthijs van der Wielen",
        "timestamp": 1597930541
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"259036\">@Matthijs van der Wielen</span> ,</p>\n<p>thanks for your reply and effort, but that's not actually my issue. I guess my phrasing was confusing.<br>\nI omitted the \"profile\" attribute for the non confoming Patient on purpose. I want one Patient-Resource which conforms to the MyPatient profile and onther one which doesn't. There's not an issue with that and it works just fine with HAPI.</p>\n<p>But now, when i create a CareTeam-Resource, which references the non conforming Patient, i expect it to be invalid if the CareTeam-Resource is equipped with</p>\n<ul>\n<li>\"profile\": [\"<a href=\"http://example.org/fhir/StructureDefinition/MyCareTeam\">http://example.org/fhir/StructureDefinition/MyCareTeam</a>\" ]</li>\n</ul>\n<p>So this resource should be invalid:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"p\">{</span>\n  <span class=\"nt\">&quot;resourceType&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;CareTeam&quot;</span><span class=\"p\">,</span>\n  <span class=\"nt\">&quot;id&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;1438249&quot;</span><span class=\"p\">,</span>\n  <span class=\"nt\">&quot;meta&quot;</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n    <span class=\"nt\">&quot;profile&quot;</span><span class=\"p\">:</span> <span class=\"p\">[</span> <span class=\"s2\">&quot;http://example.org/fhir/StructureDefinition/MyCareTeam&quot;</span> <span class=\"p\">]</span>\n  <span class=\"p\">},</span>\n  <span class=\"nt\">&quot;subject&quot;</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n    <span class=\"nt\">&quot;reference&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;Patient/1438247&quot;</span><span class=\"p\">,</span>\n    <span class=\"nt\">&quot;display&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;This patient is not conforming to the MyPatient profile&quot;</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 207526882,
        "sender_full_name": "Sergej Reiser",
        "timestamp": 1597933039
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"260796\">@Sergej Reiser</span> ,<br>\nApologies for my misunderstanding. I will take a look at your clarification.</p>",
        "id": 207608532,
        "sender_full_name": "Matthijs van der Wielen",
        "timestamp": 1597996779
    },
    {
        "content": "<p>If you don't yet have an answer <span class=\"user-mention\" data-user-id=\"260796\">@Sergej Reiser</span>, I'd suggest raising this on <a class=\"stream\" data-stream-id=\"179167\" href=\"/#narrow/stream/179167-hapi\">#hapi</a></p>",
        "id": 207792983,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1598219407
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> <br>\nI dont have an answer yet, but im also not sure if my expectations are correct. Am i misinterpreting the FHIR specification for <a href=\"https://www.hl7.org/fhir/elementdefinition-definitions.html#ElementDefinition.type.targetProfile\">targetProfile </a>somehow?</p>",
        "id": 207826376,
        "sender_full_name": "Sergej Reiser",
        "timestamp": 1598263665
    },
    {
        "content": "<p>I think your expectations are correct</p>",
        "id": 207850804,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1598279869
    },
    {
        "content": "<p><strong>Update:</strong> I asked the same Question on <a href=\"https://groups.google.com/forum/#!topic/hapi-fhir/owvoIdbKwRo\">Google Groups</a> where i  received a reply from <span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span> . </p>\n<p>To summarize: HAPI <strong>does</strong> support validation for TargetProfiles, but it's not enabled by default and it also wasn't enabled on <a href=\"http://hapi.fhir.org\">hapi.fhir.org</a>. James commited a configuration update to enable validation for TargetProfiles on <a href=\"http://hapi.fhir.org\">hapi.fhir.org</a>.</p>",
        "id": 209505569,
        "sender_full_name": "Sergej Reiser",
        "timestamp": 1599655735
    }
]