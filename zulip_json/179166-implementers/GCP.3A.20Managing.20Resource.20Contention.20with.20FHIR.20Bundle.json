[
    {
        "content": "<p>Hi, so currently I am trying to update multiple FHIR resources via executeBundle[1] and \"Managing Resource Contention\"[2] by using Etag with If-Match header. But GCP returning \"412 Precondition Failed\" with <code>\"diagnostics\": \"the version id doesn't match current value\"</code>.<br>\nBut it return \"200 OK\" when I try to update a single FHIR resource separately via executeBundle.<br>\nThe different here are:</p>\n<ul>\n<li>Case 1: request bundle have 2 or more entries, each entry is a different resource of the same type with different versionId.</li>\n<li>Case 2: request bundle have only 1 entry.</li>\n</ul>\n<p>[1] <a href=\"https://cloud.google.com/healthcare/docs/reference/rest/v1/projects.locations.datasets.fhirStores.fhir/executeBundle\">https://cloud.google.com/healthcare/docs/reference/rest/v1/projects.locations.datasets.fhirStores.fhir/executeBundle</a><br>\n[2] <a href=\"http://hl7.org/fhir/http.html#concurrency\">http://hl7.org/fhir/http.html#concurrency</a></p>\n<p>So my request body for executeBundle look like this:<br>\nPOST <a href=\"https://healthcare.googleapis.com/v1/projects/*/locations/*/datasets/*/fhirStores/*/fhir\">https://healthcare.googleapis.com/v1/projects/*/locations/*/datasets/*/fhirStores/*/fhir</a></p>\n<ul>\n<li>Case 1:</li>\n</ul>\n<div class=\"codehilite\"><pre><span></span><code>{\n  &quot;entry&quot;: [\n    {\n      &quot;resource&quot;: {\n        &quot;active&quot;: false,\n        &quot;gender&quot;: &quot;female&quot;,\n        &quot;id&quot;: &quot;example1&quot;,\n        &quot;meta&quot;: {\n          &quot;lastUpdated&quot;: &quot;2020-08-06T08:19:13.138829+00:00&quot;,\n          &quot;versionId&quot;: &quot;validVersionIdExample1&quot;\n        },\n        &quot;resourceType&quot;: &quot;Patient&quot;\n      },\n      &quot;request&quot;: {\n        &quot;method&quot;: &quot;PUT&quot;,\n        &quot;url&quot;: &quot;Patient/example1&quot;,\n        &quot;ifMatch&quot;: &quot;W/\\&quot;validVersionIdExample1\\&quot;&quot;\n      }\n    },\n    {\n      &quot;resource&quot;: {\n        &quot;active&quot;: false,\n        &quot;gender&quot;: &quot;male&quot;,\n        &quot;id&quot;: &quot;example2&quot;,\n        &quot;meta&quot;: {\n          &quot;lastUpdated&quot;: &quot;2020-08-06T08:19:30.331322+00:00&quot;,\n          &quot;versionId&quot;: &quot;validVersionIdExample2&quot;\n        },\n        &quot;resourceType&quot;: &quot;Patient&quot;\n      },\n      &quot;request&quot;: {\n        &quot;method&quot;: &quot;PUT&quot;,\n        &quot;url&quot;: &quot;Patient/example2&quot;,\n        &quot;ifMatch&quot;: &quot;W/\\&quot;validVersionIdExample2\\&quot;&quot;\n      }\n    }\n  ],\n  &quot;type&quot;: &quot;transaction&quot;,\n  &quot;resourceType&quot;: &quot;Bundle&quot;\n}\n</code></pre></div>\n\n\n<p>GCP will return: \"Status: 412 Precondition Failed\"</p>\n<div class=\"codehilite\"><pre><span></span><code>{\n  &quot;issue&quot;: [\n    {\n      &quot;code&quot;: &quot;structure&quot;,\n      &quot;details&quot;: {\n        &quot;text&quot;: &quot;invalid_headers&quot;\n      },\n      &quot;diagnostics&quot;: &quot;the version id doesn&#39;t match current value&quot;,\n      &quot;severity&quot;: &quot;error&quot;\n    }\n  ],\n  &quot;resourceType&quot;: &quot;OperationOutcome&quot;\n}\n</code></pre></div>\n\n\n<ul>\n<li>Case 2:</li>\n</ul>\n<div class=\"codehilite\"><pre><span></span><code>{\n  &quot;entry&quot;: [\n    {\n      &quot;resource&quot;: {\n        &quot;active&quot;: false,\n        &quot;gender&quot;: &quot;female&quot;,\n        &quot;id&quot;: &quot;example1&quot;,\n        &quot;meta&quot;: {\n          &quot;lastUpdated&quot;: &quot;2020-08-06T08:19:13.138829+00:00&quot;,\n          &quot;versionId&quot;: &quot;validVersionIdExample1&quot;\n        },\n        &quot;resourceType&quot;: &quot;Patient&quot;\n      },\n      &quot;request&quot;: {\n        &quot;method&quot;: &quot;PUT&quot;,\n        &quot;url&quot;: &quot;Patient/example1&quot;,\n        &quot;ifMatch&quot;: &quot;W/\\&quot;validVersionIdExample1\\&quot;&quot;\n      }\n    }\n  ],\n  &quot;type&quot;: &quot;transaction&quot;,\n  &quot;resourceType&quot;: &quot;Bundle&quot;\n}\n</code></pre></div>\n\n\n<p>GCP will return: \"Status: 200 OK\"</p>\n<div class=\"codehilite\"><pre><span></span><code>{\n  &quot;entry&quot;: [\n    {\n      &quot;response&quot;: {\n        &quot;etag&quot;: &quot;W/\\&quot;newVersionId\\&quot;&quot;,\n        &quot;lastModified&quot;: &quot;2020-08-06T08:41:01.385494+00:00&quot;,\n        &quot;location&quot;: &quot;https://healthcare.googleapis.com/v1/projects/*/locations/*/datasets/*/fhirStores/*/fhir/Patient/example1/_history/newVersionId&quot;,\n        &quot;status&quot;: &quot;200 OK&quot;\n      }\n    }\n  ],\n  &quot;resourceType&quot;: &quot;Bundle&quot;,\n  &quot;type&quot;: &quot;transaction-response&quot;\n}\n</code></pre></div>",
        "id": 206117386,
        "sender_full_name": "Nguyen Quang Huy",
        "timestamp": 1596703939
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"197072\">@Paul Church</span></p>",
        "id": 206149972,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1596724831
    },
    {
        "content": "<p>What are your expectations in each of these cases? It depends on the current state of the resources compared to the version IDs specified in If-Match.</p>",
        "id": 206169996,
        "sender_full_name": "Paul Church",
        "timestamp": 1596734097
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"197072\">Paul Church</span> <a href=\"#narrow/stream/179166-implementers/topic/GCP.3A.20Managing.20Resource.20Contention.20with.20FHIR.20Bundle/near/206169996\">said</a>:</p>\n<blockquote>\n<p>What are your expectations in each of these cases? It depends on the current state of the resources compared to the version IDs specified in If-Match.</p>\n</blockquote>\n<p>For case 1: I expect GCP to return <code>Status: 200 OK</code> response bundle with 2 entries which is updated resources from request. And of course those 2 resources should be updated.<br>\nFor case 2: It is already return what I expect it to be returned.</p>",
        "id": 206227051,
        "sender_full_name": "Nguyen Quang Huy",
        "timestamp": 1596780814
    },
    {
        "content": "<p>I believe the confusion here is that the meta.lastUpdated and meta.versionId in the resources in the bundle have no effect. These fields are assigned by the server. The ifMatch header compares against the version ID of the resource currently in the store.</p>\n<p>Also, our implementation does not check IfMatch when doing a PUT to a resource that does not exist - perhaps it is a matter of interpretation whether this should be rejected.</p>\n<p>Your examples are succeeding or failing depending on the state of the store.</p>",
        "id": 206515714,
        "sender_full_name": "Paul Church",
        "timestamp": 1597094859
    },
    {
        "content": "<p>I think you miss understanding of my example. Let's me make it more clear:</p>\n<ul>\n<li>I have 2 Patient resources which already exist in FHIR store for example are <code>Patient/example1</code> &amp; <code>Patient/example2</code>.</li>\n<li>I send to GCP an<code> executeBundle</code> to PUT those 2 already exist Patients, the <code>transaction bundle</code> in request body will have 2 entries which is corresponding to <code>Patient/example1</code> &amp; <code>Patient/example2</code>.</li>\n<li>The <code>ifMatch</code> will point to current version ID  of <code>Patient/example1</code> &amp; <code>Patient/example2</code> corresponding are <code>currentVersionOfPatientExample1</code> &amp; <code>currentVersionOfPatientExample2</code>. So it will look like this:</li>\n</ul>\n<div class=\"codehilite\"><pre><span></span><code>  &quot;entry&quot;: [\n    {\n      &quot;resource&quot;: {\n        &quot;id&quot;: &quot;example1&quot;,\n        &quot;resourceType&quot;: &quot;Patient&quot;\n      },\n      &quot;request&quot;: {\n        &quot;method&quot;: &quot;PUT&quot;,\n        &quot;url&quot;: &quot;Patient/example1&quot;,\n        &quot;ifMatch&quot;: &quot;W/\\&quot;currentVersionOfPatientExample1\\&quot;&quot;\n      }\n    },\n    {\n      &quot;resource&quot;: {\n        &quot;id&quot;: &quot;example2&quot;,\n        &quot;resourceType&quot;: &quot;Patient&quot;\n      },\n      &quot;request&quot;: {\n        &quot;method&quot;: &quot;PUT&quot;,\n        &quot;url&quot;: &quot;Patient/example2&quot;,\n        &quot;ifMatch&quot;: &quot;W/\\&quot;currentVersionOfPatientExample2\\&quot;&quot;\n      }\n    }\n  ],\n  &quot;type&quot;: &quot;transaction&quot;,\n  &quot;resourceType&quot;: &quot;Bundle&quot;\n}\n</code></pre></div>\n\n\n<p>This will sometimes succeed and sometimes fail. So I don't know what is happening here as why sometimes it succeed and sometimes it fail.</p>",
        "id": 206551293,
        "sender_full_name": "Nguyen Quang Huy",
        "timestamp": 1597134559
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"320901\">@Nguyen Quang Huy</span> I haven't reproduced this so far but we're still investigating. There are no existing known issues with IfMatch that would explain it.</p>",
        "id": 207300099,
        "sender_full_name": "Paul Church",
        "timestamp": 1597777009
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"320901\">@Nguyen Quang Huy</span> We have identified the cause of this issue and a fix is in progress. The issue is specific to transaction bundles containing more than one entry with an IfMatch condition. I don't have any workarounds to suggest but we are confident that the fix will address the issue once rolled out to production.</p>",
        "id": 207537277,
        "sender_full_name": "Paul Church",
        "timestamp": 1597938026
    }
]