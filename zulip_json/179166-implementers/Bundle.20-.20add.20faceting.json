[
    {
        "content": "<p>Bundle provides the optional <strong>total</strong> which is helpfull to paginate. </p>\n<p>In the same spirit, I d'like to add faceting numbers (such lucene faceting). Say the resource <strong>Patient</strong> has 10 milion entries,<br>\nthe bundle would have a total=10M . Also It could ship a facet on gender (Male=5M, Female=5M) and also<br>\na facet on year of birth.</p>\n<p>The search parameter could be <strong>_facet=gender,deaceasedBoolean</strong>. I wonder what FHIR type could <br>\nrepresent facets with flexibility. I also guess a bundle extension could be okay, with a kind of key/value map<br>\ndata type.</p>\n<p>Any thought ?</p>",
        "id": 176698288,
        "sender_full_name": "natus",
        "timestamp": 1569532844
    },
    {
        "content": "<p>That could be put into an operation outcome in the bundle with info messages if you really wanted to.</p>",
        "id": 176724017,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1569568865
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191367\">@Brian Postlethwaite</span> this makes sense. Do you mean putting the facets as string in the display element of the operationOucome resource in the Bundle resource ?</p>",
        "id": 176734313,
        "sender_full_name": "natus",
        "timestamp": 1569579941
    },
    {
        "content": "<p>Or info messages in it yes.</p>",
        "id": 176734508,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1569580151
    },
    {
        "content": "<p>no way to have a complex type such Map[key -&gt; intValue] instead of string ?</p>",
        "id": 176734720,
        "sender_full_name": "natus",
        "timestamp": 1569580377
    },
    {
        "content": "<p>It should be possible to create an operation that did this, but I don't think it's appropriate to build it into the query mechanism.  It would add a lot of complexity and wouldn't be relevant to paging.  You could submit a change request if you'd like us to define such an operation as part of R5.</p>",
        "id": 176745014,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1569590637
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span>  not sure to understand why it wouldn't be relevant to paging. Facet is as static as total</p>",
        "id": 176782470,
        "sender_full_name": "natus",
        "timestamp": 1569615328
    },
    {
        "content": "<p>Yes, but 'total' lets you know how many times you'll have to page forward to get everything.  The others are just statistics - and there's pretty much an unlimited set of statistics you might want.  For example, you might want males and females, but you might also want males and females by age range or males and females who meet a particular criteria vs. not.  And most often when you're looking for the statistics, you won't actually care to page through the details.  (If you were going to, there'd be no reason to retrieve the statistics in the first place.)</p>",
        "id": 176801889,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1569635815
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"213944\">@natus</span> Note that the above just reflects my personal opinion.  If you feel strongly it should be part of search, feel free to submit a change request for that instead.</p>",
        "id": 176801958,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1569635896
    },
    {
        "content": "<p>no one else has expressed interest in the idea yet?</p>",
        "id": 176821346,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1569667939
    },
    {
        "content": "<p>I didn't find any mention of facet in the zulip history. </p>\n<p><span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> I admit faceting can be broad, however it might be possible to specifify the kind of facet and level that could be shared exactly how search parameters and _elements are limited in scope</p>",
        "id": 176827316,
        "sender_full_name": "natus",
        "timestamp": 1569679229
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span>  I didn't find any mention of facet in the zulip history.</p>\n<p>@Lloyd McKenzie I admit faceting can be broad, however it might be possible to specifify the kind of facet and level that could be shared exactly how search parameters and _elements are limited in scope</p>\n<p>Any search engine provide those statistics natively and easily</p>",
        "id": 176827329,
        "sender_full_name": "natus",
        "timestamp": 1569679271
    },
    {
        "content": "<blockquote>\n<p>Any search engine provide those statistics natively and easily</p>\n</blockquote>\n<p>Uh....no. In our system (SQL Server based) producing male / female stats would involve some extra non-trivial query - because the query would have to deal with mapping of our internal values to FHIR male / female</p>",
        "id": 176828830,
        "sender_full_name": "Michele Mottini",
        "timestamp": 1569681988
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191912\">@Michele Mottini</span> sure this may not apply to every implementation</p>",
        "id": 176829165,
        "sender_full_name": "natus",
        "timestamp": 1569682616
    },
    {
        "content": "<p>The database will typically return a count of total matching records.  To do facet counts, you either need to do sub-queries or iterate through all the data (both of which have a significant impact on performance).  I'm not aware of any database technologies that would provide facet counts 'for free' the way they provide a count of total records.</p>",
        "id": 176830495,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1569685056
    },
    {
        "content": "<blockquote>\n<p>I'm not aware of any database technologies that would provide facet counts 'for free' the way they provide a count of total records.</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> same apply for total matching records: no relational database will know that information without scanning the whole. However, search engine such solr/elastic search provides this for free.</p>",
        "id": 176830685,
        "sender_full_name": "natus",
        "timestamp": 1569685327
    },
    {
        "content": "<blockquote>\n<p>I didn't find any mention of facet in the zulip history</p>\n</blockquote>\n<p>yes, to my memory no one has brought this up. There's nothing stopping you from doing this in a server, but we generally only standardise something if enogh people express interest in the idea</p>",
        "id": 176836518,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1569695835
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> - the mechanism for doing this on a local basis would be to put extensions in Bundle.meta?</p>",
        "id": 176838088,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1569698702
    },
    {
        "content": "<p>yes I think so</p>",
        "id": 176838152,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1569698801
    },
    {
        "content": "<p>so what about the valueType. Is string the best option (with a json in it)?</p>",
        "id": 176841841,
        "sender_full_name": "natus",
        "timestamp": 1569704908
    },
    {
        "content": "<p>Your mechanism should ideally work whether the system asks for results in XML, JSON or RDF.  So I would go with a complex extension that indicates the facet type and value</p>",
        "id": 176844020,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1569708896
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> you mean a bundle extension ? Apprently bundle cannot have extension (from the documentation):</p>\n<blockquote>\n<p>Although there are no extensions on the Bundle itself, link, entry, and search/request/response can all have extensions</p>\n</blockquote>",
        "id": 181024687,
        "sender_full_name": "natus",
        "timestamp": 1574090563
    },
    {
        "content": "<p>True, but you can stick them inside Bundle.meta</p>",
        "id": 181029376,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1574093698
    },
    {
        "content": "<p>what about this:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"p\">{</span>\n  <span class=\"nt\">&quot;resourceType&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;Bundle&quot;</span><span class=\"p\">,</span>\n  <span class=\"nt\">&quot;id&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;3ec28c39-cc93-42fa-924e-46dd6ee9c65d&quot;</span><span class=\"p\">,</span>\n  <span class=\"nt\">&quot;meta&quot;</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n    <span class=\"nt\">&quot;extension&quot;</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n      <span class=\"p\">{</span>\n        <span class=\"nt\">&quot;url&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;facet-encounter-length&quot;</span><span class=\"p\">,</span>\n        <span class=\"nt\">&quot;extension&quot;</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n          <span class=\"p\">{</span>\n            <span class=\"nt\">&quot;url&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;1 days&quot;</span><span class=\"p\">,</span>\n            <span class=\"nt\">&quot;valueInt&quot;</span><span class=\"p\">:</span> <span class=\"mi\">2000</span>\n          <span class=\"p\">},</span>\n          <span class=\"p\">{</span>\n            <span class=\"nt\">&quot;url&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;2 days&quot;</span><span class=\"p\">,</span>\n            <span class=\"nt\">&quot;valueInt&quot;</span><span class=\"p\">:</span> <span class=\"mi\">4000</span>\n          <span class=\"p\">}</span>\n        <span class=\"p\">]</span>\n      <span class=\"p\">}</span>\n    <span class=\"p\">],</span>\n    <span class=\"err\">...</span>\n<span class=\"p\">}</span>\n</pre></div>",
        "id": 181034540,
        "sender_full_name": "natus",
        "timestamp": 1574096764
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> the general idea is to propose one complex extention per facet, and limit the facet to several FHIR elements.<br>\nsay patient.age, encounter.type, encounter.length, documentReference.type ...</p>",
        "id": 181035744,
        "sender_full_name": "natus",
        "timestamp": 1574097513
    },
    {
        "content": "<p>the sub extention would follow a pattern in order to allow range faceting  such<br>\n<code>\"[1, 20[\":2000</code></p>",
        "id": 181035867,
        "sender_full_name": "natus",
        "timestamp": 1574097602
    },
    {
        "content": "<p>The base URL would have to be a full URL and the child URLs would have to be valid URL syntax (e.g. change the space to %20), but otherwise I think that should work.</p>",
        "id": 181035879,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1574097602
    },
    {
        "content": "<p>finally I hve something working with complex extension in the meta of bundles.<br>\nThe client is able to ask for different kind of facets:</p>\n<p>- &amp;facet=gender: returns a histogram of code as complex extension<br>\n- &amp;rangeDateFacet=birthdate : returns a histogram of date range as complex extension<br>\n- &amp;rangeNumFacet=length: returns an histogram of numeric range as complex extension<br>\n- &amp;uniqueFacet=patient,encounter : returns the number of unique patient/encounters that matches the filter as simple extension</p>\n<p>This has been implemented with HAPI FHIR and apache solr. Thanks <span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> and <span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span></p>",
        "id": 181712136,
        "sender_full_name": "natus",
        "timestamp": 1574508809
    }
]