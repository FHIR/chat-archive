[
    {
        "content": "<p>Looking at the Last N Observations Query I am confused about the definition of 'last'. In clinical context, it seems logical to think of <em>last</em> being the <em>latest</em> observation e.g. last measured blood pressure.</p>\n<p>However, reading the <a href=\"https://hl7.org/fhir/STU3/operation-observation-lastn.html\" target=\"_blank\" title=\"https://hl7.org/fhir/STU3/operation-observation-lastn.html\">STU3 specification</a> this is not mentioned anywhere where I would expect to see something like <em>'sorted from most recent to the oldest <strong>using the effective[x] element</strong>'</em>. For instance, one could also think of using the <em>meta.lastUpdated</em> element to determine the latest observation.<br>\nThe vague sentence <em>'they are passed to a server algorithm of some kind that uses them to determine the most appropriate matches'</em> also kind of worries me: how should this work?</p>\n<p>In <a href=\"https://hl7.org/fhir/operation-observation-lastn.html\" target=\"_blank\" title=\"https://hl7.org/fhir/operation-observation-lastn.html\">R4</a> this seems to be a bit more clear because the phrase 'effective times' is mentioned. But still: a bit vague.</p>\n<p>Can someone explain further and clarify this?</p>",
        "id": 189505833,
        "sender_full_name": "Niek van Galen",
        "timestamp": 1583165352
    },
    {
        "content": "<p>It is indeed expected to be the \"most recent\".  We should probably also exclude 'predicted' values (those where the effective time falls after the time of the Observation).  Feel free to submit a change request for us to further clarify in R5.</p>",
        "id": 189508075,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1583166533
    },
    {
        "content": "<p>Just to be sure: \"most recent\" as in clinically based on effective time? Or based on a _lastUpdated thing? We expect the first.</p>",
        "id": 189514844,
        "sender_full_name": "Ardon Toonstra",
        "timestamp": 1583170415
    },
    {
        "content": "<p>Should be based on effective time I think</p>",
        "id": 189519473,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1583173109
    },
    {
        "content": "<p>Done: <a href=\"http://jira.hl7.org/browse/FHIR-26428\" target=\"_blank\" title=\"http://jira.hl7.org/browse/FHIR-26428\">J#26428</a></p>",
        "id": 189525630,
        "sender_full_name": "Alexander Henket",
        "timestamp": 1583176721
    },
    {
        "content": "<p>We went forward with the $Lastn operation based on effective[x] but run into difficulties. </p>\n<p>In FHIR-26428 <span class=\"user-mention\" data-user-id=\"191401\">@Eric Haas</span>  commented, the $Lastn definition needs to clarify how it should work with ( period vs datatime vs timing). This is exactly where we run into problems with our implementation.</p>\n<p>What would be the correct behaviour of a $lasnt operation with max = 1 when there is/are:</p>\n<ol>\n<li>only 1 observation without an effective[x] --&gt; return it or not?</li>\n<li>multiple Observation have no effective[x] --&gt; return them all or none? </li>\n<li>multiple Observation, some with an effective[x] and some without. --&gt; return only the latest with an effective[x]? </li>\n<li>multiple Observations with an effectivePeriod. Some have a period.start and no period.end. Do they need to be returned over a 'closed' period?</li>\n</ol>",
        "id": 207377720,
        "sender_full_name": "Ardon Toonstra",
        "timestamp": 1597822120
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> can you shed some light on this?</p>",
        "id": 207491464,
        "sender_full_name": "Niek van Galen",
        "timestamp": 1597903449
    },
    {
        "content": "<blockquote>\n<p>What would be the correct behaviour of a $lasnt operation with max = 1 when there is/are:</p>\n</blockquote>\n<p>taking these one at time...</p>\n<p>how often is an operation dateless?  That IMO is not very useful</p>\n<blockquote>\n<p>only 1 observation without an effective[x] --&gt; return it or not?</p>\n</blockquote>\n<p>not -  since this is a time based operation. </p>\n<blockquote>\n<p>multiple Observation have no effective[x] --&gt; return them all or none?</p>\n</blockquote>\n<p>none </p>\n<blockquote>\n<p>multiple Observation, some with an effective[x] and some without. --&gt; return only the latest with an effective[x]?</p>\n</blockquote>\n<p>Yes</p>\n<blockquote>\n<p>multiple Observations with an effectivePeriod. Some have a period.start and no period.end. Do they need to be returned over a 'closed' period?</p>\n</blockquote>\n<p>Yes</p>\n<p>added a comment to document all this.</p>",
        "id": 207543513,
        "sender_full_name": "Eric Haas",
        "timestamp": 1597941114
    },
    {
        "content": "<blockquote>\n<p>multiple Observations with an effectivePeriod. Some have a period.start and no period.end. Do they need to be returned over a 'closed' period?</p>\n</blockquote>\n<p>Eric, what are you interpreting this as? resources without a period.end should not be returned as if they had no effective[x] at all? or some other reading into the 'closed' period that I'm not getting?</p>",
        "id": 207555190,
        "sender_full_name": "ryan moehrke",
        "timestamp": 1597947022
    },
    {
        "content": "<p>no period end means is current  so that would be the most recent - right?   Could always add some new parameters  to the operation to interpret it differently ... lets ping the lastn expert  <span class=\"user-mention\" data-user-id=\"191356\">@Jenni Syed</span></p>",
        "id": 207555733,
        "sender_full_name": "Eric Haas",
        "timestamp": 1597947331
    },
    {
        "content": "<p>ah, that makes a lot more sense, thanks</p>",
        "id": 207555868,
        "sender_full_name": "ryan moehrke",
        "timestamp": 1597947400
    },
    {
        "content": "<p>I think it would likely go by the \"begin\" to compare, but also can confirm if we have this scenario in our internal system or not today. I can see the argument for \"it didn't complete yet, so it's more recent\" but the \"it didn't complete yet\" part is worrisome for \"most recent\"</p>",
        "id": 207563294,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1597951273
    },
    {
        "content": "<p>No period end only really makes sense for a predictive observation - one where the observer is asserting that the value is expected to hold 'forever'.</p>",
        "id": 207794648,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1598222453
    },
    {
        "content": "<p>so if a resource has effective[DateTime or Instant] compare by that value, else if it has effectivePeriod.end compare by that value, else if it has effectivePeriod.start compare by that value. And any resources without an effective value are ignored for the purposes of $lastn, correct?</p>\n<p>Also I don't think Ardon needs it but how would effectiveTiming be handled? just the most recent of the timing.events?</p>",
        "id": 207850544,
        "sender_full_name": "ryan moehrke",
        "timestamp": 1598279743
    },
    {
        "content": "<p>for timing follow this <a href=\"http://build.fhir.org/search.html#date\">guidance</a>:</p>\n<blockquote>\n<p>Timing the specified scheduling details are ignored and only the outer limits matter. For instance, a schedule that specifies every second day between 31-Jan 2013 and 24-Mar 2013 includes 1-Feb 2013, even though that is on an odd day that is not specified by the period. This is to keep the server load processing queries reasonable.</p>\n</blockquote>",
        "id": 207868508,
        "sender_full_name": "Eric Haas",
        "timestamp": 1598288762
    },
    {
        "content": "<p>Thanks all for the input. I agree with the 4 answers that <span class=\"user-mention\" data-user-id=\"191401\">@Eric Haas</span>  gave and I believe <span class=\"user-mention\" data-user-id=\"237342\">@ryan moehrke</span>  summarizes it quite well. So first DateTime or Instant, then Period.end and lastly by Period.start. Can we get this documented/clarified in the FHIR spec?</p>\n<p>To check my understanding: theoretical speaking if you have Observations grouped by one code, with some having an effectivePeriod that is ongoing while others have a effectiveDateTime: the Observation with the latest effectivePeriod.start and no end date should be returned over a Observation with a more recent effectiveDateTime. Correct?</p>",
        "id": 208089350,
        "sender_full_name": "Ardon Toonstra",
        "timestamp": 1598447961
    },
    {
        "content": "<p>I now see that Eric has made a comment in the FHIR-26428 ticket, hopefully, that will suffice :)</p>",
        "id": 208089615,
        "sender_full_name": "Ardon Toonstra",
        "timestamp": 1598448125
    },
    {
        "content": "<p>It will be as part of the above mentioned tracker</p>",
        "id": 208117717,
        "sender_full_name": "Eric Haas",
        "timestamp": 1598460718
    }
]