[
    {
        "content": "<p>Hello! I'm working on a FHIRPath Patch implementation for our FHIR server. I've run into two related use cases where data needs to be added to a resource, but the target object or list isn't initialized. The specification page doesn't address proper behavior for this scenario, so my assumption is that the behavior is left up to the implementer. Is that correct? Also, any input on what the server should do for these scenarios?</p>\n<p>Below are a couple of sample use cases. Thanks for the help!</p>\n<p><strong>Use Case 1: Adding a value to a nested object that doesn't exist.</strong><br>\nThe Patient has an identifier defined without a period. The user wants to be able to expire the identifier. Should the server initialize the <code>period</code> object that doesn't exist on the object or return an error?</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"p\">{</span>\n    <span class=\"nt\">\"resourceType\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Patient\"</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"identifier\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n        <span class=\"p\">{</span>\n            <span class=\"nt\">\"use\"</span><span class=\"p\">:</span> <span class=\"s2\">\"official\"</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"value\"</span><span class=\"p\">:</span> <span class=\"s2\">\"123\"</span>\n        <span class=\"p\">}</span>\n    <span class=\"p\">]</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"p\">{</span>\n    <span class=\"nt\">\"resourceType\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Parameters\"</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"parameter\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n        <span class=\"p\">{</span>\n            <span class=\"nt\">\"name\"</span><span class=\"p\">:</span> <span class=\"s2\">\"operation\"</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"part\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n                <span class=\"p\">{</span>\n                    <span class=\"nt\">\"name\"</span><span class=\"p\">:</span> <span class=\"s2\">\"type\"</span><span class=\"p\">,</span>\n                    <span class=\"nt\">\"valueCode\"</span><span class=\"p\">:</span> <span class=\"s2\">\"add\"</span>\n                <span class=\"p\">},</span>\n                <span class=\"p\">{</span>\n                    <span class=\"nt\">\"name\"</span><span class=\"p\">:</span> <span class=\"s2\">\"path\"</span><span class=\"p\">,</span>\n                    <span class=\"nt\">\"valueString\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Patient.identifier.where(use = 'official').period\"</span>\n                <span class=\"p\">},</span>\n                <span class=\"p\">{</span>\n                    <span class=\"nt\">\"name\"</span><span class=\"p\">:</span> <span class=\"s2\">\"name\"</span><span class=\"p\">,</span>\n                    <span class=\"nt\">\"valueString\"</span><span class=\"p\">:</span> <span class=\"s2\">\"end\"</span>\n                <span class=\"p\">},</span>\n                <span class=\"p\">{</span>\n                    <span class=\"nt\">\"name\"</span><span class=\"p\">:</span> <span class=\"s2\">\"value\"</span><span class=\"p\">,</span>\n                    <span class=\"nt\">\"valueDate\"</span><span class=\"p\">:</span> <span class=\"s2\">\"2021-12-01\"</span>\n                <span class=\"p\">}</span>\n            <span class=\"p\">]</span>\n        <span class=\"p\">}</span>\n    <span class=\"p\">]</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p><strong>Use Case 2: Inserting a value into a list that doesn't exist.</strong><br>\nA Patient resource exists without any identifiers. The user wants to add an identifier to the patient. Should the server initialize the <code>identifier</code> list or return an error?</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"p\">{</span>\n    <span class=\"nt\">\"resourceType\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Patient\"</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"p\">{</span>\n    <span class=\"nt\">\"resourceType\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Parameters\"</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"parameter\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n        <span class=\"p\">{</span>\n            <span class=\"nt\">\"name\"</span><span class=\"p\">:</span> <span class=\"s2\">\"operation\"</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"part\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n                <span class=\"p\">{</span>\n                    <span class=\"nt\">\"name\"</span><span class=\"p\">:</span> <span class=\"s2\">\"type\"</span><span class=\"p\">,</span>\n                    <span class=\"nt\">\"valueCode\"</span><span class=\"p\">:</span> <span class=\"s2\">\"add\"</span>\n                <span class=\"p\">},</span>\n                <span class=\"p\">{</span>\n                    <span class=\"nt\">\"name\"</span><span class=\"p\">:</span> <span class=\"s2\">\"path\"</span><span class=\"p\">,</span>\n                    <span class=\"nt\">\"valueString\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Patient\"</span>\n                <span class=\"p\">},</span>\n                <span class=\"p\">{</span>\n                    <span class=\"nt\">\"name\"</span><span class=\"p\">:</span> <span class=\"s2\">\"name\"</span><span class=\"p\">,</span>\n                    <span class=\"nt\">\"valueString\"</span><span class=\"p\">:</span> <span class=\"s2\">\"identifier\"</span>\n                <span class=\"p\">},</span>\n                <span class=\"p\">{</span>\n                    <span class=\"nt\">\"name\"</span><span class=\"p\">:</span> <span class=\"s2\">\"value\"</span><span class=\"p\">,</span>\n                    <span class=\"nt\">\"valueIdentifier\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n                        <span class=\"nt\">\"system\"</span><span class=\"p\">:</span> <span class=\"s2\">\"http://example.org\"</span><span class=\"p\">,</span>\n                        <span class=\"nt\">\"value\"</span><span class=\"p\">:</span> <span class=\"s2\">\"value 3\"</span>\n                    <span class=\"p\">}</span>\n                <span class=\"p\">}</span>\n            <span class=\"p\">]</span>\n        <span class=\"p\">}</span>\n    <span class=\"p\">]</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 263793797,
        "sender_full_name": "Mikael Weaver",
        "timestamp": 1638744730
    },
    {
        "content": "<p>It may be best to ask on <a class=\"stream\" data-stream-id=\"179266\" href=\"/#narrow/stream/179266-fhirpath\">#fhirpath</a></p>",
        "id": 263803680,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1638759053
    },
    {
        "content": "<p>Hello, </p>\n<p>I couldn't find a proper way handling patches with certain elements with the implementation of hapi FHIR server as well. I think it's addressing the same issue here. Additionally the behavoir of JSON patches and patching with FHIRPath seems to be not equal. </p>\n<p>I want to add a <code>link</code>to the ressource <code>Patient</code> ressource. If there are no other <code>link</code> elements in this ressource, the server response status code is 400 with the message \"parent of node to add does not exist\".</p>\n<p>Sample</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"p\">[</span>\n\n    <span class=\"p\">{</span>\n        <span class=\"nt\">\"op\"</span><span class=\"p\">:</span> <span class=\"s2\">\"add\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"path\"</span><span class=\"p\">:</span> <span class=\"s2\">\"/link/-\"</span><span class=\"p\">,</span>\n        <span class=\"nt\">\"value\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n            <span class=\"nt\">\"other\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n                <span class=\"nt\">\"reference\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Patient/108\"</span>\n            <span class=\"p\">},</span>\n            <span class=\"nt\">\"type\"</span><span class=\"p\">:</span> <span class=\"s2\">\"seealso\"</span>\n        <span class=\"p\">}</span>\n    <span class=\"p\">}</span>\n<span class=\"p\">]</span>\n</code></pre></div>\n<p>The same for FHIRPath, but different behavior. This case returns a status code 200 but doesn't set the <code>link</code>. <br>\nSurprisingly it's working if I try to patch the element <code>identifier</code> instead.</p>\n<div class=\"codehilite\" data-code-language=\"XML\"><pre><span></span><code><span class=\"nt\">&lt;Parameters</span>\n    <span class=\"na\">xmlns=</span><span class=\"s\">\"http://hl7.org/fhir\"</span><span class=\"nt\">&gt;</span>\n    <span class=\"nt\">&lt;parameter&gt;</span>\n        <span class=\"nt\">&lt;name</span> <span class=\"na\">value=</span><span class=\"s\">\"operation\"</span><span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;part&gt;</span>\n            <span class=\"nt\">&lt;name</span> <span class=\"na\">value=</span><span class=\"s\">\"type\"</span><span class=\"nt\">/&gt;</span>\n            <span class=\"nt\">&lt;valueCode</span> <span class=\"na\">value=</span><span class=\"s\">\"insert\"</span><span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;/part&gt;</span>\n        <span class=\"nt\">&lt;part&gt;</span>\n            <span class=\"nt\">&lt;name</span> <span class=\"na\">value=</span><span class=\"s\">\"path\"</span><span class=\"nt\">/&gt;</span>\n            <span class=\"nt\">&lt;valueString</span> <span class=\"na\">value=</span><span class=\"s\">\"Patient.link\"</span><span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;/part&gt;</span>\n        <span class=\"nt\">&lt;part&gt;</span>\n            <span class=\"nt\">&lt;name</span> <span class=\"na\">value=</span><span class=\"s\">\"index\"</span><span class=\"nt\">/&gt;</span>\n            <span class=\"nt\">&lt;valueInteger</span> <span class=\"na\">value=</span><span class=\"s\">\"0\"</span><span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;/part&gt;</span>\n        <span class=\"nt\">&lt;part&gt;</span>\n            <span class=\"nt\">&lt;name</span> <span class=\"na\">value=</span><span class=\"s\">\"value\"</span><span class=\"nt\">/&gt;</span>\n            <span class=\"nt\">&lt;valueLink&gt;</span>\n                <span class=\"nt\">&lt;other&gt;</span>\n                    <span class=\"nt\">&lt;reference</span> <span class=\"na\">value=</span><span class=\"s\">\"Patient/108\"</span><span class=\"nt\">/&gt;</span>\n                <span class=\"nt\">&lt;/other&gt;</span>\n                <span class=\"nt\">&lt;type</span> <span class=\"na\">value=</span><span class=\"s\">\"replaced-by\"</span><span class=\"nt\">/&gt;</span>\n            <span class=\"nt\">&lt;/valueLink&gt;</span>\n        <span class=\"nt\">&lt;/part&gt;</span>\n    <span class=\"nt\">&lt;/parameter&gt;</span>\n<span class=\"nt\">&lt;/Parameters&gt;</span>\n</code></pre></div>",
        "id": 263856929,
        "sender_full_name": "Mark Putke",
        "timestamp": 1638800831
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span></p>",
        "id": 263867496,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1638804927
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"450607\">@Mark Putke</span> for JSONPatch, it looks like the object must exist and be initialized according to the JSONPatch spec <a href=\"https://www.rfc-editor.org/rfc/rfc6902#section-4.1\">RFC 6902 4.1</a>. The spec says <em>\"However, the object itself or an array containing it does need to exist, and it remains an error for that not to be the case\"</em>. I would expect a result of HTTP 400 there. The behavior you are seeing with the FHIRPatch implementation looks incorrect - it should either result in a successful patch or an error.</p>",
        "id": 263891145,
        "sender_full_name": "Mikael Weaver",
        "timestamp": 1638814078
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191320\">Lloyd McKenzie</span> <a href=\"#narrow/stream/179166-implementers/topic/FHIRPath.20Path.20on.20uninitialized.20object.2Flist/near/263803680\">said</a>:</p>\n<blockquote>\n<p>It may be best to ask on <a class=\"stream\" data-stream-id=\"179266\" href=\"/#narrow/stream/179266-fhirpath\">#fhirpath</a></p>\n</blockquote>\n<p>Thanks I'll ask over there in a bit.</p>",
        "id": 263900505,
        "sender_full_name": "Mikael Weaver",
        "timestamp": 1638817779
    },
    {
        "content": "<p>Conversation moved to <a class=\"stream\" data-stream-id=\"179266\" href=\"/#narrow/stream/179266-fhirpath\">#fhirpath</a> <a href=\"#narrow/stream/179266-fhirpath/topic/FHIRPath.20Patch.20on.20uninitialized.20.20object.2Flist\">here</a>.</p>",
        "id": 263924486,
        "sender_full_name": "Mikael Weaver",
        "timestamp": 1638824700
    },
    {
        "content": "<p>hi Mikael. Good questions. </p>\n<p>Case one is an error - the server should say something like \"No content found at Patient.identifier.where(use = 'official').period when adding\". This is defined in the spec when it says:</p>\n<blockquote>\n<p>The FHIRPath statement must return a single element</p>\n</blockquote>\n<p>but I agree it could be bit clearer. </p>\n<p>For case #2, it's not an error - the path expression returns a single element, and it adds identifier to it.</p>\n<p>I added your two test cases: <a href=\"https://github.com/FHIR/fhir-test-cases/blob/master/r4/patch/fhir-path-tests.xml#L1381\">https://github.com/FHIR/fhir-test-cases/blob/master/r4/patch/fhir-path-tests.xml#L1381</a></p>",
        "id": 263950774,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1638843036
    },
    {
        "content": "<p>oh. i'll go update the other thread</p>",
        "id": 263950793,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1638843062
    },
    {
        "content": "<p>Thank for the interpretation and test cases <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span>! I have a bit more work to do for test case #2 then we'll have it fully working. I have a few more test cases that may be useful to add - I'll ping you here once they are merged.</p>",
        "id": 264384874,
        "sender_full_name": "Mikael Weaver",
        "timestamp": 1639094223
    }
]