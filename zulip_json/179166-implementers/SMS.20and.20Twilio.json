[
    {
        "content": "<p>I've been looking through the other threads about SMS messages, and if I just missed the answer to my question, my apologies.<br>\nI think my work flow is going to be something like this:</p>\n<ol>\n<li>Provider orders a survey for a patient (magic happens! - resources created, questionnaire identified, etc)</li>\n<li>A Communication resource representing an SMS to the patient is created, the payload is a short message and a link to the survey</li>\n<li>When the Communication is first created, its status is 'preparation'</li>\n<li>A listener of some sort (FHIR Subscription, pub/sub) alerts a Twilio microservice that there is a new SMS communication</li>\n<li>The microservice gets the Communication payload (updates the resource's status to in-progress) and attempts to send the SMS, and updating the Communication resource as appropriate</li>\n</ol>\n<p>Does that seem like the right approach?</p>",
        "id": 242764377,
        "sender_full_name": "Grey Faulkenberry",
        "timestamp": 1623776116
    },
    {
        "content": "<p>This seems like a good workflow in general. One question is whether you might want to capture (2) as a <code>CommunicationRequest</code> with status <code>active</code> (meaning: ready to be acted upon), and in (5) create the <code>Communication</code> (with <code>.basedOn</code> referencing the request) to capture the fact that the communiaction has been sent.</p>",
        "id": 242766073,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1623776834
    },
    {
        "content": "<p>Based on my best reading of these resources, I think the \"Request\" best captures your intended semantics in (2), which is \"this request is ready to be acted upon\".</p>",
        "id": 242766441,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1623776989
    },
    {
        "content": "<p>(BTW, I really like this idea. I sketched out a design but never started working on something similar a couple of years back. If you have any inclination to build the microservice -- whether polling- or subscription-based -- as an open-source standalone component, I'd certainly cheer you on!)</p>",
        "id": 242766723,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1623777100
    },
    {
        "content": "<p>Thanks! I'll look into that. And everything I've done so far is open-source, so I'll see what I can do! (I haven't used Subscriptions much yet, so that may be the main roadblock).</p>",
        "id": 242771231,
        "sender_full_name": "Grey Faulkenberry",
        "timestamp": 1623778856
    },
    {
        "content": "<p>Realistically today I'd do it via polling, and leave Subscriptions as an optimization for later (we're in the process of revamping Subscriptions for FHIR R5, along with a back-port to R4B, but this is still work in progress).</p>",
        "id": 242780176,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1623782637
    },
    {
        "content": "<p>So I came up with another question as I was tinkering with this. Specifically, how do I represent SMS as a medium? I don't think any of the participation modes do a great job at capturing it (<a href=\"https://www.hl7.org/fhir/v3/ParticipationMode/vs.html\">https://www.hl7.org/fhir/v3/ParticipationMode/vs.html</a>). I guess it's technically typewritten, but I don't feel like that's what we're going for.</p>",
        "id": 242875522,
        "sender_full_name": "Grey Faulkenberry",
        "timestamp": 1623848070
    },
    {
        "content": "<p>Agreed! The <code>medium</code> is optional, and that valueset is only an example, so no huge surprise there but I agree we ought to include it. Will you submit a Jira tracker for this?</p>",
        "id": 242936808,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1623874567
    },
    {
        "content": "<p>As a stopgap I might just use </p>\n<div class=\"codehilite\"><pre><span></span><code>&quot;medium&quot;: [{\n  &quot;coding&quot;: [{\n    &quot;system&quot;: &quot;http://hl7.org/fhir/contact-point-system&quot;,\n    &quot;code&quot;: &quot;sms&quot;\n  }]\n}]\n</code></pre></div>\n<p>from <a href=\"http://build.fhir.org/codesystem-contact-point-system.html#contact-point-system-sms\">http://build.fhir.org/codesystem-contact-point-system.html#contact-point-system-sms</a> -- which would make the job of looking up the <em>right</em> ContactPoint in <code>Patient.telecom</code> pretty straightforward.</p>",
        "id": 242937423,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1623874881
    },
    {
        "content": "<p>^^ Edited to fix <code>Patient.telecom</code>, which I wrote accidentally as \".contact\" at first.</p>",
        "id": 242937748,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1623875024
    },
    {
        "content": "<p>So it's not ready for production, but it does work: <a href=\"https://github.com/MayJuun/fhir_twilio\">https://github.com/MayJuun/fhir_twilio</a></p>",
        "id": 242943421,
        "sender_full_name": "Grey Faulkenberry",
        "timestamp": 1623877660
    },
    {
        "content": "<p>I'm watching the files disappear as I browse GH ;-))</p>",
        "id": 242943672,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1623877775
    },
    {
        "content": "<p>You do need the Dart SDK though, although I made it specifically to run in a Docker container.</p>",
        "id": 242944026,
        "sender_full_name": "Grey Faulkenberry",
        "timestamp": 1623877946
    },
    {
        "content": "<p>Yeah, accidentally uploaded a credentials file the first time</p>",
        "id": 242944055,
        "sender_full_name": "Grey Faulkenberry",
        "timestamp": 1623877975
    },
    {
        "content": "<p>Should be fixed now</p>",
        "id": 242944061,
        "sender_full_name": "Grey Faulkenberry",
        "timestamp": 1623877980
    },
    {
        "content": "<p>Right now, as long as you put in your own credentials, you can post a ContactRequest to the PublicHapi server, and this will check it, and text you whatever the payload is, and change the status of the ContactRequest to complete.</p>",
        "id": 242944144,
        "sender_full_name": "Grey Faulkenberry",
        "timestamp": 1623878037
    },
    {
        "content": "<p>Not fancy, obviously, but its functional. And when I get time I'll make it cleaner, add functionality, etc. But just in case you wanted to take a look.</p>",
        "id": 242944303,
        "sender_full_name": "Grey Faulkenberry",
        "timestamp": 1623878121
    },
    {
        "content": "<p>Nice! My first experience reading Dart. BTW I'm mulling over the \"right\" way to \"claim a Request from a work queue\", e.g. to <a href=\"https://github.com/MayJuun/fhir_twilio/blob/a8de25f9e8785ec6bda6c3e5e5093e377a0a6825/lib/index.dart#L41\">ensure here</a> that somebody else (like, another task runner in your cluster) hasn't already grabbed this one. I've asked a question in <a class=\"stream-topic\" data-stream-id=\"179196\" href=\"/#narrow/stream/179196-workflow/topic/Claiming.20a.20request.2C.20to.20work.20on.20it\">#workflow &gt; Claiming a request, to work on it</a> to see if there's something I'm missing.</p>",
        "id": 242944990,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1623878419
    },
    {
        "content": "<p>It's the only language I know pretty well (obviously it looks similar to anything else object oriented, but this is the only one I really work in).</p>",
        "id": 242945077,
        "sender_full_name": "Grey Faulkenberry",
        "timestamp": 1623878494
    },
    {
        "content": "<p>As a stopgap or a hack, it'd be possible to</p>\n<div class=\"codehilite\"><pre><span></span><code>PUT /CommunicationRequest/:id\nIf-Match: W/&quot;prev-version&quot;\n\n{\n              // .copyWith(status: Code(&#39;on-hold&#39;));\n}\n</code></pre></div>\n<p>and only proceeding if this works.</p>",
        "id": 242945154,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1623878527
    },
    {
        "content": "<p>And yeah, that's definitely something that would need to be solved. Plus the ensuring that the request is for an SMS, etc.</p>",
        "id": 242945179,
        "sender_full_name": "Grey Faulkenberry",
        "timestamp": 1623878546
    },
    {
        "content": "<p>If you have any interest in Dart/Flutter, I can certainly suggest some useful resources (and/or go on a long monologue about why I've enjoyed using them). <span aria-label=\"joy\" class=\"emoji emoji-1f602\" role=\"img\" title=\"joy\">:joy:</span></p>",
        "id": 242945281,
        "sender_full_name": "Grey Faulkenberry",
        "timestamp": 1623878630
    },
    {
        "content": "<p>Task is the ressource geared towards \"claiming\". If you replace (or add in addition to) CommunicationRequest with Task, you  can \"claim\" the Task by becoming the owner.</p>",
        "id": 242960884,
        "sender_full_name": "Vassil Peytchev",
        "timestamp": 1623890171
    },
    {
        "content": "<p>Makes sense, but still: how does the Request status state machine address the \"is claimed\" state?</p>",
        "id": 242961242,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1623890545
    },
    {
        "content": "<p>No Task.owner - no claim. Also, businessStatus (+ statusReason)</p>",
        "id": 242961411,
        "sender_full_name": "Vassil Peytchev",
        "timestamp": 1623890760
    },
    {
        "content": "<p>But you can't know that from the Request status, and you can't know it atomically. Would you agree <span class=\"user-mention\" data-user-id=\"192685\">@Vassil Peytchev</span> that a new Request status like <code>in-progress</code> would help fill a meaningful gap in the current state machine?</p>",
        "id": 242964162,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1623894118
    },
    {
        "content": "<p>Or is there really no gap, and I just have mistaken expectation?</p>",
        "id": 242964206,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1623894151
    },
    {
        "content": "<p>Sorry for the drive-by posting, I need to expand a little on this. </p>\n<p>In the original scenario we start with a provider order. Usually a provider order is a ServiceRequest, but here it is probably more appropriate to be a ComunicationRequest.  In any case, the resource that follows the Request pattern is just a record of the order, and (on purpose) is decoupled from the fulfillment of the request. This is reflected in the Request pattern's state machine, where the order is active or complete. </p>\n<p>To get the request fulfilled, you create a Task resource, with Task.focus pointing to the order - in this case the CommunicationRequest. The state machine for Task.status is more involved and includes the capability to \"negotiate\" with the fulfiller. A very basic use of Task.status is setting it to <code>requested</code> and when the micrtoservice \"claims\" it, updates it to <code>accepted</code> or even directly to <code>in-progress</code>. </p>\n<p>The microservice would be subscribed to/polling on a Task (can be based on Task.focus being a reference to a CommunicationRequest, or Task.code being a specific code, and Task.status being <code>requested</code>) </p>\n<p>Once the SMS is sent, Task.output would reference the Communication resource, and the status would be <code>completed</code>.</p>\n<p>With this fairly straight-forward workflow, Task.status seems to be sufficient. If there were more complicated workflows, you can add more nuances via task.businessStatus and create any state machine based on the triplet of status, businessStatus, and statusReason. Getting an owner assigned is another way to claim a Task, if there is a reason to distinguish the Task being claimed from being accepted or being in progress.</p>",
        "id": 242965618,
        "sender_full_name": "Vassil Peytchev",
        "timestamp": 1623896288
    },
    {
        "content": "<p>This all makes sense, but Task feels like a big hammer, and also the Request.status *does\" have a state machine that gets updated at various points during this workflow -- it's not like the Request represented some immutable \"order as initially placed\". As such, why <em>not</em> have a status like <code>in-progress</code> on the Request.status state machine?</p>",
        "id": 242966313,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1623897254
    },
    {
        "content": "<p>You could avoid the request, and have the Task represent both the request and the fulfillment. If the main point of the workflow is how the microservice will know there is something to do, it does it, and leaves a record of the fulfillment, you can start with Task - there is no need for a CommunicationRequest, unless there is a need for the permanent record of an official authorization to also be exposed as a FHIR resource.</p>\n<p>As to why the Request pattern does no allow recording of the fulfillment - my guess is that the record of the fulfillment is in many cases on a different server than the record of the request. From the point of view of a pure FHIR client and a single server, that might be overkill, but I think the benefits of not having too many ways to do the same thing outweigh the hammer...</p>",
        "id": 242967684,
        "sender_full_name": "Vassil Peytchev",
        "timestamp": 1623898994
    },
    {
        "content": "<p>Thanks again for the feedback here. I'd definitely try to avoid having to touch two resources in this workflow. Either Task alone or CommunicationRequest alone seems okay.</p>\n<p>That said, I'll file a jira issue about the Request status state machine, because forcing a request to jump from \"ready to be acted on\" to \"all done\" seems a bit coarse grained (to be clear, I think it's fine if that jump is a common pattern in practice, but it seems very strange not to be able to express a state in between).</p>",
        "id": 243017632,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1623936816
    },
    {
        "content": "<p>Submitted <a href=\"http://jira.hl7.org/browse/FHIR-32948\">FHIR-32948</a></p>",
        "id": 243026770,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1623940503
    },
    {
        "content": "<p>In general, asking a Patient to complete a Questionnaire should be a Task, not a CommunicationRequest.  CommunicationRequest allows you to say \"please share data\".  It's not really intended to be used for \"please perform some activity, then send me the result\".  The SDC implementation guide defines a profile for what the Task should look like here: <a href=\"http://build.fhir.org/ig/HL7/sdc/StructureDefinition-sdc-task.html\">http://build.fhir.org/ig/HL7/sdc/StructureDefinition-sdc-task.html</a> (and will soon have some additional guidance that talks about how to use it).</p>",
        "id": 243733664,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1624499282
    },
    {
        "content": "<p>So my vote is for Task alone.</p>",
        "id": 243733712,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1624499309
    },
    {
        "content": "<p>Request resources can't be claimed.  A Task soliciting the fulfillment some or all of a Request can be claimed.  Without a Task, the Request itself isn't actionable.  It's like a paper prescription or lab requisition sitting in the patient's pocket.  No pills are counted and no blood is drawn until/unless the patient gives the piece of paper to a pharmacy/lab and says \"please action\".  (And even then, for the drug prescription, they only typically action one fill, not the whole order.)</p>",
        "id": 243733818,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1624499451
    },
    {
        "content": "<p>The semantics of the communication request are \"please send this sms\" ; it's not about \"a Task to complete a questionnaire\" -- or at least, I wouldn't want to limit it to that.</p>",
        "id": 243737085,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1624504171
    },
    {
        "content": "<p>I'm struggling to understand what a real life use case for Communication Request would be, otherwise.</p>",
        "id": 243737136,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1624504209
    },
    {
        "content": "<p>Reading through the resolution on <a href=\"http://jira.hl7.org/browse/FHIR-32948\">FHIR-32948</a> I'm thoroughly puzzled. Saying, \"it makes sense to describe a request as ready for action and done but nothing in between\" just seems like a gaping logical hole in the state machine. Logically, something happens in between those states.</p>",
        "id": 243737233,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1624504378
    },
    {
        "content": "<p>In any case <span class=\"user-mention\" data-user-id=\"235060\">@Grey Faulkenberry</span> you should certainly take Lloyd's advice on this since he's the expert. On this particular subject I am just a detractor yelling into the wind :-)</p>",
        "id": 243737402,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1624504630
    },
    {
        "content": "<div class=\"message_inline_image\"><a href=\"https://media0.giphy.com/media/ScmA88oVeD78aEpd2O/giphy.gif?cid=c623cb352jsqkivcwmf7pziy70om6m9g3evu00lpcijdbhq9&amp;rid=giphy.gif&amp;ct=g\"><img src=\"https://uploads.zulipusercontent.net/70209a2c73c857d994172825091f96e9cd072a52/68747470733a2f2f6d65646961302e67697068792e636f6d2f6d656469612f53636d4138386f566544373861457064324f2f67697068792e6769663f6369643d6336323363623335326a73716b697663776d6637707a697937306f6d366d39673365767530306c7063696a6462687139267269643d67697068792e6769662663743d67\"></a></div>",
        "id": 243815023,
        "sender_full_name": "Brendan Keeler",
        "timestamp": 1624553827
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span>  ^^</p>",
        "id": 243815036,
        "sender_full_name": "Brendan Keeler",
        "timestamp": 1624553841
    },
    {
        "content": "<p>A Request is just an authorization.  By itself, it doesn't drive action.  It just sits there until the author decides (based on other events in the world) that it's done, expired, or otherwise needs to end.  If you want to know what's happening with a Request, you can look at things that reference the Request, but the Request itself doesn't change.  The base rule is \"fillers can't edit the placer Request\".</p>\n<p>If you think about the real world, if a clinician authors a non-directed prescription or referral, no one comes back and edits the record in the ordering system to subsequently 'assign' that order once it gets sent to a specific pharmacy or a dispatch center assigns the referral to a particular care agency.  To see what Observations have been created against a ServiceRequest, you query the Observations.  The ServiceRequest won't point to them.  That ensures that we don't need to update 2 resources when an Event resource comes into play.  The same principle holds when updating status.  Also \"in progress\" isn't super-useful because \"in-progress for what?\"  One order could simultaneously be in progress with 3 different fillers, each satisfying a different part.  Task allows us to manage this because we can have a separate Task for each 'chunk'.  Task is a special resource in that it's actually expected to be editable by both placer and filler systems.</p>",
        "id": 243939005,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1624638430
    },
    {
        "content": "<p>It doesn't matter whether the \"filler\" or the \"requester\" is updating the status; a Request <em>can</em> be actively in progress.</p>",
        "id": 243951919,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1624645175
    },
    {
        "content": "<p>Just because you can envision scenarios where you wouldn't want to mark it as such isn't a good reason to <em>prevent anyone</em> from marking it as such.</p>",
        "id": 243952049,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1624645223
    },
    {
        "content": "<p>Fundamentally, it's not part of the Request model because it's not a status of the authorization - it's a status of the activity happening that's authorized.  We have a deep history of conflating \"authorization\" status and \"execution\" status and that causes grief.  In FHIR, we've tried to clearly delineate them to avoid that confusion/grief.  A Request can't have a status of 'accepted' or 'rejected'.  Because regardless of whether a particular filler agrees to fulfill an order, it remains an active order - and in some workflow processes, an order that was rejected by one filler might later be satisfied by another.  The notion of \"in progress\" is a similar status in that it deals with decisions and actions of the fulfiller, not with the state of the authorization.</p>",
        "id": 243970238,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1624654893
    },
    {
        "content": "<p>Does the FHIR Workflow pattern describe this (or describe this adequately enough)?</p>\n<p><a href=\"https://www.hl7.org/fhir/workflow.html\">https://www.hl7.org/fhir/workflow.html</a></p>",
        "id": 243971593,
        "sender_full_name": "John Silva",
        "timestamp": 1624655671
    },
    {
        "content": "<p>It tries.  Whether it's adequate or not, I don't know.  Change requests suggesting improvement are more than welcome</p>",
        "id": 243973058,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1624656443
    },
    {
        "content": "<p>I'm not sure if it's adequate or not; maybe those who are asking the questions about the Communication workflow can answer better.<br>\nI also noticed that this page might be helpful too (referenced by workflow page): <a href=\"https://www.hl7.org/fhir/workflow-communications.html\">https://www.hl7.org/fhir/workflow-communications.html</a></p>",
        "id": 243975001,
        "sender_full_name": "John Silva",
        "timestamp": 1624657696
    }
]