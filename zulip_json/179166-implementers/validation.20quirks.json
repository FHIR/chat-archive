[
    {
        "content": "<p>I'm seeing conflicting behavour in the validity of the example resources in my IG. As part of my IG, I have the example of a resource here: <a href=\"https://build.fhir.org/ig/hl7dk/dk-medcom/StructureDefinition-medcom-careCommunication-message-examples.html\">https://build.fhir.org/ig/hl7dk/dk-medcom/StructureDefinition-medcom-careCommunication-message-examples.html</a> - the QA site of the IG is listed here: <a href=\"https://build.fhir.org/ig/hl7dk/dk-medcom/qa.html#_scratch_ig-build-temp-CMJHI5_repo_fsh-generated_resources_Bundle-CareCommunicationMessageExample\">https://build.fhir.org/ig/hl7dk/dk-medcom/qa.html#_scratch_ig-build-temp-CMJHI5_repo_fsh-generated_resources_Bundle-CareCommunicationMessageExample</a> and it reports no errors. Now, If I try manually to validate the example resource as listed on <a href=\"https://build.fhir.org/ig/hl7dk/dk-medcom/StructureDefinition-medcom-careCommunication-message-examples.html\">https://build.fhir.org/ig/hl7dk/dk-medcom/StructureDefinition-medcom-careCommunication-message-examples.html</a> using the validator, the example bundle full of errors:</p>\n<div class=\"codehilite\"><pre><span></span><code> ava -jar validator_cli.jar communication.json -version 4.0 -ig http://build.fhir.org/ig/hl7dk/dk-medcom -profile http://medcom.dk/fhir/medcom-core/StructureDefinition/medcom-careCommunication-message\nFHIR Validation tool Version 5.2.13 (Git# 5f67b5bad03d). Built 2020-12-24T05:16:59.673Z (20 days old)\n  Java:   15 from /Library/Java/JavaVirtualMachines/adoptopenjdk-15.jdk/Contents/Home on x86_64 (64bit). 4096MB available\n  Paths:  Current = /Users/jvi/dk-medcom, Package Cache = /Users/jvi/.fhir/packages\n  Params: communication.json -version 4.0 -ig http://build.fhir.org/ig/hl7dk/dk-medcom -profile http://medcom.dk/fhir/medcom-core/StructureDefinition/medcom-careCommunication-message\nLoading\n  Load FHIR v4.0 from hl7.fhir.r4.core#4.0.1 - 4575 resources (00:04.0158)\n  Load hl7.terminology#2.0.0 - 3749 resources (00:00.0930)\n  Terminology server http://tx.fhir.org - Version 1.9.369 (00:01.0920)\n  Load http://build.fhir.org/ig/hl7dk/dk-medcom+  .. load IG from dk.fhir.ig.dk-core#current\n - 52 resources (01:19.0521)\n  Get set...  go (00:00.0032)\nValidating\n  Profiles: [http://medcom.dk/fhir/medcom-core/StructureDefinition/medcom-careCommunication-message]\n  Validate communication.json 00:00.0717\nDone. Times: Loading: 01:26.0787, validation: 00:00.0717\n\n*FAILURE*: 10 errors, 2 warnings, 15 notes\n  Error @ resource.focus[0] : Bundled or contained reference not found within the bundle/resource Communication/CareCommunicationContent\n  Error @ resource.target[0] : Bundled or contained reference not found within the bundle/resource MessageHeader/CareCommunicationMessageHeader\n  Error @ resource.managingOrganization : Bundled or contained reference not found within the bundle/resource Organization/BurnCenter\n  Error @ resource.destination[0].receiver : Bundled or contained reference not found within the bundle/resource Organization/MessageReceiver\n  Error @ resource.agent[0].who : Bundled or contained reference not found within the bundle/resource Organization/MessageSender\n  Error @ Bundle (line 2, col2) : Bundle.entry:citizen: minimum required = 1, but only found 0 (from http://medcom.dk/fhir/medcom-core/StructureDefinition/medcom-careCommunication-message)\n  Error @ Bundle (line 2, col2) : Bundle.entry:messageHeader: minimum required = 1, but only found 0 (from http://medcom.dk/fhir/medcom-core/StructureDefinition/medcom-careCommunication-message)\n  Error @ Bundle.entry[3].resource.ofType(Communication).subject (line 161, col6) : Unable to find matching profile for Patient/EricFlame among choices: http://medcom.dk/fhir/medcom-core/StructureDefinition/medcom-core-patient\n  Error @ Bundle.entry[3].resource.ofType(Communication).encounter (line 164, col6) : Unable to find matching profile for Encounter/EncounterWithLPR3Identifier among choices: http://medcom.dk/fhir/medcom-core/StructureDefinition/medcom-core-lpr3Encounter\n  Error @ Bundle.entry[4].resource.ofType(Encounter).subject (line 206, col6) : Unable to find matching profile for Patient/EricFlame among choices: http://medcom.dk/fhir/medcom-core/StructureDefinition/medcom-core-patient\n  Information @ Bundle.entry[0] (line 13, col5) : This element does not match any known slice defined in the profile http://medcom.dk/fhir/medcom-core/StructureDefinition/medcom-careCommunication-message\n  Information @ Bundle.entry[1] (line 61, col5) : This element does not match any known slice defined in the profile http://medcom.dk/fhir/medcom-core/StructureDefinition/medcom-careCommunication-message\n  Information @ Bundle.entry[2] (line 110, col5) : This element does not match any known slice defined in the profile http://medcom.dk/fhir/medcom-core/StructureDefinition/medcom-careCommunication-message\n  Information @ Bundle.entry[3] (line 134, col5) : This element does not match any known slice defined in the profile http://medcom.dk/fhir/medcom-core/StructureDefinition/medcom-careCommunication-message\n  Information @ Bundle.entry[4] (line 185, col5) : This element does not match any known slice defined in the profile http://medcom.dk/fhir/medcom-core/StructureDefinition/medcom-careCommunication-message\n  Information @ Bundle.entry[5] (line 217, col5) : This element does not match any known slice defined in the profile http://medcom.dk/fhir/medcom-core/StructureDefinition/medcom-careCommunication-message\n  Information @ Bundle.entry[6] (line 236, col5) : This element does not match any known slice defined in the profile http://medcom.dk/fhir/medcom-core/StructureDefinition/medcom-careCommunication-message\n  Information @ Bundle.entry[7] (line 263, col5) : This element does not match any known slice defined in the profile http://medcom.dk/fhir/medcom-core/StructureDefinition/medcom-careCommunication-message\n  Information @ Bundle.entry[8] (line 290, col5) : This element does not match any known slice defined in the profile http://medcom.dk/fhir/medcom-core/StructureDefinition/medcom-careCommunication-message\n  Information @ Bundle.entry[3].resource.ofType(Communication).subject (line 161, col6) : Details for Patient/EricFlame matching against Profilehttp://hl7.org/fhir/StructureDefinition/Patient\n  Information @ Bundle.entry[3].resource.ofType(Communication).subject (line 161, col6) : Details for Patient/EricFlame matching against Profilehttp://medcom.dk/fhir/medcom-core/StructureDefinition/medcom-core-patient\n  Information @ Bundle.entry[3].resource.ofType(Communication).encounter (line 164, col6) : Details for Encounter/EncounterWithLPR3Identifier matching against Profilehttp://hl7.org/fhir/StructureDefinition/Encounter\n  Information @ Bundle.entry[3].resource.ofType(Communication).encounter (line 164, col6) : Details for Encounter/EncounterWithLPR3Identifier matching against Profilehttp://medcom.dk/fhir/medcom-core/StructureDefinition/medcom-core-lpr3Encounter\n  Information @ Bundle.entry[4].resource.ofType(Encounter).subject (line 206, col6) : Details for Patient/EricFlame matching against Profilehttp://hl7.org/fhir/StructureDefinition/Patient\n  Information @ Bundle.entry[4].resource.ofType(Encounter).subject (line 206, col6) : Details for Patient/EricFlame matching against Profilehttp://medcom.dk/fhir/medcom-core/StructureDefinition/medcom-core-patient\n  Warning @ Bundle.entry[8].resource.ofType(Provenance).activity (line 312, col16) : None of the codes provided are in the value set http://hl7.org/fhir/ValueSet/provenance-activity-type (http://hl7.org/fhir/ValueSet/provenance-activity-type), and a code should come from this value set unless it has no suitable code and the validator cannot judge what is suitable) (codes = http://medcom.dk/fhir/medcom-core/CodeSystem/medcom-messaging-activityCodes#new-message)\n  Warning @ resource.activity (line 312, col16) : None of the codes provided are in the value set http://hl7.org/fhir/ValueSet/provenance-activity-type (http://hl7.org/fhir/ValueSet/provenance-activity-type), and a code should come from this value set unless it has no suitable code and the validator cannot judge what is suitable) (codes = http://medcom.dk/fhir/medcom-core/CodeSystem/medcom-messaging-activityCodes#new-message)\n</code></pre></div>\n<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> do you have any idea why the validator when executed during the IGpublisher phase does not find the errors that the validator does afterwards.</p>",
        "id": 222578651,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1610544657
    },
    {
        "content": "<p>Your fullUrls aren't.  I don't know why the IGPublisher isn't rejecting them (<span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> ?), but the validator is right to yell.  FullURLs must be full uris - either urn:uuid:someguid or <a href=\"http://something/ResourceType/id\">http://something/ResourceType/id</a> (maybe plus _history/version).  You can't specify a relative reference as a fullUrl.</p>",
        "id": 222680645,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1610600839
    },
    {
        "content": "<p>the IGPublisher hasn't rejected relative URLs ever.  I have some old guides that used relative URLs in my examples and they worked.  it is only recently that I realized that relative URLs aren't valid there (which should have been obvious from the name of the attribute if not from reading the the definition/comments).</p>",
        "id": 222684280,
        "sender_full_name": "Jean Duteau",
        "timestamp": 1610606579
    },
    {
        "content": "<p>I don't get those errors. what exact file are you validating?</p>",
        "id": 222685350,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1610607978
    },
    {
        "content": "<p>The content of <a href=\"https://build.fhir.org/ig/hl7dk/dk-medcom/Bundle-CareCommunicationMessageExample.json.html\">https://build.fhir.org/ig/hl7dk/dk-medcom/Bundle-CareCommunicationMessageExample.json.html</a></p>",
        "id": 222687103,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1610610267
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> right ... I've prefixed all the fullUrls with '<a href=\"http://example.org/fhir\">http://example.org/fhir</a>' ... that removed 4 errors ... that leaves 6 errors left, which<br>\nreally puzzles me.</p>\n<div class=\"codehilite\"><pre><span></span><code>  Error @ resource.focus[0] : Bundled or contained reference not found within the bundle/resource Communication/CareCommunicationContent\n  Error @ resource.target[0] : Bundled or contained reference not found within the bundle/resource MessageHeader/CareCommunicationMessageHeader\n  Error @ resource.destination[0].receiver : Bundled or contained reference not found within the bundle/resource Organization/MessageReceiver\n  Error @ resource.agent[0].who : Bundled or contained reference not found within the bundle/resource Organization/MessageSender\n  Error @ Bundle (line 1, col2) : Bundle.entry:messageHeader: minimum required = 1, but only found 0 (from http://medcom.dk/fhir/medcom-core/StructureDefinition/medcom-careCommunication-message)\n  Error @ Bundle (line 1, col2) : Bundle.entry:messageHeader: minimum required = 1, but only found 0 (from http://medcom.dk/fhir/medcom-core/StructureDefinition/medcom-messaging-message)\n</code></pre></div>",
        "id": 222698863,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1610619193
    },
    {
        "content": "<p>nop ... my mistake ... I validated against the wrong profile. I still have 10 errors</p>",
        "id": 222700837,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1610620499
    },
    {
        "content": "<p>can you push the file to github in a branch?</p>",
        "id": 222706858,
        "sender_full_name": "Oliver Egger",
        "timestamp": 1610624573
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191478\">@Oliver Egger</span> 2 sec</p>",
        "id": 222708176,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1610625729
    },
    {
        "content": "<p><a href=\"https://gist.github.com/jvitrifork/adef9fb0b5079fb1ed7fb421ec4221a5\">https://gist.github.com/jvitrifork/adef9fb0b5079fb1ed7fb421ec4221a5</a></p>",
        "id": 222708353,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1610625863
    },
    {
        "content": "<p>And interestingly enough <span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> , if I run the validation without the profile - there are no  errors or warrnings. Shouldn't that mean that the stated internal references are valid?</p>",
        "id": 222708943,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1610626366
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191478\">@Oliver Egger</span> let me know if you find something</p>",
        "id": 222709586,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1610626974
    },
    {
        "content": "<p>if I remove all profile references from the bundle i'm down to two errors validating against your bundle profile which are not related to the 'Bundle or container reference message':</p>\n<div class=\"codehilite\"><pre><span></span><code>java -jar validator_cli.jar &quot;/Users/oliveregger/Desktop/dk/bundle.json&quot; -version 4.0.1 -ig dk.fhir.ig.medcom-core#current -profile http://medcom.dk/fhir/medcom-core/StructureDefinition/medcom-careCommunication-message\n\n*FAILURE*: 2 errors, 1 warnings, 9 notes\n  Error @ Bundle (line 1, col2) : Bundle.entry:citizen: minimum required = 1, but only found 0 (from http://medcom.dk/fhir/medcom-core/StructureDefinition/medcom-careCommunication-message)\n  Error @ Bundle (line 1, col2) : Bundle.entry:messageHeader: minimum required = 1, but only found 0 (from http://medcom.dk/fhir/medcom-core/StructureDefinition/medcom-careCommunication-message)\n</code></pre></div>\n<p>So it looks for me, that either one of the profile definitions is wrong in the bundle and provokes the error or the profile definitions within the bundle triggers another validation where it stumbles over the bundle.entry or hopefully if above two errors are solved all are gone away :-)</p>",
        "id": 222714313,
        "sender_full_name": "Oliver Egger",
        "timestamp": 1610629922
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191478\">@Oliver Egger</span> I just tried to validate the patient example by itself ... that seems to conform to the patient profile</p>",
        "id": 222732640,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1610638112
    },
    {
        "content": "<p>so the first error is really funky</p>",
        "id": 222732802,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1610638191
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191316\">Grahame Grieve</span> <a href=\"#narrow/stream/179166-implementers/topic/validation.20quirks/near/222685350\">said</a>:</p>\n<blockquote>\n<p>I don't get those errors. what exact file are you validating?</p>\n</blockquote>\n<p><a href=\"https://gist.github.com/jvitrifork/adef9fb0b5079fb1ed7fb421ec4221a5\">https://gist.github.com/jvitrifork/adef9fb0b5079fb1ed7fb421ec4221a5</a></p>",
        "id": 222768406,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1610651991
    },
    {
        "content": "<p>Hmmm ... I think I'm on to something ... the last two errors that you see <span class=\"user-mention\" data-user-id=\"191478\">@Oliver Egger</span>  looks like they related to the fact that the reference aggregation mode is profiled. Currently it is narrowed down to only allow <code>bundled</code> for the cases <code>managingOrganization</code> for Patient - the same goes for the references on MessageHeader. If I let the aggregation mode instead be <code>referenced</code>, there are no errors. However, the references  are in fact part of the bundle and should be part of  the bundle. Why this does not pop up as of the IG building process <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span>  puzzles me.</p>",
        "id": 223031894,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1610872351
    },
    {
        "content": "<p>It's also present on other IG's - like Davinci (where the error is not present in the QA report): </p>\n<p><code> curl http://build.fhir.org/ig/HL7/davinci-alerts/Bundle-admit-notification-message-bundle-01.json -o davinci.json &amp;&amp; java -jar validator_cli.jar davinci.json -version 4.0 -ig http://build.fhir.org/ig/HL7/davinci-alerts -profile http://hl7.org/fhir/us/davinci-alerts/StructureDefinition/notifications-bundle -tx n/a</code><br>\ngives the following errors:</p>\n<div class=\"codehilite\"><pre><span></span><code> Error @ resource.participant[0].individual : Bundled or contained reference not found within the bundle/resource urn:uuid:0000016f-57cb-cdac-0000-00000000014a\n  Error @ resource.subject : Bundled or contained reference not found within the bundle/resource urn:uuid:06e1f0dd-5fbe-4480-9bb4-6b54ec02d31b\n  Error @ resource.location[0].location : Bundled or contained reference not found within the bundle/resource urn:uuid:09188b81-0d1d-453c-b0fa-203ef88c794c\n  Error @ Bundle.entry[0].resource.ofType(MessageHeader) (line 57, col25) : MessageHeader.focus:admit-notification: minimum required = 1, but only found 0 (from http://hl7.org/fhir/us/davinci-alerts/StructureDefinition/admit-notification-messageheader)\n  Error @ Bundle.entry[6].resource.ofType(Condition).encounter (line 553, col10) : Unable to find matching profile for urn:uuid:5fe62cd5-bfcf-4d3b-a1e9-80d6f75d6f82 among choices: http://hl7.org/fhir/us/davinci-alerts/StructureDefinition/adt-notification-encounter\n</code></pre></div>",
        "id": 223060542,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1610914116
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> I can see you are one of the contributers to the IG. Maybe you can shed some light on these errors?</p>",
        "id": 223060629,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1610914215
    },
    {
        "content": "<p>The davinci errors that is</p>",
        "id": 223151952,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1610994651
    },
    {
        "content": "<p>I was a contributor, but wasn't involved in the technical work of IG creation.  If the validator is complaining (incorrectly) about issues that aren't showing up in publisher QA, that suggests a bug in the validator.  <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> ?</p>",
        "id": 223171160,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1611010755
    },
    {
        "content": "<p>this is on my todo list, but realistically, not until the first week of Feb</p>",
        "id": 223177579,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1611018127
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> has it become the first week of feb yet down under? I'm sort of confused that the IG does't report the example as an error during the build proces but afterwards if I take the example and parse it to the validator_cli and points it to the freshly generated package then I see a lot of errors.</p>",
        "id": 226714553,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1613591173
    },
    {
        "content": "<p>still on my todo list</p>",
        "id": 227543022,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1614137711
    },
    {
        "content": "<p>I'm starting to suspect that you live in a currently undocumented timezone where it's almost always late january ;)</p>",
        "id": 227602108,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1614175340
    },
    {
        "content": "<p>I really liked late January, since I had a holiday for a week. I'm trying to work only 50-60 hours a week since i'm back, and everyone is noticing</p>",
        "id": 227682260,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1614204438
    },
    {
        "content": "<p>I'm still trying to figure out how March is next week, considering it was <em>just</em> March.</p>",
        "id": 227683333,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1614204774
    },
    {
        "content": "<p>So we still haven't figured out how to clone <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> yet?  Darn.</p>",
        "id": 227683820,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1614204910
    },
    {
        "content": "<p>yeah, it's so strange that it's March 2022 already</p>",
        "id": 227683853,
        "sender_full_name": "Paul Church",
        "timestamp": 1614204927
    },
    {
        "content": "<p>seems like only yesterday it was March 2020</p>",
        "id": 227683866,
        "sender_full_name": "Paul Church",
        "timestamp": 1614204939
    }
]