[
    {
        "content": "<p>So I posted a question a while back in the hapi stream, but never got an answer. I'll try again here. Perhaps <span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span> or someone else familiar with hapi will know the answer.</p>\n<p>The issue is with a search involving a list of codes  like the following:</p>\n<div class=\"codehilite\"><pre><span></span>&lt;BASE&gt;/Condition?code=http%3A%2F%2Fsnomed.info%2Fsct%7C109838007,http%3A%2F%2Fsnomed.info%2Fsct%7C1701000119104,http%3A%2F%2Fsnomed.info%2Fsct%7C187757001,http%3A%2F%2Fsnomed.info%2Fsct%7C187758006,http%3A%2F%2Fsnomed.info%2Fsct%7C447395005,http%3A%2F%2Fsnomed.info%2Fsct%7C269544008,http%3A%2F%2Fsnomed.info%2Fsct%7C285312008&amp;patient=Patient-12214\n</pre></div>\n\n\n<p>That search causes my hapi server to complain with the following stack trace:</p>\n<div class=\"codehilite\"><pre><span></span>org.springframework.transaction.TransactionSystemException: Could not commit JPA transaction; nested exception is javax.persistence.RollbackException: Error while committing the transaction\n    at org.springframework.orm.jpa.JpaTransactionManager.doCommit(JpaTransactionManager.java:526)\n    at org.springframework.transaction.support.AbstractPlatformTransactionManager.processCommit(AbstractPlatformTransactionManager.java:761)\n    at org.springframework.transaction.support.AbstractPlatformTransactionManager.commit(AbstractPlatformTransactionManager.java:730)\n    at org.springframework.transaction.support.TransactionTemplate.execute(TransactionTemplate.java:150)\n    at ca.uhn.fhir.jpa.search.SearchCoordinatorSvcImpl$SearchTask.saveSearch(SearchCoordinatorSvcImpl.java:586)\n    at ca.uhn.fhir.jpa.search.SearchCoordinatorSvcImpl$SearchTask.call(SearchCoordinatorSvcImpl.java:444)\n    at ca.uhn.fhir.jpa.search.SearchCoordinatorSvcImpl$SearchTask.call(SearchCoordinatorSvcImpl.java:402)\n    at java.util.concurrent.FutureTask.run(FutureTask.java:266)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n    at java.lang.Thread.run(Thread.java:748)\nCaused by: javax.persistence.RollbackException: Error while committing the transaction\n    at org.hibernate.internal.ExceptionConverterImpl.convertCommitException(ExceptionConverterImpl.java:75)\n    at org.hibernate.engine.transaction.internal.TransactionImpl.commit(TransactionImpl.java:71)\n    at org.springframework.orm.jpa.JpaTransactionManager.doCommit(JpaTransactionManager.java:517)\n    ... 10 common frames omitted\nCaused by: java.lang.NullPointerException: null\n    at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeBatchElement(Unknown Source)\n    at org.apache.derby.impl.jdbc.EmbedStatement.executeLargeBatch(Unknown Source)\n    at org.apache.derby.impl.jdbc.EmbedStatement.executeBatch(Unknown Source)\n    at org.apache.commons.dbcp2.DelegatingStatement.executeBatch(DelegatingStatement.java:345)\n    at org.apache.commons.dbcp2.DelegatingStatement.executeBatch(DelegatingStatement.java:345)\n    at org.hibernate.engine.jdbc.batch.internal.BatchingBatch.performExecution(BatchingBatch.java:111)\n    at org.hibernate.engine.jdbc.batch.internal.BatchingBatch.doExecuteBatch(BatchingBatch.java:97)\n    at org.hibernate.engine.jdbc.batch.internal.AbstractBatchImpl.execute(AbstractBatchImpl.java:147)\n    at org.hibernate.engine.jdbc.internal.JdbcCoordinatorImpl.executeBatch(JdbcCoordinatorImpl.java:206)\n    at org.hibernate.engine.spi.ActionQueue.executeActions(ActionQueue.java:618)\n    at org.hibernate.engine.spi.ActionQueue.executeActions(ActionQueue.java:463)\n    at org.hibernate.event.internal.AbstractFlushingEventListener.performExecutions(AbstractFlushingEventListener.java:337)\n    at org.hibernate.event.internal.DefaultFlushEventListener.onFlush(DefaultFlushEventListener.java:39)\n    at org.hibernate.internal.SessionImpl.doFlush(SessionImpl.java:1435)\n    at org.hibernate.internal.SessionImpl.managedFlush(SessionImpl.java:491)\n    at org.hibernate.internal.SessionImpl.flushBeforeTransactionCompletion(SessionImpl.java:3201)\n    at org.hibernate.internal.SessionImpl.beforeTransactionCompletion(SessionImpl.java:2411)\n    at org.hibernate.engine.jdbc.internal.JdbcCoordinatorImpl.beforeTransactionCompletion(JdbcCoordinatorImpl.java:467)\n    at org.hibernate.resource.transaction.backend.jdbc.internal.JdbcResourceLocalTransactionCoordinatorImpl.beforeCompletionCallback(JdbcResourceLocalTransactionCoordinatorImpl.java:146)\n    at org.hibernate.resource.transaction.backend.jdbc.internal.JdbcResourceLocalTransactionCoordinatorImpl.access$100(JdbcResourceLocalTransactionCoordinatorImpl.java:38)\n    at org.hibernate.resource.transaction.backend.jdbc.internal.JdbcResourceLocalTransactionCoordinatorImpl$TransactionDriverControlImpl.commit(JdbcResourceLocalTransactionCoordinatorImpl.java:220)\n    at org.hibernate.engine.transaction.internal.TransactionImpl.commit(TransactionImpl.java:68)\n    ... 11 common frames omitted\n</pre></div>\n\n\n<p>However, if the code list has 5 codes or less, then it works fine. </p>\n<p>My question is why does the search fail with more than 5 codes and how can I prevent that? </p>\n<p>Thanks</p>",
        "id": 153904887,
        "sender_full_name": "Christopher Schuler",
        "timestamp": 1504818669
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"191897\">@Christopher Schuler</span> , Bryn just pointed me to this :)</p>\n<p>What version of HAPI are you using? I'm not able to reproduce this so I'm wondering if this is version specific or related to the data in your DB, or something else entirely?</p>\n<p>The following works, for example:<br>\n<a href=\"http://fhirtest.uhn.ca/baseDstu3/Observation?code=http%3A%2F%2Fsnomed.info%2Fsct|109838007,http%3A%2F%2Fsnomed.info%2Fsct|1701000119104,http%3A%2F%2Fsnomed.info%2Fsct|187757001,http%3A%2F%2Fsnomed.info%2Fsct|187758006,http%3A%2F%2Fsnomed.info%2Fsct|447395005,http%3A%2F%2Fsnomed.info%2Fsct|269544008,http%3A%2F%2Fsnomed.info%2Fsct|285312008\" target=\"_blank\" title=\"http://fhirtest.uhn.ca/baseDstu3/Observation?code=http%3A%2F%2Fsnomed.info%2Fsct|109838007,http%3A%2F%2Fsnomed.info%2Fsct|1701000119104,http%3A%2F%2Fsnomed.info%2Fsct|187757001,http%3A%2F%2Fsnomed.info%2Fsct|187758006,http%3A%2F%2Fsnomed.info%2Fsct|447395005,http%3A%2F%2Fsnomed.info%2Fsct|269544008,http%3A%2F%2Fsnomed.info%2Fsct|285312008\">http://fhirtest.uhn.ca/baseDstu3/Observation?code=http%3A%2F%2Fsnomed.info%2Fsct|109838007,http%3A%2F%2Fsnomed.info%2Fsct|1701000119104,http%3A%2F%2Fsnomed.info%2Fsct|187757001,http%3A%2F%2Fsnomed.info%2Fsct|187758006,http%3A%2F%2Fsnomed.info%2Fsct|447395005,http%3A%2F%2Fsnomed.info%2Fsct|269544008,http%3A%2F%2Fsnomed.info%2Fsct|285312008</a></p>",
        "id": 153904889,
        "sender_full_name": "James Agnew",
        "timestamp": 1504819753
    },
    {
        "content": "<p>I am using HAPI 3.0.0-SNAPSHOT, but I also had the issue with 2.6 I believe.</p>",
        "id": 153904890,
        "sender_full_name": "Christopher Schuler",
        "timestamp": 1504819837
    },
    {
        "content": "<p>just realized my example was for the wrong resource type.. this works too though: <a href=\"http://fhirtest.uhn.ca/baseDstu3/Condition?code=http%3A%2F%2Fsnomed.info%2Fsct|109838007,http%3A%2F%2Fsnomed.info%2Fsct|1701000119104,http%3A%2F%2Fsnomed.info%2Fsct|187757001,http%3A%2F%2Fsnomed.info%2Fsct|187758006,http%3A%2F%2Fsnomed.info%2Fsct|447395005,http%3A%2F%2Fsnomed.info%2Fsct|269544008,http%3A%2F%2Fsnomed.info%2Fsct|285312008&amp;patient=Patient/12375\" target=\"_blank\" title=\"http://fhirtest.uhn.ca/baseDstu3/Condition?code=http%3A%2F%2Fsnomed.info%2Fsct|109838007,http%3A%2F%2Fsnomed.info%2Fsct|1701000119104,http%3A%2F%2Fsnomed.info%2Fsct|187757001,http%3A%2F%2Fsnomed.info%2Fsct|187758006,http%3A%2F%2Fsnomed.info%2Fsct|447395005,http%3A%2F%2Fsnomed.info%2Fsct|269544008,http%3A%2F%2Fsnomed.info%2Fsct|285312008&amp;patient=Patient/12375\">http://fhirtest.uhn.ca/baseDstu3/Condition?code=http%3A%2F%2Fsnomed.info%2Fsct|109838007,http%3A%2F%2Fsnomed.info%2Fsct|1701000119104,http%3A%2F%2Fsnomed.info%2Fsct|187757001,http%3A%2F%2Fsnomed.info%2Fsct|187758006,http%3A%2F%2Fsnomed.info%2Fsct|447395005,http%3A%2F%2Fsnomed.info%2Fsct|269544008,http%3A%2F%2Fsnomed.info%2Fsct|285312008&amp;patient=Patient/12375</a></p>\n<p>Any idea what the data looks like on your server that is matching? Or are there any more parts to that stack trace, or other stack traces nearby in the log?</p>",
        "id": 153904896,
        "sender_full_name": "James Agnew",
        "timestamp": 1504820356
    },
    {
        "content": "<p>The data should be in this test bundle:</p>",
        "id": 153904897,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1504820756
    },
    {
        "content": "<p><a href=\"http://build.fhir.org/ig/cqframework/payerextract/test-data.html\" target=\"_blank\" title=\"http://build.fhir.org/ig/cqframework/payerextract/test-data.html\">http://build.fhir.org/ig/cqframework/payerextract/test-data.html</a></p>",
        "id": 153904898,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1504820756
    },
    {
        "content": "<p>Additional stack trace info:</p>\n<div class=\"codehilite\"><pre><span></span>ca.uhn.fhir.rest.server.exceptions.InternalErrorException: null\n    at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\n    at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)\n    at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)\n    at java.lang.reflect.Constructor.newInstance(Constructor.java:423)\n    at ca.uhn.fhir.rest.server.exceptions.BaseServerResponseException.newInstance(BaseServerResponseException.java:301)\n    at ca.uhn.fhir.jpa.search.SearchCoordinatorSvcImpl.verifySearchHasntFailedOrThrowInternalErrorException(SearchCoordinatorSvcImpl.java:398)\n    at ca.uhn.fhir.jpa.search.PersistedJpaSearchFirstPageBundleProvider.size(PersistedJpaSearchFirstPageBundleProvider.java:71)\n    at ca.uhn.fhir.rest.server.method.BaseResourceReturningMethodBinding.doInvokeServer(BaseResourceReturningMethodBinding.java:248)\n    at ca.uhn.fhir.rest.server.method.BaseResourceReturningMethodBinding.invokeServer(BaseResourceReturningMethodBinding.java:136)\n    at ca.uhn.fhir.rest.server.RestfulServer.handleRequest(RestfulServer.java:858)\n    at ca.uhn.fhir.rest.server.RestfulServer.doGet(RestfulServer.java:1453)\n    at ca.uhn.fhir.rest.server.RestfulServer.service(RestfulServer.java:1429)\n    at javax.servlet.http.HttpServlet.service(HttpServlet.java:790)\n    at org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:837)\n    at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1689)\n    at org.eclipse.jetty.websocket.server.WebSocketUpgradeFilter.doFilter(WebSocketUpgradeFilter.java:225)\n    at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1676)\n    at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:581)\n    at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:143)\n    at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:548)\n    at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:226)\n    at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1180)\n    at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:511)\n    at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)\n    at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1112)\n    at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\n    at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:213)\n    at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:119)\n    at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:134)\n    at org.eclipse.jetty.server.Server.handle(Server.java:524)\n    at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:319)\n    at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:253)\n    at org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:273)\n    at org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:95)\n    at org.eclipse.jetty.io.SelectChannelEndPoint$2.run(SelectChannelEndPoint.java:93)\n    at org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.executeProduceConsume(ExecuteProduceConsume.java:303)\n    at org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.produceConsume(ExecuteProduceConsume.java:148)\n    at org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.run(ExecuteProduceConsume.java:136)\n    at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:671)\n    at org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:589)\n    at java.lang.Thread.run(Thread.java:748)\n</pre></div>",
        "id": 153904899,
        "sender_full_name": "Christopher Schuler",
        "timestamp": 1504822325
    }
]