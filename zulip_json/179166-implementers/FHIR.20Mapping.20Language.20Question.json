[
    {
        "content": "<p>Hi all, I received a question on FHIR Mapping Language + Validation and was hoping for confirmation.  Starting from the (unfortunately named =) <a href=\"https://hl7.org/fhir/r3maps.html\">Transforms between DSTU 3 and STU 4</a>, I am looking at (for example) <a href=\"https://hl7.org/fhir/observation-version-maps.html\">Observation</a>.</p>\n<p>When mapping into extensions (e.g., <code>v3.related where type=interfered-by</code>), the extension extension URL is: <code>http://hl7.org/fhir/3.0/StructureDefinition/Observation.interferedBy</code>, which is different from the cross-version extension URL: <code>http://hl7.org/fhir/3.0/StructureDefinition/extension-Observation.related</code>.</p>\n<p>The extensions used in the mapping language are not actually defined, which unfortunately means they fail validation.  Is the intention just that they are used in the context of transformations and should ignore the validation warnings, or are the mapping files out of date and the 'correct' way is to use the cross-version extensions?  Thanks!</p>",
        "id": 273717117,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1646171880
    },
    {
        "content": "<p>I think the mappings are out of date.</p>",
        "id": 273725573,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1646175997
    },
    {
        "content": "<p>I've found another example of where the DSTU2 to STU3 FHIR mappings are out of sync with 'reality'; I forget the specific example but when I posted about it I was told that it's not likely that the mapping would be updated.</p>",
        "id": 273729891,
        "sender_full_name": "John Silva",
        "timestamp": 1646178478
    },
    {
        "content": "<p>In principle, they could be fixed in R4B, but we'd need a FHIR mapping language volunteer to do it  who isn't Grahame - and we'd need the work done in the next week or so.</p>",
        "id": 273752497,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1646194155
    },
    {
        "content": "<p>Thanks for the info!  I doubt that timeframe is realistic to spin up on the work that needs to be done though.  I will check to see if anything can be done post-R4B release though.</p>",
        "id": 273753236,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1646194801
    },
    {
        "content": "<p>AFAIK the only mappings that are well maintained are the ones for the conformance resources. For any other resource types there's no guarantee that they exist, nor that they're up to date. Obviously it would be nice if they were to exist, but then we'd need a (new) volunteer to maintain them.</p>",
        "id": 273765777,
        "sender_full_name": "Ren√© Spronk",
        "timestamp": 1646205995
    },
    {
        "content": "<p>Mappings also exist in 2 repos:</p>\n<ul>\n<li><a href=\"https://github.com/HL7/fhir/blob/master/implementations/r3maps/R3toR4/\">https://github.com/HL7/fhir/blob/master/implementations/r3maps/R3toR4/</a></li>\n<li><a href=\"https://github.com/FHIR/interversion/tree/master/r4/R3toR4\">https://github.com/FHIR/interversion/tree/master/r4/R3toR4</a></li>\n</ul>\n<p>Is one of these \"official,\" and how do we intend to keep these in sync?</p>",
        "id": 273821202,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1646233980
    },
    {
        "content": "<p>Hmm.. I wonder if this is something that could be moved into core editing somehow.  E.g., if you modify a resource, you also modify some map information to keep it up to date.  Probably not worth cycles thinking about right now though.</p>",
        "id": 273826485,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1646235959
    },
    {
        "content": "<p>I found one of the tickets, <a href=\"https://jira.hl7.org/browse/FHIR-35797\">FHIR-35797</a>, I submitted for ClinicalImpression.finding.cause mapping is missing in DSTU2 to STU3 version map.  The fix, assuming it's one line of missing FML, should be easy.</p>\n<p>I think this line is just a typo:<br>\n<code>  \"ClinicalImpression.finding-reason\" : for src.reason make tgt.basis</code><br>\nshould be:<br>\n<code>  \"ClinicalImpression.finding-cause\" : for src.reason make tgt.basis</code></p>\n<p>There is no ClinicalImpression.finding[].reason property in STU3.</p>",
        "id": 273864018,
        "sender_full_name": "John Silva",
        "timestamp": 1646249532
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"222054\">@Gino Canessa</span> the set of people who know how to use the mapping language is significantly smaller than the set of people who know how to maintain resources.  (And that set isn't huge.)</p>",
        "id": 273917071,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1646278209
    },
    {
        "content": "<p>Yep, idle theorizing.  Mostly pinning in the back of my head to think about.</p>",
        "id": 273921730,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1646282383
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"222054\">@Gino Canessa</span> <span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> </p>\n<p>In testing 3to4 transforms using the validator_cli, I wrote a script to do a level of validation on the transforms.  What it does is described here</p>\n<p><a href=\"https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/tree/main/scripts\">https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/tree/main/scripts</a></p>\n<p>The script is</p>\n<p><a href=\"https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/blob/main/scripts/generate_comparison.py\">https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/blob/main/scripts/generate_comparison.py</a></p>\n<p>basically, it uses the source and target StructureDefinitions to work out if the transform is correct based on what is contained in the input and what ends up in the transform.  I had in the back of my head when I was writing it, the notion that it might a good test harness for updating the maps.  They're actually quite complete from what it 's show so far though.</p>\n<p>It will identify</p>\n<ul>\n<li>Definitely lost data</li>\n<li>Data that is invalid (i.e. shouldn't be in the input)</li>\n<li>Data that might be lost or renamed either in the source or target (because a mapping isn't referenced).</li>\n</ul>\n<p>in a generated report</p>\n<p><a href=\"https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/tree/main/examples\">https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/tree/main/examples</a></p>\n<p>It currently has the limitation of not looking at data, it just looks at the keys and only so far as is defined in the StructureDefinition snapshot elements, and its only for STU3 to R4.  More details on limitations here</p>\n<p><a href=\"https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/tree/main/scripts#limitations--scope-for-extension\">https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/tree/main/scripts#limitations--scope-for-extension</a></p>\n<p>It might be useful for what you're talking about as it should indicate potential issues with transforms assuming you have a good set of input data to test.  I still need to write some unit tests for code, but I'm pretty sure where a transform has no issues, then it can be considered correct (well in terms of keys, to the level as defined...).  I think it should be straightforward as well to extend it to look at the data, and even reference maps, but I haven't got round to that yet...</p>\n<p>One other thing, is I needed to make a modification to the xver package as there is an issue with the code finding the STU3 definitions if the target is not a versioned URL in the StructureMaps.</p>\n<p>There is a github pipeline that shows how it is ran on a linux machine</p>\n<p><a href=\"https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/blob/main/.github/workflows/validate-transforms.yml\">https://github.com/declankieran-nhsd/hapi-fhir-3to4-demo/blob/main/.github/workflows/validate-transforms.yml</a></p>\n<p>As for using this to get all maps fully correct by next week, even just for 3 to 4, I think that might be ambitious!</p>",
        "id": 273951033,
        "sender_full_name": "Declan Kieran",
        "timestamp": 1646302542
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"222054\">Gino Canessa</span> <a href=\"#narrow/stream/179166-implementers/topic/FHIR.20Mapping.20Language.20Question/near/273717117\">said</a>:</p>\n<blockquote>\n<p>Hi all, I received a question on FHIR Mapping Language + Validation and was hoping for confirmation.  Starting from the (unfortunately named =) <a href=\"https://hl7.org/fhir/r3maps.html\">Transforms between DSTU 3 and STU 4</a>, I am looking at (for example) <a href=\"https://hl7.org/fhir/observation-version-maps.html\">Observation</a>.</p>\n<p>When mapping into extensions (e.g., <code>v3.related where type=interfered-by</code>), the extension extension URL is: <code>http://hl7.org/fhir/3.0/StructureDefinition/Observation.interferedBy</code>, which is different from the cross-version extension URL: <code>http://hl7.org/fhir/3.0/StructureDefinition/extension-Observation.related</code>.</p>\n<p>The extensions used in the mapping language are not actually defined, which unfortunately means they fail validation.  Is the intention just that they are used in the context of transformations and should ignore the validation warnings, or are the mapping files out of date and the 'correct' way is to use the cross-version extensions?  Thanks!</p>\n</blockquote>\n<p>I think it was just a mistake that they're not aligned. The <a href=\"https://github.com/HL7/fhir/commit/641002468f296d9085044e7704733e224a609f82\">format</a> for the extensions and the <a href=\"https://github.com/HL7/fhir/commit/70321f285d08c25eccaca8468bcbf19a5f6a6a16\">first use</a> of extensions was both in 2018 a few months apart.</p>\n<p>It looks like a relatively simple change - if that's all there is to it, does not seem like a problem to fix. I'll look into it this weekend. No promises it'll fix all your validation issues, I haven't looked at the mappings in a while so we might discover other gremlins.</p>\n<p>Which branch is tracking the R4B release on github? Is it <code>master</code>?</p>",
        "id": 274104803,
        "sender_full_name": "Vadim Peretokin",
        "timestamp": 1646387477
    },
    {
        "content": "<p>R4B</p>",
        "id": 274138884,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1646405392
    },
    {
        "content": "<p>Thanks Vadim!</p>",
        "id": 274146693,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1646408417
    },
    {
        "content": "<p><a href=\"https://github.com/HL7/fhir/pull/1758\">https://github.com/HL7/fhir/pull/1758</a>, have a look to see if that solves the problem!</p>",
        "id": 274503277,
        "sender_full_name": "Vadim Peretokin",
        "timestamp": 1646722542
    },
    {
        "content": "<p>Awesome! I added a quick correction <a href=\"https://github.com/HL7/fhir/pull/1758/files#r821982009\">here</a>. Once merged is there a process for propagating these changes to keep these two in sync:</p>\n<ul>\n<li><a href=\"https://github.com/HL7/fhir/blob/master/implementations/r3maps/R3toR4/\">https://github.com/HL7/fhir/blob/master/implementations/r3maps/R3toR4/</a></li>\n<li><a href=\"https://github.com/FHIR/interversion/tree/master/r4/R3toR4\">https://github.com/FHIR/interversion/tree/master/r4/R3toR4</a></li>\n</ul>",
        "id": 274589759,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1646766320
    }
]