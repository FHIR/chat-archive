[
    {
        "content": "<p>Does anyone have any performance tips on getting HAPI 3.6+ to work with Postgres in Azure?<br>\nI'm doing some initial testing and I'm getting really bad performance for queries like:<br>\n<a href=\"https://hapi-x5lnjt7yu5yqe.azurewebsites.net/baseDstu3/Patient?gender=female&amp;birthdate=gt1950-07-01&amp;birthdate=lt1960-07-01&amp;_has:Condition:subject:code=http://snomed.info/sct%7C55822004\" target=\"_blank\" title=\"https://hapi-x5lnjt7yu5yqe.azurewebsites.net/baseDstu3/Patient?gender=female&amp;birthdate=gt1950-07-01&amp;birthdate=lt1960-07-01&amp;_has:Condition:subject:code=http://snomed.info/sct%7C55822004\">https://hapi-x5lnjt7yu5yqe.azurewebsites.net/baseDstu3/Patient?gender=female&amp;birthdate=gt1950-07-01&amp;birthdate=lt1960-07-01&amp;_has:Condition:subject:code=http://snomed.info/sct%7C55822004</a></p>\n<p>..what seems to break it is the _has param</p>\n<p>Here is the stack trace</p>\n<p>2019-02-11 10:25:56.785 [qtp182639397-27] INFO  c.u.f.j.s.SearchCoordinatorSvcImpl [SearchCoordinatorSvcImpl.java:543] Proceeding, as we have 250 results<br>\n2019-02-11 10:25:57.385 [search_coord_1] INFO  o.h.e.j.b.internal.AbstractBatchImpl [AbstractBatchImpl.java:193] HHH000010: On release of batch it still contained JDBC statements<br>\n2019-02-11 10:25:57.386 [search_coord_1] ERROR o.h.e.j.batch.internal.BatchingBatch [BatchingBatch.java:127] HHH000315: Exception executing batch [java.sql.BatchUpdateException: Batch entry 0 insert into HFJ_SEARCH_RESULT (SEARCH_ORDER, RESOURCE_PID, SEARCH_PID, PID) values (0, 1228, 1152, 50252) was aborted: ERROR: insert or update on table \"hfj_search_result\" violates foreign key constraint \"fk_searchres_search\"<br>\n  Detail: Key (search_pid)=(1152) is not present in table \"hfj_search\".  Call getNextException to see other errors in the batch.], SQL: insert into HFJ_SEARCH_RESULT (SEARCH_ORDER, RESOURCE_PID, SEARCH_PID, PID) values (?, ?, ?, ?)<br>\n2019-02-11 10:25:57.386 [search_coord_1] WARN  o.h.e.jdbc.spi.SqlExceptionHelper [SqlExceptionHelper.java:137] SQL Error: 0, SQLState: 23503<br>\n2019-02-11 10:25:57.386 [search_coord_1] ERROR o.h.e.jdbc.spi.SqlExceptionHelper [SqlExceptionHelper.java:142] Batch entry 0 insert into HFJ_SEARCH_RESULT (SEARCH_ORDER, RESOURCE_PID, SEARCH_PID, PID) values (0, 1228, 1152, 50252) was aborted: ERROR: insert or update on table \"hfj_search_result\" violates foreign key constraint \"fk_searchres_search\"<br>\n  Detail: Key (search_pid)=(1152) is not present in table \"hfj_search\".  Call getNextException to see other errors in the batch.<br>\n2019-02-11 10:25:57.387 [search_coord_1] ERROR o.h.e.jdbc.spi.SqlExceptionHelper [SqlExceptionHelper.java:142] ERROR: insert or update on table \"hfj_search_result\" violates foreign key constraint \"fk_searchres_search\"<br>\n  Detail: Key (search_pid)=(1152) is not present in table \"hfj_search\".<br>\n2019-02-11 10:25:57.391 [search_coord_1] ERROR o.h.i.ExceptionMapperStandardImpl [ExceptionMapperStandardImpl.java:39] HHH000346: Error during managed flush [org.hibernate.exception.ConstraintViolationException: could not execute batch]<br>\n2019-02-11 10:25:57.442 [search_coord_1] ERROR c.u.f.j.s.SearchCoordinatorSvcImpl [SearchCoordinatorSvcImpl.java:702] Failed during search loading after 192175ms<br>\norg.springframework.dao.DataIntegrityViolationException: could not execute batch; SQL [insert into HFJ_SEARCH_RESULT (SEARCH_ORDER, RESOURCE_PID, SEARCH_PID, PID) values (?, ?, ?, ?)]; constraint [fk_searchres_search]; nested exception is org.hibernate.exception.ConstraintViolationException: could not execute batch<br>\n    at org.springframework.orm.jpa.vendor.HibernateJpaDialect.convertHibernateAccessException(HibernateJpaDialect.java:259)<br>\n    at ca.uhn.fhir.jpa.config.HapiFhirHibernateJpaDialect.convertHibernateAccessException(HapiFhirHibernateJpaDialect.java:59)<br>\n    at org.springframework.orm.jpa.vendor.HibernateJpaDialect.translateExceptionIfPossible(HibernateJpaDialect.java:225)<br>\n    at org.springframework.orm.jpa.JpaTransactionManager.doCommit(JpaTransactionManager.java:540)<br>\n    at org.springframework.transaction.support.AbstractPlatformTransactionManager.processCommit(AbstractPlatformTransactionManager.java:746)<br>\n    at org.springframework.transaction.support.AbstractPlatformTransactionManager.commit(AbstractPlatformTransactionManager.java:714)<br>\n    at org.springframework.transaction.support.TransactionTemplate.execute(TransactionTemplate.java:152)<br>\n    at ca.uhn.fhir.jpa.search.SearchCoordinatorSvcImpl$BaseTask.call(SearchCoordinatorSvcImpl.java:676)<br>\n    at ca.uhn.fhir.jpa.search.SearchCoordinatorSvcImpl$BaseTask.call(SearchCoordinatorSvcImpl.java:449)<br>\n    at java.util.concurrent.FutureTask.run(FutureTask.java:266)<br>\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)<br>\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)<br>\n    at java.lang.Thread.run(Thread.java:748)<br>\nCaused by: org.hibernate.exception.ConstraintViolationException: could not execute batch<br>\n    at org.hibernate.exception.internal.SQLStateConversionDelegate.convert(SQLStateConversionDelegate.java:112)<br>\n    at org.hibernate.exception.internal.StandardSQLExceptionConverter.convert(StandardSQLExceptionConverter.java:42)<br>\n    at org.hibernate.engine.jdbc.spi.SqlExceptionHelper.convert(SqlExceptionHelper.java:113)<br>\n    at org.hibernate.engine.jdbc.batch.internal.BatchingBatch.performExecution(BatchingBatch.java:128)<br>\n    at org.hibernate.engine.jdbc.batch.internal.BatchingBatch.addToBatch(BatchingBatch.java:88)<br>\n    at org.hibernate.persister.entity.AbstractEntityPersister.insert(AbstractEntityPersister.java:3165)<br>\n    at org.hibernate.persister.entity.AbstractEntityPersister.insert(AbstractEntityPersister.java:3686)<br>\n    at org.hibernate.action.internal.EntityInsertAction.execute(EntityInsertAction.java:90)<br>\n    at org.hibernate.engine.spi.ActionQueue.executeActions(ActionQueue.java:604)<br>\n    at org.hibernate.engine.spi.ActionQueue.executeActions(ActionQueue.java:478)<br>\n    at org.hibernate.event.internal.AbstractFlushingEventListener.performExecutions(AbstractFlushingEventListener.java:356)<br>\n    at org.hibernate.event.internal.DefaultFlushEventListener.onFlush(DefaultFlushEventListener.java:39)<br>\n    at org.hibernate.internal.SessionImpl.doFlush(SessionImpl.java:1454)<br>\n    at org.hibernate.internal.SessionImpl.managedFlush(SessionImpl.java:511)<br>\n    at org.hibernate.internal.SessionImpl.flushBeforeTransactionCompletion(SessionImpl.java:3283)<br>\n    at org.hibernate.internal.SessionImpl.beforeTransactionCompletion(SessionImpl.java:2479)<br>\n    at org.hibernate.engine.jdbc.internal.JdbcCoordinatorImpl.beforeTransactionCompletion(JdbcCoordinatorImpl.java:473)<br>\n    at org.hibernate.resource.transaction.backend.jdbc.internal.JdbcResourceLocalTransactionCoordinatorImpl.beforeCompletionCallback(JdbcResourceLocalTransactionCoordinatorImpl.java:178)<br>\n    at org.hibernate.resource.transaction.backend.jdbc.internal.JdbcResourceLocalTransactionCoordinatorImpl.access$300(JdbcResourceLocalTransactionCoordinatorImpl.java:39)<br>\n    at org.hibernate.resource.transaction.backend.jdbc.internal.JdbcResourceLocalTransactionCoordinatorImpl$TransactionDriverControlImpl.commit(JdbcResourceLocalTransactionCoordinatorImpl.java:271)<br>\n    at org.hibernate.engine.transaction.internal.TransactionImpl.commit(TransactionImpl.java:98)<br>\n    at org.springframework.orm.jpa.JpaTransactionManager.doCommit(JpaTransactionManager.java:536)<br>\n    ... 9 common frames omitted<br>\nCaused by: java.sql.BatchUpdateException: Batch entry 0 insert into HFJ_SEARCH_RESULT (SEARCH_ORDER, RESOURCE_PID, SEARCH_PID, PID) values (0, 1228, 1152, 50252) was aborted: ERROR: insert or update on table \"hfj_search_result\" violates foreign key constraint \"fk_searchres_search\"<br>\n  Detail: Key (search_pid)=(1152) is not present in table \"hfj_search\".  Call getNextException to see other errors in the batch.<br>\n    at org.postgresql.jdbc.BatchResultHandler.handleError(BatchResultHandler.java:148)<br>\n    at org.postgresql.core.v3.QueryExecutorImpl.processResults(QueryExecutorImpl.java:2184)<br>\n    at org.postgresql.core.v3.QueryExecutorImpl.execute(QueryExecutorImpl.java:481)<br>\n    at org.postgresql.jdbc.PgStatement.executeBatch(PgStatement.java:840)<br>\n    at org.postgresql.jdbc.PgPreparedStatement.executeBatch(PgPreparedStatement.java:1538)<br>\n    at org.apache.commons.dbcp2.DelegatingStatement.executeBatch(DelegatingStatement.java:223)<br>\n    at org.apache.commons.dbcp2.DelegatingStatement.executeBatch(DelegatingStatement.java:223)<br>\n    at org.hibernate.engine.jdbc.batch.internal.BatchingBatch.performExecution(BatchingBatch.java:118)<br>\n    ... 27 common frames omitted<br>\nCaused by: org.postgresql.util.PSQLException: ERROR: insert or update on table \"hfj_search_result\" violates foreign key constraint \"fk_searchres_search\"<br>\n  Detail: Key (search_pid)=(1152) is not present in table \"hfj_search\".<br>\n    at org.postgresql.core.v3.QueryExecutorImpl.receiveErrorResponse(QueryExecutorImpl.java:2440)<br>\n    at org.postgresql.core.v3.QueryExecutorImpl.processResults(QueryExecutorImpl.java:2183)<br>\n    ... 33 common frames omitted<br>\n2019-02-11 10:26:02.643 [qtp182639397-27] INFO  ca.uhn.fhir.context.FhirContext [FhirContext.java:171] Creating new FHIR context for FHIR version [DSTU3]<br>\n2019-02-11 10:26:02.736 [qtp182639397-27] INFO  ca.uhn.fhir.util.XmlUtil [DependencyLogImpl.java:75] FHIR XML procesing will use StAX implementation 'Woodstox XML-processor' version '4.4.1'<br>\n^C[INFO] Stopped ServerConnector@5eb1fd44{HTTP/1.1,[http/1.1]}{0.0.0.0:8080}<br>\n[INFO] Stopped scavenging<br>\n[INFO] Destroying Spring FrameworkServlet 'spring'</p>",
        "id": 158048329,
        "sender_full_name": "Veliyan Georgiev",
        "timestamp": 1549906282
    },
    {
        "content": "<p>You might want to raise this on the <a class=\"stream\" data-stream-id=\"179167\" href=\"/#narrow/stream/179167-hapi\">#hapi</a> stream</p>",
        "id": 158048818,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1549906710
    }
]