[
    {
        "content": "<p>Hi All,<br>\nNeed help on below issue.</p>\n<p>For Observation resource (STU 3), there is one constraint mentioned -</p>\n<p><a href=\"https://www.hl7.org/implement/standards/fhir/observation.html\" target=\"_blank\" title=\"https://www.hl7.org/implement/standards/fhir/observation.html\">https://www.hl7.org/implement/standards/fhir/observation.html</a> </p>\n<p><strong>obs-7: If code is the same as a component code then the value element associated with the code SHALL NOT be present (expression : value.empty() or code!=component.code)</strong></p>\n<p>In my understanding it means if Observation.code (which means Observation.code.coding.code) is equal to component.code ( which means Observation.component.code.coding.code) then there must not be Observation.value element. </p>\n<p>But when I try to validate this, I am not getting correct results.</p>\n<p><strong>Scenario 1: Error with HAPI code</strong></p>\n<p>Actual FHIR Json Resource:</p>\n<div class=\"codehilite\"><pre><span></span>        {\n             &quot;resourceType&quot;: &quot;Observation&quot;,\n                &quot;identifier&quot;: [\n                    {\n                        &quot;system&quot;: &quot;http://partners.org/schema/ABC/LabTest&quot;,\n                        &quot;value&quot;: &quot;45454545&quot;\n                    }\n                ],\n                &quot;status&quot;: &quot;final&quot;,\n                &quot;category&quot;: [\n                    {\n                        &quot;coding&quot;: [\n                            {\n                                &quot;system&quot;: &quot;http://hl7.org/fhir/observation-category&quot;,\n                                &quot;code&quot;: &quot;laboratory&quot;,\n                                &quot;display&quot;: &quot;Laboratory&quot;\n                            }\n                        ]\n                    }\n                ],\n                &quot;code&quot;: {\n                    &quot;coding&quot;: [\n                        {\n                            &quot;system&quot;: &quot;http://loinc.org&quot;,\n                            &quot;code&quot;: &quot;2823-3&quot;,\n                            &quot;display&quot;: &quot;Potassium [Moles/volume] in Serum or Plasma&quot;\n                        }\n                    ],\n                    &quot;text&quot;: &quot;K&quot;\n                },\n                &quot;effectiveDateTime&quot;: &quot;2014-04-02T07:49:00+05:30&quot;,\n                &quot;valueQuantity&quot;: {\n                    &quot;value&quot;: 100,\n                    &quot;unit&quot;: &quot;mmol/L&quot;\n                },\n                &quot;specimen&quot;: {\n                    &quot;identifier&quot;: {\n                        &quot;system&quot;: &quot;http://mysystem.org/schema/ABC/Specimen&quot;,\n                        &quot;value&quot;: &quot;4547667&quot;\n                    }\n                },\n                &quot;referenceRange&quot;: [\n                    {\n                        &quot;text&quot;: &quot;3.4-4.8&quot;\n                    }\n                ]\n        }\n</pre></div>\n\n\n<p>HAPI code used:</p>\n<p>FhirContext context = FhirContext.forDstu3();<br>\n        FhirValidator validator = context.newValidator();<br>\n        validator.setValidateAgainstStandardSchema(true);<br>\n        validator.setValidateAgainstStandardSchematron(true); </p>\n<p>Error Log:</p>\n<div class=\"codehilite\"><pre><span></span>ValidationResult{messageCount=1, isSuccessful=false, description=&#39;ERROR - [error] Observation @ /*:Observation[namespace-uri()=&#39;http://hl7.org/fhir&#39;][1]; Test=not(exists(f:*[starts-with(local-name(.), &#39;value&#39;)])) or not(count(for $coding in f:code/f:coding return parent::*/f:component/f:code/f:coding[f:code/@value=$coding/f:code/@value and f:system/@value=$coding/f:system/@value])=0); Message=obs-7: If code is the same as a component code then the value element associated with the code SHALL NOT be present - Observation @ /*:Observation[namespace-uri()=&#39;http://hl7.org/fhir&#39;][1]&#39;}\n</pre></div>\n\n\n<p>Note- I tried above example to validate on below Public servers and did not get any error-<br>\n<a href=\"http://test.fhir.org/r4\" target=\"_blank\" title=\"http://test.fhir.org/r4\">http://test.fhir.org/r4</a></p>\n<p><a href=\"http://fhir.hl7fundamentals.org/baseDstu3\" target=\"_blank\" title=\"http://fhir.hl7fundamentals.org/baseDstu3\">http://fhir.hl7fundamentals.org/baseDstu3</a> (used $validate operation)</p>\n<p><strong>Scenario 2: Error</strong> Using some other public fhir test server and other Observation resource examples to compare how other test servers behaves for this issue</p>\n<p>Observation Resource with only one component. This is giving error related to above constraint.</p>\n<div class=\"codehilite\"><pre><span></span>{\n  &quot;resourceType&quot;: &quot;Observation&quot;,\n  &quot;id&quot;: &quot;blood-pressure&quot;,\n  &quot;meta&quot;: {\n    &quot;profile&quot;: [\n      &quot;http://hl7.org/fhir/StructureDefinition/vitalsigns&quot;\n    ]\n  },\n  &quot;identifier&quot;: [\n    {\n      &quot;system&quot;: &quot;urn:ietf:rfc:3986&quot;,\n      &quot;value&quot;: &quot;urn:uuid:187e0c12-8dd2-67e2-99b2-bf273c878281&quot;\n    }\n  ],\n  &quot;status&quot;: &quot;final&quot;,\n  &quot;category&quot;: [\n    {\n      &quot;coding&quot;: [\n        {\n          &quot;system&quot;: &quot;http://hl7.org/fhir/observation-category&quot;,\n          &quot;code&quot;: &quot;vital-signs&quot;,\n          &quot;display&quot;: &quot;Vital Signs&quot;\n        }\n      ]\n    }\n  ],\n  &quot;code&quot;: {\n    &quot;coding&quot;: [\n      {\n        &quot;system&quot;: &quot;http://loinc.org&quot;,\n        &quot;code&quot;: &quot;85354-9&quot;,\n        &quot;display&quot;: &quot;Bood pressure panel with all children optional&quot;\n      }\n    ],\n    &quot;text&quot;: &quot;Blood pressure systolic &amp; diastolic&quot;\n  },\n  &quot;subject&quot;: {\n    &quot;reference&quot;: &quot;Patient/example&quot;\n  },\n  &quot;effectiveDateTime&quot;: &quot;2012-09-17&quot;,\n   &quot;valueQuantity&quot;: {\n        &quot;value&quot;: 60,\n        &quot;unit&quot;: &quot;mmHg&quot;,\n        &quot;system&quot;: &quot;http://unitsofmeasure.org&quot;,\n        &quot;code&quot;: &quot;mm[Hg]&quot;\n      },\n  &quot;component&quot;: [\n    {\n      &quot;code&quot;: {\n        &quot;coding&quot;: [\n          {\n            &quot;system&quot;: &quot;http://loinc.org&quot;,\n            &quot;code&quot;: &quot;8480-6&quot;,\n            &quot;display&quot;: &quot;Systolic blood pressure&quot;\n          }\n        ]\n      },\n      &quot;valueQuantity&quot;: {\n        &quot;value&quot;: 107,\n        &quot;unit&quot;: &quot;mmHg&quot;,\n        &quot;system&quot;: &quot;http://unitsofmeasure.org&quot;,\n        &quot;code&quot;: &quot;mm[Hg]&quot;\n      }\n    }\n  ]\n}\n</pre></div>\n\n\n<p>I am validating resouce using $validate opeartion. Here is the query (using POST)-<br>\n<a href=\"http://fhir.hl7fundamentals.org/baseDstu3/Observation/$validate\" target=\"_blank\" title=\"http://fhir.hl7fundamentals.org/baseDstu3/Observation/$validate\">http://fhir.hl7fundamentals.org/baseDstu3/Observation/$validate</a></p>\n<p>Above resource in POST body. </p>\n<p>But Observation.code is not equal to Observation.component.code in above case.</p>\n<p><strong>Server response</strong>- see the last error, rest warnings are fine, I do understand what they are</p>\n<div class=\"codehilite\"><pre><span></span>{\n    &quot;resourceType&quot;: &quot;OperationOutcome&quot;,\n    &quot;text&quot;: {\n        &quot;status&quot;: &quot;generated&quot;,\n        &quot;div&quot;: &quot;&lt;div xmlns=\\&quot;http://www.w3.org/1999/xhtml\\&quot;&gt;&lt;h1&gt;Operation Outcome&lt;/h1&gt;&lt;table border=\\&quot;0\\&quot;&gt;&lt;tr&gt;&lt;td style=\\&quot;font-weight: bold;\\&quot;&gt;WARNING&lt;/td&gt;&lt;td&gt;[Observation]&lt;/td&gt;&lt;td&gt;&lt;pre&gt;All observations should have a performer&lt;/pre&gt;&lt;/td&gt;\\n\\t\\t\\t\\t\\t\\n\\t\\t\\t\\t\\n\\t\\t\\t&lt;/tr&gt;\\n\\t\\t\\t&lt;tr&gt;\\n\\t\\t\\t\\t&lt;td style=\\&quot;font-weight: bold;\\&quot;&gt;INFORMATION&lt;/td&gt;\\n\\t\\t\\t\\t&lt;td&gt;[Observation]&lt;/td&gt;\\n\\t\\t\\t\\t\\n\\t\\t\\t\\t\\t\\n\\t\\t\\t\\t\\t\\n\\t\\t\\t\\t\\t\\t&lt;td&gt;&lt;pre&gt;All observations should have a performer&lt;/pre&gt;&lt;/td&gt;\\n\\t\\t\\t\\t\\t\\n\\t\\t\\t\\t\\n\\t\\t\\t&lt;/tr&gt;\\n\\t\\t\\t&lt;tr&gt;\\n\\t\\t\\t\\t&lt;td style=\\&quot;font-weight: bold;\\&quot;&gt;ERROR&lt;/td&gt;\\n\\t\\t\\t\\t&lt;td&gt;[Observation]&lt;/td&gt;\\n\\t\\t\\t\\t\\n\\t\\t\\t\\t\\t\\n\\t\\t\\t\\t\\t\\n\\t\\t\\t\\t\\t\\t&lt;td&gt;&lt;pre&gt;If code is the same as a component code then the value element associated with the code SHALL NOT be present [value.empty() or code!=component.code]&lt;/pre&gt;&lt;/td&gt;\\n\\t\\t\\t\\t\\t\\n\\t\\t\\t\\t\\n\\t\\t\\t&lt;/tr&gt;\\n\\t\\t&lt;/table&gt;\\n\\t&lt;/div&gt;&quot;\n    },\n    &quot;issue&quot;: [\n        {\n            &quot;severity&quot;: &quot;warning&quot;,\n            &quot;code&quot;: &quot;processing&quot;,\n            &quot;diagnostics&quot;: &quot;All observations should have a performer&quot;,\n            &quot;location&quot;: [\n                &quot;Observation&quot;\n            ]\n        },\n        {\n            &quot;severity&quot;: &quot;information&quot;,\n            &quot;code&quot;: &quot;processing&quot;,\n            &quot;diagnostics&quot;: &quot;All observations should have a performer&quot;,\n            &quot;location&quot;: [\n                &quot;Observation&quot;\n            ]\n        },\n        {\n            &quot;severity&quot;: &quot;error&quot;,\n            &quot;code&quot;: &quot;processing&quot;,\n            &quot;diagnostics&quot;: &quot;If code is the same as a component code then the value element associated with the code SHALL NOT be present [value.empty() or code!=component.code]&quot;,\n            &quot;location&quot;: [\n                &quot;Observation&quot;\n            ]\n        }\n    ]\n}\n</pre></div>\n\n\n<p><strong>Note</strong>- I tried above example to validate on below Public servers and did not get any error-<br>\n<a href=\"http://test.fhir.org/r4\" target=\"_blank\" title=\"http://test.fhir.org/r4\">http://test.fhir.org/r4</a></p>\n<p><strong>Scenario 3: When I use both components, error went away. </strong></p>\n<div class=\"codehilite\"><pre><span></span>{\n  &quot;resourceType&quot;: &quot;Observation&quot;,\n  &quot;id&quot;: &quot;blood-pressure&quot;,\n  &quot;meta&quot;: {\n    &quot;profile&quot;: [\n      &quot;http://hl7.org/fhir/StructureDefinition/vitalsigns&quot;\n    ]\n  },\n  &quot;identifier&quot;: [\n    {\n      &quot;system&quot;: &quot;urn:ietf:rfc:3986&quot;,\n      &quot;value&quot;: &quot;urn:uuid:187e0c12-8dd2-67e2-99b2-bf273c878281&quot;\n    }\n  ],\n  &quot;status&quot;: &quot;final&quot;,\n  &quot;category&quot;: [\n    {\n      &quot;coding&quot;: [\n        {\n          &quot;system&quot;: &quot;http://hl7.org/fhir/observation-category&quot;,\n          &quot;code&quot;: &quot;vital-signs&quot;,\n          &quot;display&quot;: &quot;Vital Signs&quot;\n        }\n      ]\n    }\n  ],\n  &quot;code&quot;: {\n    &quot;coding&quot;: [\n      {\n        &quot;system&quot;: &quot;http://loinc.org&quot;,\n        &quot;code&quot;: &quot;85354-9&quot;,\n        &quot;display&quot;: &quot;Bood pressure panel with all children optional&quot;\n      }\n    ],\n    &quot;text&quot;: &quot;Blood pressure systolic &amp; diastolic&quot;\n  },\n  &quot;subject&quot;: {\n    &quot;reference&quot;: &quot;Patient/example&quot;\n  },\n  &quot;effectiveDateTime&quot;: &quot;2012-09-17&quot;,\n   &quot;valueQuantity&quot;: {\n        &quot;value&quot;: 60,\n        &quot;unit&quot;: &quot;mmHg&quot;,\n        &quot;system&quot;: &quot;http://unitsofmeasure.org&quot;,\n        &quot;code&quot;: &quot;mm[Hg]&quot;\n      },\n  &quot;component&quot;: [\n    {\n      &quot;code&quot;: {\n        &quot;coding&quot;: [\n          {\n            &quot;system&quot;: &quot;http://loinc.org&quot;,\n            &quot;code&quot;: &quot;8480-6&quot;,\n            &quot;display&quot;: &quot;Systolic blood pressure&quot;\n          }\n        ]\n      },\n      &quot;valueQuantity&quot;: {\n        &quot;value&quot;: 107,\n        &quot;unit&quot;: &quot;mmHg&quot;,\n        &quot;system&quot;: &quot;http://unitsofmeasure.org&quot;,\n        &quot;code&quot;: &quot;mm[Hg]&quot;\n      }\n    },\n    {\n      &quot;code&quot;: {\n        &quot;coding&quot;: [\n          {\n            &quot;system&quot;: &quot;http://loinc.org&quot;,\n            &quot;code&quot;: &quot;8462-4&quot;,\n            &quot;display&quot;: &quot;Diastolic blood pressure&quot;\n          }\n        ]\n      },\n      &quot;valueQuantity&quot;: {\n        &quot;value&quot;: 60,\n        &quot;unit&quot;: &quot;mmHg&quot;,\n        &quot;system&quot;: &quot;http://unitsofmeasure.org&quot;,\n        &quot;code&quot;: &quot;mm[Hg]&quot;\n      }\n    }\n  ]\n}\n</pre></div>\n\n\n<p><strong>Scenario 4: when no component, no error on baseDSTU3 server but error with HAPI code</strong></p>\n<p>I am really not clear on this constraint, what it really meant. and why I am getting error when there is one component  but codes are different. </p>\n<p>Thanks for your help.</p>\n<p>Regards,<br>\nAditya Joshi</p>",
        "id": 153969887,
        "sender_full_name": "Aditya Joshi",
        "timestamp": 1528984712
    },
    {
        "content": "<p>your interpretation is correct.  if  code = A and component.code = A then there is no value, component.values are allowed.</p>",
        "id": 153969946,
        "sender_full_name": "Eric Haas",
        "timestamp": 1529001604
    },
    {
        "content": "<p>Thanks Eric for confirmation. So, do you think that issue I have posted is due to HAPI validator. For the Json I have posted this issue must not come from validator.</p>",
        "id": 153969956,
        "sender_full_name": "Aditya Joshi",
        "timestamp": 1529003657
    },
    {
        "content": "<p>For comparison you can also try to validate it using the .NET validator. You can use the .NET validator with the <a href=\"https://github.com/ewoutkramer/Furore.Fhir.ValidationDemo\" target=\"_blank\" title=\"https://github.com/ewoutkramer/Furore.Fhir.ValidationDemo\">ValidationDemo</a> or by invoking the <a href=\"http://docs.simplifier.net/vonk/features/validation.html#validate-on-the-resourcetype-level\" target=\"_blank\" title=\"http://docs.simplifier.net/vonk/features/validation.html#validate-on-the-resourcetype-level\">$validate operation</a> on Vonk (<a href=\"http://vonk.fire.ly\" target=\"_blank\" title=\"http://vonk.fire.ly\">vonk.fire.ly</a>)</p>",
        "id": 153973290,
        "sender_full_name": "Christiaan Knaap",
        "timestamp": 1530679000
    }
]