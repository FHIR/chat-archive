[
    {
        "content": "<p>Hi all - I'm currently playing around with the FHIR Search.<br>\nAt the moment I'm trying some composite searches on our HAPI test server and recognised some things I don't understand.<br>\nFirst of all I deployed the example from the FHIR website for blood pressure on our Hapi (<a href=\"https://www.hl7.org/fhir/observation-example-bloodpressure.json.html\" target=\"_blank\" title=\"https://www.hl7.org/fhir/observation-example-bloodpressure.json.html\">https://www.hl7.org/fhir/observation-example-bloodpressure.json.html</a>) with all the necessary values and references (the jsons i deployed are listed below, I just copied them from the official test server or from the fhir website and modified some values a little bit)</p>\n<p>1. When I'm doing a composite search like : Observation?component-code-value-quantity=8480-6$lt70, my Patient is also displayed even when the systolic blood pressure (99) isn't lower than 70.<br>\nI recongised that the diastolic blood pressure is 60 and if I enter a value below 60 no patient is displayed.<br>\nI guess its just searching for \"some\" valueQuantity.</p>\n<p>So the search doesn't really connect the code with the value ? <br>\nIs this a bug within the Hapi Server, are the composite searches not fully implemented yet?<br>\nOr did I made some mistake/misunderstood something ? </p>\n<p>2. If I'm trying to connect multiple Parameters for a patient like:<br>\na) /Patient?_has:Observation:subject:component-code=8480-6&amp;_has:Observation:subject:value-quantity=lt90 (works but same problem like in 1 )<br>\nor <br>\nb) /Patient?_has:Observation:subject:component-code-value-quantity=8480-6$lt90 (does display an error)<br>\nWhy is b) not working (wrong syntax/not implemented) ?<br>\nAlso i don't think a) is connecting the systolic code and the value at all, even if the search in 1. would work.</p>\n<p>3. How would a search for female patients with blood pressure (sys) &gt;90 and Body Temperature &gt;37.0 look like?</p>\n<p>Regards,<br>\nSeverin Kohler</p>\n<p>-----------------------------Here are the Resources, Observations etc. i deployed on my HAPI---------------------------------<br>\n---------------------Patient 1------------------------<br>\n{<br>\n \"resourceType\": \"Patient\",<br>\n  \"id\": \"5\",<br>\n  \"active\": true,<br>\n  \"gender\": \"female\",<br>\n  \"birthDate\": \"1976-07-01\",<br>\n  \"deceasedBoolean\": false,<br>\n    \"name\": [<br>\n    {<br>\n      \"family\": \"of Alexandria\",<br>\n      \"given\": [<br>\n        \"Aedesia\"<br>\n      ]<br>\n    }<br>\n  ]<br>\n}</p>\n<p>-----------PRACTITIONER----------------------<br>\n{<br>\n  \"resourceType\": \"Practitioner\",<br>\n  \"id\": \"22291\",<br>\n  \"meta\": {<br>\n    \"versionId\": \"1\",<br>\n    \"lastUpdated\": \"2018-10-01T06:18:35.977+00:00\"<br>\n  },<br>\n  \"identifier\": [<br>\n    {<br>\n      \"system\": \"<a href=\"http://clinfhir.com/fhir/NamingSystem/practitioner\" target=\"_blank\" title=\"http://clinfhir.com/fhir/NamingSystem/practitioner\">http://clinfhir.com/fhir/NamingSystem/practitioner</a>\",<br>\n      \"value\": \"NM7uqTm65gZHKEzsqLQ9nT2y2662\"<br>\n    }<br>\n  ],<br>\n  \"name\": [<br>\n    {<br>\n      \"family\": \"DOCTOR\",<br>\n      \"given\": [<br>\n        \"REFERRING\"<br>\n      ]<br>\n    }<br>\n  ]<br>\n}</p>\n<p>-----------Observation Blood Pressure --------------------<br>\n{<br>\n  \"resourceType\": \"Observation\",<br>\n  \"id\": \"blood-pressure\",<br>\n  \"meta\": {<br>\n    \"profile\": [<br>\n      \"<a href=\"http://hl7.org/fhir/StructureDefinition/vitalsigns\" target=\"_blank\" title=\"http://hl7.org/fhir/StructureDefinition/vitalsigns\">http://hl7.org/fhir/StructureDefinition/vitalsigns</a>\"<br>\n    ]<br>\n  },<br>\n  \"text\": {<br>\n    \"status\": \"generated\",<br>\n    \"div\": \"&lt;div xmlns=\\\"http://www.w3.org/1999/xhtml\\\"&gt;&lt;p&gt;&lt;b&gt;Generated Narrative with Details&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;id&lt;/b&gt;: blood-pressure&lt;/p&gt;&lt;p&gt;&lt;b&gt;meta&lt;/b&gt;: &lt;/p&gt;&lt;p&gt;&lt;b&gt;identifier&lt;/b&gt;: urn:uuid:187e0c12-8dd2-67e2-99b2-bf273c878281&lt;/p&gt;&lt;p&gt;&lt;b&gt;basedOn&lt;/b&gt;: &lt;/p&gt;&lt;p&gt;&lt;b&gt;status&lt;/b&gt;: final&lt;/p&gt;&lt;p&gt;&lt;b&gt;category&lt;/b&gt;: Vital Signs &lt;span&gt;(Details : {http://hl7.org/fhir/observation-category code 'vital-signs' = 'Vital Signs', given as 'Vital Signs'})&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;code&lt;/b&gt;: Blood pressure systolic &amp; diastolic &lt;span&gt;(Details : {LOINC code '85354-9' = 'lood pressure panel with all children optional', given as 'Bood pressure panel with all children optional'})&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;subject&lt;/b&gt;: &lt;a&gt;Patient/example&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;effective&lt;/b&gt;: 17/09/2012&lt;/p&gt;&lt;p&gt;&lt;b&gt;performer&lt;/b&gt;: &lt;a&gt;Practitioner/example&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;interpretation&lt;/b&gt;: Below low normal &lt;span&gt;(Details : {http://hl7.org/fhir/v2/0078 code 'L' = 'Low', given as 'low'})&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;bodySite&lt;/b&gt;: Right arm &lt;span&gt;(Details : {SNOMED CT code '368209003' = 'Right upper arm', given as 'Right arm'})&lt;/span&gt;&lt;/p&gt;&lt;blockquote&gt;&lt;p&gt;&lt;b&gt;component&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;code&lt;/b&gt;: Systolic blood pressure &lt;span&gt;(Details : {LOINC code '8480-6' = 'Systolic blood pressure', given as 'Systolic blood pressure'}; {SNOMED CT code '271649006' = 'Systolic blood pressure', given as 'Systolic blood pressure'}; {http://acme.org/devices/clinical-codes code 'bp-s' = 'bp-s', given as 'Systolic Blood pressure'})&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;value&lt;/b&gt;: 107 mmHg&lt;span&gt; (Details: UCUM code mm[Hg] = 'mmHg')&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;interpretation&lt;/b&gt;: Normal &lt;span&gt;(Details : {http://hl7.org/fhir/v2/0078 code 'N' = 'Normal', given as 'normal'})&lt;/span&gt;&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;p&gt;&lt;b&gt;component&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;code&lt;/b&gt;: Diastolic blood pressure &lt;span&gt;(Details : {LOINC code '8462-4' = 'Diastolic blood pressure', given as 'Diastolic blood pressure'})&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;value&lt;/b&gt;: 60 mmHg&lt;span&gt; (Details: UCUM code mm[Hg] = 'mmHg')&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;interpretation&lt;/b&gt;: Below low normal &lt;span&gt;(Details : {http://hl7.org/fhir/v2/0078 code 'L' = 'Low', given as 'low'})&lt;/span&gt;&lt;/p&gt;&lt;/blockquote&gt;&lt;/div&gt;\"<br>\n  },<br>\n  \"identifier\": [<br>\n    {<br>\n      \"system\": \"urn:ietf:rfc:3986\",<br>\n      \"value\": \"urn:uuid:187e0c12-8dd2-67e2-99b2-bf273c878281\"<br>\n    }<br>\n  ],<br>\n  \"basedOn\": [<br>\n    {<br>\n      \"identifier\": {<br>\n        \"system\": \"<a href=\"https://acme.org/identifiers\" target=\"_blank\" title=\"https://acme.org/identifiers\">https://acme.org/identifiers</a>\",<br>\n        \"value\": \"1234\"<br>\n      }<br>\n    }<br>\n  ],<br>\n  \"status\": \"final\",<br>\n  \"category\": [<br>\n    {<br>\n      \"coding\": [<br>\n        {<br>\n          \"system\": \"<a href=\"http://hl7.org/fhir/observation-category\" target=\"_blank\" title=\"http://hl7.org/fhir/observation-category\">http://hl7.org/fhir/observation-category</a>\",<br>\n          \"code\": \"vital-signs\",<br>\n          \"display\": \"Vital Signs\"<br>\n        }<br>\n      ]<br>\n    }<br>\n  ],<br>\n  \"code\": {<br>\n    \"coding\": [<br>\n      {<br>\n        \"system\": \"<a href=\"http://loinc.org\" target=\"_blank\" title=\"http://loinc.org\">http://loinc.org</a>\",<br>\n        \"code\": \"85354-9\",<br>\n        \"display\": \"Bood pressure panel with all children optional\"<br>\n      }<br>\n    ],<br>\n    \"text\": \"Blood pressure systolic &amp; diastolic\"<br>\n  },<br>\n  \"subject\": {<br>\n    \"reference\": \"Patient/5\"<br>\n  },<br>\n  \"effectiveDateTime\": \"2012-09-17\",<br>\n  \"performer\": [<br>\n    {<br>\n      \"reference\": \"Practitioner/3\"<br>\n    }<br>\n  ],<br>\n  \"interpretation\": {<br>\n    \"coding\": [<br>\n      {<br>\n        \"system\": \"<a href=\"http://hl7.org/fhir/v2/0078\" target=\"_blank\" title=\"http://hl7.org/fhir/v2/0078\">http://hl7.org/fhir/v2/0078</a>\",<br>\n        \"code\": \"L\",<br>\n        \"display\": \"low\"<br>\n      }<br>\n    ],<br>\n    \"text\": \"Below low normal\"<br>\n  },<br>\n  \"bodySite\": {<br>\n    \"coding\": [<br>\n      {<br>\n        \"system\": \"<a href=\"http://snomed.info/sct\" target=\"_blank\" title=\"http://snomed.info/sct\">http://snomed.info/sct</a>\",<br>\n        \"code\": \"368209003\",<br>\n        \"display\": \"Right arm\"<br>\n      }<br>\n    ]<br>\n  },<br>\n  \"component\": [<br>\n    {<br>\n      \"code\": {<br>\n        \"coding\": [<br>\n          {<br>\n            \"system\": \"<a href=\"http://loinc.org\" target=\"_blank\" title=\"http://loinc.org\">http://loinc.org</a>\",<br>\n            \"code\": \"8480-6\",<br>\n            \"display\": \"Systolic blood pressure\"<br>\n          },<br>\n          {<br>\n            \"system\": \"<a href=\"http://snomed.info/sct\" target=\"_blank\" title=\"http://snomed.info/sct\">http://snomed.info/sct</a>\",<br>\n            \"code\": \"271649006\",<br>\n            \"display\": \"Systolic blood pressure\"<br>\n          },<br>\n          {<br>\n            \"system\": \"<a href=\"http://acme.org/devices/clinical-codes\" target=\"_blank\" title=\"http://acme.org/devices/clinical-codes\">http://acme.org/devices/clinical-codes</a>\",<br>\n            \"code\": \"bp-s\",<br>\n            \"display\": \"Systolic Blood pressure\"<br>\n          }<br>\n        ]<br>\n      },<br>\n      \"valueQuantity\": {<br>\n        \"value\": 99,<br>\n        \"unit\": \"mmHg\",<br>\n        \"system\": \"<a href=\"http://unitsofmeasure.org\" target=\"_blank\" title=\"http://unitsofmeasure.org\">http://unitsofmeasure.org</a>\",<br>\n        \"code\": \"mm[Hg]\"<br>\n      },<br>\n      \"interpretation\": {<br>\n        \"coding\": [<br>\n          {<br>\n            \"system\": \"<a href=\"http://hl7.org/fhir/v2/0078\" target=\"_blank\" title=\"http://hl7.org/fhir/v2/0078\">http://hl7.org/fhir/v2/0078</a>\",<br>\n            \"code\": \"N\",<br>\n            \"display\": \"normal\"<br>\n          }<br>\n        ],<br>\n        \"text\": \"Normal\"<br>\n      }<br>\n    },<br>\n    {<br>\n      \"code\": {<br>\n        \"coding\": [<br>\n          {<br>\n            \"system\": \"<a href=\"http://loinc.org\" target=\"_blank\" title=\"http://loinc.org\">http://loinc.org</a>\",<br>\n            \"code\": \"8462-4\",<br>\n            \"display\": \"Diastolic blood pressure\"<br>\n          }<br>\n        ]<br>\n      },<br>\n      \"valueQuantity\": {<br>\n        \"value\": 60,<br>\n        \"unit\": \"mmHg\",<br>\n        \"system\": \"<a href=\"http://unitsofmeasure.org\" target=\"_blank\" title=\"http://unitsofmeasure.org\">http://unitsofmeasure.org</a>\",<br>\n        \"code\": \"mm[Hg]\"<br>\n      },<br>\n      \"interpretation\": {<br>\n        \"coding\": [<br>\n          {<br>\n            \"system\": \"<a href=\"http://hl7.org/fhir/v2/0078\" target=\"_blank\" title=\"http://hl7.org/fhir/v2/0078\">http://hl7.org/fhir/v2/0078</a>\",<br>\n            \"code\": \"L\",<br>\n            \"display\": \"low\"<br>\n          }<br>\n        ],<br>\n        \"text\": \"Below low normal\"<br>\n      }<br>\n    }<br>\n  ]<br>\n}</p>\n<p>---------------------Observation Body Temperature------------------------------</p>\n<p>{<br>\n  \"resourceType\": \"Observation\",<br>\n  \"id\": \"body-temperature\",<br>\n  \"meta\": {<br>\n    \"profile\": [<br>\n      \"<a href=\"http://hl7.org/fhir/StructureDefinition/vitalsigns\" target=\"_blank\" title=\"http://hl7.org/fhir/StructureDefinition/vitalsigns\">http://hl7.org/fhir/StructureDefinition/vitalsigns</a>\"<br>\n    ]<br>\n  },<br>\n  \"text\": {<br>\n    \"status\": \"generated\",<br>\n    \"div\": \"&lt;div xmlns=\\\"http://www.w3.org/1999/xhtml\\\"&gt;&lt;p&gt;&lt;b&gt;Generated Narrative with Details&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;id&lt;/b&gt;: body-temperature&lt;/p&gt;&lt;p&gt;&lt;b&gt;meta&lt;/b&gt;: &lt;/p&gt;&lt;p&gt;&lt;b&gt;status&lt;/b&gt;: final&lt;/p&gt;&lt;p&gt;&lt;b&gt;category&lt;/b&gt;: Vital Signs &lt;span&gt;(Details : {http://hl7.org/fhir/observation-category code 'vital-signs' = 'Vital Signs', given as 'Vital Signs'})&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;code&lt;/b&gt;: Body temperature &lt;span&gt;(Details : {LOINC code '8310-5' = 'Body temperature', given as 'Body temperature'})&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;subject&lt;/b&gt;: &lt;a&gt;Patient/example&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;effective&lt;/b&gt;: 02/07/1999&lt;/p&gt;&lt;p&gt;&lt;b&gt;value&lt;/b&gt;: 36.5 C&lt;span&gt; (Details: UCUM code Cel = 'Cel')&lt;/span&gt;&lt;/p&gt;&lt;/div&gt;\"<br>\n  },<br>\n  \"status\": \"final\",<br>\n  \"category\": [<br>\n    {<br>\n      \"coding\": [<br>\n        {<br>\n          \"system\": \"<a href=\"http://hl7.org/fhir/observation-category\" target=\"_blank\" title=\"http://hl7.org/fhir/observation-category\">http://hl7.org/fhir/observation-category</a>\",<br>\n          \"code\": \"vital-signs\",<br>\n          \"display\": \"Vital Signs\"<br>\n        }<br>\n      ],<br>\n      \"text\": \"Vital Signs\"<br>\n    }<br>\n  ],<br>\n  \"code\": {<br>\n    \"coding\": [<br>\n      {<br>\n        \"system\": \"<a href=\"http://loinc.org\" target=\"_blank\" title=\"http://loinc.org\">http://loinc.org</a>\",<br>\n        \"code\": \"8310-5\",<br>\n        \"display\": \"Body temperature\"<br>\n      }<br>\n    ],<br>\n    \"text\": \"Body temperature\"<br>\n  },<br>\n  \"subject\": {<br>\n    \"reference\": \"Patient/5\"<br>\n  },<br>\n  \"effectiveDateTime\": \"1999-07-02\",<br>\n  \"valueQuantity\": {<br>\n    \"value\": 37.2,<br>\n    \"unit\": \"C\",<br>\n    \"system\": \"<a href=\"http://unitsofmeasure.org\" target=\"_blank\" title=\"http://unitsofmeasure.org\">http://unitsofmeasure.org</a>\",<br>\n    \"code\": \"Cel\"<br>\n  }<br>\n}</p>",
        "id": 154023754,
        "sender_full_name": "Severin Kohler",
        "timestamp": 1544196917
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span> ?</p>",
        "id": 154024296,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1544486364
    },
    {
        "content": "<p>This composite search issue is a known issue in HAPI FHIR. Unfortunately it's a hard one to fix..</p>",
        "id": 154024382,
        "sender_full_name": "James Agnew",
        "timestamp": 1544524308
    },
    {
        "content": "<p>Just to make sure I understand the composite parameter examples in the spec at 2.21.1.4.15 - is example #1 in this thread valid without specifying the system, or should it be \"Observation?component-code-value-quantity=http://loinc.org|8480-6$lt70\"? Based on the token definition I guess both should work.</p>",
        "id": 154024571,
        "sender_full_name": "Paul Church",
        "timestamp": 1544559843
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"194952\">@Julian Sass</span></p>",
        "id": 154025621,
        "sender_full_name": "Severin Kohler",
        "timestamp": 1544782444
    },
    {
        "content": "<blockquote>\n<p>This composite search issue is a known issue in HAPI FHIR. Unfortunately it's a hard one to fix..</p>\n</blockquote>\n<p>okay so i just try it on a vonk then</p>",
        "id": 154025622,
        "sender_full_name": "Severin Kohler",
        "timestamp": 1544783101
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"196447\">@Andrea Essenwanger</span></p>",
        "id": 154025623,
        "sender_full_name": "Severin Kohler",
        "timestamp": 1544784865
    },
    {
        "content": "<p>Hi Severin!</p>\n<p>Unfortunately, there is currently also a known bug in Vonk related to composite parameters.<br>\nInstead of searching on \"component-code-value-quantity\" it will try to search on \"component-value-quantity\".<br>\nSo search request 1) does not work.</p>\n<p>2a) This search query is not working because \"lt90\" is not a valid value for \"value-quantity\". In a quantity, only the prefix is optional.<br>\nYou have to supply the system and unit. {{BASE_URL}}/Observation?value-quantity=lt70|http://unitsofmeasure.org|mm[Hg] should work fine.<br>\nA combination with _has is valid, however, it needs to be noted that both _has parts are applied independently. So, the server forms a union of both result sets not an intersection. If you need to have a logical AND, have a look at _filter, though, this is not widely implemented.</p>\n<p>2b) Should work if you provide all mandatory parts, provided 1) get's fixed.</p>\n<p>3) A combination of _filter and _type should work. However, I guess at the moment there is not a single server capable of handling this.</p>",
        "id": 154025703,
        "sender_full_name": "Alexander Zautke",
        "timestamp": 1544819519
    }
]