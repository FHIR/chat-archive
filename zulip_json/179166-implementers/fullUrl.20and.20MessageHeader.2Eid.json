[
    {
        "content": "<p>Hi, can u please help me on this question? When I send a json message with a bundle where the first entry is a MessageHeader, I set the entry.fullUrl to \"urn:uuid:49c843ba-5686-4549-93c8-afb8c8d2c1ea\" and the <a href=\"http://entry.resource.MessageHeader.id\" target=\"_blank\" title=\"http://entry.resource.MessageHeader.id\">entry.resource.MessageHeader.id</a> to \"49c843ba-5686-4549-93c8-afb8c8d2c1ea\", but then the HAPI validator deletes the <a href=\"http://entry.resource.MessageHeader.id\" target=\"_blank\" title=\"http://entry.resource.MessageHeader.id\">entry.resource.MessageHeader.id</a>, is this normal?</p>",
        "id": 153818701,
        "sender_full_name": "Patricia Alves",
        "timestamp": 1459242746
    },
    {
        "content": "<p>Hi Patricia, do you mean like you're sending it to a HAPI server and the server is deleting the ID? Or something else?</p>",
        "id": 153818783,
        "sender_full_name": "James Agnew",
        "timestamp": 1459259059
    },
    {
        "content": "<p>Deleted</p>",
        "id": 153818787,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1459259805
    },
    {
        "content": "<p>Yes, i'm sending to a HAPI server</p>",
        "id": 153818794,
        "sender_full_name": "Patricia Alves",
        "timestamp": 1459260204
    },
    {
        "content": "<p>and it deletes the iD</p>",
        "id": 153818796,
        "sender_full_name": "Patricia Alves",
        "timestamp": 1459260225
    },
    {
        "content": "<p>HAPI treats UUID IDs on resources it receives as being placeholders, and replaces them with the appropriate permanent ID. The idea is that if you want to send in a bunch of resources with links to each other but you don't yet know what the IDs for those resources will be, you can use placeholder UUIDs  as a substitute. There's an example of this here: <a href=\"http://jamesagnew.github.io/hapi-fhir/doc_rest_client_examples.html#Transaction_With_Placeholder_IDs\" target=\"_blank\" title=\"http://jamesagnew.github.io/hapi-fhir/doc_rest_client_examples.html#Transaction_With_Placeholder_IDs\">http://jamesagnew.github.io/hapi-fhir/doc_rest_client_examples.html#Transaction_With_Placeholder_IDs</a></p>\n<p>What are you trying to achieve? Do you want the resource to actually be stored with that UUID?</p>",
        "id": 153818832,
        "sender_full_name": "James Agnew",
        "timestamp": 1459262542
    },
    {
        "content": "<p>@James, I believe Patricia is implementing a fhir messaging paradigm, not transaction. In the fhir messaging definition on MessageHeader Identifiers - <a href=\"http://hl7-fhir.github.io/messaging.html#2.4.1.3\" target=\"_blank\" title=\"http://hl7-fhir.github.io/messaging.html#2.4.1.3\">http://hl7-fhir.github.io/messaging.html#2.4.1.3</a> - the purpose of the <a href=\"http://MessageHeader.id\" target=\"_blank\" title=\"http://MessageHeader.id\">MessageHeader.id</a> is \"Each time a new message is created, it SHALL be assigned an identifier (<a href=\"http://MessageHeader.id\" target=\"_blank\" title=\"http://MessageHeader.id\">MessageHeader.id</a>) that is unique within that message stream. ... This can be achieved by using a UUID or an OID.\" Also, \"The response message also quotes the request <a href=\"http://MessageHeader.id\" target=\"_blank\" title=\"http://MessageHeader.id\">MessageHeader.id</a> in MessageHeader.response.identifier so that the source system can relate the response to its request.\"</p>",
        "id": 153818837,
        "sender_full_name": "Richard Ettema",
        "timestamp": 1459263271
    },
    {
        "content": "<p>So, from my understanding within the context of fhir messaging, the <a href=\"http://MessageHeader.id\" target=\"_blank\" title=\"http://MessageHeader.id\">MessageHeader.id</a> value should not be considered a \"placeholder\" value.</p>",
        "id": 153818838,
        "sender_full_name": "Richard Ettema",
        "timestamp": 1459263282
    },
    {
        "content": "<p>That's correct @Richard, I just want to give an ID to the resource like you describe. And since I saw the use of \"urn:uuid\" in this example (<a href=\"http://hl7-fhir.github.io/message-request-link.json.html\" target=\"_blank\" title=\"http://hl7-fhir.github.io/message-request-link.json.html\">http://hl7-fhir.github.io/message-request-link.json.html</a>) I also used it in my message. I don't want it to be a placeholder.</p>",
        "id": 153818846,
        "sender_full_name": "Patricia Alves",
        "timestamp": 1459263454
    },
    {
        "content": "<p>So, is it normal in the messaging context that the <a href=\"http://MessageHeader.id\" target=\"_blank\" title=\"http://MessageHeader.id\">MessageHeader.id</a> is removed?</p>",
        "id": 153818869,
        "sender_full_name": "Patricia Alves",
        "timestamp": 1459267452
    },
    {
        "content": "<p>Can you describe exactly what you're doing? HAPI's server doesn't do any messaging out of the box so I'm having a bit of trouble picturing what this issue is..</p>\n<p>If you're just creating a resource and using the parser to serialize it, the ID shouldn't be removed. If you're posting it to <a href=\"http://fhirtest.uhn.ca\" target=\"_blank\" title=\"http://fhirtest.uhn.ca\">fhirtest.uhn.ca</a> though it is probably being treated as a transaction and not a message though, so placeholder ID rules would be applied. I may not be understanding what you're up to though. </p>",
        "id": 153818895,
        "sender_full_name": "James Agnew",
        "timestamp": 1459269668
    },
    {
        "content": "<p>@Patricia, no, it is not normal. The fhir messaging context is designed to utilize the <a href=\"http://MessageHeader.id\" target=\"_blank\" title=\"http://MessageHeader.id\">MessageHeader.id</a> in both the request and response as described in MessageHeader Identifiers section of the specification.  In addition, the very next section after that, Absence of Reliable Messaging - <a href=\"http://hl7-fhir.github.io/messaging.html#reliable\" target=\"_blank\" title=\"http://hl7-fhir.github.io/messaging.html#reliable\">http://hl7-fhir.github.io/messaging.html#reliable</a>, goes into further details and consequences regarding the use of both the <a href=\"http://Bundle.id\" target=\"_blank\" title=\"http://Bundle.id\">Bundle.id</a> and <a href=\"http://MessageHeader.id\" target=\"_blank\" title=\"http://MessageHeader.id\">MessageHeader.id</a>.</p>",
        "id": 153818896,
        "sender_full_name": "Richard Ettema",
        "timestamp": 1459269731
    },
    {
        "content": "<p>@Patricia, are you posting your message to the $process-message operation?  The FHIR DSTU2 specification re-defined the messaging interface to now use the $process-message operation.  The FHIR DSTU1 and earlier used 'mailbox'.</p>",
        "id": 153818898,
        "sender_full_name": "Richard Ettema",
        "timestamp": 1459270132
    },
    {
        "content": "<p>James' question is very appropriate.  It would help to understand what issue/problem you are attempting to solve/implement via the fhir messaging paradigm.  To make matters even more interesting, FHIR now has an Extended Operations framework or architecture - <a href=\"http://hl7-fhir.github.io/operations.html\" target=\"_blank\" title=\"http://hl7-fhir.github.io/operations.html\">http://hl7-fhir.github.io/operations.html</a> - that may be potential fit for what you wish to implement.</p>",
        "id": 153818899,
        "sender_full_name": "Richard Ettema",
        "timestamp": 1459271024
    },
    {
        "content": "<p>I'm using FHIR DSTU2 and the message is being posted to the $process-message operation. What I'm doing is to send the json message to a fhir server, which serializes the message to xml. That's when the ID is removed, since I did not replace the placeholder by anything. I can post the code if you need.</p>",
        "id": 153819063,
        "sender_full_name": "Patricia Alves",
        "timestamp": 1459336099
    },
    {
        "content": "<p>Can you describe this server more? Like, is this a server you wrote, or one of the public test servers? If it's a HAPI server of your own creation, it might be worth adding logging to see if the ID makes it in but is lost on the way out, or if it doesn't even make it in...</p>",
        "id": 153819088,
        "sender_full_name": "James Agnew",
        "timestamp": 1459347337
    },
    {
        "content": "<p>Sure and thank you very much for your time. It is a server written by us and we already had logging, and what happens is what you described: \"the ID makes it in but is lost on the way out...\" </p>",
        "id": 153819323,
        "sender_full_name": "Patricia Alves",
        "timestamp": 1459411693
    },
    {
        "content": "<p>Is the handler method in your server short enough you could paste it in? I'd love to see if I can reproduce this in a unit test...</p>",
        "id": 153819356,
        "sender_full_name": "James Agnew",
        "timestamp": 1459427105
    },
    {
        "content": "<p>It's not very short, but I can try to resume. I'll post in a moment.</p>",
        "id": 153819640,
        "sender_full_name": "Patricia Alves",
        "timestamp": 1459517261
    },
    {
        "content": "<p>Hi @James, sorry for the late answer, but I had some mandatory issues to solve. The ID is lost after parsing the resource (in the serialization-deserialization process): </p>\n<p>var parser = inboundFormat.toUpperCase() == \"XML\" ? ctx.newXmlParser(): ctx.newJsonParser();<br>\nvar hapiResource = parser.parseResource(Packages.ca.uhn.fhir.model.dstu2.resource.Bundle, msgString);  <br>\nvar x = parser.setPrettyPrint(true).encodeResourceToString(hapiResource);<br>\nlogger.debug(\"x-&gt; \" + x);</p>",
        "id": 153819953,
        "sender_full_name": "Patricia Alves",
        "timestamp": 1459849398
    },
    {
        "content": "<p>Does the ID remain in the Bundle.entry.fullUrl field? I just had a go at this with a unit test:</p>\n<div class=\"codehilite\"><pre>        <span class=\"n\">Patient</span> <span class=\"n\">p</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"n\">Patient</span><span class=\"o\">();</span>\n        <span class=\"n\">p</span><span class=\"o\">.</span><span class=\"na\">addName</span><span class=\"o\">().</span><span class=\"na\">addFamily</span><span class=\"o\">(</span><span class=\"s\">&quot;FAMILY&quot;</span><span class=\"o\">);</span>\n        <span class=\"n\">p</span><span class=\"o\">.</span><span class=\"na\">setId</span><span class=\"o\">(</span><span class=\"s\">&quot;urn:uuid:4f08cf3d-9f41-41bb-9e10-6e34c5b8f602&quot;</span><span class=\"o\">);</span>\n\n        <span class=\"n\">ca</span><span class=\"o\">.</span><span class=\"na\">uhn</span><span class=\"o\">.</span><span class=\"na\">fhir</span><span class=\"o\">.</span><span class=\"na\">model</span><span class=\"o\">.</span><span class=\"na\">dstu2</span><span class=\"o\">.</span><span class=\"na\">resource</span><span class=\"o\">.</span><span class=\"na\">Bundle</span> <span class=\"n\">b</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"n\">ca</span><span class=\"o\">.</span><span class=\"na\">uhn</span><span class=\"o\">.</span><span class=\"na\">fhir</span><span class=\"o\">.</span><span class=\"na\">model</span><span class=\"o\">.</span><span class=\"na\">dstu2</span><span class=\"o\">.</span><span class=\"na\">resource</span><span class=\"o\">.</span><span class=\"na\">Bundle</span><span class=\"o\">();</span>\n        <span class=\"n\">Entry</span> <span class=\"n\">be</span> <span class=\"o\">=</span> <span class=\"n\">b</span><span class=\"o\">.</span><span class=\"na\">addEntry</span><span class=\"o\">();</span>\n        <span class=\"n\">be</span><span class=\"o\">.</span><span class=\"na\">setResource</span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"o\">);</span>\n        <span class=\"n\">be</span><span class=\"o\">.</span><span class=\"na\">getRequest</span><span class=\"o\">().</span><span class=\"na\">setUrl</span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"o\">.</span><span class=\"na\">getId</span><span class=\"o\">().</span><span class=\"na\">getValue</span><span class=\"o\">());</span>\n\n        <span class=\"n\">String</span> <span class=\"n\">output</span> <span class=\"o\">=</span> <span class=\"n\">ourCtx</span><span class=\"o\">.</span><span class=\"na\">newXmlParser</span><span class=\"o\">().</span><span class=\"na\">setPrettyPrint</span><span class=\"o\">(</span><span class=\"kc\">true</span><span class=\"o\">).</span><span class=\"na\">encodeResourceToString</span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"o\">);</span>\n        <span class=\"n\">ourLog</span><span class=\"o\">.</span><span class=\"na\">info</span><span class=\"o\">(</span><span class=\"n\">output</span><span class=\"o\">);</span>\n\n        <span class=\"n\">ca</span><span class=\"o\">.</span><span class=\"na\">uhn</span><span class=\"o\">.</span><span class=\"na\">fhir</span><span class=\"o\">.</span><span class=\"na\">model</span><span class=\"o\">.</span><span class=\"na\">dstu2</span><span class=\"o\">.</span><span class=\"na\">resource</span><span class=\"o\">.</span><span class=\"na\">Bundle</span> <span class=\"n\">parsedBundle</span> <span class=\"o\">=</span> <span class=\"n\">ourCtx</span><span class=\"o\">.</span><span class=\"na\">newXmlParser</span><span class=\"o\">().</span><span class=\"na\">parseResource</span><span class=\"o\">(</span><span class=\"n\">ca</span><span class=\"o\">.</span><span class=\"na\">uhn</span><span class=\"o\">.</span><span class=\"na\">fhir</span><span class=\"o\">.</span><span class=\"na\">model</span><span class=\"o\">.</span><span class=\"na\">dstu2</span><span class=\"o\">.</span><span class=\"na\">resource</span><span class=\"o\">.</span><span class=\"na\">Bundle</span><span class=\"o\">.</span><span class=\"na\">class</span><span class=\"o\">,</span> <span class=\"n\">output</span><span class=\"o\">);</span>\n        <span class=\"n\">Entry</span> <span class=\"n\">parsedEntry</span> <span class=\"o\">=</span> <span class=\"n\">parsedBundle</span><span class=\"o\">.</span><span class=\"na\">getEntry</span><span class=\"o\">().</span><span class=\"na\">get</span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">);</span>\n\n        <span class=\"n\">assertEquals</span><span class=\"o\">(</span><span class=\"s\">&quot;urn:uuid:4f08cf3d-9f41-41bb-9e10-6e34c5b8f602&quot;</span><span class=\"o\">,</span> <span class=\"n\">parsedEntry</span><span class=\"o\">.</span><span class=\"na\">getRequest</span><span class=\"o\">().</span><span class=\"na\">getUrl</span><span class=\"o\">());</span>\n</pre></div>\n\n\n<p>and this passes. The parsed patient.getId().getValue() does not contain the UUIID though, which I think is confusing. The parser should be taking care of that, and possibly this is what's causing your issue. As a workaround until we get that fixed, can you grab the ID from <code>Bundle.entry.request.url</code>?</p>",
        "id": 153819957,
        "sender_full_name": "James Agnew",
        "timestamp": 1459853847
    },
    {
        "content": "<p>Yes, the Bundle.entry.fullUrl ID is maintained . The test you made was for the URL, can you please test for the <a href=\"http://resource.id\" target=\"_blank\" title=\"http://resource.id\">resource.id</a>? parsedEntry.getResource().getId().getValue(). It should be equal to 4f08cf3d-9f41-41bb-9e10-6e34c5b8f602. But if you check the prettyPrint for the parsedEntry it does not have that element (<a href=\"http://Patient.id\" target=\"_blank\" title=\"http://Patient.id\">Patient.id</a>).</p>",
        "id": 153819969,
        "sender_full_name": "Patricia Alves",
        "timestamp": 1459869340
    },
    {
        "content": "<p>Yeah, I added that test and it did indeed not pass. That is a bug in HAPI, or at least something that I would agree doesn't work the way it should.</p>\n<p>It is fixed in the latest trunk HAPI, so this will work the way you want in HAPI 1.5 which will be released with a week or so.</p>",
        "id": 153819993,
        "sender_full_name": "James Agnew",
        "timestamp": 1459882837
    },
    {
        "content": "<p>That's great! Thank you very much! =)</p>",
        "id": 153820032,
        "sender_full_name": "Patricia Alves",
        "timestamp": 1459940563
    }
]