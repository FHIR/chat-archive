[
    {
        "content": "<p>I feel there is a syntax error in the CompartmentDefinition example resource and the Compartment Patient page here: <a href=\"http://build.fhir.org/compartmentdefinition-patient.html\" target=\"_blank\" title=\"http://build.fhir.org/compartmentdefinition-patient.html\">http://build.fhir.org/compartmentdefinition-patient.html</a> . In both there is a search parameter referances which allows the AuditEvent resources to be in the Patient compartment, same issue exsits for the Provenance resource in Patient Compartment as well. Focusing on the AuditEvent case the search parameters given are <code>agent.patient</code> or <code>entity.patient</code>. These are chain syntax using the '.' yet I'm not confident that this was the intent. I question weather the intent was to have a parameter such as <code>agent:Patient</code> or <code>entity:Patient</code> where we are explicitly saying only references that are to a Patient resource in the Compartment. At present <code>agent.patient</code> or <code>entity.patient</code> is saying any resource this reference points to where that resource has a search parameter called 'patient' . So to summarise I am questioning should this  <code>agent.patient</code> or <code>entity.patient</code> actually be <code>agent:Patient</code> or <code>entity:Patient</code>? And I do realise that Compartment search parameters can be chain parameters, I'm asking is the use of a chaining parameter correct in these cases.</p>",
        "id": 153955324,
        "sender_full_name": "Angus Millar",
        "timestamp": 1525226571
    },
    {
        "content": "<p>Actualy I'm now begining to think the way it currently is in the spec is intended. This section from the chaining docuemntation is key, and also something I have never liked. <em>\"Advanced Search Note: Where a chained parameter searches a resource reference that may have more than one type of resource as its target, the parameter chain may end up referring to search parameters with the same name on more than one kind of resource at once. Servers SHOULD reject a search where the logical id refers to more than one matching resource across different types. For example, the client has to specify the type explicitly using the syntax in the second example above.\"</em> I've never liked this as it seamed like a vague form of matching. To that point in my server I forced that when the referance points to <em>n</em> resources the client MUST specify the type. Yet this has now come unstuck for me when it comes to Compartments. My problem to work on!</p>",
        "id": 153955329,
        "sender_full_name": "Angus Millar",
        "timestamp": 1525228772
    },
    {
        "content": "<p>I'm now back where I started and think this is this incorrect or at least not workable. If we have  a Patient Compartment and it is deemed that AuditEvent resources are in that Patient Compartment based on any of the following search parameters :</p>\n<p>Patient Compartment AuditEvent search parameters:<br>\n<code> - patient      : acts on ResourceTypes: (Patient) \n - agent.patient :  acts on ResourceTypes: (Practitioner, Organization, Device, Patient, RelatedPerson) \n - entity.patient:  acts on ResourceTypes: (Any)</code></p>\n<p>Given this, I would say that it is highly likely that a Patient would have AuditEvents for more than a single one of the allowed Resource Types. For instance, 'AuditEvent.entity.patient' is a reference to a resource involved in the audited event where that resource has a 'patient' search parameter, and it can reference any resource type. That is 28 resource in total with the patient parameter. </p>\n<p>If I am trying to get all AuditEvent resource for a given Patient compartment then it would only take two AuditEvent resources across all instances of the 28 types to have a reference to the same patient compartment resource id, and if so,  the search is to be rejected based on the  Advanced Search Note for Chaining, as quoted in the comment above. </p>\n<p>So as an example, if I have an AuditEvent resource pointing to a DiagnosticReport resource as its entity, and also another AuditEvent resource pointing to an Observation resource as its entity, and both have the same patient, then the search is to be rejected based on the rule. I would have thought this happens 80% of the time if not more.<br>\nI would have thought the resolution to this is that all 28 'entity' search parameters should be explicitly stated in the compartments search parameters. like this:<br>\n<code>\n entity:DiagnosticReport.patient\n entity:Observation.patient\n entity:Encounter.patient\n entity:Procedure.patient</code></p>\n<p>...etc for all 28 possible, in fact, the same need to occur for any chained parameter in a CompartmentDefinition where that parameter has more than a single possible ResourceType.</p>",
        "id": 153955364,
        "sender_full_name": "Angus Millar",
        "timestamp": 1525253142
    },
    {
        "content": "<p>well, it was intended to be chain search. It's trying to say something simple; an audit event falls into a patient compartment if it's an audit on a resource about the patient</p>",
        "id": 153956103,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1525495468
    }
]