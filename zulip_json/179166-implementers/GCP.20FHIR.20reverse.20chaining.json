[
    {
        "content": "<p>Hi all,<br>\nI'm working with GCP FHIR API and got some problems with reverse chaining.<br>\nI try to get resource ServiceRequest which has a relationship with Observation via <code>Observation.basedOn</code> field. <br>\nThe query will like:</p>\n<div class=\"codehilite\"><pre><span></span><code>POST &lt;based URL&gt;/ServiceRequest/_search?_has:Observation:based-on:status=final\n</code></pre></div>\n<p>My total Observation resource: 161 records. But Observation resources which have field <code>based-on = ServiceRequest/{id}</code> is only 5.<br>\nThat means if I search from ServiceRequest and reverse chaining to Observation, I'll get correct Observation data (5 records) without errors message.</p>\n<p>Expect-result: 5 records</p>\n<p>Actual result: error message:</p>\n<div class=\"codehilite\"><pre><span></span><code>{\n    &quot;issue&quot;: [\n        {\n            &quot;code&quot;: &quot;value&quot;,\n            &quot;details&quot;: {\n                &quot;text&quot;: &quot;invalid_query&quot;\n            },\n            &quot;diagnostics&quot;: &quot;_has search failed: inner query on resource type &#39;Observation&#39;, search parameter &#39;status&#39; returned too many results to expand (&gt;100)&quot;,\n            &quot;severity&quot;: &quot;error&quot;\n        }\n    ],\n    &quot;resourceType&quot;: &quot;OperationOutcome&quot;\n}\n</code></pre></div>",
        "id": 228549298,
        "sender_full_name": "Hue Nguyen",
        "timestamp": 1614757250
    },
    {
        "content": "<p>My image about the above query like this: <br>\nFetch resource ServiceRequest that have an Observation where observation has a relationship with ServiceRequest (via based-on)[1] and have status=final [2].  [1] and [2] are <code>AND condition</code>, that means result is 5.</p>\n<p>But seem like [1] and [2] are not <code>AND condition</code>, I think [2] is applied first and  [1] is applied into [2] result. So, errors happen.</p>\n<p><span class=\"user-mention\" data-user-id=\"197072\">@Paul Church</span> do you have any idea about this problem?</p>",
        "id": 228554616,
        "sender_full_name": "Hue Nguyen",
        "timestamp": 1614760395
    },
    {
        "content": "<p>This is expected - the core limitation in our chain/reverse-chain implementation is that the inner query return &lt;100 results. In this case the inner query is Observation?status=final which I assume has 161 results in this case.</p>",
        "id": 228679897,
        "sender_full_name": "Paul Church",
        "timestamp": 1614810346
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"197072\">@Paul Church</span> </p>\n<blockquote>\n<p>My image about the above query like this:<br>\nFetch resource ServiceRequest that have an Observation where observation has a relationship with ServiceRequest (via based-on)[1] and have status=final [2]. [1] and [2] are AND condition, that means the result is 5.</p>\n</blockquote>\n<p>Is this correct imagination?</p>",
        "id": 228737542,
        "sender_full_name": "Hue Nguyen",
        "timestamp": 1614848471
    },
    {
        "content": "<p>No, this is more like a join than an AND condition. It selects on status=final and then joins that result set against ServiceRequests using based-on.</p>",
        "id": 228827867,
        "sender_full_name": "Paul Church",
        "timestamp": 1614883540
    },
    {
        "content": "<p>I see, Do you have any idea for me how to handle it? I asked the supporter of GCP, but they give me the solution is using BigQuery, but our customer doesn't want to use Bigquery.</p>",
        "id": 228885594,
        "sender_full_name": "Hue Nguyen",
        "timestamp": 1614910322
    },
    {
        "content": "<p>I try add more condition into query</p>\n<blockquote>\n<p>POST &lt;based URL&gt;/ServiceRequest/_search?_has:Observation:based-on:status=final&amp;_has:Observation:based-on:code=implement</p>\n</blockquote>\n<p>But same error cause it's not  AND condition. I wonder that can we do something like a composite field?</p>",
        "id": 228885864,
        "sender_full_name": "Hue Nguyen",
        "timestamp": 1614910492
    }
]