[
    {
        "content": "<p>Starting work to update my implementation guide for STU3.  Does anyone know if there is a way to profile an element that is defined as a reference to another structure?<br>\nFrom <a href=\"http://wiki.hl7.org/?title=FHIR_Spreadsheet_Profile_Authoring\" target=\"_blank\" title=\"http://wiki.hl7.org/?title=FHIR_Spreadsheet_Profile_Authoring\">http://wiki.hl7.org/?title=FHIR_Spreadsheet_Profile_Authoring</a> :</p>\n<div class=\"codehilite\"><pre>For complex structures (which includes profiled simple structures with nested elements):\n\n You can say &quot;@some.complex.element.path&quot; or &quot;@[Element Profile Name]&quot; to say that the type for the element should be a complex structure already defined elsewhere within the resource.\n</pre></div>",
        "id": 153879911,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490638590
    },
    {
        "content": "<p>Example:  PlanDefinition.action.action  (defined as type '@PlanDefinition.action' in plandefinition-spreadsheet.xml of the spec)</p>",
        "id": 153879912,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490638758
    },
    {
        "content": "<p>are you looking for ElementDefinition.type.targetProfile?</p>",
        "id": 153879927,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1490641779
    },
    {
        "content": "<p>possibly; i'm not familiar with that one and so i'll go look now.  in the meantime, i just committed my stripped down sample in case you/anyone interested would like to help crack this nut (sent the same sample to <span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span> a while ago but I don't think he's had chance to look into it yet)</p>",
        "id": 153879935,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490642540
    },
    {
        "content": "<p><a href=\"https://github.com/lmsurpre/plandefinition-profile-example\" target=\"_blank\" title=\"https://github.com/lmsurpre/plandefinition-profile-example\">https://github.com/lmsurpre/plandefinition-profile-example</a></p>",
        "id": 153879936,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490642546
    },
    {
        "content": "<p>so far i've tried a bunch of stuff, but I included in that sample what I felt to be the most promising two ways:<br>\n1. as a single structure where i include the subelements of the complex element i'm trying to profile (singleStructure)<br>\n2. tried to define a separate structure based on PlanDefinition.action for the profile of PlanDefinition.action.action</p>\n<p>#1 is complaining that my differential doesn't match my snapshot (which makes sense since the sub-element isn't repeated in the snapshot)</p>\n<p>#2 is giving me this:</p>",
        "id": 153879941,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490643188
    },
    {
        "content": "<div class=\"codehilite\"><pre>java.lang.Exception: exception parsing pack /Users/lmsurpre/svn/fhir/NCCN-simple/resources/plandefinition-order-template-simple-spreadsheet-split: Unhandled case\n    at org.hl7.fhir.igtools.spreadsheets.IgSpreadsheetParser.parse(IgSpreadsheetParser.java:204)\n    at org.hl7.fhir.igtools.publisher.Publisher.loadSpreadsheet(Publisher.java:1247)\n    at org.hl7.fhir.igtools.publisher.Publisher.loadSpreadsheets(Publisher.java:1231)\n    at org.hl7.fhir.igtools.publisher.Publisher.load(Publisher.java:1040)\n    at org.hl7.fhir.igtools.publisher.Publisher.execute(Publisher.java:268)\n    at org.hl7.fhir.igtools.publisher.Publisher.main(Publisher.java:3263)\nCaused by: java.lang.Exception: Unhandled case\n    at org.hl7.fhir.igtools.spreadsheets.TypeParser.parse(TypeParser.java:107)\n    at org.hl7.fhir.igtools.spreadsheets.TypeParser.parse(TypeParser.java:46)\n    at org.hl7.fhir.igtools.spreadsheets.IgSpreadsheetParser.processLine(IgSpreadsheetParser.java:751)\n    at org.hl7.fhir.igtools.spreadsheets.IgSpreadsheetParser.parseProfileSheet(IgSpreadsheetParser.java:268)\n    at org.hl7.fhir.igtools.spreadsheets.IgSpreadsheetParser.parse(IgSpreadsheetParser.java:178)\n</pre></div>",
        "id": 153879942,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490643195
    },
    {
        "content": "<p>I tried using this syntax in the 'Type' column:  \"{#subtask}\"  (based on my reading of <a href=\"http://wiki.hl7.org/index.php?title=FHIR_Spreadsheet_Authoring#Element_Definition_Columns\" target=\"_blank\" title=\"http://wiki.hl7.org/index.php?title=FHIR_Spreadsheet_Authoring#Element_Definition_Columns\">http://wiki.hl7.org/index.php?title=FHIR_Spreadsheet_Authoring#Element_Definition_Columns</a> )</p>",
        "id": 153879944,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490643271
    },
    {
        "content": "<p>did some more reading and I don't think ElementDefinition.type.targetProfile is right.  That seems to be about elements of type Reference.  what I was trying to ask is whether its possible to profile elements that are defined by a 'contentReference'</p>",
        "id": 153879950,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490648910
    },
    {
        "content": "<p>per eld-5, if the element definition has a contentReference, it cannot have type.  so i guess the question i have is whether there existing anything like a profile or targetProfile for a contentReference</p>",
        "id": 153879951,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490648988
    },
    {
        "content": "<p>if not, i'm thinking i need to redo all my constraints as invariants which i'd rather not do</p>",
        "id": 153879952,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490649048
    },
    {
        "content": "<p>i want to say things like \"PlanDefinition.action must have one or more subaction and those subactions must have codes like x, y, z, etc\"</p>",
        "id": 153879953,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490649097
    },
    {
        "content": "<p>so there's no way to profile a content reference because you should just unroll the content reference and go ahead and make rules about it </p>",
        "id": 153879954,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1490649414
    },
    {
        "content": "<p>.e.g replace the content reference with the content being referred to </p>",
        "id": 153879955,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1490649423
    },
    {
        "content": "<p>cool, that is why i tried first.  but the spreadsheet tooling doesn't seem to handle that when it generates the snapshot (i.e. the differential lists the extra elements but that doesn't match the snapshot)</p>",
        "id": 153879963,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490649966
    },
    {
        "content": "<p>is this a place where the differential is allowed to differ from the snapshot?   or do i need to scrap the tooling and do snapshot by hand?</p>",
        "id": 153879964,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490649991
    },
    {
        "content": "<p>FWIW the only other example of a profiled contentReference i could find was <a href=\"http://build.fhir.org/consentdirective.html\" target=\"_blank\" title=\"http://build.fhir.org/consentdirective.html\">http://build.fhir.org/consentdirective.html</a> and it seems broken there too:<br>\n<a href=\"/user_uploads/10155/qvXFb_K62HO2Ulk1XZxdcVVZ/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a> </p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/qvXFb_K62HO2Ulk1XZxdcVVZ/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\"><img src=\"/user_uploads/10155/qvXFb_K62HO2Ulk1XZxdcVVZ/pasted_image.png\"></a></div>",
        "id": 153879965,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490650517
    },
    {
        "content": "<p>I think if 'action' was defined as its own re-usable Type  (e.g. like 'Dosage') then I could create a profile for it a lot easier.  any advantage to using this 'contentReference' thing over something like that?  ...doesn't seem to be very widely used</p>",
        "id": 153879966,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490650679
    },
    {
        "content": "<p>don't know. let me investigate</p>",
        "id": 153879971,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1490651510
    },
    {
        "content": "<p>I need to debug - can you send me an example?</p>",
        "id": 153879996,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1490662139
    },
    {
        "content": "<p>hi graham, i tried to provide an example at <a href=\"https://github.com/lmsurpre/plandefinition-profile-example\" target=\"_blank\" title=\"https://github.com/lmsurpre/plandefinition-profile-example\">https://github.com/lmsurpre/plandefinition-profile-example</a></p>",
        "id": 153880002,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490666443
    },
    {
        "content": "<p>as mentioned above this version currently fails with the following error:</p>\n<div class=\"codehilite\"><pre>java.lang.Exception: Exception loading http://example.org/fhir/StructureDefinition/order-template: Snapshot for http://example.org/fhir/StructureDefinition/order-template does not contain differential element with id: PlanDefinition:ordertemplate.action.action:subtask.label\n    at org.hl7.fhir.igtools.publisher.Publisher.load(Publisher.java:1559)\n    at org.hl7.fhir.igtools.publisher.Publisher.loadConformance(Publisher.java:1323)\n    at org.hl7.fhir.igtools.publisher.Publisher.execute(Publisher.java:272)\n    at org.hl7.fhir.igtools.publisher.Publisher.main(Publisher.java:3263)\nCaused by: org.hl7.fhir.exceptions.DefinitionException: Snapshot for http://example.org/fhir/StructureDefinition/order-template does not contain differential element with id: PlanDefinition:ordertemplate.action.action:subtask.label\n    at org.hl7.fhir.dstu3.conformance.ProfileUtilities.generateSnapshot(ProfileUtilities.java:351)\n    at org.hl7.fhir.dstu3.context.SimpleWorkerContext.seeProfile(SimpleWorkerContext.java:263)\n    at org.hl7.fhir.dstu3.context.SimpleWorkerContext.seeResource(SimpleWorkerContext.java:213)\n    at org.hl7.fhir.igtools.publisher.Publisher.load(Publisher.java:1557)\n    ... 3 more\n</pre></div>",
        "id": 153880003,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490666846
    },
    {
        "content": "<p>if i remove the offending row from the spreadsheet then it produces a StructureDefinition like this:  <a href=\"/user_uploads/10155/6XDMJSqvvJ7_6ODWz2lsJo3P/StructureDefinition-order-template.xml\" target=\"_blank\" title=\"StructureDefinition-order-template.xml\">StructureDefinition-order-template.xml</a></p>",
        "id": 153880004,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490666936
    },
    {
        "content": "<p>in this example, I am trying to specify the cardinality of a property (label) of the PlanDefinition.action.action  ...any tips/pointers much appreciated</p>",
        "id": 153880005,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490666997
    },
    {
        "content": "<p>can make a gForge task for this please</p>",
        "id": 153880007,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1490671477
    },
    {
        "content": "<p>yes, will do now</p>",
        "id": 153880008,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490671563
    },
    {
        "content": "<p>thanks</p>",
        "id": 153880010,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1490671577
    },
    {
        "content": "<p>in single structure?</p>",
        "id": 153880011,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1490671658
    },
    {
        "content": "<p>basically i've tried a bunch of things hoping something would stick.  in single structure i tried to just list the extra elements (unwrap the contentReference as you say)</p>",
        "id": 153880012,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490671778
    },
    {
        "content": "<p>in my other version (which i call the 'split' version), i tried to define a separate structure just to profile PlanDefinition.action -- but I couldn't seem to make that work either (i think it has to be its own standalone resource/datatype to allow that?)</p>",
        "id": 153880013,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490671826
    },
    {
        "content": "<p>opened <a href=\"http://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=13139\" target=\"_blank\" title=\"http://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=13139\">http://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=13139</a></p>",
        "id": 153880015,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490672102
    },
    {
        "content": "<p>ok, so this one: <a href=\"/user_uploads/10155/wmb8zKQLrDEKV5fPuqriIsXF/test-ig-lee.xml\" target=\"_blank\" title=\"test-ig-lee.xml\">test-ig-lee.xml</a> </p>",
        "id": 153880017,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1490672691
    },
    {
        "content": "<p>that's correct for slicing action at the root level. </p>",
        "id": 153880018,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1490672703
    },
    {
        "content": "<p>with a discriminator of label (which is pretty crappy, but valid and sufficient for our purpose now)</p>",
        "id": 153880019,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1490672735
    },
    {
        "content": "<p>can you check that and tell me whether it makes sense, and I'll look at slicing the next level</p>",
        "id": 153880020,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1490672758
    },
    {
        "content": "<p>This one: <a href=\"/user_uploads/10155/8-z7QIKo4KSsqokEyCYlwIHf/test-ig-lee.xml\" target=\"_blank\" title=\"test-ig-lee.xml\">test-ig-lee.xml</a> - it works now</p>",
        "id": 153880033,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1490681528
    },
    {
        "content": "<p>Sorry, just getting back to this now (I tried it right away but it seemed I needed to wait for the new ig publisher jar and fhir build was broken at that time)</p>",
        "id": 153880422,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490900130
    },
    {
        "content": "<p>after downloading the latest jar from <a href=\"http://build.fhir.org/downloads\" target=\"_blank\" title=\"http://build.fhir.org/downloads\">http://build.fhir.org/downloads</a>, I confirm it builds for me.  in my case, I don't even think I need the slicing (because each sub-action at a specific level will be the same), and it worked there as well</p>",
        "id": 153880426,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490900610
    },
    {
        "content": "<p>one thing i noticed is that when slicing is used, the snapshot still contains this ugly 'Unknown reference to #PlanDefinition.ordertemplate.action' text<br>\n<a href=\"/user_uploads/10155/YY217A6P9QtaG3wSoNp1Lytf/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a> </p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/YY217A6P9QtaG3wSoNp1Lytf/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\"><img src=\"/user_uploads/10155/YY217A6P9QtaG3wSoNp1Lytf/pasted_image.png\"></a></div>",
        "id": 153880427,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490900668
    },
    {
        "content": "<p>hmm. I will investigate</p>",
        "id": 153880428,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1490900696
    },
    {
        "content": "<p>in my version without slicing, i don't see that</p>",
        "id": 153880429,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490900716
    },
    {
        "content": "<p>however, i just tried adding a third level (a sub-sub-action) and this is where things got interesting...  the jar seems to be stuck (maybe a endless loop somewhere due to the recursive nature of this)?</p>",
        "id": 153880432,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490900773
    },
    {
        "content": "<p>i will deliver this updated sample to that github project in case you find some time to look</p>",
        "id": 153880433,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490900796
    },
    {
        "content": "<p>i havn't tried the 3rd level with slicing yet (i assume it will be the same story)</p>",
        "id": 153880434,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1490900815
    }
]