[
    {
        "content": "<p>Hi all,</p>\n<p>I'm currently working on drafting a FHIR document which has couple of sections and each section contains multiple named entries. To achieve this, I've done slicing on both the sections and entries. the section slices are done on the 'code' and is working fine. However, the slicing on the entries (Composition.section.entry()) are not working. I' getting the following types of error while validating the sample using the IG publisher. I've tried the following options and getting the errors as provided in the section below: </p>\n<p>I'm getting \"Profile based discriminators nust have a type with a profile (Reference.reference)\" error if I am doing profile reference based discriminators <br>\n Here is the snippet from the SD:<br>\n\"slicing\": {<br>\n          \"discriminator\": [<br>\n            {<br>\n              \"type\": \"profile\",<br>\n              \"path\": \"reference\"<br>\n            }<br>\n          ],<br>\n          \"rules\": \"closed\"<br>\n        }</p>\n<p>I'm getting \"This element does not match any known slice for profile ... and slicing is CLOSED\" if I'm using the profile resolve() based discriminators <br>\nHere is the Snippet from the SD:<br>\n \"slicing\": {<br>\n          \"discriminator\": [<br>\n            {<br>\n              \"type\": \"profile\",<br>\n              \"path\": \"resolve()\"<br>\n            }<br>\n          ],<br>\n          \"rules\": \"closed\"</p>\n<p>Here is the snippet from the Sample:</p>\n<p>\"section\": [<br>\n          {<br>\n            \"title\": \"Other health conditions\",<br>\n            \"code\": {<br>\n              \"coding\": [<br>\n                {<br>\n                  \"system\": \"<a href=\"http://loinc.org\" target=\"_blank\" title=\"http://loinc.org\">http://loinc.org</a>\",<br>\n                  \"code\": \"86674-9\"<br>\n                }<br>\n              ]<br>\n            },<br>\n            \"text\": {<br>\n              \"status\": \"additional\",<br>\n              \"div\": \"&lt;div xmlns=\\\"http://www.w3.org/1999/xhtml\\\"&gt;Other health conditions&lt;/div&gt;\"<br>\n            },<br>\n            \"entry\": [<br>\n              {<br>\n                \"reference\": \"Observation/541a72a8-df75-4484-ac89-ac4923f03b81\"<br>\n              }<br>\n            ]<br>\n          }<br>\n        ]</p>\n<p>In the \"Observation/541a72a8-df75-4484-ac89-ac4923f03b81\" instance, I've provided the resource profile in the \"meta' tag (which matches with the targetProfile as provided in the SD). </p>\n<p>It will be extremely helpful if the community can provide me suggestion about what I'm missing in the above implementation or any alternative solution.</p>",
        "id": 158931522,
        "sender_full_name": "Shovan Roy",
        "timestamp": 1550620609
    },
    {
        "content": "<p>Slicing by profile isn't generally supported by the validator</p>",
        "id": 158934735,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1550624041
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> .<br>\n I was trying the profile based approach as per the guideline provided in <a href=\"https://www.hl7.org/fhir/profiling.html\" target=\"_blank\" title=\"https://www.hl7.org/fhir/profiling.html\">https://www.hl7.org/fhir/profiling.html</a>.  I was more interested to use it since the guidelines says: \"profile - Used to match slices based on the whether the item conforms to the specified profile. This provides the most power, since the full range of profiling capabilities are available, but it is also the hardest to implement, and requires the most processing (&gt;1000-fold compared to the others). Implementers should use this only where absolutely required. Typical example: slice on the type of Composition.section.entry() for the profiles Current-Clinical-Condition, Past-Medical-Event, etc\"</p>\n<p>Happy to change it. My objective is to ensure that the slicing on the entries works. May I request you to guide me an alternative approach to slice the entries which works with the validator?</p>",
        "id": 158937433,
        "sender_full_name": "Shovan Roy",
        "timestamp": 1550626816
    },
    {
        "content": "<p>I understand the desire, but it turns out to be hard to implement.  If you can slice on the type of the target resource or an element (e.g. code) in the target resource</p>",
        "id": 158944414,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1550635700
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span>  So, I believe we should be able to slice on the value of meta.profile in the resource referenced by Composition.section.entry?  In the IPS IG we've tried a variety of approaches to do this using resolve(), but we haven't been able to get it to work yet.  Any help working through the details and figuring out either what we've been doing wrong or what's not (yet) supported by the validator (or both) would be great.</p>",
        "id": 158985451,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1550676832
    },
    {
        "content": "<p>You can't count on meta.profile being declared - and the validator doesn't assume it'll be there.</p>",
        "id": 158988641,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1550678848
    },
    {
        "content": "<p>But if you want to force its inclusion, then yes you could slice on that value.</p>",
        "id": 158988674,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1550678872
    },
    {
        "content": "<p>We don't want to force it, but it seems that this may be our only choice if we want it to work?  But we still haven't been able to make that work.</p>",
        "id": 158990052,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1550679793
    },
    {
        "content": "<p>So any help in making even that work would be a step forward.</p>",
        "id": 158990128,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1550679845
    },
    {
        "content": "<p>Although on our IPS call just now I think we've decided to relax the approach to use only a reference choice and not require slicing on the entry, as it's appearing likely that we aren't going to have the tooling support needed to really make that work.</p>",
        "id": 158993877,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1550682906
    },
    {
        "content": "<p>I've tried multiple options and unfortunately unable to make any of them working. I used, type - resolve(), type - $this,  data- id etc.  I've even tried meta.profile but no luck. <br>\n It seems entry slicing is not working at all.  I guess an alternative option could be not to slice the entry but include all the different profiles as entry reference and provide invariant. However that may become unmanageable when the number of  profiles to be included in  a sections become 20+ like what we have.  <br>\nIt will be extremely helpful if we get a working position on how entry slicing works.</p>",
        "id": 159016414,
        "sender_full_name": "Shovan Roy",
        "timestamp": 1550697994
    },
    {
        "content": "<p>Problem Summary: Multiple Composition section entry profile (of same resource type) reference choice is not working. It seems validator is caching the first profile of a particular resource type and applying it to all instances of that section. </p>\n<p>Details:<br>\nAs mentioned in the above post, I have been working on drafting a FHIR profiles. The Objective is to construct a FHIR document which contains the followings:</p>\n<p>1. Two Sections : Vital Sign and Other health conditions<br>\n2. Vital Sign Section consists of the following allowed entries:<br>\n        1. Body Weight (1..1)<br>\n        2. Body Height (1..1)<br>\n        3. Head Circum (1..1)<br>\n        4. BMI (0..1)<br>\n3. Other Assessment Details Contains multiple (~25) Observation profiles.</p>\n<p>Initially I tried to achieve the above using Composition.section.entry slicing. However that didn't work (please see the post history for more details).</p>\n<p>As an alternative approach, I've chosen entry reference and added allowed entries as references in the target profile.  For an example, in the Vital Sign Section I have listed down the following profiles as the entry target profile:<br>\n<a href=\"http://hl7.org.au/fhir/ch/v1/StructureDefinition/ncdhc-observation-vitalsign-bodyweight\" target=\"_blank\" title=\"http://hl7.org.au/fhir/ch/v1/StructureDefinition/ncdhc-observation-vitalsign-bodyweight\">http://hl7.org.au/fhir/ch/v1/StructureDefinition/ncdhc-observation-vitalsign-bodyweight</a><br>\n<a href=\"http://hl7.org.au/fhir/ch/v1/StructureDefinition/ncdhc-observation-vitalsign-bodyheight\" target=\"_blank\" title=\"http://hl7.org.au/fhir/ch/v1/StructureDefinition/ncdhc-observation-vitalsign-bodyheight\">http://hl7.org.au/fhir/ch/v1/StructureDefinition/ncdhc-observation-vitalsign-bodyheight</a><br>\n<a href=\"http://hl7.org.au/fhir/ch/v1/StructureDefinition/ncdhc-observation-vitalsign-headcircum\" target=\"_blank\" title=\"http://hl7.org.au/fhir/ch/v1/StructureDefinition/ncdhc-observation-vitalsign-headcircum\">http://hl7.org.au/fhir/ch/v1/StructureDefinition/ncdhc-observation-vitalsign-headcircum</a><br>\n<a href=\"http://hl7.org.au/fhir/ch/v1/StructureDefinition/ncdhc-observation-vitalsign-bmi\" target=\"_blank\" title=\"http://hl7.org.au/fhir/ch/v1/StructureDefinition/ncdhc-observation-vitalsign-bmi\">http://hl7.org.au/fhir/ch/v1/StructureDefinition/ncdhc-observation-vitalsign-bmi</a></p>\n<p>I've added a sample which consists of Body Weight and BMI entries. However it looks like the validator is applying only the first entry profile reference on the referenced entries. In this case the validator is applying the bodyweight profile on the both the Body Weight and BMI entry in the Bundle and coming back with errors on the BMI entry. I tried with multiple other combinations and found the similar behaviour. It seems the validator is caching the first resource type profile reference only (I may be wrong).</p>\n<p>This has become a blocker for us now. <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> , <span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span>  may I request you to suggest me if I'm doing anything wrong in my profile? Is there any alternative solution/approach to achieve the above objective?</p>\n<p><span class=\"user-mention\" data-user-id=\"191368\">@Brett Esler</span> , <span class=\"user-mention\" data-user-id=\"192174\">@Danielle Tavares</span> , <span class=\"user-mention\" data-user-id=\"191682\">@Richard Townley-O'Neill</span>  fyi..</p>\n<p>Here is the details of the profile and sample I've used: </p>\n<p>Profile: <a href=\"http://build.fhir.org/ig/hl7au/au-fhir-childhealth/StructureDefinition-ncdhc-composition-health-check-assessment.html\" target=\"_blank\" title=\"http://build.fhir.org/ig/hl7au/au-fhir-childhealth/StructureDefinition-ncdhc-composition-health-check-assessment.html\">http://build.fhir.org/ig/hl7au/au-fhir-childhealth/StructureDefinition-ncdhc-composition-health-check-assessment.html</a> <br>\nGit Hub: <a href=\"https://github.com/hl7au/au-fhir-childhealth/blob/master/resources/structuredefinition-ncdhc-composition-health-check-assessment.json\" target=\"_blank\" title=\"https://github.com/hl7au/au-fhir-childhealth/blob/master/resources/structuredefinition-ncdhc-composition-health-check-assessment.json\">https://github.com/hl7au/au-fhir-childhealth/blob/master/resources/structuredefinition-ncdhc-composition-health-check-assessment.json</a><br>\nSample: <a href=\"http://build.fhir.org/ig/hl7au/au-fhir-childhealth/Bundle-28900024-070c-4141-8109-9d9fa34dd24b.json.html\" target=\"_blank\" title=\"http://build.fhir.org/ig/hl7au/au-fhir-childhealth/Bundle-28900024-070c-4141-8109-9d9fa34dd24b.json.html\">http://build.fhir.org/ig/hl7au/au-fhir-childhealth/Bundle-28900024-070c-4141-8109-9d9fa34dd24b.json.html</a><br>\nGitHub: <a href=\"https://github.com/hl7au/au-fhir-childhealth/blob/master/examples/Bundle-document-healthcheck-response-payload.json\" target=\"_blank\" title=\"https://github.com/hl7au/au-fhir-childhealth/blob/master/examples/Bundle-document-healthcheck-response-payload.json\">https://github.com/hl7au/au-fhir-childhealth/blob/master/examples/Bundle-document-healthcheck-response-payload.json</a></p>\n<p>Error page: <a href=\"http://build.fhir.org/ig/hl7au/au-fhir-childhealth/qa.html\" target=\"_blank\" title=\"http://build.fhir.org/ig/hl7au/au-fhir-childhealth/qa.html\">http://build.fhir.org/ig/hl7au/au-fhir-childhealth/qa.html</a> search Bundle-document-healthcheck-response-payload</p>",
        "id": 159482103,
        "sender_full_name": "Shovan Roy",
        "timestamp": 1551242285
    },
    {
        "content": "<p>This seems pretty similar to where we've landed and the issues that we've encountered with slicing Composition.section and attempting to slice Composition.section.entry in IPS.  Agree that a fully functional solution for this is needed.</p>",
        "id": 159507783,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1551272525
    },
    {
        "content": "<p>ok..np.. would it be possible for you to have a look at it today. sorry to bother you on this.. it has now become a burning issue for us and trying to find out a workaround.</p>",
        "id": 159654170,
        "sender_full_name": "Shovan Roy",
        "timestamp": 1551389532
    },
    {
        "content": "<p>Is there an IG I can grab of Github that has all of the relevant files?</p>",
        "id": 159661870,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1551395724
    },
    {
        "content": "<p>The Github location is : <a href=\"https://github.com/hl7au/au-fhir-childhealth\" target=\"_blank\" title=\"https://github.com/hl7au/au-fhir-childhealth\">https://github.com/hl7au/au-fhir-childhealth</a></p>",
        "id": 159662885,
        "sender_full_name": "Shovan Roy",
        "timestamp": 1551396711
    },
    {
        "content": "<p>all the relevant files are available in the resource directory..  the above mentioned  issue is with the <a href=\"http://build.fhir.org/ig/hl7au/au-fhir-childhealth/StructureDefinition-ncdhc-composition-health-check-assessment.html\" target=\"_blank\" title=\"http://build.fhir.org/ig/hl7au/au-fhir-childhealth/StructureDefinition-ncdhc-composition-health-check-assessment.html\">http://build.fhir.org/ig/hl7au/au-fhir-childhealth/StructureDefinition-ncdhc-composition-health-check-assessment.html</a> profile .. please let me know if you need any other details</p>",
        "id": 159663020,
        "sender_full_name": "Shovan Roy",
        "timestamp": 1551396840
    },
    {
        "content": "<p>HI Lloyd.. thanks for looking into it.. let me know if you need any further details. The GitHub location of the profile is:  <a href=\"https://github.com/hl7au/au-fhir-childhealth/blob/master/resources/structuredefinition-ncdhc-composition-health-check-assessment.json\" target=\"_blank\" title=\"https://github.com/hl7au/au-fhir-childhealth/blob/master/resources/structuredefinition-ncdhc-composition-health-check-assessment.json\">https://github.com/hl7au/au-fhir-childhealth/blob/master/resources/structuredefinition-ncdhc-composition-health-check-assessment.json</a></p>",
        "id": 159665887,
        "sender_full_name": "Shovan Roy",
        "timestamp": 1551399240
    },
    {
        "content": "<p>That's quite the IG.  My PC's had its CPU pinned for 15 minutes just checking the hyperlinks...  Have you considered splitting it?</p>",
        "id": 159675269,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1551410524
    },
    {
        "content": "<p>In the slice definition, you're setting Composition.section.entry to max=0, but in your slices you're trying to override it to other values.  That's not legal.  <br>\nAlso, why are you using a fixed value for code instead of a pattern?  Fixed value is going to prevent translations, display names and other stuff which is all bad practice.</p>",
        "id": 159675708,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1551411213
    },
    {
        "content": "<p>The IGPublisher seems to be hung.  Can you send me the igpack it produces when generation completes?</p>",
        "id": 159675756,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1551411260
    }
]