[
    {
        "content": "<p>I'm confused by how prefixes work for numbers in the search.</p>\n<p>Is it correct that value \"1.9\" is \"gt1.91\"? The range of the value \"1.9\" would be [1.85, 1.95], which overlaps with the \"above\" range of \"1.91\", which is [1.91, +inf).</p>\n<p>It sort of awkward that any number would be \"greater than\" itself, as the range \"above\" it will always overlap with the range of the number itself, given the definition of the \"above\" range.</p>\n<p>Or maybe I'm mistaken and the \"above\" range should actually be [1.915, +inf) for the \"1.91\" rather than [1.91, +inf)?</p>\n<p>So, basically, which one is correct for the ranges \"below\" and \"above\":<br>\n1) (-inf, value] and [value, +inf) <br>\nor<br>\n2) (-inf, low_value] and [high_value, +inf)<br>\n?<br>\n(where \"low_value\" and \"high_value\" are computed by subtracting/adding 0.(n0)5, where \"(n0)\" is the right amount of zeroes according to the number scale)</p>",
        "id": 153944644,
        "sender_full_name": "Ivan Dubrov",
        "timestamp": 1521000570
    },
    {
        "content": "<p>\"Note: Uncertainty does not factor in evaluations. The precision of the numbers is considered arbitrarily high. (The way search parameters operate in resources is not the same as whether two numbers are equal to each other in a mathematical sense).\"</p>",
        "id": 153944645,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1521000920
    },
    {
        "content": "<p>I've read that many times, but still cannot quite grasp it. I understand the part about mathematical sense, sure, but I don't really understand the part \"uncertainty does not factor in evaluations\".</p>\n<p>Similarly, if date is given as just the year, let's say, \"2018\", what would be the \"above\" and \"below\" range for it? Before 2018-01-01T00:00:00 and after 2018-01-01T00:00:00? This is what it looks like according to the specification, but \"2000\" sort of represents the whole year. Shouldn't  the those ranges be rather \"before 2018-01-01T00:00:00\" and \"after 2018-12-31T23:59:59\"?</p>\n<p>I feel that this part of the specification is hard to understand without more \"interesting\" examples (example given uses \"2015-08-12T05:23:45\" which is not very interesting as it has exact time specified). Also, examples like \"1.9 is considered greater than 1.91\" would also help as they would clearly demonstrate the point about the mathematical sense.</p>",
        "id": 153944649,
        "sender_full_name": "Ivan Dubrov",
        "timestamp": 1521001517
    },
    {
        "content": "<p>so with numbers, when searching, precision does not play a part. 1.91 &gt; 1.9. As is 1.9000000000001</p>",
        "id": 153944650,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1521001589
    },
    {
        "content": "<p>your search engine should just add 0s to the number till you get to the working precision limit - or behave as if that has happened</p>",
        "id": 153944651,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1521001642
    },
    {
        "content": "<p>dates the rules are different.</p>",
        "id": 153944652,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1521001661
    },
    {
        "content": "<p>Ok. Does that mean that for numbers I just use \"normal\" mathematical operators? Like, a &gt; b when a &gt; b, digit by digit?</p>\n<p>What confuses me is that section \"The range interpretation is provided for decimals and dates. Searches are always performed on values that are implicitly or explicitly a range.\", so I tried to make sense of all those \"range\" rules for decimals.</p>",
        "id": 153944653,
        "sender_full_name": "Ivan Dubrov",
        "timestamp": 1521001806
    },
    {
        "content": "<p>well, those two statements are not compatible with each other</p>",
        "id": 153944654,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1521001986
    },
    {
        "content": "<p>Let me formulate where I think specification has some issues. Apologies for the long text, but I struggle to make total sense of the specification in this area.</p>\n<p>1. There is an inconsistency around number comparisons. One part of the specification calls for \"range\" semantics (\"The range interpretation is provided for decimals and dates. Searches are always performed on values that are implicitly or explicitly a range\") and another part of the specification calls for something else (\"Uncertainty does not factor in evaluations. The precision of the numbers is considered arbitrarily high\").</p>\n<p>Based on the previous discussion it seems that for relative comparisons (gt/lt/ge/le) the comparison should be against numbers as they are, without using range semantics. For example, \"1.0 &lt; 1.0001\" and \"1.0001 &gt; 1.0\".</p>\n<p>It is also not so clear for the equality. For example, when checking value \"1.001\" against criteria \"eq1.0\", should it be \"true\" or \"false\"? According to the \"range\" semantics, it should be \"true\", because range of \"1.0\" (\"0.95\" - \"1.05\") includes range of \"1.001\" (\"1.0005\" - \"1.0015\"). However, according to the \"arbitrarily high\" precision semantics and the discussion above (\"your search engine should just add 0s to the number till you get to the working precision limit - or behave as if that has happened\"), it should be \"false\", as \"1.001\" != \"1.000\".</p>\n<p>Also, to fully nitpick on this case, this \"The precision of the numbers is considered arbitrarily high.\" is somewhat inconsistent with \"The way search parameters operate in resources is not the same as whether two numbers are equal to each other in a mathematical sense\". The \"mathematical sense\" (to me) is exactly about numbers having arbitrary precision (no rounding at all).</p>\n<p>2. There is uncertainty around \"above\" and \"below\" ranges for the dates. It is not clear what to use as \"high\" value for the \"below\" range and \"low\" value for the \"above\" range. For example, for the \"range above the value\" the specification says \"The specified value and up\". However, it is not clear what is the \"value\" in this context for dates which are not fully specified (for example, \"2015\").</p>\n<p>Intuitively, I would split into three intervals:</p>\n<p>* \"below\" interval: up to the _minimum_ value (\"2015-01-01T00:00:00Z\" in case of \"2015\")<br>\n  * \"value\" interval: from _minimum_ value to the _maximum_ value (\"2015-01-01T00:00:00Z\" to \"2015-12-31T23:59:59\" in case of \"2015\")<br>\n  * \"above\" interval: from the _maximum_ value (\"2015-12-31T23:59:59\" in case of \"2015\").</p>\n<p>However, I don't think this is what specification says. For both \"below\" and \"above\" it does not distinguish between _minimum_ and _maximum_ value and says about the value itself. Which is, again, unclear, what is the value of \"2015\"? The whole year or just the point in time \"2015-01-01T00:00:00\"?</p>\n<p>3. Finally, the examples provided in the table explaining ranges (<a href=\"https://build.fhir.org/search.html#prefix\" target=\"_blank\" title=\"https://build.fhir.org/search.html#prefix\">https://build.fhir.org/search.html#prefix</a>) are not very helpful as the cases they use are not very interesting. For example, for dates they use date with time for which both _minimum_ and _maximum_ values are the same as the value itself (because it includes month, day and time).</p>\n<p>Also, an example for the date \"2015-08-12 has a range from 00:00 to 00:00 exclusive\" seems to specify an empty range (\"00:00 to 00:00 exclusive\"). It (probably) should say \"2015-08-12 has a range from 2015-08-12T00:00 to 2015-08-13T00:00\" (different day, \"13\").</p>\n<p>Hopefully that explains my frustration with the specification. Unfortunately, the discussion above did not help me to understand what is the desired semantics.</p>\n<p>I would really appreciate if other implementers point me at tests they have in public access, so I can compare them to each other and to the specification.</p>",
        "id": 153944809,
        "sender_full_name": "Ivan Dubrov",
        "timestamp": 1521047470
    },
    {
        "content": "<p>don't know if <span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span> has tests. I don't have tests for this part in my server. But agree that the specification says 2 incompatible things here</p>",
        "id": 153944842,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1521054975
    },
    {
        "content": "<p>In Vonk we compare Number searchparams as-is, but the value of Quantities are treated as ranges, accounting for their precision (both the value in the resource and the value in the search). <br>\nGiven the nature of the searchparams of type number (<a href=\"http://www.hl7.org/implement/standards/fhir/searchparameter-registry.html\" target=\"_blank\" title=\"http://www.hl7.org/implement/standards/fhir/searchparameter-registry.html\">http://www.hl7.org/implement/standards/fhir/searchparameter-registry.html</a>), this seems reasonable for most of them. I'm just not sure about ChargeItem.factor-Override and RiskAssessment.probability.</p>",
        "id": 153950111,
        "sender_full_name": "Christiaan Knaap",
        "timestamp": 1522738660
    },
    {
        "content": "<p>I think the spec needs clarification around these cases. It seems that everyone is interpreting it differently. <br>\nI've spent hours reading it and am still not certain on some cases. </p>\n<p>To illustrate, I set up some tests to see how different servers are handling some cases around searching numbers and ranges. <br>\nI could only find three public servers to test against at the time. <br>\nFor each of these, I created a Condition resource with either the onsetAge or onsetRange set.<br>\nPosted to each server, then executed a search to see if the search returned the resource. Then I deleted the resource. </p>\n<p>Here are the cases that I ran where various servers behaved differently: </p>\n<div class=\"codehilite\"><pre><span></span>*********\n  Test age:  age:0.99; searchParam:=eq1.0; found:true; server:HAPI STU3\n  Test age:  age:0.99; searchParam:=eq1.0; found:false; server:Aegis STU3\n  Test age:  age:0.99; searchParam:=eq1.0; found:true; server:Pyro STU3\n*********\n  Test age:  age:0.99; searchParam:=ge0.99; found:true; server:HAPI STU3\n  Test age:  age:0.99; searchParam:=ge0.99; found:false; server:Aegis STU3\n  Test age:  age:0.99; searchParam:=ge0.99; found:true; server:Pyro STU3\n*********\nTest range:  low:5.0; high:6.0; searchParam:=eq6.0; found:true; server:HAPI STU3\nTest range:  low:5.0; high:6.0; searchParam:=eq6.0; found:false; server:Aegis STU3\nTest range:  low:5.0; high:6.0; searchParam:=eq6.0; found:false; server:Pyro STU3\n*********\nTest range:  low:5.0; high:6.0; searchParam:=gt5.999999; found:true; server:HAPI STU3\nTest range:  low:5.0; high:6.0; searchParam:=gt5.999999; found:false; server:Aegis STU3\nTest range:  low:5.0; high:6.0; searchParam:=gt5.999999; found:false; server:Pyro STU3\n*********\nTest range:  low:5.0; high:6.0; searchParam:=ge6.0; found:true; server:HAPI STU3\nTest range:  low:5.0; high:6.0; searchParam:=ge6.0; found:false; server:Aegis STU3\nTest range:  low:5.0; high:6.0; searchParam:=ge6.0; found:false; server:Pyro STU3\n</pre></div>\n\n\n<p>Test details:<br>\nFor instance, this output:<br>\n<strong>Test age:  age:0.99; searchParam:=eq1.0; found:true; server:HAPI STU3</strong></p>\n<p>I posted a Condition like: </p>\n<div class=\"codehilite\"><pre><span></span>{\n  &quot;resourceType&quot;: &quot;Condition&quot;,\n  &quot;contained&quot;: [\n    {\n      &quot;resourceType&quot;: &quot;Patient&quot;,\n      &quot;id&quot;: &quot;xx1&quot;\n    }\n  ],\n  &quot;identifier&quot;: [\n    {\n      &quot;system&quot;: &quot;http://example.org/testXX&quot;,\n      &quot;value&quot;: &quot;0618b587-a842-4298-af74-d41e6c31df4e&quot;\n    }\n  ],\n  &quot;clinicalStatus&quot;: &quot;inactive&quot;,\n  &quot;subject&quot;: {\n    &quot;reference&quot;: &quot;#xx1&quot;\n  },\n  &quot;onsetAge&quot;: {\n    &quot;value&quot;: 0.99,\n    &quot;system&quot;: &quot;http://unitsofmeasure.org&quot;,\n    &quot;code&quot;: &quot;{years}&quot;\n  }\n}\n</pre></div>\n\n\n<p>Then performed a search like:<br>\n<strong>{baseurl}/Condition/?identifier=0618b587-a842-4298-af74-d41e6c31df4e&amp;onset-age=eq1.0</strong><br>\nThen printed whether the search found the resource or not.</p>",
        "id": 157807637,
        "sender_full_name": "Craig McClendon",
        "timestamp": 1549569329
    },
    {
        "content": "<p>did you test <a href=\"http://test.fhir.org\" target=\"_blank\" title=\"http://test.fhir.org\">test.fhir.org</a>?</p>",
        "id": 157835841,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1549601461
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span>  - I'm receiving errors POSTing to <a href=\"http://test.fhir.org\" target=\"_blank\" title=\"http://test.fhir.org\">test.fhir.org</a>.   <br>\nAt  <a href=\"http://test.fhir.org/r3\" target=\"_blank\" title=\"http://test.fhir.org/r3\">test.fhir.org/r3</a>  and <a href=\"http://test.fhir.org/r4\" target=\"_blank\" title=\"http://test.fhir.org/r4\">test.fhir.org/r4</a>:<br>\n<code>500, responseBody-&gt;Not done yet @ TFHIRTextComposer.Compose</code><br>\nAt the base url <a href=\"http://test.fhir.org\" target=\"_blank\" title=\"http://test.fhir.org\">test.fhir.org</a>: <br>\n<code>404, responseBody-&gt;Document /Condition not found</code></p>\n<p>NOTE: I have these tests automated so can add servers and test cases re-compare easily.</p>",
        "id": 157861984,
        "sender_full_name": "Craig McClendon",
        "timestamp": 1549635573
    },
    {
        "content": "<p>what are you posting?</p>",
        "id": 157866742,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1549639559
    },
    {
        "content": "<p>Updated results with <a href=\"http://test.fhir.org\" target=\"_blank\" title=\"http://test.fhir.org\">test.fhir.org</a> included: </p>\n<div class=\"codehilite\"><pre><span></span>*********\n  Test age:  age:0.99; searchParam:=eq1.0; found:true; server:test.fhir.org STU3\n  Test age:  age:0.99; searchParam:=eq1.0; found:true; server:HAPI STU3\n  Test age:  age:0.99; searchParam:=eq1.0; found:false; server:Aegis STU3\n  Test age:  age:0.99; searchParam:=eq1.0; found:true; server:Pyro STU3\n*********\n  Test age:  age:0.99; searchParam:=ge0.99; found:true; server:test.fhir.org STU3\n  Test age:  age:0.99; searchParam:=ge0.99; found:true; server:HAPI STU3\n  Test age:  age:0.99; searchParam:=ge0.99; found:false; server:Aegis STU3\n  Test age:  age:0.99; searchParam:=ge0.99; found:true; server:Pyro STU3\n*********\nTest range:  low:5.0; high:6.0; searchParam:=eq5.0; found:false; server:test.fhir.org STU3\nTest range:  low:5.0; high:6.0; searchParam:=eq5.0; found:true; server:HAPI STU3\nTest range:  low:5.0; high:6.0; searchParam:=eq5.0; found:true; server:Aegis STU3\nTest range:  low:5.0; high:6.0; searchParam:=eq5.0; found:true; server:Pyro STU3\n*********\nTest range:  low:5.0; high:6.0; searchParam:=eq6.0; found:false; server:test.fhir.org STU3\nTest range:  low:5.0; high:6.0; searchParam:=eq6.0; found:true; server:HAPI STU3\nTest range:  low:5.0; high:6.0; searchParam:=eq6.0; found:false; server:Aegis STU3\nTest range:  low:5.0; high:6.0; searchParam:=eq6.0; found:false; server:Pyro STU3\n*********\nTest range:  low:5.0; high:6.0; searchParam:=gt5.999999; found:true; server:test.fhir.org STU3\nTest range:  low:5.0; high:6.0; searchParam:=gt5.999999; found:true; server:HAPI STU3\nTest range:  low:5.0; high:6.0; searchParam:=gt5.999999; found:false; server:Aegis STU3\nTest range:  low:5.0; high:6.0; searchParam:=gt5.999999; found:false; server:Pyro STU3\n*********\nTest range:  low:5.0; high:6.0; searchParam:=ge6.0; found:true; server:test.fhir.org STU3\nTest range:  low:5.0; high:6.0; searchParam:=ge6.0; found:true; server:HAPI STU3\nTest range:  low:5.0; high:6.0; searchParam:=ge6.0; found:false; server:Aegis STU3\nTest range:  low:5.0; high:6.0; searchParam:=ge6.0; found:false; server:Pyro STU3\n</pre></div>",
        "id": 157874607,
        "sender_full_name": "Craig McClendon",
        "timestamp": 1549645455
    },
    {
        "content": "<p>After re-reading that part of the search spec I have to agree with <a href=\"http://test.fhir.org\" target=\"_blank\" title=\"http://test.fhir.org\">test.fhir.org</a> - but it's a little bit confusing that significant figures precision applies to eq5.0 =&gt; [4.95,5.05) while the values in the explicit range (low=5.0, high=6.0) are treated with no distinction between setting low=5.0 and low=5.0000000. This confusion is specific to eq/ne against a range target value, I think?</p>",
        "id": 157883178,
        "sender_full_name": "Paul Church",
        "timestamp": 1549652568
    },
    {
        "content": "<p>When we discussed this for eq at the May 2018 WGM (<a href=\"https://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=16369\" target=\"_blank\" title=\"https://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=16369\">Gforge #16369</a>) I don't remember whether we discussed ge and le.</p>",
        "id": 157884438,
        "sender_full_name": "Michael Donnelly",
        "timestamp": 1549653525
    },
    {
        "content": "<p>I think <a href=\"http://test.fhir.org\" target=\"_blank\" title=\"http://test.fhir.org\">test.fhir.org</a> has the  \"eq\" against an explicit target range correct, as per the spec. But I can't say the spec makes intuitive sense to me on this case. <br>\nThe spec says: <code>the range of the search value fully contains the range of the target value</code><br>\nSo for this case: <code>Test range:  low:5.0; high:6.0; searchParam:=eq5.0; </code><br>\nrange of search value = [4.95,5.05)<br>\nrange of target value = [5.0, 6.0]</p>\n<p>So while the search value is within the target range, the (implicit) range of the search value does not fully contain the (explicit) range of the target. And it seems like it rarely would, unless the target range had a fine precision with a relatively narrow range.  </p>\n<ul>\n<li>Assuming I am reading the spec correctly.</li>\n</ul>",
        "id": 157891426,
        "sender_full_name": "Craig McClendon",
        "timestamp": 1549658873
    },
    {
        "content": "<p>I opened this issue to investigate this further: <a href=\"https://jira.hl7.org/browse/FHIR-26311\" target=\"_blank\" title=\"https://jira.hl7.org/browse/FHIR-26311\">https://jira.hl7.org/browse/FHIR-26311</a></p>",
        "id": 188393541,
        "sender_full_name": "Alexander Kiel",
        "timestamp": 1581958914
    }
]