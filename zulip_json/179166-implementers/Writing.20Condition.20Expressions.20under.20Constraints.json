[
    {
        "content": "<p>Is there a documentation / Help I can read through on writing Conditional Expressions to validate the values. For instance::</p>\n<p>I have custom Structure Definition based on Observation resource. Using HAPI for the validation. Is there a way to validate the value combination?</p>\n<p>Ex:</p>\n<div class=\"codehilite\"><pre><span></span><code>   &quot;code&quot;: {\n       &quot;coding&quot;: [\n            {\n               &quot;system&quot;: &quot;http://loinc.org&quot;,\n               &quot;code&quot;: &quot;76536-2&quot;,\n              &quot;display&quot;: &quot;Mean Arterial Pressure, Cuff&quot;\n           }\n       ]\n    },\n</code></pre></div>\n\n<p>When this one is used, the unit of measure from the valueQuantity should have only corresponding values, not anything from the code valueset for unitofmeasure.</p>\n<div class=\"codehilite\"><pre><span></span><code>&quot;valueQuantity&quot;: {\n  &quot;value&quot;: 90,\n  &quot;unit&quot;: &quot;mm Hg&quot;,\n  &quot;system&quot;: &quot;http://unitsofmeasure.org&quot;,\n  &quot;code&quot;: &quot;mm[Hg]&quot;\n}\n</code></pre></div>\n\n<p>In other words, for Mean Arial Pressure LOINC code, valueQuantity.code should not allow kg, for example.</p>",
        "id": 253798212,
        "sender_full_name": "Krant",
        "timestamp": 1631908257
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"441486\">@Krant</span>.  I think the key operators you're looking for is <a href=\"http://hl7.org/fhirpath/#implies\">implies</a>.  In other words, \"LOINC code X <em>implies</em> quantity unit Y\".  See the FHIRPath spec for examples of its use.  If you search the whole spec for the word \"implies\" then you'll see it is used in several examples.</p>",
        "id": 253800183,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1631909130
    },
    {
        "content": "<p>Here's an example using the Observation from your question:</p>\n<div class=\"codehilite\"><pre><span></span><code>code.coding.where(code = &#39;76536-2&#39; and system = &#39;http://loinc.org&#39;).exists() implies valueQuantity.where(code = &#39;mm[Hg]&#39; and system = &#39;http://unitsofmeasure.org&#39;).exists()\n</code></pre></div>\n<p>You can try that out on the <a href=\"https://hl7.github.io/fhirpath.js/\">fhirpath tester</a> with this Observation:</p>\n<div class=\"codehilite\" data-code-language=\"YAML\"><pre><span></span><code><span class=\"nt\">resourceType</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">Observation</span>\n<span class=\"nt\">id</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">ExampleObservation</span>\n<span class=\"nt\">status</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">final</span>\n<span class=\"nt\">code</span><span class=\"p\">:</span>\n  <span class=\"nt\">coding</span><span class=\"p\">:</span>\n    <span class=\"p p-Indicator\">-</span> <span class=\"nt\">code</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">76536-2</span>\n      <span class=\"nt\">system</span><span class=\"p\">:</span> <span class=\"s\">'http://loinc.org'</span>\n      <span class=\"nt\">display</span><span class=\"p\">:</span> <span class=\"s\">'Mean</span><span class=\"nv\"> </span><span class=\"s\">Arterial</span><span class=\"nv\"> </span><span class=\"s\">Pressure,</span><span class=\"nv\"> </span><span class=\"s\">Cuff'</span>\n<span class=\"nt\">valueQuantity</span><span class=\"p\">:</span>\n  <span class=\"nt\">value</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">90</span>\n  <span class=\"nt\">code</span><span class=\"p\">:</span> <span class=\"s\">'mm[Hg]'</span>\n  <span class=\"nt\">system</span><span class=\"p\">:</span> <span class=\"s\">'http://unitsofmeasure.org'</span>\n  <span class=\"nt\">unit</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">mm Hg</span>\n</code></pre></div>\n<p>Play with the code and quantity to see how it affects the result on the right-hand side.</p>",
        "id": 253801658,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1631909857
    },
    {
        "content": "<p>For more advanced stuff (like checking for value set inclusion) you can just modify the expressions on the left or right side of <code>implies</code> as appropriate.  Note however that the fhirpath tester linked above does not cover the whole FHIRPath spec, so some FHIRPath expressions won't work there.</p>",
        "id": 253801869,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1631909959
    },
    {
        "content": "<p>Thank you.. Is this conditional expression should be specified only in snapshot or it can be specified in Differential too?</p>",
        "id": 253810256,
        "sender_full_name": "Krant",
        "timestamp": 1631914170
    },
    {
        "content": "<p>Also, how do I specify multiple AND or OR conditions in the same expression?</p>",
        "id": 253810513,
        "sender_full_name": "Krant",
        "timestamp": 1631914294
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"441486\">@Krant</span> -- I'd recommend you review the documentation on <a href=\"http://hl7.org/fhir/R4/profiling.html#snapshot\">Differential vs Snapshot</a>, but in short, if you're creating a profile, your changes always go in the differential.  When the profile is processed by the IG Publisher (or whatever tooling you're using) it will generate the snapshot, which will reflect any changes you made in the differential.</p>",
        "id": 253811626,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1631915036
    },
    {
        "content": "<p>As for AND and OR, you use the keywords <code>and</code> and <code>or</code>.  If you need to group logical constructs, you can group them in <code>(</code> <code>)</code>.  For more info on FHIRPath, I'd suggest reading the <a href=\"http://hl7.org/fhirpath/\">FHIRPath spec</a> as well as the <a href=\"http://hl7.org/fhir/R4/fhirpath.html\">section on FHIRPath</a> in the FHIR R4 spec.  Both are fairly easy reads.</p>",
        "id": 253811940,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1631915207
    }
]