[
    {
        "content": "<p>Hi !</p>\n<p>I'm currently using FirelyTeam library (<a href=\"https://github.com/FirelyTeam/fhir-net-api/tree/master-r4/src/Hl7.Fhir.Specification\" target=\"_blank\" title=\"https://github.com/FirelyTeam/fhir-net-api/tree/master-r4/src/Hl7.Fhir.Specification\">https://github.com/FirelyTeam/fhir-net-api/tree/master-r4/src/Hl7.Fhir.Specification</a>) for validation but I'm facing an issue with a simple validation.</p>\n<p>I have created : <br>\n- A custom profile for patient<br>\n- A custom complex extension (Added to patient profile) with 3 fields (Nationality, DocumentType, DocumentNumber)</p>\n<p>During validation, I've got theses errors from the library : <br>\n[ERROR] Instance count for 'Extension.extension:nationality' is 3, which is not within the specified cardinality of 0..1 (at Patient.extension[0])    <br>\n[ERROR] Instance count for 'Extension.extension:documentType' is 3, which is not within the specified cardinality of 0..1 (at Patient.extension[0])    <br>\n[ERROR] Instance count for 'Extension.extension:documentNumber' is 3, which is not within the specified cardinality of 0..1 (at Patient.extension[0])</p>\n<p>if I use HAPI validation, it gives multiples issues  :<br>\n{<br>\n      \"severity\": \"error\",<br>\n      \"code\": \"processing\",<br>\n      \"diagnostics\": \"Could not match discriminator (url) for slice Patient.extension:citizenship in profile <a href=\"http://pms-fhir.org/fhir/StructureDefinition/PmsPatient\" target=\"_blank\" title=\"http://pms-fhir.org/fhir/StructureDefinition/PmsPatient\">http://pms-fhir.org/fhir/StructureDefinition/PmsPatient</a> - does not have fixed value, binding or existence assertions\",<br>\n      \"location\": [<br>\n        \"Patient.extension\"<br>\n      ]<br>\n    },<br>\n    {<br>\n      \"severity\": \"error\",<br>\n      \"code\": \"processing\",<br>\n      \"diagnostics\": \"Could not match discriminator (url) for slice Extension.extension:nationality in profile <a href=\"http://pms-fhir.org/fhir/StructureDefinition/PmsCitizenship\" target=\"_blank\" title=\"http://pms-fhir.org/fhir/StructureDefinition/PmsCitizenship\">http://pms-fhir.org/fhir/StructureDefinition/PmsCitizenship</a> - does not have fixed value, binding or existence assertions\",<br>\n      \"location\": [<br>\n        \"Patient.extension.extension[1]\"<br>\n      ]<br>\n    }</p>\n<p>Moreover, I see that multiple github issues related to this problem without any fixes : <br>\n<a href=\"https://github.com/FirelyTeam/fhir-net-api/issues/885\" target=\"_blank\" title=\"https://github.com/FirelyTeam/fhir-net-api/issues/885\">https://github.com/FirelyTeam/fhir-net-api/issues/885</a></p>\n<p>It seems that the resolver can't correctly map my ressource.. Any ideas ?</p>",
        "id": 176011908,
        "sender_full_name": "Thomas",
        "timestamp": 1568817940
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191328\">@Ewout Kramer</span> ?</p>",
        "id": 176012733,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1568818459
    },
    {
        "content": "<p>Perfect timing!  We're working on those issues currently, and the fix is available in this branch (<a href=\"https://github.com/FirelyTeam/fhir-net-api/tree/develop-1.x/r4\" target=\"_blank\" title=\"https://github.com/FirelyTeam/fhir-net-api/tree/develop-1.x/r4\">https://github.com/FirelyTeam/fhir-net-api/tree/develop-1.x/r4</a>).</p>\n<p><span class=\"user-mention\" data-user-id=\"238039\">@Thomas</span> are you using your own build of the API?  In that case it would be lovely if you could grab that branch and test whether I have actually fixed your problem.</p>\n<p>Otherwise, I think we have our CI build alphas of all these branches, and there should be a way to get to it and test it out.  <span class=\"user-mention\" data-user-id=\"193551\">@Marco Visser</span> do you know exactly?</p>",
        "id": 176015324,
        "sender_full_name": "Ewout Kramer",
        "timestamp": 1568820124
    },
    {
        "content": "<blockquote>\n<p>Perfect timing!  We're working on those issues currently, and the fix is available in this branch (<a href=\"https://github.com/FirelyTeam/fhir-net-api/tree/develop-1.x/r4\" target=\"_blank\" title=\"https://github.com/FirelyTeam/fhir-net-api/tree/develop-1.x/r4\">https://github.com/FirelyTeam/fhir-net-api/tree/develop-1.x/r4</a>).</p>\n<p><span class=\"user-mention silent\" data-user-id=\"238039\">Thomas</span> are you using your own build of the API?  In that case it would be lovely if you could grab that branch and test whether I have actually fixed your problem.</p>\n<p>Otherwise, I think we have our CI build alphas of all these branches, and there should be a way to get to it and test it out.  <span class=\"user-mention silent\" data-user-id=\"193551\">Marco Visser</span> do you know exactly?</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"191328\">@Ewout Kramer</span>  Thanks for your answer. I'm currently using the build provided by the nuget package (<a href=\"https://www.nuget.org/packages/Hl7.Fhir.Specification.R4/\" target=\"_blank\" title=\"https://www.nuget.org/packages/Hl7.Fhir.Specification.R4/\">https://www.nuget.org/packages/Hl7.Fhir.Specification.R4/</a>).</p>\n<p>Now, I'm going to try artifacts located here : <a href=\"https://dev.azure.com/firely/fhir-net-api/_build/results?buildId=4744\" target=\"_blank\" title=\"https://dev.azure.com/firely/fhir-net-api/_build/results?buildId=4744\">https://dev.azure.com/firely/fhir-net-api/_build/results?buildId=4744</a></p>",
        "id": 176075561,
        "sender_full_name": "Thomas",
        "timestamp": 1568878243
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191328\">@Ewout Kramer</span> <br>\nI've updated all packages to 1.4.0-alpha-20190912-1 and now I have a different issue during validation : </p>\n<p>Overall result: FAILURE<br>\n[FATAL] Internal logic failure: The value discriminator should have either a 'fixed[x]' or 'binding' element set on 'Extension.url'. (at Patient)</p>\n<p>I've attached my DefinitionStructures of patient + Extension with an example.<br>\nExtension definition : <a href=\"/user_uploads/10155/DJA_uvP5uiWydPwi6HACwOHQ/pmsCitizenship.StructureDefinition.xml\" target=\"_blank\" title=\"pmsCitizenship.StructureDefinition.xml\">pmsCitizenship.StructureDefinition.xml</a> <br>\nPatient definition : <a href=\"/user_uploads/10155/KZSbgqIAhCyPtWhHi-H7Dv0E/PmsPatient.StructureDefinition.xml\" target=\"_blank\" title=\"PmsPatient.StructureDefinition.xml\">PmsPatient.StructureDefinition.xml</a><br>\nPatient example : <a href=\"/user_uploads/10155/2chtYKpMa8sQplOJeddsFk_H/ExamplePatient\" target=\"_blank\" title=\"ExamplePatient\">ExamplePatient</a> </p>\n<p>Could you please, have a look ?</p>",
        "id": 176076736,
        "sender_full_name": "Thomas",
        "timestamp": 1568879685
    },
    {
        "content": "<p>In the meantime I created the packages for 1.x/r4 on MyGet (<a href=\"https://www.myget.org/feed/fhir-net-api/package/nuget/Hl7.Fhir.R4/1.4.0-alpha-20190912-1\" target=\"_blank\" title=\"https://www.myget.org/feed/fhir-net-api/package/nuget/Hl7.Fhir.R4/1.4.0-alpha-20190912-1\">https://www.myget.org/feed/fhir-net-api/package/nuget/Hl7.Fhir.R4/1.4.0-alpha-20190912-1</a>). So you could use that one, but it will be probably the same like you created yourself. Btw, this is not an official release, but an alpha release. Official releases can be found on NuGet.</p>\n<p>I will try to test your use case now. I will  report the results later.</p>",
        "id": 176079553,
        "sender_full_name": "Marco Visser",
        "timestamp": 1568882757
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"238039\">@Thomas</span>, your extension definition has a couple of errors. All three<code>valueString</code> slices are repeated and the \"[...].extension.url\" elements don't specify a <code>fixedString</code> value (in the snapshot). This probably explains why the validator complains about the extension slice. Here are updated versions with snapshots generated by Forge R4 22.1:<br>\n<a href=\"/user_uploads/10155/f1hoxx4dE3nQ3gIDZVY8Lwy5/pmsCitizenship.StructureDefinition.xml\" target=\"_blank\" title=\"pmsCitizenship.StructureDefinition.xml\">pmsCitizenship.StructureDefinition.xml</a> <a href=\"/user_uploads/10155/bv5-1X18SXOKKyCIM_fpoRIT/PmsPatient.StructureDefinition.xml\" target=\"_blank\" title=\"PmsPatient.StructureDefinition.xml\">PmsPatient.StructureDefinition.xml</a></p>",
        "id": 176081487,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1568884613
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"238039\">@Thomas</span>  , I can confirm  the comment of my colleague <span class=\"user-mention\" data-user-id=\"191336\">@Michel Rutten</span>: the structuredefinitions were not correct. I have created an unittest to prove that. <a href=\"/user_uploads/10155/XLU8CWoLzWv0qucnJuW3qC_H/Program.cs\" target=\"_blank\" title=\"Program.cs\">Program.cs</a></p>",
        "id": 176082341,
        "sender_full_name": "Marco Visser",
        "timestamp": 1568885432
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"191336\">@Michel Rutten</span> and <span class=\"user-mention\" data-user-id=\"193551\">@Marco Visser</span>  for your revisions.</p>\n<p>I've created these files with a previous version of forge and with this 22.1, it seems better.</p>\n<p>Snapshot shoud always been included into structureDefinitions ?</p>\n<p>Thanks again</p>",
        "id": 176101281,
        "sender_full_name": "Thomas",
        "timestamp": 1568901180
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"238039\">@Thomas</span>, <a href=\"http://hl7.org/fhir/structuredefinition-definitions.html#StructureDefinition.snapshot\" target=\"_blank\" title=\"http://hl7.org/fhir/structuredefinition-definitions.html#StructureDefinition.snapshot\"><code>StructureDefinition.snapshot</code></a> is an optional component (not required). Systems can re-generate the snapshot from the differential component (depending on capabilities).<br>\nNote that Forge ignores any existing snapshot and always re-generates a new snapshot based on the specified differential. Except when an existing profile only contains a snapshot and no differential.</p>",
        "id": 176101952,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1568901554
    },
    {
        "content": "<p>I am happy my new code now turned this into a clear error message - this is probably also why the original &lt;1.4 version behaved incorrectly!   I'll  have to chase why the error includes the bit about \"internal error\", but those small things are to be expected in an alpha ;-)</p>",
        "id": 176129344,
        "sender_full_name": "Ewout Kramer",
        "timestamp": 1568918654
    },
    {
        "content": "<p>Can we make it tollerant of the fixedUrl or fixedString in there, and report a warning/info message that the SD is incorrect, rather than the instance of the resource?</p>",
        "id": 176137166,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1568923907
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191336\">@Michel Rutten</span>  Good to know, it seems that some servers implementation of FHIR need to have the full snapshot to have a correct validation of ressources..</p>\n<p><span class=\"user-mention\" data-user-id=\"191328\">@Ewout Kramer</span>  Do you know when we could expect this bugfix included in the next release ?</p>",
        "id": 176170131,
        "sender_full_name": "Thomas",
        "timestamp": 1568963443
    },
    {
        "content": "<p>FYI after discussion with Grahame &amp; Lloyd, I learned that <code>Extension.url</code> actually requires a <code>fixedUri</code> value, not a <code>fixedString</code> as I mistakenly had assumed. Coincidentally, this small discrepancy does not seem to cause validation errors, since the validator is perfectly capable of discriminating slices on fixedString values.<br>\nI have already created a bugfix for the .NET API SnapshotGenerator and am planning to publish a Forge hotfix soon that includes a fix for this issue.</p>",
        "id": 176176874,
        "sender_full_name": "Michel Rutten",
        "timestamp": 1568970825
    }
]