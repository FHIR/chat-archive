[
    {
        "content": "<p>Hi, I encountered a problem with the java validator when validating against an ig package. It seems that one of the dependencies in the package does not resolve, although it is present in the registry and I'm relatively sure it was loading before. This is the package I'm using: <a href=\"http://registry.fhir.org/package/de.medizininformatikinitiative.kerndatensatz.diagnose|1.0.2\">http://registry.fhir.org/package/de.medizininformatikinitiative.kerndatensatz.diagnose|1.0.2</a> <br>\nHere is the exception thrown by the validator:</p>\n<div class=\"codehilite\"><pre><span></span><code>  Load de.medizininformatikinitiative.kerndatensatz.meta#1.0.2 - 2 resources (00:00.0046)\n  Load de.basisprofil.r4#0.9.12 - 126 resources (00:00.0355)\n  Load KBV.Basis#1.1.0Exception in thread &quot;main&quot; org.hl7.fhir.exceptions.FHIRException: Unable to find/resolve/read -ig KBV.Basis#1.1.0\n    at org.hl7.fhir.validation.IgLoader.loadIgSource(IgLoader.java:191)\n    at org.hl7.fhir.validation.IgLoader.loadIg(IgLoader.java:85)\n    at org.hl7.fhir.validation.IgLoader.loadIg(IgLoader.java:71)\n    at org.hl7.fhir.validation.cli.services.ValidationService.getValidator(ValidationService.java:205)\n    at org.hl7.fhir.validation.ValidatorCli.doValidation(ValidatorCli.java:200)\n    at org.hl7.fhir.validation.ValidatorCli.main(ValidatorCli.java:156)\n</code></pre></div>",
        "id": 228787495,
        "sender_full_name": "Julian Sass",
        "timestamp": 1614870343
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"248736\">@Mark Iantorno</span></p>",
        "id": 228790020,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1614871111
    },
    {
        "content": "<p>please provide the exact command you ran with any supporting files</p>",
        "id": 228836070,
        "sender_full_name": "Mark Iantorno",
        "timestamp": 1614886529
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"248736\">Mark Iantorno</span> <a href=\"#narrow/stream/179166-implementers/topic/Error.20loading.20package.20in.20java.20validator/near/228836070\">said</a>:</p>\n<blockquote>\n<p>please provide the exact command you ran with any supporting files</p>\n</blockquote>\n<p>Here's the file and the command:<br>\n<a href=\"/user_uploads/10155/PJVUF0MBG6GGdItJKJipDP0j/Condition-example.json\">Condition-example.json</a> <a href=\"/user_uploads/10155/t93ekIIrWoihiOvfWXPJw3_e/de.medizininformatikinitiative.kerndatensatz.diagnose-1.0.2.tgz\">de.medizininformatikinitiative.kerndatensatz.diagnose-1.0.2.tgz</a> </p>\n<div class=\"codehilite\"><pre><span></span><code>julian@Julians-MacBook-Air kerndatensatzmodul-diagnose % java -jar validator_cli.jar Condition-example.json -version 4.0 -ig de.medizininformatikinitiative.kerndatensatz.diagnose#1.0.2\nFHIR Validation tool Version 5.3.2 (Git# 7e70adf8198d). Built 2021-02-18T23:33:17.184Z (13 days old)\n  Java:   15.0.2 from /Library/Java/JavaVirtualMachines/jdk-15.0.2.jdk/Contents/Home on x86_64 (64bit). 2048MB available\n  Paths:  Current = /Users/julian/git/kerndatensatzmodul-diagnose, Package Cache = /Users/julian/.fhir/packages\n  Params: Condition-example.json -version 4.0 -ig de.medizininformatikinitiative.kerndatensatz.diagnose#1.0.2\nLoading\n  Load FHIR v4.0 from hl7.fhir.r4.core#4.0.1Creating Package manager?\n - 4575 resources (00:17.0543)\n  Load hl7.terminology#2.0.0 - 3749 resources (00:01.0836)\n  Terminology server http://tx.fhir.org - Version 1.9.369 (00:02.0909)\n  Load de.medizininformatikinitiative.kerndatensatz.meta#1.0.2 - 2 resources (00:00.0101)\n  Load de.basisprofil.r4#0.9.12 - 126 resources (00:01.0198)\n  Load KBV.Basis#1.1.0Exception in thread &quot;main&quot; org.hl7.fhir.exceptions.FHIRException: Unable to find/resolve/read -ig KBV.Basis#1.1.0\n    at org.hl7.fhir.validation.IgLoader.loadIgSource(IgLoader.java:191)\n    at org.hl7.fhir.validation.IgLoader.loadIg(IgLoader.java:85)\n    at org.hl7.fhir.validation.IgLoader.loadIg(IgLoader.java:71)\n    at org.hl7.fhir.validation.cli.services.ValidationService.getValidator(ValidationService.java:205)\n    at org.hl7.fhir.validation.ValidatorCli.doValidation(ValidatorCli.java:200)\n    at org.hl7.fhir.validation.ValidatorCli.main(ValidatorCli.java:156)\n</code></pre></div>",
        "id": 228842139,
        "sender_full_name": "Julian Sass",
        "timestamp": 1614888779
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"194952\">@Julian Sass</span> Given <a href=\"#narrow/stream/179177-conformance/topic/Bug.20in.20FHIR.20Package.20Servers/near/231780540\">your comment here</a> is this now resolved?</p>",
        "id": 232644200,
        "sender_full_name": "Ward Weistra",
        "timestamp": 1617216399
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"203235\">@Ward Weistra</span> the error remains when packages include a dependency on KBV.Basis. But yes, resolved in the sense that the bug has been reported.</p>",
        "id": 232646382,
        "sender_full_name": "Julian Sass",
        "timestamp": 1617217268
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"194952\">@Julian Sass</span> Sorry to hear, I thought this was now resolved, given that the package API will now basically ignore capitalization (eg both <a href=\"https://packages.simplifier.net/KBV.Basis\">https://packages.simplifier.net/KBV.Basis</a> and <a href=\"https://packages.simplifier.net/kbv.basis\">https://packages.simplifier.net/kbv.basis</a> resolve). But perhaps there's still some case-dependent resolving in the IG Publisher?<br>\n<span class=\"user-mention\" data-user-id=\"191451\">@Patrick Werner</span> Is this also still occurring for you? And if so, is there a IG publisher ticket for that?</p>",
        "id": 232648405,
        "sender_full_name": "Ward Weistra",
        "timestamp": 1617218082
    },
    {
        "content": "<p>Isn't this an issue with the upper cases in the package.json package reference?</p>",
        "id": 233633409,
        "sender_full_name": "Martijn Harthoorn",
        "timestamp": 1617879022
    },
    {
        "content": "<p>And the IG tool not being able to match that against the lower cased package listing?</p>",
        "id": 233633450,
        "sender_full_name": "Martijn Harthoorn",
        "timestamp": 1617879047
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191451\">@Patrick Werner</span> <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> If this is still an issue, could the IG publisher be improved to compare package names case independent (always treat the names in package cache, dependencies, dependencies of dependencies as lowercase)?</p>",
        "id": 233792015,
        "sender_full_name": "Ward Weistra",
        "timestamp": 1617960635
    },
    {
        "content": "<p>Hey <span class=\"user-mention\" data-user-id=\"203235\">@Ward Weistra</span> i hadn't had the time to fix this, and i think nobody else did it on the java side.</p>",
        "id": 233792631,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1617960965
    },
    {
        "content": "<p>will file a ticket</p>",
        "id": 233792671,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1617960991
    },
    {
        "content": "<p><a href=\"https://github.com/hapifhir/org.hl7.fhir.core/issues/475\">https://github.com/hapifhir/org.hl7.fhir.core/issues/475</a><br>\nfyi: <span class=\"user-mention\" data-user-id=\"203235\">@Ward Weistra</span> <span class=\"user-mention\" data-user-id=\"194952\">@Julian Sass</span> <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span></p>",
        "id": 234048204,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1618150636
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191469\">@Chris Moesel</span> <span aria-label=\"wait one second\" class=\"emoji emoji-261d\" role=\"img\" title=\"wait one second\">:wait_one_second:</span>Ô∏è FYI<br>\nPerhaps you can also check if sushi is comparing and searching for packages always as lowercase.</p>",
        "id": 234287943,
        "sender_full_name": "Ward Weistra",
        "timestamp": 1618302768
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191427\">@Jens Villadsen</span> Perhaps you can also check your scripts to make sure they always treat package names as lowercase, regardless of how provided.</p>",
        "id": 234292412,
        "sender_full_name": "Ward Weistra",
        "timestamp": 1618304990
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"203235\">@Ward Weistra</span> -- I think we take the package name exactly as the user provided it in the config.  If we switch to use lowercase only, then won't it temporarily break projects that currently depend on a Simplifier package name with capitals?  Or am I misunderstanding?</p>",
        "id": 234318280,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1618318065
    },
    {
        "content": "<p>That said, since Simplifier doesn't publish snapshots in the packages, I'm guessing we don't have too many cases of this anyway.</p>",
        "id": 234318400,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1618318116
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191469\">@Chris Moesel</span> It depends a bit on how your logic for comparing packages is implemented. Let's take <a href=\"https://simplifier.net/packages/kbv.basis/1.1.3\">KBV.Basis 1.3.3</a> as an example:</p>\n<ul>\n<li>The package API will now give you back the package, regardless of how you capitalize it and the file will be named how you capitalized it. Eg. <a href=\"https://packages.simplifier.net/kbv.basis/1.1.3\">https://packages.simplifier.net/kbv.basis/1.1.3</a> will give back a file called <code>kbv.basis-1.3.3.tgz</code>, <a href=\"https://packages.simplifier.net/KbV.BaSiS/1.1.3\">https://packages.simplifier.net/KbV.BaSiS/1.1.3</a> will give you a file called <code>KbV.BaSiS-1.3.3.tgz</code>.</li>\n<li>The package.json will still have the original package name <code>KBV.Basis</code> regardless: <a href=\"https://simplifier.net/packages/kbv.basis/1.1.3/files/319323\">https://simplifier.net/packages/kbv.basis/1.1.3/files/319323</a></li>\n</ul>\n<p>When someone now specifies <code>KBV.Basis@1.1.3</code> as a dependency in sushi or IG publisher or wherever, I hope you will:</p>\n<ol>\n<li>query the local package cache for <code>kbv.basis</code> regardless of how it's capitalized there</li>\n<li>if not locally available yet, query the package server for lowercase <code>kbv.basis</code> and put a lowercase folder in the FHIR package cache (although that shouldn't matter if other tools implement 1. as well, but just for good measure)</li>\n</ol>\n<p>Makes sense or am I missing something?</p>",
        "id": 234331919,
        "sender_full_name": "Ward Weistra",
        "timestamp": 1618323057
    },
    {
        "content": "<p>We'll start to enforce new package( version)s to have lowercase names, possibly even update old ones to lowercase. But until other tools have capitalization-independent package comparison I'm afraid that will lead to breaking dependencies for current sushi/IG publisher IGs when using a previously capitalized dependency.</p>",
        "id": 234332597,
        "sender_full_name": "Ward Weistra",
        "timestamp": 1618323289
    },
    {
        "content": "<p>Thanks for the extra detail / suggested approach <span class=\"user-mention\" data-user-id=\"203235\">@Ward Weistra</span> -- that's helpful.  We'll look into this to ensure SUSHI fits within this.</p>",
        "id": 234343030,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1618326299
    },
    {
        "content": "<p><a href=\"https://github.com/FHIR/sushi/issues/800\">SUSHI #800</a></p>",
        "id": 234343935,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1618326487
    },
    {
        "content": "<p>I can't reproduce this. it doesn't matter whether I use KBV.Basis or kbv.basis in the java client.</p>",
        "id": 237261765,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1620097367
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191451\">@Patrick Werner</span> <span class=\"user-mention\" data-user-id=\"194952\">@Julian Sass</span> Can you check whether this (<a href=\"https://github.com/hapifhir/org.hl7.fhir.core/issues/475\">https://github.com/hapifhir/org.hl7.fhir.core/issues/475</a>) is still an issue and, if so, make it reproducible for Grahame?</p>",
        "id": 237782876,
        "sender_full_name": "Ward Weistra",
        "timestamp": 1620374472
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"203235\">@Ward Weistra</span> <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> Just tested again and I'm still getting this error with the java validator when I set the -ig parameter to <code>de.medizininformatikinitiative.kerndatensatz.diagnose#1.0.2</code>.  This IG declares a dependency on <code>\"KBV.Basis\": \"1.1.0\"</code> in its package manifest. The subsequent version of <em>diagnose</em> changed this to <code>kbv.basis</code> and package loading works. Here's the log:</p>\n<div class=\"codehilite\"><pre><span></span><code>julian@Julians-Air kerndatensatzmodul-diagnose % java -jar validator_cli.jar Condition-example.json -version 4.0 -ig de.medizininformatikinitiative.kerndatensatz.diagnose#1.0.2\nFHIR Validation tool Version 5.3.11 (Git# 33fffe28ff6b). Built 2021-04-22T05:48:36.375Z (20 days old)\n  Java:   15.0.2 from /Library/Java/JavaVirtualMachines/jdk-15.0.2.jdk/Contents/Home on x86_64 (64bit). 2048MB available\n  Paths:  Current = /Users/julian/git/kerndatensatzmodul-diagnose, Package Cache = /Users/julian/.fhir/packages\n  Params: Condition-example.json -version 4.0 -ig de.medizininformatikinitiative.kerndatensatz.diagnose#1.0.2\nLoading\n  Load FHIR v4.0 from hl7.fhir.r4.core#4.0.1Creating Package manager?\n - 4575 resources (00:08.0710)\n  Load hl7.terminology#2.0.0 - 3749 resources (00:02.0256)\n  Terminology server http://tx.fhir.org - Version 1.9.372 (00:02.0206)\n  Load de.medizininformatikinitiative.kerndatensatz.meta#1.0.2 - 2 resources (00:00.0028)\n  Load de.basisprofil.r4#0.9.12 - 126 resources (00:00.0275)\n  Load KBV.Basis#1.1.0Exception in thread &quot;main&quot; org.hl7.fhir.exceptions.FHIRException: Unable to find/resolve/read -ig KBV.Basis#1.1.0\n    at org.hl7.fhir.validation.IgLoader.loadIgSource(IgLoader.java:195)\n    at org.hl7.fhir.validation.IgLoader.loadIg(IgLoader.java:89)\n    at org.hl7.fhir.validation.IgLoader.loadIg(IgLoader.java:75)\n    at org.hl7.fhir.validation.cli.services.ValidationService.initializeValidator(ValidationService.java:234)\n    at org.hl7.fhir.validation.cli.services.ValidationService.initializeValidator(ValidationService.java:212)\n    at org.hl7.fhir.validation.ValidatorCli.doValidation(ValidatorCli.java:203)\n    at org.hl7.fhir.validation.ValidatorCli.main(ValidatorCli.java:159)\n</code></pre></div>",
        "id": 238458482,
        "sender_full_name": "Julian Sass",
        "timestamp": 1620819097
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"194952\">@Julian Sass</span>. <span class=\"user-mention\" data-user-id=\"191687\">@Kevin Mayfield</span> sees the same <a href=\"#narrow/stream/179177-conformance/topic/Simplifier.20-.20Git.20Worklow.20FHIR.20Validation/near/238449585\">here</a>.<br>\n<span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> Can you reproduce that for <a href=\"https://github.com/hapifhir/org.hl7.fhir.core/issues/475\">https://github.com/hapifhir/org.hl7.fhir.core/issues/475</a>? I believe just always lowercasing any user inputted FHIR package names should do the trick.</p>",
        "id": 238461119,
        "sender_full_name": "Ward Weistra",
        "timestamp": 1620820532
    },
    {
        "content": "<p>hah found it. It was an internal regex I was using for internal decision making. Should be fixed next release. Fixed next release</p>",
        "id": 238692430,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1620945999
    },
    {
        "content": "<p>It looks like I just encountered a separate version of this issue when trying to load packages into the JPA server starter, see <a href=\"#narrow/stream/179167-hapi/topic/Error.20loading.20de.2Egecco.20package.20into.20JPA.20starter\">this HAPI thread</a>. Specifically, the <code>JpaPackageCache#addPackageToCache</code> method also does a package ID comparison that is case-sensitive (see <a href=\"https://github.com/hapifhir/hapi-fhir/blob/48f93f55555e397bc664fc51be38a77d6e15d0ee/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/packages/JpaPackageCache.java#L198\">these code lines</a>), causing this error:</p>\n<div class=\"codehilite\"><pre><span></span><code>2021-05-26 16:52:02.948 [main] ERROR o.a.c.c.C.[Tomcat].[localhost].[/] [DirectJDKLog.java:175] Servlet.init() for servlet [jpaRestfulServer] threw exception\nca.uhn.fhir.rest.server.exceptions.InvalidRequestException: Package ID KBV.Basis doesn&#39;t match expected: kbv.basis\n    at ca.uhn.fhir.jpa.packages.JpaPackageCache.addPackageToCache(JpaPackageCache.java:199)\n</code></pre></div>\n<p>Am I right in assuming this would require a separate fix?</p>",
        "id": 240428769,
        "sender_full_name": "Morten Ernebjerg",
        "timestamp": 1622100287
    },
    {
        "content": "<p>(I'd be happy to do a PR for this, just wanted to check whether it would have further ramifications)</p>",
        "id": 240429109,
        "sender_full_name": "Morten Ernebjerg",
        "timestamp": 1622100518
    },
    {
        "content": "<p>yes you should do a PR for that</p>",
        "id": 240441426,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1622108587
    },
    {
        "content": "<p>Opened a PR with a fix that makes the ID check case-insensitive:</p>\n<p>PR: <a href=\"https://github.com/hapifhir/hapi-fhir/pull/2683\">https://github.com/hapifhir/hapi-fhir/pull/2683</a><br>\nAssociated issue: <a href=\"https://github.com/hapifhir/hapi-fhir/issues/2682\">https://github.com/hapifhir/hapi-fhir/issues/2682</a></p>\n<p>Finally, I managed to (attempt to) contribute smt. to HAPI <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span>  (even if it is only a single line &amp; two tests...).</p>",
        "id": 240465922,
        "sender_full_name": "Morten Ernebjerg",
        "timestamp": 1622121747
    }
]