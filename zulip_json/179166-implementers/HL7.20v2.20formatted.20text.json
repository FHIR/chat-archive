[
    {
        "content": "<p>Suppose I have an HL7 v2 message with formatted text as the value. What is the best way to represent that in the value[x] element of an Observation? Markdown would seem the best option, but it isn't a supported datatype. We could use a string and put markdown in there, but the end user won't know that's markdown (unless we use an extension to indicate this of course)...</p>",
        "id": 153841409,
        "sender_full_name": "David Hay",
        "timestamp": 1469670345
    },
    {
        "content": "<p>Of maybe the unformatted data in the value, and formatted as markdown in the extension?</p>",
        "id": 153841411,
        "sender_full_name": "David Hay",
        "timestamp": 1469670549
    },
    {
        "content": "<p>Have you considered ValueAttachment?</p>",
        "id": 153841423,
        "sender_full_name": "Eric Haas",
        "timestamp": 1469674015
    },
    {
        "content": "<p>How does that value over string? Or are you thinking that the markdown/html whatever is b64 encoded with an appropriate mime type?</p>",
        "id": 153841427,
        "sender_full_name": "David Hay",
        "timestamp": 1469674393
    },
    {
        "content": "<p>One of the advantages of Markdown is that the bare text is very readable as is.  I'm not sure if this would be frowned upon, but you could put the Markdown text in the string and people \"in the know\" would decode it while others would get the bare text.  As I said, though, that might be considered bad form because of it's esoteric nature.</p>",
        "id": 153841430,
        "sender_full_name": "Stephen Royce",
        "timestamp": 1469675010
    },
    {
        "content": "<p>Or are you saying no-one would be \"in the know\"?</p>",
        "id": 153841431,
        "sender_full_name": "Stephen Royce",
        "timestamp": 1469675130
    },
    {
        "content": "<p>In which case my suggestion is a bad idea and you <strong>SHOULD</strong> just ignore me! <img alt=\":wink:\" class=\"emoji\" src=\"static/third/gemoji/images/emoji/wink.png\" title=\":wink:\"> </p>",
        "id": 153841436,
        "sender_full_name": "Stephen Royce",
        "timestamp": 1469676936
    },
    {
        "content": "<p>That was where we started :)  I'll likely propose that markdown is a valid observation.value datatype, but - as you say - the MD is quite readable, even as plain text...</p>",
        "id": 153841450,
        "sender_full_name": "David Hay",
        "timestamp": 1469692169
    },
    {
        "content": "<p>after looking at section 2.7.7 in the V2 spec ver 2.8.2 re FT formatiing.  I don't see why you would need to use markdown here.  if you want to reproduce it exactly as in the V2 message it will be text.   If you want to have it all pretty and formatted at the end I'm still partial to valueAttachment so you can identify the Markup  (html, markdown flavor)  </p>",
        "id": 153841495,
        "sender_full_name": "Eric Haas",
        "timestamp": 1469723344
    },
    {
        "content": "<p>I feel a bit queasy about base64-encoding something which is *pretty much* human-readable text. One of the reasons for suggesting Markdown is that if a client can't interpret the markup it can still show the user something useful, the remaining problem being there's no way to tell clients that Markdown is what is there. If we present it as some kind of binary then a client is more likely to reject it outright imho.</p>",
        "id": 153841581,
        "sender_full_name": "James Butler",
        "timestamp": 1469742531
    },
    {
        "content": "<p>I think it because HL7 v2 OBX  has multipe types of text value. So, you have to provide additional information to that. In that case, ValueAttachment is the only place to hold those information.</p>",
        "id": 153841585,
        "sender_full_name": "Jeffrey Chen",
        "timestamp": 1469745063
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191321\">@David Hay</span> What did you end up doing? I am currently facing the same issue: It mostly boils down to the question of what to do with the \"\\.br\\\" in OBX.#5. I have hardly ever seen systems using more sophisticated markup that that...</p>",
        "id": 153843914,
        "sender_full_name": "Simone Heckmann",
        "timestamp": 1471255273
    },
    {
        "content": "<p>oh wait. CR LF are allowed in datatype string! duh.</p>",
        "id": 153843916,
        "sender_full_name": "Simone Heckmann",
        "timestamp": 1471257432
    },
    {
        "content": "<p>From our notes:</p>\n<p>Textual laboratory results might enter the system in an OBX message with a value of type FT (Formatted Text), an HL7v2-specific markup language. We currently expose this in FHIR as an Observation with a string value, where the string is the raw FT text complete with formatting. This isn't very useful for clients who don't know how to interpret FT formatting (which is a vague legacy standard used only in v2 messaging); and even clients which do will have trouble, because there's no standard way to indicate that a string Observation contains formatting instructions.<br>\nAfter consulting the FHIR community, we have determined that the only way to represent formatted text is by using an attachment value, with the original FT text base64-encoded and the media type set to tell the consuming application what formatting is in the value. It's a bit clumsy to base64-encode what is essentially plain text, but it's the mechanism available, so we will use it.<br>\nOur approach will be:<br>\nAn FT-type result from an OBX will be mapped to an Observation with an attachment value<br>\nThe original formatted text will be presented base64-encoded in attachment.data<br>\nattachment.contentType will be set to \"text/x-hl7-ft\" (ref)<br>\nattachment.title will be set to a string generated by a best-effort attempt at formatting the FT text, for display by clients which can't interpret FT text<br>\nsee this blog (<a href=\"http://www.healthintersections.com.au/?page_id=441\" target=\"_blank\" title=\"http://www.healthintersections.com.au/?page_id=441\">http://www.healthintersections.com.au/?page_id=441</a> ) for some guidelines <br>\nthe 'h' and 'n' directives for highlighting should be ignored, and highlighted text presented as plain text</p>",
        "id": 153843965,
        "sender_full_name": "David Hay",
        "timestamp": 1471302369
    },
    {
        "content": "<p>My solution turned out to be the following: <br>\n*Replace all FT formatting with appropriate html tags and place formatted text into Observation.text<br>\n*Replace /.br/ with CR LF and remove all other formatting and place unformatted text in Observation.valueString <br>\nSidenote: the sending system only used linebreak and bold as formatting tags. But I guess for Observations with a more excessive use of formatting, your solution is better.</p>",
        "id": 153844007,
        "sender_full_name": "Simone Heckmann",
        "timestamp": 1471333639
    },
    {
        "content": "<p>does this help? <a href=\"http://www.healthintersections.com.au/?page_id=441\" target=\"_blank\" title=\"http://www.healthintersections.com.au/?page_id=441\">http://www.healthintersections.com.au/?page_id=441</a></p>",
        "id": 153844008,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1471334357
    },
    {
        "content": "<p>We didn't want to simply drop the Observation value into the narrative because we're not otherwise populating it right now, <a href=\"https://www.hl7.org/fhir/narrative.html#Narrative\" target=\"_blank\" title=\"https://www.hl7.org/fhir/narrative.html#Narrative\">and</a>:</p>\n<blockquote>\n<p>If narrative is present, it SHALL reflect all content needed for a human to understand the essential clinical and business information otherwise encoded within the resource<br>\nand the value doesn't have some pretty essential context, like for instance the test that is being performed. If you are already generating narrative which includes all the important extra stuff, then it makes sense to HTML-ify the value there as well.</p>\n</blockquote>",
        "id": 153844048,
        "sender_full_name": "James Butler",
        "timestamp": 1471468008
    },
    {
        "content": "<p>Gah formatting fail</p>",
        "id": 153844049,
        "sender_full_name": "James Butler",
        "timestamp": 1471468009
    }
]