[
    {
        "content": "<p>Currently, we are trying to check if a practitioner already exists using <code>@Interceptor</code> annotation:</p>\n<div class=\"codehilite\"><pre><span></span><code>@Interceptor\npublic class MpiValidationInterceptor {\n\n    private final IFhirResourceDao&lt;Practitioner&gt; myPractitionerDaoR4;\n\n    @Hook(Pointcut.STORAGE_PRESTORAGE_RESOURCE_CREATED)\n    public void storagePrestorageResourceCreated(RequestDetails theRequestDetails, IBaseResource theResource) {\n        if(theResource instanceof Practitioner) {\n            this.validatePractitioner((Practitioner)theResource,getLocaleFromRequest(theRequestDetails));\n        }\n    }\n\n    private void validatePractitioner(Practitioner practitioner) {\n        SearchParameterMap paramMap = new SearchParameterMap();\n        //Fill paramMap\n        IBundleProvider provider = myPractitionerDaoR4.search(paramMap);\n        List&lt;IBaseResource&gt; list = provider.getAllResources();\n        for(IBaseResource resource:list) {\n            //do validation\n        }\n    }\n}\n</code></pre></div>\n<p>Nevertheless, we're getting this error message when this code is reached:</p>\n<div class=\"codehilite\"><pre><span></span><code>2021-07-29 09:50:30.610 ERROR 12037 --- [nio-8093-exec-1] c.u.f.r.s.i.ExceptionHandlingInterceptor : Failure during REST processing\n\nca.uhn.fhir.rest.server.exceptions.InternalErrorException: Failed to call access method: ca.uhn.fhir.context.ConfigurationException: Attempt to request all resources from an asynchronous search result.  The SearchParameterMap for this search probably should have been synchronous.\n    at ca.uhn.fhir.rest.server.method.BaseMethodBinding.invokeServerMethod(BaseMethodBinding.java:272) ~[hapi-fhir-server-5.4.1.jar:na]\n    at ca.uhn.fhir.rest.server.method.BaseOutcomeReturningMethodBinding.invokeServer(BaseOutcomeReturningMethodBinding.java:154) ~[hapi-fhir-server-5.4.1.jar:na]\n    at ca.uhn.fhir.rest.server.method.CreateMethodBinding.invokeServer(CreateMethodBinding.java:41) ~[hapi-fhir-server-5.4.1.jar:na]\n    at ca.uhn.fhir.rest.server.RestfulServer.handleRequest(RestfulServer.java:1146) ~[hapi-fhir-server-5.4.1.jar:na]\n    at ca.uhn.fhir.rest.server.RestfulServer.doPost(RestfulServer.java:417) ~[hapi-fhir-server-5.4.1.jar:na]\n    at ca.uhn.fhir.rest.server.RestfulServer.service(RestfulServer.java:1855) ~[hapi-fhir-server-5.4.1.jar:na]\n    at javax.servlet.http.HttpServlet.service(HttpServlet.java:733) ~[tomcat-embed-core-9.0.41.jar:4.0.FR]\n</code></pre></div>\n<p>The outcome is:</p>\n<div class=\"codehilite\"><pre><span></span><code>{\n    &quot;resourceType&quot;: &quot;OperationOutcome&quot;,\n    &quot;text&quot;: {\n        &quot;status&quot;: &quot;generated&quot;,\n        &quot;div&quot;: &quot;&lt;div xmlns=\\&quot;http://www.w3.org/1999/xhtml\\&quot;&gt;&lt;h1&gt;Operation Outcome&lt;/h1&gt;&lt;table border=\\&quot;0\\&quot;&gt;&lt;tr&gt;&lt;td style=\\&quot;font-weight: bold;\\&quot;&gt;ERROR&lt;/td&gt;&lt;td&gt;[]&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Failed to call access method: ca.uhn.fhir.context.ConfigurationException: Attempt to request all resources from an asynchronous search result.  The SearchParameterMap for this search probably should have been synchronous.&lt;/pre&gt;&lt;/td&gt;\\n\\t\\t\\t&lt;/tr&gt;\\n\\t\\t&lt;/table&gt;\\n\\t&lt;/div&gt;&quot;\n    },\n    &quot;issue&quot;: [\n        {\n            &quot;severity&quot;: &quot;error&quot;,\n            &quot;code&quot;: &quot;processing&quot;,\n            &quot;diagnostics&quot;: &quot;Failed to call access method: ca.uhn.fhir.context.ConfigurationException: Attempt to request all resources from an asynchronous search result.  The SearchParameterMap for this search probably should have been synchronous.&quot;\n        }\n    ]\n}\n</code></pre></div>\n<p>Sometimes, we're also getting this message:</p>\n<div class=\"codehilite\"><pre><span></span><code>{\n    &quot;resourceType&quot;: &quot;OperationOutcome&quot;,\n    &quot;text&quot;: {\n        &quot;status&quot;: &quot;generated&quot;,\n        &quot;div&quot;: &quot;&lt;div xmlns=\\&quot;http://www.w3.org/1999/xhtml\\&quot;&gt;&lt;h1&gt;Operation Outcome&lt;/h1&gt;&lt;table border=\\&quot;0\\&quot;&gt;&lt;tr&gt;&lt;td style=\\&quot;font-weight: bold;\\&quot;&gt;ERROR&lt;/td&gt;&lt;td&gt;[]&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Failed to call access method: org.springframework.transaction.IllegalTransactionStateException: Existing transaction found for transaction marked with propagation &#39;never&#39;&lt;/pre&gt;&lt;/td&gt;\\n\\t\\t\\t&lt;/tr&gt;\\n\\t\\t&lt;/table&gt;\\n\\t&lt;/div&gt;&quot;\n    },\n    &quot;issue&quot;: [\n        {\n            &quot;severity&quot;: &quot;error&quot;,\n            &quot;code&quot;: &quot;processing&quot;,\n            &quot;diagnostics&quot;: &quot;Failed to call access method: org.springframework.transaction.IllegalTransactionStateException: Existing transaction found for transaction marked with propagation &#39;never&#39;&quot;\n        }\n    ]\n}\n</code></pre></div>\n<p>What are we doing wrong?<br>\nAny ideas?</p>",
        "id": 247553890,
        "sender_full_name": "Jordi Cabr√©",
        "timestamp": 1627545198
    },
    {
        "content": "<p>Suggest raising this on <a class=\"stream\" data-stream-id=\"179167\" href=\"/#narrow/stream/179167-hapi\">#hapi</a></p>",
        "id": 247581559,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1627564665
    }
]