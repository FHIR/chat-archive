[
    {
        "content": "<p>Hello!</p>\n<p>I'm reading over the specification for <code>Reference</code> (<a href=\"https://www.hl7.org/fhir/references.html\" target=\"_blank\" title=\"https://www.hl7.org/fhir/references.html\">https://www.hl7.org/fhir/references.html</a>). Its <code>ref-1</code> constraint expression is:</p>\n<div class=\"codehilite\"><pre><span></span>reference.startsWith(&#39;#&#39;).not() or (reference.substring(1).trace(&#39;url&#39;) in %resource.contained.id.trace(&#39;ids&#39;))\n</pre></div>\n\n\n<p>However, later in this page, it describes contained resources (<a href=\"https://www.hl7.org/fhir/references.html#contained\" target=\"_blank\" title=\"https://www.hl7.org/fhir/references.html#contained\">https://www.hl7.org/fhir/references.html#contained</a>). Quoting from that section:</p>\n<blockquote>\n<p>For a resource that references the container, the reference is \"#\"</p>\n</blockquote>\n<p>Thus it seems like the above expression is missing a case. Am I reading this correctly?</p>\n<p>Thank you,<br>\nPreston</p>",
        "id": 176037868,
        "sender_full_name": "Preston TW",
        "timestamp": 1568835280
    },
    {
        "content": "<p>The above expression says that a reference either:</p>\n<ul>\n<li>does NOT start with <code>#</code></li>\n<li>OR the part after the <code>#</code> must match one of the contained resource IDs</li>\n</ul>\n<p>So that seems right to me, unless I'm misunderstanding your question.</p>",
        "id": 176038175,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1568835467
    },
    {
        "content": "<p>Thank you, <span class=\"user-mention\" data-user-id=\"191469\">@Chris Moesel</span>, I misread how constraint expressions work. I thought the expression must be <code>true</code> to <em>satisfy</em> the constraint, rather than evaluating to <code>true</code> means the constraint is violated. Is the latter interpretation correct?</p>",
        "id": 176038367,
        "sender_full_name": "Preston TW",
        "timestamp": 1568835591
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"240854\">@Preston TW</span> -- no, you had it right the first time.  If the constraint evaluates to <code>true</code> then the data is <em>good</em>.  If it evaluates to false, then the data is <em>bad</em> (constraint violated).</p>",
        "id": 176038620,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1568835728
    },
    {
        "content": "<p>I have to step out a quick minute, but glad to walk through it.  Just a minute...</p>",
        "id": 176038683,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1568835792
    },
    {
        "content": "<p>As a concrete example, the docs give this resource:</p>\n<div class=\"codehilite\"><pre><span></span>&lt;Patient xmlns=&quot;http://hl7.org/fhir&quot;&gt;\n  &lt;id value=&quot;something&quot;/&gt;\n  &lt;contained&gt;\n    &lt;Provenance&gt;\n      &lt;!-- no id necessary (though still allowed) --&gt;\n      &lt;target&gt;\n        &lt;reference value=&quot;#&quot;/&gt;\n      &lt;/target&gt;\n    &lt;/Provenance&gt;\n  &lt;/contained&gt;\n  &lt;!-- other attributes --&gt;\n&lt;/Patient&gt;\n</pre></div>\n\n\n<p>How is this reference valid wrt <code>ref-1</code>?</p>",
        "id": 176039362,
        "sender_full_name": "Preston TW",
        "timestamp": 1568836240
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"240854\">@Preston TW</span> -- you are 100% correct.  I'm sorry, I misread your original message.  I agree -- if just <code>\"#\"</code> is intended to be used to reference the \"container\" (e.g., the resource that has the contained resources), then there <em>does</em> seem to be a missing phrase in the constraint.  I'm sorry for the confusion!</p>",
        "id": 176039702,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1568836442
    },
    {
        "content": "<p>Thank you, <span class=\"user-mention\" data-user-id=\"191469\">@Chris Moesel</span>, for clearing that up!</p>",
        "id": 176040030,
        "sender_full_name": "Preston TW",
        "timestamp": 1568836639
    },
    {
        "content": "<p>Is there a process for opening a ticket?</p>",
        "id": 176041459,
        "sender_full_name": "Preston TW",
        "timestamp": 1568837409
    },
    {
        "content": "<p><code>#</code> is not a valid reference. I have no idea what's up with that example above.</p>",
        "id": 176041702,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1568837596
    },
    {
        "content": "<p>to create a ticket, there's a link at the bottom of every page - \"propose a change\"</p>",
        "id": 176041718,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1568837610
    },
    {
        "content": "<p>I initially didn't expect it either, <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span>  , but it's not just the example that uses <code>#</code> as a reference.  The text itself <em>says</em> to use just <code>#</code> to reference the container from a contained resource.</p>\n<p>And this approach is further supported by DOM-3 in DomainResource, which contains the following clause: <code>descendants().where(reference = '#').exists()</code>.</p>",
        "id": 176042376,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1568838018
    },
    {
        "content": "<p>oh</p>",
        "id": 176042407,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1568838051
    },
    {
        "content": "<p>yes now I'm waking up. this is to reference the container</p>",
        "id": 176042427,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1568838061
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> and it looks like the original poster is correct that the FHIRPath is insufficient - it doesn't allow for a bare \"#\" as the reference when the reference appears in a contained resource - and it needs to.</p>",
        "id": 176044495,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1568839379
    },
    {
        "content": "<p>looks like another technical correction</p>",
        "id": 176044644,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1568839478
    },
    {
        "content": "<p>Yep.  So the constraint needs to check for references that are <code>#</code> and are in the <code>contained</code> resources. <br>\n Maybe something more like this?</p>\n<div class=\"codehilite\"><pre><span></span>reference.startsWith(&#39;#&#39;).not()\n  or (reference.substring(1).trace(&#39;url&#39;) in %resource.contained.id.trace(&#39;ids&#39;))\n  or (reference = &#39;#&#39; and $this in %resource.contained.descendants())\n</pre></div>\n\n\n<p>I'm not sure if that's the right / best way to check if the reference is in the contained resources of the container.  Another possible approach might be checking the <code>path</code> of <code>reference.elementDefinition()</code>.  I don't have a FHIRPath parser on hand that knows how to do <code>%resource</code> or <code>elementDefintion()</code>, so I can't test this constraint.</p>",
        "id": 176044714,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1568839525
    },
    {
        "content": "<p>something like that, yes. I'd also have to test</p>",
        "id": 176044755,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1568839557
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191469\">@Chris Moesel</span> <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span>  quick followup,  why do you need the <code>descendants()</code>? Can you just have <code>... or (reference = '#' and $this in %resource.contained)</code>? From <a href=\"https://www.hl7.org/fhir/references.html#contained\" target=\"_blank\" title=\"https://www.hl7.org/fhir/references.html#contained\">https://www.hl7.org/fhir/references.html#contained</a>: \"Contained resources SHALL NOT contain additional contained resources.\"</p>",
        "id": 176964844,
        "sender_full_name": "Preston TW",
        "timestamp": 1569871472
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"240854\">@Preston TW</span> -- IIRC, this is a constraint on the <code>Reference</code> data type, so <code>$this</code> refers to an instance of a <code>Reference</code>. In your concrete example further up the thread, Reference's <code>$this</code> would refer to the part inside the <code>&lt;target&gt;</code> tags.  That being the case, the Reference instance is not an item directly in <code>contained</code> -- it's nested within the contained object.  That's why I used <code>descendants()</code> -- because we don't know exactly where it should be in a contained resource (depends on the resource) -- but we know it should be a descendant node of one of the contained resources.</p>",
        "id": 176968414,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1569873751
    }
]