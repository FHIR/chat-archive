[
    {
        "content": "<p>From <a class=\"stream\" data-stream-id=\"179298\" href=\"/#narrow/stream/179298-fhirpath.2Ejs\">#fhirpath.js</a> discussion...</p>\n<p>Is it expected that</p>\n<div class=\"codehilite\"><pre><span></span><code>name.select(use | given)\n</code></pre></div>\n\n<p>should return different results from</p>\n<div class=\"codehilite\"><pre><span></span><code>name.select(use.union(given))\n</code></pre></div>\n\n<p>? I would have expected these to be equivalent but in fhirpath.js, <code>union</code> appears to be operating at the root level even when it occurs inside a <code>select</code>.</p>",
        "id": 276089909,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1647885235
    },
    {
        "content": "<p>I think that the right replacement for:<br>\n<code>name.select(use | given)</code><br>\nusing union() is:<br>\n<code>name.select(use.union($this.given))</code></p>\n<p>It does not work for fhirpath.js right now, but I can fix that if there are no objections.</p>",
        "id": 276102160,
        "sender_full_name": "Yury Sedinkin",
        "timestamp": 1647890921
    },
    {
        "content": "<p>That doesn't quite sound correct to me; the <a href=\"https://hl7.org/fhirpath/#unionother-collection\">spec says</a>:</p>\n<div class=\"codehilite\"><pre><span></span><code>a.union(b)\nis synonymous with\na | b\n</code></pre></div>\n<p>... and so I expect this holds true anywhere the expression occurs (including within a <code>select</code> expression).</p>",
        "id": 276114038,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1647896953
    },
    {
        "content": "<p>The spec is referring to two collections, \"A\" and \"B\" (uppercase), and then gives the example in lowercase.  I would interpret that as referring to two collections, not two properties of a parent node.</p>",
        "id": 276116245,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1647897984
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191328\">@Ewout Kramer</span> can you shed any light on the intention here?</p>",
        "id": 276133068,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1647911307
    },
    {
        "content": "<p>I don't think we intended to imply any difference in using uppercase versus lower case for those examples. I also don't think that there's any difference between whether the union operates on two collections or on two properties of a parent node (assuming those properties are accessible within the current scope), they would both be interpreted as collection arguments to the union operator.</p>",
        "id": 276252845,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1647982558
    },
    {
        "content": "<p>And in the example above:</p>\n<div class=\"codehilite\"><pre><span></span><code>name.select(use.union($this.given))\n</code></pre></div>\n<p>This is equivalent to:</p>\n<div class=\"codehilite\"><pre><span></span><code>name.select(use.union(given))\n</code></pre></div>\n<p>In other words, the <code>$this</code> is still referring to the iterator introduced by the <code>.select()</code>, union does not introduce an iteration scope. So although the <code>use.union($this.given)</code> should still work, it's not necessary to use <code>$this</code>.</p>",
        "id": 276253194,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1647982725
    },
    {
        "content": "<p>union does not introduce an iteration scope, but in that example, what is the scope for the collection in \"union(...)\"?</p>",
        "id": 276253534,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1647982874
    },
    {
        "content": "<p>I'm not sure I understand the question.</p>",
        "id": 276254264,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1647983183
    },
    {
        "content": "<p>The expression <code>use.union(given)</code> is the same as saying <code>use | given</code>, both are just invoking the <code>.union()</code> function, which takes two arguments, and both those arguments are evaluated in the same scope, which in this case is the one introduced by the <code>select()</code> function.</p>",
        "id": 276254601,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1647983341
    },
    {
        "content": "<p>Is that what you're asking?</p>",
        "id": 276254611,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1647983345
    },
    {
        "content": "<p>Yes.  That is clear answer.  I think the spec could use some clarification on that point, because it introduces \"A\" and \"B\" without any context of where they are coming from.  This example from Patient would be better.</p>",
        "id": 276254866,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1647983462
    },
    {
        "content": "<p>That's fair, submit a tracker?</p>",
        "id": 276257149,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1647984456
    },
    {
        "content": "<p><a href=\"http://jira.hl7.org/browse/FHIR-36494\">FHIR-36494</a></p>",
        "id": 276258394,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1647984965
    },
    {
        "content": "<p>Which is the version that is a concatenation of collections that doesn't remove duplicates?<br>\n(I know that | does remove duplicates)</p>",
        "id": 276412245,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1648075738
    },
    {
        "content": "<p>\"combine\"?  <a href=\"https://hl7.org/fhirpath/#combineother-collection-collection\">https://hl7.org/fhirpath/#combineother-collection-collection</a></p>",
        "id": 276421109,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1648082577
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span> the difference between <code>name.select(use.union($this.given))</code><br>\nand <code>name.select(use.union(given))</code> is catching me out.</p>",
        "id": 277222798,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1648690039
    },
    {
        "content": "<p>you say that </p>\n<blockquote>\n<p>In other words, the $this is still referring to the iterator introduced by the .select(), union does not introduce an iteration scope. So although the use.union($this.given) should still work, it's not necessary to use $this.</p>\n</blockquote>\n<p>but it's more than that. You're saying that .union() doesn't switch context on it's parameters.</p>",
        "id": 277223647,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1648691089
    },
    {
        "content": "<p>I don't get this. a.func(b),  a is the scope for b. but not for union?</p>",
        "id": 277223680,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1648691133
    },
    {
        "content": "<blockquote>\n<p>I don't get this. a.func(b),  a is the scope for b. but not for union?</p>\n</blockquote>\n<p>That is how I read the definitions, yes. How else can <code>a | b</code> and <code>a.union(b)</code> be equivalent? It's obvious in the former expression that the context for <code>b</code> is the same as the context for <code>a</code>.</p>",
        "id": 277225730,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1648693611
    },
    {
        "content": "<p>I don’t see a as the scope for b, a is just an argument, just like b, they are independent of eachother.</p>",
        "id": 277226616,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1648694685
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191316\">Grahame Grieve</span> <a href=\"#narrow/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60/near/277223680\">said</a>:</p>\n<blockquote>\n<p>I don't get this. a.func(b),  a is the scope for b. but not for union?</p>\n</blockquote>\n<p>Maybe in <code>a.func(b)</code> a only becomes the scope for b (one at a time) when func takes and <code>expression</code> (as in <code>repeat</code>) and not a <code>collection</code> (as in <code>union</code>)?</p>",
        "id": 277289630,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1648736815
    },
    {
        "content": "<p><code>union</code> not the only case of this, right?  Should <code>Patient.telecom.use.subsetOf(use)</code> return true?</p>",
        "id": 277290031,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1648736981
    },
    {
        "content": "<p>That's an interesting framing, re: expressions vs collections as arguments. I think it makes sense, though I have not thought through all of the implications.</p>\n<p>(I think your specific subset example is challenging though: if you thought the context for evaluating the argument to the subsetOf function was <code>use</code>, you'd then be evaluating <code>use.use</code>, which wouldn't make sense.)</p>",
        "id": 277296052,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1648739477
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191315\">Josh Mandel</span> <a href=\"#narrow/stream/179266-fhirpath/topic/Context.20for.20.60.2Eunion.60/near/277296052\">said</a>:</p>\n<blockquote>\n<p>(I think your specific subset example is challenging though: if you thought the context for evaluating the argument to the subsetOf function was <code>use</code>, you'd then be evaluating <code>use.use</code>, which wouldn't make sense.)</p>\n</blockquote>\n<p>Yes, my question is whether <code>Patient.telecom.use.subsetOf(use)</code> should work, just like (I think) you and Bryn are saying <code>Patient.telecom.use.union(use)</code> should work.</p>",
        "id": 277298175,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1648740323
    },
    {
        "content": "<p>I am aware of two possible interpretations:</p>\n<ol>\n<li><code>a.b.someFunc(c)</code> evaluates <code>c</code> in the same context that it evaluated <code>a</code> (this is how <code>.union</code> presumably works, and perhaps all functions that take a collection for their argument)</li>\n<li><code>a.b.someFunc(c)</code> evaluates <code>b</code> in the context of elements of the <code>a.b</code> collection (this is how <code>.where</code> presumably works, and perhaps all functions that take an expression for their argument)</li>\n</ol>\n<p>... but I don't see how <code>Patient.telecom.use.subsetOf(use)</code> makes sense in <em>either</em> of these intepretations. (Under (1), the \"use\" argument would be looking for <code>Patient.use</code>, and  under (2), the \"use\" argument would be looking for <code>Patient.telecom.use.use</code> -- and neither of these exists.)</p>",
        "id": 277310538,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1648745830
    },
    {
        "content": "<p>Using the union example, wouldn't you say <code>a.b.union(c)</code> is equivalent to <code>a.b | a.c</code> ?  I did drop the select() call from the original example, which might make a difference.</p>",
        "id": 277325693,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1648753229
    },
    {
        "content": "<p>Wow, good question. I was assuming <code>a.b | c</code>. What do others expect?</p>",
        "id": 277326601,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1648753693
    },
    {
        "content": "<p>After some more thought about the effect of select(), I think if one wants the union of a.b and a.c one could write <code>a.select(b | c)</code>, or <code>a.select(b.union(c))</code>,  or <code>a.b.union(a.c)</code>, but not <code>a.b.union(c)</code>.</p>",
        "id": 277326673,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1648753743
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span> I'm having trouble with this:</p>\n<blockquote>\n<p>I don’t see a as the scope for b, a is just an argument, just like b, they are independent of each other.</p>\n</blockquote>\n<p><code>Patient.name.exists(use = 'nickname')</code> - the scope of use is name<br>\n<code>name.select(use.union(given))</code> - the scope of given is name, not use</p>\n<p>I don't have any magic that can make this happen in my code unless I make a special rule for union. Or unless I'm just missing the point here</p>",
        "id": 277338113,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1648759820
    },
    {
        "content": "<p>The only difference I can see is that union takes a \"collection\" while exists takes an \"expression\".</p>",
        "id": 277338907,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1648760250
    },
    {
        "content": "<p>Consider a similar example:<br>\n<code>name.select(use.contains(given))</code><br>\nThe scope of <code>given</code> is still <code>name</code> (and that scope was introduced by the <code>select</code>)</p>",
        "id": 277341521,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1648761515
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> , does your engine have the same issue with this example?</p>",
        "id": 277341596,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1648761574
    },
    {
        "content": "<p>yes it does. For the same reason. Because scope works consistently for me</p>",
        "id": 277348462,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1648765711
    },
    {
        "content": "<p>To be clear, Grahame -- are you saying your engine's behavior reflects the behavior you <em>would like</em> the standard to specify?</p>",
        "id": 277350656,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1648767175
    },
    {
        "content": "<p>I think if we are going to have some functions setting the scope while others do not, there needs to be a clearly stated explanation of why that is.</p>",
        "id": 277354762,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1648770532
    },
    {
        "content": "<p>The <a href=\"https://hl7.org/fhirpath/#functions\">Functions</a> section specifies that if an argument is typed as an <code>expression</code>, then the function will evaluate the input expression with respect to each item in the input collection, and that these expressions are allowed to refer to the <code>$this</code> and <code>$index</code> variables. We don't explicitly call that a <code>scope</code>, but that is what I've been calling a <code>scope</code> in this discussion. In the CQL engine this is implemented with a runtime stack, and functions that introduce a scope push a $this variable onto that stack, and that variable is allowed to resolve implicitly.</p>",
        "id": 277433715,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1648826271
    },
    {
        "content": "<p>To me, the implication of that language is that attempting to access <code>$this</code> outside the context of an expression-type argument is an error. Grahame, are you saying that in your engine, I could say: <code>Patient.name.$this</code> and the reference to <code>$this</code> would be allowed, and would return the name?</p>",
        "id": 277434943,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1648826748
    },
    {
        "content": "<p>no I don't have an issue with expressions and $this, I have an issue that you've described a particular behavior that I don't understand around scope.</p>",
        "id": 277718701,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1649072973
    },
    {
        "content": "<p>as far I understand, you're saying that scope works differently for these:</p>\n<p><code>Patient.name.exists(use = 'nickname')</code><br>\n<code>name.select(use.union(given))</code></p>\n<p>but I don't know why you think that they're different. My engine can't differentiate them</p>",
        "id": 277718839,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1649073050
    },
    {
        "content": "<p>They are different because <code>union()</code> doesn't have arguments of type <code>expression</code>. In other words, the arguments to union can both be evaluated prior to invoking the union. Whereas the <code>expression</code> arguments to <code>exists()</code> and <code>select()</code> are evaluated iteratively within the functions.</p>",
        "id": 277797834,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1649108574
    },
    {
        "content": "<p>I don't follow. to me that's not relevant to my question. In the first case, \"use\" as parameter to exists() has a scope of name - the thing on which .exists is called. But the in the second case, the parameter to union() does not have the scope of 'use' but of name. Why is that different? I don't see that the .select() bit makes any difference to the evaluation there</p>",
        "id": 277799086,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1649109263
    },
    {
        "content": "<p><code>use</code> isn't a parameter to the <code>exists()</code> in this example, the expression <code>use = 'nickname'</code> is the parameter. And the reason the <code>select()</code> bit makes a difference is because it's a function with an <code>expression</code> type parameter. Functions that don't have <code>expression</code> type parameters don't introduce an iteration scope.</p>",
        "id": 277808363,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1649115316
    },
    {
        "content": "<p>I had missed that about exists() in my head and in my code</p>",
        "id": 277825794,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1649132187
    }
]