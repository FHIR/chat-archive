[
    {
        "content": "<p>Hi All,</p>\n<p>We're trying to validate the CarePlan below across all the public test servers. <code>[baseurl]/CarePlan/$validate?profile=http://hl7.org/fhir/StructureDefinition/CarePlan</code></p>\n<p>HAPI FHIR, Aegis WildFHIR, <a href=\"http://test.fhir.org\" target=\"_blank\" title=\"http://test.fhir.org\">test.fhir.org</a> all report that this resource is OK.</p>\n<p>However, vonk says that</p>\n<div class=\"codehilite\"><pre><span></span>    {\n      &quot;severity&quot;: &quot;error&quot;,\n      &quot;code&quot;: &quot;invariant&quot;,\n      &quot;details&quot;: {\n        &quot;coding&quot;: [\n          {\n            &quot;system&quot;: &quot;http://hl7.org/fhir/dotnet-api-operation-outcome&quot;,\n            &quot;code&quot;: &quot;1012&quot;\n          }\n        ],\n        &quot;text&quot;: &quot;Instance failed constraint tim-9 \\&quot;If there&#39;s an offset, there must be a when (and not C, CM, CD, CV)\\&quot;&quot;\n      },\n      &quot;diagnostics&quot;: &quot;offset.empty() or (when.exists() and ((when in (&#39;C&#39; | &#39;CM&#39; | &#39;CD&#39; | &#39;CV&#39;)).not()))&quot;,\n      &quot;location&quot;: [\n        &quot;CarePlan.activity[1].detail[0].scheduledTiming[0].repeat[0]&quot;\n      ]\n    }\n</pre></div>\n\n\n<p>I believe this is triggered by the <code>when in ...</code> part of the FHIRPath expression. I looked at the spec here: <a href=\"http://hl7.org/fhirpath/N1/index.html#in-membership\" target=\"_blank\" title=\"http://hl7.org/fhirpath/N1/index.html#in-membership\">http://hl7.org/fhirpath/N1/index.html#in-membership</a> and it says that \"If the left operand has multiple items, an exception is thrown.\" I can verify this is the case since if I change <code>when</code> to only contain a single value, vonk reports the validation didn't find any errors.</p>\n<p>Since <code>when</code> indeed contains multiple items in this case, I believe Vonk is right and the others wrong. Can anyone comment and confirm on what is the correct behavior?</p>\n<p>Note: The description for the <code>in</code> operator seems to have been unchanged since version <a href=\"http://hl7.org/fhirpath/2018May/index.html#collections-2\" target=\"_blank\" title=\"http://hl7.org/fhirpath/2018May/index.html#collections-2\">http://hl7.org/fhirpath/2018May/index.html#collections-2</a></p>\n<p>This would mean FHIR STU3 and R4 are affected.</p>\n<p>I would guess the implementations of <code>contains</code> operator are affected as well.</p>\n<div class=\"codehilite\"><pre><span></span>{\n    &quot;resourceType&quot;: &quot;CarePlan&quot;,\n    &quot;id&quot;: &quot;example&quot;,\n    &quot;text&quot;: {\n        &quot;status&quot;: &quot;additional&quot;,\n        &quot;div&quot;: &quot;&lt;div xmlns=\\&quot;http://www.w3.org/1999/xhtml\\&quot;&gt;test careplan&lt;/div&gt;&quot;\n    },\n    &quot;status&quot;: &quot;active&quot;,\n    &quot;intent&quot;: &quot;plan&quot;,\n    &quot;subject&quot;: {\n        &quot;reference&quot;: &quot;Patient/123&quot;\n    },\n    &quot;activity&quot;: [\n        {\n            &quot;reference&quot;: {\n                &quot;display&quot;: &quot;Prenatal vitamin MedicationRequest&quot;\n            }\n        },\n        {\n            &quot;detail&quot;: {\n                &quot;kind&quot;: &quot;Appointment&quot;,\n                &quot;code&quot;: {\n                    &quot;coding&quot;: [\n                        {\n                            &quot;system&quot;: &quot;http://example.org/mySystem&quot;,\n                            &quot;code&quot;: &quot;1an&quot;\n                        }\n                    ],\n                    &quot;text&quot;: &quot;First Antenatal encounter&quot;\n                },\n                &quot;status&quot;: &quot;scheduled&quot;,\n                &quot;doNotPerform&quot;: false,\n                &quot;scheduledTiming&quot;: {\n                    &quot;repeat&quot;: {\n                        &quot;boundsPeriod&quot;: {\n                            &quot;start&quot;: &quot;2013-02-14&quot;,\n                            &quot;end&quot;: &quot;2013-02-28&quot;\n                        },\n                        &quot;offset&quot;: 1,\n                        &quot;when&quot;: [\n                            &quot;ACM&quot;,\n                            &quot;AC&quot;\n                        ]\n                    }\n                },\n                &quot;description&quot;: &quot;The first antenatal encounter. This is where a detailed physical examination is performed.             and the pregnanacy discussed with the mother-to-be.&quot;\n            }\n        }\n    ]\n}\n</pre></div>",
        "id": 188987436,
        "sender_full_name": "Michael Calderero",
        "timestamp": 1582599486
    },
    {
        "content": "<p>you're right. I don't think that the definition of opIn and opContains are correct, in that a set can still be in another set (<span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span>) and that's how I implemented it. The invariant is definitely wrong given the FHIRPath definition. Added here: <a href=\"https://confluence.hl7.org/display/FHIR/Known+Issues+with+the+published+FHIR+Specifications\" target=\"_blank\" title=\"https://confluence.hl7.org/display/FHIR/Known+Issues+with+the+published+FHIR+Specifications\">https://confluence.hl7.org/display/FHIR/Known+Issues+with+the+published+FHIR+Specifications</a></p>",
        "id": 188988191,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1582600772
    },
    {
        "content": "<p>Hmmm... don't you still need to be able to ask if a list is in a list of lists? If we add an overload of <code>in</code> to take a list for both operands, we wouldn't be able to distinguish that case, right? We defined <code>in(T, List&lt;T&gt;)</code> and <code>contains(List&lt;T&gt;, T)</code>. I think to properly support this use case, we'd need list-level operations: <code>includedIn(List&lt;T&gt;, List&lt;T&gt;)</code> and <code>includes(List&lt;T&gt;, List&lt;T&gt;)</code>.</p>",
        "id": 188989268,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1582602549
    },
    {
        "content": "<p>I guess</p>",
        "id": 188989324,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1582602612
    }
]