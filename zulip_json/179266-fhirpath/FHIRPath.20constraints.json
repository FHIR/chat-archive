[
    {
        "content": "<p>Hi, I have a question about FHIRPath constraints. When a constraint evaluates to an empty collection does that imply that the constraint is not satisfied (i.e. should it be treated as if it evaluated to false)?</p>\n<p>Specifically, FHIR's Bundle.entry has a constraint, fullUrl.contains('/_history/').not(), that will evaluate to an empty collection when fullUrl is not specified on the entry. In this case, I believe I have to treat the empty collection the same as \"true\" since transactions and batches aren't required to have a fullUrl. However, this goes against my intuition that constraints should explicitly evaluate to true in order to be considered satisfied.</p>",
        "id": 185857572,
        "sender_full_name": "Aaron Nash",
        "timestamp": 1579207268
    },
    {
        "content": "<p>empty collection is false, and I think that expression is in error.</p>",
        "id": 185876251,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1579220262
    },
    {
        "content": "<p>Thank you, Grahame. I'm new to the FHIR community. Are there any steps I can take to help fix the constraint in the spec?</p>",
        "id": 185939187,
        "sender_full_name": "Aaron Nash",
        "timestamp": 1579282723
    },
    {
        "content": "<p>You can sign up to HL7's Jira site (<a href=\"http://jira.hl7.org\" target=\"_blank\" title=\"http://jira.hl7.org\">http://jira.hl7.org</a>) and submit a change request here: <a href=\"https://jira.hl7.org/projects/FHIR\" target=\"_blank\" title=\"https://jira.hl7.org/projects/FHIR\">https://jira.hl7.org/projects/FHIR</a></p>",
        "id": 185940148,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1579283409
    },
    {
        "content": "<p>Reported: <a href=\"https://jira.hl7.org/browse/FHIR-25525\" target=\"_blank\" title=\"https://jira.hl7.org/browse/FHIR-25525\">https://jira.hl7.org/browse/FHIR-25525</a></p>",
        "id": 185954168,
        "sender_full_name": "Aaron Nash",
        "timestamp": 1579293304
    },
    {
        "content": "<p>We are running into this again in some other places. Consider <a href=\"http://Questionnaire.name\" target=\"_blank\" title=\"http://Questionnaire.name\">Questionnaire.name</a>. The constraint on this field is <code>name.matches('[A-Z]([A-Za-z0-9_]){0,254}')</code> in FHIRPath, but in XPath it's <code>not(exists(f:name/@value)) or matches(f:name/@value, '[A-Z]([A-Za-z0-9_]){0,254}')</code>. To me this shows pretty clearly that the FHIRPath should have an <code>exists()</code> check. In the case mentioned previously by Aaron, the XPath is <code>not(exists(f:fullUrl[contains(string(@value), '/_history/')]))</code>. Again XPath has an <code>exists()</code> check and FHIRPath does not. It is possible that there are more examples in the StructureDefinitions of XPath treating missing fields correctly with <code>exists()</code> where FHIRPath does not?</p>",
        "id": 186921615,
        "sender_full_name": "Nik Klassen",
        "timestamp": 1580327190
    },
    {
        "content": "<p>it is possible</p>",
        "id": 186922983,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1580328028
    },
    {
        "content": "<p>Is the best thing to do just file bugs for every expression we find?</p>",
        "id": 186926310,
        "sender_full_name": "Nik Klassen",
        "timestamp": 1580330314
    },
    {
        "content": "<p>sure is</p>",
        "id": 186926935,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1580330719
    },
    {
        "content": "<p>are constraint[n].expression and are constraint[n].xpath both tested? should one (presumably the former) be considered authoritative?</p>",
        "id": 243115849,
        "sender_full_name": "Eric Prud'hommeaux",
        "timestamp": 1623991265
    },
    {
        "content": "<p>I assume that .expression gets code-gen'd into java classes for run-time checks and .xpath is only used if you're e.g. building schematron rules</p>",
        "id": 243115914,
        "sender_full_name": "Eric Prud'hommeaux",
        "timestamp": 1623991341
    },
    {
        "content": "<p>expression is authoritative. We can say things using FHIRpath that aren't possible in XPath, and also, XPath only applies the XML serialization</p>",
        "id": 243116106,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1623991623
    },
    {
        "content": "<p>ack. is .xpath tested or is it caveat emptor?</p>",
        "id": 243116171,
        "sender_full_name": "Eric Prud'hommeaux",
        "timestamp": 1623991702
    },
    {
        "content": "<p>not tested to the same degree. I think I parse them all, but I'm not sure that they are correct statements</p>",
        "id": 243116205,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1623991796
    },
    {
        "content": "<p>i can imagine that .expression is compiled into java code which is executed during ingestion in hapi, which is then tested against the corpus of examples.<br>\ni can also imagine that the .xpath is translated into Schematron, which <em>could</em> be tested against the corpus of XML examples, but probably isn't.</p>",
        "id": 243116436,
        "sender_full_name": "Eric Prud'hommeaux",
        "timestamp": 1623992025
    },
    {
        "content": "<p>those seem about right?</p>",
        "id": 243116444,
        "sender_full_name": "Eric Prud'hommeaux",
        "timestamp": 1623992037
    },
    {
        "content": "<p>close: not compiled; there's a run time engine that executes FHIRPath</p>\n<p>Schematron is generated, yes. And I do test it, but somehow the testing is deficient because people report expression issues that they don't against the FHIRPath - so inspecting my testing is on the to do list</p>",
        "id": 243117054,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1623992803
    },
    {
        "content": "<p>I have on occasion (generally before a publication) run the XSLT that results from the XPath schematrons through Saxon SA (when I happen to have a licensed version that doesn't blow up on our schemas).  That at least checks that the elements and paths we're navigating are legitimate.  It doesn't check that the rules are enforced correctly though.</p>",
        "id": 243820494,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1624556276
    }
]