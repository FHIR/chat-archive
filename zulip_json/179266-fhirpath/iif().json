[
    {
        "content": "<p>Hey folks, I'm looking at the FHIRPath spec and cannot seem to reconcile what's written with the behavior I see in fhirpath.js.</p>\n<p>The spec's definition is <code>iif(criterion: expression, true-result: collection [, otherwise-result: collection]) : collection</code></p>\n<p>When I use fhirpath.js I see <code>Patient.address.first().text.iif(contains('Rainbow'), $this, {}))</code> return <code>'534 Erewhon St PeasantVille, Rainbow, Vic  3999'</code> yet I would expect the result to be the Patient resource. Is the implementation wrong or I am misunderstanding something about the spec. I would expect <code>true-result</code> to have an <code>expression</code> type in order to see the behavior I'm seeing.</p>",
        "id": 225362667,
        "sender_full_name": "Aaron Nash",
        "timestamp": 1612561939
    },
    {
        "content": "<p>$this is the 'current context node', which in this case is the first repetition of address.text.  If you want to return the context resource, use <code>%resource</code></p>",
        "id": 225363951,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1612562645
    },
    {
        "content": "<p>That seems wrong to me. Take for example <code>Patient.address.first().text.union($this)</code> that returns <code>'534 Erewhon St PeasantVille, Rainbow, Vic  3999' | Patient</code> Both the first parameter of <code>union</code> and the second parameter of <code>iif </code> are of type <code>collection</code> Why would they have different results?</p>",
        "id": 225364479,
        "sender_full_name": "Aaron Nash",
        "timestamp": 1612562913
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> <span class=\"user-mention\" data-user-id=\"195344\">@Paul Lynch</span> <span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span></p>",
        "id": 225364718,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1612563032
    },
    {
        "content": "<p>From <a href=\"http://hl7.org/fhirpath/#functions\">http://hl7.org/fhirpath/#functions</a>:</p>",
        "id": 225368680,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1612565509
    },
    {
        "content": "<blockquote>\n<p>If the function takes an expression as a parameter, the function will evaluate the expression passed for the <br>\nparameter with respect to each of the items in the input collection. These expressions may refer to the special $this and $index elements, which represent the item from the input collection currently under evaluation, and its index in the collection, respectively.</p>\n</blockquote>\n<p>The function iif takes an expression as its first parameter, so $this gets set each item in turn in the array to which iif is applied.</p>",
        "id": 225368697,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1612565513
    },
    {
        "content": "<p>I would expect the spec to say \"If the function takes an expression as a parameter, the function will evaluate the expression passed for <strong>every</strong> parameter with respect to each of the items in the input collection\" or something along those lines if that applied to every parameter. Separately, if that's the behavior we expect shouldn't the signature be <code>iif(criterion: expression, true-result: expression [, otherwise-result: expression]) : collection</code> and not <code>iif(criterion: expression, true-result: collection [, otherwise-result: collection]) : collection</code></p>",
        "id": 225370249,
        "sender_full_name": "Aaron Nash",
        "timestamp": 1612566582
    },
    {
        "content": "<p>It doesn't say every parameter has to be an expression; it is enough that one of them is.  That's how I read it, anyway.  <span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span> ?</p>",
        "id": 225540943,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1612789633
    },
    {
        "content": "<p>Only the arguments indicated as <code>expression</code> are iterated. It's not clear what the behavior would mean otherwise, cartesian product? In fact, it's not clear to me in any of these examples that the <code>$this</code> reference is well defined? $this is only accessible within an iteration context.</p>",
        "id": 225548540,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1612793266
    },
    {
        "content": "<p>is iif iterated though? I wouldn't expect to get multiple true/false results from an iif expression</p>",
        "id": 225557605,
        "sender_full_name": "ryan moehrke",
        "timestamp": 1612797134
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"237342\">@ryan moehrke</span>  Good point. Immediately above description for iif, it says, \"The functions in this section operate on collections with a single item. If there is more than one item, the evaluation of the expression will end and signal an error to the calling environment.\"  fhirpath.js throws an error for more than one argument.... but it still sets \"iterates\" over the one item and sets \"$this\", because it takes an expression.</p>\n<div class=\"codehilite\"><pre><span></span><code>(3).iif($this&gt;1, &#39;a&#39;, &#39;b&#39;) =&gt; [&#39;a&#39;]\n</code></pre></div>",
        "id": 225565807,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1612800443
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span> fhirpath.js' implementation views that iteration context at the iif call, not just its argument, so that when $this is set, the same value is available to any of the arguments, not just the expression argument.</p>",
        "id": 225566899,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1612800847
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"195344\">@Paul Lynch</span> , that's a reasonable interpretation given it's a singleton function, I'm looking at what the CQL engine would do here and I think it's actually aligned with the JS engine there. <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> , does the FHIRPath engine support the true-result and otherwise-result arguments to iif as expressions with access to the iteration context?</p>",
        "id": 225572037,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1612802718
    },
    {
        "content": "<p>To separate out the discussion regarding the appropriate use of $this from the original inquiry, you could replace $this in my original examples with first(). That is, <code>Patient.address.first().text.iif(contains('Rainbow'), first(), {}))</code>and <code>Patient.address.first().text.union(first())</code></p>",
        "id": 225590759,
        "sender_full_name": "Aaron Nash",
        "timestamp": 1612810575
    },
    {
        "content": "<p>Nonetheless, Bryn's last question is a good summary of what I'm asking.</p>",
        "id": 225590983,
        "sender_full_name": "Aaron Nash",
        "timestamp": 1612810676
    },
    {
        "content": "<p>Patient.where(address.first().text.contains('Rainbow'))<br>\nPatient.where(address.text.where(contains('Rainbow'))) if you want any address that contains Rainbow<br>\niif(Patient.address.first().text.contains('Rainbow'), Patient, {})) if you really want to use iif<br>\nshould all work for your usecase too (fhirpath has a lot of options)</p>",
        "id": 225591910,
        "sender_full_name": "ryan moehrke",
        "timestamp": 1612811048
    },
    {
        "content": "<p>Thanks, Ryan. To be clear, my issue isn't about \"how do I do this particular thing\" but, rather, what does the spec say should happen in this particular situation.</p>",
        "id": 225607389,
        "sender_full_name": "Aaron Nash",
        "timestamp": 1612817969
    }
]