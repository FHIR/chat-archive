[
    {
        "content": "<p>Yes, open JIRAs please, that clarification is supposed to be on each function, but apparently we missed some.</p>",
        "id": 275591971,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1647474768
    },
    {
        "content": "<p>Actually one JIRA would be fine with all of them listed</p>",
        "id": 275591984,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1647474780
    },
    {
        "content": "<p>But to answer the question, length() expects a singleton. Basically, unless the function is something that will by it's nature iterate over the items in the collection (like .where, .select, etc), then it's a singleton. Another way to think about it is if you would have to supply collection semantics, then it's a singleton. For example, in .length(), what should it do if it gets multiple items? Compute the total length or return the length of each?</p>",
        "id": 275592105,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1647474888
    },
    {
        "content": "<p>I think i'll do 2 issues:  one for fhirpath and one for fhir.  its actually the latter one that defines <code>memberOf</code> which was the original function that raised this question</p>",
        "id": 275660298,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1647527079
    },
    {
        "content": "<blockquote>\n<p>if you would have to supply collection semantics, then it's a singleton...<br>\nFor example, in .length(), what should it do if it gets multiple items?</p>\n</blockquote>\n<p>That matches our implementation, but the verbiage in the spec about all functions operating over collections got me worried that maybe we had it wrong.</p>",
        "id": 275660396,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1647527117
    },
    {
        "content": "<p>I think the alternative would be for any function that operates over singletons to instead apply the function for each input element and produce a 1-to-1 mapping to the output collection.<br>\nFor example, for <code>length()</code> it <em>could</em> execute the function against <em>each</em> string in the input collection and return a collection of integers.</p>\n<p>Personally, I think that interpretation would have some nice properties.<br>\nBecause the current FHIRPath specification requires FHIRPath authors to be super-aware of any repeating elements in the model.<br>\nThis is probably the number 1 mistake I've seen with FHIRPath expressions \"in the wild\".</p>",
        "id": 275661140,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1647527401
    },
    {
        "content": "<p>Has anything like that ever been considered?</p>",
        "id": 275661208,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1647527418
    },
    {
        "content": "<blockquote>\n<p>This is probably the number 1 mistake I've seen with FHIRPath expressions \"in the wild\".</p>\n</blockquote>\n<p>One thing that contributes to that issue is that I think most engines will happily execute the function if you apply it to a resource such that only a single element is present.<br>\nThat leads to issues like <a href=\"https://jira.hl7.org/browse/FHIR-36328\">https://jira.hl7.org/browse/FHIR-36328</a> where the expression seems to work for some input (e.g. when the repeating element is only there once) but then fails when you try applying it to a resource that has more than a single instance of the repeating element.</p>",
        "id": 275662281,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1647527851
    },
    {
        "content": "<p>Do any of the engines / other tools warn users when they use singleton functions against a model that could lead to multiple inputs?</p>",
        "id": 275662458,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1647527921
    },
    {
        "content": "<p>Yes.  <a href=\"https://hl7.github.io/fhirpath.js/\">https://hl7.github.io/fhirpath.js/</a>.  ('aaa'| 'zzz').length()   =&gt; <code>Error: Unexpected collection[\"aaa\",\"zzz\"]; expected singleton of type String</code></p>",
        "id": 275662776,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1647528056
    },
    {
        "content": "<p>I mean if you have an expression like <code>Observation.component.value is string</code> (just an example off the top of my head)</p>",
        "id": 275663337,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1647528253
    },
    {
        "content": "<p>that will execute on any Observations with 0 or 1 components</p>",
        "id": 275663402,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1647528275
    },
    {
        "content": "<p>but if you run that against an Observation with 2 components... kablooey</p>",
        "id": 275663445,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1647528298
    },
    {
        "content": "<p>it would be interesting to use model-awareness to warn FHIRPath authors about that</p>",
        "id": 275663480,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1647528315
    },
    {
        "content": "<p>Yes, a warning in such cases could be helpful.</p>",
        "id": 275664337,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1647528635
    },
    {
        "content": "<p>When you evaluate FHIRPath expressions in CQL, the translator does this with a \"list demotion\" and will issue a warning whenever it happens, yes.</p>",
        "id": 275667427,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1647529743
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191676\">Lee Surprenant</span> <a href=\"#narrow/stream/179266-fhirpath/topic/should.20all.20functions.20work.20on.20repeating.20fields.3F/near/275660298\">said</a>:</p>\n<blockquote>\n<p>I think i'll do 2 issues:  one for fhirpath and one for fhir.  its actually the latter one that defines <code>memberOf</code> which was the original function that raised this question</p>\n</blockquote>\n<p><a href=\"http://jira.hl7.org/browse/FHIR-36335\">FHIR-36335</a> (fhirpath) and <a href=\"http://jira.hl7.org/browse/FHIR-36334\">FHIR-36334</a> (fhir)</p>",
        "id": 275706398,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1647541951
    }
]