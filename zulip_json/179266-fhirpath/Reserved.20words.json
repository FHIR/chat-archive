[
    {
        "content": "<p><a href=\"http://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=23073\" target=\"_blank\" title=\"http://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=23073\">GF#23073</a> - I'm interested in comment on this. I agree with the comment in the resolution, but I'm not convinced that it's conformant</p>",
        "id": 177199304,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1570055928
    },
    {
        "content": "<p>I discussed this one with <span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span>  and Ewout for a bit after connectathon.  <span class=\"user-mention\" data-user-id=\"191328\">@Ewout Kramer</span> said they had to work around this violation of the fhirpath grammar in their implementation as well.  I think he's out now, but perhaps someone else can fill in for him on that side?</p>",
        "id": 177199573,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1570056190
    },
    {
        "content": "<p>I've also had pretty extensive discussion with <span class=\"user-mention\" data-user-id=\"192334\">@John Timm</span> on this one and here were my notes:</p>\n<ol>\n<li><a href=\"http://hl7.org/fhirpath/2018Sep/index.html#keywords\" target=\"_blank\" title=\"http://hl7.org/fhirpath/2018Sep/index.html#keywords\">http://hl7.org/fhirpath/2018Sep/index.html#keywords</a> says \"In general, keywords within FHIRPath are also considered reserved words, meaning that it is illegal to use them as identifiers. If necessary, identifiers that clash with a reserved word can be quoted.\"</li>\n</ol>",
        "id": 177200175,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1570056827
    },
    {
        "content": "<p>that's not the same as 'must'</p>",
        "id": 177200248,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1570056875
    },
    {
        "content": "<p>was gonna add more points from my notes, but they are sort of contingent on keywords being reserved / illegal as identifiers :-)</p>",
        "id": 177200778,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1570057395
    },
    {
        "content": "<p>agree that language is unusually loose</p>",
        "id": 177200788,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1570057406
    },
    {
        "content": "<blockquote>\n<p>In general, keywords within FHIRPath are also considered reserved words, meaning that it is illegal to use them as identifiers.</p>\n</blockquote>\n<p>does it mean <br>\n\"keywords are generally considered to be reserved words and therefor it is always illegal to use them as identifiers\" <br>\nOR<br>\n\"keywords are usually considered to be reserved words and therefor should be generally avoided as identifiers (but not required to be quoted)\"</p>",
        "id": 177201006,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1570057595
    },
    {
        "content": "<p>yes</p>",
        "id": 177201368,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1570057915
    },
    {
        "content": "<p>Yes, that language could definitely be clarified. The intent of that wording was to allow for the fact that the grammar defines the <code>in</code>, <code>is</code>, <code>as</code>, and <code>contains</code> keywords as possible identifiers, specifically because they are also function names and so need to be available as identifiers.</p>",
        "id": 177208845,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1570068010
    },
    {
        "content": "<p>+1 to clarify the language. My biggest concern is that there are structure definitions that include constraints with FHIRPath expressions that do not escape some of the problematic keywords (i.e. <code>div</code> and <code>contains</code>). Even if it is a SHOULD and not a SHALL, I think that the base specification should observe some sort of best practice when specifying constraints in a StructureDefinition. Otherwise its left up to the implementer to address. -- especially if the published ANLR grammar is used as a basis for an expression parser. The grammar will not work out-of-the-box unless identifiers that conflict with keywords are delimited.</p>",
        "id": 177246854,
        "sender_full_name": "John Timm",
        "timestamp": 1570111289
    },
    {
        "content": "<p>The grammar explicitly defines <code>contains</code>, <code>in</code>, <code>is</code>, and <code>as</code> as keywords, so they do not need to be escaped in paths. <code>div</code>, <code>mod</code>, <code>and</code>, <code>or</code>, <code>xor</code>, and <code>implies</code> would need to be escaped, but there are no function name clashes with any of those keywords. Are there any element name clashses?</p>",
        "id": 177257825,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1570117842
    },
    {
        "content": "<p>And I just validated to be sure, the constraint expression referenced in the above tracker _does_ parse correctly: <code>ValueSet.expansion.contains.code</code></p>",
        "id": 177257864,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1570117884
    },
    {
        "content": "<blockquote>\n<p><code>ValueSet.expansion.contains.code</code></p>\n</blockquote>\n<p>That also works in fhirpath.js, which generates its parser from the grammar.</p>",
        "id": 177258126,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1570118057
    },
    {
        "content": "<p><a href=\"http://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=24895\" target=\"_blank\" title=\"http://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=24895\">GF#24895</a> to clarify the language</p>",
        "id": 177259995,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1570119208
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span>  Let me clarify my previous comments by providing more detail. I am using an ANLR4 generated Java parser and the expression <code>ValueSet.expansion.contains.code</code> causes issues after it is parsed into an abstract syntax tree. If you process the AST using the generated parse tree visitor, it will incorrectly call <code>visitMembershipExpression(FHIRPathParser.MembershipExpressionContext ctx) </code> This tells me that it thinks that an unescaped <code>contains</code> identifier refers to the contains operator. It's pretty easy to replicate by downloading antlr and running it on fhirpath.g4. I could put together a unit test if you'd like.</p>",
        "id": 177276579,
        "sender_full_name": "John Timm",
        "timestamp": 1570129902
    },
    {
        "content": "<blockquote>\n<blockquote>\n<p><code>ValueSet.expansion.contains.code</code></p>\n</blockquote>\n<p>That also works in fhirpath.js, which generates its parser from the grammar.</p>\n</blockquote>\n<p>I just realized that fhirpath.js is still using the STU1 grammar file.  Perhaps differences between that and the new one account for why the above expression parses correctly for fhirpath.js but not for <span class=\"user-mention\" data-user-id=\"192334\">@John Timm</span>.</p>",
        "id": 177276964,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1570130083
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"192334\">@John Timm</span> , what version of the FHIRPath grammar file are you reproducing that with?</p>",
        "id": 177278376,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1570131027
    },
    {
        "content": "<p>If you're using this one: <a href=\"http://hl7.org/fhirpath/grammar.html\" target=\"_blank\" title=\"http://hl7.org/fhirpath/grammar.html\">http://hl7.org/fhirpath/grammar.html</a>, agreed, but that has been updated in the latest balloted version: <a href=\"http://hl7.org/fhirpath/2019May/grammar.html\" target=\"_blank\" title=\"http://hl7.org/fhirpath/2019May/grammar.html\">http://hl7.org/fhirpath/2019May/grammar.html</a></p>",
        "id": 177278549,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1570131136
    },
    {
        "content": "<p>Which is currently on track for normative publication.</p>",
        "id": 177278581,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1570131160
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span> The version I'm using is here:<br>\n<a href=\"http://hl7.org/fhirpath/2018Sep/grammar.html\" target=\"_blank\" title=\"http://hl7.org/fhirpath/2018Sep/grammar.html\">http://hl7.org/fhirpath/2018Sep/grammar.html</a></p>",
        "id": 177278606,
        "sender_full_name": "John Timm",
        "timestamp": 1570131189
    },
    {
        "content": "<p>Yeah, that one still has the issue, it was found and addressed as part of the most recent ballot.</p>",
        "id": 177278651,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1570131236
    },
    {
        "content": "<p>Apologies, I should have guessed that was what was going on. :(</p>",
        "id": 177278703,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1570131246
    },
    {
        "content": "<p>Okay, what has changed in the latest version that addresses the issue?</p>",
        "id": 177278708,
        "sender_full_name": "John Timm",
        "timestamp": 1570131251
    },
    {
        "content": "<p>I will be sure to upgrade ASAP.</p>",
        "id": 177278728,
        "sender_full_name": "John Timm",
        "timestamp": 1570131264
    },
    {
        "content": "<p>The <code>identifier</code> production rule:</p>\n<div class=\"codehilite\"><pre><span></span>identifier\n        : IDENTIFIER\n        | DELIMITEDIDENTIFIER\n        | &#39;as&#39;\n        | &#39;contains&#39;\n        | &#39;in&#39;\n        | &#39;is&#39;\n        ;\n</pre></div>",
        "id": 177278752,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1570131285
    },
    {
        "content": "<p>It specifically calls out <code>contains</code> and <code>in</code>, where in previous versions, we had only called out <code>is</code> and <code>as</code>.</p>",
        "id": 177278796,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1570131310
    },
    {
        "content": "<p>Nice</p>",
        "id": 177278816,
        "sender_full_name": "John Timm",
        "timestamp": 1570131327
    },
    {
        "content": "<p>I think <code>div</code> has the same problem</p>",
        "id": 177278845,
        "sender_full_name": "John Timm",
        "timestamp": 1570131352
    },
    {
        "content": "<p>as <code>div</code> is an operator and used in a Narrative constraint</p>",
        "id": 177278933,
        "sender_full_name": "John Timm",
        "timestamp": 1570131386
    },
    {
        "content": "<p>Ah, because Narrative has a div element.</p>",
        "id": 177279244,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1570131554
    },
    {
        "content": "<p>I wasn't aware of that clash. In that invariant, yes, div would need to be escaped.</p>",
        "id": 177279266,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1570131565
    },
    {
        "content": "<p>Added this as followup to that tracker.</p>",
        "id": 177279680,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1570131811
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span> Thank you!</p>",
        "id": 177280708,
        "sender_full_name": "John Timm",
        "timestamp": 1570132382
    },
    {
        "content": "<p>which constraint is this? I don't see it?</p>",
        "id": 177289794,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1570137878
    },
    {
        "content": "<p>DomainResource: dom-6</p>",
        "id": 177291939,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1570139453
    },
    {
        "content": "<p>if someone will make a task, I'll fix that one in the R4 technical correction</p>",
        "id": 177292911,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1570140204
    },
    {
        "content": "<p>And also txt-1 and txt-2 on Narrative</p>",
        "id": 177301563,
        "sender_full_name": "John Timm",
        "timestamp": 1570149830
    },
    {
        "content": "<p>I'm not seeing that</p>",
        "id": 177303190,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1570152070
    },
    {
        "content": "<p>I updated the proposed resolution to <a href=\"http://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=23073\" target=\"_blank\" title=\"http://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemEdit&amp;tracker_item_id=23073\">GF#23073</a> to update constraint dom-6 on DomainResource. Does that work or do you need a separate task?</p>",
        "id": 177306294,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1570157221
    },
    {
        "content": "<p>no that'll be fine</p>",
        "id": 177306360,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1570157342
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> Taken directly from the Narrative StructureDefinition:</p>\n<div class=\"codehilite\"><pre><span></span>            {\n                &quot;id&quot;: &quot;Narrative.div&quot;,\n                &quot;path&quot;: &quot;Narrative.div&quot;,\n                &quot;short&quot;: &quot;Limited xhtml content&quot;,\n                &quot;definition&quot;: &quot;The actual narrative content, a stripped down version of XHTML.&quot;,\n                &quot;comment&quot;: &quot;The contents of the html element are an XHTML fragment containing only the basic html formatting elements described in chapters 7-11 and 15 of the HTML 4.0 standard, &lt;a&gt; elements (either name or href), images and internally contained stylesheets. The XHTML content SHALL NOT contain a head, a body, external stylesheet references, scripts, forms, base/link/xlink, frames, iframes and objects.&quot;,\n                &quot;min&quot;: 1,\n                &quot;max&quot;: &quot;1&quot;,\n                &quot;base&quot;: {\n                    &quot;path&quot;: &quot;Narrative.div&quot;,\n                    &quot;min&quot;: 1,\n                    &quot;max&quot;: &quot;1&quot;\n                },\n                &quot;type&quot;: [\n                    {\n                        &quot;code&quot;: &quot;xhtml&quot;\n                    }\n                ],\n                &quot;constraint&quot;: [\n                    {\n                        &quot;key&quot;: &quot;txt-1&quot;,\n                        &quot;severity&quot;: &quot;error&quot;,\n                        &quot;human&quot;: &quot;The narrative SHALL contain only the basic html formatting elements and attributes described in chapters 7-11 (except section 4 of chapter 9) and 15 of the HTML 4.0 standard, &lt;a&gt; elements (either name or href), images and internally contained style attributes&quot;,\n                        &quot;expression&quot;: &quot;htmlChecks()&quot;,\n                        &quot;xpath&quot;: &quot;not(descendant-or-self::*[not(local-name(.)=(&#39;a&#39;, &#39;abbr&#39;, &#39;acronym&#39;, &#39;b&#39;, &#39;big&#39;, &#39;blockquote&#39;, &#39;br&#39;, &#39;caption&#39;, &#39;cite&#39;, &#39;code&#39;, &#39;col&#39;, &#39;colgroup&#39;, &#39;dd&#39;, &#39;dfn&#39;, &#39;div&#39;, &#39;dl&#39;, &#39;dt&#39;, &#39;em&#39;, &#39;h1&#39;, &#39;h2&#39;, &#39;h3&#39;, &#39;h4&#39;, &#39;h5&#39;, &#39;h6&#39;, &#39;hr&#39;, &#39;i&#39;, &#39;img&#39;, &#39;li&#39;, &#39;ol&#39;, &#39;p&#39;, &#39;pre&#39;, &#39;q&#39;, &#39;samp&#39;, &#39;small&#39;, &#39;span&#39;, &#39;strong&#39;, &#39;sub&#39;, &#39;sup&#39;, &#39;table&#39;, &#39;tbody&#39;, &#39;td&#39;, &#39;tfoot&#39;, &#39;th&#39;, &#39;thead&#39;, &#39;tr&#39;, &#39;tt&#39;, &#39;ul&#39;, &#39;var&#39;))]) and not(descendant-or-self::*/@*[not(name(.)=(&#39;abbr&#39;, &#39;accesskey&#39;, &#39;align&#39;, &#39;alt&#39;, &#39;axis&#39;, &#39;bgcolor&#39;, &#39;border&#39;, &#39;cellhalign&#39;, &#39;cellpadding&#39;, &#39;cellspacing&#39;, &#39;cellvalign&#39;, &#39;char&#39;, &#39;charoff&#39;, &#39;charset&#39;, &#39;cite&#39;, &#39;class&#39;, &#39;colspan&#39;, &#39;compact&#39;, &#39;coords&#39;, &#39;dir&#39;, &#39;frame&#39;, &#39;headers&#39;, &#39;height&#39;, &#39;href&#39;, &#39;hreflang&#39;, &#39;hspace&#39;, &#39;id&#39;, &#39;lang&#39;, &#39;longdesc&#39;, &#39;name&#39;, &#39;nowrap&#39;, &#39;rel&#39;, &#39;rev&#39;, &#39;rowspan&#39;, &#39;rules&#39;, &#39;scope&#39;, &#39;shape&#39;, &#39;span&#39;, &#39;src&#39;, &#39;start&#39;, &#39;style&#39;, &#39;summary&#39;, &#39;tabindex&#39;, &#39;title&#39;, &#39;type&#39;, &#39;valign&#39;, &#39;value&#39;, &#39;vspace&#39;, &#39;width&#39;))])&quot;\n                    },\n                    {\n                        &quot;key&quot;: &quot;txt-2&quot;,\n                        &quot;severity&quot;: &quot;error&quot;,\n                        &quot;human&quot;: &quot;The narrative SHALL have some non-whitespace content&quot;,\n                        &quot;expression&quot;: &quot;htmlChecks()&quot;,\n                        &quot;xpath&quot;: &quot;descendant::text()[normalize-space(.)!=&#39;&#39;] or descendant::h:img[@src]&quot;\n                    }\n                ],\n                &quot;isModifier&quot;: false,\n                &quot;isSummary&quot;: false,\n                &quot;mapping&quot;: [\n                    {\n                        &quot;identity&quot;: &quot;rim&quot;,\n                        &quot;map&quot;: &quot;N/A&quot;\n                    }\n                ]\n            }\n        ]\n    },\n</pre></div>",
        "id": 177339553,
        "sender_full_name": "John Timm",
        "timestamp": 1570196416
    },
    {
        "content": "<p>I'm not seeing div in the fhirpath</p>",
        "id": 177339624,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1570196489
    },
    {
        "content": "<p>the path of the constraint is <code>Narrative.div</code> and the constraint is <code>htmlChecks()</code> In order to check this constraint using FHIRPath we either need to first evaluate the path <code>Narrative.div</code> and then <code>htmlChecks()</code> or put the two together into one expression: <code>Narrative.div.htmlChecks()</code></p>",
        "id": 177339718,
        "sender_full_name": "John Timm",
        "timestamp": 1570196536
    },
    {
        "content": "<p>Either way, with the existing grammar, the generated parser needs an escaped <code>div</code>. I guess there's nothing really that can be changed in the Structure Definition but it is an implementer pitfall</p>",
        "id": 177339776,
        "sender_full_name": "John Timm",
        "timestamp": 1570196601
    },
    {
        "content": "<p>the path there is the ElementDefinition.path, and it's not a FHIRPath element</p>",
        "id": 177339864,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1570196670
    },
    {
        "content": "<p>Right. Understood. I'm coming at this from the perspective of what actually has to be done in a real implementation. and it is not immediately obvious to an implementer that div actually <em>does</em> need to be escaped in this particular case. So I think the documentation fix will help there.</p>",
        "id": 177339933,
        "sender_full_name": "John Timm",
        "timestamp": 1570196737
    },
    {
        "content": "<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"191359\">Bryn Rhodes</span> The version I'm using is here:<br>\n<a href=\"http://hl7.org/fhirpath/2018Sep/grammar.html\" target=\"_blank\" title=\"http://hl7.org/fhirpath/2018Sep/grammar.html\">http://hl7.org/fhirpath/2018Sep/grammar.html</a></p>\n</blockquote>\n<p>Its worth mentioning that this is the version of FHIRPath pointed to by FHIR R4.   Is it possible to update <a href=\"http://hl7.org/fhir/R4B/fhirpath.html\" target=\"_blank\" title=\"http://hl7.org/fhir/R4B/fhirpath.html\">http://hl7.org/fhir/R4B/fhirpath.html</a> (and <a href=\"https://build.fhir.org/fhirpath.html\" target=\"_blank\" title=\"https://build.fhir.org/fhirpath.html\">https://build.fhir.org/fhirpath.html</a>) to point at a more recent version of FHIRPath?  Is there already a tracker for that?  Should we open one?</p>",
        "id": 177577525,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1570499438
    },
    {
        "content": "<p>it will automatically update to the latest. Neatly, it looks like this will align with the technical correction</p>",
        "id": 177580960,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1570504795
    }
]