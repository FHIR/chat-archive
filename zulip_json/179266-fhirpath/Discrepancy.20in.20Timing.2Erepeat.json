[
    {
        "content": "<p>I wanted to get some clarity on one of the constraints in Timing.repeat (<a href=\"http://hl7.org/fhir/R4/datatypes-definitions.html#Timing.repeat\">http://hl7.org/fhir/R4/datatypes-definitions.html#Timing.repeat</a>) ; <code>tim-9</code>:</p>\n<p><code>offset.empty() or (when.exists() and ((when in ('C' | 'CM' | 'CD' | 'CV')).not()))</code></p>\n<p>It looks like <code>when</code> is a repeated field: <a href=\"http://hl7.org/fhir/R4/datatypes-definitions.html#Timing.repeat\">http://hl7.org/fhir/R4/datatypes-definitions.html#Timing.repeat</a></p>\n<p>But it also looks like the <code>in</code> operation does not allow repeated fields on its LHS (it is supposed to error out): <a href=\"http://hl7.org/fhirpath/index.html#in-membership\">http://hl7.org/fhirpath/index.html#in-membership</a>; <code>If the left operand has multiple items, an exception is thrown.</code></p>\n<p>So is <code>when in ('C' | 'CM' | 'CD' | 'CV')</code> an invalid expression? or am I misunderstanding how <code>in</code> works.</p>\n<p>And if it is invalid, what would the replacement be?</p>",
        "id": 271189742,
        "sender_full_name": "Ose Umolu",
        "timestamp": 1644353842
    },
    {
        "content": "<p>Yeah, this will run fine so long as there is only ever one \"when\" in an instance. It should probably be:</p>\n<div class=\"codehilite\"><pre><span></span><code>offset.empty() or (when.exists() and when.all(($this in (&#39;C&#39; | &#39;CM&#39; | &#39;CD&#39; | &#39;CV&#39;)).not()))\n</code></pre></div>",
        "id": 271192884,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1644355327
    },
    {
        "content": "<p>So just to be 100% clear, in a case where the when clause is satisfied for one but not all of the Timing.repeat.when, <br>\na) the current expression evalatuates to an exception<br>\nb) it should evaluate to false</p>",
        "id": 271195276,
        "sender_full_name": "Nick George",
        "timestamp": 1644356568
    },
    {
        "content": "<p>is that accurate?</p>",
        "id": 271196997,
        "sender_full_name": "Nick George",
        "timestamp": 1644357426
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191359\">Bryn Rhodes</span> <a href=\"#narrow/stream/179266-fhirpath/topic/Discrepancy.20in.20Timing.2Erepeat/near/271192884\">said</a>:</p>\n<blockquote>\n<p>Yeah, this will run fine so long as there is only ever one \"when\" in an instance. It should probably be:</p>\n<p><div class=\"codehilite\"><pre><span></span><code>offset.empty() or (when.exists() and when.all(($this in (&#39;C&#39; | &#39;CM&#39; | &#39;CD&#39; | &#39;CV&#39;)).not()))\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Interesting, okay. What happens when there is more than one \"when\" instance? <br>\nIs there an implied restriction in the constraint that there should be only one instance of \"when\"?</p>",
        "id": 271197096,
        "sender_full_name": "Ose Umolu",
        "timestamp": 1644357482
    },
    {
        "content": "<p>No, an exception evaluating a constraint is, I would think, an error condition, not part of the constraint definition.</p>",
        "id": 271212641,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1644365925
    },
    {
        "content": "<p>I guess my point being - If I asked you, \"does this resource pass this fhirpath constraint\", on a multi-valued when resource, how would you answer?</p>\n<p>Our current plan is to just in place replace the expression with your sugggested  replacement - does that make sense to you.  Do you think we can propose it e.g., for r5?</p>",
        "id": 271220483,
        "sender_full_name": "Nick George",
        "timestamp": 1644371639
    },
    {
        "content": "<p>This <a href=\"https://hl7.org/fhir/conformance-rules.html#constraints\">language</a> indicates that the invariant must evaluate to true, so by that requirement, no, an exception during evaluation of the constraint would have to be considered a failure of the constraint and the resource don't pass the constraint. I would suggest submitting a tracker to correct the invariant with the suggested expression, that's just my read of the intent, should definitely be brought up with FHIR-I to confirm my interpretation there and to get the spec invariant corrected.</p>",
        "id": 271225735,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1644376727
    },
    {
        "content": "<p>As far as the interpretation of an exception when evaluating a constraint, that's probably worth some clarifying language in the spec as well. I'll submit a tracker on that: <a href=\"https://jira.hl7.org/browse/FHIR-35990\">https://jira.hl7.org/browse/FHIR-35990</a></p>",
        "id": 271226757,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1644377838
    }
]