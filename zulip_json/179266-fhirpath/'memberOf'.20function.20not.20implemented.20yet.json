[
    {
        "content": "<p>The Validator and FHIRPathEngine now seem to be attempting to fully validate ElementDefinition.constraint.expression (which apparently wasn't the case before), resulting in a new error when I build the IPS IG, as the constraint expression that we had in Patient.address.country wasn't actually a valid FHIRPath expression.  The human readable for the constraint is \"The content of this element SHALL be selected EITHER from ValueSet ISO Country Alpha-2 <a href=\"http://hl7.org/fhir/ValueSet/iso3166-1-2\" target=\"_blank\" title=\"http://hl7.org/fhir/ValueSet/iso3166-1-2\">http://hl7.org/fhir/ValueSet/iso3166-1-2</a> OR MAY be selected from ISO Country Alpha-3 Value Set <a href=\"http://hl7.org/fhir/ValueSet/iso3166-1-3\" target=\"_blank\" title=\"http://hl7.org/fhir/ValueSet/iso3166-1-3\">http://hl7.org/fhir/ValueSet/iso3166-1-3</a>, IF the country is not specified in value Set ISO Country Alpha-2 <a href=\"http://hl7.org/fhir/ValueSet/iso3166-1-2\" target=\"_blank\" title=\"http://hl7.org/fhir/ValueSet/iso3166-1-2\">http://hl7.org/fhir/ValueSet/iso3166-1-2</a>.\"  I attempted to change it to what I think should be a valid FHIRPath expression:<br>\n<code>Patient.address.country.memberOf('http://hl7.org/fhir/ValueSet/iso3166-1-2') or (Patient.address.country.memberOf('http://hl7.org/fhir/ValueSet/iso3166-1-2').not() and Patient.address.country.memberOf('http://hl7.org/fhir/ValueSet/iso3166-1-3'))</code><br>\nBut when the IG Publisher attempts to execute the expression it gives this error, indicating that memberOf (documented <a href=\"http://build.fhir.org/fhirpath.html#functions\" target=\"_blank\" title=\"http://build.fhir.org/fhirpath.html#functions\">here</a>) hasn't been implemented:</p>\n<div class=\"codehilite\"><pre><span></span>Validating Resources                                                             (00:30.0782)\n .. validate /Users/rhausam/git-repo/fhir-ips/resources/ig-uv-ips                (00:30.0782)\n .. /Users/rhausam/git-repo/fhir-ips/resources/ig-uv-ips                         (00:30.0782)\n .. validate /Users/rhausam/git-repo/fhir-ips/examples/IPS-bundle-01             (00:30.0782)\n .. /Users/rhausam/git-repo/fhir-ips/examples/IPS-bundle-01                      (00:30.0782)\n     validating Bundle/IPS-examples-Bundle-01                                    (00:30.0782)\nException in thread &quot;main&quot; java.lang.Error: not Implemented yet\n    at org.hl7.fhir.r5.utils.FHIRPathEngine.funcMemberOf(FHIRPathEngine.java:2853)\n    at org.hl7.fhir.r5.utils.FHIRPathEngine.evaluateFunction(FHIRPathEngine.java:2735)\n    at org.hl7.fhir.r5.utils.FHIRPathEngine.execute(FHIRPathEngine.java:1147)\n    at org.hl7.fhir.r5.utils.FHIRPathEngine.execute(FHIRPathEngine.java:1161)\n    at org.hl7.fhir.r5.utils.FHIRPathEngine.execute(FHIRPathEngine.java:1161)\n    at org.hl7.fhir.r5.utils.FHIRPathEngine.execute(FHIRPathEngine.java:1161)\n    at org.hl7.fhir.r5.utils.FHIRPathEngine.evaluate(FHIRPathEngine.java:546)\n    at org.hl7.fhir.r5.utils.FHIRPathEngine.evaluateToBoolean(FHIRPathEngine.java:614)\n    at org.hl7.fhir.r5.validation.InstanceValidator.checkInvariant(InstanceValidator.java:4558)\n    at org.hl7.fhir.r5.validation.InstanceValidator.checkInvariants(InstanceValidator.java:4533)\n    at org.hl7.fhir.r5.validation.InstanceValidator.checkInvariants(InstanceValidator.java:4424)\n    at org.hl7.fhir.r5.validation.InstanceValidator.checkChild(InstanceValidator.java:4148)\n    at org.hl7.fhir.r5.validation.InstanceValidator.validateElement(InstanceValidator.java:4069)\n    at org.hl7.fhir.r5.validation.InstanceValidator.checkChild(InstanceValidator.java:4252)\n    at org.hl7.fhir.r5.validation.InstanceValidator.validateElement(InstanceValidator.java:4069)\n    at org.hl7.fhir.r5.validation.InstanceValidator.start(InstanceValidator.java:2998)\n    at org.hl7.fhir.r5.validation.InstanceValidator.validateResource(InstanceValidator.java:4665)\n    at org.hl7.fhir.r5.validation.InstanceValidator.validateContains(InstanceValidator.java:3976)\n    at org.hl7.fhir.r5.validation.InstanceValidator.checkChild(InstanceValidator.java:4175)\n    at org.hl7.fhir.r5.validation.InstanceValidator.validateElement(InstanceValidator.java:4069)\n    at org.hl7.fhir.r5.validation.InstanceValidator.checkChild(InstanceValidator.java:4180)\n    at org.hl7.fhir.r5.validation.InstanceValidator.validateElement(InstanceValidator.java:4069)\n    at org.hl7.fhir.r5.validation.InstanceValidator.start(InstanceValidator.java:2977)\n    at org.hl7.fhir.r5.validation.InstanceValidator.validateResource(InstanceValidator.java:4665)\n    at org.hl7.fhir.r5.validation.InstanceValidator.validate(InstanceValidator.java:846)\n    at org.hl7.fhir.r5.validation.InstanceValidator.validate(InstanceValidator.java:806)\n    at org.hl7.fhir.igtools.publisher.Publisher.validate(Publisher.java:3972)\n    at org.hl7.fhir.igtools.publisher.Publisher.validate(Publisher.java:3949)\n    at org.hl7.fhir.igtools.publisher.Publisher.createIg(Publisher.java:773)\n    at org.hl7.fhir.igtools.publisher.Publisher.execute(Publisher.java:656)\n    at org.hl7.fhir.igtools.publisher.Publisher.main(Publisher.java:6637)\n</pre></div>\n\n\n<p>I assume this is a known issue?  Maybe there is a reasonable way to work around this in FHIRPath and still be able to validate that a code is (or isn't) a member of a particular value set? <span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span>, or anyone?</p>",
        "id": 182609685,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1575500457
    },
    {
        "content": "<p>I don't actually understand the fHIRPath. a or a.not or b?</p>",
        "id": 182610358,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1575500983
    },
    {
        "content": "<p>I don't think the terminology server understands those value sets anyway?</p>",
        "id": 182610374,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1575500999
    },
    {
        "content": "<p>it's actually \"a or (a.not and b)\"<br>\nso it's usually expected to be a, but if it isn't a then it must be b - which I think should make sense</p>",
        "id": 182611262,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1575501806
    },
    {
        "content": "<p>if we need to add support for the code systems / value sets in the terminology server then we should be able to do that - but if we aren't able to check for value set membership then that's not going to help (at least not immediately)</p>",
        "id": 182611477,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1575501979
    },
    {
        "content": "<p>Actually the FHIRPath probably might as well be just \"a or b\" - the \"(a.not and b)\" doesn't add anything over just \"b\" here.  Ideally you would want to determine if a particular 3 character code also has a corresponding 2 character code which should be chosen instead, but I don't see an obvious way to do that (unless there is a way with %terminologies.translate, but that might not be supported either?).  So if we don't attempt to enforce that aspect then the expression logic is considerably simpler - but the issue of checking the value set membership still remains.</p>",
        "id": 182612199,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1575502615
    },
    {
        "content": "<p>So, if I understand correctly with the following example:</p>\n<div class=\"codehilite\"><pre><span></span>&lt;Bundle xmlns=&quot;http://hl7.org/fhir&quot;&gt;\n  &lt;id value=&quot;bundle1234&quot;/&gt;\n  &lt;type value=&quot;searchset&quot;/&gt;\n  &lt;entry&gt;\n    &lt;resource&gt;\n      &lt;Patient&gt;   &lt;!-- %rootResource --&gt;\n        &lt;contained&gt;\n            &lt;RelatedPerson&gt;     &lt;!-- %resource --&gt;\n                &lt;id value=&quot;rel0304&quot;/&gt;\n                &lt;!--    snip    --&gt;\n            &lt;/RelatedPerson&gt;\n        &lt;/contained&gt;\n        &lt;id value=&quot;pat3123&quot;/&gt;\n        &lt;!--    snip    --&gt;\n      &lt;/Patient&gt;\n    &lt;/resource&gt;\n  &lt;/entry&gt;\n  &lt;!--    snip    --&gt;\n&lt;/Bundle&gt;\n</pre></div>\n\n\n<p>&lt;Patient&gt; is %rootResource and &lt;RelatedPerson&gt; is %resource ?</p>",
        "id": 182653200,
        "sender_full_name": "Marco Visser",
        "timestamp": 1575548017
    },
    {
        "content": "<p>RelatedPerson&gt; is %resource<em>if the FHIRPath is run in the context of RelatedPerson</em>, yes</p>",
        "id": 182653318,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1575548116
    },
    {
        "content": "<p>Thanks Grahame!</p>",
        "id": 182653352,
        "sender_full_name": "Marco Visser",
        "timestamp": 1575548162
    },
    {
        "content": "<p>Anything more on memberOf?  Or any possible workarounds in its absence? <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> <span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span></p>",
        "id": 182657662,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1575551710
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191405\">@Rob Hausam</span> , if I'm understanding correctly, the logic you want is actually an <code>xor</code>. As far as memberOf, if that is not implemented, you could try <code>%terminologies.validateVS</code>, though that usage is documented as draft.</p>",
        "id": 182905387,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1575833084
    },
    {
        "content": "<p>I don't think 'xor' will provide anything useful here.  The value sets are mutually exclusive ( a code is either 2-char or 3-char), and even if they overlapped I don't think you would want to exclude codes that were members of both.  Actually I think what would be useful is the value set of 3-char codes without a 2-char equivalent, and then the logic would be \"2-char\" <strong>or</strong> \"3-char without 2-char equivalent\".  I agree that %terminologies.validateVS() should also work for this, but I assumed it was even less likely to be implemented than memberOf (because as you say it's documented as draft).  But I can check that out.</p>",
        "id": 182912718,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1575845571
    },
    {
        "content": "<p>have you got a good example set (profile, valid resource, invalid resource)?</p>",
        "id": 182950346,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1575894244
    },
    {
        "content": "<p>Well, maybe - but I'm not entirely sure if I know what you want in this case.  Nothing that I have now is provably valid from the build perspective because memberOf isn't implemented (and I haven't had a chance yet to try %terminologies.validateVS).  There definitely are invalid and potentially valid versions of the profile.</p>",
        "id": 182952280,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1575896100
    },
    {
        "content": "<p>so I was asking because I was thinking of implementing memberOf but that means I need test cases</p>",
        "id": 182989289,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1575918988
    },
    {
        "content": "<p>Sure.  Let me do a little more work so that the logic actually does what we're looking for and I'll send you a set.</p>",
        "id": 182996413,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1575923387
    },
    {
        "content": "<p>Has this been implemented?  I'm no longer getting an error in the IG build when I use memberOf in the constraint expression, but I didn't see anything in the recent FHIRPath commits that addressed it (maybe I missed it).  <span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span>?  <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span>?</p>",
        "id": 185152724,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1578514900
    },
    {
        "content": "<p>I think it's implemented. org.hl7.fhir.r5.utils.FHIRPathEngine L1887</p>",
        "id": 185248326,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1578599298
    },
    {
        "content": "<p>Yes, it appears that it is, as it's working.  Do you know when that was done?</p>",
        "id": 185253331,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1578602479
    },
    {
        "content": "<p>a few weeks back...?</p>",
        "id": 185253970,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1578602913
    },
    {
        "content": "<p>I'm no longer getting the build error, but the memberOf function doesn't appear to be working.  I'm getting this warning:</p>\n<div class=\"codehilite\"><pre><span></span>== /Users/rhausam/git-repo/fhir-ips/examples/patient-example-female.xml ==\nWARNING: Patient/patient-example-female: Patient.address[0].country: pat-cnt-2or3-char: The content of this element SHALL be selected EITHER from ValueSet ISO Country Alpha-2 http://hl7.org/fhir/ValueSet/iso3166-1-2 OR MAY be selected from ISO Country Alpha-3 Value Set http://hl7.org/fhir/ValueSet/iso3166-1-3, IF the country is not specified in value Set ISO Country Alpha-2 http://hl7.org/fhir/ValueSet/iso3166-1-2. [Patient.address.country.memberOf(&#39;http://hl7.org/fhir/ValueSet/iso3166-1-2&#39;) or Patient.address.country.memberOf(&#39;http://hl7.org/fhir/ValueSet/iso3166-1-3&#39;)]\n</pre></div>\n\n\n<p>when I validate this example instance in the build (or separately with the standalone validator):</p>\n<div class=\"codehilite\"><pre><span></span>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;Patient xmlns=&quot;http://hl7.org/fhir&quot;&gt;\n    &lt;id value=&quot;patient-example-female&quot;/&gt;\n    &lt;identifier&gt;\n        &lt;system value=&quot;urn:oid:2.16.840.1.113883.2.4.6.3&quot;/&gt;\n        &lt;value value=&quot;574687583&quot;/&gt;\n    &lt;/identifier&gt;\n    &lt;active value=&quot;true&quot;/&gt;\n    &lt;name&gt;\n        &lt;family value=&quot;DeLarosa&quot;/&gt;\n        &lt;given value=&quot;Martha&quot;/&gt;\n    &lt;/name&gt;\n    &lt;telecom&gt;\n        &lt;system value=&quot;phone&quot;/&gt;\n        &lt;value value=&quot;+31788700800&quot;/&gt;\n        &lt;use value=&quot;home&quot;/&gt;\n    &lt;/telecom&gt;\n    &lt;gender value=&quot;female&quot;/&gt;\n    &lt;birthDate value=&quot;1992-05-01&quot;/&gt;\n    &lt;address&gt;\n        &lt;line value=&quot;Laan Van Europa 1600&quot;/&gt;\n        &lt;city value=&quot;Dordrecht&quot;/&gt;\n        &lt;postalCode value=&quot;3317 DB&quot;/&gt;\n        &lt;country value=&quot;NL&quot;/&gt;\n    &lt;/address&gt;\n    &lt;contact&gt;\n        &lt;relationship&gt;\n            &lt;coding&gt;\n                &lt;system value=&quot;http://terminology.hl7.org/CodeSystem/v3-RoleCode&quot;/&gt;\n                &lt;code value=&quot;MTH&quot;/&gt;\n            &lt;/coding&gt;\n        &lt;/relationship&gt;\n        &lt;name&gt;\n            &lt;family value=&quot;Mum&quot;/&gt;\n            &lt;given value=&quot;Martha&quot;/&gt;\n        &lt;/name&gt;\n        &lt;telecom&gt;\n            &lt;system value=&quot;phone&quot;/&gt;\n            &lt;value value=&quot;+33-555-20036&quot;/&gt;\n            &lt;use value=&quot;home&quot;/&gt;\n        &lt;/telecom&gt;\n        &lt;address&gt;\n            &lt;line value=&quot;Promenade des Anglais 111&quot;/&gt;\n            &lt;city value=&quot;Lyon&quot;/&gt;\n            &lt;postalCode value=&quot;69001&quot;/&gt;\n            &lt;country value=&quot;FR&quot;/&gt;\n        &lt;/address&gt;\n    &lt;/contact&gt;\n&lt;/Patient&gt;\n</pre></div>\n\n\n<p>The code 'NL' is in fact a valid member of the <a href=\"http://hl7.org/fhir/valueset-iso3166-1-2.html\" target=\"_blank\" title=\"http://hl7.org/fhir/valueset-iso3166-1-2.html\">iso3166-1-2</a> value set, so I believe the expression should be evaluating to true and no warning should be generated. <span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span>? <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span>?</p>",
        "id": 186260667,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1579676128
    },
    {
        "content": "<p>MemberOf is working. I presume this means there’s a problem on the terminology server.</p>",
        "id": 186274699,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1579690212
    },
    {
        "content": "<p>Ok.  Not sure yet what that problem is, since the 3166 value sets are displayed properly in the core build, but I will check further.</p>",
        "id": 186291851,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1579703979
    },
    {
        "content": "<p>Hmm.  Posting GET `http://tx.fhir.org/r4/ValueSet/$expand?url=http://hl7.org/fhir/ValueSet/iso3166-1-2' works fine, with 'NL' being returned as expected in the expansion.  So it doesn't seem like a terminology server error?  If memberOf is working (however you test it), is it a problem with the evaluation of the FHIRPath expression?  <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span>? <span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span>?</p>",
        "id": 186293522,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1579705058
    },
    {
        "content": "<p>I’ll investigate tomorrow</p>",
        "id": 186333433,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1579728897
    },
    {
        "content": "<p>sounds good - thanks</p>",
        "id": 186333492,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1579728941
    },
    {
        "content": "<p>looks like it works for me. Check these test cases - do you think I missed something? -<br>\n<a href=\"https://github.com/FHIR/fhir-test-cases/commit/7a96f17241afb25b94c0db2226a6216df1f090cb\" target=\"_blank\" title=\"https://github.com/FHIR/fhir-test-cases/commit/7a96f17241afb25b94c0db2226a6216df1f090cb\">https://github.com/FHIR/fhir-test-cases/commit/7a96f17241afb25b94c0db2226a6216df1f090cb</a></p>",
        "id": 186465525,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1579845155
    },
    {
        "content": "<p>I just did a fresh build with 1.0.47-SNAPSHOT and I'm still getting the warning:</p>\n<div class=\"codehilite\"><pre><span></span>WARNING: Patient/patient-example-female: Patient.address[0].country: pat-cnt-2or3-char: The content of this element SHALL be selected EITHER from ValueSet ISO Country Alpha-2 http://hl7.org/fhir/ValueSet/iso3166-1-2 OR MAY be selected from ISO Country Alpha-3 Value Set http://hl7.org/fhir/ValueSet/iso3166-1-3, IF the country is not specified in value Set ISO Country Alpha-2 http://hl7.org/fhir/ValueSet/iso3166-1-2. [Patient.address.country.memberOf(&#39;http://hl7.org/fhir/ValueSet/iso3166-1-2&#39;) or Patient.address.country.memberOf(&#39;http://hl7.org/fhir/ValueSet/iso3166-1-3&#39;)]\n</pre></div>\n\n\n<p>Your test cases look fine to me.  You are testing exactly what we are doing in IPS, so I don't see why it would be working for you and not for us.  Can you check it in IPS, and see if you get the same warning on patient-example-female.xml as we do?</p>",
        "id": 186467091,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1579847666
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> I assume you haven't had a chance yet to look at this again?  Let me know if you don't see the issue.</p>",
        "id": 186583542,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1579977209
    },
    {
        "content": "<p>I don't see the issue. Is it a txCache issue?</p>",
        "id": 186616498,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1580036257
    },
    {
        "content": "<p>no I do see it and it's a context issue. The context of the expression is Patient.address.country, but the expression is <code>Patient.address.country.memberOf('http://hl7.org/fhir/ValueSet/iso3166-1-2') or Patient.address.country.memberOf('http://hl7.org/fhir/ValueSet/iso3166-1-3')</code></p>\n<p>The path is doubled up</p>",
        "id": 186618524,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1580039927
    },
    {
        "content": "<p>oh, that's interesting - makes sense in retrospect<br>\nI guess hadn't thought about whether stating the entire Patient.address.country context was correct (it was already there that way)<br>\nthat's good to know - thanks</p>",
        "id": 186638227,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1580072903
    },
    {
        "content": "<p>Unfortunately, I'm getting the same exact warning message whether I include the 'Patient.address.country.' part of the path in the expression or not:</p>\n<div class=\"codehilite\"><pre><span></span>WARNING: Patient/patient-example-female: Patient.address[0].country: pat-cnt-2or3-char: The content of this element SHALL be selected EITHER from ValueSet ISO Country Alpha-2 http://hl7.org/fhir/ValueSet/iso3166-1-2 OR MAY be selected from ISO Country Alpha-3 Value Set http://hl7.org/fhir/ValueSet/iso3166-1-3, IF the country is not specified in value Set ISO Country Alpha-2 http://hl7.org/fhir/ValueSet/iso3166-1-2. [memberOf(&#39;http://hl7.org/fhir/ValueSet/iso3166-1-2&#39;) or memberOf(&#39;http://hl7.org/fhir/ValueSet/iso3166-1-3&#39;)]\n</pre></div>\n\n\n<p>Is there something else that's different?</p>",
        "id": 186653816,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1580101926
    },
    {
        "content": "<p>I'll double check the txCache.</p>",
        "id": 186653832,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1580101996
    },
    {
        "content": "<p>Deleting and re-creating the iso3166 cache by the publisher makes no difference - the cache file has no content.</p>",
        "id": 186654544,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1580103140
    },
    {
        "content": "<p>thanks for fixing this - it looks good now!</p>",
        "id": 186696253,
        "sender_full_name": "Rob Hausam",
        "timestamp": 1580141183
    }
]