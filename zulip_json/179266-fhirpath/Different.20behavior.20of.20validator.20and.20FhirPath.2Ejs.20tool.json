[
    {
        "content": "<p>I have implemented FhirPath expression \"Consent.except.actor.distinct().subsetOf(<a href=\"http://Consent.actor\">Consent.actor</a>)\" for consent profile means <a href=\"http://consent.except.actor\">consent.except.actor</a> should be subset of <a href=\"http://consent.actor\">consent.actor</a>, this expression giving true output when testing with consent instance using fhirpath.js(<a href=\"https://github.com/HL7/fhirpath.js\">https://github.com/HL7/fhirpath.js</a>) build tool, but same instance is failing validation while validating using HL7 Java validatorwith with 1 error - <br>\n\"Error @ Consent (line 1, col38) : Consent-1: '<a href=\"http://consent.except.actor\">consent.except.actor</a> should be subset of <a href=\"http://consent.actor\">consent.actor</a>' failed\".<br>\nI am not sure if distinct() and subsetOf() FhirPath functions are supported by java validator? Where I can find documentation of java validator to know what all FhirPath features are supported/not supported?</p>",
        "id": 234828711,
        "sender_full_name": "Kailash",
        "timestamp": 1618568441
    },
    {
        "content": "<p>The code is here: <a href=\"https://github.com/hapifhir/org.hl7.fhir.core/blob/master/org.hl7.fhir.r5/src/main/java/org/hl7/fhir/r5/utils/FHIRPathEngine.java\">https://github.com/hapifhir/org.hl7.fhir.core/blob/master/org.hl7.fhir.r5/src/main/java/org/hl7/fhir/r5/utils/FHIRPathEngine.java</a>. The tests are here: <a href=\"https://github.com/FHIR/fhir-test-cases/blob/master/r5/fhirpath/tests-fhir-r5.xml\">https://github.com/FHIR/fhir-test-cases/blob/master/r5/fhirpath/tests-fhir-r5.xml</a></p>\n<p>And yes, R5 is what the validator uses internally</p>",
        "id": 235284955,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1618892095
    },
    {
        "content": "<p>Thank you for reply, just one doubt, I am using FHIR STU3 version, can I expect the validator to support all Fhirpath features that are supported for r5 ? I saw no different in FhirPath spec across FHIR versions.</p>",
        "id": 235374667,
        "sender_full_name": "Kailash",
        "timestamp": 1618936467
    },
    {
        "content": "<p>the validator uses R5 code internally, irrespective of the version it is validating</p>",
        "id": 235411652,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1618951373
    },
    {
        "content": "<p>Hello All, This is similar to my previous post on FHIRPath validation,<br>\nI have a constraint on consent resource(STU3) at root level and FHIRPath expresiion is:-  <br>\nExpression:  Consent.actor.supersetOf(Consent.except.actor.distinct())<br>\nSeverity: error</p>\n<p>Below is snippet from consent instance where actor list is not superset of <a href=\"http://exept.actor\">exept.actor</a> list as except.actor.reference is not part of actor list and should return a error -  <br>\n{<br>\n  \"resourceType\": \"Consent\",<br>\n  \"meta\": {<br>\n    \"profile\": [<br>\n      \"<a href=\"https://www.example.com/StructureDefinition/ConsentProfile\">https://www.example.com/StructureDefinition/ConsentProfile</a>\"<br>\n    ]<br>\n  },<br>\n  \"status\": \"active\",<br>\n  \"patient\": {<br>\n    \"reference\": \"Patient/55\"<br>\n  },<br>\n  \"actor\": [<br>\n    {<br>\n      \"role\": {<br>\n        \"coding\": [<br>\n          {<br>\n            \"system\": \"<a href=\"http://hl7.org/fhir/v3/RoleClass\">http://hl7.org/fhir/v3/RoleClass</a>\",<br>\n            \"code\": \"PAT\"<br>\n          }<br>\n        ]<br>\n      },<br>\n      \"reference\": {<br>\n        \"reference\": \"Patient/12345\"<br>\n      }<br>\n    }<br>\n  ],<br>\n  \"policyRule\": \"<a href=\"http://hl7.org/fhir/ConsentPolicy/opt-in\">http://hl7.org/fhir/ConsentPolicy/opt-in</a>\",<br>\n  \"except\": [<br>\n    {<br>\n      \"type\": \"deny\",<br>\n      \"actor\": [<br>\n        {<br>\n          \"role\": {<br>\n            \"coding\": [<br>\n              {<br>\n                \"system\": \"<a href=\"http://hl7.org/fhir/v3/RoleClass\">http://hl7.org/fhir/v3/RoleClass</a>\",<br>\n                \"code\": \"PAT\"<br>\n              }<br>\n            ]<br>\n          },<br>\n          \"reference\": {<br>\n            \"reference\": \"Patient/9999\"<br>\n          }<br>\n        }<br>\n      ]<br>\n    }<br>\n  ]<br>\n}</p>\n<p>I am expecting this instance to be failed while its getting pass with 0 error using cli validator 5.4.2<br>\nI am not sure if the issue is with Validator or something else? When testing the same instance and expression using javascript.js tool its giving expected result(false).</p>",
        "id": 241130872,
        "sender_full_name": "Kailash",
        "timestamp": 1622629880
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> <span class=\"user-mention\" data-user-id=\"191359\">@Bryn Rhodes</span></p>",
        "id": 241148735,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1622640699
    },
    {
        "content": "<p>what are you actually trying to achieve? what is a super set in this context?</p>",
        "id": 241298078,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1622657692
    },
    {
        "content": "<p>want to validate that consent.actor[1..<em>] is superset of consent.exept[0..</em>].actor[0..*] or in other way <a href=\"http://consent.exept.actor\">consent.exept.actor</a> is subset of <a href=\"http://consent.actor\">consent.actor</a></p>",
        "id": 241345657,
        "sender_full_name": "Kailash",
        "timestamp": 1622691956
    },
    {
        "content": "<p>but what makes them a superset? they're not the <em>same objects</em></p>",
        "id": 241346690,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1622693503
    },
    {
        "content": "<p>Yes, they are not same objects in the given instance but still validator passing the given FHIRPath expression and no error. I am expecting validation to be failed but its not.</p>",
        "id": 241349489,
        "sender_full_name": "Kailash",
        "timestamp": 1622697493
    },
    {
        "content": "<p>well, the problem might not be in the fhirpath itself. Please provide a zip and a set of parameters for the validator that reproduces the issue</p>",
        "id": 241462289,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1622757955
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span>  , Thank you for response, I am attaching Profile having discussed FhirPath expression, Valid and Invalid instances and validation result for both instances against the profile. <a href=\"/user_uploads/10155/z_9rc2G5HZahj4osgz_INI9b/FHIRPathIssue.zip\">FHIRPathIssue.zip</a></p>",
        "id": 241758583,
        "sender_full_name": "Kailash",
        "timestamp": 1623063484
    },
    {
        "content": "<p>(working on this with <span class=\"user-mention\" data-user-id=\"263322\">@Kailash</span> )</p>\n<p>I think <span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> 's point is that you are looking to compare Objects in <em>different</em> sets, for which superSet may be inappropriate?</p>\n<p>one set is the consent.actor[] ; another set is the consent.except[].actor[]<br>\nbut the superSet/Equals comparison should not be by Object reference, but by looking whether their attributes are equal. </p>\n<p>what we want to ensure is that each individual entry in consent.except[].actor[] _equals_ an entry of consent.actor[]</p>",
        "id": 241760810,
        "sender_full_name": "David Simons",
        "timestamp": 1623064843
    },
    {
        "content": "<p>This is an example that must throw an error, based on the profile conformance claim being validated, given the actor mismatch:<br>\nWhich FHIRPath expression to achieve this with, it our puzzle:</p>\n<div class=\"codehilite\"><pre><span></span><code> &lt;Consent xmlns=&quot;http://hl7.org/fhir&quot;&gt;\n    &lt;id value=&quot;test-ConsentConsumer&quot;/&gt;\n    &lt;meta&gt;\n        &lt;profile value=&quot;ConsentConsumer&quot; /&gt;\n    &lt;/meta&gt;\n    &lt;status value=&quot;active&quot;/&gt;\n    &lt;category&gt;\n        &lt;coding&gt;\n            &lt;system value=&quot;http://loinc.org&quot;/&gt;\n            &lt;code value=&quot;59284-0&quot;/&gt;\n        &lt;/coding&gt;\n    &lt;/category&gt;\n    &lt;patient&gt;\n        &lt;reference value=&quot;Patient/test-Patient&quot;/&gt;\n    &lt;/patient&gt;\n    &lt;actor&gt;                                                          **Consent.actor[]**\n        &lt;role&gt;\n            &lt;coding&gt;\n                &lt;system value=&quot;http://hl7.org/fhir/v3/RoleClass&quot;/&gt;\n                &lt;code value=&quot;PAT&quot;/&gt;\n            &lt;/coding&gt;\n        &lt;/role&gt;\n        &lt;reference&gt;\n            &lt;reference value=&quot;Patient/test-Patient&quot;/&gt;\n        &lt;/reference&gt;\n    &lt;/actor&gt;\n    &lt;action&gt;\n        &lt;coding&gt;\n            &lt;system value=&quot;http://hl7.org/fhir/consentaction&quot;/&gt;\n            &lt;code value=&quot;access&quot;/&gt;\n        &lt;/coding&gt;\n    &lt;/action&gt;\n    &lt;policyRule value=&quot;http://hl7.org/fhir/ConsentPolicy/opt-in&quot;/&gt;\n    &lt;except&gt;\n        &lt;type value=&quot;deny&quot;/&gt;\n        &lt;actor&gt;                                                        **Consent.except[].actor[]**\n            &lt;role&gt;\n                &lt;coding&gt;\n                    &lt;system value=&quot;http://hl7.org/fhir/v3/ParticipationType&quot;/&gt;\n                    &lt;code value=&quot;CST&quot;/&gt;\n                &lt;/coding&gt;\n            &lt;/role&gt;\n            &lt;reference&gt;\n                &lt;reference value=&quot;Organization/test-Organization&quot;/&gt;\n            &lt;/reference&gt;\n        &lt;/actor&gt;\n        &lt;action&gt;\n            &lt;coding&gt;\n                &lt;system value=&quot;http://hl7.org/fhir/consentaction&quot;/&gt;\n                &lt;code value=&quot;access&quot;/&gt;\n            &lt;/coding&gt;\n        &lt;/action&gt;\n        &lt;securityLabel&gt;\n            &lt;system value=&quot;http://hl7.org/fhir/v3/ActCode&quot;/&gt;\n            &lt;code value=&quot;NOPAT&quot;/&gt;\n        &lt;/securityLabel&gt;\n    &lt;/except&gt;\n&lt;/Consent&gt;\n</code></pre></div>",
        "id": 243030464,
        "sender_full_name": "David Simons",
        "timestamp": 1623941861
    },
    {
        "content": "<p><code>consent.except.actor.exclude(consent.actor).exists().not()</code> should do it</p>",
        "id": 243053502,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1623950824
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191359\">Bryn Rhodes</span> <a href=\"#narrow/stream/179266-fhirpath/topic/Different.20behavior.20of.20validator.20and.20FhirPath.2Ejs.20tool/near/243053502\">said</a>:</p>\n<blockquote>\n<p><code>consent.except.actor.exclude(consent.actor).exists().not()</code> should do it</p>\n</blockquote>\n<p>Thank you - I was hopeful but unfortunately that also does not work as expected...</p>",
        "id": 243150679,
        "sender_full_name": "David Simons",
        "timestamp": 1624017841
    },
    {
        "content": "<p>because the consent actors are distinct objects from the <a href=\"http://consent.except.actor\">consent.except.actor</a>. You'll have to say how you're comparing them somehow</p>",
        "id": 243155823,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1624020829
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191316\">Grahame Grieve</span> <a href=\"#narrow/stream/179266-fhirpath/topic/Different.20behavior.20of.20validator.20and.20FhirPath.2Ejs.20tool/near/243155823\">said</a>:</p>\n<blockquote>\n<p>because the consent actors are distinct objects from the <a href=\"http://consent.except.actor\">consent.except.actor</a>. You'll have to say how you're comparing them somehow</p>\n</blockquote>\n<p>thanks will need to figure that out - I think you are hinting at implementing more granular and individual element comparisons of their role and references, separately (in STU3 at least)</p>",
        "id": 243157904,
        "sender_full_name": "David Simons",
        "timestamp": 1624021751
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> , are you saying that the FHIRPath implementation uses reference comparison for equality between objects?</p>",
        "id": 243179586,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1624031868
    },
    {
        "content": "<p>well, I think in classic terms, it uses identity. I don't think we've said anything about that?</p>",
        "id": 243211688,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1624053187
    },
    {
        "content": "<p>I was assuming Equality/Equivalence</p>\n<p><a href=\"http://hl7.org/fhirpath/#equality\">http://hl7.org/fhirpath/#equality</a><br>\n\"For complex types, equality requires all child properties to be equal, recursively.\"</p>\n<p>and I think we're running into: \"Note that this implies that if the collections have a different number of items to compare, the result will be false.\"</p>\n<p><a href=\"https://www.hl7.org/fhir/fhirpath.html#changes\">https://www.hl7.org/fhir/fhirpath.html#changes</a><br>\n<a href=\"/user_uploads/10155/1X8vR-KckbJxyFkCDxXIVFP3/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/1X8vR-KckbJxyFkCDxXIVFP3/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/1X8vR-KckbJxyFkCDxXIVFP3/image.png\"></a></div>",
        "id": 243359193,
        "sender_full_name": "David Simons",
        "timestamp": 1624268443
    }
]