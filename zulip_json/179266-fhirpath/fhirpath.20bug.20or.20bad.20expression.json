[
    {
        "content": "<p>I've written a fhirpath expression that works on <a href=\"https://hl7.github.io/fhirpath.js/\" target=\"_blank\" title=\"https://hl7.github.io/fhirpath.js/\">https://hl7.github.io/fhirpath.js/</a> but not in the java FhirPath engine implementation. More specifically the following should evaluate to true (and does so on <a href=\"https://hl7.github.io/fhirpath.js/\" target=\"_blank\" title=\"https://hl7.github.io/fhirpath.js/\">https://hl7.github.io/fhirpath.js/</a>):</p>\n<div class=\"codehilite\"><pre><span></span>extension.where(&#39;http://ehealth.sundhed.dk/fhir/StructureDefinition/ehealth-responsible&#39;).valueReference in participant.extension.where(&#39;http://ehealth.sundhed.dk/fhir/StructureDefinition/ehealth-ext-careteam&#39;).valueReference or extension.where(&#39;http://ehealth.sundhed.dk/fhir/StructureDefinition/ehealth-responsible&#39;).valueReference in participant.actor.reference\n</pre></div>\n\n\n<p>applied on </p>\n<div class=\"codehilite\"><pre><span></span>{\n   &quot;resourceType&quot;:&quot;Appointment&quot;,\n   &quot;meta&quot;:{\n      &quot;profile&quot;:[\n         &quot;http://ehealth.sundhed.dk/fhir/StructureDefinition/ehealth-videoappointment&quot;\n      ]\n   },\n   &quot;extension&quot;:[\n      {\n         &quot;url&quot;:&quot;http://ehealth.sundhed.dk/fhir/StructureDefinition/ehealth-responsible&quot;,\n         &quot;valueReference&quot;:{\n            &quot;reference&quot;:&quot;http://organization.inttest.ehealth.sundhed.dk/fhir/CareTeam/63d82214-ee30-4e3c-a5d7-efa1a77acb06&quot;\n         }\n      }\n   ],\n   &quot;status&quot;:&quot;booked&quot;,\n   &quot;appointmentType&quot;:{\n      &quot;coding&quot;:[\n         {\n            &quot;system&quot;:&quot;http://ehealth.sundhed.dk/cs/appointmenttype-codes&quot;,\n            &quot;code&quot;:&quot;CHECKUP&quot;\n         }\n      ]\n   },\n   &quot;reason&quot;:[\n      {\n         &quot;coding&quot;:[\n            {\n               &quot;system&quot;:&quot;http://snomed.info/sct&quot;,\n               &quot;code&quot;:&quot;219006&quot;\n            }\n         ]\n      }\n   ],\n   &quot;description&quot;:&quot;124ba7e4-558e-4cb1-b497-9e78bab45a7a&quot;,\n   &quot;start&quot;:&quot;2019-11-01T14:07:20.901+01:00&quot;,\n   &quot;end&quot;:&quot;2019-11-01T14:07:20.901+01:00&quot;,\n   &quot;participant&quot;:[\n      {\n         &quot;actor&quot;:{\n            &quot;reference&quot;:&quot;http://organization.inttest.ehealth.sundhed.dk/fhir/Practitioner/dc8a1213-99ff-4553-879d-295a0a431e8d&quot;\n         },\n         &quot;status&quot;:&quot;accepted&quot;\n      },\n      {\n         &quot;actor&quot;:{\n            &quot;reference&quot;:&quot;http://organization.inttest.ehealth.sundhed.dk/fhir/Practitioner/54283316-077e-4d71-8280-92256de1ab2c&quot;\n         },\n         &quot;status&quot;:&quot;accepted&quot;\n      },\n      {\n         &quot;extension&quot;:[\n            {\n               &quot;url&quot;:&quot;http://ehealth.sundhed.dk/fhir/StructureDefinition/ehealth-ext-careteam&quot;,\n               &quot;valueReference&quot;:{\n                  &quot;reference&quot;:&quot;http://organization.inttest.ehealth.sundhed.dk/fhir/CareTeam/63d82214-ee30-4e3c-a5d7-efa1a77acb06&quot;\n               }\n            }\n         ]\n      }\n   ]\n}\n</pre></div>\n\n\n<p>Is my expression malformed or is it a bug in the Java implementation?</p>",
        "id": 179625526,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1572614802
    },
    {
        "content": "<p>apparently rewriting it to </p>\n<div class=\"codehilite\"><pre><span></span>(extension(&#39;http://ehealth.sundhed.dk/fhir/StructureDefinition/ehealth-responsible&#39;).first().value.reference in participant.extension(&#39;http://ehealth.sundhed.dk/fhir/StructureDefinition/ehealth-ext-careteam&#39;).first().value.reference) or (extension(&#39;http://ehealth.sundhed.dk/fhir/StructureDefinition/ehealth-responsible&#39;).first().value.reference in participant.actor.reference)\n</pre></div>\n\n\n<p>made it work ... I can't however say how .... ?</p>",
        "id": 179629206,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1572617627
    },
    {
        "content": "<p>This bit seems incorrect to me: <code>extension.where('http://ehealth.sundhed.dk/fhir/StructureDefinition/ehealth-responsible')</code>, because what this is saying is \"extensions where _the string value '<a href=\"http://.\" target=\"_blank\" title=\"http://.\">http://.</a>..'\", which depending on the strictness of your evaluator will either be interpreted as just \"true\", or a type error. The expressed passed to the where function is expected to evaluate to a boolean. The rewrite is actually using the <code>extension()</code> function to access the extension.</p>",
        "id": 179631740,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1572619449
    },
    {
        "content": "<p>the rewrite also encapsulates both sides of the 'or' in parentheses which also seemed necessary</p>",
        "id": 179631879,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1572619550
    },
    {
        "content": "<p>That bit doesn't seem right to me, you shouldn't need to put that in parentheses to get it to evaluate.</p>",
        "id": 179632237,
        "sender_full_name": "Bryn Rhodes",
        "timestamp": 1572619794
    },
    {
        "content": "<p>removing 'first()' was also needed as soon as my test data was expanded</p>",
        "id": 179634937,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1572621672
    },
    {
        "content": "<p>For the extension.where, I think you need \"url=\" in front of the URL in the \"where\" call, like:</p>\n<div class=\"codehilite\"><pre><span></span>extension.where(url = &#39;http://ehealth.sundhed.dk/fhir/StructureDefinition/ehealth-responsible&#39;)...\n</pre></div>",
        "id": 179640816,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1572625608
    },
    {
        "content": "<p>you can use either extension.where(url = '') or extension(''') as a short cut. won't work if you mix them. Also, valueReference is not a valid in FHIR Path - it's just value. So value.reference works</p>",
        "id": 179662196,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1572640018
    },
    {
        "content": "<blockquote>\n<p>Also, valueReference is not a valid in FHIR Path - it's just value. </p>\n</blockquote>\n<p>True, and that is an issue we haven't addressed yet in fhirpath.js, for which valueReference is still necessary.</p>",
        "id": 179662580,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1572640314
    }
]