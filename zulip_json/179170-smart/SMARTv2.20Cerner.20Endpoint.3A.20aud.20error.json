[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"195155\">@Max Philips</span> when I try to authorize against the Cerner server I'm getting </p>\n<blockquote>\n<p>error_uri: <a href=\"https://authorization.cerner.com/errors/urn%3Acerner%3Aerror%3Aauthorization-server%3Asmart-v1%3Agrant%3Alaunch%3Aaudience-not-white-listed/instances/05d8b1bb-a7b4-44bf-a51f-db523d0aa55f?persona=patient&amp;client=aa95d23c-8a3c-4155-ac73-c5c4226f9ef2&amp;tenant=ec2458f2-1e24-41c8-b71b-0e701af7583d\">https://authorization.cerner.com/errors/urn%3Acerner%3Aerror%3Aauthorization-server%3Asmart-v1%3Agrant%3Alaunch%3Aaudience-not-white-listed/instances/05d8b1bb-a7b4-44bf-a51f-db523d0aa55f?persona=patient&amp;client=aa95d23c-8a3c-4155-ac73-c5c4226f9ef2&amp;tenant=ec2458f2-1e24-41c8-b71b-0e701af7583d</a></p>\n</blockquote>\n<p>... but I'm passing along</p>\n<div class=\"codehilite\"><pre><span></span><code>aud=https%3A%2F%2Ffhir-myrecord.stagingcerner.com%2Fbeta%2Fec2458f2-1e24-41c8-b71b-0e701af7583d\n</code></pre></div>",
        "id": 222784160,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1610658426
    },
    {
        "content": "<p>(I've also tried with a trailing <code>/</code> in my aud, same result.)</p>",
        "id": 222784181,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1610658441
    },
    {
        "content": "<p>Is this a known issue?</p>",
        "id": 222784188,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1610658448
    },
    {
        "content": "<p>this is not a known issue, let me check it out</p>",
        "id": 222784591,
        "sender_full_name": "Max Philips",
        "timestamp": 1610658643
    },
    {
        "content": "<p>oopsie, looks like i didn't test this properly, that's the aud you'd expect to use. if you can customize that value an aud of https%3A%2F%2Ffhir-myrecord.cerner.com%2Fr4%2Fec2458f2-1e24-41c8-b71b-0e701af7583d should work at the moment but let me see if i can fix this up</p>",
        "id": 222786023,
        "sender_full_name": "Max Philips",
        "timestamp": 1610659279
    },
    {
        "content": "<p>I see, one has <code>.stagingcerner.com</code> and the other has <code>cerner.com</code>. I can't easily decouple the FHIR server from the <code>aud</code> -- would be great if you can let me know when they're synced up.</p>",
        "id": 222786507,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1610659506
    },
    {
        "content": "<p>will do</p>",
        "id": 222786545,
        "sender_full_name": "Max Philips",
        "timestamp": 1610659532
    },
    {
        "content": "<p>yeah and r4 vs beta - the aud that works now is Cerner's non-connectathon URL :)</p>",
        "id": 222786617,
        "sender_full_name": "Max Philips",
        "timestamp": 1610659563
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> this should work now! no trailing slash is what i'm testing with</p>",
        "id": 222788436,
        "sender_full_name": "Max Philips",
        "timestamp": 1610660440
    },
    {
        "content": "<p>I've made it as far as a login screen! I don't see the login details <a href=\"https://github.com/MaxPhilips/wgm_notes/blob/26/smart_v2/test_server_faq.md\">in your GH doc</a> though <span class=\"user-mention\" data-user-id=\"195155\">@Max Philips</span> . How do I sign in?</p>",
        "id": 222919148,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1610741833
    },
    {
        "content": "<p>they should be in there - nancysmart / Cerner01</p>",
        "id": 222920013,
        "sender_full_name": "Max Philips",
        "timestamp": 1610742225
    },
    {
        "content": "<p>Thanks! I missed these and searched for \"user\", \"login\", \"password\", etc and didn't find this :)</p>",
        "id": 222920590,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1610742469
    },
    {
        "content": "<p>i'll put some more conspicuous keywords near them :)</p>",
        "id": 222920713,
        "sender_full_name": "Max Philips",
        "timestamp": 1610742511
    },
    {
        "content": "<p>Now I'm getting further, to <a href=\"/user_uploads/10155/ix0aZfFCN7SiW3JCbKF5JVpf/image.png\">image.png</a>  but can't click \"Allow Access\"; cancel is my only option.</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/ix0aZfFCN7SiW3JCbKF5JVpf/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/ix0aZfFCN7SiW3JCbKF5JVpf/image.png\"></a></div>",
        "id": 222920775,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1610742541
    },
    {
        "content": "<p>Keith ran into this too - for Cerner's case we require that you request patient/Observation.read as well as the new scopes in order to give our non-connectathon auth server something to think about on that screen</p>",
        "id": 222921112,
        "sender_full_name": "Max Philips",
        "timestamp": 1610742669
    },
    {
        "content": "<p>This was the case in sept too and I think Gino enhanced the <a href=\"http://smart.argo.run\">smart.argo.run</a> client to allow other scopes to be requested</p>",
        "id": 222921182,
        "sender_full_name": "Max Philips",
        "timestamp": 1610742699
    },
    {
        "content": "<p>Thanks!</p>",
        "id": 222921228,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1610742713
    },
    {
        "content": "<p>Yeah, I have extra checkboxes I can use (would be great if you can patch up this behavior at some point for consistency of testing)</p>",
        "id": 222921317,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1610742739
    },
    {
        "content": "<p>Looks like I can't do token introspection from the browser:</p>\n<blockquote>\n<p>Access to fetch at '<a href=\"https://authorization.cerner.com/tokeninfo\">https://authorization.cerner.com/tokeninfo</a>' from origin '<a href=\"https://smart.argo.run\">https://smart.argo.run</a>' has been blocked by CORS policy: Response to preflight request doesn't pass access control check: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.</p>\n</blockquote>\n<p>... is this intentional?</p>",
        "id": 222921438,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1610742804
    },
    {
        "content": "<p>huh, let me check that out</p>",
        "id": 222921539,
        "sender_full_name": "Max Philips",
        "timestamp": 1610742854
    },
    {
        "content": "<p>And when I call token introspection outside the browser I get </p>\n<div class=\"codehilite\"><pre><span></span><code>{\n  &quot;active&quot;: true,\n  &quot;scope&quot;: &quot;openid profile patient/Observation.rs patient/Observation.read&quot;,\n  &quot;client_id&quot;: &quot;aa95d23c-8a3c-4155-ac73-c5c4226f9ef2&quot;,\n  &quot;tenant_id&quot;: &quot;ec2458f2-1e24-41c8-b71b-0e701af7583d&quot;\n}\n</code></pre></div>\n<p>which is missing <code>patient</code> and <code>fhirUser</code>  and <code>sub</code> and <code>iss</code>.</p>",
        "id": 222921703,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1610742947
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span>  I had previously raised some concerns about fhiruser there as our auth system doesn't currently have that type of info available at that point</p>",
        "id": 222922820,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1610743561
    },
    {
        "content": "<p>OK; we tailored the language to reflect <code>SHALL</code> for <code>iss</code> and <code>sub</code>, and <code>SHOULD</code> for <code>fhirUser</code>. Are you still comfortable with those as the formal requirements?</p>",
        "id": 222924449,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1610744352
    },
    {
        "content": "<p>no luck on CORS for token introspection yet. can you link me to the documentation around those other claims?</p>",
        "id": 222928490,
        "sender_full_name": "Max Philips",
        "timestamp": 1610746402
    },
    {
        "content": "<p>Docs at <a href=\"http://build.fhir.org/ig/HL7/smart-app-launch/token-introspection.html#conditional-fields-in-the-introspection-response\">http://build.fhir.org/ig/HL7/smart-app-launch/token-introspection.html#conditional-fields-in-the-introspection-response</a></p>",
        "id": 222930829,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1610747780
    },
    {
        "content": "<p>I was having a lot of troubles getting past that first page but I see now you can go back up to the TOC</p>",
        "id": 222935893,
        "sender_full_name": "Max Philips",
        "timestamp": 1610750289
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span>  What is the use case for a browser to call a token introspection endpoint? Usually the use case is for a server/service to make an access decision</p>",
        "id": 223247750,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1611072164
    },
    {
        "content": "<p>Agreed, re: the usual/most-important use case. For the connectathon the use case for a browser to call token introspection was just \"we're writing a browser app to test a bunch of stuff\".  Outside of testing, the main example I'd think about is explicit tracking of token expiration. You can always try using a token and see if it fails, but it's nice to have an explicit API to tell you whether it's valid, rather than needing to infer reasons for failure.</p>",
        "id": 223257316,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1611075963
    },
    {
        "content": "<p>I believe we tell users to use the OAuth 2 returned parameters for expiration and not to wait until failure</p>",
        "id": 223259786,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1611076887
    },
    {
        "content": "<p>We wouldn't recommend introspection for that (and there's nothing in the response that tells you it fails b/c it's expired)</p>",
        "id": 223259861,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1611076918
    },
    {
        "content": "<p>The url being used in the connectathon was our production endpoint - we wouldn't likely implement CORS there</p>",
        "id": 223259955,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1611076942
    },
    {
        "content": "<p>since it's not an endpoint we actually want browsers to call</p>",
        "id": 223260010,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1611076965
    },
    {
        "content": "<p>When you talk about using the return parameters you mean an expected duration? This is good but tokens can in general be expired sooner.</p>",
        "id": 223260516,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1611077153
    },
    {
        "content": "<p>in any case I don't think there's a deep need to have CORS support for this endpoint; just want to make sure this is a considered decision if you're going to omit it</p>",
        "id": 223260615,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1611077180
    },
    {
        "content": "<p>expires_in: <a href=\"https://tools.ietf.org/html/rfc6749#section-5.1\">https://tools.ietf.org/html/rfc6749#section-5.1</a></p>",
        "id": 223260747,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1611077225
    },
    {
        "content": "<p>That is expected to be accurate</p>",
        "id": 223260869,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1611077265
    },
    {
        "content": "<p>if it's returned</p>",
        "id": 223260878,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1611077269
    },
    {
        "content": "<p>when you say they can \"in general expire sooner\" what do you mean?</p>",
        "id": 223260966,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1611077286
    },
    {
        "content": "<p>(and we're speaking access token, not refresh token)</p>",
        "id": 223260988,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1611077295
    },
    {
        "content": "<p>(and if it's not returned, servers are supposed to provide documentation or something else instead... but I'm curious what servers don't currently provide that today)</p>",
        "id": 223261115,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1611077350
    },
    {
        "content": "<blockquote>\n<p>Jenni Syed: when you say they can \"in general expire sooner\" what do you mean?</p>\n</blockquote>\n<p>I just mean... a token I have that's intended to last 3600s might actually be invalidated by a server before 3600s is up.</p>",
        "id": 223296579,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1611091281
    },
    {
        "content": "<p>Ours doesn't work that way (our tokens are also much shorter lived). In systems that do longer lived tokens, usually tokens are invalidated not because they expire - ie, a refresh wouldn't fix it, it's because the auth itself was revoked either due to security or patient choice?</p>",
        "id": 223304728,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1611094716
    },
    {
        "content": "<p>IE: wouldn't the app need to go back through full auth again, not just a refresh?</p>",
        "id": 223304751,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1611094726
    },
    {
        "content": "<p>If we have someone asking for this use case, do we have something more concrete?</p>",
        "id": 223305014,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1611094840
    },
    {
        "content": "<p>As I said above, I don't think there's a deep need to have CORS support for the token introspection; I just wanted to make sure that this is a considered decision if you're omitting it.</p>",
        "id": 223306600,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1611095683
    },
    {
        "content": "<p>Yes, today I believe it's not a use case we would encourage nor expect based on current asks</p>",
        "id": 223306668,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1611095724
    },
    {
        "content": "<p>our introspection endpoint has been in prod for a while now :)</p>",
        "id": 223306694,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1611095742
    }
]