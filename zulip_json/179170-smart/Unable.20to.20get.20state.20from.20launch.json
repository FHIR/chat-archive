[
    {
        "content": "<p>Hi,</p>\n<p>During the initial launch of a SMART client app from the logica sandbox or SMART app launcher, we receive the following error: <br>\n<code> Error: No state found! Please (re)launch the app. </code></p>\n<p>Does anyone know how to solve this ?</p>\n<p>Thanks, <br>\nChrista, <span class=\"user-mention\" data-user-id=\"193795\">@Joel Francis</span> , <span class=\"user-mention\" data-user-id=\"192545\">@Alex Goel</span> , <span class=\"user-mention\" data-user-id=\"416084\">@Paul Puscas</span></p>",
        "id": 240857000,
        "sender_full_name": "Christa Wan",
        "timestamp": 1622482583
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"193731\">@Vladimir Ignatov</span> we saw you posted an answer to similar question on github <a href=\"https://github.com/smart-on-fhir/growth-chart-app/issues/18\">https://github.com/smart-on-fhir/growth-chart-app/issues/18</a> </p>\n<p>but we're trying to launch the app through Firebase (<a href=\"http://firebase.google.com/\">firebase.google.com/</a>). </p>\n<p>We noticed that the state is getting passed through the URL, but our app (using the SMART JS framework) isn't doing anything with it it seems</p>",
        "id": 240857842,
        "sender_full_name": "Alex Goel",
        "timestamp": 1622483282
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"192545\">Alex Goel</span> <a href=\"#narrow/stream/179170-smart/topic/Unable.20to.20get.20state.20from.20launch/near/240857842\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"193731\">Vladimir Ignatov</span> we saw you posted an answer to similar question on github <a href=\"https://github.com/smart-on-fhir/growth-chart-app/issues/18\">https://github.com/smart-on-fhir/growth-chart-app/issues/18</a> </p>\n<p>but we're trying to launch the app through Firebase (<a href=\"http://firebase.google.com/\">firebase.google.com/</a>). </p>\n<p>We noticed that the state is getting passed through the URL, but our app (using the SMART JS framework) isn't doing anything with it it seems</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"191496\">@Nikolai Schwertner</span></p>",
        "id": 240887232,
        "sender_full_name": "Joel Francis",
        "timestamp": 1622512929
    },
    {
        "content": "<p>Can you explain what you mean by \"launch the app through Firebase\"? Who is launching it and how? Is it a browser app or NodeJS? Is it EHR launch or standalone? Can you provide a link to the app itself?</p>",
        "id": 240942655,
        "sender_full_name": "Vladimir Ignatov",
        "timestamp": 1622554662
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"400829\">@Christa Wan</span> I ran into a similar issue trying to get the <code>client-js</code> library working with a vendor sandbox.  Have you tried putting some debugging statements around <a href=\"https://github.com/smart-on-fhir/client-js/blob/master/src/smart.ts#L583\">where this error is getting thrown</a>?</p>",
        "id": 240977084,
        "sender_full_name": "David Winters",
        "timestamp": 1622568927
    },
    {
        "content": "<p>You need to first launch by calling <code>FHIR.oauth2.authorize()</code> which takes your configuration and creates a redirect url and then performs the redirect.  <code>client-js</code> stores information in the local store, which is referenced after authorization redirects back to your app.  You should have a call to <code>FHIR.oauth2.ready()</code> on the page of this final redirection.  The issue I was running into was that I didn't have my redirect url specified correctly.</p>",
        "id": 240978020,
        "sender_full_name": "David Winters",
        "timestamp": 1622569355
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"193731\">@Vladimir Ignatov</span> ,  </p>\n<p>We are trying to use the Logica sandbox to provide patient data to our Node.JS application that is currently running on Firebase. The app works on the SMART app launcher without a proxy, but we require a proxy to forward the information to our app due to an issue we had with the CORS header. Once we add the CORS header via proxy, we get the error as specified above </p>\n<div class=\"codehilite\"><pre><span></span><code>Error: No state found! Please (re)launch the app.\n</code></pre></div>\n<p>The app can be found at this link: <a href=\"https://smart-on-fhir-17eef.web.app/\">https://smart-on-fhir-17eef.web.app/</a>, and it is an EHR Launch. We are receiving the state from the URL from Logica (seen through fiddler), but for some reason we are still getting this error. </p>\n<p>Thanks.</p>",
        "id": 240978075,
        "sender_full_name": "Christa Wan",
        "timestamp": 1622569379
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"193731\">@Vladimir Ignatov</span>  <span class=\"user-mention\" data-user-id=\"195840\">@David Winters</span> thank you for your responses. </p>\n<p>The application is hosted on Firebase - what I mean by this is the project directory and resources are served using Firebase. The app is launched using the Logica STU3 sandbox. <span class=\"user-mention\" data-user-id=\"195840\">@David Winters</span>  in reply to your suggestions about CORS, to get around it, we use a proxy to inject the Allow-Cors header into the request and pass it through to the app hosted on Firebase. </p>\n<p>What we are finding is that the fhire-client.js is complaining on line 583 of smart.ts where it checks the url parameters for the state and complains of no state and asks re-launch of the app. Using fiddler we are able to see the re-direct to our index page with a \"code\" and a \"state\" parameter both obviously not empty.</p>\n<p><span class=\"user-mention\" data-user-id=\"193731\">@Vladimir Ignatov</span> we will host our proxy on a server and give you access to the app as soon as we can. We currently have the proxy on localhost.  Thank you <span class=\"user-mention\" data-user-id=\"193731\">@Vladimir Ignatov</span>  and <span class=\"user-mention\" data-user-id=\"195840\">@David Winters</span>  for the response and help. </p>\n<p><span class=\"user-mention\" data-user-id=\"192545\">@Alex Goel</span></p>",
        "id": 240978462,
        "sender_full_name": "Joel Francis",
        "timestamp": 1622569560
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"195840\">@David Winters</span> ,</p>\n<p>We have both of these calls - The first one <code>FHIR.oauth2.authorize()</code> in our launch.html, which specifies the Redirect URI as index.html, which contains our call to the <code>FHIR.oauth2.authorize()</code>function.</p>",
        "id": 240978515,
        "sender_full_name": "Christa Wan",
        "timestamp": 1622569568
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"193795\">@Joel Francis</span> have you looked into <a href=\"https://github.com/smart-on-fhir/client-js/blob/master/src/smart.ts#L511\">line 511</a>?  <code>state</code> is getting pulled from storage, which I think comes from the session if you're in the browser.</p>",
        "id": 240979882,
        "sender_full_name": "David Winters",
        "timestamp": 1622570211
    },
    {
        "content": "<p>Sounds like somehow your <code>authorize()</code> and <code>ready()</code> calls aren't working off of the same session.</p>",
        "id": 240980396,
        "sender_full_name": "David Winters",
        "timestamp": 1622570422
    },
    {
        "content": "<blockquote>\n<p>Sounds like somehow your authorize() and ready() calls aren't working off of the same session.</p>\n</blockquote>\n<p>Exactly. Your <code>SessionStorage</code> is empty but it shouldn't be. How is your <code>launch_url</code> configured in Logica? Is it on the same <code>origin</code> as your app ( <a href=\"https://smart-on-fhir-17eef.web.app\">https://smart-on-fhir-17eef.web.app</a>)? Perhaps the proxy is messing with that (although it does work with the <a href=\"https://launch.smarthealthit.org/?auth_error=&amp;fhir_version_1=r4&amp;fhir_version_2=r4&amp;iss=&amp;launch_ehr=1&amp;launch_url=https%3A%2F%2Fsmart-on-fhir-17eef.web.app%2Flaunch.html&amp;patient=&amp;prov_skip_auth=1&amp;provider=&amp;pt_skip_auth=1&amp;public_key=&amp;sb=&amp;sde=&amp;sim_ehr=0&amp;token_lifetime=15&amp;user_pt=\">SMART Launcher</a>)?</p>",
        "id": 240983795,
        "sender_full_name": "Vladimir Ignatov",
        "timestamp": 1622571864
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"193731\">@Vladimir Ignatov</span> <span class=\"user-mention\" data-user-id=\"195840\">@David Winters</span> </p>\n<p>The registered launch url in the logica sanbox  and the redirect_uri are different and we get the same error consistently on Logica and the SMART app Launcher. </p>\n<p>The Launch_URL is to our proxy server which is just literally adds the CORS header to the request and then forwards it to the Launch.html of our app where we call the ``` FHIR.oauth2.authorize()```` . Then the redirect is back to the app but to the index.html page where we call the  ready() function. </p>\n<p>So what the both of you are saying is that there is somehow two different sessions and no preservation of the \"state\" of the fhir-client.js state and not the \"state\" that comes from the FHIR server???? </p>\n<p>Without the proxy we were encountering a CORS issue. So <span class=\"user-mention\" data-user-id=\"195840\">@David Winters</span> , using your amended fhir client, we can add the cors header?</p>",
        "id": 241065313,
        "sender_full_name": "Joel Francis",
        "timestamp": 1622576742
    },
    {
        "content": "<p>In this case \"state\" is just an entry in <code>SessionStorage</code>. SessionStorage is namespaced per origin. If launch.html is hosted at <a href=\"http://a/launch.html\">http://a/launch.html</a>, it will write a few things to <code>SessionStorage</code>, assuming that <code>app.html</code> will find those after the redirect. However, if the app is on <a href=\"http://b/index.html\">http://b/index.html</a>, it will not be able to see anything that <code>launch.html</code> wrote... Can't you run them both through the same proxy then?</p>",
        "id": 241066885,
        "sender_full_name": "Vladimir Ignatov",
        "timestamp": 1622577462
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"193731\">Vladimir Ignatov</span> <a href=\"#narrow/stream/179170-smart/topic/Unable.20to.20get.20state.20from.20launch/near/241066885\">said</a>:<br>\n.. Can't you run them both through the same proxy then?</p>\n<p><span class=\"user-mention\" data-user-id=\"193731\">@Vladimir Ignatov</span>  trying to understand by reiterating what you are saying - have the application redirect back to the proxy and then call index.hmtl in which case  index.html has to be part of the same cluster or on the same host?</p>",
        "id": 241067562,
        "sender_full_name": "Joel Francis",
        "timestamp": 1622577750
    },
    {
        "content": "<p>What I'm saying is that in Logica, if your \"Launch URL\" is <code>https://my.proxy/launch.html</code>, then your \"Redirect URL\" should be <code>https://my.proxy/app.html</code></p>",
        "id": 241069000,
        "sender_full_name": "Vladimir Ignatov",
        "timestamp": 1622578439
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"193731\">Vladimir Ignatov</span> <a href=\"#narrow/stream/179170-smart/topic/Unable.20to.20get.20state.20from.20launch/near/241069000\">said</a>:</p>\n<blockquote>\n<p>What I'm saying is that in Logica, if your \"Launch URL\" is <code>https://my.proxy/launch.html</code>, then your \"Redirect URL\" should be <code>https://my.proxy/app.html</code></p>\n</blockquote>\n<p>exactly! <span class=\"user-mention\" data-user-id=\"193731\">@Vladimir Ignatov</span>  we will give that a try. Thanks <span class=\"user-mention\" data-user-id=\"193731\">@Vladimir Ignatov</span> and  <span class=\"user-mention\" data-user-id=\"195840\">@David Winters</span></p>",
        "id": 241069749,
        "sender_full_name": "Joel Francis",
        "timestamp": 1622578823
    },
    {
        "content": "<p>In general, there is no requirement that the launch and redirect URIs of an application are on the same domain either by SMART or Logica. It just happens that the SMART JS client (that you are using) has this limitation.</p>",
        "id": 241158784,
        "sender_full_name": "Nikolai Schwertner",
        "timestamp": 1622644992
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"193731\">@Vladimir Ignatov</span> , </p>\n<p>We have tried to replace the Redirect URI with our proxy  server. However, we are now getting the CORS header error again, as shown below: <a href=\"/user_uploads/10155/CcJ47YXk84Hw049Y90m_lroM/Screen-Shot-2021-06-02-at-10.43.04-AM.png\">Screen-Shot-2021-06-02-at-10.43.04-AM.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/CcJ47YXk84Hw049Y90m_lroM/Screen-Shot-2021-06-02-at-10.43.04-AM.png\" title=\"Screen-Shot-2021-06-02-at-10.43.04-AM.png\"><img src=\"/user_uploads/10155/CcJ47YXk84Hw049Y90m_lroM/Screen-Shot-2021-06-02-at-10.43.04-AM.png\"></a></div><p>Thanks, <br>\nChrista</p>",
        "id": 241159073,
        "sender_full_name": "Christa Wan",
        "timestamp": 1622645108
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191496\">Nikolai Schwertner</span> <a href=\"#narrow/stream/179170-smart/topic/Unable.20to.20get.20state.20from.20launch/near/241158784\">said</a>:</p>\n<blockquote>\n<p>In general, there is no requirement that the launch and redirect URIs of an application are on the same domain either by SMART or Logica. It just happens that the SMART JS client (that you are using) has this limitation.</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"191496\">@Nikolai Schwertner</span>  thank you for pointing this out  as were were wondering why have the redirect_uri in the first place.</p>",
        "id": 241159359,
        "sender_full_name": "Joel Francis",
        "timestamp": 1622645211
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191496\">Nikolai Schwertner</span> <a href=\"#narrow/stream/179170-smart/topic/Unable.20to.20get.20state.20from.20launch/near/241158784\">said</a>:</p>\n<blockquote>\n<p>In general, there is no requirement that the launch and redirect URIs of an application are on the same domain either by SMART or Logica. It just happens that the SMART JS client (that you are using) has this limitation.</p>\n</blockquote>\n<p>That might be true, but it is the only way to to provide out  of the box SMART auth in the browser. The alternative would be to ask users to set up and rely on some kind of external storage service (rather than SessionStorage), just to manage the \"local\" state - not impossible but too complicated for client-side apps...</p>\n<p>Anyhow, if the launch and redirect urls are on the same domain, then it should be working, so the real question is why doesn't it?  Is the token endpoint (and /metadata) sending CORS headers? What exactly is the response status code/message (it says \"does not have HTTP ok status\" in the screenshot)?</p>",
        "id": 241168884,
        "sender_full_name": "Vladimir Ignatov",
        "timestamp": 1622649031
    },
    {
        "content": "<p>We get the OK Status if we use the proxy and the redirect_uri pointing at our SMART app and not the proxy</p>",
        "id": 241309414,
        "sender_full_name": "Alex Goel",
        "timestamp": 1622662893
    },
    {
        "content": "<p>but the SMART app doesn't do anything with the state</p>",
        "id": 241309449,
        "sender_full_name": "Alex Goel",
        "timestamp": 1622662911
    },
    {
        "content": "<p>Sorry, but I cant't try it (has to be done from within your Logica account)</p>\n<p>Try executing this in console <code>localStorage.debug = \"FHIR.*\"</code>, then make sure your console is configured to persist logs. Then re-launch and see if you are getting anything useful in the console.</p>",
        "id": 241311161,
        "sender_full_name": "Vladimir Ignatov",
        "timestamp": 1622663771
    },
    {
        "content": "<blockquote>\n<p>The registered launch url in the logica sanbox and the redirect_uri are different and we get the same error consistently on Logica and the SMART app Launcher.</p>\n</blockquote>\n<p>When you say the SMART app Launcher, do you mean the public SMART sandbox?  If that's the case I would focus on getting the app working with that first.</p>",
        "id": 241316615,
        "sender_full_name": "David Winters",
        "timestamp": 1622666396
    },
    {
        "content": "<p>Thanks Vlad we'll try the debug. </p>\n<p>We're getting the same <code>Error: No state found! Please (re)launch the app.</code> failure to pass the state on both the SMART App Launcher: <a href=\"https://launch.smarthealthit.org/\">https://launch.smarthealthit.org/</a></p>",
        "id": 241331577,
        "sender_full_name": "Alex Goel",
        "timestamp": 1622675850
    },
    {
        "content": "<p>You are probably using wrong settings. Just click the \"Launch App\" button here: <a href=\"https://launch.smarthealthit.org/?auth_error=&amp;fhir_version_1=r4&amp;fhir_version_2=r4&amp;iss=&amp;launch_ehr=1&amp;launch_url=https%3A%2F%2Fsmart-on-fhir-17eef.web.app%2Flaunch.html&amp;patient=&amp;prov_skip_auth=1&amp;provider=&amp;pt_skip_auth=1&amp;public_key=&amp;sb=&amp;sde=&amp;sim_ehr=0&amp;token_lifetime=15&amp;user_pt=\">https://launch.smarthealthit.org/?auth_error=&amp;fhir_version_1=r4&amp;fhir_version_2=r4&amp;iss=&amp;launch_ehr=1&amp;launch_url=https%3A%2F%2Fsmart-on-fhir-17eef.web.app%2Flaunch.html&amp;patient=&amp;prov_skip_auth=1&amp;provider=&amp;pt_skip_auth=1&amp;public_key=&amp;sb=&amp;sde=&amp;sim_ehr=0&amp;token_lifetime=15&amp;user_pt=</a></p>",
        "id": 241331967,
        "sender_full_name": "Vladimir Ignatov",
        "timestamp": 1622676182
    },
    {
        "content": "<p><a href=\"/user_uploads/10155/jHk5LvTEVJdj92KO-8jVdx2_/Screen-Shot-2021-06-02-at-19.33.44.png\">Screen-Shot-2021-06-02-at-19.33.44.png</a> </p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/jHk5LvTEVJdj92KO-8jVdx2_/Screen-Shot-2021-06-02-at-19.33.44.png\" title=\"Screen-Shot-2021-06-02-at-19.33.44.png\"><img src=\"/user_uploads/10155/jHk5LvTEVJdj92KO-8jVdx2_/Screen-Shot-2021-06-02-at-19.33.44.png\"></a></div><p>It works fine when we launch just the app without the proxy on the sandbox. It's able to receive the patient. It does not pass the state when we use the proxy to get around the CORS issue with Logica or with the SMART sandbox.</p>",
        "id": 241332837,
        "sender_full_name": "Alex Goel",
        "timestamp": 1622676942
    },
    {
        "content": "<p>Our proxy is here: <a href=\"https://stormy-plateau-96241.herokuapp.com/\">https://stormy-plateau-96241.herokuapp.com/</a> our app launch is here: <a href=\"http://smart-on-fhir-17eef.web.app/launch.html\">smart-on-fhir-17eef.web.app/launch.html</a> you can replicate our error on the sandbox. It's the same on Logica</p>",
        "id": 241332950,
        "sender_full_name": "Alex Goel",
        "timestamp": 1622677022
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"192545\">Alex Goel</span> <a href=\"#narrow/stream/179170-smart/topic/Unable.20to.20get.20state.20from.20launch/near/241332950\">said</a>:</p>\n<blockquote>\n<p>Our proxy is here: <a href=\"https://stormy-plateau-96241.herokuapp.com/\">https://stormy-plateau-96241.herokuapp.com/</a> our app launch is here: <a href=\"http://smart-on-fhir-17eef.web.app/launch.html\">smart-on-fhir-17eef.web.app/launch.html</a> you can replicate our error on the sandbox. It's the same on Logica</p>\n</blockquote>\n<p>Hello <span class=\"user-mention\" data-user-id=\"193731\">@Vladimir Ignatov</span> <span class=\"user-mention\" data-user-id=\"195840\">@David Winters</span> </p>\n<p>We finally have it working using the SMART sand box and our proxy adds the following headers. It still fails on Logica with a CORS issue.</p>\n<p>res.header(\"Access-Control-Allow-Origin\", process.env.ORIGIN || \"*\");<br>\nres.header(\"Access-Control-Allow-Methods\", process.env.ORIGIN || \"POST, GET, OPTIONS, DELETE, PUT\");<br>\nres.header(\"Access-Control-Allow-Headers\", process.env.ORIGIN || \"append,delete,entries,foreach,get,has,keys,set,values,Authorization\"); </p>\n<p>Thanks <span class=\"user-mention\" data-user-id=\"193731\">@Vladimir Ignatov</span>  and <span class=\"user-mention\" data-user-id=\"195840\">@David Winters</span>  for the help and guidance. Our next step is to try it on another sandbox like Cerner.</p>",
        "id": 241391822,
        "sender_full_name": "Joel Francis",
        "timestamp": 1622727650
    },
    {
        "content": "<p>To be clear, the SMART sandbox does not have a CORS issue and you don't need that proxy.  My advice is:</p>\n<ol>\n<li>If Logica really does have a CORS issue, report that, give them time to fix it and use other sandboxes until they do.</li>\n<li>Don't use that proxy on the SMART sandbox, Cerner or anywhere else</li>\n</ol>",
        "id": 241393616,
        "sender_full_name": "Vladimir Ignatov",
        "timestamp": 1622728508
    }
]