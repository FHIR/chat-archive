[
    {
        "content": "<p>Hi All,</p>\n<p>We are building a proof of concept, to launch a SMART app, from within our EHR. (EHR launch sequence).  We use Keycloak as the Authz server.   We are blocked on 2 aspects of this flow. </p>\n<ol>\n<li>\n<p>At the point of launching the SMART app, user is authn'd and athuz'd and we have a patient in context in the EHR. We are seeding the SMART app with a launch parameter (a launch code that has knowledge of the EHR context) and the fhir resource server url. The expectation is that when tokens are being issued (by keycloak) we would see the patient_id as one of the properties in the json. We are seeing tokens issued. I was expecting to have access to that launch code at the point of setting claims or transforming the access token response but cannot find a way to do that. </p>\n</li>\n<li>\n<p>I created a custom user attribute mapper  to transform the token response to include the patient_id (even hard coding is fine.. at this point) but I just cannot seem to see it in the output. I also tried with a custom OIDCProtocolMapper.. same results. </p>\n</li>\n</ol>\n<p>I'm totally missing something at this point. Any inputs are highly appreciated.</p>",
        "id": 258621131,
        "sender_full_name": "Kalyan Dasika",
        "timestamp": 1634852148
    },
    {
        "content": "<p>These sound like keycloak questions; I wonder if <span class=\"user-mention\" data-user-id=\"191676\">@Lee Surprenant</span> might have insight</p>",
        "id": 258621489,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1634852340
    },
    {
        "content": "<p>Hi Kalyan, did you have a look at <a href=\"https://github.com/Alvearie/keycloak-extensions-for-fhir\">https://github.com/Alvearie/keycloak-extensions-for-fhir</a> yet?</p>",
        "id": 258701378,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1634904077
    },
    {
        "content": "<p>I havn't done much with the EHR launch sequence, but maybe the work I did to support standalone app launch could be informative</p>",
        "id": 258701443,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1634904117
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191676\">@Lee Surprenant</span>  Thank you for that link. Yes it is very informative. With the help of your project and Niko's videos  I am able to make some progress on step 2.  I was able to use this call, </p>\n<p>accessTokenResponse.setOtherClaims(mappingModel.getConfig().get(\"<a href=\"http://claim.name\">claim.name</a>\"), \"SOME_PATIENT_ID2\"); </p>\n<p>in the overridden setClaim method, the one that uses has AccessTokenResponse and now the patient property shows in the token response payload as a top level property (not as a claim in the JWT token) as shown in the sequence diagrams here <a href=\"http://hl7.org/fhir/smart-app-launch/index.html\">http://hl7.org/fhir/smart-app-launch/index.html</a>. I can make an additional call to get the patient in context from the EHR database (from the authz server) for the  EHR user associated with the keycloak session to get the actual patient id.  </p>\n<p>But to get that EHR state look up, I would really like to make use of the launch parameter that initiates this EHR launch sequence. That is getting lost somewhere in the flow, and by the time it gets to token issue time, I don't have that anywhere. Any ideas on this front, on how other authz servers are keeping track of the launch parameter, would be greatly appreciated.</p>",
        "id": 258735433,
        "sender_full_name": "Kalyan Dasika",
        "timestamp": 1634919706
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191676\">Lee Surprenant</span> <a href=\"#narrow/stream/179170-smart/topic/SMART.20on.20FHIR.20EHR.20Launch.20flow/near/258701443\">said</a>:</p>\n<blockquote>\n<p>I havn't done much with the EHR launch sequence, but maybe the work I did to support standalone app launch could be informative</p>\n</blockquote>\n<p>I have a question regarding the standalone launch project you have in git hub. </p>\n<p>How did you get the patient ids for selection? </p>\n<p>I see that there is a resourceId attribute set up for the user  but did not quite follow where in the flow do the patient ids get set prior to looking up the resource server for selection. I'm assuming that its space separated string of ids.</p>",
        "id": 259268033,
        "sender_full_name": "Kalyan Dasika",
        "timestamp": 1635352770
    },
    {
        "content": "<p>Hi Kalyan.  Yes, the assumption is that this happens out-of-band somehow and we have that id.  Its possible to do otherwise, but obviously you need to start with SOMETHING that could get you to the resource id(s).</p>",
        "id": 259274870,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1635355419
    },
    {
        "content": "<blockquote>\n<p>I'm assuming that its space separated string of ids.</p>\n</blockquote>\n<p>correct</p>",
        "id": 259275154,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1635355517
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191676\">@Lee Surprenant</span>  thank you</p>",
        "id": 259299604,
        "sender_full_name": "Kalyan Dasika",
        "timestamp": 1635365535
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191676\">@Lee Surprenant</span>  Thank you so much for sharing your work in the github project. It provided enough ideas for us to implement both the EHR launch and Standalone launch proof of concepts.</p>",
        "id": 260196097,
        "sender_full_name": "Kalyan Dasika",
        "timestamp": 1635972843
    },
    {
        "content": "<p>Could I follow up on this question? I'm having a little trouble understanding how to pull information from the context of a SMART on FHIR EHR launch. I can perform an external launch with authentication without issue, but in these cases, I have a patient ID or I search for it. However, my understanding is that with an EHR launch, this information is somehow passed through the context of the launch, and not something that must be known a priori. </p>\n<p>I think <a href=\"http://www.hl7.org/fhir/smart-app-launch/example-app-launch-public.html#retrieve-access-token\">this example</a> on the HL7 website is where I get stuck.  I can authenticate, including getting the access token, and then write to the server. But in the box \"Issue POST to the token endpoint:\" where does the patient ID come from?</p>",
        "id": 264165223,
        "sender_full_name": "Grey Faulkenberry",
        "timestamp": 1638975012
    },
    {
        "content": "<p>The EHR sends along an opaque parameter called <code>launch</code>   (i.e., as a query param) to the app when it opens the app's launch endpoint.  The app echoes  this parameter back when it redirects to the EHR's \"authorize\" endpoint. The EHR uses this value to tie the session together and based on this value it knows how to populate the patient and any other required context in the access token response (if access is indeed granted).</p>",
        "id": 264165657,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1638975220
    },
    {
        "content": "<p>The example all you pointed to is  showing  a standalone launch,  so it does not demonstrate this perimeter. <a href=\"http://www.hl7.org/fhir/smart-app-launch/app-launch.html#request-2\">http://www.hl7.org/fhir/smart-app-launch/app-launch.html#request-2</a>  is the source of truth and includes an example.</p>",
        "id": 264165866,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1638975299
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> Haha! That's exactly what I needed. And then currently, the only 2 contexts that are generally used are launch/patient and launch/encounter? (with the understanding there may be more in the future)</p>",
        "id": 264184300,
        "sender_full_name": "Grey Faulkenberry",
        "timestamp": 1638982355
    },
    {
        "content": "<p>Yes, that's the right.</p>",
        "id": 264209105,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1638992504
    },
    {
        "content": "<p>Hello, I'm a physician who makes apps as a hobby and I'm new to FHIR development.  I've been through the HL7 FHIR Intermediate course.  However, I'm not understanding something.  If I want to make a third-party app that allows patients access to their data, how can the patient setup a username and password to access their specific EHR data.  Can someone walk me through this?</p>",
        "id": 265453361,
        "sender_full_name": "Michael Albrecht",
        "timestamp": 1639876095
    },
    {
        "content": "<p>They set that up with a healthcare provider, using their portal (e.g., MyChart from Epic)</p>",
        "id": 265453573,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1639876470
    },
    {
        "content": "<p>As an app, you don't see these usernames or passwords ; the OAuth workflow keeps those away from you</p>",
        "id": 265453590,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1639876517
    },
    {
        "content": "<p>So the patient would have to access any app that I create from their portal?  I really just want them to login from my app.</p>",
        "id": 265453643,
        "sender_full_name": "Michael Albrecht",
        "timestamp": 1639876577
    },
    {
        "content": "<p>It's a bad security prospect to force users to share their EHR password with anyone though -- you can see why this is the case?</p>",
        "id": 265453660,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1639876640
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span>. I'm a newbie trying to understand how this would work.  The patient logs into their portal.  How then do they access the app?</p>",
        "id": 265453687,
        "sender_full_name": "Michael Albrecht",
        "timestamp": 1639876783
    },
    {
        "content": "<p><a href=\"https://youtu.be/vYZ2G8hx6DY\">https://youtu.be/vYZ2G8hx6DY</a> at 11 min has a demo from my personal portal account</p>\n<div class=\"youtube-video message_inline_image\"><a data-id=\"vYZ2G8hx6DY\" href=\"https://youtu.be/vYZ2G8hx6DY\"><img src=\"https://uploads.zulipusercontent.net/e012304c95287d10f44bc510f1392ccddbee57ce/68747470733a2f2f692e7974696d672e636f6d2f76692f76595a32473868783644592f64656661756c742e6a7067\"></a></div>",
        "id": 265453806,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1639876985
    },
    {
        "content": "<p>Thank you!  I will watch the full video later.  I will be trying to figure this out for the Meditech EHR, which is what my hospital uses.</p>",
        "id": 265454361,
        "sender_full_name": "Michael Albrecht",
        "timestamp": 1639877908
    },
    {
        "content": "<p>Sure, the workflow with Meditech will be the same as with Epic, Cerner, etc</p>",
        "id": 265454422,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1639878007
    },
    {
        "content": "<p>Did you have to contact EPIC to find the tools to set up this workflow?  I sent a request earlier today to get started with Meditech Greenfield.  I didn't see a way for developers to get started with Meditech otherwise.</p>",
        "id": 265454494,
        "sender_full_name": "Michael Albrecht",
        "timestamp": 1639878167
    },
    {
        "content": "<p>There shouldn't be a cost, but you'll need to register with the EHR as a developer to create a Patient facing app.</p>",
        "id": 265454881,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1639878827
    },
    {
        "content": "<p>Thank you for clearing this up for me.</p>",
        "id": 265454929,
        "sender_full_name": "Michael Albrecht",
        "timestamp": 1639878904
    }
]