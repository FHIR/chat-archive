[
    {
        "content": "<p>Hi all,</p>\n<p>We are testing launching an Java app with <a href=\"https://smart.argo.run/\">https://smart.argo.run/</a> . We are using the following launch parameters:<br>\n    - Validate that my client performs PKCE<br>\n    - Client Identity Validation Method: client-confidential-asymmetric</p>\n<p>We are getting the following response when requesting an access token (<a href=\"http://hl7.org/fhir/smart-app-launch/app-launch.html#obtain-access-token\">http://hl7.org/fhir/smart-app-launch/app-launch.html#obtain-access-token</a>): </p>\n<p>&lt;html&gt;</p>\n<p>&lt;head&gt;<br>\n    &lt;title&gt;502 Bad Gateway&lt;/title&gt;<br>\n&lt;/head&gt;</p>\n<p>&lt;body&gt;<br>\n    &lt;center&gt;<br>\n        &lt;h1&gt;502 Bad Gateway&lt;/h1&gt;<br>\n    &lt;/center&gt;<br>\n    &lt;hr&gt;<br>\n    &lt;center&gt;nginx&lt;/center&gt;<br>\n&lt;/body&gt;</p>\n<p>&lt;/html&gt;</p>\n<p>Do you have any suggestion on how to solve this error? Attached are <a href=\"/user_uploads/10155/OXy1mwUf9gcOTJ8nZuW2zTWb/A.png\">A.png</a> <a href=\"/user_uploads/10155/K1ao1QMaSTIAe0IyICBmVYuL/B.png\">B.png</a> <a href=\"/user_uploads/10155/_Us9CBuAEu9ydGWI3NaATPwu/C.png\">C.png</a> : <br>\nA. jwks.json. <br>\nB. The body of the POST request<br>\nC. The POST request and response (Postman) - which is the same response we are getting in the Java console.</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/OXy1mwUf9gcOTJ8nZuW2zTWb/A.png\" title=\"A.png\"><img src=\"/user_uploads/10155/OXy1mwUf9gcOTJ8nZuW2zTWb/A.png\"></a></div><div class=\"message_inline_image\"><a href=\"/user_uploads/10155/K1ao1QMaSTIAe0IyICBmVYuL/B.png\" title=\"B.png\"><img src=\"/user_uploads/10155/K1ao1QMaSTIAe0IyICBmVYuL/B.png\"></a></div><div class=\"message_inline_image\"><a href=\"/user_uploads/10155/_Us9CBuAEu9ydGWI3NaATPwu/C.png\" title=\"C.png\"><img src=\"/user_uploads/10155/_Us9CBuAEu9ydGWI3NaATPwu/C.png\"></a></div><p>Thanks!</p>",
        "id": 267427880,
        "sender_full_name": "Ricardo Quintano",
        "timestamp": 1641814754
    },
    {
        "content": "<p>Hmm,  thanks for the report!  Will see if we can reproduce with the demo app, and will check error logs -- normally a Bad Gateway error would be transient, but there's not a ton to go on here. Could you also paste the text of the full request inside code block (triple back quotes in zulip)? Screenshots can make it hard to dig into the tokens, etc.</p>",
        "id": 267446896,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1641825795
    },
    {
        "content": "<p>Also, for debugging: you mentioned that you have two validation options turned on in the launcher. Do you get the same errors if you turn off one or both of the validation options?</p>",
        "id": 267448271,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1641826430
    },
    {
        "content": "<p>Thanks Josh!  Here it is. I generated a new one.</p>\n<div class=\"codehilite\"><pre><span></span><code>2022-01-10 15:54:15.476  INFO 1860 --- [nio-8080-exec-7] c.p.r.l.utils.LoggingRequestInterceptor  : URI         : https://smart.argo.run/v/r4/auth/token\n2022-01-10 15:54:15.476  INFO 1860 --- [nio-8080-exec-7] c.p.r.l.utils.LoggingRequestInterceptor  : Method      : POST\n2022-01-10 15:54:15.476  INFO 1860 --- [nio-8080-exec-7] c.p.r.l.utils.LoggingRequestInterceptor  : Headers     : [Accept:&quot;text/plain, application/json, application/*+json, */*&quot;, Content-Type:&quot;application/x-www-form-urlencoded;charset=UTF-8&quot;, Content-Length:&quot;2544&quot;]\n2022-01-10 15:54:15.476  INFO 1860 --- [nio-8080-exec-7] c.p.r.l.utils.LoggingRequestInterceptor  : Request body: code=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjb250ZXh0Ijp7Im5lZWRfcGF0aWVudF9iYW5uZXIiOmZhbHNlLCJzbWFydF9zdHlsZV91cmwiOiJodHRwczovL3NtYXJ0LmFyZ28ucnVuLy9zbWFydC1zdHlsZS5qc29uIiwidmFsX21ldGhvZCI6ImNjLWFzeW0iLCJqd2tzX3VyaSI6Imh0dHA6Ly9sb2NhbGhvc3Q6ODA4MC9qd2tzLmpzb24iLCJqd2tzIjoie1wia2V5c1wiOlt7XCJrdHlcIjpcIlJTQVwiLFwiZVwiOlwiQVFBQlwiLFwidXNlXCI6XCJzaWdcIixcImtpZFwiOlwiZDQ2ZDAwYzMtNGE0YS00YTkxLWExNWMtYzhkOTg2MjMxMTljXCIsXCJhbGdcIjpcIlJTMzg0XCIsXCJuXCI6XCJrRk84VGdpcGItcVFzZ1ZXeldIUm93NG9OOExwdmZIRnQ0NGVuN21ROHBHYmhuMDFQSDBaQzBWZGl4RFc3bnBiV1VfMDZueWpFamtGNTJWSmJyYWwwa05aXzFCNjl1TmUxdGZ0bVJoTW91SGw4aUxhMDMzYnlPdENWcmdVQWNldkJEVko1TnlKbnJZYXNyTWVuNWxSQXZJZTJuRFNCWlVnQ1ZuSTlENjJHbnZZRklyTzd2WkZreHNpYng5TW1Kd2Nxdy1ZNVpfV3hSX2FzX1VHLVFiY1FsTUgxaTVVN2dQMXN2QW5qcF9jdk5aRFk5Zy1iaUphLVQ2SXlQdzhMaFBXSWowRGtXTjdETk95ejQ5UlhGblUzVGpKM2pmMUxLZGpKYnoxc0pfZDhoZlUzRWEzVmVRZVFob1lGMlRzOWFtVmR4QkkzT09HNkgtcmZ5elJPbVJCbFFcIn1dfSIsInBhdGllbnQiOiIyY2RhNWFhZC1lNDA5LTQwNzAtOWExNS1lMWMzNWM0NmVkNWEiLCJlbmNvdW50ZXIiOiIxZTM4Yjc3MS1lYTg3LTQzNDMtYTVhOC02MDAyMjM3NGNiYWEifSwiY2xpZW50X2lkIjoiNDI3Yzk5ZTUtZTZhMC00OWIxLTgyMDEtNGYxOGRjNzVlZjFkIiwiY29kZV9jaGFsbGVuZ2VfbWV0aG9kIjoiUzI1NiIsImNvZGVfY2hhbGxlbmdlIjoiV2FWNHJUeExpcDRuOXVVajF6MmNVcm44WG9RajhjUzdxd3Bydk9zMk8xayIsInNjb3BlIjoibGF1bmNoIGxhdW5jaC9wYXRpZW50IHBhdGllbnQvT2JzZXJ2YXRpb24ucmVhZCBwYXRpZW50L1BhdGllbnQucmVhZCIsInJlZGlyZWN0X3VyaSI6Imh0dHA6Ly9sb2NhbGhvc3Q6ODA4MC9zbWFydC9yZWRpcmVjdCIsImlhdCI6MTY0MTgyNjQ1NSwiZXhwIjoxNjQxODI2NzU1fQ.5aCihPSviKhIG9FrKB_H8dsTKtmpjnVxEuByu-SW1Ck&amp;grant_type=authorization_code&amp;redirect_uri=http%3A%2F%2Flocalhost%3A8080%2Fsmart%2Fredirect&amp;client_assertion_type=urn%3Aietf%3Aparams%3Aoauth%3Aclient-assertion-type%3Ajwt-bearer&amp;client_assertion=eyJqa3UiOiJodHRwOlwvXC9sb2NhbGhvc3Q6ODA4MFwvandrcy5qc29uIiwia2lkIjoiZDQ2ZDAwYzMtNGE0YS00YTkxLWExNWMtYzhkOTg2MjMxMTljIiwidHlwIjoiSldUIiwiYWxnIjoiUlMzODQifQ.eyJpc3MiOiI0MjdjOTllNS1lNmEwLTQ5YjEtODIwMS00ZjE4ZGM3NWVmMWQiLCJzdWIiOiI0MjdjOTllNS1lNmEwLTQ5YjEtODIwMS00ZjE4ZGM3NWVmMWQiLCJhdWQiOiJodHRwczpcL1wvc21hcnQuYXJnby5ydW5cL3ZcL3I0XC9hdXRoXC90b2tlbiIsImV4cCI6MTY0MTgyNjUxNSwianRpIjoiODNlMjI5OWYtZGI3ZC00MWEyLTkyODktMDY0Y2EyY2VmZDVkIn0.II_26YchntrBaETP-i558FzPtf2gd-pSDFvM3-Tg13DoJoC-EPy_UHYXYWVcPtyZQv6jqMWa0bnEqFmIjCsMWmnjq--jIS_Pe01lSDao6mpmdGtGstMXNPqzqLHsj9AOy9ryoncNtv3ZrPsYRjrpxpM1poUTIUeNdYssh52yJdIEqYGuzXIvdws-SUkTjUSAjXj8StZhaz10DG2_7n56xDsQE7TNBkE1c4KHuJoi-c7S3BqowsoEXnBJEJDwzSyYBRUHnJxBctduUjp4fMwSA8g54TOCl4gEwm-4DSlKZbHyvo3Or2mX2-VyeD3ooyaQQZlyglUqFOCuZ2r3sSw_xw&amp;code_verifier=a3nnKLRYw3nvl5ukrrbaispIAGjlnx9j2ZNlJbqEpsU\n</code></pre></div>\n<p>public key</p>\n<div class=\"codehilite\"><pre><span></span><code>{&quot;kty&quot;:&quot;RSA&quot;,&quot;e&quot;:&quot;AQAB&quot;,&quot;use&quot;:&quot;sig&quot;,&quot;kid&quot;:&quot;d46d00c3-4a4a-4a91-a15c-c8d98623119c&quot;,&quot;alg&quot;:&quot;RS384&quot;,&quot;n&quot;:&quot;kFO8Tgipb-qQsgVWzWHRow4oN8LpvfHFt44en7mQ8pGbhn01PH0ZC0VdixDW7npbWU_06nyjEjkF52VJbral0kNZ_1B69uNe1tftmRhMouHl8iLa033byOtCVrgUAcevBDVJ5NyJnrYasrMen5lRAvIe2nDSBZUgCVnI9D62GnvYFIrO7vZFkxsibx9MmJwcqw-Y5Z_WxR_as_UG-QbcQlMH1i5U7gP1svAnjp_cvNZDY9g-biJa-T6IyPw8LhPWIj0DkWN7DNOyz49RXFnU3TjJ3jf1LKdjJbz1sJ_d8hfU3Ea3VeQeQhoYF2Ts9amVdxBI3OOG6H-rfyzROmRBlQ&quot;}\n</code></pre></div>",
        "id": 267448939,
        "sender_full_name": "Ricardo Quintano",
        "timestamp": 1641826699
    },
    {
        "content": "<p>Thanks -- I'm able to reproduce this behavior when I put invalid data into the JWKS box at <a href=\"https://smart.argo.run\">https://smart.argo.run</a> (to be clear, these errors are <em>not</em> helpful and we need to surface better errors -- just want to figure out what's going on first).</p>\n<p>Can you clarify whether you're supplying a JWKS by URL or inline at this form and if line can you share the actual content of this JWKS? Specifically it's important to check that you're pasting a JWKS and not a \"bare\" JWK? (i.e. a JSON structure like <code>{ \"keys\": [{...</code></p>\n<p><a href=\"/user_uploads/10155/N4EwiqMoqor7Q5MdOkEFzBdH/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/N4EwiqMoqor7Q5MdOkEFzBdH/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/N4EwiqMoqor7Q5MdOkEFzBdH/image.png\"></a></div>",
        "id": 267450995,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1641827594
    },
    {
        "content": "<p>In our initial tests we provided the JWKS by URLS.<br>\nAfter your remark we tried in line and it worked. Now we get a 200 - we copied the exact same content from the URL.</p>",
        "id": 267453771,
        "sender_full_name": "Ricardo Quintano",
        "timestamp": 1641828923
    },
    {
        "content": "<p>Here a new example:</p>\n<div class=\"codehilite\"><pre><span></span><code>2022-01-10 16:28:54.269  INFO 23836 --- [nio-8080-exec-5] c.p.r.l.utils.LoggingRequestInterceptor  : URI         : https://smart.argo.run/v/r4/auth/token\n2022-01-10 16:28:54.269  INFO 23836 --- [nio-8080-exec-5] c.p.r.l.utils.LoggingRequestInterceptor  : Method      : POST\n2022-01-10 16:28:54.269  INFO 23836 --- [nio-8080-exec-5] c.p.r.l.utils.LoggingRequestInterceptor  : Headers     : [Accept:&quot;text/plain, application/json, application/*+json, */*&quot;, Content-Type:&quot;application/x-www-form-urlencoded;charset=UTF-8&quot;, Content-Length:&quot;2544&quot;]\n2022-01-10 16:28:54.269  INFO 23836 --- [nio-8080-exec-5] c.p.r.l.utils.LoggingRequestInterceptor  : Request body: code=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjb250ZXh0Ijp7Im5lZWRfcGF0aWVudF9iYW5uZXIiOmZhbHNlLCJzbWFydF9zdHlsZV91cmwiOiJodHRwczovL3NtYXJ0LmFyZ28ucnVuLy9zbWFydC1zdHlsZS5qc29uIiwidmFsX21ldGhvZCI6ImNjLWFzeW0iLCJqd2tzX3VyaSI6Imh0dHA6Ly9sb2NhbGhvc3Q6ODA4MC9qd2tzLmpzb24iLCJqd2tzIjoie1wia2V5c1wiOlt7XCJrdHlcIjpcIlJTQVwiLFwiZVwiOlwiQVFBQlwiLFwidXNlXCI6XCJzaWdcIixcImtpZFwiOlwiZmIzOGNlOWYtMjUwYS00YTA1LThhZTItNDExMzkxZjkzZDViXCIsXCJhbGdcIjpcIlJTMzg0XCIsXCJuXCI6XCJ6SkdTNTNYNl8waXNkWldUY3p3LURoaHBfaE01UDVJTTE1eW50VS1qcTM4RHAxWHN3UWRUX2xRQ1ZjWEZlSUpJWmVzQ0dvWmdZRVRFYXJXQ19UZmJULUo2Q09QaFZDTUJvaE9pLXEtdktXVXgwcTJqa0hjc3ZEVHp3Vk9xcUQzX0UxSjBxdGRjYWluRnlnbk44TGo3N2E4RFVCcFdZc0NuN1VXZldhelhkQzFCYlBYTWYyRFByWmNfUFlocS1wd2g0UDUtd3l1WE1wRWYyUjFQRVJYc1VaZkdXeDBBVEw2VU5PS2JMdXd3RkRBWFZOdmI4R2tLWG5nNjI2cWw5TENBWUR4V1UxM0JRcXZrREcwaTVRY01PT1RFNzczcEJsbUtTc0thNnlOeVFZaGh1TUVhU3hQRE9mUTJWc2NzamltNnBIWHA0ZWN3RHVpemlGRXNwMFNIaHdcIn1dfSIsInBhdGllbnQiOiIyY2RhNWFhZC1lNDA5LTQwNzAtOWExNS1lMWMzNWM0NmVkNWEiLCJlbmNvdW50ZXIiOiIxZTM4Yjc3MS1lYTg3LTQzNDMtYTVhOC02MDAyMjM3NGNiYWEifSwiY2xpZW50X2lkIjoiNDI3Yzk5ZTUtZTZhMC00OWIxLTgyMDEtNGYxOGRjNzVlZjFkIiwiY29kZV9jaGFsbGVuZ2VfbWV0aG9kIjoiUzI1NiIsImNvZGVfY2hhbGxlbmdlIjoiWGtVRHZUcFRKWWlHVFlVamotLW5CRVdUa3hCNG1ELWlhMUpnYlFXbnA2QSIsInNjb3BlIjoibGF1bmNoIGxhdW5jaC9wYXRpZW50IHBhdGllbnQvT2JzZXJ2YXRpb24ucmVhZCBwYXRpZW50L1BhdGllbnQucmVhZCIsInJlZGlyZWN0X3VyaSI6Imh0dHA6Ly9sb2NhbGhvc3Q6ODA4MC9zbWFydC9yZWRpcmVjdCIsImlhdCI6MTY0MTgyODUzMCwiZXhwIjoxNjQxODI4ODMwfQ.cMKbnSA5wXwZ6KWESyOUaCqN8e_cxzIVaaynmPotXRw&amp;grant_type=authorization_code&amp;redirect_uri=http%3A%2F%2Flocalhost%3A8080%2Fsmart%2Fredirect&amp;client_assertion_type=urn%3Aietf%3Aparams%3Aoauth%3Aclient-assertion-type%3Ajwt-bearer&amp;client_assertion=eyJqa3UiOiJodHRwOlwvXC9sb2NhbGhvc3Q6ODA4MFwvandrcy5qc29uIiwia2lkIjoiZmIzOGNlOWYtMjUwYS00YTA1LThhZTItNDExMzkxZjkzZDViIiwidHlwIjoiSldUIiwiYWxnIjoiUlMzODQifQ.eyJpc3MiOiI0MjdjOTllNS1lNmEwLTQ5YjEtODIwMS00ZjE4ZGM3NWVmMWQiLCJzdWIiOiI0MjdjOTllNS1lNmEwLTQ5YjEtODIwMS00ZjE4ZGM3NWVmMWQiLCJhdWQiOiJodHRwczpcL1wvc21hcnQuYXJnby5ydW5cL3ZcL3I0XC9hdXRoXC90b2tlbiIsImV4cCI6MTY0MTgyODU5MCwianRpIjoiYzNjMmMyZTItZDg3My00ZmY3LTk2NTAtNTEwOWFiYjUxNjFiIn0.WaftPGsHkxeAvvchzjSfAdN2bnUFBnSVrSjVL8-jgNXwTone7tN-LRVWdl7n2S6vJQcJ53PhKTHckQK-rk9M2c1lwIWEYnXV-pMSNlzPXN3zWJSxIFFTwqKHGszu94DHSjdpMnrM5wEhw1ozcA9ryGfPO_LpHie0XK0H8TjP_o_9V6MxLBLYmyDsm6zvSq-NBEhJXQa777_tjxyHF7Y2qpN9lQtimhXh-uVOKyhMT2FUolR22b5WbV9dJpt0j-vNdglhEosECTM4LWHP51wcuSyp65fFxyueMdKD1FXxHNpREk7oloh_fvZxWEZkDDSDfmmoVX7uNqV2hgN2hduJag&amp;code_verifier=m1yQcBkzG4n3w6OWLV1bzvOz95EJxmQlfH7V-sgNCFA\n</code></pre></div>\n<p>And the JWKS</p>\n<div class=\"codehilite\"><pre><span></span><code>{&quot;keys&quot;:[{&quot;kty&quot;:&quot;RSA&quot;,&quot;e&quot;:&quot;AQAB&quot;,&quot;use&quot;:&quot;sig&quot;,&quot;kid&quot;:&quot;fb38ce9f-250a-4a05-8ae2-411391f93d5b&quot;,&quot;alg&quot;:&quot;RS384&quot;,&quot;n&quot;:&quot;zJGS53X6_0isdZWTczw-Dhhp_hM5P5IM15yntU-jq38Dp1XswQdT_lQCVcXFeIJIZesCGoZgYETEarWC_TfbT-J6COPhVCMBohOi-q-vKWUx0q2jkHcsvDTzwVOqqD3_E1J0qtdcainFygnN8Lj77a8DUBpWYsCn7UWfWazXdC1BbPXMf2DPrZc_PYhq-pwh4P5-wyuXMpEf2R1PERXsUZfGWx0ATL6UNOKbLuwwFDAXVNvb8GkKXng626ql9LCAYDxWU13BQqvkDG0i5QcMOOTE773pBlmKSsKa6yNyQYhhuMEaSxPDOfQ2Vscsjim6pHXp4ecwDuiziFEsp0SHhw&quot;}]}\n</code></pre></div>",
        "id": 267454009,
        "sender_full_name": "Ricardo Quintano",
        "timestamp": 1641829024
    },
    {
        "content": "<p>Thank you very much <span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> - Now we can get observations from the FHIR server! :)</p>",
        "id": 267458479,
        "sender_full_name": "Ricardo Quintano",
        "timestamp": 1641830624
    },
    {
        "content": "<p>Thanks for the details here -- sounds like a problem in our JWKS URL resolution + in our error reporting (but glad you are un-stuck for now).</p>",
        "id": 267459359,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1641830933
    },
    {
        "content": "<p>I'll debug</p>",
        "id": 267459370,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1641830937
    },
    {
        "content": "<p>Can you let me know where your JWKS is hosted? I'm guessing it may be a CORS issue, since it's fetched from the Launcher's browser UI at setup time.</p>",
        "id": 267460875,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1641831540
    },
    {
        "content": "<p>Also: I've added more client-facing error logs to the launcher, so the reports will include a stack trace into our reference implementation. Should help with debugging issues as they come up during the connectathon.</p>",
        "id": 267467165,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1641833902
    },
    {
        "content": "<p>The JWKS is hosted as a method in our app.<br>\n<a href=\"http://localhost:8080/jwks.json\">http://localhost:8080/jwks.json</a> ---&gt; generates/returns the JWKS<br>\n<a href=\"http://localhost:8080/smart/launch\">http://localhost:8080/smart/launch</a> ---&gt; launches the app.</p>",
        "id": 267478528,
        "sender_full_name": "Ricardo Quintano",
        "timestamp": 1641838703
    },
    {
        "content": "<p>Ah, so if you're only hosting locally you'll need to paste in a JWKS because... your localhost web server won't be visible to the SMART Launcher backend</p>",
        "id": 267504345,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1641850799
    }
]