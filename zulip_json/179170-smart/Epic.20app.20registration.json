[
    {
        "content": "<p>When registering a patient-facing app at <a href=\"http://fhir.epic.com\">fhir.epic.com</a> it can be tricky to choose all (and only) the USCDI scopes, which is necessary to have your app registration broadcast to all participating providers.</p>\n<p>I'm hoping Epic might add a feature to make this easier, because the cost of choosing incorrectly is high (if you discover you included too many scopes or too few after finalizing a registration, you need to re-start a new app registration from scratch and effectively throw out your old client). But in the meantime, here's a tip to help you select the right scopes:</p>\n<ol>\n<li>open the \"Edit\" page for your app, starting with no scopes selected</li>\n<li>open Chrome dev tools and run the following snippet, and</li>\n<li>click \"Save\" at the bottom of the form</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"JavaScript\"><pre><span></span><code><span class=\"nb\">Array</span><span class=\"p\">.</span><span class=\"kr\">from</span><span class=\"p\">(</span><span class=\"nb\">document</span><span class=\"p\">.</span><span class=\"nx\">querySelectorAll</span><span class=\"p\">(</span><span class=\"s2\">\"#WebServicesChosen option\"</span><span class=\"p\">))</span>\n  <span class=\"p\">.</span><span class=\"nx\">filter</span><span class=\"p\">(</span><span class=\"nx\">e</span> <span class=\"p\">=&gt;</span> <span class=\"nx\">e</span><span class=\"p\">.</span><span class=\"nx\">getAttribute</span><span class=\"p\">(</span><span class=\"s2\">\"data-uscdi-readonly\"</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"s1\">'True'</span><span class=\"p\">)</span>\n  <span class=\"p\">.</span><span class=\"nx\">forEach</span><span class=\"p\">(</span><span class=\"nx\">e</span> <span class=\"p\">=&gt;</span> <span class=\"nx\">e</span><span class=\"p\">.</span><span class=\"nx\">setAttribute</span><span class=\"p\">(</span><span class=\"s2\">\"selected\"</span><span class=\"p\">,</span> <span class=\"kc\">true</span><span class=\"p\">))</span>\n</code></pre></div>",
        "id": 267506357,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1641851666
    },
    {
        "content": "<p>Yeah, I've found this annoying too (we have to create new clients any time we do a dry run for ONC certification).  I really should have submitted an enhancement request for this a long time ago.  Anyway, I just submitted one now, so we at least have the request on our backlog.  No promises on if/when we'll be able to get it done (lots of other competing priorities...).</p>",
        "id": 267922444,
        "sender_full_name": "Cooper Thompson",
        "timestamp": 1642104096
    },
    {
        "content": "<p>And if you don't want <em>all</em> USCDI APIs, but just a subset, I crafted this snippet inspired by Josh's example that adds a USCDI tag to the web view so you can use the search box to narrow down to the USCDI APIs and pick the ones you want from there.  No guarantees this will work forever.  Disclaimer aside:</p>\n<div class=\"codehilite\" data-code-language=\"JavaScript\"><pre><span></span><code><span class=\"nb\">Array</span><span class=\"p\">.</span><span class=\"kr\">from</span><span class=\"p\">(</span><span class=\"nb\">document</span><span class=\"p\">.</span><span class=\"nx\">querySelectorAll</span><span class=\"p\">(</span><span class=\"s2\">\"#WebServicesChosen option\"</span><span class=\"p\">))</span>\n    <span class=\"p\">.</span><span class=\"nx\">filter</span><span class=\"p\">(</span><span class=\"nx\">e</span> <span class=\"p\">=&gt;</span> <span class=\"nx\">e</span><span class=\"p\">.</span><span class=\"nx\">getAttribute</span><span class=\"p\">(</span><span class=\"s2\">\"data-uscdi-readonly\"</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"s1\">'True'</span><span class=\"p\">)</span>\n    <span class=\"p\">.</span><span class=\"nx\">forEach</span><span class=\"p\">(</span><span class=\"nx\">e</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n    <span class=\"kd\">var</span> <span class=\"nx\">apiId</span><span class=\"o\">=</span><span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"nx\">e</span><span class=\"p\">).</span><span class=\"nx\">attr</span><span class=\"p\">(</span><span class=\"s1\">'value'</span><span class=\"p\">);</span>\n    <span class=\"kd\">var</span> <span class=\"nx\">apiEntry</span> <span class=\"o\">=</span> <span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"s1\">'#availableWebServices a[id='</span> <span class=\"o\">+</span> <span class=\"nx\">apiId</span> <span class=\"o\">+</span> <span class=\"s1\">']'</span><span class=\"p\">);</span>\n    <span class=\"nx\">apiEntry</span><span class=\"p\">.</span><span class=\"nx\">append</span><span class=\"p\">(</span><span class=\"s1\">' (USCDI)'</span><span class=\"p\">);</span>\n    <span class=\"nx\">apiEntry</span><span class=\"p\">.</span><span class=\"nx\">attr</span><span class=\"p\">(</span><span class=\"s1\">'filter-term'</span><span class=\"p\">,</span><span class=\"nx\">apiEntry</span><span class=\"p\">.</span><span class=\"nx\">attr</span><span class=\"p\">(</span><span class=\"s1\">'filter-term'</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"s2\">\";USCDI\"</span><span class=\"p\">);</span>\n    <span class=\"p\">});</span>\n</code></pre></div>",
        "id": 267926760,
        "sender_full_name": "Cooper Thompson",
        "timestamp": 1642106258
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 271340482,
        "sender_full_name": "erwin foxtree",
        "timestamp": 1644437504
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191315\">Josh Mandel</span> <a href=\"#narrow/stream/179170-smart/topic/Epic.20app.20registration/near/267506357\">said</a>:</p>\n<blockquote>\n<p>When registering a patient-facing app at <a href=\"http://fhir.epic.com\">fhir.epic.com</a> it can be tricky to choose all (and only) the USCDI scopes, which is necessary to have your app registration broadcast to all participating providers.</p>\n<p>I'm hoping Epic might add a feature to make this easier, because the cost of choosing incorrectly is high (if you discover you included too many scopes or too few after finalizing a registration, you need to re-start a new app registration from scratch and effectively throw out your old client). But in the meantime, here's a tip to help you select the right scopes:</p>\n<ol>\n<li>open the \"Edit\" page for your app, starting with no scopes selected</li>\n<li>open Chrome dev tools and run the following snippet, and</li>\n<li>click \"Save\" at the bottom of the form</li>\n</ol>\n<p><div class=\"codehilite\" data-code-language=\"JavaScript\"><pre><span></span><code><span class=\"nb\">Array</span><span class=\"p\">.</span><span class=\"kr\">from</span><span class=\"p\">(</span><span class=\"nb\">document</span><span class=\"p\">.</span><span class=\"nx\">querySelectorAll</span><span class=\"p\">(</span><span class=\"s2\">\"#WebServicesChosen option\"</span><span class=\"p\">))</span>\n  <span class=\"p\">.</span><span class=\"nx\">filter</span><span class=\"p\">(</span><span class=\"nx\">e</span> <span class=\"p\">=&gt;</span> <span class=\"nx\">e</span><span class=\"p\">.</span><span class=\"nx\">getAttribute</span><span class=\"p\">(</span><span class=\"s2\">\"data-uscdi-readonly\"</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"s1\">'True'</span><span class=\"p\">)</span>\n  <span class=\"p\">.</span><span class=\"nx\">forEach</span><span class=\"p\">(</span><span class=\"nx\">e</span> <span class=\"p\">=&gt;</span> <span class=\"nx\">e</span><span class=\"p\">.</span><span class=\"nx\">setAttribute</span><span class=\"p\">(</span><span class=\"s2\">\"selected\"</span><span class=\"p\">,</span> <span class=\"kc\">true</span><span class=\"p\">))</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> -- would over-specifying scope cause OAuth to fail w/ production client ids?</p>",
        "id": 271340679,
        "sender_full_name": "erwin foxtree",
        "timestamp": 1644437601
    },
    {
        "content": "<p>This comment was about how to register a client to be associated with certain scopes. If you are asking about what happens at runtime if you request the scopes that you are not registered for... This is probably a question for the epic team. Historically Epic ignored the list of scopes requested at runtime. I'm not sure if that's true today.</p>",
        "id": 271342185,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1644438358
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 271342637,
        "sender_full_name": "erwin foxtree",
        "timestamp": 1644438559
    },
    {
        "content": "<p>Oh, I'm wondering what happens if you over-specify non-uscdi scopes in a particular \"<a href=\"https://fhir.epic.com/Developer/&lt;whatever\">https://fhir.epic.com/Developer/&lt;whatever</a>&gt;\" app configuration page -- could that cause authentication to fail ?</p>\n<p>(to a real EHR, eg: <a href=\"https://fhir.mah.org/prd-fhir/api/FHIR/R4/\">https://fhir.mah.org/prd-fhir/api/FHIR/R4/</a>) with what appears to be a valid production client id.</p>",
        "id": 271343248,
        "sender_full_name": "erwin foxtree",
        "timestamp": 1644438822
    },
    {
        "content": "<p>I guess it's a question for Epic, but I don't see why that would cause anything to fail if you are in fact registered for that scope and your client registration has been completed</p>",
        "id": 271343348,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1644438857
    },
    {
        "content": "<p>In my experience, the failure mode with registering for too many scopes is that you cannot have your app's registration automatically propagated to Epic clients</p>",
        "id": 271343394,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1644438886
    },
    {
        "content": "<p>Well, I've been trying to figure it out with them (on the open.epic free tier), and it's possible that \"Automatic Client ID Distribution\" is involved?  (is this applicable to S4S?) </p>\n<p>described here:<br>\n<a href=\"https://fhir.epic.com/Documentation?docId=patientfacingfhirapps\">https://fhir.epic.com/Documentation?docId=patientfacingfhirapps</a></p>",
        "id": 271343871,
        "sender_full_name": "erwin foxtree",
        "timestamp": 1644439106
    },
    {
        "content": "<p>Were you able to get production client ids working w/ real Epic portals (eg: for a test or demo, possibly looking at your own data?)</p>",
        "id": 271344378,
        "sender_full_name": "erwin foxtree",
        "timestamp": 1644439359
    },
    {
        "content": "<p>(If we need to enable and configure auto-syncing, then what would the production client ID be for?)</p>\n<p>I've registered another app, using the mechanism you described to add only uscdi scopes (and further limiting those to R4) -- wonder if that will make the production client id work.</p>",
        "id": 271344711,
        "sender_full_name": "erwin foxtree",
        "timestamp": 1644439511
    },
    {
        "content": "<p>Oh, BTW: the _non_-production client id for same app/s work with the free-tier Epic sandbox.</p>\n<p>eg: <a href=\"https://fhir.epic.com/interconnect-fhir-oauth/api/FHIR/R4/\">https://fhir.epic.com/interconnect-fhir-oauth/api/FHIR/R4/</a></p>",
        "id": 271344775,
        "sender_full_name": "erwin foxtree",
        "timestamp": 1644439548
    },
    {
        "content": "<blockquote>\n<p>Were you able to get production client ids working w/ real Epic portals </p>\n</blockquote>\n<p>Yes, that definitely works</p>",
        "id": 271348082,
        "sender_full_name": "Michele Mottini",
        "timestamp": 1644441122
    },
    {
        "content": "<p>Yes, for me too.</p>",
        "id": 271352661,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1644443541
    },
    {
        "content": "<p>Oh, my, filtering and only adding uscdi scopes actually makes a difference, here:</p>",
        "id": 271356473,
        "sender_full_name": "erwin foxtree",
        "timestamp": 1644445363
    },
    {
        "content": "<p><a href=\"/user_uploads/10155/WLQIzDeHG7d1JCm8f5sY4HAv/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/WLQIzDeHG7d1JCm8f5sY4HAv/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/WLQIzDeHG7d1JCm8f5sY4HAv/image.png\"></a></div>",
        "id": 271356482,
        "sender_full_name": "erwin foxtree",
        "timestamp": 1644445367
    },
    {
        "content": "<p>Yeah, there's an indication at the bottom of your app details page showing you whether it is or isn't eligible for automated registration with all the sites. Pick too many scopes and the indication flips to no.</p>",
        "id": 271356686,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1644445467
    },
    {
        "content": "<p>Yeah -- Only the ^last app configuration filters out non-uscid -- and it has &gt;0 -- Client ID Downloads: 422 --  Previously, I had been adding all R4 \"Read\" scopes.</p>",
        "id": 271356710,
        "sender_full_name": "erwin foxtree",
        "timestamp": 1644445483
    },
    {
        "content": "<p>this has been very helpful -- thanks a lot!</p>",
        "id": 271356734,
        "sender_full_name": "erwin foxtree",
        "timestamp": 1644445497
    },
    {
        "content": "<p>Oh, I see what you're talking about, here:</p>",
        "id": 271356798,
        "sender_full_name": "erwin foxtree",
        "timestamp": 1644445533
    },
    {
        "content": "<p>Yeah, if you scroll all the way up to the top of this thread, that was why I documented this technique</p>",
        "id": 271356808,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1644445536
    },
    {
        "content": "<p><a href=\"/user_uploads/10155/H0P5RXQ3Yr0mDbQsMf5IBpS5/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/H0P5RXQ3Yr0mDbQsMf5IBpS5/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/H0P5RXQ3Yr0mDbQsMf5IBpS5/image.png\"></a></div>",
        "id": 271356812,
        "sender_full_name": "erwin foxtree",
        "timestamp": 1644445537
    },
    {
        "content": "<p>\"will\" is green -- for every other app, it's:</p>",
        "id": 271356834,
        "sender_full_name": "erwin foxtree",
        "timestamp": 1644445551
    },
    {
        "content": "<p><a href=\"/user_uploads/10155/Z-DWuG_hn1JqqzLLgNH9JTmU/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/Z-DWuG_hn1JqqzLLgNH9JTmU/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/Z-DWuG_hn1JqqzLLgNH9JTmU/image.png\"></a></div>",
        "id": 271356906,
        "sender_full_name": "erwin foxtree",
        "timestamp": 1644445568
    },
    {
        "content": "<p>But, you're totally right: The selection of USCID scopes should be automated and validated in that App configuration UI, somehow...</p>",
        "id": 271357270,
        "sender_full_name": "erwin foxtree",
        "timestamp": 1644445760
    },
    {
        "content": "<p>or maybe: the _non_-production client id should fail to work, if there were some sort of \"USCID\" checkbox...</p>",
        "id": 271357540,
        "sender_full_name": "erwin foxtree",
        "timestamp": 1644445890
    },
    {
        "content": "<p>I've commented in a few other spots, but we (Epic) upgraded our sandbox to a new version recently, and had a few hiccups.  Those should be resolved now.</p>",
        "id": 271362998,
        "sender_full_name": "Cooper Thompson",
        "timestamp": 1644449079
    }
]