[
    {
        "content": "<p>BTW <span class=\"user-mention\" data-user-id=\"191676\">@Lee Surprenant</span>, following discussion <a href=\"#narrow/stream/179309-inferno/topic/Is.20client.20id.20optional.20on.20a.20refresh.20request.3F/near/213974919\">over here</a>: I'd love to get an overview of how you're using KeyCloak to implement a SMART authz server -- I think there's probably broad community interest in this point. Any chance you'd be up for a chat? (And if you're amenable, we could record / share for folks who want to catch up later.)</p>",
        "id": 214251419,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1603402687
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191343\">@Michael Lawley</span> and <span class=\"user-mention\" data-user-id=\"191337\">@Dion McMurtrie</span> and I would probably be interested in this. We're using Keycloak for some SMART stuff too.</p>",
        "id": 214259473,
        "sender_full_name": "Jim Steel",
        "timestamp": 1603409184
    },
    {
        "content": "<p>I am too interested on this. We have OAuth Server (built using spring security) on cloud and EHR as on-prem solution.  and we are planning to migrate over to KeyCloak for building OIDC and extending for SMART on FHIR from existing OAuth Server</p>",
        "id": 214305439,
        "sender_full_name": "Sagar Shah",
        "timestamp": 1603455285
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span>, I'm happy to join a call and share where we're at with Keycloak on this effort.  I'm especially interested to hear from others using Keycloak (or RedHat SSO) for SMART-on-FHIR support.</p>",
        "id": 214317543,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1603462014
    },
    {
        "content": "<p>Does anyone know any of the folks involved with \"igia\" (<a href=\"https://igia.github.io/docs/igia-keycloak~introduction\">https://igia.github.io/docs/igia-keycloak~introduction</a>)?</p>",
        "id": 214317584,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1603462037
    },
    {
        "content": "<p>I noticed some in the DaVinci community are using Keycloak as well.  <span class=\"user-mention\" data-user-id=\"191506\">@Yunwei Wang</span> <span class=\"user-mention\" data-user-id=\"191434\">@Andy Gregorowicz</span> I noticed you both have edited the keycloak section of the DaVinci CRD README...is this a subject you'd be interested in discussing?</p>",
        "id": 214319027,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1603462736
    },
    {
        "content": "<p>Super, <span class=\"user-mention\" data-user-id=\"191676\">@Lee Surprenant</span>! Let's see who else chimes in here as interested, and then try to schedule a time for a conversation late next week, if that works?</p>",
        "id": 214322172,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1603464152
    },
    {
        "content": "<p>works for me</p>",
        "id": 214322305,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1603464229
    },
    {
        "content": "<p>Just curious, if there was any conversation around this week on this topic?</p>",
        "id": 215084968,
        "sender_full_name": "Sagar Shah",
        "timestamp": 1604059333
    },
    {
        "content": "<p>We didn't schedule one -- but let's do so for next week. <span class=\"user-mention\" data-user-id=\"191676\">@Lee Surprenant</span> are there times next Friday 11/6 that would work for you?</p>",
        "id": 215117313,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1604074808
    },
    {
        "content": "<p>I'm free most of the day.  Pretty much anything outside of 10-11 ET</p>",
        "id": 215123659,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1604077827
    },
    {
        "content": "<p>Great -- I just sent an invite for 2:30p ET. Anyone else who wants to (to lee, Sagar, Jim, Michael, Dion -- recognizing that the time will be really poor for some; we'll record it!)</p>",
        "id": 215130087,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1604080936
    },
    {
        "content": "<p>(Others please let me know if you want to be added to the invite)</p>",
        "id": 215130218,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1604081015
    },
    {
        "content": "<p>Hi Josh, please send the invite to me also. (<a href=\"mailto:dr.davuluri@gmail.com\">dr.davuluri@gmail.com</a>)</p>",
        "id": 215130369,
        "sender_full_name": "Venkateswara R Davuluri",
        "timestamp": 1604081072
    },
    {
        "content": "<p>(Note that we moved this later in the day, to 4p ET, to accommodate Australia <em>slightly</em> less terribly. Everyone on the invite should have seen an update.)</p>",
        "id": 215475407,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1604420142
    },
    {
        "content": "<p>I may be tentative around that time. But I am hoping this will be recorded and I can go though it later.</p>",
        "id": 215479616,
        "sender_full_name": "Sagar Shah",
        "timestamp": 1604422003
    },
    {
        "content": "<p>Thanks -- we'll plan to record it (and for folks on the call: please remind me of this plan so I actually hit the button!)</p>",
        "id": 215482212,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1604423082
    },
    {
        "content": "<p>Can you please add me to the invite too? Thanks</p>",
        "id": 215508520,
        "sender_full_name": "Brian Postlethwaite",
        "timestamp": 1604436708
    },
    {
        "content": "<p>Done!</p>",
        "id": 215508834,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1604436906
    },
    {
        "content": "<p>I'd also be interested in this discussion if it's possible to include me (<a href=\"mailto:ian_bacher@brown.edu\">ian_bacher@brown.edu</a>). Thanks!</p>",
        "id": 215577439,
        "sender_full_name": "Ian Bacher",
        "timestamp": 1604495394
    },
    {
        "content": "<p>Done!</p>",
        "id": 215651643,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1604530536
    },
    {
        "content": "<p>FYI I just posted a quick advert on the Keycloak Zulip instance (yes, they use Zulip too!)</p>",
        "id": 215843255,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1604668283
    },
    {
        "content": "<p><a href=\"https://keycloak.zulipchat.com/#narrow/stream/211273-user/topic/SMART.20App.20Launch\">https://keycloak.zulipchat.com/#narrow/stream/211273-user/topic/SMART.20App.20Launch</a></p>",
        "id": 215843260,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1604668286
    },
    {
        "content": "<p>Meeting in 8min: <a href=\"https://teams.microsoft.com/dl/launcher/launcher.html?url=%2F_%23%2Fl%2Fmeetup-join%2F19%3Ameeting_Nzg4MWVmYTctMGQ1Mi00NjAwLTkzMWItNjVjOGU3N2IwMGUy%40thread.v2%2F0%3Fcontext%3D%257b%2522Tid%2522%253a%252272f988bf-86f1-41af-91ab-2d7cd011db47%2522%252c%2522Oid%2522%253a%252299f26c89-9bc7-4381-abb4-95b0804b27f3%2522%257d%26anon%3Dtrue&amp;type=meetup-join&amp;deeplinkId=2f71bf3c-2bb2-422d-948c-fccf9f7e6c2e&amp;directDl=true&amp;msLaunch=true&amp;enableMobilePage=true&amp;suppressPrompt=true\">Teams link</a></p>",
        "id": 215902402,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1604695966
    },
    {
        "content": "<p>Thanks for the meeting <span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> and particular thanks to <span class=\"user-mention\" data-user-id=\"191676\">@Lee Surprenant</span> for sharing.</p>\n<p>As well as our efforts I'm aware of this <a href=\"https://github.com/itcr-uni-luebeck/ontoserver-keycloak\">https://github.com/itcr-uni-luebeck/ontoserver-keycloak</a> so I think it would be great to provide a space for those who've done Keycloak + FHIR to share knowledge/approaches so we don't have to keep independently learning the same stuff. Mostly it is a journey of figuring out how to configure Keycloak to do what you want it to do, which is a bit of a learning curve.</p>",
        "id": 215911532,
        "sender_full_name": "Dion McMurtrie",
        "timestamp": 1604701561
    },
    {
        "content": "<p>Thanks all for joining the discussion today! I've just uploaded the recording to <a href=\"https://youtu.be/Pp32GOOq0Vw\">https://youtu.be/Pp32GOOq0Vw</a> (YouTube may take a few minutes to finish processing.)</p>\n<div class=\"youtube-video message_inline_image\"><a data-id=\"Pp32GOOq0Vw\" href=\"https://youtu.be/Pp32GOOq0Vw\"><img src=\"https://i.ytimg.com/vi/Pp32GOOq0Vw/default.jpg\"></a></div><p>Thanks especially to <span class=\"user-mention\" data-user-id=\"191676\">@Lee Surprenant</span> for sharing the work you've done.</p>",
        "id": 215912381,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1604702078
    },
    {
        "content": "<p>Thank you for setting this up and providing very useful information. I also wanted bring up similar point, but could not bring it due to time constraint that Okta is working on similar initiative too by using AWS lambda as a SMART proxy that adds SMART on FHIR capabilities on top of its OIDC solution. That SMART proxy runs outside of the Auth Server solution of Okta, which is very similar to what <span class=\"user-mention\" data-user-id=\"191676\">@Lee Surprenant</span>  showed in his diagram. Thanks <span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> for setting this up and sharing the recording</p>",
        "id": 215913352,
        "sender_full_name": "Sagar Shah",
        "timestamp": 1604702674
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"344150\">@Sagar Shah</span>  -- are their docs or any background reading on this approach with Okta?</p>",
        "id": 215915202,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1604703865
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span>  I believe, there are some contractual obligations because of which I may not be able to share it at this point. But I can point to these 2 open source git hub repositories, that may provider some pointers <a href=\"https://github.com/dancinnamon-okta/okta-smartfhir-demo\">https://github.com/dancinnamon-okta/okta-smartfhir-demo</a> and <a href=\"https://github.com/dancinnamon-okta/SoF-Demo\">https://github.com/dancinnamon-okta/SoF-Demo</a>. Hope this is useful!</p>",
        "id": 215915593,
        "sender_full_name": "Sagar Shah",
        "timestamp": 1604704132
    },
    {
        "content": "<p>Thanks for the recording, I couldn't make the meeting time but that was very interesting.</p>",
        "id": 215931118,
        "sender_full_name": "Paul Church",
        "timestamp": 1604722632
    },
    {
        "content": "<p>FYI - I have a setup where we bridge SAML to OAuth in Keycloak ending up with a 'SMART'-like behaviour (<a href=\"https://ehealth-dk.atlassian.net/wiki/spaces/EDTW/pages/7045392/Security\">https://ehealth-dk.atlassian.net/wiki/spaces/EDTW/pages/7045392/Security</a>) where the JWT more or less follows SMART - should it have any interest.</p>",
        "id": 215953428,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1604753243
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"344150\">@Sagar Shah</span> <span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> <span class=\"user-mention\" data-user-id=\"191676\">@Lee Surprenant</span> ,<br>\nShoot! I'm totally late to the party :). Saw the video from last week, and yes it does certainly look familiar to some of the research I've been doing- in my particular case using Okta as the authorization server- Lee sounds like you and I ran into a number of the very same issues and overcame some of the same hurdles. I'll also be checking what i'm doing with the \"aud\" input parameter, as I think I'm currently working in the same way you are.</p>",
        "id": 216428719,
        "sender_full_name": "Dan Cinnamon",
        "timestamp": 1605157918
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> one thing we ran out of time to discuss in that call is the issue I hit where keycloak is expecting the client_id in the refresh token for public clients (whereas SMART says its not needed).<br>\nGiven that Keycloak is a certified OIDC provider, and that it shouldn't be burdensome for clients to include the client_id in the exchange (since they already use it elsewhere), would you be opposed to adding it into the corresponding exchange for SMART App Launch?  Should I open a JIRA ticket for it?</p>",
        "id": 216920419,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1605555374
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191676\">Lee Surprenant</span> <a href=\"#narrow/stream/179170-smart/topic/Keycloak.20for.20SMART.20authz/near/216920419\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"191315\">Josh Mandel</span> one thing we ran out of time to discuss in that call is the issue I hit where keycloak is expecting the client_id in the refresh token for public clients (whereas SMART says its not needed).</p>\n</blockquote>\n<p>Not sure if that's issue after all. Refresh token is something given to client and expected to be returned by it. I am not quite sure if client should bother at all about what refresh token is, just bring it back to obtain new tokens.</p>",
        "id": 217825433,
        "sender_full_name": "≈Åukasz Dywicki",
        "timestamp": 1606258995
    },
    {
        "content": "<p>My apologies for the sloppy language.  What I meant above is this:</p>\n<blockquote>\n<p>keycloak is expecting the client_id in the <em>request</em> to refresh the access token for public clients (whereas SMART says its not needed)</p>\n</blockquote>",
        "id": 218280522,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1606739543
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191315\">Josh Mandel</span> <a href=\"#narrow/stream/179170-smart/topic/Keycloak.20for.20SMART.20authz/near/215912381\">said</a>:</p>\n<blockquote>\n<p>Thanks all for joining the discussion today! I've just uploaded the recording to <a href=\"https://youtu.be/Pp32GOOq0Vw\">https://youtu.be/Pp32GOOq0Vw</a> (YouTube may take a few minutes to finish processing.)</p>\n<p>Thanks especially to <span class=\"user-mention silent\" data-user-id=\"191676\">Lee Surprenant</span> for sharing the work you've done.</p>\n</blockquote>\n<p>Thanks a lot for recording and sharing this. Is there a plugin/extension required to  support wildcard scopes in Keycloak? <br>\nHow does Keycloak know patient/*.read means patient/Observation.read AND patient/Immunization.read (etc...)</p>",
        "id": 218323018,
        "sender_full_name": "Yogesh Dhimate",
        "timestamp": 1606759666
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"329487\">@Yogesh Dhimate</span> what we spent most of the time discussing is how to get the right context and scopes associated with the access token.  What we <em>did not</em> cover is how to actually enforce access controls based on the combination of the user context and the approved scopes.  It sounds like you are asking about the latter.</p>",
        "id": 218330103,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1606762909
    },
    {
        "content": "<blockquote>\n<p>How does Keycloak know patient/*.read means patient/Observation.read AND patient/Immunization.read</p>\n</blockquote>\n<p>The authorization server does not really need to know that, doesn't it? Is the resource server that has to check that - 'I am getting a request for Patient, let me check if that's admissible based on the access token scopes: look for patient/Patient.read or patient/*.read etc.'</p>",
        "id": 218330765,
        "sender_full_name": "Michele Mottini",
        "timestamp": 1606763208
    },
    {
        "content": "<p>Thanks for your reply <span class=\"user-mention\" data-user-id=\"191676\">@Lee Surprenant</span>  Yes I was talking about the latter part of enforcing the access controls. </p>\n<p>Hi <span class=\"user-mention\" data-user-id=\"191912\">@Michele Mottini</span>  - thanks for your input. That was my point, that if the resource server is  getting a request for patient/Immunization.read, but the scope being presented is patient/*.read, should it be the responsibility of the resource server to interpret the wildcard and allow/deny the request.</p>\n<p>In my architecture we have an API gateway layer on top of the resource server. The API gateway layer protects the APIs by applying security policies like OpenID token enforcement etc. </p>\n<p>Outside of SMART on FHIR, we haven't encountered the wildcard scopes, so the policy enforcement for scopes is verbatim.  The list of scopes can be configured for each API or a resource  endpoint when applying a policy.</p>\n<p>e.g. API security policy for /Immunization resource can be configured with scopes like <code>openid fhirUser patient/Immunization.read </code><br>\nWith this configuration when a SMART app tries to access the resource, it must present a token which proves that it has been granted access to these scopes. </p>\n<p>Since this validation/comparison of scopes at API policy level doesn't take into account wildcards, an app with these scopes <code>openid fhirUser patient/*.read</code> can't get past the security policy layer as the patient/*.read doesn't translate to patient/Immunization.read. </p>\n<p>I was wondering whether authorization server should interpret the wildcard scopes and translate/return the appropriate scopes accordingly.</p>",
        "id": 218359620,
        "sender_full_name": "Yogesh Dhimate",
        "timestamp": 1606777834
    },
    {
        "content": "<p>Note that you can forbid wildcard scopes, and require apps to use always explicit ones (some existing server do that - eg Cerner)</p>",
        "id": 218359912,
        "sender_full_name": "Michele Mottini",
        "timestamp": 1606778076
    },
    {
        "content": "<p>Thanks for your response.  I didn't know that we can forbid specific scopes. If we were to forbid these scopes, how Is this information communicated to the client apps? Do we document in API documentation or it should be in the CapabilityStatement?</p>",
        "id": 218372824,
        "sender_full_name": "Yogesh Dhimate",
        "timestamp": 1606788521
    },
    {
        "content": "<p>Typically as part of the app registration there is a list of allowed scopes, or in some cases the app has to select which scopes it wants from a list of all the available ones.</p>",
        "id": 218379471,
        "sender_full_name": "Michele Mottini",
        "timestamp": 1606796504
    },
    {
        "content": "<p>Here is an example from Cerner app registration:<br>\n<a href=\"/user_uploads/10155/BRmG_p7PVZD_oL7Yd7z-2g7f/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/BRmG_p7PVZD_oL7Yd7z-2g7f/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/BRmG_p7PVZD_oL7Yd7z-2g7f/image.png\"></a></div>",
        "id": 218379555,
        "sender_full_name": "Michele Mottini",
        "timestamp": 1606796624
    },
    {
        "content": "<p>You can also advertise what scopes you support in the conformance doc for SMART</p>",
        "id": 218432699,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1606834841
    },
    {
        "content": "<p><a href=\"http://www.hl7.org/fhir/smart-app-launch/conformance/index.html\">http://www.hl7.org/fhir/smart-app-launch/conformance/index.html</a></p>",
        "id": 218432811,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1606834893
    },
    {
        "content": "<p>Perfect thank you.</p>",
        "id": 218847325,
        "sender_full_name": "Yogesh Dhimate",
        "timestamp": 1607095823
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191676\">@Lee Surprenant</span> <span class=\"user-mention\" data-user-id=\"222054\">@Gino Canessa</span> <span class=\"user-mention\" data-user-id=\"191367\">@Brian Postlethwaite</span> <span class=\"user-mention\" data-user-id=\"259065\">@Ian Bacher</span> <span class=\"user-mention\" data-user-id=\"191337\">@Dion McMurtrie</span> <br>\nThanks so much for the informative talk!<br>\nY'all mentioned working on a cookbook for SMART on FHIR in Keycloak (~59 min). Did anything ever come of that effort?</p>",
        "id": 219577476,
        "sender_full_name": "Ryan Harrison",
        "timestamp": 1607676424
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"344150\">@Sagar Shah</span> Would you consider presenting a similar talk on the Okta + API Gateway + Lambda's approach from <a href=\"https://github.com/dancinnamon-okta/okta-smartfhir-demo\">https://github.com/dancinnamon-okta/okta-smartfhir-demo</a> ?</p>",
        "id": 219577678,
        "sender_full_name": "Ryan Harrison",
        "timestamp": 1607676556
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"300914\">@Ryan Harrison</span>  - Wish, I could. I am not in a position to present a talk as we have not explored it except for understanding high level flow  and we are not planning to use it, as we are not going with Okta solution for OIDC. We just came across that as an option while exploring. I will try to put down the high level steps here soon here</p>",
        "id": 219599756,
        "sender_full_name": "Sagar Shah",
        "timestamp": 1607689843
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"344150\">@Sagar Shah</span> Thanks for the prompt response/clarification, and for bringing the Okta community configuration to the communities attention.</p>",
        "id": 219613831,
        "sender_full_name": "Ryan Harrison",
        "timestamp": 1607697906
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"300914\">@Ryan Harrison</span>  Nothing from me on that front yet.  Still want to get to it though.  The latest news is <span class=\"user-mention\" data-user-id=\"259065\">@Ian Bacher</span> 's pull request got merged which will change things a bit (no more need for a token-response-rewriter)</p>",
        "id": 219622892,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1607702301
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"259065\">@Ian Bacher</span> /@<strong>Lee Surprenant</strong>  - Is that available in 11.0.3 v of keycloak? or going to be part of next release?</p>",
        "id": 219623343,
        "sender_full_name": "Sagar Shah",
        "timestamp": 1607702492
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"344150\">@Sagar Shah</span> The <a href=\"https://issues.redhat.com/browse/KEYCLOAK-15287\">Jira ticket</a> indicates it will be included in the 12.0.0 release. Note that the changes are (to the best of my knowledge) not exposed through the Keycloak UI.</p>\n<p>I'm still on board with helping get together a cookbook for SMART on FHIR in Keycloak, but probably in the new year.</p>",
        "id": 219625326,
        "sender_full_name": "Ian Bacher",
        "timestamp": 1607703312
    },
    {
        "content": "<p>That will be a great help, <span class=\"user-mention\" data-user-id=\"259065\">@Ian Bacher</span> . Excited to see new release of keycloak of 12.0.0</p>",
        "id": 219625547,
        "sender_full_name": "Sagar Shah",
        "timestamp": 1607703404
    },
    {
        "content": "<p>Here are the steps in general <span class=\"user-mention\" data-user-id=\"300914\">@Ryan Harrison</span> . Hope this helps!<br>\n<strong>End-to-End Flow</strong></p>\n<hr>\n<ol>\n<li>User accesses a SMART-enabled app.</li>\n<li>App determines authz endpoints from metadata.</li>\n<li>App opens the /authorize proxy endpoint. <em>(Note this is the proxy endpoint and not real auth server endpoint)</em></li>\n<li>Authorize proxy caches original request and performs authz with patient picker app instead.</li>\n<li>User logs in with Auth Server.</li>\n<li>User is shown the patient picker app.</li>\n<li>Patient, and downscoped scopes are combined with original request details and sent to Auth Server in a new /authorize request.</li>\n<li>Auth server calls a token hook to validate that the request actually came from the patient picker, and to insert the selected patient into the token.</li>\n<li>Auth Server returns authorization code to the authorize proxy. The authorize proxy redirects the browser to the OAuth2 callback url of the app.</li>\n<li>App calls the /token proxy to obtain an access token.</li>\n<li>/token proxy obtains the token from Auth Server, uses a private key to perform client authentication</li>\n<li>/token proxy puts the proper launch response alongside the access token from Auth Server.</li>\n<li>App accesses the FHIR API</li>\n</ol>",
        "id": 219626283,
        "sender_full_name": "Sagar Shah",
        "timestamp": 1607703750
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"344150\">@Sagar Shah</span> Well that sequence list is the first step of the playbook. Then come the Keycloak (or Igia on Keycloak?) specific instructions for each step. Ideally backed by a repo with some automation (e.g. creating all the resource scopes and tedious configuration). Thank you!</p>",
        "id": 219668131,
        "sender_full_name": "Ryan Harrison",
        "timestamp": 1607724186
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"300914\">@Ryan Harrison</span> - I'm the author of the Okta reference implementation- I'd be happy to do a presentation on it if people are interested.  I've made some updates to it in the past few weeks:<br>\n1- I've provided some far more detailed documentation on it, contained here: <a href=\"https://github.com/dancinnamon-okta/okta-smartfhir-docs\">https://github.com/dancinnamon-okta/okta-smartfhir-docs</a><br>\n2- I just did a major refactor of the components earlier this week to separate out the Lambda specific pieces of it so if there's interest in releasing in another serverless technology (Azure functions, GCP functions, etc) that should be quick to do.  It leverages the serverless deployment framework so adjusting to other clouds should be seamless.</p>",
        "id": 219996527,
        "sender_full_name": "Dan Cinnamon",
        "timestamp": 1608046987
    },
    {
        "content": "<p>I'd be super interested in a presentation about this, Dan!</p>",
        "id": 219997203,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1608047234
    },
    {
        "content": "<p>Great- perhaps we can shoot for a date later in January after connectathon. Whatever works.</p>",
        "id": 220184255,
        "sender_full_name": "Dan Cinnamon",
        "timestamp": 1608158682
    },
    {
        "content": "<p>Good morning everyone- well it was a crazy January- not sure where the time went.  Is there still interest in covering the reference implementation I've done with SMART+Okta?  If so, I thought I'd propose some time during the week of 2/15 to have that session. Thoughts?</p>",
        "id": 225166755,
        "sender_full_name": "Dan Cinnamon",
        "timestamp": 1612449332
    },
    {
        "content": "<p>Hi  Dan, I am a new comer to this chat, and I am implementing a solution for India. I'm interested, if you have time</p>",
        "id": 225168153,
        "sender_full_name": "Venu Gopal",
        "timestamp": 1612449978
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"361257\">@Dan Cinnamon</span>  for checking. We have similar interests too in knowing what that SMART on FHIR proxy component works with AWS lambda works and Okta as an authz server (or any other auth server).</p>",
        "id": 225174711,
        "sender_full_name": "Sagar Shah",
        "timestamp": 1612452594
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"361257\">@Dan Cinnamon</span> Thanks for publishing your reference implementation! I would _enthusiastically_ attend a presentation the week of 2/15. Just say when (please @ me so I see it). <a href=\"https://meet.jit.si\">https://meet.jit.si</a> is my goto for small to mid-sized meetings. Please record if you're comfortable [^1].</p>\n<p>cc <span class=\"user-mention\" data-user-id=\"336563\">@Elijah</span><br>\n[^1] The session Josh Mandel et al. recorded was fantastic: <a href=\"#narrow/stream/179170-smart/topic/Keycloak.20for.20SMART.20authz/near/215912381\">https://chat.fhir.org/#narrow/stream/179170-smart/topic/Keycloak.20for.20SMART.20authz/near/215912381</a></p>",
        "id": 225390282,
        "sender_full_name": "Ryan Harrison",
        "timestamp": 1612593319
    },
    {
        "content": "<p>Yeah <span class=\"user-mention\" data-user-id=\"361257\">@Dan Cinnamon</span> I'd be eager to join. Do you want to set up a time (or I'm happy to help!)</p>",
        "id": 225433380,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1612650851
    },
    {
        "content": "<p>Awesome- thanks everyone! <span class=\"user-mention\" data-user-id=\"300914\">@Ryan Harrison</span>  <span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> <span class=\"user-mention\" data-user-id=\"344150\">@Sagar Shah</span> <span class=\"user-mention\" data-user-id=\"251824\">@Venu Gopal</span> - Right now Thursday the 18th looks wide open.  In efforts to select a time that's somewhat reasonable for our partners in India, I was thinking we could do 9am CST- does that time work? In terms of jitsi- I'd be glad to use that platform- however, would like to post a link here beforehand.  What's the best way to do that? I was thinking i'd just generate a GUID and use that as my meeting ID.</p>",
        "id": 225548385,
        "sender_full_name": "Dan Cinnamon",
        "timestamp": 1612793195
    },
    {
        "content": "<p>That works for me! Re: jitsi I'd note that the built-in recording capabilities are limited, so we might want to see if someone can record from their desktop as a backup.</p>",
        "id": 225552692,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1612795157
    },
    {
        "content": "<p>yes Yes! :) </p>\n<p>That time works for me (18 Feb @ 9 am CT).<br>\nYou can use any arbitrary room name you'd like.<br>\nAnd a recording backup is a great idea.</p>",
        "id": 225586540,
        "sender_full_name": "Ryan Harrison",
        "timestamp": 1612808726
    },
    {
        "content": "<p>Works for me too. Thanks for checking <span class=\"user-mention\" data-user-id=\"361257\">@Dan Cinnamon</span> !</p>",
        "id": 225598456,
        "sender_full_name": "Sagar Shah",
        "timestamp": 1612814094
    },
    {
        "content": "<p>Great!  9am central time on 2/18 it is then.  We'll use <a href=\"https://meet.jit.si/smart-reference-review-with-dan\">https://meet.jit.si/smart-reference-review-with-dan</a> for it.  I've also attached a .ics file for your calendar if you'd like. <a href=\"/user_uploads/10155/7HG53A-Y61zPVLBBmlp2JiKM/invite.ics\">invite.ics</a><br>\n<span class=\"user-mention\" data-user-id=\"300914\">@Ryan Harrison</span> <span class=\"user-mention\" data-user-id=\"344150\">@Sagar Shah</span> <span class=\"user-mention\" data-user-id=\"251824\">@Venu Gopal</span> <span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> ^^</p>",
        "id": 225698418,
        "sender_full_name": "Dan Cinnamon",
        "timestamp": 1612881424
    },
    {
        "content": "<p>Hi! Lurker here super interested in oauth, oidc, smart auth and fhir.  Implemented the fhir resource server and authorization server used in production by my company (an ehr vendor).   We've been looking at replacing our authorization infrastructure w/ something new (keycloak, gluu, okta, identityserver)</p>\n<p>I'd really love the opportunity to tune in for the presentation... would that be okay?</p>",
        "id": 225795842,
        "sender_full_name": "Rob Resendez",
        "timestamp": 1612934663
    },
    {
        "content": "<p>(I will answer for Dan because I happen to be reading this first.) Of course! that's why it's advertised here openly, to extend the invitation to everyone who is interested :-)</p>",
        "id": 225842048,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1612966812
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"308766\">@Angus McAllister</span> Just in case you didn't notice this thread.<br>\n<a href=\"#narrow/stream/179170-smart/topic/Keycloak.20for.20SMART.20authz/near/225698418\">https://chat.fhir.org/#narrow/stream/179170-smart/topic/Keycloak.20for.20SMART.20authz/near/225698418</a></p>",
        "id": 226104627,
        "sender_full_name": "Ryan Harrison",
        "timestamp": 1613114351
    },
    {
        "content": "<p>Aw, I'm going to have to miss tomorrow morning's session (conflict that I can't move) but will look forward to watching  a recording if someone can make one. (My regrets, <span class=\"user-mention\" data-user-id=\"361257\">@Dan Cinnamon</span> !)</p>",
        "id": 226747496,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1613606783
    },
    {
        "content": "<p>Shoot sorry to hear that but will definitely get a recording going!</p>",
        "id": 226749495,
        "sender_full_name": "Dan Cinnamon",
        "timestamp": 1613608149
    },
    {
        "content": "<p>Thanks again <span class=\"user-mention\" data-user-id=\"361257\">@Dan Cinnamon</span>  for the presentation this morning (and the work behind it)!  I was hoping to clarify / discuss a couple of points from it:</p>\n<ul>\n<li><em>Requiring</em> PKCE for clients means the implementation will not be SMART v1 compliant.<ul>\n<li>One implication to keep in mind is for US customers and ONC patient-facing app requirements / certification (e.g., that won't pass).</li>\n<li>Outside of that ruling, or as additional flows, this can and has been done (e.g., for a class of apps that aren't patient-facing).</li>\n<li>I know that vendors have done this (feel free to chime in), but wanted to be clear on the limitations.</li>\n</ul>\n</li>\n<li>This should/will* be different in SMART v2 (Coming Soon (tm)) (*: it is currently in the spec and has not been a point of contention - I'm leaving the 'should' because nothing is set in stone until publication).</li>\n<li>Could you describe a bit more of the interaction between PKCE and refresh tokens (not allowing refresh tokens without PKCE / confidential client)?  AFAICT, this just prevents someone who snooped on the authorization code and was able to exchange for an access token from renewing it.  Is that correct, or am I missing something else?</li>\n</ul>\n<p>Also, my local recording did work.  It's via Jitsi, so your recording is likely better quality if it worked, but all the text appears readable and the audio came through clearly.  Please just let me know if you want/need it posted.</p>",
        "id": 226856828,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1613672970
    },
    {
        "content": "<p>Thank you <span class=\"user-mention\" data-user-id=\"222054\">@Gino Canessa</span>! I did a quick gut check of my video, and it does look like it came through as well- I just wanted to do a little bit of cropping at the beginning and end and I'll post it before I begin the weekend. I'll let you know if I have issues though.</p>\n<p>I appreciate the follow-up on the PKCE topic as well- I think your understanding there is accurate, in that both PKCE and confidential clients give us some confidence that the tokens actually wound up in the right hands (with confidential still being more secure if it's possible to be used).</p>\n<p>So it has been Okta's stance that given the sensitivity of the refresh token that it's not something we're minting without the client falling into one of those 2 buckets (confidential, or public w/ PKCE).  </p>\n<p>Part of my proxy architecture would allow me to bypass that requirement if needed, and it would do so by having the /token proxy performing client authentication on behalf of the public client that doesn't use PKCE (Okta wouldn't know it as a public client- it would know it as a confidential one).</p>",
        "id": 226892471,
        "sender_full_name": "Dan Cinnamon",
        "timestamp": 1613686821
    },
    {
        "content": "<p>Thank you <span class=\"user-mention\" data-user-id=\"361257\">@Dan Cinnamon</span> for the presentation. I am implementing something similar for India. It isn't standard yet here, we are encouraged to learn from SMART (v1/v2) and are trying reference implementations. Most of the patient apps are mobile with a guidance to use PKCE. I have some questions for you. If these are answered before, please direct me there</p>\n<p>1) Is there an introspection endpoint the FHIR resource server can access ?<br>\n2) How would a device flow be ?<br>\n3) How do you support opaque tokens ?<br>\n4) Is there a plan to support EHR launch  ? <br>\nAny guidance on \"intent\" of launch context is appreciated. For example, break the glass (BTG)/emergency access to a patient record without consent. I understand Audit security flag, but I am looking more in terms of how can a record be accessed ?  How can the requester be downscoped to access only that patient's record and not anything else, until the audit is on</p>\n<p>Thanks again</p>",
        "id": 226906371,
        "sender_full_name": "Venu Gopal",
        "timestamp": 1613695778
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"251824\">@Venu Gopal</span> , welcome! (Sorry hit send too soon- i'll send response soon)</p>",
        "id": 227023557,
        "sender_full_name": "Dan Cinnamon",
        "timestamp": 1613766574
    },
    {
        "content": "<p>1) Is there an introspection endpoint the FHIR resource server can access ?</p>\n<p>Yep- there is an introspection endpoint that Okta offers out of the box that is called out in my metadata endpoints.</p>\n<p>2) How would a device flow be ?</p>\n<p>Can you clarify? Do you mean OAuth2 device code flow? Or machine to machine client credential flow?</p>\n<p>3) How do you support opaque tokens ?</p>\n<p>I'm not- I'm always using JSON web tokens.</p>\n<p>4) Is there a plan to support EHR launch ?</p>\n<p>Not at this time- I've given it some thought on how I might do it, so if there's big demand in the future I might take that leap.</p>\n<p>Any guidance on \"intent\" of launch context is appreciated. For example, break the glass (BTG)/emergency access to a patient record without consent. I understand Audit security flag, but I am looking more in terms of how can a record be accessed ? How can the requester be downscoped to access only that patient's record and not anything else, until the audit is on</p>\n<p>I have a feeling I'm not going to provide you with a sufficient answer right out of the gate, but here goes my first attempt (and maybe others with far more experience can jump in!):<br>\nSo in general, any of the launch response parameters, by themselves, are purely meant as \"hints\" to the application- and by themselves are not security enforcement.<br>\nThe \"patient\" response is special though, in that it does inform the application what patient the access token has access to- but it's still just a hint, the application can choose to ignore it (but won't be very useful if it does ignore it). <br>\nThe resource server is still responsible for introspecting the token, and furthermore checking/enforcing what \"records\" it can access. Exactly how that is determined is left to the implementation.<br>\nIn my particular implementation, since I'm using signed JWTs for my access tokens, I am also including the selected patient id as a claim within the access token, so it will be easy for the resource server to determine what patient the token is scoped to during the introspection process.<br>\nFor the intent response in particular, seems like it can be anything you want, and so I'd think to derive any value from that at all, the organization hosting the resource and authorization server would need to publish what their authorization server might send for it, so application developers can account for it in their applications.</p>",
        "id": 227042894,
        "sender_full_name": "Dan Cinnamon",
        "timestamp": 1613775507
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"361257\">@Dan Cinnamon</span>  Can you share the recording?</p>",
        "id": 227271735,
        "sender_full_name": "Alan Viars",
        "timestamp": 1614003262
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span>   Yes please add me to the SMART Health Cards thing.</p>",
        "id": 227271807,
        "sender_full_name": "Alan Viars",
        "timestamp": 1614003297
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"391350\">@Alan Viars</span>, definitely will.  I'm working with <span class=\"user-mention\" data-user-id=\"222054\">@Gino Canessa</span>  to see which of our recordings will be best to share.  I found out on Friday that my recording only has my audio in it (so the conversations are very one sided- ha).  So if Gino's recording is better, I'm hoping we can use his, otherwise mine is better than nothing and I'll share it!</p>",
        "id": 227275433,
        "sender_full_name": "Dan Cinnamon",
        "timestamp": 1614004600
    },
    {
        "content": "<p>Hi all, <a href=\"https://openaccessvideos.blob.core.windows.net/openaccessvideos/20210218-SMART-Okta-720p.mp4\">here</a> is a link to the recording of Dan's presentation I have.  I'll apologize that it doesn't have audio of me speaking (discovered a mic configuration issue), but on the balance I didn't say much =).</p>\n<p>Cheers,<br>\n-Gino</p>\n<p>(tags for people I've seen ask: <span class=\"user-mention\" data-user-id=\"391350\">@Alan Viars</span> <span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> <span class=\"user-mention\" data-user-id=\"251824\">@Venu Gopal</span> )</p>",
        "id": 227511063,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1614117656
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"361257\">@Dan Cinnamon</span> no problems. Thank you for your message and responses</p>\n<p>The question on device flow - I was interested in device flow as there mayn't be an option to key in login information. For example a patient may be equipped with a IoT device (a glucometer) and sync with patient's mobile app. The glucometer may have to post Observations at frequent time intervals to the app. How would the device authenticate with the patient app ? Or would that be M2M ? I am not an expert of M2M. So if you can offer some insights that would be of help</p>",
        "id": 228189932,
        "sender_full_name": "Venu Gopal",
        "timestamp": 1614583053
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"251824\">@Venu Gopal</span>,</p>\n<p>I see- so the device code flow is great in use cases where a headless device (or at least input limited device), has the ability to directly communicate with an API from your service. One of the best examples of this would be a smart TV- authenticating with your streaming service in a user friendly way by allowing the user to perform the actual login with a computer/mobile device rather than typing with their TV remote on a virtual keyboard. At the end of the device code flow process, the IoT device actually has OAuth tokens in hand that it can use for subsequent authorization directly to an API.</p>\n<p>A few considerations on that though:<br>\n1- For device code flow, the device does at least need to display a code to the user- perhaps 8 characters or so.  Will your device have any display at all? Even an old LCD panel like you might find on a 30 year old wrist watch will do- but it does require something.</p>\n<p>2- Also in device code flow, the device does need to communicate directly with the authorization service to obtain tokens and make API calls.</p>\n<p>I haven't designed a system like this personally, so please just take this as initial thoughts- but I think you should first start with who the actual OAuth2 client is (who/what is actually calling the FHIR API).  From your description, it sounds to me like perhaps your mobile app is the actual OAuth2 client to the FHIR API, and so the mobile app is the one that would do the SMART flow.</p>",
        "id": 228245210,
        "sender_full_name": "Dan Cinnamon",
        "timestamp": 1614611016
    },
    {
        "content": "<p>Thank you <span class=\"user-mention\" data-user-id=\"361257\">@Dan Cinnamon</span> you are right. I asked if more as a forward looking one. As of now the plan is to connect bluetooth enabled devices connect via the mobile app. Thank you so much for the insights</p>",
        "id": 229152770,
        "sender_full_name": "Venu Gopal",
        "timestamp": 1615088676
    },
    {
        "content": "<p>A long while back, I took a TODO to open up some Keycloak extensions that we were using in support of SMART App Launch.  I did that a few months ago but never got around to announcing it here.  If you are interested in SMART support for Keycloak, please have a look and let me know what you think:  <a href=\"https://github.com/Alvearie/keycloak-extensions-for-fhir\">https://github.com/Alvearie/keycloak-extensions-for-fhir</a></p>",
        "id": 242875608,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1623848114
    }
]