[
    {
        "content": "<p>I've been mulling and discussing the idea of telling apps about scopes being approved or denied (it was a topic on the last call).  So, I thought I'd bring it up here for further discussion.</p>\n<p>We all agreed that having it in the spec adds complexity, and I am trying to get an idea of how useful it is to offset that.  The TL;DR is that I'm not seeing it.  Also, apologies in advance for the long post =)</p>\n<ul>\n<li>Scenario 1:<ul>\n<li>App asks for scopes A, B, and C.</li>\n<li>User grants A and B.</li>\n<li>Fork:<ul>\n<li>App knows it was denied C<ul>\n<li>App has information that user denied C</li>\n<li>App assumes data is incomplete</li>\n</ul>\n</li>\n<li>App does not know it was denied C<ul>\n<li>App assumes it has all of scopes A, B, and C</li>\n<li>App still can't assume it has all data, since there are external reasons it may be incomplete</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<p>In either case, the App has to assume there can be data missing, because there are reasons beyond scope/auth that may cause incomplete data.</p>\n<ul>\n<li>Scenario 2:<ul>\n<li>App asks for access to Observations</li>\n<li>Server is fancy, and allows the user to select exactly which Observations (via policy, selection, whatever) this App gets access to.<ul>\n<li>How can this be communicated?</li>\n</ul>\n</li>\n<li>App uses the data it gets, but cannot assume it is complete.</li>\n</ul>\n</li>\n</ul>\n<p>So again, the App may or may not receive records, but cannot make assumptions of completeness.</p>\n<p>In general, servers cannot provide enough information to clients to say what is missing, since that would leak information.  So, best practice is that Apps should always assume data MAY be missing, and auth/scope is just one possible reason.</p>\n<p>With all that in mind, the biggest difference I see is that if the App doesn't get a record it is expecting AND it knows that scope was denied, it could prompt the user to re-auth...  But if an App doesn't get data it's expecting, that's a common solution anyway (e.g., the user workflow could/would look the same).</p>\n<p>Thoughts? Pieces I missed?</p>",
        "id": 203559236,
        "sender_full_name": "Gino Canessa",
        "timestamp": 1594416142
    },
    {
        "content": "<p>I agree there's a ton of complexity here. The issue of graceful degradation is one that apps must be able to handle irrespective of what the scopes say (though <span class=\"user-mention\" data-user-id=\"191356\">@Jenni Syed</span> I'm interested to know if you see this differently).</p>\n<p>The main benefit I see to returning a scopes list to the app is so in certain cases where the app is allowed to learn about denials, the app can explicitly re-prompt a user with a message like \"you chose not to share your vital signs. Please re-authorize here if you want to use our BP calculator.\"</p>",
        "id": 203596575,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1594473878
    },
    {
        "content": "<p>Such warnings can help recover from some situations where the user accidentally denies specific scopes. But these warnings can also be naggy and unwelcome. Furthermore, even if no explicit return scopes are communicated by the server, an app can approximate this \"mistake correcting\" behavior with messages like \"we're not seeing any blood pressure results in your chart. if you chose not to share but are now ready to change your mind, click here to re-authorize.\"</p>",
        "id": 203596727,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1594474164
    },
    {
        "content": "<p>Technically, this behavior isn't really something we get to \"choose\" to include, depending on the behavior of the server. The OAuth 2 specification already calls this out:</p>\n<blockquote>\n<p>The authorization server MAY fully or partially ignore the scope<br>\n   requested by the client, based on the authorization server policy or<br>\n   the resource owner's instructions.  If the issued access token scope<br>\n   is different from the one requested by the client, the authorization<br>\n   server MUST include the \"scope\" response parameter to inform the<br>\n   client of the actual scope granted.</p>\n</blockquote>",
        "id": 203598049,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1594476448
    },
    {
        "content": "<p><a href=\"https://tools.ietf.org/html/rfc6749#section-3.3\">https://tools.ietf.org/html/rfc6749#section-3.3</a></p>",
        "id": 203598050,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1594476457
    },
    {
        "content": "<p>The massive complexity comes in when your scopes are so specific as to start causing privacy concerns, which makes us question that \"MUST\"</p>",
        "id": 203598095,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1594476494
    },
    {
        "content": "<p>This is another reason I think we should keep scopes \"broader\" and the very granular, per observation, per loinc (not category) type consent needs to be somewhere else</p>",
        "id": 203598102,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1594476526
    },
    {
        "content": "<p>My graceful degradation (progressive enhancement? eh, you choose :)) comments are more for scenarios where the server is likely to 403 the request, which is what you should do when access is denied based on the scope not being present. And then apps not handling that error</p>",
        "id": 203598155,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1594476603
    },
    {
        "content": "<p>The scenarios that get complex, where data is \"hidden,\" aren't the things we do communicate to the app typically, because the user themselves may not have privs, or the user may not have consented to share (or the org doesn't). And yes, this means that apps need to understand generally that they may not see the full picture</p>",
        "id": 203598173,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1594476681
    },
    {
        "content": "<p>This is also the friction often between patient privacy advocates vs. clinicians that want to make sure they have all the info to be able to properly treat the patient - the APIs aren't the first place this is present. This is present within EHRs themselves as well</p>",
        "id": 203598222,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1594476746
    },
    {
        "content": "<p>Also, this isn't unique to healthcare, though obviously there are very different impacts :) Facebook allows you to grant apps privs, but also lets you hide specific posts from people/groups/etc. Those posts aren't really hidden by scopes - and they definitely don't tell grandma/mom/family that you hid your 21st birthday pics and posts from them :)</p>",
        "id": 203598317,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1594476912
    },
    {
        "content": "<p>And this goes back to the other recommendation I referred to: apps cannot assume \"no data\" == negative. Just like a doctor who is getting ready to perform a treatment that may conflict if the patient has certain conditions - if they see no evidence of the negative or positive result in the record, they aren't going to assume a negative. They will order the test (or ask the patient) before making a decision. Apps should do the same.</p>",
        "id": 203598533,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1594477296
    },
    {
        "content": "<p>Thanks! I agree with your points here and would like to formulate a plan. Given your notes here:</p>",
        "id": 203598588,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1594477375
    },
    {
        "content": "<ol>\n<li>there is a question about what apps can ask for. The \"request language\" needs to support some pretty decent granularity, in my view -- and I'm assuming that scopes are the place to put this request. Agreed?</li>\n</ol>",
        "id": 203598591,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1594477381
    },
    {
        "content": "<ol start=\"2\">\n<li>there is a question about what detailed internal policies a server can/will enforce. I'm assuming we (Argo 2020 Granular Data project) are not trying to standardize this at all. Agreed?</li>\n</ol>",
        "id": 203598594,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1594477388
    },
    {
        "content": "<ol start=\"3\">\n<li>there is a question of what approval decisions are communicated back to an app. I'm assuming an app always needs to consider treat these \"response language\" statements as a <em>hint</em> (because policy details from (2) can always silently override). I've been assuming scopes are the place to put this response. Agreed?</li>\n</ol>",
        "id": 203598595,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1594477391
    },
    {
        "content": "<p>Agree with 2and 3. Agree with 1 with the caveat that I don't think that scopes should go lower than categories of data <span aria-label=\"blush\" class=\"emoji emoji-1f60a\" role=\"img\" title=\"blush\">:blush:</span></p>",
        "id": 203603754,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1594485124
    },
    {
        "content": "<p>And labels and tags can be categories, but we should include guidance around how precise that should go.</p>",
        "id": 203603776,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1594485182
    },
    {
        "content": "<p>Okay. And how would you feel about a solution for (1) where the SMART 2.0 IG just described granularity at the level of categories (/labels/tags, as you suggest) but with a syntax that is extensible (e.g., a list of query parameters)?</p>",
        "id": 203604474,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1594486362
    },
    {
        "content": "<p>good discussion. I propose that the additional vector we add to current SMART is ConfidentialityCode (6 non-overlapping risk codes) + Sensitivity (categories of sensitivity). We could pick a valueset of the sensitivity, as some of these vocabulary are less useful or less clear. We don't require data to be labeled (i.e. .meta.security might be filled but not needed); leaving it up to the resource server API to filter based on any internal mechanics, where that internal mechanics might leave evidence around but might not. These internal mechanics might use loinc, might use ontology, might allow human tagging, etc...</p>",
        "id": 203724568,
        "sender_full_name": "John Moehrke",
        "timestamp": 1594651858
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span>  I'm good with that structure, though I think we should call out anti-patterns. EG: don't use \"code\" field within scope? I'm actually curious what other params we think would be good that wouldn't start to get so precise to start leaking privacy concerns. Might be a place to look at the \"common\" params and do some tests on what we think would and wouldn't be good to help guide some of our wording?</p>",
        "id": 203730883,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1594654745
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"191356\">@Jenni Syed</span>, <span class=\"user-mention\" data-user-id=\"191404\">@John Moehrke</span>. I think we're getting somewhere. A couple of notes:</p>\n<ul>\n<li>\n<p>I'm wary of decoupling sensitivity-based scopes (like <code>_security=XX</code>) from the tags present in the FHIR data themselves, though I agree we can leave this as a server decision. My recommendation would be: if your server is clever enough to match certain resources to a \"_security=XX\" scope, then it should also be populating <code>.meta.security</code> with \"XX\". This also allows for flow the other direction: if your server is flexible enough to let users assign <code>.meta.tag</code> values to resources, these should be addressable in the scope system.</p>\n</li>\n<li>\n<p>We might disagree on whether scopes with <code>code=</code> are an anti-pattern. Like, I was assuming Argonaut IG might wind up explicitly defining a scope for <a href=\"https://www.hl7.org/fhir/us/core/StructureDefinition-us-core-smokingstatus.html#mandatory-search-parameters\">US Core Smoking Status</a> like <code>patient/Observation?code=http://loinc.org|72166-2</code>.  If we won't define it this way (aligning with the US core guide data requirements), how <em>should</em> we define it?</p>\n</li>\n</ul>",
        "id": 203734704,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1594656465
    },
    {
        "content": "<p>im not against requiring the .meta.security tagging. I just think it is not necessary to make progress.  I am also not against _security parameter like expression, but that is a query parameter not a scope; where scopes would need to address all kinds of access, not just query.</p>",
        "id": 203747354,
        "sender_full_name": "John Moehrke",
        "timestamp": 1594662955
    },
    {
        "content": "<p>I am also not against use of some loinc based category codes. These  can be used in .meta.securty too, used there they are more consistent ABAC, vs the fact that not all clinical resources have a .category --- however I think it needs to be a very well defined sub-set. I think much of the reason DS4P is seen as hard to implement is that it is a very expansive and difficult set of value sets. A flat set of a dozen clinical codes is far more executable.</p>",
        "id": 203747766,
        "sender_full_name": "John Moehrke",
        "timestamp": 1594663126
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span> my concern is that I'm not sure:<br>\n1) That an auth server should need to be a terminology server to understand what codes are \"ok\" and what aren't and <br>\n2) Saying I only want social history using code is not really much different than saying I only want heart rate for vitals. I don't know that it should be done via scope... unless we can find something more general/that isn't also used for sensitive data</p>",
        "id": 203747985,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1594663204
    },
    {
        "content": "<p>OK, backing up: do you agree that granular controls needs to support things like \"only my smoking status\" (given that this is one of the US Core data elements)? And if so, is your preferred route to add a new category? And if so, should this bubble upstream into US Core so that the US Core IG requires populating that as Observation.category?</p>",
        "id": 203750032,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1594664060
    },
    {
        "content": "<blockquote>\n<p>I don't know that it should be done via scope</p>\n</blockquote>\n<p>And for this, are you suggesting an additional/complementary way for apps to request specific data? This hasn't been on the radar yet, but I'd like to understand what specifically you'd be proposing.</p>",
        "id": 203750216,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1594664155
    },
    {
        "content": "<p>we could provide the pathway in the scope where the authorization denial could be communicated, this would be usable when the app is mostly trusted to know that it has been denied access; while allowing the authorization decision to have other apps that it doesn't trust to know why they were denied. Defining the method of communicating the scope restriction is interoperability enabling; forcing this mechanism to be used is the problem. Some apps are trusted more than others, this is just reality.</p>",
        "id": 203750895,
        "sender_full_name": "John Moehrke",
        "timestamp": 1594664464
    },
    {
        "content": "<p>it could even be a user decision... user, you just denied this app some data that it has asked for, can I tell the app or should I not let it know?</p>",
        "id": 203750967,
        "sender_full_name": "John Moehrke",
        "timestamp": 1594664513
    }
]