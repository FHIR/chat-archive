[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"193782\">@Christopher Schaut</span> pointed out something that's got me worried.  <a href=\"http://hl7.org/fhir/smart-app-launch/#step-5-later-app-uses-a-refresh-token-to-obtain-a-new-access-token\">Section 7.1.6 of SMART spec</a> says </p>\n<blockquote>\n<p>A server can decide which client types (public or confidential) are eligible for offline access and able to receive a refresh token.</p>\n</blockquote>\n<p>The <a href=\"https://www.healthit.gov/cures/sites/default/files/cures/2020-10/ONC_IFC_Extension_of_Applicability_and_Compliance_Dates.pdf\">IFC</a> says (on page 48) </p>\n<blockquote>\n<p>we have specified that Health IT Modulesâ€™ authorization servers must issue a refresh token to native applications that are capable of securing a refresh token</p>\n</blockquote>\n<p><a href=\"http://hl7.org/fhir/smart-app-launch/#use-the-confidential-app--profile-if-your-app-is-able-to-protect-a-client_secret\">Section 3.0.1 of the SMART spec </a> defines confidential and public apps based on whether they can secure a <strong>client secret</strong>.  But this IFC makes their definition on whether the application can secure a <strong>refresh token</strong>.</p>",
        "id": 217164520,
        "sender_full_name": "Michael Donnelly",
        "timestamp": 1605718809
    },
    {
        "content": "<p>public and confidential are actually defined by the OAuth 2 specification, not SMART</p>",
        "id": 217165196,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1605719085
    },
    {
        "content": "<p>the way an app \"secures a refresh token\" is indeed different than the OAuth 2 definition of public vs confidential</p>",
        "id": 217165236,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1605719102
    },
    {
        "content": "<p>eg: if an application secures the refresh token on the device itself, and the refresh token never leaves the device - it's as secure s it can be for a public app</p>",
        "id": 217165469,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1605719178
    },
    {
        "content": "<p>I don't think \"securing a refresh token\" is a well-defined concept, and I have been a bit frustrated to see this concept introduced in the interim final rule. I think we need to simplify the story rather than making it more complicated :-)</p>",
        "id": 217165472,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1605719180
    },
    {
        "content": "<p>indeed, this would be a moving target of threat models and options, OS, and app :)</p>",
        "id": 217165539,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1605719211
    },
    {
        "content": "<p>There's no way to \"prove\" an app in this ecosystem follows the guides by OAuth 2 - so this issue is just being made more out in the open by the language above. IE: I don't think all apps that had offline access were \"confidential\" (I know some were native)</p>",
        "id": 217166944,
        "sender_full_name": "Jenni Syed",
        "timestamp": 1605719800
    },
    {
        "content": "<p>100% agreed</p>",
        "id": 217170831,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1605721456
    },
    {
        "content": "<p><a href=\"https://tools.ietf.org/html/rfc8252#section-8.6\">RFC 8252 discusses client impersonation</a> </p>\n<blockquote>\n<p>...the authorization server SHOULD NOT process authorization requests automatically without user consent or interaction, except when the identity of the client can be assured.  This includes the case where the user has previously approved an authorization request for a given client id -- unless the identity of the client can be proven, the request SHOULD be processed as if no previous request had been approved.</p>\n</blockquote>\n<p>Does this mean that we should update the SMART on FHIR spec to either require the app be a confidential app to process a refresh token, or stipulate some other form of client identity verification besides being a confidential app?</p>\n<p>The section does also say that claimed https schemes may serve as identity verification, but I don't think that's helpful to the native app developers that pushed for the change in the IFC.</p>",
        "id": 217290255,
        "sender_full_name": "Christopher Schaut",
        "timestamp": 1605801788
    },
    {
        "content": "<p>Do we need to update the SMART spec? <span class=\"user-mention\" data-user-id=\"191356\">@Jenni Syed</span> <span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span></p>",
        "id": 218306695,
        "sender_full_name": "Michael Donnelly",
        "timestamp": 1606752300
    },
    {
        "content": "<p>The language you quoted above pertains to (auto-)approving authorization requests, not to exchanging an existing proof of authorization to obtain an access token. In other words, the quote above would be arguing against things like redirecting back to the app immediately from the server's \"authorize\" endpoint (without displaying an approval screen for the user). This consideration is distinct from what happens when you exchange an authorization code or a refresh token for an access token.</p>",
        "id": 218310572,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1606753998
    },
    {
        "content": "<p>(to state this in a slightly different way, OAuth considers an \"authorization request\" to be the thing that happens when you redirect to an authorization server's authorized endpoint -- it's distinct from the thing that happens when a client calls the token endpoint with existing proof of authorization.)</p>",
        "id": 218310863,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1606754141
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"191315\">@Josh Mandel</span>, I see what you're saying. <br>\nGoing back to the OAuth2 spec, <a href=\"https://tools.ietf.org/html/rfc6749#section-10.1\">RFC 6749 section 10.1</a> says</p>\n<blockquote>\n<p>The authorization server must consider the security implications of interacting with unauthenticated clients and take measures to limit the potential exposure of other credentials (e.g., refresh tokens) issued to such clients.</p>\n</blockquote>\n<p><a href=\"https://tools.ietf.org/html/rfc6749#section-10.4\">RFC 6749 section 10.4</a> says</p>\n<blockquote>\n<p>The authorization server MUST maintain the binding between a refresh token and the client to whom it was issued. <br>\n...<br>\nThe authorization server MUST verify the binding between the refresh token and client identity whenever the client identity can be authenticated.  When client authentication is not possible, the authorization server SHOULD deploy other means to detect refresh token abuse.</p>\n</blockquote>\n<p>Considering the sensitivity of data we're handling, this seems to imply that within our SMART on FHIR spec we should satisfy this requirement. We should either require the client be confidential, or we should describe some alternative means, standard, or test that the authorization server can prove they can detect (and act on?) refresh token abuse. Of course, once there's refresh token abuse there is already a breach, so it begs the question of why we should permit a risk and require specific implementation of detection at all.</p>\n<p>Do you think this should drive a change in the SMART spec?</p>",
        "id": 218321968,
        "sender_full_name": "Christopher Schaut",
        "timestamp": 1606759161
    },
    {
        "content": "<p>I'm not sure what change we could</p>",
        "id": 218330475,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1606763054
    },
    {
        "content": "<p>...add to improve this. My take is that pretending your app can keep a secret (when it can't) won't provide meaningful security improvements -- and forcing traffic through a centralized cloud endpoint just to have a \"truly confidential\" client misses the point, by spreading data across more places than it really needs to go.</p>",
        "id": 218330619,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1606763146
    },
    {
        "content": "<p>If an individual user wants to share their data with a public client, this seems like a perfectly fair and reasonable thing to do. There's a whole set of tradeoffs involved.</p>",
        "id": 218330781,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1606763216
    },
    {
        "content": "<p>In the long term I'd say: we could explore / experiment with approaches to dynamic client registration; if we like how it goes, we could augment SMART spec, or maybe this will land in UDAP.</p>",
        "id": 218331116,
        "sender_full_name": "Josh Mandel",
        "timestamp": 1606763367
    }
]