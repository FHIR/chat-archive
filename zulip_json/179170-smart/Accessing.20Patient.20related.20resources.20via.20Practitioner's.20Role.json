[
    {
        "content": "<p>Hello everyone,</p>\n<p>I am currently implementing an app on top of ibm/fhir. In one of my scenarios there are Practitioner users. And a Practitioner:</p>\n<ul>\n<li>Can create an <code>Organization</code> and connect its <code>Practitioner</code> resource to this <code>Organization</code> via <code>PractitionerRole</code>. </li>\n<li>Can also include other <code>Practitioner</code>s  to the <code>Organization</code> via <code>PractitionerRole</code>.</li>\n<li>Can create new <code>Patient</code>s under the <code>Organization</code> by providing <code>managingOrganization</code> element to it.</li>\n<li>Has read/write access to the <code>Observation</code> records of a <code>Patient</code> who is under his/her <code>Organization</code>.</li>\n</ul>\n<p>So an example scenario is:</p>\n<p>There are following resources: </p>\n<div class=\"codehilite\" data-code-language=\"JavaScript\"><pre><span></span><code><span class=\"p\">{</span>\n  <span class=\"nx\">resourceType</span><span class=\"o\">:</span> <span class=\"s1\">'Organization'</span><span class=\"p\">,</span>\n  <span class=\"nx\">id</span><span class=\"o\">:</span> <span class=\"s1\">'Organization1'</span><span class=\"p\">,</span>\n  <span class=\"c1\">//...</span>\n<span class=\"p\">}</span>\n<span class=\"p\">{</span>\n  <span class=\"nx\">resourceType</span><span class=\"o\">:</span> <span class=\"s1\">'Practitioner'</span><span class=\"p\">,</span>\n  <span class=\"nx\">id</span><span class=\"o\">:</span> <span class=\"s1\">'Practitioner1'</span><span class=\"p\">,</span>\n  <span class=\"c1\">//...</span>\n<span class=\"p\">}</span>\n<span class=\"p\">{</span>\n  <span class=\"nx\">resourceType</span><span class=\"o\">:</span> <span class=\"s1\">'PractitionerRole'</span><span class=\"p\">,</span>\n  <span class=\"nx\">active</span><span class=\"o\">:</span> <span class=\"kc\">true</span><span class=\"p\">,</span>\n  <span class=\"nx\">practitioner</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">reference</span><span class=\"o\">:</span> <span class=\"s1\">'Practitioner/Practitioner1'</span>\n  <span class=\"p\">},</span>\n  <span class=\"nx\">organization</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">reference</span><span class=\"o\">:</span> <span class=\"s1\">'Organization/Organization1'</span>\n  <span class=\"p\">},</span>\n  <span class=\"nx\">code</span><span class=\"o\">:</span> <span class=\"p\">[{</span>\n    <span class=\"nx\">coding</span><span class=\"o\">:</span> <span class=\"p\">[{</span>\n      <span class=\"nx\">system</span><span class=\"o\">:</span> <span class=\"s1\">'http://terminology.hl7.org/CodeSystem/practitioner-role'</span><span class=\"p\">,</span>\n      <span class=\"nx\">code</span><span class=\"o\">:</span> <span class=\"s1\">'doctor'</span>\n    <span class=\"p\">}]</span>\n  <span class=\"p\">}]</span>\n  <span class=\"c1\">//...</span>\n<span class=\"p\">}</span>\n<span class=\"p\">{</span>\n  <span class=\"nx\">resourceType</span><span class=\"o\">:</span> <span class=\"s1\">'Patient'</span><span class=\"p\">,</span>\n  <span class=\"nx\">id</span><span class=\"o\">:</span> <span class=\"s1\">'Patient1'</span><span class=\"p\">,</span>\n  <span class=\"nx\">managingOrganization</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">reference</span><span class=\"o\">:</span> <span class=\"s1\">'Organization/Organization1'</span>\n  <span class=\"p\">},</span>\n  <span class=\"c1\">//...</span>\n<span class=\"p\">}</span>\n<span class=\"p\">{</span>\n  <span class=\"nx\">resourceType</span><span class=\"o\">:</span> <span class=\"s1\">'Observation'</span><span class=\"p\">,</span>\n  <span class=\"nx\">id</span><span class=\"o\">:</span> <span class=\"s1\">'Observation1'</span><span class=\"p\">,</span>\n  <span class=\"nx\">subject</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">reference</span><span class=\"o\">:</span> <span class=\"s1\">'Patient/Patient1'</span>\n  <span class=\"p\">},</span>\n  <span class=\"c1\">//...</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<hr>\n<p>Now lets say a <code>Practitioner</code> wants to get all <code>Observation</code>s belongs to the <code>Patient</code>s that are under the <code>Organization</code> of this <code>Practitioner</code>.<br>\nIn another saying <code>Practitioner</code> reads all <code>Observation</code>s by using the chain: <code>Practitioner -&gt; PractitionerRole -&gt; Organization -&gt; Patient -&gt; Observation</code></p>\n<ol>\n<li>To get Organization we use endpoint:  <code>/Organization?_has:PractitionerRole:organization:practitioner=Practitioner/{practitioner_id}</code></li>\n<li>So by taking the organization Id from the Organization, I will get all the Patients's ids by using endpoint <code>Patient?organization=Organization/{organization.id}&amp;_elements=id</code></li>\n<li>By using all the Patient Ids, I will get all the Observations belongs to those Patients</li>\n</ol>\n<hr>\n<p>So for this scenerio I have encountered 2 limitations so far:</p>\n<ul>\n<li>Fhir-smart implementation forces to use a claim <code>patient_id</code> in <code>access_token</code>, but instead, what I want is to provide <code>practitioner_id</code> (<a href=\"https://github.com/IBM/FHIR/blob/adda17a73e118e89c4b8b6bed8e81cf60a456a64/fhir-smart/src/main/java/com/ibm/fhir/smart/AuthzPolicyEnforcementPersistenceInterceptor.java#L326\">related line of code</a>)</li>\n<li>I couldn't find any logic on <code>fhir-smart</code> module's interceptor which considers the relation between a <a href=\"https://hl7.org/fhir/compartmentdefinition.html\">Compartment</a> and resource (additional example to the scenario above can be: Practitioner ↔ Encounter ↔ Patient).</li>\n</ul>\n<hr>\n<p>My questions are:</p>\n<ol>\n<li>How much of those limitations I encountered are resulted from the specification itself or due to lack of implementation?</li>\n<li>Is it possible to configure policy enforcement via fhir resources (e.g. <code>Encounter</code>, <code>Organization</code> and <code>PractitionerRole</code>) while using SMART specifications?</li>\n<li>Does this scenerio make sense at all under the specification of SMART on FHIR specification?</li>\n</ol>",
        "id": 268559553,
        "sender_full_name": "Volkan Kalın",
        "timestamp": 1642607610
    },
    {
        "content": "<p>Hi Vokan.  the spec stops well short of defining a permissions model (which practitioners should have access to which resources).  as you pointed out, the IBM FHIR server fhir-smart module uses a patient_id claim on the access token to restrict access to resources related to the patient compartment for one or more patient.  This is an internal detail of our implementation...the spec itself does not impose any restrictions on the access token...it is \"opaque\".</p>",
        "id": 268868105,
        "sender_full_name": "Lee Surprenant",
        "timestamp": 1642783118
    }
]