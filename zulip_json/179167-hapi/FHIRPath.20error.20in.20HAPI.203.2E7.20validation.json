[
    {
        "content": "<p>In HAPI 3.7, we're seeing an error when validating (STU3) against certain custom profiles. Specifically, we see the following errors when posting a valid Practitioner resource (this is from the returned OperationOutcome):</p>\n<div class=\"codehilite\"><pre><span></span>&quot;Problem evaluating slicing expression for element in profile http://example.org/fhir/StructureDefinition/MyBugpractitioner-de-basis-0.2 path Practitioner.name (fhirPath = true and (use memberOf &#39;http://hl7.org/fhir/ValueSet/name-use&#39;)): null&quot;\n</pre></div>\n\n\n<p>First bit of the error stack trace is</p>\n<div class=\"codehilite\"><pre><span></span>java.lang.UnsupportedOperationException\n    at org.hl7.fhir.dstu3.hapi.validation.FhirInstanceValidator$WorkerContextWrapper.expandVS(FhirInstanceValidator.java:535)\n    at org.hl7.fhir.r4.elementmodel.Element.getAsICoding(Element.java:775)\n    at org.hl7.fhir.r4.model.Base.castToCoding(Base.java:486)\n    at org.hl7.fhir.r4.utils.FHIRPathEngine.opMemberOf(FHIRPathEngine.java:1735)\n    at org.hl7.fhir.r4.utils.FHIRPathEngine.operate(FHIRPathEngine.java:1333)\n    at org.hl7.fhir.r4.utils.FHIRPathEngine.execute(FHIRPathEngine.java:1119)\n    at org.hl7.fhir.r4.utils.FHIRPathEngine.execute(FHIRPathEngine.java:1100)\n    at org.hl7.fhir.r4.utils.FHIRPathEngine.execute(FHIRPathEngine.java:1118)\n    at org.hl7.fhir.r4.utils.FHIRPathEngine.evaluate(FHIRPathEngine.java:503)\n    at org.hl7.fhir.r4.utils.FHIRPathEngine.evaluateToBoolean(FHIRPathEngine.java:559)\n    at org.hl7.fhir.r4.validation.InstanceValidator.evaluateSlicingExpression(InstanceValidator.java:2571)\n    at org.hl7.fhir.r4.validation.InstanceValidator.sliceMatches(InstanceValidator.java:2563)\n    at org.hl7.fhir.r4.validation.InstanceValidator.matchSlice(InstanceValidator.java:3801)\n    at org.hl7.fhir.r4.validation.InstanceValidator.validateElement(InstanceValidator.java:3505)\n    at org.hl7.fhir.r4.validation.InstanceValidator.start(InstanceValidator.java:2681)\n    at org.hl7.fhir.r4.validation.InstanceValidator.validateResource(InstanceValidator.java:4020)\n   (...)\n</pre></div>\n\n\n<p>The profile is a re-profiling of the <a href=\"https://simplifier.net/basisprofilde/practitioner-de-basis-0.2-duplicate-2\" target=\"_blank\" title=\"https://simplifier.net/basisprofilde/practitioner-de-basis-0.2-duplicate-2\">German Base Practitioner profile</a> in which the following changes are introduced:</p>\n<p>1. Make the <code>name</code> field required<br>\n2. Slice the <code>name</code> with the discriminator on the value of the <code>name.use</code> field<br>\n3. Add a required (1..1) slice in which <code>name.use</code> is required and fixed to \"official\", and <code>name.given</code>and <code>name.family</code>are required.</p>\n<p>The error seems to be related to the profile in question being a re-profling</p>\n<p>Is this a known issue and is there perhaps a workaround?</p>",
        "id": 158804445,
        "sender_full_name": "Morten Ernebjerg",
        "timestamp": 1550500950
    },
    {
        "content": "<p>not sure. I'll have to investigate.</p>",
        "id": 158840564,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1550538288
    },
    {
        "content": "<p>I think that this is before the change to the new hapi core structure?</p>",
        "id": 158840572,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1550538305
    },
    {
        "content": "<p>Hm, not sure when the split was -  HAPI 3.7 was released on Feb 6th (release is Git commit #207015c3af5022570c36796ce0f4f0067ff9bc3a).</p>",
        "id": 158860497,
        "sender_full_name": "Morten Ernebjerg",
        "timestamp": 1550567368
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> Should I make a GF ticket for this for your current sweep through the validator?</p>",
        "id": 159983719,
        "sender_full_name": "Morten Ernebjerg",
        "timestamp": 1551772504
    },
    {
        "content": "<p>can you reproduce this with the validator.jar?</p>",
        "id": 159986381,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1551775897
    },
    {
        "content": "<p>Just checked with the latest validator JAR and it worked fine, so I suppose this is actually coming from HAPI.</p>",
        "id": 159990839,
        "sender_full_name": "Morten Ernebjerg",
        "timestamp": 1551780493
    },
    {
        "content": "<p>ok. well, is it because the code is not up to date?</p>",
        "id": 159991048,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1551780700
    },
    {
        "content": "<p>Just checked again and I see the above error with the most recent HAPI release (3.7). In my setup, I'm afraid I can't check against anything newer so I cannot tell if it has fixed in GitHub.</p>",
        "id": 160020956,
        "sender_full_name": "Morten Ernebjerg",
        "timestamp": 1551806050
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span> is there are way to investigate this?</p>",
        "id": 160023593,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1551807973
    }
]