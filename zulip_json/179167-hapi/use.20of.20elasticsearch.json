[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span> <br>\nwe see errors when trying to do valueset expansions (4.2.0) while using elasticsearch (6.8.6):</p>\n<div class=\"codehilite\"><pre><span></span>Caused by: org.hibernate.search.exception.SearchException: HSEARCH400002: Lucene query &#39;myCode:&quot;(message notification advice note)&quot;&#39; cannot be transformed into equivalent Elasticsearch query\n    at org.hibernate.search.elasticsearch.impl.ToElasticsearch.fromLuceneQuery(ToElasticsearch.java:268)\n    at org.hibernate.search.elasticsearch.impl.ToElasticsearch.convertBooleanQuery(ToElasticsearch.java:302)\n    at org.hibernate.search.elasticsearch.impl.ToElasticsearch.fromLuceneQuery(ToElasticsearch.java:206)\n    at org.hibernate.search.elasticsearch.impl.ElasticsearchLuceneQueryTranslator.convertLuceneQuery(ElasticsearchLuceneQueryTranslator.java:41)\n    at org.hibernate.search.engine.impl.ImmutableSearchFactory.createQueryDescriptor(ImmutableSearchFactory.java:308)\n    at org.hibernate.search.engine.impl.ImmutableSearchFactory.createHSQuery(ImmutableSearchFactory.java:291)\n    at org.hibernate.search.engine.impl.MutableSearchFactory.createHSQuery(MutableSearchFactory.java:138)\n    at org.hibernate.search.impl.FullTextSessionImpl.createFullTextQuery(FullTextSessionImpl.java:77)\n    at org.hibernate.search.impl.FullTextSessionImpl.createFullTextQuery(FullTextSessionImpl.java:52)\n    at ca.uhn.fhir.jpa.term.BaseTermReadSvcImpl.expandValueSetHandleIncludeOrExclude(BaseTermReadSvcImpl.java:614)\n    at ca.uhn.fhir.jpa.term.BaseTermReadSvcImpl.lambda$expandValueSet$0(BaseTermReadSvcImpl.java:457)\n    at org.springframework.transaction.support.TransactionTemplate.execute(TransactionTemplate.java:140)\n...\n</pre></div>\n\n\n<ul>\n<li>is this related to a malformed configuration/incorrect spring bindings on our side?</li>\n</ul>",
        "id": 188360654,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1581928896
    },
    {
        "content": "<p>its triggered by the fact that org.apache.lucene.search.MultiPhraseQuery's are not currently mapped</p>",
        "id": 188362570,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1581931037
    },
    {
        "content": "<p>Which happens here: <a href=\"https://github.com/jamesagnew/hapi-fhir/blob/c5c1e3196b776c8b5cb6ddbf70845c024a73148f/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/term/BaseTermReadSvcImpl.java#L603\" target=\"_blank\" title=\"https://github.com/jamesagnew/hapi-fhir/blob/c5c1e3196b776c8b5cb6ddbf70845c024a73148f/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/term/BaseTermReadSvcImpl.java#L603\">https://github.com/jamesagnew/hapi-fhir/blob/c5c1e3196b776c8b5cb6ddbf70845c024a73148f/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/term/BaseTermReadSvcImpl.java#L603</a></p>",
        "id": 188363388,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1581931800
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191451\">@Patrick Werner</span> - have you stumbled across this problem?</p>",
        "id": 188375471,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1581943847
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191427\">@Jens Villadsen</span> not yet, we are still using Lucene</p>",
        "id": 188389106,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1581955127
    },
    {
        "content": "<p>Currently, ElasticSearch 2.x is required as this is the version supported<br>\nby the current GA release of Hibernate Search. They are seemingly very<br>\nclose to releasing a new major release though which will add support for<br>\nES5/6.</p>\n<p>Cheers,<br>\nJames</p>",
        "id": 188399680,
        "sender_full_name": "James Agnew",
        "timestamp": 1581965332
    },
    {
        "content": "<p>Sorry- I take that partially back.</p>\n<p>It's 6.x that isn't supported, but 5.x is. So you should be able to do this using a 5.x release of ES.</p>",
        "id": 188399942,
        "sender_full_name": "James Agnew",
        "timestamp": 1581965588
    },
    {
        "content": "<p>Awesome! Thx.</p>",
        "id": 188405477,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1581972108
    },
    {
        "content": "<p>I dont know why I insisted on using 6.x ...</p>",
        "id": 188405526,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1581972144
    },
    {
        "content": "<div class=\"message_inline_image\"><a href=\"https://media.tenor.com/images/abcd1c505f535e2958ac85b64a901953/tenor.gif\" target=\"_blank\" title=\"https://media.tenor.com/images/abcd1c505f535e2958ac85b64a901953/tenor.gif\"><img src=\"https://media.tenor.com/images/abcd1c505f535e2958ac85b64a901953/tenor.gif\"></a></div>",
        "id": 188405534,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1581972174
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span> - just tried with ES 5.6.16 ...no luck</p>",
        "id": 188407783,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1581974938
    },
    {
        "content": "<p>it is caused by <a href=\"https://github.com/hibernate/hibernate-search/blob/e7e19ed2a64fffce8d161802e7664438b8d53340/legacy/elasticsearch/src/main/java/org/hibernate/search/elasticsearch/impl/ToElasticsearch.java#L267\" target=\"_blank\" title=\"https://github.com/hibernate/hibernate-search/blob/e7e19ed2a64fffce8d161802e7664438b8d53340/legacy/elasticsearch/src/main/java/org/hibernate/search/elasticsearch/impl/ToElasticsearch.java#L267\">https://github.com/hibernate/hibernate-search/blob/e7e19ed2a64fffce8d161802e7664438b8d53340/legacy/elasticsearch/src/main/java/org/hibernate/search/elasticsearch/impl/ToElasticsearch.java#L267</a> (maybe not the entirely correct branch on hibernate search) - the use of a MultiPhraseQuery seems to end there - where hibernate throws an exception</p>",
        "id": 188407990,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1581975169
    },
    {
        "content": "<p>the error is thrown before there is any interaction with ES</p>",
        "id": 188408067,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1581975296
    },
    {
        "content": "<p>Whoa, interesting.</p>\n<p>What does the ValueSet that is triggering this look like?</p>",
        "id": 188445204,
        "sender_full_name": "James Agnew",
        "timestamp": 1582027927
    },
    {
        "content": "<p><a href=\"https://docs.ehealth.sundhed.dk/latest/ig/ValueSet-message-category.html\" target=\"_blank\" title=\"https://docs.ehealth.sundhed.dk/latest/ig/ValueSet-message-category.html\">https://docs.ehealth.sundhed.dk/latest/ig/ValueSet-message-category.html</a></p>",
        "id": 188459541,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1582039346
    },
    {
        "content": "<p>backing codesystem: <a href=\"https://docs.ehealth.sundhed.dk/latest/ig/CodeSystem-ehealth-message-category.html\" target=\"_blank\" title=\"https://docs.ehealth.sundhed.dk/latest/ig/CodeSystem-ehealth-message-category.html\">https://docs.ehealth.sundhed.dk/latest/ig/CodeSystem-ehealth-message-category.html</a></p>",
        "id": 188459603,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1582039385
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span> there you go</p>",
        "id": 188460604,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1582039994
    },
    {
        "content": "<p>Loading that and calling $expand on it</p>",
        "id": 188479690,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1582052020
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191427\">@Jens Villadsen</span> yup, I see this same issue with your test case. Thanks.</p>\n<p>Fix has gone in: <a href=\"https://github.com/jamesagnew/hapi-fhir/pull/1717\" target=\"_blank\" title=\"https://github.com/jamesagnew/hapi-fhir/pull/1717\">https://github.com/jamesagnew/hapi-fhir/pull/1717</a></p>",
        "id": 188487622,
        "sender_full_name": "James Agnew",
        "timestamp": 1582057440
    },
    {
        "content": "<p>(for review, not merged yet)</p>",
        "id": 188487668,
        "sender_full_name": "James Agnew",
        "timestamp": 1582057451
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span> out of curiosity,  would you in any way consider my use of valuesets and codesystems exotic?</p>",
        "id": 188489669,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1582059014
    },
    {
        "content": "<p>Heh nope, I'd say that's about as \"hello world\" of expanding valuesets as it gets :)</p>",
        "id": 188490026,
        "sender_full_name": "James Agnew",
        "timestamp": 1582059286
    },
    {
        "content": "<p>Although.. Technically for your specific example you could just not include any codes at all in the VS, and only include the system if your intent is to just include all codes</p>",
        "id": 188490077,
        "sender_full_name": "James Agnew",
        "timestamp": 1582059328
    },
    {
        "content": "<p>hmmm ... yes that is true... can't say why that valueset ended up like that ... i don't believe thats is the general picture of the valuesets in that IG though ;)</p>",
        "id": 188493110,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1582061244
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span>  any change that this and the update of the hl7 core validation component could go into a 4.2.1?</p>",
        "id": 188560136,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1582129917
    },
    {
        "content": "<p>as an alternative (I guess/hope) I could make it my self from <a href=\"https://github.com/jamesagnew/hapi-fhir/pull/1719\" target=\"_blank\" title=\"https://github.com/jamesagnew/hapi-fhir/pull/1719\">https://github.com/jamesagnew/hapi-fhir/pull/1719</a> and <a href=\"https://github.com/jamesagnew/hapi-fhir/pull/1717\" target=\"_blank\" title=\"https://github.com/jamesagnew/hapi-fhir/pull/1717\">https://github.com/jamesagnew/hapi-fhir/pull/1717</a> given that the changes are not conflicting with the rest of 4.2.0</p>",
        "id": 188560630,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1582130206
    },
    {
        "content": "<p>once done, that is</p>",
        "id": 188832886,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1582405004
    }
]