[
    {
        "content": "<p>Reference: <a href=\"https://www.hl7.org/fhir/search.html#combining\" target=\"_blank\" title=\"https://www.hl7.org/fhir/search.html#combining\">https://www.hl7.org/fhir/search.html#combining</a></p>\n<p>We are working on an IG for a medical formulary.   Roughly the CoveragePlan is a List (with some extra stuff) and the Drugs in the Plan are MedicationKnowledge instances.      The List refers to the MedicationKnowledge items.</p>\n<p><strong>Example CoveragePlan</strong> is:  SaulExperimentCP2<br>\n<a href=\"https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/List/SaulExperimentCP2\" target=\"_blank\" title=\"https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/List/SaulExperimentCP2\">https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/List/SaulExperimentCP2</a><br>\n<strong>Example FormularyDrug</strong> is:<br>\nSaulExperimentFD2<br>\n<a href=\"https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/MedicationKnowledge/SaulExperimentFD2\" target=\"_blank\" title=\"https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/MedicationKnowledge/SaulExperimentFD2\">https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/MedicationKnowledge/SaulExperimentFD2</a></p>\n<p>I'm trying to exercise FHIR-based search on this data, and things are not working as expected when I combine searches as per the documentation.<br>\nHere is what works, and what doesn't work.   Basically I can search for (classification=A) and (classification=B) successfully, but searching for (classification=A)<strong>AND</strong>(classification=B) fails.</p>\n<div class=\"codehilite\"><pre><span></span>- this **works**:       https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/MedicationKnowledge?classification=https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/CodeSystem/usdrugformulary-DrugTierCS%7CBRAND\n</pre></div>\n\n\n<p>- this <strong>works</strong>:        <a href=\"https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/MedicationKnowledge?_list=SaulExperimentCP2&amp;classification=BRAND\" target=\"_blank\" title=\"https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/MedicationKnowledge?_list=SaulExperimentCP2&amp;classification=BRAND\">https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/MedicationKnowledge?_list=SaulExperimentCP2&amp;classification=BRAND</a>     <br>\n  - this <strong>works </strong> search by DrugTier  <a href=\"https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/MedicationKnowledge?classification=https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/CodeSystem/usdrugformulary-DrugTierCS%7CBRAND\" target=\"_blank\" title=\"https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/MedicationKnowledge?classification=https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/CodeSystem/usdrugformulary-DrugTierCS%7CBRAND\">https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/MedicationKnowledge?classification=https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/CodeSystem/usdrugformulary-DrugTierCS%7CBRAND</a><br>\n    - this <strong>fails</strong>:      search by DrugTier <strong>AND</strong> planID <strong>with</strong> system   <a href=\"https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/MedicationKnowledge?classification=https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/CodeSystem/usdrugformulary-DrugTierCS%7CBRAND&amp;classification=https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/CodeSystem/usdrugformulary-PlanIDCS|12345XX9876543\" target=\"_blank\" title=\"https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/MedicationKnowledge?classification=https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/CodeSystem/usdrugformulary-DrugTierCS%7CBRAND&amp;classification=https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/CodeSystem/usdrugformulary-PlanIDCS|12345XX9876543\">https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/MedicationKnowledge?classification=https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/CodeSystem/usdrugformulary-DrugTierCS%7CBRAND&amp;classification=https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/CodeSystem/usdrugformulary-PlanIDCS|12345XX9876543</a><br>\n- this <strong>fails</strong>  search by DrugTier and PlanID <strong>without</strong> system   <a href=\"https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/MedicationKnowledge?classification=12345XX9876543&amp;classification=BRAND&amp;_profile=https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/StructureDefinition/usdrugformulary-FormularyDrug\" target=\"_blank\" title=\"https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/MedicationKnowledge?classification=12345XX9876543&amp;classification=BRAND&amp;_profile=https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/StructureDefinition/usdrugformulary-FormularyDrug\">https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/MedicationKnowledge?classification=12345XX9876543&amp;classification=BRAND&amp;_profile=https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/StructureDefinition/usdrugformulary-FormularyDrug</a></p>\n<p>The same failure modes are present if I use the _list to constrain the search to members of the list.</p>",
        "id": 166209992,
        "sender_full_name": "Saul Kravitz",
        "timestamp": 1558470866
    },
    {
        "content": "<p>The <code>_list</code> search parameter is not yet implemented in HAPI FHIR unfortunately.</p>",
        "id": 166212424,
        "sender_full_name": "James Agnew",
        "timestamp": 1558472443
    },
    {
        "content": "<p>Thanks for the quick response.</p>\n<p>Is the failure searching for  (classification=A)AND(classification=B)  also expected.</p>",
        "id": 166212922,
        "sender_full_name": "Saul Kravitz",
        "timestamp": 1558472805
    },
    {
        "content": "<p>No, that one should work.</p>\n<p>The error message there doesn't look like it's coming from HAPI though... A good first step would probably be to see if you can reproduce this on <a href=\"http://hapi.fhir.org\" target=\"_blank\" title=\"http://hapi.fhir.org\">hapi.fhir.org</a> .. If not, this is probably a question for the HSPC developers.</p>",
        "id": 166262989,
        "sender_full_name": "James Agnew",
        "timestamp": 1558528724
    },
    {
        "content": "<p>Saul's 2nd-to-last query (w/ systems) does fail with a <code>400</code> -- which is the error message I expect <span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span> is referring to.  But if we take the system out of the picture we have this:</p>\n<ul>\n<li><a href=\"https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/MedicationKnowledge?classification=BRAND\" target=\"_blank\" title=\"https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/MedicationKnowledge?classification=BRAND\">Query w/ <code>classification=BRAND</code></a> returns MedicationKnowledge w/ id <code>SaulExperimentFD2</code></li>\n<li><a href=\"https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/MedicationKnowledge?classification=12345XX9876543\" target=\"_blank\" title=\"https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/MedicationKnowledge?classification=12345XX9876543\">Query w/ <code>classification=12345XX9876543</code></a> returns MedicationKnowledge w/ id <code>SaulExperimentFD2</code> (same as above)</li>\n<li><a href=\"https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/MedicationKnowledge?classification=BRAND&amp;classification=12345XX9876543\" target=\"_blank\" title=\"https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/MedicationKnowledge?classification=BRAND&amp;classification=12345XX9876543\">Query w/ <code>classification=BRAND&amp;classification=12345XX9876543</code></a> returns <code>0</code> results.</li>\n</ul>\n<p>Given that the first two queries are successful and return _the same object_, we expect the third should also be successful.  No error is returned, but it has an empty set of results.  Do you still think that has something to do w/ HSPC implementation?</p>",
        "id": 166272127,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1558534942
    },
    {
        "content": "<p>Well, 400 errors coming out of HAPI should typically return an OperationOutcome. E.g.:</p>\n<p><a href=\"https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/MedicationKnowledge?foo=bar\" target=\"_blank\" title=\"https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/MedicationKnowledge?foo=bar\">https://api-v8-r4.hspconsortium.org/DrugFormulary1/open/MedicationKnowledge?foo=bar</a></p>\n<p>It's suspicious to me that this one doesn't. I'd need to see a stack trace though to be sure..</p>",
        "id": 166276828,
        "sender_full_name": "James Agnew",
        "timestamp": 1558537675
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span> -- right, but can you comment on the results of my last message, which does not trigger the <code>400</code> error at all?</p>",
        "id": 166277608,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1558538136
    },
    {
        "content": "<p>that does look like something that should work, i'd agree.</p>",
        "id": 166279016,
        "sender_full_name": "James Agnew",
        "timestamp": 1558538925
    },
    {
        "content": "<p>this isn't my server though, so my ability to troubleshoot is limited.. reproducing it on HAPI would be a requirement in order for me to be able to do anything about it</p>",
        "id": 166279086,
        "sender_full_name": "James Agnew",
        "timestamp": 1558538976
    },
    {
        "content": "<p>Got it, thanks!  <span class=\"user-mention\" data-user-id=\"215604\">@Saul Kravitz</span> -- I'll leave the rest to you if you wish to try to reproduce this on the HAPI server.</p>",
        "id": 166301911,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1558553726
    },
    {
        "content": "<p>Will do.</p>",
        "id": 166304750,
        "sender_full_name": "Saul Kravitz",
        "timestamp": 1558555794
    },
    {
        "content": "<p>Short version:  everything works fine on <a href=\"http://hapi.fhir.org/baseR4\" target=\"_blank\" title=\"http://hapi.fhir.org/baseR4\">http://hapi.fhir.org/baseR4</a><br>\nInserted two MedicationKnowledge objects -- <a href=\"http://hapi.fhir.org/baseR4/MedicationKnowledge/\" target=\"_blank\" title=\"http://hapi.fhir.org/baseR4/MedicationKnowledge/\">http://hapi.fhir.org/baseR4/MedicationKnowledge/</a>?<br>\n<a href=\"http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK1\" target=\"_blank\" title=\"http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK1\">http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK1</a><br>\n<a href=\"http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK2\" target=\"_blank\" title=\"http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK2\">http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK2</a></p>\n<p><a href=\"http://hapi.fhir.org/baseR4/MedicationKnowledge/?classification=BRAND\" target=\"_blank\" title=\"http://hapi.fhir.org/baseR4/MedicationKnowledge/?classification=BRAND\">http://hapi.fhir.org/baseR4/MedicationKnowledge/?classification=BRAND</a>    returns both objects, as expected.<br>\n<a href=\"http://hapi.fhir.org/baseR4/MedicationKnowledge/?classification=BRAND\" target=\"_blank\" title=\"http://hapi.fhir.org/baseR4/MedicationKnowledge/?classification=BRAND\">http://hapi.fhir.org/baseR4/MedicationKnowledge/?classification=BRAND</a> &amp;classification=12345XX9876544 returns one object, as expected.<br>\n<a href=\"http://hapi.fhir.org/baseR4/MedicationKnowledge/?classification=BRAND\" target=\"_blank\" title=\"http://hapi.fhir.org/baseR4/MedicationKnowledge/?classification=BRAND\">http://hapi.fhir.org/baseR4/MedicationKnowledge/?classification=BRAND</a> &amp;classification=12345XX9876543 returns one object as expected<br>\n<a href=\"http://hapi.fhir.org/baseR4/MedicationKnowledge/?classification=12345XX9876544,12345XX9876543\" target=\"_blank\" title=\"http://hapi.fhir.org/baseR4/MedicationKnowledge/?classification=12345XX9876544,12345XX9876543\">http://hapi.fhir.org/baseR4/MedicationKnowledge/?classification=12345XX9876544,12345XX9876543</a> returns two objects as expected.</p>\n<p>In short, works as advertised...sigh....</p>\n<p>Thoughts on how to debug the HSPC server?<br>\nI loaded the same two objects (MedicationKNowledge sans our extensions) into the HSPC server, and the 'AND' queries fail.</p>",
        "id": 166308776,
        "sender_full_name": "Saul Kravitz",
        "timestamp": 1558558546
    },
    {
        "content": "<p>Hmm, wonder if this is a bug that's already fixed in 3.8.0. Might be worth waiting for the release (happening this coming tuesday) to see if that resolves things on the HSPC side.</p>",
        "id": 166324051,
        "sender_full_name": "James Agnew",
        "timestamp": 1558574239
    },
    {
        "content": "<p>My test also fails on our own build of HAPI 3.7.<br>\nLook forward to 3.8 release....</p>",
        "id": 166366938,
        "sender_full_name": "Saul Kravitz",
        "timestamp": 1558622463
    }
]