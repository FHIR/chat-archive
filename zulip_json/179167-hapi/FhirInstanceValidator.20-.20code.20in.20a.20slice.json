[
    {
        "content": "<p>Hello,</p>\n<p>TL/DR: I have an Issue with the FhirInstanceValidator on a code in a required slice. Can I work around it without removing the profile from the validator?</p>\n<p>To be precise: I want to create an Organization which is supposed to have a work address. The Profile states that it should have a slice of address with the use defined as work using this <a href=\"http://hl7.org/fhir/STU3/valueset-address-use.html\" target=\"_blank\" title=\"http://hl7.org/fhir/STU3/valueset-address-use.html\">valueset</a>.  Without the Validator using my Profile enabled I can create the organization just fine, sending in something like:</p>\n<div class=\"codehilite\"><pre><span></span>{\n  &quot;resourceType&quot;: &quot;Organization&quot;,\n  &quot;name&quot;: &quot;org&quot;,\n  &quot;address&quot;: [{\n    &quot;use&quot;: &quot;work&quot;,\n    &quot;city&quot;: &quot;Atown&quot;,\n    &quot;postalCode&quot;: &quot;12345&quot;,\n    &quot;country&quot;: &quot;Bland&quot;,\n    &quot;line&quot;: [\n      &quot;CStreet 1&quot;\n    ]\n  }]\n}\n</pre></div>\n\n\n<p>When I activate the validator though, I get the following response:</p>\n<div class=\"codehilite\"><pre><span></span>&quot;response&quot;: {\n    &quot;statusCode&quot;: 422,\n    &quot;body&quot;: {\n      &quot;resourceType&quot;: &quot;OperationOutcome&quot;,\n      &quot;issue&quot;: [\n        {\n          &quot;severity&quot;: &quot;error&quot;,\n          &quot;code&quot;: &quot;processing&quot;,\n          &quot;diagnostics&quot;: &quot;Problem evaluating slicing expression for element in profile &lt;Profile&gt; path Organization.address (fhirPath = true and (use memberOf &#39;http://hl7.o\nrg/fhir/ValueSet/address-use&#39;)): null&quot;,\n          &quot;location&quot;: [\n            &quot;Organization.address&quot;\n          ]\n        },\n        {\n          &quot;severity&quot;: &quot;information&quot;,\n          &quot;code&quot;: &quot;processing&quot;,\n          &quot;diagnostics&quot;: &quot;Profile &lt;Profile&gt;, Element &#39;Organization.address[workAddress]&#39;&#39;: Unable to check minimum required (1) due to lack of slicing validation&quot;,\n          &quot;location&quot;: [\n            &quot;Organization&quot;\n          ]\n        }\n      ]\n    }\n</pre></div>\n\n\n<p>I debugged through lots of the code and noticed that it gets to the point where the rule: <code>use memberOf 'http://hl7.o\nrg/fhir/ValueSet/address-use'</code> is evaluated.<br>\nThe given value of use (which is <code>work</code>)  is being converted to a Codeing.<br>\nTo do this the given valueset is trying to be expanded which ends up in this code:</p>\n<div class=\"codehilite\"><pre><span></span>@Override\npublic ValueSetExpander.ValueSetExpansionOutcome expandVS(org.hl7.fhir.r4.model.ElementDefinition.ElementDefinitionBindingComponent binding, boolean cacheOk, boolean heiarchical) {\n  throw new UnsupportedOperationException();\n}\n</pre></div>\n\n\n<p>What I think to be weird, is that when the same kind of attribute (a code given as string value with an implicit valueset) is outside of a slice, it works. For example posting an observation which has a status that is part of a valueset as well, works.<br>\nI did notice though that posting an observation with an invalid status does not fail in validation but in processing.</p>\n<p>Now to my question:<br>\nIs there any way for me to make the validator not fail on my adress slice other than removing the profile altogether?<br>\nCan I overwrite the expandVS function in my validator to make it work somehow?<br>\nIs there maybe a way to express the same thing in the profile in a different way? (Multiple adresses are okay, but one has to be a work address.)</p>\n<p>Thanks and best regards,<br>\nLars</p>",
        "id": 166170688,
        "sender_full_name": "Lars R端ckert",
        "timestamp": 1558444434
    },
    {
        "content": "<p>Hi Lars,</p>\n<p>Before any other checking, it would be worth testing your system against the latest snapshot builds of HAPI FHIR (3.8.0-SNAPSHOT). The validator is very actively developed, so many things have been fixed since 3.7.0 was released.</p>",
        "id": 166205819,
        "sender_full_name": "James Agnew",
        "timestamp": 1558467823
    },
    {
        "content": "<p>Hi James,</p>\n<p>thanks for the answer, unfortunately we have a setup where we have to get the dependencies from maven, which seems not to be available yet.<br>\nI think we can work around it for now by changing the profile a bit.<br>\nDo you have an estimation as to when 3.8.0 will be released?</p>",
        "id": 166244006,
        "sender_full_name": "Lars R端ckert",
        "timestamp": 1558510557
    },
    {
        "content": "<p>We'll be releasing on this coming Tuesday. If you want to use snapshot builds before then, there are instructions on how to do this here: <a href=\"http://hapifhir.io/download.html#_toc_using_snapshot_builds\" target=\"_blank\" title=\"http://hapifhir.io/download.html#_toc_using_snapshot_builds\">http://hapifhir.io/download.html#_toc_using_snapshot_builds</a></p>",
        "id": 166263489,
        "sender_full_name": "James Agnew",
        "timestamp": 1558529184
    },
    {
        "content": "<p>That's great! Thank you a lot for the information.</p>",
        "id": 166268503,
        "sender_full_name": "Lars R端ckert",
        "timestamp": 1558532781
    },
    {
        "content": "<p>Version 3.8.0 fixes the described Problem with codes in slices. Thanks.</p>",
        "id": 166340173,
        "sender_full_name": "Lars R端ckert",
        "timestamp": 1558598155
    }
]