[
    {
        "content": "<p>Hello, I am currently creating a communication resource which contains a immunization, relatedperson, patient and organization resource.</p>",
        "id": 153836793,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1467915212
    },
    {
        "content": "<p>Upon submit, the contained immunization resource vanishes, as does the contentReference from the communication resource</p>",
        "id": 153836794,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1467915242
    },
    {
        "content": "<p><a href=\"/user_uploads/10155/uVYMzxl76UrHY-o9M0xD162F/fhir.jpg\" target=\"_blank\" title=\"/user_uploads/10155/uVYMzxl76UrHY-o9M0xD162F/fhir.jpg\">fhir.jpg</a> </p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/uVYMzxl76UrHY-o9M0xD162F/fhir.jpg\" target=\"_blank\" title=\"/user_uploads/10155/uVYMzxl76UrHY-o9M0xD162F/fhir.jpg\"><img src=\"/user_uploads/10155/uVYMzxl76UrHY-o9M0xD162F/fhir.jpg\"></a></div>",
        "id": 153836795,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1467915323
    },
    {
        "content": "<p>Note the posted resource has 4 contained resources and 3 in payload, while the returned resource has 3 contained and 2 in payload</p>",
        "id": 153836796,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1467915366
    },
    {
        "content": "<p>I have posted the immunization resource separately on it's own successfully.</p>",
        "id": 153836797,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1467915382
    },
    {
        "content": "<p>One possible cause of this is that one of your contained resources isn't actually referred to by the containing resource (or by another contained resource). If a contained resource isn't actually addressable via the outer resource it isn't valid, so HAPI removes it.</p>",
        "id": 153836798,
        "sender_full_name": "James Agnew",
        "timestamp": 1467917852
    },
    {
        "content": "<p><code>var fhirObject = {\n        resource:\n              {\n          resourceType: \"Communication\",\n          contained: [\n            {\n              resourceType: \"Patient\",\n              id: \"Patient1\",\n              identifier: [\n                {\n                  use: \"official\",\n                  system: \"[id-system-global-base]/ca-on-patient-hcn\",\n                  value: \"unknown\" \n                }\n              ],\n              name: [\n                {\n                  use: \"official\",\n                  family: [\n                    clientInfo.lastName\n                  ],\n                  given: [\n                    clientInfo.firstName \n                  ]\n                }\n              ],\n              gender: clientInfo.gender,\n                birthDate: clientInfo.dateOfBirth,\n              address: [\n                {\n                  extension: [\n                    {\n                      url: \"http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-houseNumber\",\n                      valueString: clientInfo.addressStreetNumber\n                    },\n                    {\n                      url: \"http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-streetName\",\n                      valueString: clientInfo.addressStreetName\n                    },\n                    {\n                      url: \"http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-streetNameType\",\n                      valueString: \"unknown\"\n                    },\n                    {\n                      url: \"http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-direction\",\n                      valueString: \"unknown\" \n                    },\n                    {\n                      url: \"http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-unitID\",\n                      valueString: \"unknown\" \n                    }\n                  ],\n                  use: \"home\",\n                  line: [\n                    \"unknown\"\n                  ],\n                  city: clientInfo.addressCity, \n                  state:clientInfo.addressProvince,\n                  postalCode: \"unknown\" \n                }\n              ],\n              contact: [\n                {\n                  organization: {\n                    reference: \"#OrgSchool1\"\n                  }\n                }\n              ]\n            },\n            {\n              resourceType: \"RelatedPerson\",\n              id: \"RelatedPerson1\",\n              patient: {\n                reference: \"#Patient1\"\n              },\n              relationship: {\n                coding: [\n                  {\n                    system: \"http://hl7.org/fhir/patient-contact-relationship\",\n                    code: relationshipToClient\n                  }\n                ]\n              },\n              name: {\n                family: [\n                  lastName\n                ],\n                given: [\n                  firstName\n                ]\n              },\n              telecom: [\n                {\n                  system: \"phone\",\n                  value: phone1Number,\n                  use: phone1Type\n                }\n              ]\n            },\n            {\n              resourceType: \"Organization\",\n              id: \"OrgSchool1\",\n              identifier: [\n                {\n                  system: \"[id-system-local-base]/school-id\",\n                  value: \"unknown\"\n                }\n              ],\n              name: \"unknown\" \n            },\n            {\n              resourceType: \"Immunization\",\n              id: \"Immunization1\",\n              status: \"completed\",\n              date: \"2016-02-14T10:22:00-05:00\",\n              vaccineCode: {\n                coding: [\n                  {\n                    system: \"http://snomed.info/sct\",\n                    code: \"61153008\",\n                    display: \"MMR measles + mumps + rubella unspecified\"\n                  }\n                ],\n                text: \"MMR Priorix GSK\"\n              },\n              patient: {\n                reference: \"#Patient1\"\n              },\n              wasNotGiven: false,\n              reported: true,\n              note: {\n                text: \"Was given MMR vaccine in a walk-in clinic\"\n              }\n            }\n          ],\n          identifier: [\n            {\n              system: \"[id-system-local-base]/submission-id\",\n              value: \"1000212\"\n            }\n          ],\n          sender: {\n            reference: \"#RelatedPerson1\"\n          },\n          payload: [\n            {\n              contentAttachment: {\n                contentType: \"image/gif\",\n                data: \"â€¦\"\n              }\n            },\n            {\n              contentString: \"Scanned copy of MRM immunization receipt and Flu shot chart page\"\n            },\n            {\n              contentReference:  {\n                reference: \"#Immunization1\"\n              }\n            }\n          ],\n          status: \"completed\",\n          sent: \"\",\n          received: \"\",\n          subject: {\n            reference: \"#Patient1\"\n          }\n        }\n    };</code></p>",
        "id": 153836803,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1467920183
    },
    {
        "content": "<p>That will look way better if you make it a markdown snippet... put ``` at the very start and again at the very end</p>",
        "id": 153836804,
        "sender_full_name": "James Agnew",
        "timestamp": 1467920265
    },
    {
        "content": "<p>Sweet, way better. So which one is missing after you post and fetch it?</p>",
        "id": 153836805,
        "sender_full_name": "James Agnew",
        "timestamp": 1467920335
    },
    {
        "content": "<p>Thank you, I reviewed the object, it appears as though all of the contained resources are referenced. Immunization is missing.  Also, when I post, the contentReference: with \"#Immunization1\" also disappears.</p>",
        "id": 153836806,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1467920346
    },
    {
        "content": "<p><a href=\"http://fhirtest.uhn.ca/baseDstu3/Communication/111211/_history/1\" target=\"_blank\" title=\"http://fhirtest.uhn.ca/baseDstu3/Communication/111211/_history/1\">http://fhirtest.uhn.ca/baseDstu3/Communication/111211/_history/1</a></p>",
        "id": 153836807,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1467920363
    },
    {
        "content": "<p>Oh fascinating.</p>\n<p>I had a look, that's actually a bug in the RI Java STU3 structures... the <code>@Child</code> annotation is missing \"reference\" from the list of types it supports. Weird!</p>\n<div class=\"codehilite\"><pre>        @Child(name = &quot;content&quot;, type = {StringType.class, Attachment.class}, order=1, min=1, max=1, modifier=false, summary=true)\n        @Description(shortDefinition=&quot;Message part content&quot;, formalDefinition=&quot;A communicated content (or for multi-part communications, one portion of the communication).&quot; )\n        protected Type content;\n</pre></div>",
        "id": 153836810,
        "sender_full_name": "James Agnew",
        "timestamp": 1467921030
    },
    {
        "content": "<p>Will investigate a bit later, but presumably your code is correct and will work once I've fixed this bug.</p>",
        "id": 153836812,
        "sender_full_name": "James Agnew",
        "timestamp": 1467921065
    },
    {
        "content": "<p>Issue 399 here: <a href=\"https://github.com/jamesagnew/hapi-fhir/issues/399\" target=\"_blank\" title=\"https://github.com/jamesagnew/hapi-fhir/issues/399\">https://github.com/jamesagnew/hapi-fhir/issues/399</a></p>",
        "id": 153836814,
        "sender_full_name": "James Agnew",
        "timestamp": 1467921572
    },
    {
        "content": "<p>Thank you so much James! I appreciate it!</p>",
        "id": 153836949,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1467985704
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> I am having the same issue listed in this discussion with <a href=\"http://fhir3.healthintersections.com.au/open\" target=\"_blank\" title=\"http://fhir3.healthintersections.com.au/open\">http://fhir3.healthintersections.com.au/open</a></p>",
        "id": 153837680,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1468347891
    },
    {
        "content": "<p>I can post the immunization resource: </p>",
        "id": 153837681,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1468347900
    },
    {
        "content": "<p><code>var new_immunization = {\n    resource:\n    {\n        \"resourceType\": \"Immunization\",\n    //  \"id\": \"Immunization1\",\n        \"status\":\"completed\",\n        \"date\": \"2015-06-22\", \n            \"vaccineCode\": \n            {\"coding\":\n            [{\n                \"system\":\"http://snomed.info/sct\",\n                \"code\": \"7931000087106\", \n                \"display\": \"DTaP-IPV-Hib\"}],\n            \"text\":\"DTaP-IPV-Hib\"},\n            \"patient\": {\"reference\": \"http://fhirtest.uhn.ca/baseDstu3/Patient/21561/_history/1\"},\n            \"wasNotGiven\": false,\n            \"reported\": true\n    }\n}</code></p>",
        "id": 153837682,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1468347914
    },
    {
        "content": "<p>But when I try to post the same immunization contained in a communication resource, referenced by payload contentReference, the POST is unsuccessful</p>",
        "id": 153837683,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1468347991
    },
    {
        "content": "<p>Full object in earlier conversation.</p>",
        "id": 153837684,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1468348013
    },
    {
        "content": "<p>example immunization successful: <a href=\"http://fhir3.healthintersections.com.au/open/Immunization/_search?_id=1\" target=\"_blank\" title=\"http://fhir3.healthintersections.com.au/open/Immunization/_search?_id=1\">http://fhir3.healthintersections.com.au/open/Immunization/_search?_id=1</a></p>",
        "id": 153837685,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1468349150
    },
    {
        "content": "<p>example communication: <a href=\"http://fhir3.healthintersections.com.au/open/Communication/_search?_id=11\" target=\"_blank\" title=\"http://fhir3.healthintersections.com.au/open/Communication/_search?_id=11\">http://fhir3.healthintersections.com.au/open/Communication/_search?_id=11</a></p>",
        "id": 153837686,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1468349179
    },
    {
        "content": "<p>FYI <span class=\"user-mention\" data-user-id=\"191854\">@Tara Oskam</span> this issue should be fixed now if you want to try again..</p>",
        "id": 153837729,
        "sender_full_name": "James Agnew",
        "timestamp": 1468360517
    },
    {
        "content": "<p>and then try again on my server, because I really think that was a client issue not s erver issue (even though I'm usually wrong when I say that)</p>",
        "id": 153837731,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1468361009
    },
    {
        "content": "<p>That would be a heck of a coincidence if the same issue was also happening on your server, considering this was a very HAPI-specific bug :)</p>",
        "id": 153837734,
        "sender_full_name": "James Agnew",
        "timestamp": 1468361669
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 153837949,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1468414413
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 153837950,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1468414425
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 153837951,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1468414486
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 153837952,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1468414494
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 153837953,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1468414679
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 153837954,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1468415142
    },
    {
        "content": "<p><a href=\"/user_uploads/10155/XWPVb9sAtTRF1pn7iuCPipnb/pasted_image.png\" target=\"_blank\" title=\"/user_uploads/10155/XWPVb9sAtTRF1pn7iuCPipnb/pasted_image.png\">pasted image</a> </p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/XWPVb9sAtTRF1pn7iuCPipnb/pasted_image.png\" target=\"_blank\" title=\"/user_uploads/10155/XWPVb9sAtTRF1pn7iuCPipnb/pasted_image.png\"><img src=\"/user_uploads/10155/XWPVb9sAtTRF1pn7iuCPipnb/pasted_image.png\"></a></div>",
        "id": 153837956,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1468415361
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 153837958,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1468415414
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> <span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span> Ah, the issue was mine. I had contentReference: \"#Immunization1\", modifying this to contentReference: { reference: \"#Immunization1\"} resolved the issue</p>",
        "id": 153837961,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1468415910
    },
    {
        "content": "<p>thank you for looking into this issue for me</p>",
        "id": 153837962,
        "sender_full_name": "Tara Oskam",
        "timestamp": 1468415916
    },
    {
        "content": "<p>Hehe np! You uncovered a pretty nasty bug actually, so... thanks for that :)</p>",
        "id": 153837965,
        "sender_full_name": "James Agnew",
        "timestamp": 1468416446
    }
]