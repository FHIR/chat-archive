[
    {
        "content": "<p>The current HAPI test server (and HSPC R4 sandbox) will not load contained resources when they are referenced only via a canonical. The base resource is loaded successfully, but contained resources are ignored.  This should be acceptable, as described here: <a href=\"https://www.hl7.org/fhir/references.html#canonical-fragments\" target=\"_blank\" title=\"https://www.hl7.org/fhir/references.html#canonical-fragments\">https://www.hl7.org/fhir/references.html#canonical-fragments</a></p>",
        "id": 166326057,
        "sender_full_name": "Dave Carlson",
        "timestamp": 1558577029
    },
    {
        "content": "<p>I created a minimal sample resource to illustrate the problem:</p>",
        "id": 166326104,
        "sender_full_name": "Dave Carlson",
        "timestamp": 1558577069
    },
    {
        "content": "<p>{<br>\n  \"resourceType\": \"Questionnaire\",<br>\n  \"id\": \"questionnaire-test-frag\",<br>\n  \"url\": \"<a href=\"http://example.com/fhir/Questionnaire/test-1\" target=\"_blank\" title=\"http://example.com/fhir/Questionnaire/test-1\">http://example.com/fhir/Questionnaire/test-1</a>\",<br>\n  \"status\": \"draft\",<br>\n  \"item\": [<br>\n    {<br>\n      \"linkId\": \"q1\",<br>\n      \"type\": \"choice\",<br>\n      \"answerValueSet\": \"#options-1\"<br>\n    }<br>\n  ],<br>\n  \"contained\": [<br>\n    {<br>\n      \"resourceType\": \"ValueSet\",<br>\n      \"id\": \"options-1\",<br>\n      \"url\": \"<a href=\"http://example.com/fhir/ValueSet/options-1\" target=\"_blank\" title=\"http://example.com/fhir/ValueSet/options-1\">http://example.com/fhir/ValueSet/options-1</a>\",<br>\n      \"status\": \"draft\"<br>\n    }<br>\n  ]<br>\n}</p>",
        "id": 166326105,
        "sender_full_name": "Dave Carlson",
        "timestamp": 1558577071
    },
    {
        "content": "<p>If I replace the canonical URI with a Reference type, then the contained resource is included.  e.g.</p>",
        "id": 166326278,
        "sender_full_name": "Dave Carlson",
        "timestamp": 1558577358
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>  &quot;answerOption&quot;: [\n    {\n      &quot;valueReference&quot;: {\n        &quot;reference&quot;: &quot;#options-1&quot;\n      }\n    }\n  ]\n</pre></div>",
        "id": 166326279,
        "sender_full_name": "Dave Carlson",
        "timestamp": 1558577360
    },
    {
        "content": "<p>this validates ok in the latest validator - it's probably a versioning issue (and I have a vague memory of needing to fix an invariant related to this)</p>",
        "id": 166326442,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1558577642
    },
    {
        "content": "<p>Grahame, yes this resource loads in your test server, but fails in HAPI.</p>",
        "id": 166326491,
        "sender_full_name": "Dave Carlson",
        "timestamp": 1558577724
    },
    {
        "content": "<p>More precisely, this resource loads without error in HAPI, but omits the contained resource.</p>",
        "id": 166326565,
        "sender_full_name": "Dave Carlson",
        "timestamp": 1558577869
    },
    {
        "content": "<p>oh. not a validation issue at all then</p>",
        "id": 166326615,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1558577896
    },
    {
        "content": "<p>But the contained resource is retained if it has a Reference from primary resource. Seems like the invariant is considered with accepting contained resources, but incorrectly.</p>",
        "id": 166326704,
        "sender_full_name": "Dave Carlson",
        "timestamp": 1558578023
    },
    {
        "content": "<p>I expect it's an issue in <span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span>'s persistence code, not in the validator at the front</p>",
        "id": 166326723,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1558578117
    },
    {
        "content": "<p>its a known hapi issue: <a href=\"https://github.com/jamesagnew/hapi-fhir/issues/1184\" target=\"_blank\" title=\"https://github.com/jamesagnew/hapi-fhir/issues/1184\">https://github.com/jamesagnew/hapi-fhir/issues/1184</a></p>",
        "id": 166335913,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1558592578
    },
    {
        "content": "<p>it is on my todo list (as we need this for our questionnaire renderer) but i didn't had too much time for hapi contributions lately</p>",
        "id": 166335929,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1558592617
    },
    {
        "content": "<p>Thanks, Patrick.  For now I'll look for a workaround by stuffing the ValueSet references into some obscure Reference inside the Questionnaire so that contained resources are retained for my demo example work.</p>",
        "id": 166370255,
        "sender_full_name": "Dave Carlson",
        "timestamp": 1558624486
    },
    {
        "content": "<p>That's a good idea- FYI a dummy extension with a reference as the value would do the trick</p>",
        "id": 166384297,
        "sender_full_name": "James Agnew",
        "timestamp": 1558634379
    },
    {
        "content": "<p>Thanks, James.  That's exactly what I did earlier today and it worked perfectly.</p>",
        "id": 166413773,
        "sender_full_name": "Dave Carlson",
        "timestamp": 1558659042
    }
]