[
    {
        "content": "<p>Hi, May i know where can i get the Dockerfile for hapiproject/hapi:base?</p>",
        "id": 206687934,
        "sender_full_name": "Keerthivasan Ramanathan",
        "timestamp": 1597235875
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span> Can you help with this?</p>",
        "id": 206689999,
        "sender_full_name": "Keerthivasan Ramanathan",
        "timestamp": 1597237216
    },
    {
        "content": "<p><a href=\"https://github.com/hapifhir/hapi-fhir-jpaserver-starter/blob/master/Dockerfile\">https://github.com/hapifhir/hapi-fhir-jpaserver-starter/blob/master/Dockerfile</a></p>",
        "id": 206691454,
        "sender_full_name": "James Agnew",
        "timestamp": 1597238042
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span> I have this one. It pulls another image, the base : FROM hapiproject/hapi:base as build-hapi<br>\nDo we have access to that base image's docker file?</p>",
        "id": 206783471,
        "sender_full_name": "Keerthivasan Ramanathan",
        "timestamp": 1597298949
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191505\">@Sean McIlvenna</span> this is above my pay grade.. :) do you know?</p>",
        "id": 206815909,
        "sender_full_name": "James Agnew",
        "timestamp": 1597326193
    },
    {
        "content": "<p>yes, I do</p>",
        "id": 206826459,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1597331129
    },
    {
        "content": "<p>lemme dig it up</p>",
        "id": 206826470,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1597331135
    },
    {
        "content": "<p><a href=\"https://github.com/hapifhir/hapi-fhir-jpaserver-starter/blob/master/Dockerfile.base\">https://github.com/hapifhir/hapi-fhir-jpaserver-starter/blob/master/Dockerfile.base</a></p>",
        "id": 206826566,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1597331163
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"326090\">@Keerthivasan Ramanathan</span></p>",
        "id": 206826617,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1597331193
    },
    {
        "content": "<p>Wow.. thank you! <span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span></p>",
        "id": 206827170,
        "sender_full_name": "Keerthivasan Ramanathan",
        "timestamp": 1597331446
    },
    {
        "content": "<p>NP</p>",
        "id": 206829594,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1597332443
    },
    {
        "content": "<p>May I suggest that you convert those docker images into multistage build in a single Dockerfile ... <span class=\"user-mention\" data-user-id=\"191505\">@Sean McIlvenna</span> - the current design of having \":base\" separate makes it quite hard to bump the version of \":base\"</p>",
        "id": 206906864,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1597392031
    },
    {
        "content": "<p>eg. something like this:</p>\n<div class=\"codehilite\"><pre><span></span><code>FROM ubuntu as build-hapi\n\nENV PATH=&quot;/tmp/apache-maven-3.6.0/bin:${PATH}&quot;\n\nENV TZ=Etc/UTC\nRUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; echo $TZ &gt; /etc/timezone\n\nWORKDIR /tmp\nRUN apt-get update &amp;&amp; \\\n    apt-get install git -y &amp;&amp; \\\n    apt-get install sed -y &amp;&amp; \\\n    apt-get install wget -y &amp;&amp; \\\n    apt-get install openjdk-11-jdk -y\n\nRUN wget https://downloads.apache.org/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz &amp;&amp; tar xzf apache-maven-3.6.3-bin.tar.gz\nRUN export PATH=/tmp/apache-maven-3.6.3/bin:${PATH}\n\nWORKDIR /tmp/hapi-fhir-jpaserver-starter\n\nCOPY . .\n\nRUN /tmp/apache-maven-3.6.3/bin/mvn clean install -DskipTests\n\nFROM tomcat:9-jre11\n\nRUN mkdir -p /data/hapi/lucenefiles &amp;&amp; chmod 775 /data/hapi/lucenefiles\nCOPY --from=build-hapi /tmp/hapi-fhir-jpaserver-starter/target/*.war /usr/local/tomcat/webapps/\n\nEXPOSE 8080\n\nCMD [&quot;catalina.sh&quot;, &quot;run&quot;]\n</code></pre></div>",
        "id": 206915397,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1597400401
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191505\">@Sean McIlvenna</span> that simplifies the setup and keeps it in a single file</p>",
        "id": 206916082,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1597400974
    },
    {
        "content": "<p>Is there a way to separate download and compilation from creating docker images? In the end only the war files afe needed...</p>",
        "id": 206930778,
        "sender_full_name": "Frank Oemig",
        "timestamp": 1597412908
    },
    {
        "content": "<p>That is possible, yes</p>",
        "id": 206935115,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1597415522
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191427\">@Jens Villadsen</span> why do you need to bump the version of base? I use :base because those dependencies never really change, and it adds extra time to the build process for the hapi image.</p>",
        "id": 206939307,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1597417850
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191549\">@Frank Oemig</span> anyone can run <code>mvn install</code> at any time to compile it on their own, without using Docker...</p>",
        "id": 206939494,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1597417902
    },
    {
        "content": "<p>Yes, thx, I know, this is what I am doing and running. Just thinking about dockerization from that point onwards. Is a Dockerfile somewhere available?</p>",
        "id": 206939817,
        "sender_full_name": "Frank Oemig",
        "timestamp": 1597418070
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191505\">@Sean McIlvenna</span> Docker caches those layers - as you mention they rarely change. And if they actually do, you would have a problem as your version is called 'base', hence it is VERY hard to know whether your cache is stale or not. Combining it to a multistage build takes advantages of the docker caching layer at keeps the file to a single version</p>",
        "id": 206939845,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1597418093
    },
    {
        "content": "<p>docker's caching layer doesn't really apply in a CI build</p>",
        "id": 206939899,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1597418132
    },
    {
        "content": "<p>but, I don't have a strong preference either way</p>",
        "id": 206939933,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1597418154
    },
    {
        "content": "<p>docker caching does apply to CI</p>",
        "id": 206939989,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1597418167
    },
    {
        "content": "<p>so, I'll make the change you requested, and update each of the tagged versions</p>",
        "id": 206939996,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1597418170
    },
    {
        "content": "<p>that depends on your CI setup</p>",
        "id": 206940008,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1597418183
    },
    {
        "content": "<p>every docker CI I've seen <em>doesn't</em> use cache</p>",
        "id": 206940039,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1597418213
    },
    {
        "content": "<p>granted... that's not <em>many</em></p>",
        "id": 206940055,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1597418226
    },
    {
        "content": "<p>azure and docker hub</p>",
        "id": 206940074,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1597418234
    },
    {
        "content": "<p>they all spawn a fresh vm to build the images</p>",
        "id": 206940093,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1597418252
    },
    {
        "content": "<p>which don't have any caching history</p>",
        "id": 206940099,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1597418259
    },
    {
        "content": "<p>you can bootstrap your vm with a cache</p>",
        "id": 206940111,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1597418270
    },
    {
        "content": "<p>quick google search: <a href=\"https://dev.to/pst418/speed-up-multi-stage-docker-builds-in-ci-cd-with-buildkit-s-registry-cache-11gi\">https://dev.to/pst418/speed-up-multi-stage-docker-builds-in-ci-cd-with-buildkit-s-registry-cache-11gi</a></p>",
        "id": 206940427,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1597418437
    },
    {
        "content": "<p>but I'll look into it <span class=\"user-mention\" data-user-id=\"191505\">@Sean McIlvenna</span> and check with my CI goto-guys monday</p>",
        "id": 206940482,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1597418471
    },
    {
        "content": "<p>np. we <em>were</em> using the docker hub's CI, but I stopped <em>yesterday</em> because docker hub seems to freeze whenever building hapi</p>",
        "id": 206940881,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1597418677
    },
    {
        "content": "<p>so, I'm forced to use a manual process as of recent anyways</p>",
        "id": 206940890,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1597418685
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191427\">@Jens Villadsen</span> base image is removed and all tags in docker hub have been updated to use your suggested Dockerfile</p>",
        "id": 206960001,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1597428915
    },
    {
        "content": "<p>Fyi: the base image \"froze\" during build because the jdk requires a timezone set. Thats the reason for <a href=\"https://github.com/hapifhir/hapi-fhir-jpaserver-starter/blob/af6bd69db027c6632283d03947a1b3ac4eeac4d7/Dockerfile#L6\">https://github.com/hapifhir/hapi-fhir-jpaserver-starter/blob/af6bd69db027c6632283d03947a1b3ac4eeac4d7/Dockerfile#L6</a></p>",
        "id": 206964828,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1597431572
    },
    {
        "content": "<p>I'll re-enable the CI build in docker hub and see what happens</p>",
        "id": 206987511,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1597442940
    },
    {
        "content": "<p>hmmm, still seems to be freezing on docker hub builds</p>",
        "id": 206989211,
        "sender_full_name": "Sean McIlvenna",
        "timestamp": 1597444058
    },
    {
        "content": "<p>Where does it happen?</p>",
        "id": 207007408,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1597470938
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191549\">Frank Oemig</span> <a href=\"#narrow/stream/179167-hapi/topic/hapiproject.2Fhapi.3Abase.20Docker.20file/near/206930778\">said</a>:</p>\n<blockquote>\n<p>Is there a way to separate download and compilation from creating docker images? In the end only the war files afe needed...</p>\n</blockquote>\n<p>With <a href=\"https://github.com/hapifhir/hapi-fhir-jpaserver-starter/pull/124\">https://github.com/hapifhir/hapi-fhir-jpaserver-starter/pull/124</a> - the entire fetchning of maven dependencies is cached as long as you don't change the pom. Change the rest of the sources all you want and the build will still be way more speedy ;)</p>",
        "id": 207038971,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1597525001
    }
]