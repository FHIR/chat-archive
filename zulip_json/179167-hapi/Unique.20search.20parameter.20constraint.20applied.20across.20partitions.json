[
    {
        "content": "<h1>Background</h1>\n<p>I have created a search parameter on the patient resource to guarantee uniqueness on the patient identifier, thus preventing race conditions when bulk inserting resources. <a href=\"#narrow/stream/179167-hapi/topic/hapi.20fhir.20protect.20agains.20race.20conditions\">See original post here</a>.</p>\n<p>However, I noticed during testing that the uniqueness constraint is applied across all partitions (I have partitioning enabled on the server). Here are the<code>SearchParameters</code> I created:</p>\n<div class=\"codehilite\"><pre><span></span><code>{\n    &quot;resourceType&quot;: &quot;SearchParameter&quot;,\n    &quot;id&quot;: &quot;1&quot;,\n    &quot;title&quot;: &quot;Unique Identifier&quot;,\n    &quot;name&quot;: &quot;PatientUniqueIdentifier&quot;,\n    &quot;status&quot;: &quot;active&quot;,\n    &quot;code&quot;: &quot;uniquePatientIdentifier&quot;,\n    &quot;base&quot;: [\n        &quot;Patient&quot;\n    ],\n    &quot;type&quot;: &quot;token&quot;,\n    &quot;expression&quot;: &quot;Patient.identifier.where(system=&#39;external-patient&#39;)&quot;\n}\n</code></pre></div>\n<div class=\"codehilite\"><pre><span></span><code>{\n    &quot;resourceType&quot;: &quot;SearchParameter&quot;,\n    &quot;id&quot;: &quot;2&quot;,\n    &quot;extension&quot;: [\n        {\n            &quot;url&quot;: &quot;http://hapifhir.io/fhir/StructureDefinition/sp-unique&quot;,\n            &quot;valueBoolean&quot;: true\n        }\n    ],\n    &quot;status&quot;: &quot;active&quot;,\n    &quot;code&quot;: &quot;patient-identifier&quot;,\n    &quot;base&quot;: [\n        &quot;Patient&quot;\n    ],\n    &quot;type&quot;: &quot;composite&quot;,\n    &quot;expression&quot;: &quot;Patient&quot;,\n    &quot;component&quot;: [\n        {\n            &quot;definition&quot;: &quot;SearchParameter/1&quot;,\n            &quot;expression&quot;: &quot;Patient&quot;\n        }\n    ]\n}\n</code></pre></div>\n<h1>Expected behavior</h1>\n<p>I should only be able to create one patient with identifier 123 in PARTITION-1, but I can also create a patient with the same identifier in PARTITION-2.</p>\n<h1>Actual outcome</h1>\n<p>When I create a patient with identifier 123 in PARTITION-1, it works. But when I try to create a patient with the same identifier in PARTITION-2, I got an error saying <code>The operation has failed with a unique index constraint failure.</code>. This is not the expected behavior because it may very well be likely that patients in different partitions have the same identifiers.</p>\n<h1>Investigation</h1>\n<p>After going through the source code, I believe the issue is <a href=\"https://github.com/hapifhir/hapi-fhir/blob/b934abb297a3d1cb7a981312fc59846762ea8e88/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/index/SearchParamWithInlineReferencesExtractor.java#L324\">here</a>: when querying for existing indexed unique composite strings, it does not take the partition id into account, even though <code>partition_id</code> is a column in the <code>hfj_idx_cmp_string_uniq</code> table. </p>\n<p>My questions are:</p>\n<ol>\n<li>Is this the intended behavior (that the uniqueness constraint should apply across partitions) or is it a bug?</li>\n<li>How can I get around this issue?</li>\n</ol>",
        "id": 245783105,
        "sender_full_name": "Pengyu Wang",
        "timestamp": 1626156916
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span> do you know if the above is intended behavior? We are considering putting up a pull request to change unique params to respect partition.</p>",
        "id": 246660865,
        "sender_full_name": "Aaron Kawalsky",
        "timestamp": 1626821916
    }
]