[
    {
        "content": "<p>I am trying to implement validation of STU3 resources with custom profiles and values sets using HAPI 4.1, following the description in section 8.2.5 of the <a href=\"https://hapifhir.io/hapi-fhir/docs/validation/profile_validator.html\" target=\"_blank\" title=\"https://hapifhir.io/hapi-fhir/docs/validation/profile_validator.html\">HAPI documentation of profile validation</a>. I register my profile and the custom ValueSet it uses as described there, but when I run it against a valid example, it claims that the code is not in the valueset.</p>\n<p>Debugging through, I see that valueset does get loaded and the custom validation support added to the support chain. But it seems the valueset is never fetched in <a href=\"https://github.com/jamesagnew/hapi-fhir/blob/aa0301084bae8d1640e84e9b4b471f03163c2cf5/hapi-fhir-validation/src/main/java/org/hl7/fhir/dstu3/hapi/validation/ValidationSupportChain.java#L153\" target=\"_blank\" title=\"https://github.com/jamesagnew/hapi-fhir/blob/aa0301084bae8d1640e84e9b4b471f03163c2cf5/hapi-fhir-validation/src/main/java/org/hl7/fhir/dstu3/hapi/validation/ValidationSupportChain.java#L153\"><code>ValidationSupportChain.validateCode()</code></a>. For the <code>PrePopulatedValidationSupport</code>, <a href=\"https://github.com/jamesagnew/hapi-fhir/blob/12a74e6cbc2f899aa341adc569e5b60221134ca6/hapi-fhir-validation/src/main/java/org/hl7/fhir/dstu3/hapi/validation/PrePopulatedValidationSupport.java#L180\" target=\"_blank\" title=\"https://github.com/jamesagnew/hapi-fhir/blob/12a74e6cbc2f899aa341adc569e5b60221134ca6/hapi-fhir-validation/src/main/java/org/hl7/fhir/dstu3/hapi/validation/PrePopulatedValidationSupport.java#L180\"><code>isCodeSystemSupported()</code> always returns <code>false</code></a>. Hence, the PrePopulation validation support is not applied for the code check and the result is that the validator gives an error stating that the the passed code is not in the required value-set (which it <em>does</em> identify correctly). Is there are issue here or am I missing something?</p>\n<p>For reference, the value set in question is a restricted subset of the MIME-types, defining the codes via <code>ValueSet.compose</code>. It works fine when checked by the command-line Java validator.</p>",
        "id": 188146924,
        "sender_full_name": "Morten Ernebjerg",
        "timestamp": 1581625585
    },
    {
        "content": "<p>Have you also added the underlying CodeSystem(s) the ValueSet uses?</p>",
        "id": 188162047,
        "sender_full_name": "Michael Lawley",
        "timestamp": 1581635046
    },
    {
        "content": "<p>MIME is one of those \"special\" code systems that are infinite and defined by a grammar.  These usually have some kind of special-case support inside terminology servers, but this may not be correctly exposed in all code-paths.  A common work-around is to added an explicit CodeSystem resource that includes as many as possible of the known-to-be-used codes</p>",
        "id": 188162191,
        "sender_full_name": "Michael Lawley",
        "timestamp": 1581635184
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"191343\">@Michael Lawley</span> , good point! I tried it out, but although that also works fine with the command-line validator, I still get the same error from HAPI.</p>",
        "id": 188190884,
        "sender_full_name": "Morten Ernebjerg",
        "timestamp": 1581672813
    },
    {
        "content": "<p>It's not quite clear to me how validation against a valueset registered in a <code>PrePopulatedValidationSupport</code> instance works, given that that the latter always denies supporting the system, causing <code>ValidationSupportChain.validateCode()</code> to skip it. It also tried registering the PrePopulated validation support with the validation chain before the default one, but that caused an additional error of the same type for a code field with a required binding in the base resource definition (i.e. on the default validation support).</p>",
        "id": 188191757,
        "sender_full_name": "Morten Ernebjerg",
        "timestamp": 1581673720
    },
    {
        "content": "<p>Further context: The custom value-set is for a required binding on the code field <code>DocumentReference.content.attachment.contentType</code>. With the validation supports swapped in the chain, I also get an error on <code>DocumentReference.status</code>: <em>The value provided ('current') is not in the value set <a href=\"http://hl7.org/fhir/ValueSet/document-reference-status\" target=\"_blank\" title=\"http://hl7.org/fhir/ValueSet/document-reference-status\">http://hl7.org/fhir/ValueSet/document-reference-status</a> (<a href=\"http://hl7.org/fhir/ValueSet/document-reference-status\" target=\"_blank\" title=\"http://hl7.org/fhir/ValueSet/document-reference-status\">http://hl7.org/fhir/ValueSet/document-reference-status</a>, and a code is required from this value set) (error message = Unknown code[current] in system[(none)])</em>.</p>",
        "id": 188192082,
        "sender_full_name": "Morten Ernebjerg",
        "timestamp": 1581674050
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span>, might you have any pointers on this? (sorry to put this right on your desk...) I see the same problems with HAPI 4.2 (including the error for the standard docref status code) although I am doing essentially exactly what is done in the example in <a href=\"https://hapifhir.io/hapi-fhir/docs/validation/profile_validator.html\" target=\"_blank\" title=\"https://hapifhir.io/hapi-fhir/docs/validation/profile_validator.html\">section 8.2.5 of the HAPI docs</a> (cf. the above).  It is independent of whether I use a custom CodeSystem or just use the standard (<code>urn:ietf:bcp:13</code>) for the MIME-type CodeSystem.</p>",
        "id": 188440918,
        "sender_full_name": "Morten Ernebjerg",
        "timestamp": 1582023276
    }
]