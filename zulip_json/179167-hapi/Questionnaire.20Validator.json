[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191478\">@Oliver Egger</span> I believe that you wrote the enableWhen part of the InstanceValidator, which I'm currently fixing to cope with getting the answer from the right context (see <a href=\"#narrow/stream/179255-questionnaire/topic/enable-when\" title=\"#narrow/stream/179255-questionnaire/topic/enable-when\">https://chat.fhir.org/#narrow/stream/179255-questionnaire/topic/enable-when</a>). I don't understand why there's a DefaultEnableWhenEvaluator. Under what circumstances would it be useful or necessary (or even valid) to replace that implementation? I'm planning to inline it into the validator...</p>\n<p>(<span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> <span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span> )</p>",
        "id": 170766214,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1562978849
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> , I'm not aware of any work done by me with enableWhen in the InstanceValidator, so I'm not much help here, please apologize</p>",
        "id": 170776117,
        "sender_full_name": "Oliver Egger",
        "timestamp": 1562997893
    },
    {
        "content": "<p>ok I apologise. I don't know why I had it my head that you wrote that code</p>",
        "id": 170782649,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1563009895
    },
    {
        "content": "<p>Only thing I can think is that it was added to deal with the extension.  In theory,additional extensions could be added in the future</p>",
        "id": 170809326,
        "sender_full_name": "Lloyd McKenzie",
        "timestamp": 1563060452
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191316\">@Grahame Grieve</span> - The EnableWhen logic was written by <span class=\"user-mention\" data-user-id=\"197084\">@Matti Uusitalo</span> (cc <span class=\"user-mention\" data-user-id=\"192813\">@Eeva Turkka</span> ) I believe</p>",
        "id": 170859099,
        "sender_full_name": "James Agnew",
        "timestamp": 1563157118
    },
    {
        "content": "<p>We added the extension point to allow some custom enable when rules based on extensions in Finnish profiles. So it is necessary for us to replace that default implementation for our system, but we did implement the logic to the default implementation in addition to that in case someone else would need it.</p>\n<p>(<span class=\"user-mention\" data-user-id=\"194844\">@Okko Kauhanen</span> was also involved)</p>",
        "id": 170866184,
        "sender_full_name": "Eeva Turkka",
        "timestamp": 1563169938
    },
    {
        "content": "<p>so I don't follow.... you have modifier extensions?</p>",
        "id": 170885081,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1563191204
    },
    {
        "content": "<p>We have modifier extension for evaluating enablewhen-condition in a questionnaire, yes. The condition used is fhirpath-expression and we are currently using STU3 in the system. The questionnaires are here: <a href=\"https://simplifier.net/finnishphr/~resources?category=Example&amp;exampletype=Questionnaire\" target=\"_blank\" title=\"https://simplifier.net/finnishphr/~resources?category=Example&amp;exampletype=Questionnaire\">https://simplifier.net/finnishphr/~resources?category=Example&amp;exampletype=Questionnaire</a></p>",
        "id": 170886108,
        "sender_full_name": "Eeva Turkka",
        "timestamp": 1563192197
    },
    {
        "content": "<p>ok so I see the extension, but it doesn't make a difference to the way that enableWhen works or is evaluated - it's a parallel thing?</p>",
        "id": 170890202,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1563195868
    },
    {
        "content": "<p>We treat it like \"if there's this modifier extension, the fhirpath-condition in the extension of the question resolves the enablewhen to either true or false\" and if there isn't that extension, we call the default \"super\" implementation that we expect to work as fhir says.  It doesn't change the basic logic of enableWhen like \"should there be an answer to this question or is an answer allowed here\". Some of the questionnaires will have \"normal\" enable whens that don't have the modifier extension logic.</p>",
        "id": 170891050,
        "sender_full_name": "Eeva Turkka",
        "timestamp": 1563196471
    },
    {
        "content": "<p>hmm. so the extensibility wasn't really right. I'll add an extension point for controlling this</p>",
        "id": 170893975,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1563198369
    },
    {
        "content": "<p>Is there a new implementation for this extension point? We noticed while migrating HAPI from 3.8.0 to 4.0.0 that the EnableWhenEvaluatorSupplier has been removed from the FhirInstanceValidator.</p>",
        "id": 176911950,
        "sender_full_name": "Juuso Oksanen",
        "timestamp": 1569831527
    },
    {
        "content": "<p>I removed it since it was broken (the design was broken). And we couldn't figure out why it should be extensible</p>",
        "id": 176920818,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1569840397
    },
    {
        "content": "<p>Is there a way we could implement support for the modifier extension of the enableWhen behaviour that wouldn't be broken by design?</p>",
        "id": 176921286,
        "sender_full_name": "Eeva Turkka",
        "timestamp": 1569840846
    },
    {
        "content": "<p>what modifier extension</p>",
        "id": 176922150,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1569841733
    },
    {
        "content": "<p>The one mentioned earlier in this thread: <a href=\"https://simplifier.net/finnishphr/fiphr-ext-questionnaire-enablewhenenablewhen\" target=\"_blank\" title=\"https://simplifier.net/finnishphr/fiphr-ext-questionnaire-enablewhenenablewhen\">https://simplifier.net/finnishphr/fiphr-ext-questionnaire-enablewhenenablewhen</a> <br>\nSome questionnaires have a fhirpath condition on some questions instead of the standard enable when (and we are still using STU3, but I believe it will be the same in R4).</p>",
        "id": 176925530,
        "sender_full_name": "Eeva Turkka",
        "timestamp": 1569845203
    },
    {
        "content": "<p>FHIRPath-based item visibility logic is vital for our project. We have already built our implementation around it.</p>\n<p>The standard enableWhen structure cannot express complex criteria. Extending the enableWhen-structure does not help either, so a parallel implementation is needed.</p>\n<p>If this is a bad design choice, how should we proceed?</p>\n<p>A similar official extension has been in development, but for some reason, it did not get included in R4:</p>\n<p><a href=\"http://hl7.org/fhir/2018Sep/extension-questionnaire-enablewhen.html\" target=\"_blank\" title=\"http://hl7.org/fhir/2018Sep/extension-questionnaire-enablewhen.html\">http://hl7.org/fhir/2018Sep/extension-questionnaire-enablewhen.html</a><br>\n\"This is only permitted when the containing item does NOT have any enableWhen elements.\"<br>\n\"Context of Use: Use on Element ID Questionnaire.item or Element ID Questionnaire.item.item\"</p>",
        "id": 177132374,
        "sender_full_name": "Okko Kauhanen",
        "timestamp": 1570006461
    },
    {
        "content": "<p>ok, getting to this.... the extension should not be a modifier extension</p>",
        "id": 179013214,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1571964833
    },
    {
        "content": "<p>does this capture the correct meaning of the extension?</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"cp\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>\n<span class=\"nt\">&lt;Questionnaire</span> <span class=\"na\">xmlns=</span><span class=\"s\">&quot;http://hl7.org/fhir&quot;</span><span class=\"nt\">&gt;</span>\n  <span class=\"nt\">&lt;id</span> <span class=\"na\">value=</span><span class=\"s\">&quot;questionnaire-enableWhen-test&quot;</span> <span class=\"nt\">/&gt;</span>\n  <span class=\"nt\">&lt;language</span> <span class=\"na\">value=</span><span class=\"s\">&quot;en-US&quot;</span> <span class=\"nt\">/&gt;</span>\n  <span class=\"nt\">&lt;text&gt;</span>\n    <span class=\"nt\">&lt;status</span> <span class=\"na\">value=</span><span class=\"s\">&quot;generated&quot;</span> <span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;div</span> <span class=\"na\">xmlns=</span><span class=\"s\">&quot;http://www.w3.org/1999/xhtml&quot;</span> <span class=\"na\">lang=</span><span class=\"s\">&quot;en-US&quot;</span><span class=\"nt\">&gt;</span>\n      <span class=\"nt\">&lt;p&gt;</span>enableWhen test<span class=\"nt\">&lt;/p&gt;</span>\n    <span class=\"nt\">&lt;/div&gt;</span>\n  <span class=\"nt\">&lt;/text&gt;</span>\n  <span class=\"nt\">&lt;url</span> <span class=\"na\">value=</span><span class=\"s\">&quot;http://hl7.org/fhir/us/hai/Questionnaire/questionnaire-enableWhen-test&quot;</span> <span class=\"nt\">/&gt;</span>\n  <span class=\"nt\">&lt;status</span> <span class=\"na\">value=</span><span class=\"s\">&quot;draft&quot;</span> <span class=\"nt\">/&gt;</span>\n  <span class=\"nt\">&lt;item&gt;</span>\n    <span class=\"nt\">&lt;linkId</span> <span class=\"na\">value=</span><span class=\"s\">&quot;condition&quot;</span> <span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;text</span> <span class=\"na\">value=</span><span class=\"s\">&quot;condition&quot;</span> <span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;type</span> <span class=\"na\">value=</span><span class=\"s\">&quot;boolean&quot;</span> <span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;required</span> <span class=\"na\">value=</span><span class=\"s\">&quot;true&quot;</span> <span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;repeats</span> <span class=\"na\">value=</span><span class=\"s\">&quot;false&quot;</span> <span class=\"nt\">/&gt;</span>\n  <span class=\"nt\">&lt;/item&gt;</span>\n  <span class=\"nt\">&lt;item&gt;</span>\n    <span class=\"nt\">&lt;extension</span> <span class=\"na\">url=</span><span class=\"s\">&quot;http://phr.kanta.fi/StructureDefinition/fiphr-ext-questionnaire-enablewhen&quot;</span><span class=\"nt\">&gt;</span>\n      <span class=\"nt\">&lt;valueString</span> <span class=\"na\">value=</span><span class=\"s\">&quot;QuestionnaireResponse.descendants().select(item).where(linkId=&#39;condition&#39;).answer.value.ofType(&#39;boolean&#39;)&quot;</span> <span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;/extension&gt;</span>\n    <span class=\"nt\">&lt;linkId</span> <span class=\"na\">value=</span><span class=\"s\">&quot;enable-when&quot;</span> <span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;text</span> <span class=\"na\">value=</span><span class=\"s\">&quot;enable when condition true&quot;</span> <span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;type</span> <span class=\"na\">value=</span><span class=\"s\">&quot;boolean&quot;</span> <span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;required</span> <span class=\"na\">value=</span><span class=\"s\">&quot;true&quot;</span> <span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;repeats</span> <span class=\"na\">value=</span><span class=\"s\">&quot;false&quot;</span> <span class=\"nt\">/&gt;</span>\n  <span class=\"nt\">&lt;/item&gt;</span>\n<span class=\"nt\">&lt;/Questionnaire&gt;</span>\n</pre></div>",
        "id": 179013327,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1571964964
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"194844\">@Okko Kauhanen</span> what did you about passing in the current context to the FHIRPath expression when you are evaluating it?</p>",
        "id": 179013828,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1571965600
    },
    {
        "content": "<p>see discussion here: <a href=\"#narrow/stream/179255-questionnaire/topic/SDC.20EnableWhen.20extension\" title=\"#narrow/stream/179255-questionnaire/topic/SDC.20EnableWhen.20extension\">https://chat.fhir.org/#narrow/stream/179255-questionnaire/topic/SDC.20EnableWhen.20extension</a></p>",
        "id": 179015047,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1571967358
    }
]