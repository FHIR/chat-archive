[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span> I just added a JUnit test case that has a dependency on the NarrativeGenerator, which executes the following line of code:</p>\n<div class=\"codehilite\"><pre><span></span>   <span class=\"n\">Set</span><span class=\"o\">&lt;</span><span class=\"n\">Extension</span><span class=\"o\">&gt;</span> <span class=\"n\">extensions</span> <span class=\"o\">=</span> <span class=\"n\">Collections</span><span class=\"o\">.</span><span class=\"na\">singleton</span><span class=\"o\">(</span><span class=\"n\">TablesExtension</span><span class=\"o\">.</span><span class=\"na\">create</span><span class=\"o\">());</span>\n</pre></div>\n\n\n<p>TablesExtension is org.commonmark.ext.gfm.tables.TablesExtension which would appear to be covered by this import in the POM:</p>\n<div class=\"codehilite\"><pre><span></span>            <span class=\"nt\">&lt;dependency&gt;</span>\n                <span class=\"nt\">&lt;groupId&gt;</span>com.atlassian.commonmark<span class=\"nt\">&lt;/groupId&gt;</span>\n                <span class=\"nt\">&lt;artifactId&gt;</span>commonmark<span class=\"nt\">&lt;/artifactId&gt;</span>\n                <span class=\"nt\">&lt;version&gt;</span>0.12.1<span class=\"nt\">&lt;/version&gt;</span>\n            <span class=\"nt\">&lt;/dependency&gt;</span>\n            <span class=\"nt\">&lt;dependency&gt;</span>\n                <span class=\"nt\">&lt;groupId&gt;</span>com.atlassian.commonmark<span class=\"nt\">&lt;/groupId&gt;</span>\n                <span class=\"nt\">&lt;artifactId&gt;</span>commonmark-ext-gfm-tables<span class=\"nt\">&lt;/artifactId&gt;</span>\n                <span class=\"nt\">&lt;version&gt;</span>0.12.1<span class=\"nt\">&lt;/version&gt;</span>\n            <span class=\"nt\">&lt;/dependency&gt;</span>\n</pre></div>",
        "id": 183139111,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1576055774
    },
    {
        "content": "<p>but... when I run it, I get:</p>",
        "id": 183139121,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1576055797
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>java.lang.NoClassDefFoundError: org/commonmark/ext/gfm/tables/TablesExtension\n    at org.hl7.fhir.utilities.MarkDownProcessor.processCommonMark(MarkDownProcessor.java:57)\n</pre></div>",
        "id": 183139136,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1576055825
    },
    {
        "content": "<p>I don't understand this?</p>",
        "id": 183139142,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1576055839
    },
    {
        "content": "<p>no:</p>\n<p>java.lang.NoClassDefFoundError: org/commonmark/parser/Parser<br>\n    at org.hl7.fhir.utilities.MarkDownProcessor.processCommonMark(MarkDownProcessor.java:58)</p>",
        "id": 183139375,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1576056058
    },
    {
        "content": "<p>none of the commonmark code is available, but I don't know why</p>",
        "id": 183139575,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1576056302
    },
    {
        "content": "<p>Are you getting this in Maven build or Eclipse?</p>",
        "id": 183263147,
        "sender_full_name": "James Agnew",
        "timestamp": 1576160482
    },
    {
        "content": "<p>i got the same error yesterday, but its gone in the current ci version (which has other problems)</p>",
        "id": 183265529,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1576162109
    },
    {
        "content": "<p>I just checked the pom, the dependencies are entered with the optional flag set to true. So (if i remember correctly) if the utilities module is used in the R5 module the dependency to commonmark has to be stated explicitly again.<br>\nOr remove the optional in the utilities pom</p>",
        "id": 183266400,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1576162693
    },
    {
        "content": "<p>I don't think this should be made a non-optional dependency though. That would mean that anyone using hapi for any purpose will get commonmark imported into their project (specifically I know this will break android)</p>\n<p>It'd be better for it to be added as a dependency with <code>&lt;scope&gt;test&lt;/scope&gt;</code> on the project that has the tests</p>",
        "id": 183268523,
        "sender_full_name": "James Agnew",
        "timestamp": 1576163970
    },
    {
        "content": "<p>yes sounds great.</p>",
        "id": 183268689,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1576164064
    },
    {
        "content": "<p>umm how is it optional?</p>",
        "id": 183290144,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1576177293
    },
    {
        "content": "<p>that's this line (which should be there): <a href=\"https://github.com/hapifhir/org.hl7.fhir.core/blob/master/org.hl7.fhir.utilities/pom.xml#L33\" target=\"_blank\" title=\"https://github.com/hapifhir/org.hl7.fhir.core/blob/master/org.hl7.fhir.utilities/pom.xml#L33\">https://github.com/hapifhir/org.hl7.fhir.core/blob/master/org.hl7.fhir.utilities/pom.xml#L33</a></p>",
        "id": 183290445,
        "sender_full_name": "James Agnew",
        "timestamp": 1576177456
    },
    {
        "content": "<p>solution is to copy these two new dependencies to the pom for the project where the tests are, but replace <code>&lt;optional&gt;true&lt;/optional&gt;</code> with <code>&lt;scope&gt;test&lt;/scope&gt;</code></p>",
        "id": 183290506,
        "sender_full_name": "James Agnew",
        "timestamp": 1576177498
    },
    {
        "content": "<p>which test is causing the NoClassDefError?</p>",
        "id": 183290571,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1576177550
    },
    {
        "content": "<p>the NarrativeGenerationTests clas ins R5, if you add a description to one of the classes in test-cases/R5/narrative</p>",
        "id": 183291753,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1576178265
    },
    {
        "content": "<p>.. but... Android doesn't support commonmark? wtf?</p>",
        "id": 183291877,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1576178327
    },
    {
        "content": "<blockquote>\n<p>the NarrativeGenerationTests clas ins R5, if you add a description to one of the classes in test-cases/R5/narrative</p>\n</blockquote>\n<p>i added the dependencies test-scoped to the module:<br>\n<a href=\"https://github.com/hapifhir/org.hl7.fhir.core/tree/commonmark_dependency\" target=\"_blank\" title=\"https://github.com/hapifhir/org.hl7.fhir.core/tree/commonmark_dependency\">https://github.com/hapifhir/org.hl7.fhir.core/tree/commonmark_dependency</a><br>\nIs it working now?</p>",
        "id": 183293676,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1576179537
    },
    {
        "content": "<p>yes thanks</p>",
        "id": 183293909,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1576179691
    },
    {
        "content": "<blockquote>\n<p>.. but... Android doesn't support commonmark? wtf?</p>\n</blockquote>\n<p>according to this: <a href=\"https://github.com/atlassian/commonmark-java\" target=\"_blank\" title=\"https://github.com/atlassian/commonmark-java\">https://github.com/atlassian/commonmark-java</a> it should work. Since Api Level 24 the Java8 support is quite good</p>",
        "id": 183294261,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1576179943
    },
    {
        "content": "<p>and glad that it works now, added a PR. I am now wondering if this really should be an optional dependency. As i understand the cause of the Exception, this would happen to any implementer using the parser from fhir.core on a R5 resource with a description element, right?</p>",
        "id": 183295381,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1576180617
    },
    {
        "content": "<p>also the validator would fail on any r5 resources with a description. Could have different build profiles: one for r5, one for r4 and below.</p>",
        "id": 183295844,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1576180807
    },
    {
        "content": "<p>no it's only when you try to process the markdown for display. We  don't do that at parse time. The NarrativeGenerator does</p>",
        "id": 183296089,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1576180930
    },
    {
        "content": "<p>ahh.</p>",
        "id": 183296370,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1576181120
    },
    {
        "content": "<p>ok, forget everything i said then <span aria-label=\"dizzy\" class=\"emoji emoji-1f635\" role=\"img\" title=\"dizzy\">:dizzy:</span></p>",
        "id": 183296439,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1576181143
    },
    {
        "content": "<p>Thought commonmark was used to check if description contains valid markdown</p>",
        "id": 183297068,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1576181534
    },
    {
        "content": "<p>there's no such thing as invalid markdown</p>",
        "id": 183299287,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1576183016
    },
    {
        "content": "<p>so I went to do the release, and:</p>\n<div class=\"codehilite\"><pre><span></span>[ERROR] [ERROR] Some problems were encountered while processing the POMs:\n[ERROR] &#39;dependencies.dependency.optional&#39; for com.atlassian.commonmark:commonmark:jar must be &#39;true&#39; or &#39;false&#39; but is &#39;test&#39;. @ ca.uhn.hapi.fhir:org.hl7.fhir.r5:[unknown-version], C:\\work\\org.hl7.fhir\\org.hl7.fhir.core\\org.hl7.fhir.r5\\pom.xml, line 114, column 19\n[ERROR] &#39;dependencies.dependency.optional&#39; for com.atlassian.commonmark:commonmark-ext-gfm-tables:jar must be &#39;true&#39; or &#39;false&#39; but is &#39;test&#39;. @ ca.uhn.hapi.fhir:org.hl7.fhir.r5:[unknown-version], C:\\work\\org.hl7.fhir\\org.hl7.fhir.core\\org.hl7.fhir.r5\\pom.xml, line 119, column 19\n @\n[ERROR] The build could not read 1 project -&gt; [Help 1]\n[ERROR]\n[ERROR]   The project ca.uhn.hapi.fhir:org.hl7.fhir.r5:4.1.23-SNAPSHOT (C:\\work\\org.hl7.fhir\\org.hl7.fhir.core\\org.hl7.fhir.r5\\pom.xml) has 2 errors\n[ERROR]     &#39;dependencies.dependency.optional&#39; for com.atlassian.commonmark:commonmark:jar must be &#39;true&#39; or &#39;false&#39; but is &#39;test&#39;. @ ca.uhn.hapi.fhir:org.hl7.fhir.r5:[unknown-version], C:\\work\\org.hl7.fhir\\org.hl7.fhir.core\\org.hl7.fhir.r5\\pom.xml, line 114, column 19\n[ERROR]     &#39;dependencies.dependency.optional&#39; for com.atlassian.commonmark:commonmark-ext-gfm-tables:jar must be &#39;true&#39; or &#39;false&#39; but is &#39;test&#39;. @ ca.uhn.hapi.fhir:org.hl7.fhir.r5:[unknown-version], C:\\work\\org.hl7.fhir\\org.hl7.fhir.core\\org.hl7.fhir.r5\\pom.xml, line 119, column 19\n</pre></div>",
        "id": 183309970,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1576190004
    },
    {
        "content": "<p>sorry, messed up the copy &amp; pasting. Just pushed a fix in the branch</p>",
        "id": 183311281,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1576190969
    },
    {
        "content": "<p>ah you didn't merge my PR, sec.</p>",
        "id": 183311849,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1576191400
    },
    {
        "content": "<p>I can merge your PR. But I had actually copied what you did before you did the PR</p>",
        "id": 183312022,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1576191563
    },
    {
        "content": "<p>i merged a fix in the master, the mistake was that  it has to be <code>&lt;scope&gt;test</code>and it was <code>&lt;optional&gt;test</code></p>",
        "id": 183312138,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1576191661
    },
    {
        "content": "<p>thanks</p>",
        "id": 183312426,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1576191883
    }
]