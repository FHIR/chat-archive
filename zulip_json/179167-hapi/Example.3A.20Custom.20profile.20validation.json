[
    {
        "content": "<p>Hi all,</p>\n<p>could anyone be so nice to provide me with (or point me towards) an example of how to implement IValidationSupport when<br>\n- Structure definitions, code systems and value sets are stored locally on the file system<br>\n- Structure definitions are available as differentials only.</p>\n<p>I do not have a FHIRStore, I only want to generate FHIR resources via Hapi and then validate them against custom profiles.</p>\n<p>My main problem lies in the method \"generateSnapshot\" and how it relates to the other methods.</p>\n<p>I have managed to get the validator working on snapshots (provided via the file system), but now I have the requirement to supply differentials only (which means - afaik - that I have to implement the generateSnapshot method).</p>\n<p>I'm working with the following dependencies:</p>\n<div class=\"codehilite\"><pre><span></span>    &lt;dependency&gt;\n        &lt;groupId&gt;ca.uhn.hapi.fhir&lt;/groupId&gt;\n        &lt;artifactId&gt;hapi-fhir-structures-r4&lt;/artifactId&gt;\n        &lt;version&gt;4.0.0&lt;/version&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;ca.uhn.hapi.fhir&lt;/groupId&gt;\n        &lt;artifactId&gt;hapi-fhir-validation&lt;/artifactId&gt;\n        &lt;version&gt;4.0.0&lt;/version&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;ca.uhn.hapi.fhir&lt;/groupId&gt;\n        &lt;artifactId&gt;hapi-fhir-validation-resources-r4&lt;/artifactId&gt;\n        &lt;version&gt;4.0.0&lt;/version&gt;\n    &lt;/dependency&gt;\n</pre></div>\n\n\n<p>Thanks in advance, <br>\nJohanna</p>",
        "id": 176072065,
        "sender_full_name": "Johanna Eicher",
        "timestamp": 1568873964
    },
    {
        "content": "<p>if you are using HAPI, then you can use ProfileUtilities to do this</p>",
        "id": 176081249,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1568884388
    },
    {
        "content": "<blockquote>\n<p>if you are using HAPI, then you can use ProfileUtilities to do this</p>\n</blockquote>\n<p>Yes, that's what I did but I'm not sure how to invoke the method. This is what I tried:</p>\n<p>class MyValidationSupport implements IValidationSupport {</p>\n<div class=\"codehilite\"><pre><span></span>    @Override\n    public ValueSetExpansionOutcome expandValueSet(FhirContext theContext,\n                                                   ConceptSetComponent theInclude) {\n        return null;\n    }\n\n    @Override\n    public List&lt;IBaseResource&gt; fetchAllConformanceResources(FhirContext theContext) {\n        return null;\n    }\n\n    @Override\n    public List&lt;StructureDefinition&gt; fetchAllStructureDefinitions(FhirContext theContext) {\n        return structureDefinitions;\n    }\n\n    @Override\n    public CodeSystem fetchCodeSystem(FhirContext theContext, String theUri) {\n        return codeSystemsMap.get(theUri);\n    }\n\n    @SuppressWarnings(&quot;unchecked&quot;)\n    @Override\n    public &lt;T extends IBaseResource&gt; T fetchResource(FhirContext theContext,\n                                                     Class&lt;T&gt; theClass,\n                                                     String theUri) {\n        Validate.notBlank(theUri, &quot;theUri must not be null or blank&quot;);\n        if (theClass.equals(StructureDefinition.class)) { return (T) fetchStructureDefinition(theContext,\n                                                                                              theUri); }\n        if (theClass.equals(ValueSet.class)) { return (T) fetchValueSet(theContext, theUri); }\n        return null;\n    }\n\n    @Override\n    public StructureDefinition fetchStructureDefinition(FhirContext theContext, String theUri) {\n        StructureDefinition sd = structureDefinitionsMap.get(theUri);\n        if (sd == null) { return sd; }\n        return generateSnapshot(sd, theUri, sd.getUrl(), sd.getName());\n    }\n\n    @Override\n    public ValueSet fetchValueSet(FhirContext theContext, String theUri) {\n        return valueSetsMap.get(theUri);\n    }\n\n    @Override\n    public StructureDefinition generateSnapshot(StructureDefinition theInput,\n                                                String theUri,\n                                                String theWebUrl,\n                                                String theProfileName) {\n        IWorkerContext context = new HapiWorkerContext(FHIRContext.instance(), this);\n        ArrayList&lt;ValidationMessage&gt; messages = new ArrayList&lt;&gt;();\n\n        StructureDefinition base = new DefaultProfileValidationSupport().fetchStructureDefinition(FHIRContext.instance(),\n                                                                                                  theInput.getBaseDefinition());\n        if (base == null) { throw new PreconditionFailedException(&quot;Unknown base definition: &quot; +\n                                                                  theInput.getBaseDefinition()); }\n\n        new ProfileUtilities(context, messages, null).generateSnapshot(base,\n                                                                       theInput,\n                                                                       theUri,\n                                                                       theWebUrl,\n                                                                       theProfileName);\n\n        return theInput;\n    }\n\n    @Override\n    public boolean isCodeSystemSupported(FhirContext theContext, String theSystem) {\n        return codeSystems.contains(theSystem);\n    }\n\n    @Override\n    public LookupCodeResult\n           lookupCode(FhirContext theContext, String theSystem, String theCode) {\n        return null;\n    }\n\n    private CodeValidationResult\n            testIfConceptIsInList(CodeSystem theCodeSystem,\n                                  String theCode,\n                                  List&lt;ConceptDefinitionComponent&gt; conceptList,\n                                  boolean theCaseSensitive) {\n        String code = theCode;\n        if (theCaseSensitive == false) {\n            code = code.toUpperCase();\n        }\n\n        return testIfConceptIsInListInner(theCodeSystem, conceptList, theCaseSensitive, code);\n    }\n\n    private CodeValidationResult\n            testIfConceptIsInListInner(CodeSystem theCodeSystem,\n                                       List&lt;ConceptDefinitionComponent&gt; conceptList,\n                                       boolean theCaseSensitive,\n                                       String code) {\n        CodeValidationResult retVal = null;\n        for (ConceptDefinitionComponent next : conceptList) {\n            String nextCandidate = next.getCode();\n            if (theCaseSensitive == false) {\n                nextCandidate = nextCandidate.toUpperCase();\n            }\n            if (nextCandidate.equals(code)) {\n                retVal = new CodeValidationResult(next);\n                break;\n            }\n\n            // recurse\n            retVal = testIfConceptIsInList(theCodeSystem,\n                                           code,\n                                           next.getConcept(),\n                                           theCaseSensitive);\n            if (retVal != null) {\n                break;\n            }\n        }\n\n        if (retVal != null) {\n            retVal.setCodeSystemName(theCodeSystem.getName());\n            retVal.setCodeSystemVersion(theCodeSystem.getVersion());\n        }\n\n        return retVal;\n    }\n\n    @Override\n    public CodeValidationResult validateCode(FhirContext theContext,\n                                             String theCodeSystem,\n                                             String theCode,\n                                             String theDisplay) {\n        CodeSystem cs = fetchCodeSystem(theContext, theCodeSystem);\n        if (cs != null) {\n            boolean caseSensitive = true;\n            if (cs.hasCaseSensitive()) {\n                caseSensitive = cs.getCaseSensitive();\n            }\n\n            CodeValidationResult retVal = testIfConceptIsInList(cs,\n                                                                theCode,\n                                                                cs.getConcept(),\n                                                                caseSensitive);\n\n            if (retVal != null) { return retVal; }\n        }\n\n        return new CodeValidationResult(IssueSeverity.WARNING,\n                                        &quot;Unknown code: &quot; + theCodeSystem + &quot; / &quot; + theCode);\n    }\n}\n</pre></div>",
        "id": 176082267,
        "sender_full_name": "Johanna Eicher",
        "timestamp": 1568885393
    },
    {
        "content": "<p>that didn't work?</p>",
        "id": 176082653,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1568885789
    },
    {
        "content": "<p>When validating a resource of type Organization for which a custom profile is defined I get lots of error messages looking like this:</p>\n<div class=\"codehilite\"><pre><span></span>Error in snapshot generation: Differential for https://fhir.bbmri.de/StructureDefinition/Biobank with id: Organization.telecom:url.system has an element that is not marked with a snapshot match\n</pre></div>",
        "id": 176082951,
        "sender_full_name": "Johanna Eicher",
        "timestamp": 1568886104
    },
    {
        "content": "<p>that means you have a problem with your differential, probably in the order of elements</p>",
        "id": 176083046,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1568886206
    },
    {
        "content": "<p>if you think that's not the case, you should submit the differential as a bug report</p>",
        "id": 176083112,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1568886249
    },
    {
        "content": "<p>The differential can be used successfully to validate resources with the HL7 validation jar (<a href=\"https://wiki.hl7.org/Using_the_FHIR_Validator\" target=\"_blank\" title=\"https://wiki.hl7.org/Using_the_FHIR_Validator\">https://wiki.hl7.org/Using_the_FHIR_Validator</a>). Probably then the differential shouldn't be the cause?</p>",
        "id": 176083165,
        "sender_full_name": "Johanna Eicher",
        "timestamp": 1568886325
    },
    {
        "content": "<p>without producing that message in the output? That's surprising. I can't think how that error could be caused by something are doing in executing the ProfileUtilities code wrongly</p>",
        "id": 176083288,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1568886448
    },
    {
        "content": "<p>you can get more insight by doing setDebug(true) on the profile utilities before calling generateSnapshot</p>",
        "id": 176083571,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1568886721
    },
    {
        "content": "<blockquote>\n<p>without producing that message in the output? That's surprising. I can't think how that error could be caused by something are doing in executing the ProfileUtilities code wrongly</p>\n</blockquote>\n<p>I will double check!</p>",
        "id": 176083627,
        "sender_full_name": "Johanna Eicher",
        "timestamp": 1568886766
    },
    {
        "content": "<blockquote>\n<blockquote>\n<p>without producing that message in the output? That's surprising. I can't think how that error could be caused by something are doing in executing the ProfileUtilities code wrongly</p>\n</blockquote>\n<p>I will double check!</p>\n</blockquote>\n<p>I have verified that I am able to successfully validate the same resource with the latest version from <a href=\"https://fhir.github.io/latest-ig-publisher/org.hl7.fhir.validator.jar\" target=\"_blank\" title=\"https://fhir.github.io/latest-ig-publisher/org.hl7.fhir.validator.jar\">https://fhir.github.io/latest-ig-publisher/org.hl7.fhir.validator.jar</a>.</p>",
        "id": 176086596,
        "sender_full_name": "Johanna Eicher",
        "timestamp": 1568889765
    },
    {
        "content": "<p>PP @ null / null : base = 0 to 25, diff = 0 to 46 (slicing = false, redirector = [])<br>\n - Organization: base = 0 (Organization) to 25 (Organization.endpoint), diff = 0 (Organization.extension) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= Organization.extension)<br>\n  PP @ Organization / null : base = 1 to 25, diff = 0 to 46 (slicing = false, redirector = [])<br>\n   - <a href=\"http://Organization.id\" target=\"_blank\" title=\"http://Organization.id\">Organization.id</a>: base = 1 (<a href=\"http://Organization.id\" target=\"_blank\" title=\"http://Organization.id\">Organization.id</a>) to 25 (Organization.endpoint), diff = 0 (Organization.extension) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= Organization.extension)<br>\n   - Organization.meta: base = 2 (Organization.meta) to 25 (Organization.endpoint), diff = 0 (Organization.extension) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= Organization.extension)<br>\n   - Organization.implicitRules: base = 3 (Organization.implicitRules) to 25 (Organization.endpoint), diff = 0 (Organization.extension) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= Organization.extension)<br>\n   - Organization.language: base = 4 (Organization.language) to 25 (Organization.endpoint), diff = 0 (Organization.extension) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= Organization.extension)<br>\n   - Organization.text: base = 5 (Organization.text) to 25 (Organization.endpoint), diff = 0 (Organization.extension) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= Organization.extension)<br>\n   - Organization.contained: base = 6 (Organization.contained) to 25 (Organization.endpoint), diff = 0 (Organization.extension) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= Organization.extension)<br>\n   - Organization.extension: base = 7 (Organization.extension) to 25 (Organization.endpoint), diff = 0 (Organization.extension) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= Organization.extension)<br>\n    PP @ Organization / null : base = 7 to 7, diff = 1 to 1 (slicing = true, redirector = [])<br>\n     - Organization.extension: base = 7 (Organization.extension) to 7 (Organization.extension), diff = 1 (Organization.extension:description) to 1 (Organization.extension:description) (slicingDone = true) (diffpath= Organization.extension)<br>\nPP @ null / null : base = 0 to 4, diff = 0 to 1 (slicing = false, redirector = [])<br>\n - Extension: base = 0 (Extension) to 4 (Extension.value[x]), diff = 0 (Extension.url) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.url)<br>\n  PP @ Extension / null : base = 1 to 4, diff = 0 to 1 (slicing = false, redirector = [])<br>\n   - <a href=\"http://Extension.id\" target=\"_blank\" title=\"http://Extension.id\">Extension.id</a>: base = 1 (<a href=\"http://Extension.id\" target=\"_blank\" title=\"http://Extension.id\">Extension.id</a>) to 4 (Extension.value[x]), diff = 0 (Extension.url) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.url)<br>\n   - Extension.extension: base = 2 (Extension.extension) to 4 (Extension.value[x]), diff = 0 (Extension.url) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.url)<br>\n   - Extension.url: base = 3 (Extension.url) to 4 (Extension.value[x]), diff = 0 (Extension.url) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.url)<br>\n   - Extension.value[x]: base = 4 (Extension.value[x]) to 4 (Extension.value[x]), diff = 1 (Extension.value[x]) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.value[x])<br>\nDifferential: <br>\n  Extension.url : [0..null]  id = Extension.url fixed=uri<br>\n  Extension.value[x] : string[1..null]  id = Extension.value[x] <br>\nSnapshot: <br>\n  Extension : [0..*]  id = Extension constraints=2<br>\n<a href=\"http://Extension.id\" target=\"_blank\" title=\"http://Extension.id\">Extension.id</a> : string[0..1]  id = <a href=\"http://Extension.id\" target=\"_blank\" title=\"http://Extension.id\">Extension.id</a> <br>\n  Extension.extension : Extension[0..*] (slicing by url)  id = Extension.extension <br>\n  Extension.url : null[1..1]  id = Extension.url fixed=uri<br>\n  Extension.value[x] : string[1..1]  id = Extension.value[x] <br>\n    PP @ Organization / null : base = 7 to 7, diff = 2 to 2 (slicing = true, redirector = [])<br>\n     - Organization.extension: base = 7 (Organization.extension) to 7 (Organization.extension), diff = 2 (Organization.extension:juridicalPerson) to 2 (Organization.extension:juridicalPerson) (slicingDone = true) (diffpath= Organization.extension)<br>\nPP @ null / null : base = 0 to 4, diff = 0 to 1 (slicing = false, redirector = [])<br>\n - Extension: base = 0 (Extension) to 4 (Extension.value[x]), diff = 0 (Extension.url) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.url)<br>\n  PP @ Extension / null : base = 1 to 4, diff = 0 to 1 (slicing = false, redirector = [])<br>\n   - <a href=\"http://Extension.id\" target=\"_blank\" title=\"http://Extension.id\">Extension.id</a>: base = 1 (<a href=\"http://Extension.id\" target=\"_blank\" title=\"http://Extension.id\">Extension.id</a>) to 4 (Extension.value[x]), diff = 0 (Extension.url) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.url)<br>\n   - Extension.extension: base = 2 (Extension.extension) to 4 (Extension.value[x]), diff = 0 (Extension.url) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.url)<br>\n   - Extension.url: base = 3 (Extension.url) to 4 (Extension.value[x]), diff = 0 (Extension.url) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.url)<br>\n   - Extension.value[x]: base = 4 (Extension.value[x]) to 4 (Extension.value[x]), diff = 1 (Extension.value[x]) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.value[x])<br>\nDifferential: <br>\n  Extension.url : [0..null]  id = Extension.url fixed=uri<br>\n  Extension.value[x] : string[1..null]  id = Extension.value[x] <br>\nSnapshot: <br>\n  Extension : [0..*]  id = Extension constraints=2<br>\n<a href=\"http://Extension.id\" target=\"_blank\" title=\"http://Extension.id\">Extension.id</a> : string[0..1]  id = <a href=\"http://Extension.id\" target=\"_blank\" title=\"http://Extension.id\">Extension.id</a> <br>\n  Extension.extension : Extension[0..*] (slicing by url)  id = Extension.extension <br>\n  Extension.url : null[1..1]  id = Extension.url fixed=uri<br>\n  Extension.value[x] : string[1..1]  id = Extension.value[x] <br>\n    PP @ Organization / null : base = 7 to 7, diff = 3 to 3 (slicing = true, redirector = [])<br>\n     - Organization.extension: base = 7 (Organization.extension) to 7 (Organization.extension), diff = 3 (Organization.extension:qualityStandard) to 3 (Organization.extension:qualityStandard) (slicingDone = true) (diffpath= Organization.extension)<br>\nPP @ null / null : base = 0 to 4, diff = 0 to 1 (slicing = false, redirector = [])<br>\n - Extension: base = 0 (Extension) to 4 (Extension.value[x]), diff = 0 (Extension.url) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.url)<br>\n  PP @ Extension / null : base = 1 to 4, diff = 0 to 1 (slicing = false, redirector = [])<br>\n   - <a href=\"http://Extension.id\" target=\"_blank\" title=\"http://Extension.id\">Extension.id</a>: base = 1 (<a href=\"http://Extension.id\" target=\"_blank\" title=\"http://Extension.id\">Extension.id</a>) to 4 (Extension.value[x]), diff = 0 (Extension.url) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.url)<br>\n   - Extension.extension: base = 2 (Extension.extension) to 4 (Extension.value[x]), diff = 0 (Extension.url) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.url)<br>\n   - Extension.url: base = 3 (Extension.url) to 4 (Extension.value[x]), diff = 0 (Extension.url) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.url)<br>\n   - Extension.value[x]: base = 4 (Extension.value[x]) to 4 (Extension.value[x]), diff = 1 (Extension.value[x]) to 1 (Extension.value[x]) (slicingDone = false) (diffpath= Extension.value[x])<br>\nDifferential: <br>\n  Extension.url : [0..null]  id = Extension.url fixed=uri<br>\n  Extension.value[x] : CodeableConcept[0..null]  id = Extension.value[x] <br>\nSnapshot: <br>\n  Extension : [0..*]  id = Extension constraints=2<br>\n<a href=\"http://Extension.id\" target=\"_blank\" title=\"http://Extension.id\">Extension.id</a> : string[0..1]  id = <a href=\"http://Extension.id\" target=\"_blank\" title=\"http://Extension.id\">Extension.id</a> <br>\n  Extension.extension : Extension[0..*] (slicing by url)  id = Extension.extension <br>\n  Extension.url : null[1..1]  id = Extension.url fixed=uri<br>\n  Extension.value[x] : CodeableConcept[0..1]  id = Extension.value[x] <br>\n   - Organization.modifierExtension: base = 8 (Organization.modifierExtension) to 25 (Organization.endpoint), diff = 4 (Organization.identifier) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= Organization.identifier)<br>\n   - Organization.identifier: base = 9 (Organization.identifier) to 25 (Organization.endpoint), diff = 4 (Organization.identifier) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= Organization.identifier)<br>\n    PP @ Organization / null : base = 9 to 9, diff = 5 to 7 (slicing = true, redirector = [])<br>\n     - Organization.identifier: base = 9 (Organization.identifier) to 9 (Organization.identifier), diff = 5 (Organization.identifier:Bbmri-EricId) to 7 (Organization.identifier:Bbmri-EricId.value) (slicingDone = true) (diffpath= Organization.identifier)<br>\n   - Organization.active: base = 10 (Organization.active) to 25 (Organization.endpoint), diff = 8 (<a href=\"http://Organization.name\" target=\"_blank\" title=\"http://Organization.name\">Organization.name</a>) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= <a href=\"http://Organization.name\" target=\"_blank\" title=\"http://Organization.name\">Organization.name</a>)<br>\n   - Organization.type: base = 11 (Organization.type) to 25 (Organization.endpoint), diff = 8 (<a href=\"http://Organization.name\" target=\"_blank\" title=\"http://Organization.name\">Organization.name</a>) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= <a href=\"http://Organization.name\" target=\"_blank\" title=\"http://Organization.name\">Organization.name</a>)<br>\n   - <a href=\"http://Organization.name\" target=\"_blank\" title=\"http://Organization.name\">Organization.name</a>: base = 12 (<a href=\"http://Organization.name\" target=\"_blank\" title=\"http://Organization.name\">Organization.name</a>) to 25 (Organization.endpoint), diff = 8 (<a href=\"http://Organization.name\" target=\"_blank\" title=\"http://Organization.name\">Organization.name</a>) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= <a href=\"http://Organization.name\" target=\"_blank\" title=\"http://Organization.name\">Organization.name</a>)<br>\n   - Organization.alias: base = 13 (Organization.alias) to 25 (Organization.endpoint), diff = 9 (Organization.alias) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= Organization.alias)<br>\n   - Organization.telecom: base = 14 (Organization.telecom) to 25 (Organization.endpoint), diff = 10 (Organization.telecom) to 46 (Organization.contact:contact.address.country) (slicingDone = false) (diffpath= Organization.telecom)<br>\n    PP @ Organization / null : base = 14 to 14, diff = 11 to 13 (slicing = true, redirector = [])<br>\n     - Organization.telecom: base = 14 (Organization.telecom) to 14 (Organization.telecom), diff = 11 (Organization.telecom:url) to 13 (Organization.telecom:url.value) (slicingDone = true) (diffpath= Organization.telecom)<br>\n   - Organization.address: base = 15 (Organization.address) to 25 (Organization.endpoint), diff = 14 (Organization.address) to 46 (Organiza</p>",
        "id": 176093321,
        "sender_full_name": "Johanna Eicher",
        "timestamp": 1568895742
    },
    {
        "content": "<p>This is an excerpt from my log, I don't really know what to look for there.</p>",
        "id": 176093372,
        "sender_full_name": "Johanna Eicher",
        "timestamp": 1568895802
    },
    {
        "content": "<p>Eventually, I will end up with the following exception:</p>\n<p>java.lang.UnsupportedOperationException<br>\n    at org.hl7.fhir.r4.hapi.validation.FhirInstanceValidator$WorkerContextWrapper.expandVS(FhirInstanceValidator.java:376)<br>\n    at org.hl7.fhir.r5.elementmodel.Element.getAsICoding(Element.java:807)<br>\n    at org.hl7.fhir.r5.model.Base.castToCoding(Base.java:518)<br>\n    at org.hl7.fhir.r5.utils.FHIRPathEngine.opMemberOf(FHIRPathEngine.java:1888)<br>\n    at org.hl7.fhir.r5.utils.FHIRPathEngine.operate(FHIRPathEngine.java:1410)<br>\n    at org.hl7.fhir.r5.utils.FHIRPathEngine.execute(FHIRPathEngine.java:1175)<br>\n    at org.hl7.fhir.r5.utils.FHIRPathEngine.execute(FHIRPathEngine.java:1156)<br>\n    at org.hl7.fhir.r5.utils.FHIRPathEngine.execute(FHIRPathEngine.java:1174)<br>\n    at org.hl7.fhir.r5.utils.FHIRPathEngine.evaluate(FHIRPathEngine.java:546)<br>\n    at org.hl7.fhir.r5.utils.FHIRPathEngine.evaluateToBoolean(FHIRPathEngine.java:614)<br>\n    at org.hl7.fhir.r5.validation.InstanceValidator.evaluateSlicingExpression(InstanceValidator.java:2803)<br>\n    at org.hl7.fhir.r5.validation.InstanceValidator.sliceMatches(InstanceValidator.java:2795)<br>\n    at org.hl7.fhir.r5.validation.InstanceValidator.matchSlice(InstanceValidator.java:4313)<br>\n    at org.hl7.fhir.r5.validation.InstanceValidator.assignChildren(InstanceValidator.java:4227)<br>\n    at org.hl7.fhir.r5.validation.InstanceValidator.validateElement(InstanceValidator.java:3942)<br>\n    at org.hl7.fhir.r5.validation.InstanceValidator.start(InstanceValidator.java:2966)<br>\n    at org.hl7.fhir.r5.validation.InstanceValidator.validateResource(InstanceValidator.java:4526)<br>\n    at org.hl7.fhir.r5.validation.InstanceValidator.validate(InstanceValidator.java:825)<br>\n    at org.hl7.fhir.r5.validation.InstanceValidator.validate(InstanceValidator.java:751)<br>\n    at org.hl7.fhir.common.hapi.validation.ValidatorWrapper.validate(ValidatorWrapper.java:116)<br>\n    at org.hl7.fhir.r4.hapi.validation.FhirInstanceValidator.validate(FhirInstanceValidator.java:216)<br>\n    at org.hl7.fhir.r4.hapi.validation.BaseValidatorBridge.doValidate(BaseValidatorBridge.java:20)<br>\n    at org.hl7.fhir.r4.hapi.validation.BaseValidatorBridge.validateResource(BaseValidatorBridge.java:43)<br>\n    at org.hl7.fhir.r4.hapi.validation.FhirInstanceValidator.validateResource(FhirInstanceValidator.java:42)<br>\n    at ca.uhn.fhir.validation.FhirValidator.validateWithResult(FhirValidator.java:219)<br>\n    at ca.uhn.fhir.validation.FhirValidator.validateWithResult(FhirValidator.java:186)<br>\n    at de.etl.util.FHIRValidation.validate(FHIRValidation.java:425)<br>\n    at de.etl.test.TestValidation.testBiobank(TestValidation.java:118)<br>\n    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br>\n    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)<br>\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)<br>\n    at java.lang.reflect.Method.invoke(Method.java:498)<br>\n    at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)<br>\n    at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)<br>\n    at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)<br>\n    at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)<br>\n    at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:325)<br>\n    at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:78)<br>\n    at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:57)<br>\n    at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)<br>\n    at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)<br>\n    at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)<br>\n    at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)<br>\n    at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)<br>\n    at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)<br>\n    at org.junit.runners.ParentRunner.run(ParentRunner.java:363)<br>\n    at org.eclipse.jdt.internal.junit4.runner.JUnit4TestReference.run(JUnit4TestReference.java:86)<br>\n    at org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:38)<br>\n    at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:538)<br>\n    at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:760)<br>\n    at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:460)<br>\n    at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:206)</p>",
        "id": 176093394,
        "sender_full_name": "Johanna Eicher",
        "timestamp": 1568895833
    },
    {
        "content": "<p>it looks like it succeeded this time, based on the location of the actual error, which is inside your terminology service binding?</p>",
        "id": 176104739,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1568903248
    },
    {
        "content": "<p>Within the HAPI ecosystem, you can use the SnapshotGeneratingValidationSupport class for snapshot generation if you only have differentials. You'll also need an instance of DefaultProfileValidationSupport to supply the standard resources.</p>\n<p>You may also want to use PrePopulatedValidationSupport to inject any custom profile SD's you have, and then ValidationSupportChain to chain them all together (this is what you will pass to the FhirInstanceValidator module).</p>",
        "id": 176144846,
        "sender_full_name": "James Agnew",
        "timestamp": 1568929277
    },
    {
        "content": "<blockquote>\n<p>Within the HAPI ecosystem, you can use the SnapshotGeneratingValidationSupport class for snapshot generation if you only have differentials. You'll also need an instance of DefaultProfileValidationSupport to supply the standard resources.</p>\n<p>You may also want to use PrePopulatedValidationSupport to inject any custom profile SD's you have, and then ValidationSupportChain to chain them all together (this is what you will pass to the FhirInstanceValidator module).</p>\n</blockquote>\n<p>I have tried different variants of the components you described but I'm afraid I haven't found the correct combination yet. Could you tell me which methods I need to implement in my custom validator and which validators I need to use in which order if I have:<br>\n- A number of custom value sets<br>\n- A number of custom code systems<br>\n- A number of custom structure definitions as differentials.</p>\n<p>I tried to provide the differentials via my own validation support and then have the snapshots generated by the SnapshotGeneratingValidationSupport like so:</p>\n<div class=\"codehilite\"><pre><span></span>    ValidationSupportChain support = new ValidationSupportChain(myValidationSupport,\n                                                                new SnapshotGeneratingValidationSupport(FHIRContext.instance(),\n                                                                                                        myValidationSupport),\n                                                                new DefaultProfileValidationSupport());\n    FhirInstanceValidator instanceValidator = new FhirInstanceValidator(support);\n    validator.registerValidatorModule(instanceValidator);\n</pre></div>\n\n\n<p>I got error messages such as  \"StructureDefinition has no snapshot - validation is against the snapshot, so it must be provided\" which made me think that my set up is not correct. </p>\n<p>Through debugging I found that none of the generateSnapshot methods of any of the three provided validators is invoked in the first place which made me think that I have to call it myself in my custom validation support. I tried this in different ways but still not successfully.</p>\n<p>All these things I tried before I posted my original question when I realized that most helpful would be a working example (which I also tried to find  via various searches).</p>\n<p>I would be really grateful if someone could provide such an example!</p>",
        "id": 176172002,
        "sender_full_name": "Johanna Eicher",
        "timestamp": 1568965809
    },
    {
        "content": "<blockquote>\n<p>it looks like it succeeded this time, based on the location of the actual error, which is inside your terminology service binding?</p>\n</blockquote>\n<p>Thanks for the tip! I do think there could be another problem relating to this but I'm quite sure that my set up is not correct yet and I am trying to get to the root cause first. Hence my previous reply.</p>",
        "id": 176172050,
        "sender_full_name": "Johanna Eicher",
        "timestamp": 1568965905
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"240776\">@Johanna Eicher</span> What you posted looks close- I think you need to be passing in an instance of DefaultProfileValidationSupport to the constructor of SnapshotGeneratingValidationSupport instead of <code>myValidationSupport</code> though.</p>",
        "id": 176207655,
        "sender_full_name": "James Agnew",
        "timestamp": 1568996746
    },
    {
        "content": "<p>Thank you for the tip. I have tried that as well but unfortunately with the same result (...StructureDefinition has no snapshot...). </p>\n<p>In all of my attempts I have not yet managed to have the method <code>ValidationSupportChain.generateSnapshot</code>invoked. From analyzing the Hapi code I'm using (see dependencies above) I could not find the trigger either.</p>\n<p>Does this mean I'm missing a dependency or maybe that I have to invoke it myself?</p>",
        "id": 176345999,
        "sender_full_name": "Johanna Eicher",
        "timestamp": 1569223786
    },
    {
        "content": "<p>You do need to invoke it yourself on the structuredefinition before you can use it if you onlt have a differential.. Then you'd want to put it in the PrePopulated one</p>",
        "id": 176353297,
        "sender_full_name": "James Agnew",
        "timestamp": 1569231295
    },
    {
        "content": "<p>I have now changed my implementation such that I only use <code>DefaultProfileValidationSupport</code>and <code>PrePopulatedValidationSupport</code> populated with my custom value sets, code systems and snapshots which I have generated from my custom differentials before:</p>\n<div class=\"codehilite\"><pre><span></span>    // Validator instance\n    validator = FHIRContext.instance().newValidator();\n\n    // Default validator\n    DefaultProfileValidationSupport defSupport = new DefaultProfileValidationSupport();\n\n    // Validator used for generating snapshots (manually)\n    SnapshotGeneratingValidationSupport snapSupport = new SnapshotGeneratingValidationSupport(FHIRContext.instance(),\n                                                                                              defSupport);\n\n    // Validator providing snapshots generated from custom differentials\n    PrePopulatedValidationSupport ppSupport = new PrePopulatedValidationSupport();\n\n    // For each value set\n    for (ValueSet valueSet : valueSetsMap.values()) {\n        ppSupport.addValueSet(valueSet);\n    }\n\n    // For each code system\n    for (CodeSystem codeSystem : codeSystemsMap.values()) {\n        ppSupport.addCodeSystem(codeSystem);\n    }\n\n    // For each profile\n    for (StructureDefinition sd : structureDefinitionsMap.values()) {\n        snapSupport.generateSnapshot(sd, sd.getBaseDefinition(), sd.getUrl(), sd.getName());\n        ppSupport.addStructureDefinition(sd);\n    }\n\n    // Add custom validation\n    ValidationSupportChain support = new ValidationSupportChain(ppSupport, defSupport);\n    FhirInstanceValidator instanceValidator = new FhirInstanceValidator(support);\n    validator.registerValidatorModule(instanceValidator);\n</pre></div>\n\n\n<p>Is this now the right approach? I am getting error messages such as </p>\n<div class=\"codehilite\"><pre><span></span>Organization.extension[2].value.ofType(CodeableConcept) Code https://fhir.bbmri.de/CodeSystem/QualityStandard/oecd-guidelines was not validated because the code system is not present\n</pre></div>\n\n\n<p>referencing code systems that I have supplied to the validator before.</p>",
        "id": 176470099,
        "sender_full_name": "Johanna Eicher",
        "timestamp": 1569336083
    },
    {
        "content": "<p>Hmm, what you have look right to me.</p>\n<p>Can you try putting breakpoints in DefaultProfileValidationSupport to see what is happening with the code validation?</p>",
        "id": 176497952,
        "sender_full_name": "James Agnew",
        "timestamp": 1569353726
    },
    {
        "content": "<p>Through debugging, I found that the problem was caused by the fact that the method</p>\n<div class=\"codehilite\"><pre><span></span>@Override\npublic boolean isCodeSystemSupported(FhirContext theContext, String theSystem) {\n    return false;\n}\n</pre></div>\n\n\n<p>of the <code>PrePopulatedValidationSupport</code> class is always returning <code>false</code>. Does this mean this validator is not designed to handle custom code systems in general?</p>\n<p>I think I have finally found a solution that is working for me. Instead of the <code>PrePopulatedValidationSupport</code> I am using my own validator (in addition to the default validator) which I populate with snapshots of my differentials (just like I was doing with the <code>PrePopulatedValidationSupport</code>). But now I can also implement the above mentioned method which so far seems to have solved my issues.</p>",
        "id": 176557516,
        "sender_full_name": "Johanna Eicher",
        "timestamp": 1569413315
    },
    {
        "content": "<p>I'm trying to replicate this last example <span class=\"user-mention\" data-user-id=\"240776\">@Johanna Eicher</span> posted. I'm testing with a custom profile and a custom extension, both written as differentials. Is important to say that this custom profile uses the custom extension.</p>\n<div class=\"codehilite\"><pre><span></span>        FhirContext ctx = .....\n\n        // Validator instance\n        FhirValidator validator = ctx.newValidator();\n\n        // Default validator\n        DefaultProfileValidationSupport defSupport = new DefaultProfileValidationSupport();\n\n        // Validator used for generating snapshots (manually)\n        SnapshotGeneratingValidationSupport snapSupport =\n                new SnapshotGeneratingValidationSupport(ctx, defSupport);\n\n        // Validator providing snapshots generated from custom differentials\n        PrePopulatedValidationSupport ppSupport = new PrePopulatedValidationSupport();\n\n        IParser fhirParser = ctx.newXmlParser();\n\n        // consider that there&#39;s a folder with all custom profiles\n        List&lt;String&gt; sdFiles = fileUtil.listFolder(pathToProfilesFolder);\n        for (String sdPath : sdFiles) {\n\n            StructureDefinition sd = fhirParser.parseResource(\n                    StructureDefinition.class,\n                    fileUtil.readFile(sdPath));\n\n            // the error prints after this next method call for the profile\n            snapSupport.generateSnapshot(\n                    sd,\n                    sd.getBaseDefinition(),\n                    sd.getUrl(),\n                    sd.getName());\n\n            ppSupport.addStructureDefinition(sd);\n        }\n\n        ValidationSupportChain support = new ValidationSupportChain(ppSupport, defSupport);\n\n        // Add custom validation\n        FhirInstanceValidator instanceValidator = new FhirInstanceValidator(support);\n        validator.registerValidatorModule(instanceValidator);\n</pre></div>\n\n\n<p>When I run this code, I get the following error log after the generateSnapshot method, only for the custom profile:</p>\n<div class=\"codehilite\"><pre><span></span>Failed to find referenced profile: [CanonicalType[http://example.com/fhir/r4/StructureDefinition/CustomExtension]]\n</pre></div>\n\n\n<p>That is exactly the URL for my custom extension. <br>\nSo I thought I'd had to first include the extension and then the profile, changing the order of the listed files on my profiles folder. But that didn't changed anything. I'm still getting that error, no matter the order those are imported. <br>\nNo exception is thrown, but I still didn't try to validate any resources even with that log message.<br>\nShould I just ignore that message log? Or should I first import all extensions and then create a new SnapshotGeneratingValidationSupport using this new 'map' of supported structures and then import the structures that makes references to those?<br>\nImagine my implementation context where I have a lot of custom profiles, one referencing the other (no cyclic ref though). Should I always rebuild the snapshot before importing the next structure? <br>\nThere's also the possibility that my custom structures were written incorrectly. They're created using Firely's Forge, and they seem alright, no errors or warnings. The tool appears to understand the reference between them.</p>",
        "id": 189356786,
        "sender_full_name": "Pedro Lauro",
        "timestamp": 1582928414
    },
    {
        "content": "<p>Did you perhaps not disable the default rules in your validator?</p>\n<div class=\"codehilite\"><pre><span></span>// Create a validator and configure it\nvalidator = con.newValidator();\n\n// Typically if you are doing profile validation, you want to disable\n // the schema/schematron validation since the profile will specify\n // all the same rules (and more)\nvalidator.setValidateAgainstStandardSchema(false);\nvalidator.setValidateAgainstStandardSchematron(false);\n</pre></div>\n\n\n<p>When the above is true, even though your validation rules allow it, the default rules block it, failing your validation</p>",
        "id": 189451324,
        "sender_full_name": "Sajith Jamal",
        "timestamp": 1583102852
    },
    {
        "content": "<p>I am seeing the same problem as <span class=\"user-mention\" data-user-id=\"240776\">@Johanna Eicher</span>  with the loading of custom value sets/ code systems. Depending on the ordering of the default and the PrePopulated, validation supports, the same problem also occurs even with standard value sets as described in this thread: <a href=\"#narrow/stream/179167-hapi/topic/Custom.20ValueSet.20missing.20from.20validation\" title=\"#narrow/stream/179167-hapi/topic/Custom.20ValueSet.20missing.20from.20validation\">https://chat.fhir.org/#narrow/stream/179167-hapi/topic/Custom.20ValueSet.20missing.20from.20validation</a></p>",
        "id": 189470627,
        "sender_full_name": "Morten Ernebjerg",
        "timestamp": 1583136708
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"194703\">@Morten Ernebjerg</span> ,  my example of validation is for R4 FHIR version, and yours are for DSTU3 right? The PrePopulated class have different versions for each FHIR version, and looking at the R4 version, the isCodeSystemSupported() method doesn't have that fixed statement to always returns false:<br>\n<a href=\"https://github.com/jamesagnew/hapi-fhir/blob/8a1fa3ea3c3a8bd15a872182461310d799f0ac7b/hapi-fhir-validation/src/main/java/org/hl7/fhir/r4/hapi/validation/PrePopulatedValidationSupport.java\" target=\"_blank\" title=\"https://github.com/jamesagnew/hapi-fhir/blob/8a1fa3ea3c3a8bd15a872182461310d799f0ac7b/hapi-fhir-validation/src/main/java/org/hl7/fhir/r4/hapi/validation/PrePopulatedValidationSupport.java\">R4 PrePopulatedValidationSupport.java</a></p>",
        "id": 189511217,
        "sender_full_name": "Pedro Lauro",
        "timestamp": 1583168405
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"234906\">Sajith Jamal</span> <a href=\"#narrow/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation/near/189451324\" title=\"#narrow/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation/near/189451324\">said</a>:</p>\n<blockquote>\n<p>Did you perhaps not disable the default rules in your validator?</p>\n<div class=\"codehilite\"><pre><span></span>// Create a validator and configure it\nvalidator = con.newValidator();\n\n// Typically if you are doing profile validation, you want to disable\n // the schema/schematron validation since the profile will specify\n // all the same rules (and more)\nvalidator.setValidateAgainstStandardSchema(false);\nvalidator.setValidateAgainstStandardSchematron(false);\n</pre></div>\n\n\n<p>When the above is true, even though your validation rules allow it, the default rules block it, failing your validation</p>\n</blockquote>\n<p>Even though those are false by default, I tried setting them false, with no difference on the output. Still getting the same error.</p>",
        "id": 189512313,
        "sender_full_name": "Pedro Lauro",
        "timestamp": 1583169085
    },
    {
        "content": "<p>hmmmm......<br>\nanother thing to try is instead of this:</p>\n<div class=\"codehilite\"><pre><span></span>// Add custom validation\n        FhirInstanceValidator instanceValidator = new FhirInstanceValidator(support);\n        validator.registerValidatorModule(instanceValidator);\n</pre></div>\n\n\n<p>try this:</p>\n<div class=\"codehilite\"><pre><span></span>ValidationSupportChain support = new ValidationSupportChain(new DefaultProfileValidationSupport(), validationSupport);\ninstanceValidator.setValidationSupport(support);\n</pre></div>\n\n\n<p>its how I got mine to work...and seems to be the difference between your code and mine</p>",
        "id": 189552451,
        "sender_full_name": "Sajith Jamal",
        "timestamp": 1583195570
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"267499\">@Pedro Lauro</span> Yes, I am using STU3 - thanks for pointing out the code difference to R4, didn't check that so far!</p>",
        "id": 189568727,
        "sender_full_name": "Morten Ernebjerg",
        "timestamp": 1583219832
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"234906\">Sajith Jamal</span> <a href=\"#narrow/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation/near/189552451\" title=\"#narrow/stream/179167-hapi/topic/Example.3A.20Custom.20profile.20validation/near/189552451\">said</a>:</p>\n<blockquote>\n<p>hmmmm......<br>\nanother thing to try is instead of this:</p>\n<div class=\"codehilite\"><pre><span></span>// Add custom validation\n        FhirInstanceValidator instanceValidator = new FhirInstanceValidator(support);\n        validator.registerValidatorModule(instanceValidator);\n</pre></div>\n\n\n<p>try this:</p>\n<div class=\"codehilite\"><pre><span></span>ValidationSupportChain support = new ValidationSupportChain(new DefaultProfileValidationSupport(), validationSupport);\ninstanceValidator.setValidationSupport(support);\n</pre></div>\n\n\n<p>its how I got mine to work...and seems to be the difference between your code and mine</p>\n</blockquote>\n<p>Nothing different. The error happens before those instructions, while trying to generate the snapshot.</p>",
        "id": 189732573,
        "sender_full_name": "Pedro Lauro",
        "timestamp": 1583354328
    }
]