[
    {
        "content": "<p>Following the suggestion of <span class=\"user-mention\" data-user-id=\"191320\">@Lloyd McKenzie</span> im posting my Question (which a already posted in <a href=\"#narrow/stream/179166-implementers/topic/Restrict.20References.20to.20specific.20Profile\">#implementers </a>) once again in this stream.</p>\n<p>If i'm not misunderstanding the FHIR specification for <a href=\"https://www.hl7.org/fhir/elementdefinition-definitions.html#ElementDefinition.type.targetProfile\">targetProfile</a>, i'm supposed to be able to restrict a Reference, so that it's actual Resource-Content conforms to a specific Profile.</p>\n<blockquote>\n<p>Definition    <br>\nUsed when the type is \"Reference\" or \"canonical\", and identifies a profile structure or implementation Guide that applies to the target of the reference this element refers to. If any profiles are specified, then the content must conform to at least one of them. The URL can be a local reference - to a contained StructureDefinition, or a reference to another StructureDefinition or Implementation Guide by a canonical URL. When an implementation guide is specified, the target resource SHALL conform to at least one profile defined in the implementation guide.</p>\n</blockquote>\n<p>So with validation enabled, i would imagine HAPI to resolve References and check if they conform to one of the specified TargetProfiles.</p>\n<p>I created a test scenario with two Profiles and uploaded the StructureDefinitions to <a href=\"http://hapi.fhir.org/baseR4\">http://hapi.fhir.org/baseR4</a>:</p>\n<ul>\n<li><a href=\"http://hapi.fhir.org/baseR4/StructureDefinition/1437751\">MyPatient</a> : needs to have a <strong>gender</strong> (by changing cardinality to 1..1)</li>\n<li><a href=\"http://hapi.fhir.org/baseR4/StructureDefinition/1437752\">MyCareTeam</a> : only allows MyPatient-References in <strong>subject</strong> (by removing the default target Profiles and adding the cannonical URL for MyPatient) <a href=\"/user_uploads/10155/Mdm0XcypZP3LxvoAgVPjuiN0/forge.png\">forge.png</a></li>\n</ul>\n<p>Than i uploaded 2 resources of Patient and 2 resources of CareTeam:</p>\n<ul>\n<li><a href=\"http://hapi.fhir.org/baseR4/Patient/1438246\">Patient conforming to MyPatient profile</a></li>\n<li><a href=\"http://hapi.fhir.org/baseR4/Patient/1438247\">Patient not conforming to MyPatient profile</a></li>\n<li><a href=\"http://hapi.fhir.org/baseR4/CareTeam/1438248\">CareTeam containing conforming Patient</a> (<a href=\"http://hapi.fhir.org/baseR4/CareTeam/1438248/$validate\">$validate</a>)</li>\n<li><a href=\"http://hapi.fhir.org/baseR4/CareTeam/1438249\">CareTeam containing non conforming Patient </a>(<a href=\"http://hapi.fhir.org/baseR4/CareTeam/1438249/$validate\">$validate</a>)</li>\n</ul>\n<p>Now when calling the <strong>$validate</strong> operation on the CareTeam resources, i would expect the first one to not contain any errors and the second one to contain one error, since the referenced Patient resource does not conform to the MyPatient profile.<br>\nTo my surprise both CareTeam resources don't have any errors.</p>\n<p>Than i tried another approch and added the following constraint to the StructureDefinition of MyCareTeam:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"nt\">&lt;constraint&gt;</span>\n    <span class=\"nt\">&lt;key</span> <span class=\"na\">value=</span><span class=\"s\">&quot;req-01&quot;</span><span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;requirements</span> <span class=\"na\">value=</span><span class=\"s\">&quot;Subject is not conforming&quot;</span><span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;severity</span> <span class=\"na\">value=</span><span class=\"s\">&quot;warning&quot;</span><span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;human</span> <span class=\"na\">value=</span><span class=\"s\">&quot;Subject is not conforming&quot;</span><span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;expression</span> <span class=\"na\">value=</span><span class=\"s\">&quot;subject.reference.resolve().conformsTo(&#39;http://example.org/fhir/StructureDefinition/MyPatient&#39;)&quot;</span><span class=\"nt\">/&gt;</span>\n<span class=\"nt\">&lt;/constraint&gt;</span>\n</code></pre></div>\n\n\n<p>Now i am expecting to see a warning when validating the second CareTeam resource. But both CareTeam resources contain the warning! It seems like either the resolve() or the conformsTo() method is not working with the FHIRPath expression.</p>\n<p>Is this a missing HAPI feature, or am i doing somthing wrong?</p>",
        "id": 207973776,
        "sender_full_name": "Sergej Reiser",
        "timestamp": 1598367506
    },
    {
        "content": "<p>I asked the same Question on <a href=\"https://groups.google.com/forum/#!topic/hapi-fhir/owvoIdbKwRo\">Google Groups</a> where i  received a reply from <span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span> . </p>\n<p>To summarize: HAPI <strong>does</strong> support validation for TargetProfiles, but it's not enabled by default and it also wasn't enabled on <a href=\"http://hapi.fhir.org\">hapi.fhir.org</a>. James commited a configuration update to enable validation for TargetProfiles on <a href=\"http://hapi.fhir.org\">hapi.fhir.org</a>.</p>",
        "id": 209505460,
        "sender_full_name": "Sergej Reiser",
        "timestamp": 1599655677
    }
]