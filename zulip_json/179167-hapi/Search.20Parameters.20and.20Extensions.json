[
    {
        "content": "<p>(Moving here from the Implementers stream...sorry for the duplication)<br>\nAny insight into how I am misusing the SearchParameter would be greatly appreciated.</p>\n<p>HAPI (I've tested 3.7 and 3.8) implements search parameter definitions.<br>\nSee <a href=\"http://hapi.fhir.org/baseR4/MedicationKnowledge?productType\" target=\"_blank\" title=\"http://hapi.fhir.org/baseR4/MedicationKnowledge?productType\">http://hapi.fhir.org/baseR4/MedicationKnowledge?productType</a> for a search parameter that allows search against the MedicationKnowledge productType field.<br>\nA sample query is:<br>\n<a href=\"http://hapi.fhir.org/baseR4/MedicationKnowledge?productType=BRANDX\" target=\"_blank\" title=\"http://hapi.fhir.org/baseR4/MedicationKnowledge?productType=BRANDX\">http://hapi.fhir.org/baseR4/MedicationKnowledge?productType=BRANDX</a></p>\n<p>I'm trying to develop a SearchParameter that will allow me to search against data in extension fields.<br>\nThe extensions are valueBooleans.<br>\nI have two MedicationInformation Objects, one with the extension data, one without: (see <a href=\"http://hapi.fhir.org/baseR4/MedicationKnowledge\" target=\"_blank\" title=\"http://hapi.fhir.org/baseR4/MedicationKnowledge\">http://hapi.fhir.org/baseR4/MedicationKnowledge</a>)<br>\n1) <a href=\"http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK1\" target=\"_blank\" title=\"http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK1\">http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK1</a> -- has extensions<br>\n2) <a href=\"http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK2\" target=\"_blank\" title=\"http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK2\">http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK2</a></p>\n<p>The quantityLimit extension looks like this:<br>\n{<br>\n\"url\": \"<a href=\"https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-QuantityLimit-extension\" target=\"_blank\" title=\"https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-QuantityLimit-extension\">https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-QuantityLimit-extension</a>\",<br>\n\"valueBoolean\": true<br>\n}</p>\n<p>I have defined a SearchParameter: <a href=\"http://hapi.fhir.org/baseR4/SearchParameter/quantityLimit\" target=\"_blank\" title=\"http://hapi.fhir.org/baseR4/SearchParameter/quantityLimit\">http://hapi.fhir.org/baseR4/SearchParameter/quantityLimit</a><br>\n{<br>\n\"resourceType\": \"SearchParameter\",<br>\n\"id\": \"quantityLimit\",<br>\n\"meta\": {<br>\n\"versionId\": \"1\",<br>\n\"lastUpdated\": \"2019-02-22T08:37:56.297+00:00\"<br>\n},<br>\n\"title\": \"quantityLimit\",<br>\n\"status\": \"active\",<br>\n\"code\": \"quantityLimit\",<br>\n\"base\": [<br>\n\"MedicationKnowledge\"<br>\n],<br>\n\"type\": \"string\",<br>\n\"expression\": \"MedicationKnowledge.extension(\\\" <a href=\"https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-QuantityLimit-extension.valueBoolean\" target=\"_blank\" title=\"https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-QuantityLimit-extension.valueBoolean\">https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-QuantityLimit-extension.valueBoolean</a> \\\")\",<br>\n\"xpathUsage\": \"normal\",<br>\n\"comparator\": [<br>\n\"eq\"<br>\n],<br>\n\"search\": {<br>\n\"mode\": \"match\"<br>\n}<br>\n}</p>\n<p>The SearchParameter is recognized by the server, but doesn't work (as intended).</p>\n<p>Searching:<br>\n1) <a href=\"http://hapi.fhir.org/baseR4/MedicationKnowledge?quantityLimit\" target=\"_blank\" title=\"http://hapi.fhir.org/baseR4/MedicationKnowledge?quantityLimit\">http://hapi.fhir.org/baseR4/MedicationKnowledge?quantityLimit</a> - returns two MedicationKnowledge objects... only one object has the quantityLimit extension, so this should return only one object, right?<br>\n2) http://hapi.fhir.org/baseR4/MedicationKnowledge?quantityLimit=\"true\" returns zero objects, but should return one object, right?</p>",
        "id": 166912370,
        "sender_full_name": "Saul Kravitz",
        "timestamp": 1559226527
    },
    {
        "content": "<p>That path doesn't look correct to me...</p>\n<div class=\"codehilite\"><pre><span></span>MedicationKnowledge.extension(\\&quot; https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-QuantityLimit-extension.valueBoolean \\&quot;\n</pre></div>\n\n\n<p>I would have expected something like</p>\n<div class=\"codehilite\"><pre><span></span>MedicationKnowledge.extension(&#39;https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-QuantityLimit-extension&#39;).value\n</pre></div>",
        "id": 166983292,
        "sender_full_name": "James Agnew",
        "timestamp": 1559296342
    },
    {
        "content": "<p>2nd try.   A colleague told me to test my FHIRPAth expressions in the fhirpath.js tool, so these expressions work on these resources on the command line.</p>\n<p>See <a href=\"http://hapi.fhir.org/baseR4/SearchParameter/drugTier\" target=\"_blank\" title=\"http://hapi.fhir.org/baseR4/SearchParameter/drugTier\">http://hapi.fhir.org/baseR4/SearchParameter/drugTier</a><br>\n<a href=\"http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK1\" target=\"_blank\" title=\"http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK1\">http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK1</a><br>\n<a href=\"http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK2\" target=\"_blank\" title=\"http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK2\">http://hapi.fhir.org/baseR4/MedicationKnowledge/SaulExperimentMK2</a><br>\n<a href=\"http://hapi.fhir.org/baseR4/MedicationKnowledge/cmsip9\" target=\"_blank\" title=\"http://hapi.fhir.org/baseR4/MedicationKnowledge/cmsip9\">http://hapi.fhir.org/baseR4/MedicationKnowledge/cmsip9</a> </p>\n<p>The expression has been tested on fhirpath:<br>\n~/git/fhirpath.js/bin/fhirpath --expression \"MedicationKnowledge.extension.where(url='https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-DrugTierID-extension').valueCodeableConcept.coding.code\" --resourceFile FormularyDrugcmsip9.json <br>\nfhirpath(MedicationKnowledge.extension.where(url='https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-DrugTierID-extension').valueCodeableConcept.coding.code) =&gt;<br>\n[<br>\n \"GENERIC\"<br>\n]</p>\n<p>The drugTier Search Parameter takes the most verbose (and likely to be supported approach).</p>\n<p>{<br>\n    \"resourceType\": \"SearchParameter\",<br>\n    \"id\": \"drugTier\",<br>\n    \"meta\": {<br>\n      \"versionId\": \"1\",<br>\n      \"lastUpdated\": \"2019-02-22T08:37:56.297+00:00\"<br>\n    },<br>\n    \"title\": \"drugTier\",<br>\n    \"status\": \"active\",<br>\n    \"code\": \"drugTier\",<br>\n    \"base\": [<br>\n      \"MedicationKnowledge\"<br>\n    ],<br>\n    \"type\": \"string\",<br>\n    \"expression\": \"MedicationKnowledge.extension.where(url='https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-DrugTierID-extension').valueCodeableConcept.coding.code\",<br>\n    \"comparator\": [<br>\n        \"eq\"<br>\n      ],<br>\n    \"search\": {<br>\n        \"mode\": \"exact\"<br>\n      }<br>\n  }</p>\n<p>The extensions look like this:<br>\n{<br>\n        \"url\": \"<a href=\"https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-DrugTierID-extension\" target=\"_blank\" title=\"https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-DrugTierID-extension\">https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-DrugTierID-extension</a>\",<br>\n        \"valueCodeableConcept\": {<br>\n          \"coding\": [<br>\n            {<br>\n              \"code\": \"GENERIC\",<br>\n              \"system\": \"<a href=\"https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/CodeSystem/usdrugformulary-DrugTierCS\" target=\"_blank\" title=\"https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/CodeSystem/usdrugformulary-DrugTierCS\">https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/CodeSystem/usdrugformulary-DrugTierCS</a>\",<br>\n              \"display\": \"GENERIC\"<br>\n            }<br>\n          ]<br>\n        }<br>\n      }</p>\n<p>GET <a href=\"http://hapi.fhir.org/baseR4/MedicationKnowledge?drugTier=GENERIC\" target=\"_blank\" title=\"http://hapi.fhir.org/baseR4/MedicationKnowledge?drugTier=GENERIC\">http://hapi.fhir.org/baseR4/MedicationKnowledge?drugTier=GENERIC</a>    returns nothing<br>\nGET <a href=\"http://hapi.fhir.org/baseR4/MedicationKnowledge?drugTier\" target=\"_blank\" title=\"http://hapi.fhir.org/baseR4/MedicationKnowledge?drugTier\">http://hapi.fhir.org/baseR4/MedicationKnowledge?drugTier</a>    returns all 3 MedicationKnowledge resources</p>\n<p>Am I configuring the searchParameter wrong, or is this a big?</p>",
        "id": 167040126,
        "sender_full_name": "Saul Kravitz",
        "timestamp": 1559341895
    },
    {
        "content": "<p>I responded to <span class=\"user-mention\" data-user-id=\"215604\">@Saul Kravitz</span> offline, but will include my response here for completeness and to spark any additional conversation or thoughts (if anyone has some).</p>\n<p>I’m not sure exactly what’s going on here, but here is something to try.  Usually code-based searches would use the “token” type and the expression need only resolve to the CodeableConcept.</p>\n<p>So try this:</p>\n<ul>\n<li>Change “type” to <code>\"token\"</code></li>\n<li>Change “expression” to <code>\"MedicationKnowledge.extension.where(url='https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-DrugTierID-extension').valueCodeableConcept\"</code></li>\n</ul>\n<p>In addition, looking at the R4 SearchParameter documentation, I don’t see “search.mode”.  Are you sure that isn’t supposed to be “modifier”?  So my last suggestion is:</p>\n<ul>\n<li>Replace <code>\"search\": { \"mode\": \"exact\" }</code> with <code>\"modifier\": [ \"exact\" ]</code></li>\n</ul>",
        "id": 167078018,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1559404743
    },
    {
        "content": "<p>I'm 70% sure you need <code>.value</code> in the expression and not <code>.valueCodeableConcept</code></p>",
        "id": 167095009,
        "sender_full_name": "James Agnew",
        "timestamp": 1559432541
    },
    {
        "content": "<p>y</p>",
        "id": 167109280,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1559459381
    },
    {
        "content": "<blockquote>\n<p>I'm 70% sure you need .value in the expression and not .valueCodeableConcept</p>\n</blockquote>\n<p>Ah.  Right.  That's probably true.  In that case I guess it's worth noting that <a href=\"https://github.com/HL7/fhirpath.js\" target=\"_blank\" title=\"https://github.com/HL7/fhirpath.js\">fhirpath.js</a> happily worked with <code>valueCodeableConcept</code>.</p>",
        "id": 167141540,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1559514402
    },
    {
        "content": "<p>Made all of the suggested changes...still not working (<a href=\"http://hapi.fhir.org/baseR4/MedicationKnowledge?drugTier=BRAND\" target=\"_blank\" title=\"http://hapi.fhir.org/baseR4/MedicationKnowledge?drugTier=BRAND\">http://hapi.fhir.org/baseR4/MedicationKnowledge?drugTier=BRAND</a> returns 0 results).</p>\n<p>One oddity is that when I PUT:<br>\n{<br>\n    \"resourceType\": \"SearchParameter\",<br>\n    \"id\": \"drugTier\",<br>\n    \"meta\": {<br>\n      \"versionId\": \"1\",<br>\n      \"lastUpdated\": \"2019-02-22T08:37:56.297+00:00\"<br>\n    },<br>\n    \"title\": \"drugTier\",<br>\n    \"status\": \"active\",<br>\n    \"code\": \"drugTier\",<br>\n    \"base\": [<br>\n      \"MedicationKnowledge\"<br>\n    ],<br>\n    \"type\": \"token\",<br>\n    \"expression\": \"MedicationKnowledge.extension.where(url='https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-DrugTierID-extension').value\",<br>\n    \"comparator\": [<br>\n        \"eq\"<br>\n      ],<br>\n    \"modifier\": {<br>\n        mode:\"exact\"<br>\n      }<br>\n  }</p>\n<p>The \"modifier gets lost\"... here is GET of the same resource:<br>\n{<br>\n    \"resourceType\": \"SearchParameter\",<br>\n    \"id\": \"drugTier\",<br>\n    \"meta\": {<br>\n        \"versionId\": \"12\",<br>\n        \"lastUpdated\": \"2019-06-03T03:32:55.073+00:00\"<br>\n    },<br>\n    \"title\": \"drugTier\",<br>\n    \"status\": \"active\",<br>\n    \"code\": \"drugTier\",<br>\n    \"base\": [<br>\n        \"MedicationKnowledge\"<br>\n    ],<br>\n    \"type\": \"token\",<br>\n    \"expression\": \"MedicationKnowledge.extension.where(url='https://api-v8-r4.hspconsortium.org/DrugFormulary2/open/StructureDefinition/usdrugformulary-DrugTierID-extension').value\",<br>\n    \"comparator\": [<br>\n        \"eq\"<br>\n    ]<br>\n}</p>",
        "id": 167152564,
        "sender_full_name": "Saul Kravitz",
        "timestamp": 1559533297
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"215604\">@Saul Kravitz</span> -- I think <code>modifier</code> needs to be an array.  So:</p>\n<div class=\"codehilite\"><pre><span></span>&quot;modifier&quot;: [ &quot;exact&quot; ]\n</pre></div>",
        "id": 167182249,
        "sender_full_name": "Chris Moesel",
        "timestamp": 1559563898
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"215604\">@Saul Kravitz</span> your search parameter appears to work for me:</p>\n<p><a href=\"http://hapi.fhir.org/baseR4/MedicationKnowledge?drugTier=GENERIC\" target=\"_blank\" title=\"http://hapi.fhir.org/baseR4/MedicationKnowledge?drugTier=GENERIC\">http://hapi.fhir.org/baseR4/MedicationKnowledge?drugTier=GENERIC</a></p>",
        "id": 167187157,
        "sender_full_name": "James Agnew",
        "timestamp": 1559567329
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span> and <span class=\"user-mention\" data-user-id=\"191469\">@Chris Moesel</span></p>",
        "id": 167192199,
        "sender_full_name": "Saul Kravitz",
        "timestamp": 1559570360
    },
    {
        "content": "<blockquote>\n<blockquote>\n<p>I'm 70% sure you need .value in the expression and not .valueCodeableConcept</p>\n</blockquote>\n<p>Ah.  Right.  That's probably true.  In that case I guess it's worth noting that <a href=\"https://github.com/HL7/fhirpath.js\" target=\"_blank\" title=\"https://github.com/HL7/fhirpath.js\">fhirpath.js</a> happily worked with <code>valueCodeableConcept</code>.</p>\n</blockquote>\n<p>Yes, that is a shortcoming of fhirpath.js-- it does not know about choice types (yet).  For some discussion on that, see <a href=\"#narrow/stream/179266-fhirpath/topic/Paths.20for.20choice.20types\" title=\"#narrow/stream/179266-fhirpath/topic/Paths.20for.20choice.20types\">https://chat.fhir.org/#narrow/stream/179266-fhirpath/topic/Paths.20for.20choice.20types</a>.</p>",
        "id": 167210133,
        "sender_full_name": "Paul Lynch",
        "timestamp": 1559581369
    },
    {
        "content": "<p>I do not think it should know about this until we fix FHIR json format :)</p>\n<p>choice types can (or should) be serialized as <code> {value: {Quantity: ....}}</code> and this will eliminate all of these problems</p>",
        "id": 167351543,
        "sender_full_name": "nicola (RIO/SS)",
        "timestamp": 1559700366
    },
    {
        "content": "<p>you have to be realistic - we will not be changing the json format.</p>",
        "id": 167373220,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1559728254
    },
    {
        "content": "<p>yes, you can define a second json format, but it will be voted down and no one will implement it</p>",
        "id": 167373238,
        "sender_full_name": "Grahame Grieve",
        "timestamp": 1559728274
    }
]