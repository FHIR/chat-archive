[
    {
        "content": "<p>Hi!<br>\nDuring the java session today I asked why my contained resources did not appear when JSON serialising and got the answer that they have to be referenced properly with their ID to appear. Thanks for the help <span class=\"user-mention\" data-user-id=\"191451\">@Patrick Werner</span>  and <span class=\"user-mention\" data-user-id=\"191319\">@James Agnew</span> ! I tried doing this, but they still don't appear. Excerpt from my code:</p>\n<div class=\"codehilite\"><pre><span></span><code>var module1 = new ActivityDefinition()\n    .setKind(ActivityDefinition.ActivityDefinitionKind.TASK)\n    .setUrl(&quot;url/to/module1&quot;);\nmodule1.setId(&quot;idForModue1&quot;);\n\nvar planDefinition = new PlanDefinition();\n\nvar module1action =\n    new PlanDefinition.PlanDefinitionActionComponent()\n        .setDescription(&quot;module1&quot;)\n        .setDefinition(new UriType(module1.getId())); //using uri instead of canonical\nplanDefinition.addAction(module1action);\n\nplanDefinition.setContained(List.of(module1));\n</code></pre></div>\n\n<p>And this is my output, without any contained:<br>\n{<br>\n  \"resourceType\": \"PlanDefinition\",<br>\n  \"action\": [ {<br>\n    \"description\": \"module1\",<br>\n    \"definitionUri\": \"idForModue1\"<br>\n  } ]<br>\n}</p>\n<p>If this is described in the standard or the HAPI docs, please just refer me to the right place in the docs.</p>",
        "id": 217427629,
        "sender_full_name": "Håkan MacLean",
        "timestamp": 1605891004
    },
    {
        "content": "<p>I have the same problem. I'm trying to include a Provenance Resource in the contained list. Procedure doesn't reference it, Provenance references the procedure. However, this is supposed to work. All items in the contained list must either reference the parent or be referenced by the parent. <br>\nI'm using 5.1.0 of hapi. Here is a test that fails. a serialized bundle that has Procedure w/Provenance. When it is deserialized the Procedure object does have the Provenance, but when re-serialized it does not. Java:<br>\n    private String serializedBundle = \"{\\n\" +<br>\n            \"  \\\"resourceType\\\": \\\"Bundle\\\",\\n\" +<br>\n            \"  \\\"id\\\": \\\"401cc9a2-5f81-4806-8f33-fbf80e94bed3\\\",\\n\" +<br>\n            \"  \\\"meta\\\": {\\n\" +<br>\n            \"    \\\"lastUpdated\\\": \\\"2020-11-20T11:38:36.350-08:00\\\"\\n\" +<br>\n            \"  },\\n\" +<br>\n            \"  \\\"type\\\": \\\"searchset\\\",\\n\" +<br>\n            \"  \\\"total\\\": 1,\\n\" +<br>\n            \"  \\\"link\\\": [\\n\" +<br>\n            \"    {\\n\" +<br>\n            \"      \\\"relation\\\": \\\"self\\\",\\n\" +<br>\n            \"      \\\"url\\\": \\\"http://localhost:8083/R4/Procedure?_id=100&amp;_revinclude=Provenance%3Atarget\\\"\\n\" +<br>\n            \"    }\\n\" +<br>\n            \"  ],\\n\" +<br>\n            \"  \\\"entry\\\": [\\n\" +<br>\n            \"    {\\n\" +<br>\n            \"      \\\"fullUrl\\\": \\\"http://localhost:8083/R4/Procedure/100\\\",\\n\" +<br>\n            \"      \\\"resource\\\": {\\n\" +<br>\n            \"        \\\"resourceType\\\": \\\"Procedure\\\",\\n\" +<br>\n            \"        \\\"id\\\": \\\"100\\\",\\n\" +<br>\n            \"        \\\"meta\\\": {\\n\" +<br>\n            \"          \\\"lastUpdated\\\": \\\"2020-10-29T12:34:55.124Z\\\"\\n\" +<br>\n            \"        },\\n\" +<br>\n            \"        \\\"contained\\\": [\\n\" +<br>\n            \"          {\\n\" +<br>\n            \"            \\\"resourceType\\\": \\\"Practitioner\\\",\\n\" +<br>\n            \"            \\\"id\\\": \\\"2\\\",\\n\" +<br>\n            \"            \\\"identifier\\\": [\\n\" +<br>\n            \"              {\\n\" +<br>\n            \"                \\\"system\\\": \\\"http://hl7.org/fhir/sid/us-npi\\\",\\n\" +<br>\n            \"                \\\"value\\\": \\\"ctc123\\\"\\n\" +<br>\n            \"              }\\n\" +<br>\n            \"            ]\\n\" +<br>\n            \"          },\\n\" +<br>\n            \"          {\\n\" +<br>\n            \"            \\\"resourceType\\\": \\\"Provenance\\\",\\n\" +<br>\n            \"            \\\"id\\\": \\\"1\\\",\\n\" +<br>\n            \"            \\\"target\\\": [\\n\" +<br>\n            \"              {\\n\" +<br>\n            \"                \\\"reference\\\": \\\"Procedure/100\\\"\\n\" +<br>\n            \"              }\\n\" +<br>\n            \"            ],\\n\" +<br>\n            \"            \\\"recorded\\\": \\\"2020-10-29T12:34:55.124Z\\\",\\n\" +<br>\n            \"            \\\"agent\\\": [\\n\" +<br>\n            \"              {\\n\" +<br>\n            \"                \\\"type\\\": {\\n\" +<br>\n            \"                  \\\"coding\\\": [\\n\" +<br>\n            \"                    {\\n\" +<br>\n            \"                      \\\"system\\\": \\\"http://terminology.hl7.org/CodeSystem/provenance-participant-type\\\",\\n\" +<br>\n            \"                      \\\"code\\\": \\\"informant\\\",\\n\" +<br>\n            \"                      \\\"display\\\": \\\"informant\\\"\\n\" +<br>\n            \"                    }\\n\" +<br>\n            \"                  ]\\n\" +<br>\n            \"                },\\n\" +<br>\n            \"                \\\"who\\\": {\\n\" +<br>\n            \"                  \\\"reference\\\": \\\"#2\\\"\\n\" +<br>\n            \"                }\\n\" +<br>\n            \"              }\\n\" +<br>\n            \"            ]\\n\" +<br>\n            \"          }\\n\" +<br>\n            \"        ],\\n\" +<br>\n            \"        \\\"status\\\": \\\"unknown\\\",\\n\" +<br>\n            \"        \\\"code\\\": {\\n\" +<br>\n            \"          \\\"coding\\\": [\\n\" +<br>\n            \"            {\\n\" +<br>\n            \"              \\\"system\\\": \\\"http://terminology.lh7.org/CodeSystem/claim-type\\\",\\n\" +<br>\n            \"              \\\"code\\\": \\\"institutional\\\",\\n\" +<br>\n            \"              \\\"display\\\": \\\"Institutional Display\\\"\\n\" +<br>\n            \"            }\\n\" +<br>\n            \"          ]\\n\" +<br>\n            \"        },\\n\" +<br>\n            \"        \\\"subject\\\": {\\n\" +<br>\n            \"          \\\"reference\\\": \\\"Patient/551261670\\\"\\n\" +<br>\n            \"        },\\n\" +<br>\n            \"        \\\"performedDateTime\\\": \\\"2020-10-29T12:34:55.124Z\\\"\\n\" +<br>\n            \"      }\\n\" +<br>\n            \"    }\\n\" +<br>\n            \"  ]\\n\" +<br>\n            \"}\\n\";</p>\n<div class=\"codehilite\"><pre><span></span><code>@Test\npublic void testContainedProvenance() {\n    FhirContext context = FhirContext.forR4();\n    IParser parser = context.newJsonParser();\n\n    Bundle b = (Bundle) parser.parseResource(serializedBundle);\n\n    String s = parser.encodeResourceToString(b); //&lt;- this excludes the Provenance\n}\n</code></pre></div>",
        "id": 217457249,
        "sender_full_name": "Daniel Venton",
        "timestamp": 1605905527
    },
    {
        "content": "<p>Interesting enough, although I think conceptually wrong, if I set the provenance resource to target itself, then it is included in the output.<br>\n            \"            \\\"target\\\": [\\n\" +<br>\n            \"              {\\n\" +<br>\n            \"                \\\"reference\\\": \\\"#1\\\"\\n\" +<br>\n            \"              },\\n\" +<br>\n            \"              {\\n\" +<br>\n            \"                \\\"reference\\\": \\\"Procedure/100\\\"\\n\" +<br>\n            \"              }\\n\" +<br>\n            \"            ],\\n\" +</p>",
        "id": 217458410,
        "sender_full_name": "Daniel Venton",
        "timestamp": 1605906248
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"364590\">@Håkan MacLean</span> <br>\nYou are still mixing up canonical urls with urls. ActivityDefinition.url is a canonical url.</p>",
        "id": 217549826,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1606049206
    },
    {
        "content": "<p>But i tested it with Canonical as well, was not working.</p>",
        "id": 217550468,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1606050302
    },
    {
        "content": "<p>Possibly this is a bug, as canonicals were introduced after references.</p>",
        "id": 217550625,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1606050522
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"335936\">@Daniel Venton</span> please format your code properly, it is very hard to read and help in this form.<br>\nJust had a quick look. Provenance wants to reference to Procedure, this is done via the reference string: <code>#</code></p>",
        "id": 217550999,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1606051202
    },
    {
        "content": "<p>But even with <code>#</code>it isn't working.</p>",
        "id": 217551039,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1606051221
    },
    {
        "content": "<blockquote>\n<p>Resources can only be contained in other resources if there is a reference from the resource to the contained resource, or if the contained resource references the container resource. This is intended to ensure that the meaning of the contained resource is clear, and that there is no confusion as to its significance.<br>\nFor a resource that references the container, the reference is \"#\"</p>\n</blockquote>\n<p><a href=\"https://www.hl7.org/fhir/references.html#contained\">https://www.hl7.org/fhir/references.html#contained</a></p>",
        "id": 217551050,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1606051248
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191451\">Patrick Werner</span> <a href=\"#narrow/stream/179167-hapi/topic/setting.20contained.20resources/near/217549826\">said</a>:</p>\n<blockquote>\n<p>You are still mixing up canonical urls with urls. ActivityDefinition.url is a canonical url.</p>\n</blockquote>\n<p>Thank you for taking the time to look into this <span class=\"user-mention\" data-user-id=\"191451\">@Patrick Werner</span> , really appreciate it! However I'm still confused since I'm not actually using the ActivityDefintion.url for anything atm. <br>\nCurrently, I'm referencing the <a href=\"http://ActivityDefinition.id\">ActivityDefinition.id</a> (not url!) from PlanDefinition.action.definition. I also tried adding a # before the id, but that made no difference. See code below:</p>\n<div class=\"codehilite\"><pre><span></span><code>var module1 = new ActivityDefinition()\n    .setKind(ActivityDefinition.ActivityDefinitionKind.TASK);\nmodule1.setId(&quot;idForModue1&quot;);\n\nvar planDefinition = new PlanDefinition();\n\nvar module1action =\n    new PlanDefinition.PlanDefinitionActionComponent()\n        .setDescription(&quot;module1&quot;)\n        .setDefinition(new UriType(&quot;#&quot; + module1.getId()));\nplanDefinition.addAction(module1action);\nplanDefinition.setContained(List.of(module1))\n</code></pre></div>\n\n<p>And output:<br>\n{<br>\n  \"resourceType\": \"PlanDefinition\",<br>\n  \"action\": [ {<br>\n    \"description\": \"module1\",<br>\n    \"definitionUri\": \"#idForModue1\"<br>\n  } ]<br>\n}</p>\n<p>Is it perhaps so that PlanDefinition.action.definition does not \"count\" as a reference somehow?  I also recall you mentioned using the actual java object when creating a reference, but I never got that to work either. I tried:<br>\n<code>.setDefinition(new Reference(module1))</code><br>\nBut then I get a runtime error since Reference is not of type CanonicalType or UriType. </p>\n<p>Or if you know of a working example somewhere perhaps I could look at it and debug the HAPI source code do find out how I should do it.</p>",
        "id": 217567973,
        "sender_full_name": "Håkan MacLean",
        "timestamp": 1606076380
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191451\">Patrick Werner</span> <a href=\"#narrow/stream/179167-hapi/topic/setting.20contained.20resources/near/217550999\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"335936\">Daniel Venton</span> please format your code properly, it is very hard to read and help in this form.<br>\nJust had a quick look. Provenance wants to reference to Procedure, this is done via the reference string: <code>#</code></p>\n</blockquote>\n<p>It was formatted correctly until zulip got ahold of it, perhaps there is a code markup that I'm unaware of.</p>",
        "id": 217630163,
        "sender_full_name": "Daniel Venton",
        "timestamp": 1606139838
    }
]