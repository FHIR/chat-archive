[
    {
        "content": "<p>Hello!</p>\n<p>I’m using HAPI FHIR 4.2.0 with R4. I’m trying to validate a ServiceRequest resource with an occurenceTiming child. However, the Timing.repeat.periodUnit element always fails with this error:</p>\n<div class=\"codehilite\"><pre><span></span><code>The value provided (&#39;wk&#39;) is not in the value set http://hl7.org/fhir/ValueSet/units-of-time|4.0.0\n(http://hl7.org/fhir/ValueSet/units-of-time, and a code is required from this value set)\n(error message = Unknown code[wk] in system[(none)]) -\nServiceRequest.occurrence.ofType(Timing).repeat.periodUnit\n</code></pre></div>\n<p>The weird thing about this is that the value “wk” is most certainly in the ValueSet units-of-time, which includes (s, min, h, d, wk, mo, and a). But after doing some hard-core debugging, I noticed that the code was not able to expand the valueset’s values. The actual code validation was happening in the method org.hl7.fhir.r4.hapi.ctx.DefaultProfileValidationSupport#validateCode. While the value set name was in fact recognized as a valid valueset, the contents of that value were empty. Programmatically, that meant that:</p>\n<div class=\"codehilite\" data-code-language=\"Java\"><pre><span></span><code><span class=\"k\">new</span> <span class=\"n\">ValueSetExpanderSimple</span><span class=\"p\">(</span><span class=\"k\">new</span> <span class=\"n\">HapiWorkerContext</span><span class=\"p\">(</span><span class=\"n\">theContext</span><span class=\"p\">,</span> <span class=\"k\">this</span><span class=\"p\">)).</span><span class=\"na\">expand</span><span class=\"p\">(</span><span class=\"n\">fetchValueSet</span><span class=\"p\">(</span><span class=\"n\">theContext</span><span class=\"p\">,</span> <span class=\"s\">\"http://hl7.org/fhir/ValueSet/units-of-time\"</span><span class=\"p\">),</span> <span class=\"kc\">null</span><span class=\"p\">).</span><span class=\"na\">getValueset</span><span class=\"p\">().</span><span class=\"na\">getExpansion</span><span class=\"p\">().</span><span class=\"na\">getContains</span><span class=\"p\">()</span>\n</code></pre></div>\n<p>was an empty list. But when I tested this with other valuesets they worked just fine, expanding to the correct set of codes.</p>\n<p>Is this a bug in the HAPI FHIR validation code? If so, it kind of defeats the purpose of validation… Could I have set up the validation wrong? Maybe there is some setting that I need to change? Here is the code that does the validation:</p>\n<div class=\"codehilite\" data-code-language=\"Java\"><pre><span></span><code><span class=\"n\">FhirValidator</span> <span class=\"n\">validator</span> <span class=\"o\">=</span> <span class=\"n\">ctx</span><span class=\"p\">.</span><span class=\"na\">newValidator</span><span class=\"p\">();</span>\n<span class=\"n\">validator</span><span class=\"p\">.</span><span class=\"na\">registerValidatorModule</span><span class=\"p\">(</span><span class=\"k\">new</span> <span class=\"n\">FhirInstanceValidator</span><span class=\"p\">(</span><span class=\"k\">new</span> <span class=\"n\">DefaultProfileValidationSupport</span><span class=\"p\">()));</span>\n<span class=\"n\">ValidationResult</span> <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">validator</span><span class=\"p\">.</span><span class=\"na\">validateWithResult</span><span class=\"p\">(</span><span class=\"n\">fhirResource</span><span class=\"p\">);</span>\n<span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">result</span><span class=\"p\">.</span><span class=\"na\">isSuccessful</span><span class=\"p\">())</span> <span class=\"p\">{</span>\n  <span class=\"k\">throw</span> <span class=\"k\">new</span> <span class=\"n\">RuntimeException</span><span class=\"p\">(</span><span class=\"s\">\"FHIR output is non-compliant: \\n\\t- \"</span>\n      <span class=\"o\">+</span> <span class=\"n\">result</span><span class=\"p\">.</span><span class=\"na\">getMessages</span><span class=\"p\">().</span><span class=\"na\">stream</span><span class=\"p\">().</span><span class=\"na\">map</span><span class=\"p\">(</span><span class=\"n\">m</span> <span class=\"o\">-&gt;</span> <span class=\"n\">m</span><span class=\"p\">.</span><span class=\"na\">getMessage</span><span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"s\">\" - \"</span> <span class=\"o\">+</span> <span class=\"n\">m</span><span class=\"p\">.</span><span class=\"na\">getLocationString</span><span class=\"p\">())</span>\n      <span class=\"p\">.</span><span class=\"na\">collect</span><span class=\"p\">(</span><span class=\"n\">Collectors</span><span class=\"p\">.</span><span class=\"na\">joining</span><span class=\"p\">(</span><span class=\"s\">\"\\n\\t- \"</span><span class=\"p\">)));</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Any advice or ideas would be helpful!</p>",
        "id": 232765137,
        "sender_full_name": "Asher Bernardi",
        "timestamp": 1617287142
    },
    {
        "content": "<p>I can't speak to why the value set wasn't fetched, but I do notice, \"(error message = Unknown code[wk] in system[(<strong>none</strong>)]) -\"<br>\nDid you populate the corresponding system in your resource, \"<a href=\"http://unitsofmeasure.org\">http://unitsofmeasure.org</a>\"</p>",
        "id": 232766044,
        "sender_full_name": "Daniel Venton",
        "timestamp": 1617287474
    },
    {
        "content": "<p>I shouldn't have to, since the value of Timing.repeat.periodUnit is a code that must be of that value set. There is nowhere to populate a valueset in that resource:<br>\n<a href=\"/user_uploads/10155/RlrIL0BAhh76fc6Y_qG_oX3r/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/RlrIL0BAhh76fc6Y_qG_oX3r/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/RlrIL0BAhh76fc6Y_qG_oX3r/image.png\"></a></div>",
        "id": 232766811,
        "sender_full_name": "Asher Bernardi",
        "timestamp": 1617287717
    }
]