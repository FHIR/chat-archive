[
    {
        "content": "<p>I'm attempting to upgrade HAPI from 3.0.0 -&gt; 3.7.0 and I have a failing test due to an issue with xml entities in narrative</p>\n<p>Given this example:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"p\">{</span>\n  <span class=\"nt\">&quot;resourceType&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;Patient&quot;</span><span class=\"p\">,</span>\n  <span class=\"nt\">&quot;id&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;example&quot;</span><span class=\"p\">,</span>\n  <span class=\"nt\">&quot;text&quot;</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n    <span class=\"nt\">&quot;status&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;generated&quot;</span><span class=\"p\">,</span>\n    <span class=\"nt\">&quot;div&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;&lt;div xmlns=\\&quot;http://www.w3.org/1999/xhtml\\&quot;&gt;Â©&lt;/div&gt;&quot;</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</pre></div>\n\n\n<p>I can parse it, but when re-encoding the narrative is turned into:</p>\n<div class=\"codehilite\"><pre><span></span>&quot;&lt;div xmlns=\\&quot;http://www.w3.org/1999/xhtml\\&quot;&gt;&amp;copy;&lt;/div&gt;&quot;\n</pre></div>\n\n\n<p>Then when attempting to parse that, I get:</p>\n<div class=\"codehilite\"><pre><span></span>ca.uhn.fhir.parser.DataFormatException: String does not appear to be valid XML/XHTML (error is &quot;ParseError at [row,col]:[1,49]\nMessage: The entity &quot;copy&quot; was referenced, but not declared.&quot;): &lt;div xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;&amp;copy;&lt;/div&gt;\n  at ca.uhn.fhir.util.XmlUtil.parse(XmlUtil.java:1748)\n  at ca.uhn.fhir.model.primitive.XhtmlDt.parse(XhtmlDt.java:83)\n  at ca.uhn.fhir.model.primitive.XhtmlDt.parse(XhtmlDt.java:41)\n  at ca.uhn.fhir.model.api.BasePrimitive.setValueAsString(BasePrimitive.java:111)\n  at ca.uhn.fhir.model.primitive.XhtmlDt.setValueAsString(XhtmlDt.java:132)\n  at ca.uhn.fhir.parser.ParserState$XhtmlState.attributeValue(ParserState.java:1530)\n  at ca.uhn.fhir.parser.ParserState.attributeValue(ParserState.java:66)\n  at ca.uhn.fhir.parser.JsonParser.parseChildren(JsonParser.java:1033)\n  at ca.uhn.fhir.parser.JsonParser.parseChildren(JsonParser.java:938)\n  at ca.uhn.fhir.parser.JsonParser.parseChildren(JsonParser.java:1021)\n  at ca.uhn.fhir.parser.JsonParser.parseChildren(JsonParser.java:938)\n  at ca.uhn.fhir.parser.JsonParser.doParseResource(JsonParser.java:183)\n  at ca.uhn.fhir.parser.JsonParser.doParseResource(JsonParser.java:165)\n  at ca.uhn.fhir.parser.BaseParser.parseResource(BaseParser.java:648)\n  at ca.uhn.fhir.parser.BaseParser.parseResource(BaseParser.java:697)\n  at ca.uhn.fhir.parser.BaseParser.parseResource(BaseParser.java:707)\n  ... 28 elided\nCaused by: javax.xml.stream.XMLStreamException: ParseError at [row,col]:[1,49]\nMessage: The entity &quot;copy&quot; was referenced, but not declared.\n  at com.sun.org.apache.xerces.internal.impl.XMLStreamReaderImpl.next(XMLStreamReaderImpl.java:604)\n  at com.sun.xml.internal.stream.XMLEventReaderImpl.nextEvent(XMLEventReaderImpl.java:83)\n  at ca.uhn.fhir.util.XmlUtil.parse(XmlUtil.java:1735)\n  ... 43 more\n</pre></div>\n\n\n<p>(this is stu3)</p>",
        "id": 159908461,
        "sender_full_name": "Ben Spencer",
        "timestamp": 1551702182
    }
]