[
    {
        "content": "<p>I just tried to run the \"official\" hapi docker image with an external configuration file:<br>\n<code>docker run -p 8080:8080 -e \"spring.config.location=file:/data/hapi/application.yaml\" patrick/test</code></p>",
        "id": 269718101,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1643367531
    },
    {
        "content": "<p>My image is just derived from hapifhir/hapi and includes a new application.yaml &amp; package.tgz.</p>\n<p>I tried to add an IG through the external config file. Which failed. After some debugging i came to the conclusion, that this only overwrites the <code>spring:</code>part of the application.yaml</p>",
        "id": 269718427,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1643367675
    },
    {
        "content": "<p>changing the DB path works, the hapi: part of the configuration is ignored.</p>",
        "id": 269718557,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1643367724
    },
    {
        "content": "<p>can i also overwrite the hapi: part with docker?</p>",
        "id": 269718588,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1643367740
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191427\">@Jens Villadsen</span> ?</p>",
        "id": 269718614,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1643367755
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191451\">@Patrick Werner</span>  Yes you can</p>",
        "id": 269721445,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1643369295
    },
    {
        "content": "<p>Have you tried loading it with the official image?</p>",
        "id": 269721519,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1643369343
    },
    {
        "content": "<p>Anything defined in the application.yaml file supplied by you is what is evaluated</p>",
        "id": 269721569,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1643369378
    },
    {
        "content": "<p>if i change smth in the <code>spring:</code> part of the external config file -&gt; it works, the hapi bit seems to be ignored. Will try it with the official image</p>",
        "id": 269723327,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1643370462
    },
    {
        "content": "<p>just tested it with the offical docker image:<br>\n`docker run -p 8080:8080 -v ~/Downloads/configs:/configs -e \"--spring.config.location=file:///configs/application.yaml\" hapiproject/hapi:latest``</p>",
        "id": 269725578,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1643371626
    },
    {
        "content": "<p>the config folder is mounted inside the docker container correctly, <code>spring:</code>settings are overwritten/applied</p>",
        "id": 269725646,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1643371671
    },
    {
        "content": "<p>all the <code>hapi:</code>properties are not read from the external file</p>",
        "id": 269725722,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1643371697
    },
    {
        "content": "<p>(i added an IG to the config, which isn't loaded, not tried to be loaded)</p>",
        "id": 269725755,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1643371726
    },
    {
        "content": "<p>Can you submit your applikation.yaml file here?</p>",
        "id": 269726762,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1643372292
    },
    {
        "content": "<p>sure: <a href=\"/user_uploads/10155/jmWXFVxLf0yRQGsHqzWfx-uR/application.yaml\">application.yaml</a> application.yaml</p>",
        "id": 269727290,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1643372591
    },
    {
        "content": "<p>the referenced ig file isn't available in the official image, but hapi doesn't throw an error not finding it. So this setting seems to be ignored.<br>\nI also changed to db path to ./test - which is picked up by hapi.</p>",
        "id": 269727460,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1643372681
    },
    {
        "content": "<p>hmmm ... yeah this is a bug - it looks like we don't fail fast (at least fail fast enough here)</p>",
        "id": 269780652,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1643394592
    },
    {
        "content": "<p>Hmmm ... <span class=\"user-mention\" data-user-id=\"191451\">@Patrick Werner</span> if you go to eg. <a href=\"http://localhost:8090/conformance?serverId=home&amp;pretty=false&amp;_summary=\">http://localhost:8090/conformance?serverId=home&amp;pretty=false&amp;_summary=</a> after the server is started you should see something like the following:</p>\n<p><a href=\"/user_uploads/10155/_rL5y8Bb8bmu9bh9FAgTZtab/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/10155/_rL5y8Bb8bmu9bh9FAgTZtab/image.png\" title=\"image.png\"><img src=\"/user_uploads/10155/_rL5y8Bb8bmu9bh9FAgTZtab/image.png\"></a></div>",
        "id": 269893267,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1643495817
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>&lt;!doctype html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt;&lt;title&gt;HTTP Status 500 – Internal Server Error&lt;/title&gt;&lt;style type=&quot;text/css&quot;&gt;body {font-family:Tahoma,Arial,sans-serif;} h1, h2, h3, b {color:white;background-color:#525D76;} h1 {font-size:22px;} h2 {font-size:16px;} h3 {font-size:14px;} p {font-size:12px;} a {color:black;} .line {height:1px;background-color:#525D76;border:none;}&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;HTTP Status 500 – Internal Server Error&lt;/h1&gt;&lt;hr class=&quot;line&quot; /&gt;&lt;p&gt;&lt;b&gt;Type&lt;/b&gt; Exception Report&lt;/p&gt;&lt;p&gt;&lt;b&gt;Message&lt;/b&gt; Servlet.init() for servlet [jpaRestfulServer] threw exception&lt;/p&gt;&lt;p&gt;&lt;b&gt;Description&lt;/b&gt; The server encountered an unexpected condition that prevented it from fulfilling the request.&lt;/p&gt;&lt;p&gt;&lt;b&gt;Exception&lt;/b&gt;&lt;/p&gt;&lt;pre&gt;javax.servlet.ServletException: Servlet.init() for servlet [jpaRestfulServer] threw exception\n    org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:540)\n    org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:92)\n    org.apache.catalina.valves.AbstractAccessLogValve.invoke(AbstractAccessLogValve.java:687)\n    org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:357)\n    org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:382)\n    org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:65)\n    org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:893)\n    org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1726)\n    org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49)\n    org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1191)\n    org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:659)\n    org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\n    java.base&amp;#47;java.lang.Thread.run(Thread.java:829)\n&lt;/pre&gt;&lt;p&gt;&lt;b&gt;Root Cause&lt;/b&gt;&lt;/p&gt;&lt;pre&gt;ca.uhn.fhir.rest.server.exceptions.InternalErrorException: Error loading &amp;quot;file:&amp;#47;&amp;#47;&amp;#47;data&amp;#47;hapi&amp;#47;packages&amp;#47;de.basisprofil.r4-1.2.0.tgz&amp;quot;: URI does not specify a valid host name: file:&amp;#47;&amp;#47;&amp;#47;data&amp;#47;hapi&amp;#47;packages&amp;#47;de.basisprofil.r4-1.2.0.tgz\n    ca.uhn.fhir.jpa.packages.JpaPackageCache.loadPackageUrlContents(JpaPackageCache.java:488)\n    ca.uhn.fhir.jpa.packages.JpaPackageCache.installPackage(JpaPackageCache.java:455)\n    ca.uhn.fhir.jpa.packages.JpaPackageCache$$FastClassBySpringCGLIB$$fadb1509.invoke(&amp;lt;generated&amp;gt;)\n    org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:218)\n    org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.invokeJoinpoint(CglibAopProxy.java:783)\n    org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163)\n    org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:753)\n    org.springframework.transaction.interceptor.TransactionInterceptor$1.proceedWithInvocation(TransactionInterceptor.java:123)\n    org.springframework.transaction.interceptor.TransactionAspectSupport.invokeWithinTransaction(TransactionAspectSupport.java:388)\n    org.springframework.transaction.interceptor.TransactionInterceptor.invoke(TransactionInterceptor.java:119)\n    org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)\n    org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:753)\n    org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:698)\n    ca.uhn.fhir.jpa.packages.JpaPackageCache$$EnhancerBySpringCGLIB$$78dd4eb7.installPackage(&amp;lt;generated&amp;gt;)\n    ca.uhn.fhir.jpa.packages.PackageInstallerSvcImpl.install(PackageInstallerSvcImpl.java:168)\n    ca.uhn.fhir.jpa.starter.BaseJpaRestfulServer.initialize(BaseJpaRestfulServer.java:403)\n    ca.uhn.fhir.jpa.starter.JpaRestfulServer.initialize(JpaRestfulServer.java:22)\n    ca.uhn.fhir.rest.server.RestfulServer.init(RestfulServer.java:1346)\n    javax.servlet.GenericServlet.init(GenericServlet.java:158)\n    org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:540)\n    org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:92)\n    org.apache.catalina.valves.AbstractAccessLogValve.invoke(AbstractAccessLogValve.java:687)\n    org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:357)\n    org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:382)\n    org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:65)\n    org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:893)\n    org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1726)\n    org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49)\n    org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1191)\n    org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:659)\n    org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\n    java.base&amp;#47;java.lang.Thread.run(Thread.java:829)\n&lt;/pre&gt;&lt;p&gt;&lt;b&gt;Note&lt;/b&gt; The full stack trace of the root cause is available in the server logs.&lt;/p&gt;&lt;hr class=&quot;line&quot; /&gt;&lt;h3&gt;Apache Tomcat/9.0.53&lt;/h3&gt;&lt;/body&gt;&lt;/html&gt;\n</code></pre></div>",
        "id": 269893281,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1643495839
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"191451\">@Patrick Werner</span> looking at <a href=\"https://github.com/hapifhir/hapi-fhir/blob/aafc42fdd81c55fb5c5a61a7f5d6466725ac8380/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/packages/JpaPackageCache.java#L473\">https://github.com/hapifhir/hapi-fhir/blob/aafc42fdd81c55fb5c5a61a7f5d6466725ac8380/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/packages/JpaPackageCache.java#L473</a> I don't see the <code>file</code>-protocol being supported. That would need a PR in hapifhir project</p>",
        "id": 269893551,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1643496195
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"191427\">Jens Villadsen</span> <a href=\"#narrow/stream/179167-hapi/topic/.5Bproblem.5D.20externalize.20properties.20docker/near/269893267\">said</a>:</p>\n<blockquote>\n<p>Hmmm ... <span class=\"user-mention silent\" data-user-id=\"191451\">Patrick Werner</span> if you go to eg. <a href=\"http://localhost:8090/conformance?serverId=home&amp;pretty=false&amp;_summary=\">http://localhost:8090/conformance?serverId=home&amp;pretty=false&amp;_summary=</a> after the server is started you should see something like the following:</p>\n<p><a href=\"/user_uploads/10155/_rL5y8Bb8bmu9bh9FAgTZtab/image.png\">image.png</a></p>\n</blockquote>\n<p>thank! <br>\nI only checked the logs, but didn't try to access the server.<br>\nWill create a hapi PR to support file:/ as well.</p>",
        "id": 269935869,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1643552889
    },
    {
        "content": "<p>do you have an idea how to get it to fail early in this and/or similar cases?</p>",
        "id": 269935888,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1643552917
    },
    {
        "content": "<p>Once we drop the deployment to external tomcat within the image I think we'll be able to fail fast(er)</p>",
        "id": 269935931,
        "sender_full_name": "Jens Villadsen",
        "timestamp": 1643552992
    },
    {
        "content": "<p>fyi: <a href=\"https://github.com/hapifhir/hapi-fhir/pull/3347\">https://github.com/hapifhir/hapi-fhir/pull/3347</a></p>",
        "id": 269945241,
        "sender_full_name": "Patrick Werner",
        "timestamp": 1643564155
    }
]